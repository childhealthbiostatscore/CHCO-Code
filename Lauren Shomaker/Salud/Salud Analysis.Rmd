---
title: "Salud Data Exploration/Analysis"
author: "Casey Sakamoto"
date:"`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE}
library(haven) # import spss dataset
library(knitr)
library(nlme) # mixed models
library(emmeans) # contrast statement
library(tidyverse) # data manipulation

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/Peds Endo/Lauren Shomaker/Salud"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Lauren Shomaker/Salud"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Lauren Shomaker/Salud"
}
knitr::opts_knit$set(root.dir = home_dir)

# import data
## make sure connected to vpn
HLP_MASTER_DATA <- read_sav("S:/Laura/Peds Endo/Lauren Shomaker/Salud/Data Analysis - Pyle 2020/HLP_MASTER DATA 7.15.20 LP Trim.sav")

```
# Aim 2
Hypothesis: We estimate that the MBI + Lifestyle (SSB) will be more effective than Lifestyle Only (HeLP) for reducing depression symptoms, insulin resistance, and stress.

### Insulin Resistance
4. Other Metabolic outcomes ALt/AST ,
Lipids(tryglyc(tryglycerides_mgdl_clean - missing 1 subj), cholesterol total(cholesteroltot_mgdl), hdl/ldl (hdlc_mgdl ldlc_mgdl)

### Stress
1. Perceived Stress Scale (psssumitem)
2. Everyday discrimination scale - (edsrawscore - total, sumavg_eds - avg) - both fine
3.	Psychological Stress Experience - (pserawsum, pserawmean, pserawsumT) - which to use
4.	Cortisol, changes before to after session each week-6 sessions (cortisol_nmoll_sessionN_before, cortisol_nmoll_sessionN_after)
a.	Did we see a pattern/trajectory toward more declining cortisol in SSB (vs. HELP)?
b.	Note cortisol was measured end-of-day, after exercise portion of the intervention -during evenings (~6pm and again at 6:45/7pm), so imperfect we are aware but was consistently measured this way 


3. lipid and hdlc missingfor subj 117 6wk,

## Data overall
1. we have 12 subjects with 3 time points (BL, 6wk, 6mo), 1 subj with 2 (BL, 6wk , subj 117 (has some missing data)), 5 with just bl


```{r data exploration and clean, include=FALSE}
###### light exploration #################
#look at what we are working with
unique(HLP_MASTER_DATA$subjectidno)
length(unique(HLP_MASTER_DATA$subjectidno)) # 18 total subj

# double check homairlg is a log transform of homair
a  = HLP_MASTER_DATA %>% select(subjectidno,homair, homairlg) 
a$testhomair = log(a$homair) # base e doesnt match
a$testhomair = log10(a$homair) # base 10 matches
##########################################

#####
# for some reason no more t-score in the new data set- will pull from the older data set
HLP_MASTER_DATA_7_14_20_LP_ = read_sav("S:/Laura/Peds Endo/Lauren Shomaker/Salud/Data Analysis - Pyle 2020/Older/HLP_MASTER DATA 7.14.20 LP .sav")

HLP_MASTER_DATA_7_14_20_LP_ = HLP_MASTER_DATA_7_14_20_LP_ %>% select(subjectidno, interval, pserawsumT)
####

###### cortisol derivation #####
hlp_cortisol = HLP_MASTER_DATA %>% mutate(cortisol_change1 = Cortisol_nmoll_session1_after - Cortisol_nmoll_session1_before,
                                          cortisol_change2 = Cortisol_nmoll_session2_after - Cortisol_nmoll_session2_before,
                                          cortisol_change3 = Cortisol_nmoll_session3_after - Cortisol_nmoll_session3_before,
                                          cortisol_change4 = Cortisol_nmoll_session4_after - Cortisol_nmoll_session4_before,
                                          cortisol_change5 = Cortisol_nmoll_session5_after - Cortisol_nmoll_session5_before,
                                          cortisol_change6 = Cortisol_nmoll_session6_after - Cortisol_nmoll_session6_before) %>%
  select(subjectidno, interval, cortisol_change1, cortisol_change2, cortisol_change3, cortisol_change4, cortisol_change5, cortisol_change6)

###### get already cleaned variables from data #################
analysis = HLP_MASTER_DATA %>% select(subjectidno, interval, groupno, sex, SV2age_calculated,z_score,
                                      cesdtot, homair, insulin_mcIUmL, glucose_mgdL,
                                      hba1c, ALT_UL, AST_UL, triglycerides_mgdL, cholesteroltot_mgdL, HDLC_mgdL, LDLC_mgdL,
                                      psssumitem, EDSrawscore) 

analysis = full_join(analysis, HLP_MASTER_DATA_7_14_20_LP_)
analysis = full_join(analysis, hlp_cortisol)

# order and factor variables
analysis = analysis[order(analysis$subjectidno, analysis$interval),]
analysis$groupno = as.factor(analysis$groupno)
analysis$interval = as.factor(analysis$interval)
analysis$sex = as.factor(analysis$sex)

# clean up workspace
rm(hlp_cortisol); rm(HLP_MASTER_DATA); rm(HLP_MASTER_DATA_7_14_20_LP_)
###########################################
```

```{r mixed model, echo=FALSE}
###### Teen Depression (cesdtot) #########

# simple models
cesdtot_mod = lme(cesdtot ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

cesdtot_mod_anova = anova.lme(cesdtot_mod, type="marginal")
# use emmeans 
cesdtot_mod_means = emmeans(cesdtot_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
cesdtot_mod2 = lme(cesdtot ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

cesdtot_mod_anova2 = anova.lme(cesdtot_mod2, type="marginal")
# use emmeans 
cesdtot_mod_means2 = emmeans(cesdtot_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### Insulin Resistance (homair) #########

# simple models
homair_mod = lme(homair ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

homair_mod_anova = anova.lme(homair_mod, type="marginal")
# use emmeans 
homair_mod_means = emmeans(homair_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
homair_mod2 = lme(homair ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

homair_mod_anova2 = anova.lme(homair_mod2, type="marginal")
# use emmeans 
homair_mod_means2 = emmeans(homair_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### Insulin Resistance (fasting insulin) #########
# simple models
insulin_mod = lme(insulin_mcIUmL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

insulin_mod_anova = anova.lme(insulin_mod, type="marginal")
# use emmeans 
insulin_mod_means = emmeans(insulin_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
insulin_mod2 = lme(insulin_mcIUmL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

insulin_mod_anova2 = anova.lme(insulin_mod2, type="marginal")
# use emmeans 
insulin_mod_means2 = emmeans(insulin_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### Insulin Resistance (glucose) #########
# simple models
glucose_mod = lme(glucose_mgdL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

glucose_mod_anova = anova.lme(glucose_mod, type="marginal")
# use emmeans 
glucose_mod_means = emmeans(glucose_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
glucose_mod2 = lme(glucose_mgdL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

glucose_mod_anova2 = anova.lme(glucose_mod2, type="marginal")
# use emmeans 
glucose_mod_means2 = emmeans(glucose_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### metabolic outcomes (hba1c) #########
# simple models
hba1c_mod = lme(hba1c ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

hba1c_mod_anova = anova.lme(hba1c_mod, type="marginal")
# use emmeans 
hba1c_mod_means = emmeans(hba1c_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
hba1c_mod2 = lme(hba1c ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

hba1c_mod_anova2 = anova.lme(hba1c_mod2, type="marginal")
# use emmeans 
hba1c_mod_means2 = emmeans(hba1c_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### metabolic outcomes (AST/ALT) #########
# simple models
alt_mod = lme(ALT_UL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)

alt_mod_anova = anova.lme(alt_mod, type="marginal")

ast_mod = lme(AST_UL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis)
ast_mod_anova = anova.lme(ast_mod, type="marginal")
# use emmeans 
alt_mod_means = emmeans(alt_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
ast_mod_means = emmeans(ast_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
#adjusted for age, bmi, sex
alt_mod2 = lme(ALT_UL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)
ast_mod2 = lme(AST_UL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)
ast_mod_anova2 = anova.lme(ast_mod2, type="marginal")
alt_mod_anova2 = anova.lme(alt_mod2, type="marginal")
# use emmeans 
alt_mod_means2 = emmeans(alt_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
ast_mod_means2 = emmeans(ast_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

########################################

###### metabolic outcomes lipids #########
# simple models
lipid_mod = lme(triglycerides_mgdL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

lipid_mod_anova = anova.lme(lipid_mod, type="marginal")
# use emmeans 
lipid_mod_means = emmeans(lipid_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
lipid_mod2 = lme(triglycerides_mgdL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

lipid_mod_anova2 = anova.lme(lipid_mod2, type="marginal")
# use emmeans 
lipid_mod_means2 = emmeans(lipid_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### metabolic outcomes cholesterol total #########
# simple models
chol_mod = lme(cholesteroltot_mgdL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

chol_mod_anova = anova.lme(chol_mod, type="marginal")
# use emmeans 
chol_mod_means = emmeans(chol_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
chol_mod2 = lme(cholesteroltot_mgdL~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

chol_mod_anova2 = anova.lme(chol_mod2, type="marginal")
# use emmeans 
chol_mod_means2 = emmeans(chol_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### metabolic outcomes (LDL/HDL) #########
# simple models
analysis$LDLC_mgdL
ldl_mod = lme(LDLC_mgdL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

ldl_mod_anova = anova.lme(ldl_mod, type="marginal")

hdl_mod = lme(HDLC_mgdL ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)
hdl_mod_anova = anova.lme(hdl_mod, type="marginal")
# use emmeans 
ldl_mod_means = emmeans(ldl_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
hdl_mod_means = emmeans(hdl_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
#adjusted for age, bmi, sex
ldl_mod2 = lme(LDLC_mgdL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)
hdl_mod2 = lme(HDLC_mgdL ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)
ldl_mod_anova2 = anova.lme(ldl_mod2, type="marginal")
hdl_mod_anova2 = anova.lme(hdl_mod2, type="marginal")
# use emmeans 
ldl_mod_means2 = emmeans(ldl_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
hdl_mod_means2 = emmeans(hdl_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

########################################

###### stress outcomes pss #########
# simple models
analysis$psssumitem
pss_mod = lme(psssumitem ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pss_mod_anova = anova.lme(pss_mod, type="marginal")
# use emmeans 
pss_mod_means = emmeans(pss_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
pss_mod2 = lme(psssumitem~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pss_mod_anova2 = anova.lme(pss_mod2, type="marginal")
# use emmeans 
pss_mod_means2 = emmeans(pss_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### stress outcomes eds #########
# simple models
analysis$EDSrawscore
eds_mod = lme(EDSrawscore ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

eds_mod_anova = anova.lme(eds_mod, type="marginal")
# use emmeans 
eds_mod_means = emmeans(eds_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
eds_mod2 = lme(EDSrawscore ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

eds_mod_anova2 = anova.lme(eds_mod2, type="marginal")
# use emmeans 
eds_mod_means2 = emmeans(eds_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### stress outcomes pse #########
# simple models
analysis$pserawsumT
pse_mod = lme(pserawsumT ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova = anova.lme(pse_mod, type="marginal")
# use emmeans 
pse_mod_means = emmeans(pse_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
pse_mod2 = lme(pserawsumT ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova2 = anova.lme(pse_mod2, type="marginal")
# use emmeans 
pse_mod_means2 = emmeans(pse_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### stress outcomes pse #########
# simple models
analysis$pserawsumT
pse_mod = lme(pserawsumT ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova = anova.lme(pse_mod, type="marginal")
# use emmeans 
pse_mod_means = emmeans(pse_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
pse_mod2 = lme(pserawsumT ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova2 = anova.lme(pse_mod2, type="marginal")
# use emmeans 
pse_mod_means2 = emmeans(pse_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

###### stress outcomes cortisol change #########
# simple models
analysis$cortisol_change1
c1_mod = lme(cortisol_change1 ~ interval+groupno+interval:groupno,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova = anova.lme(pse_mod, type="marginal")
# use emmeans 
pse_mod_means = emmeans(pse_mod,specs=pairwise ~ factor(interval):groupno, adjust="tukey")

#adjusted for age, bmi, sex
pse_mod2 = lme(pserawsumT ~ interval*groupno +sex+z_score,
                   random=~1|subjectidno,
                   data = analysis, na.action = na.omit)

pse_mod_anova2 = anova.lme(pse_mod2, type="marginal")
# use emmeans 
pse_mod_means2 = emmeans(pse_mod2,specs=pairwise ~ factor(interval):groupno, adjust="tukey")
########################################

kable(hba1c_mod_anova2,caption="CESDtot anova",format.args = list(scientific = FALSE))
kable(pse_mod_means2$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```


```{r cesdtot results}
kable(cesdtot_mod_anova,caption="CESDtot anova",format.args = list(scientific = FALSE))
kable(cesdtot_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .82, .84, 1). Similar results when adjusting for covariates

```{r homair results}
kable(homair_mod_anova,caption="HOMA-IR anova",format.args = list(scientific = FALSE))
kable(homair_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .91, .99, .69). Similar results when adjusting for covariates

```{r insulin results}
kable(insulin_mod_anova,caption="Insulin anova",format.args = list(scientific = FALSE))
kable(insulin_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .94, .99, .64). Similar results when adjusting for covariates

```{r glucose results}
kable(glucose_mod_anova,caption="Glucose anova",format.args = list(scientific = FALSE))
kable(glucose_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .99, .58, .99). Similar results when adjusting for covariates

```{r hba1c results}
kable(hba1c_mod_anova,caption="HBA1C anova",format.args = list(scientific = FALSE))
kable(hba1c_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .99, .99, .13). Similar results when adjusting for covariates

```{r AST/ALT results}
kable(alt_mod_anova,caption="ALT anova",format.args = list(scientific = FALSE))
kable(alt_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))

kable(ast_mod_anova,caption="ALT anova",format.args = list(scientific = FALSE))
kable(ast_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups for ALT at each time point (p = .93, .98, .99). Similar results when adjusting for covariates
No difference in groups for AST at each time point (p = .94, .62, .99). Similar results when adjusting for covariates

```{r Lipids results}
kable(lipid_mod_anova,caption="Lipids (triglycerides) anova",format.args = list(scientific = FALSE))
kable(lipid_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .96, .99, .86). Similar results when adjusting for covariates.

```{r Cholesterol results}
kable(chol_mod_anova,caption="Total Cholesterol anova",format.args = list(scientific = FALSE))
kable(chol_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .99, .99, .83). Similar results when adjusting for covariates.

```{r LDL/HDL results}
kable(ldl_mod_anova,caption="LDL anova",format.args = list(scientific = FALSE))
kable(ldl_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))

kable(hdl_mod_anova,caption="HDL anova",format.args = list(scientific = FALSE))
kable(hdl_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups for LDL at each time point (p = .96, .83, .91). Similar results when adjusting for covariates
No difference in groups for HDL at each time point (p = .46, .26, .48). Similar results when adjusting for covariates

```{r PSS results}
kable(pss_mod_anova,caption="Perceived Stress Scale anova",format.args = list(scientific = FALSE))
kable(pss_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .74, .78, .99). Similar results when adjusting for covariates.

```{r EDS results}
kable(eds_mod_anova,caption="Everyday Discrimination Scale anova",format.args = list(scientific = FALSE))
kable(eds_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .99, .99, .99). Similar results when adjusting for covariates.

```{r PSE results}
kable(pse_mod_anova,caption="Psychological Stress Experience anova",format.args = list(scientific = FALSE))
kable(pse_mod_means$contrasts[c(3,8,12),],caption="Time point means.",format.args = list(scientific = FALSE))
```
No difference in groups at each time point (p = .99, .76, .99). Similar results when adjusting for covariates.