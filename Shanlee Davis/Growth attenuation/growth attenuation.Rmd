---
title: "Growth attenuation therapy analysis"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(hrbrthemes)
library(nlme)
library(emmeans)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/Davis/Growth attenuation analysis/Data raw"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
}
setwd(home_dir)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data, include=FALSE}
source("./GrowthAttenuationThe-DemographicsMedicalH_R_2022-04-10_2011.r")
demo <- data
data <- NULL

source("./GrowthAttenuationThe-BoneAge_R_2022-04-10_2017.r")
bone_age <- data
data <- NULL

source("./GrowthAttenuationThe-Labs_R_2022-04-10_2014.r")
labs <- data
data <- NULL

# merge highest dose of estradiol and sex to bone age
d <- demo[,c("record_id","estradiol_highestdose","sex","stop_reason")]
bone_age <- merge(bone_age,d,by="record_id",all.x = T, all.y = F)
bone_age$estradiol_highestdose <- as.factor(as.character(bone_age$estradiol_highestdose))
bone_age$sex <- as.factor(as.character(bone_age$sex))

# df with participants having adverse effects excluded
bone_age_noae <- bone_age %>% filter(stop_reason %in% c(1,3,4,555))
```

# Questions

1) Some data points are prior to start of therapy (as much as 1.4 years prior).  Some people have two values prior to start of therapy - should I use the one closest to start of therapy as "baseline", or use all the data?
2) For the model of predicted adult height vs. dose - I used the highest dose of estradiol.  Is that correct? 

# Methods

Linear mixed-effects models were used to model the trajectory of predicted adult height over time.

# Results - all data and participants included

## Spaghetti plot of predicted adult height

### By highest dose of estradiol

```{r echo=FALSE, warning=FALSE}
# Spaghetti plot of predicted adult height over time
p1 <- ggplot(data=bone_age, aes(x=time_gat_ba,y=ba_pah_calc,group=record_id, color=estradiol_highestdose)) + geom_line() +
      theme_ipsum()
p1
```

### By sex

```{r echo=FALSE, warning=FALSE}
# Spaghetti plot of predicted adult height over time
p2 <- ggplot(data=bone_age, aes(x=time_gat_ba,y=ba_pah_calc,group=record_id, color=sex)) + geom_line() +
      theme_ipsum()
p2
```

## Mixed model of predicted adult height 

### Model summary

```{r echo=FALSE, include=FALSE}
mod1 <- lme(ba_pah_calc ~ time_gat_ba,random=~1|record_id,data = bone_age,na.action = na.omit)
# estimation at mean value of time
mod1_pred <- matrix(predict(ref_grid(mod1)))
# estimation at baseline
mod1_pred.0yr <- ref_grid(mod1, at = list(time_gat_ba = 0))
# estimation at 1 year
mod1_pred.1yr <- ref_grid(mod1, at = list(time_gat_ba = 1))
# estimation at 2 years
mod1_pred.2yr <- ref_grid(mod1, at = list(time_gat_ba = 2))
```

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1)
```

### Estimated value of ba_pah_calc at start of treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.0yr)
```

### Prediction interval of ba_pah_calc at start of treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.0yr, interval="prediction")
```

### Estimated value of ba_pah_calc at 1 year post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.1yr)
```

### Prediction interval of ba_pah_calc at 1 year post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.1yr, interval="prediction")
```

### Estimated value of ba_pah_calc at 2 years post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.2yr)
```

### Prediction interval of ba_pah_calc at 2 years post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.2yr, interval="prediction")
```

## Mixed model of predicted adult height vs. dose

```{r echo=FALSE, include=FALSE}
mod2 <- lme(ba_pah_calc ~ time_gat_ba*estradiol_highestdose,random=~1|record_id,data = bone_age,na.action = na.omit)
mod2_anova <- anova.lme(mod2, type="marginal")
mod2_means <- emmeans(mod2,"estradiol_highestdose")
mod2_pairs <-  pairs(mod2_means,adjust="tukey")
```

### Model summary

```{r echo=FALSE, warning=FALSE, comment=""}
mod2_anova
```

### Estimated mean ba_pah_calc in each dose category at mean value of time_gat_ba

```{r echo=FALSE, warning=FALSE, comment=""}
mod2_means 
mod2_pairs
```

# Results - participants with adverse effects excluded (includes participants who have not completed)

## Spaghetti plot of predicted adult height

### By highest dose of estradiol

```{r echo=FALSE, warning=FALSE}
# Spaghetti plot of predicted adult height over time
p1 <- ggplot(data=bone_age_noae, aes(x=time_gat_ba,y=ba_pah_calc,group=record_id, color=estradiol_highestdose)) + geom_line() +
      theme_ipsum()
p1
```

### By sex

```{r echo=FALSE, warning=FALSE}
# Spaghetti plot of predicted adult height over time
p2 <- ggplot(data=bone_age_noae, aes(x=time_gat_ba,y=ba_pah_calc,group=record_id, color=sex)) + geom_line() +
      theme_ipsum()
p2
```

## Mixed model of predicted adult height 

### Model summary

```{r echo=FALSE, include=FALSE}
mod1 <- lme(ba_pah_calc ~ time_gat_ba,random=~1|record_id,data = bone_age_noae,na.action = na.omit)
# estimation at mean value of time
mod1_pred <- matrix(predict(ref_grid(mod1)))
# estimation at baseline
mod1_pred.0yr <- ref_grid(mod1, at = list(time_gat_ba = 0))
# estimation at 1 year
mod1_pred.1yr <- ref_grid(mod1, at = list(time_gat_ba = 1))
# estimation at 2 years
mod1_pred.2yr <- ref_grid(mod1, at = list(time_gat_ba = 2))
```

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1)
```

### Estimated value of ba_pah_calc at start of treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.0yr)
```

### Prediction interval of ba_pah_calc at start of treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.0yr, interval="prediction")
```

### Estimated value of ba_pah_calc at 1 year post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.1yr)
```

### Prediction interval of ba_pah_calc at 1 year post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.1yr, interval="prediction")
```

### Estimated value of ba_pah_calc at 2 years post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
summary(mod1_pred.2yr)
```

### Prediction interval of ba_pah_calc at 2 years post-treatment

```{r echo=FALSE, warning=FALSE, comment=""}
predict(mod1_pred.2yr, interval="prediction")
```

## Mixed model of predicted adult height vs. dose

```{r echo=FALSE, include=FALSE}
mod2 <- lme(ba_pah_calc ~ time_gat_ba*estradiol_highestdose,random=~1|record_id,data = bone_age_noae,na.action = na.omit)
mod2_anova <- anova.lme(mod2, type="marginal")
mod2_means <- emmeans(mod2,"estradiol_highestdose")
mod2_pairs <-  pairs(mod2_means,adjust="tukey")
```

### Model summary

```{r echo=FALSE, warning=FALSE, comment=""}
mod2_anova
```

### Estimated mean ba_pah_calc in each dose category at mean value of time_gat_ba

```{r echo=FALSE, warning=FALSE, comment=""}
mod2_means 
mod2_pairs
```