---
title: "Bariatric surgery MMTT mixed models"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(tableone)
library(dplyr)
library(knitr)
library(ggpubr)
library(nlme)
library(emmeans)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

#home_dir = ifelse(.Platform$OS.type != "unix","/Volumes/Shared/Shared Projects/Laura/Peds Endo/Nadeau/IMPROVE-T2D/Data raw","")
#knitr::opts_knit$set(root.dir = home_dir)

```

```{r data, include=FALSE}
#setwd(home_dir)
alldata <- read.csv("/Volumes/Shared/Shared Projects/Laura/Peds Endo/Nadeau/IMPROVE-T2D/Data raw/IMPROVET2D-MMTTVariables_DATA_2022-07-13_1254.csv")

# select the participants
# IT2D-2,3,5,6,8,11-16, 18-20
data <- alldata %>% filter(subject_id %in% c("IT_02","IT_03","IT_05","IT_06","IT_08","IT_11","IT_12","IT_13","IT_14","IT_15","IT_16","IT_18","IT_19","IT_20"))

# separate variables into MMTT and screening variables
screen <- data %>% filter(redcap_event_name=="screening_arm_1") %>% 
  select(subject_id,age_current,gender,screen_bmi,screen_bmi_percentile,screen_weight,hba1c,a1c_pre)
mmtt <- data %>% filter(redcap_event_name=="study_visits_arm_1") %>% select(subject_id,study_visit_mttt,mmtt_wt,mmtt_insulin_0,mmtt_insulin_10,
                          mmtt_insulin_20,mmtt_insulin_30,mmtt_insulin_45,mmtt_insulin_60,mmtt_insulin_90,mmtt_insulin_120,
                          mmtt_insulin_150,mmtt_insulin_180,mmtt_insulin_210,mmtt_insulin_240,
                          mmtt_bg_0,mmtt_bg_10,
                          mmtt_bg_20,mmtt_bg_30,mmtt_bg_45,mmtt_bg_60,mmtt_bg_90,mmtt_bg_120,mmtt_bg_150,mmtt_bg_180,
                          mmtt_bg_210,mmtt_bg_240,mmtt_hba1c_base,
                          mmtt_cpep_0,mmtt_cpep_10,
                          mmtt_cpep_20,mmtt_cpep_30,
                          #mmtt_cpep_45,
                          mmtt_cpep_60,mmtt_cpep_90,mmtt_cpep_120,
                          #mmtt_cpep_150,
                          mmtt_cpep_180,
                          #mmtt_cpep_210,
                          mmtt_cpep_240,
                          mmtt_yy_0,mmtt_yy_10,
                          #mmtt_yy_20,
                          mmtt_yy_30,mmtt_yy_45,mmtt_yy_60,
                          #mmtt_yy_90,
                          mmtt_yy_120,
                          #mmtt_yy_150,
                          #mmtt_yy_180,
                          #mmtt_yy_210,
                          mmtt_yy_240,
                          glucagon_0,glucagon_10,
                          #glucagon_20,
                          glucagon_30,glucagon_45,glucagon_60,
                          #glucagon_90,
                          glucagon_120,
                          #glucagon_150,
                          #glucagon_180,
                          #glucagon_210,
                          glucagon_240,
                          glp1_0,glp1_10,glp1_30,glp1_45,glp1_60,glp1_120,glp1_240,
                          ffa_0,
                          #ffa_10,
                          ffa_30,
                          #ffa_45,
                          ffa_60,ffa_120,ffa_240)
# Keep pre-surgery and 3 month visits
mmtt <- mmtt %>% filter(study_visit_mttt %in% c(1,2))
# create separate dataframes for each assay - might make reshaping a bit easier since things were measured at different time points
insulin <- mmtt %>% select(subject_id,study_visit_mttt,mmtt_insulin_0,mmtt_insulin_10,
                          mmtt_insulin_20,mmtt_insulin_30,mmtt_insulin_45,mmtt_insulin_60,mmtt_insulin_90,mmtt_insulin_120,
                          mmtt_insulin_150,mmtt_insulin_180,mmtt_insulin_210,mmtt_insulin_240)
glucose <- mmtt %>% select(subject_id,study_visit_mttt,mmtt_bg_0,mmtt_bg_10,
                          mmtt_bg_20,mmtt_bg_30,mmtt_bg_45,mmtt_bg_60,mmtt_bg_90,mmtt_bg_120,mmtt_bg_150,mmtt_bg_180,
                          mmtt_bg_210,mmtt_bg_240)
cpep <- mmtt %>% select(subject_id,study_visit_mttt,mmtt_cpep_0,mmtt_cpep_10,
                          mmtt_cpep_20,mmtt_cpep_30,mmtt_cpep_60,mmtt_cpep_90,mmtt_cpep_120,
                          mmtt_cpep_180,mmtt_cpep_240)
pyy <- mmtt %>% select(subject_id,study_visit_mttt,mmtt_yy_0,mmtt_yy_10,
                          mmtt_yy_30,mmtt_yy_45,mmtt_yy_60,mmtt_yy_120,mmtt_yy_240)
glucagon <- mmtt %>% select(subject_id,study_visit_mttt,glucagon_0,glucagon_10,glucagon_30,glucagon_45,glucagon_60,
                          glucagon_120,glucagon_240)
glp1 <- mmtt %>% select(subject_id,study_visit_mttt,glp1_0,glp1_10,glp1_30,glp1_45,glp1_60,glp1_120,glp1_240)
ffa <- mmtt %>% select(subject_id,study_visit_mttt,ffa_0,ffa_30,ffa_60,ffa_120,ffa_240)

# create "doubly long" dataset
insulin_long <- reshape(insulin, direction = "long", varying = c("mmtt_insulin_0","mmtt_insulin_10",
                          "mmtt_insulin_20","mmtt_insulin_30","mmtt_insulin_45","mmtt_insulin_60","mmtt_insulin_90","mmtt_insulin_120",
                          "mmtt_insulin_150","mmtt_insulin_180","mmtt_insulin_210","mmtt_insulin_240"), 
                          v.names = "mmtt_insulin",times = c(0,10,20,30,45,60,90,120,150,180,210,240),
                          idvar = c("subject_id","study_visit_mttt"))
insulin_long <- insulin_long %>% arrange(subject_id,study_visit_mttt,time)

glucose_long <- reshape(glucose, direction = "long", varying = c("mmtt_bg_0","mmtt_bg_10",
                          "mmtt_bg_20","mmtt_bg_30","mmtt_bg_45","mmtt_bg_60","mmtt_bg_90","mmtt_bg_120","mmtt_bg_150","mmtt_bg_180",
                          "mmtt_bg_210","mmtt_bg_240"), 
                          v.names = "mmtt_bg",times = c(0,10,20,30,45,60,90,120,150,180,210,240),
                          idvar = c("subject_id","study_visit_mttt"))
glucose_long <- glucose_long %>% arrange(subject_id,study_visit_mttt,time)

cpep_long <- reshape(cpep, direction = "long", varying = c("mmtt_cpep_0","mmtt_cpep_10",
                          "mmtt_cpep_20","mmtt_cpep_30","mmtt_cpep_60","mmtt_cpep_90","mmtt_cpep_120",
                          "mmtt_cpep_180","mmtt_cpep_240"), 
                          v.names = "mmtt_bg",times = c(0,10,20,30,60,90,120,180,240),
                          idvar = c("subject_id","study_visit_mttt"))
cpep_long <- cpep_long %>% arrange(subject_id,study_visit_mttt,time)

pyy_long <- reshape(pyy, direction = "long", varying = c("mmtt_yy_0","mmtt_yy_10",
                          "mmtt_yy_30","mmtt_yy_45","mmtt_yy_60","mmtt_yy_120","mmtt_yy_240"), 
                          v.names = "mmtt_yy",times = c(0,10,30,45,60,120,240),
                          idvar = c("subject_id","study_visit_mttt"))
pyy_long <- pyy_long %>% arrange(subject_id,study_visit_mttt,time)

glucagon_long <- reshape(glucagon, direction = "long", varying = c("glucagon_0","glucagon_10","glucagon_30","glucagon_45","glucagon_60",
                          "glucagon_120","glucagon_240"), 
                          v.names = "glucagon",times = c(0,10,30,45,60,120,240),
                          idvar = c("subject_id","study_visit_mttt"))
glucagon_long <- glucagon_long %>% arrange(subject_id,study_visit_mttt,time)

glp1_long <- reshape(glp1, direction = "long", varying = c("glp1_0","glp1_10","glp1_30","glp1_45","glp1_60","glp1_120","glp1_240"), 
                          v.names = "glp1",times = c(0,10,30,45,60,120,240),
                          idvar = c("subject_id","study_visit_mttt"))
glp1_long <- glp1_long %>% arrange(subject_id,study_visit_mttt,time)

ffa_long <- reshape(ffa, direction = "long", varying = c("ffa_0","ffa_30","ffa_60","ffa_120","ffa_240"), 
                          v.names = "ffa",times = c(0,30,60,120,240),
                          idvar = c("subject_id","study_visit_mttt"))
ffa_long <- ffa_long %>% arrange(subject_id,study_visit_mttt,time)
```

# Methods

Unadjusted changes in outcomes were tested using the Wilcoxon test. Mixed-effects models were used to test changes in outcomes while adjusting for changes in weight.

# Results

## Table of unadjusted changes

```{r echo=FALSE, include=FALSE}
t1 <- CreateTableOne(data=wide, vars = c("auc_insulin_delta","auc_glucose_delta","mmtt_insulin_0_delta","mmtt_bg_0_delta",
                                         "homa_ir_delta","homa_b_delta","odi_delta","hba1c_delta","matsuda_delta"), test = TRUE)
t1 <- print(t1, nonnorm=c("auc_insulin_delta","auc_glucose_delta","mmtt_insulin_0_delta","mmtt_bg_0_delta",
                                         "homa_ir_delta","homa_b_delta","odi_delta","hba1c_delta","matsuda_delta"))

p <- NULL
t <- wilcox.test(wide$auc_insulin_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$auc_glucose_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$mmtt_insulin_0_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$mmtt_bg_0_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$homa_ir_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$homa_b_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$odi_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$hba1c_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
t <- wilcox.test(wide$matsuda_delta, mu = 0, alternative = "two.sided")$p.value
p <- c(p,t)
p <- round(p,3)
p <- c("",p)

t1 <- cbind(t1,p)

```

```{r echo=FALSE}
kable(t1)
```

## Adjusted models

How to interpret the output: the first table is the ANOVA table, which gives the p-value for the effect of time (pre vs. post) and the least-squares means (i.e., adjusted means) at each time point.

### AUC insulin

```{r echo=FALSE, include=FALSE}
mod <- lme(auc_insulin ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### AUC glucose

```{r echo=FALSE, include=FALSE}
mod <- lme(auc_glucose ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### Fasting insulin

```{r echo=FALSE, include=FALSE}
mod <- lme(mmtt_insulin_0 ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### Fasting glucose

```{r echo=FALSE, include=FALSE}
mod <- lme(mmtt_bg_0 ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### HOMA-IR

```{r echo=FALSE, include=FALSE}
mod <- lme(homa_ir ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### HOMA-B

```{r echo=FALSE, include=FALSE}
mod <- lme(homa_b ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### oDI

```{r echo=FALSE, include=FALSE}
mod <- lme(odi ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### HbA1c

```{r echo=FALSE, include=FALSE}
mod <- lme(mmtt_hba1c_base ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```

### Matsuda Index

```{r echo=FALSE, include=FALSE}
mod <- lme(matsuda ~ study_visit_mttt + wt_delta,random=~1|subject_id,data = mmtt,na.action = na.omit)
anova <- anova.lme(mod, type="marginal")
means <- emmeans(mod,"study_visit_mttt")
```

```{r echo=FALSE}
kable(anova)
kable(means)
```