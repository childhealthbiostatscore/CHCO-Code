---
title: "Incidence of youth-onset type 2 diabetes during the COVID-19 pandemic"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

library(skimr)
library(stringr)
library(dplyr)
library(tableone)
library(knitr)

#################
# READ IN DATA  #
#################

columbia <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID multisite template 2018_2020_Columbia.csv")
names <- colnames(columbia)
names[1] <- "ptid"
colnames(columbia) <- names
columbia$site <- "Columbia"
columbia$X <- NULL

chicago <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\2021.8.30 T2D COVID UChicago FINAL deidentified2.csv")
chicago$site <- "Chicago"

mayo <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\8-27-21MayoUpload.csv")
mayo$site <- "Mayo"

chla <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\CHLA_T2D Data.csv")
chla$site <- "CHLA"

jhu <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\DATA ENTRY Hopkins t2d CLEAN no PHI.csv")
jhu$site <- "JHU"
jhu$X <- NULL

duke <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\DUKE_T2D_DATA.csv")
duke$site <- "Duke"
duke$ptid <- NA

ou <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D and COVID Study Database 10Jul2021 DE-IDENTIFIED OU.csv")
ou$site <- "OU"
ou$ptid <- NA

mercy <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID - Children's Mercy Final Deidentified.csv")
mercy$site <- "Mercy"
mercy$ptid <- NA

cchmc <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID multisite template CCHMC.csv")
cchmc$site <- "CCHMC"

iu <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID multisite IU 8.27.2021.csv")
iu$site <- "IU"

ucsd <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID UCSD Rady Childrens 09012021 Deidentified.csv")
ucsd$site <- "UCSD"
ucsd$ptid <- NA

cu <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVID_CUAnschutz.csv")
cu$site <- "Colorado"

brown <- read.csv("E:\\Megan Kelsey\\T2D and COVID\\Data raw\\T2D COVIDdata_Brown.Hasbro.csv")
brown$site <- "Brown/Hasbro"
# need to get rid of decimal at the end of all ages
brown$age_dx <- substr(brown$age_dx,1,nchar(brown$age_dx)-1)
brown$age_dx <- ifelse(brown$age_dx=="14. 11","14.11",brown$age_dx)

# EVENTUALLY NEED TO READ IN NATIONAL AND LURIE

# COMBINE DATA 
alldata <- rbind(columbia,chicago,mayo,chla,jhu,duke,ou,mercy,cchmc,iu,ucsd,cu,brown)

#################
# DATA CLEANING #
#################

# clean up cases
alldata$GAD65.Ab <- toupper(alldata$GAD65.Ab)
alldata$Insulin.Ab <- toupper(alldata$Insulin.Ab)
alldata$ICA.Ab <- toupper(alldata$ICA.Ab)
alldata$ZnT8.Ab <- toupper(alldata$ZnT8.Ab)
alldata$sex <- toupper(alldata$sex)
alldata$insurance <- toupper(alldata$insurance)
alldata$Location.Diagnosis <- toupper(alldata$Location.Diagnosis)
alldata$COVID.19.at.diagnosis <- toupper(alldata$COVID.19.at.diagnosis)

# missing ab data
#View(alldata[alldata$GAD65.Ab=="" | alldata$Insulin.Ab=="" | alldata$ICA.Ab=="" | alldata$ZnT8.Ab=="",])

# clean up race/ethnicity
alldata$Race <- str_trim(alldata$Race)
alldata$Ethnicity <- str_trim(alldata$Ethnicity)
alldata$Race <- ifelse(alldata$Race %in% c("","Did not answer"),"Unknown",alldata$Race)
alldata$Ethnicity <- ifelse(alldata$Ethnicity %in% c("","Did not Answer"),"Unknown",alldata$Ethnicity)
alldata$Ethnicity <- ifelse(alldata$Ethnicity %in% c("Non-hispanic","non hispanic","Non hispanic","Non Hispanic","Not Hispanic"),
                            "Non-Hispanic",alldata$Ethnicity)

# clean up insurance
alldata$insurance <- ifelse(alldata$insurance=="NONE","UNINSURED",alldata$insurance)
alldata$insurance <- ifelse(alldata$insurance %in% c("PUBIC","PUBILC","PUBLIC "),"PUBLIC",alldata$insurance)

# clean up BMI
alldata$BMI <- ifelse(alldata$BMI %in% c("?","Not Available","Not Tested"),NA,alldata$BMI)
alldata$BMI <- as.numeric(alldata$BMI)
alldata$BMI <- ifelse(alldata$BMI>300,NA,alldata$BMI)

# clean up A1c
alldata$HbA1c <- ifelse(alldata$HbA1c %in% c(">14",">14.0"),14,alldata$HbA1c)
alldata$HbA1c <- ifelse(alldata$HbA1c==">14.5",14.5,alldata$HbA1c)
alldata$HbA1c <- as.numeric(alldata$HbA1c)

# clean up glucose 
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.==">400",400,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.==">500",500,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.==">600",600,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.==">700",700,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.==">750",750,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.=="Not Tested",NA,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.=="1,001",1001,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- ifelse(alldata$Serum.glucose..random.=="1,191",1191,alldata$Serum.glucose..random.)
alldata$Serum.glucose..random. <- as.numeric(alldata$Serum.glucose..random.)

# clean up pH
alldata$pH <- ifelse(alldata$pH %in% c("","-"),NA,alldata$pH)
alldata$pH <- ifelse(alldata$pH=="Not Tested",NA,alldata$pH)
alldata$pH <- ifelse(alldata$pH=="7.3Unknown",7.3,alldata$pH)
alldata$pH <- as.numeric(alldata$pH)

# clean up bicarb
alldata$bicarbonate <- ifelse(alldata$bicarbonate=="<10",10,alldata$bicarbonate)
alldata$bicarbonate <- ifelse(alldata$bicarbonate=="<5",5,alldata$bicarbonate)
alldata$bicarbonate <- ifelse(alldata$bicarbonate=="Not Tested",NA,alldata$bicarbonate)
alldata$bicarbonate <- as.numeric(alldata$bicarbonate)

# clean up osmolality
alldata$Serum.osmolality <- ifelse(alldata$Serum.osmolality=="Not Tested",NA,alldata$Serum.osmolality)
alldata$Serum.osmolality <- as.numeric(alldata$Serum.osmolality)

# clean up age
alldata$age_dx <- as.numeric(alldata$age_dx)

# convert to factors
alldata$mo_dx <- as.factor(as.character(alldata$mo_dx))
alldata$yr_dx <- as.factor(as.character(alldata$yr_dx))

# REMOVE AB POSITIVE PATIENTS!!!!!
alldata <- alldata %>% filter(!(alldata$site=="Columbia" & alldata$GAD65.Ab==""))
alldata <- alldata %>% filter(!(alldata$site=="CHLA" & alldata$GAD65.Ab=="POS"))

```

# Outstanding Data cleaning issues

- Children's Mercy recorded "Yes" and "No" for the antibodies tested - does "yes" indicate tested and negative and "no" indicate not tested?
- 6 records (1 CHLA, 5 JHU with missing ab data)
- 1 record at CHLA with missing sex
- 3 records at CCHMC missing Location of Diagnosis
- 1 record at IU with BMI>300

# Background

# Methods

deleted ab positive patients (4 at Columbia)

if A1c >14, set to 14
if A1c >14.5, set to 14.5
same with glucose, all labs (upper and lower limit)

# Results

```{r include=FALSE}
vars <- colnames(alldata)
vars <- vars[-1]

t1 <- CreateTableOne(data=alldata,vars = vars)
t1 <- print(t1,nonnormal = c("BMI","HbA1c","Serum.glucose..random.","pH","bicarbonate","Serum.osmolality"))
```

```{r echo=FALSE}
kable(t1,caption = "Table 1.")
```
<br>
