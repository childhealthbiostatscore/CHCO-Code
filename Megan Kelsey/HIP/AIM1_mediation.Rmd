---
title: "HbA1c and Fat Depot Mediation Analysis"
author: "Laura Pyle"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(tidyverse)

```

```{r}
load("E:/Megan Kelsey/Kelsey HIP/Kelsey_HIP_R_Code/data/dat_analysis_1.RData")
```

```{r}
data <- dat_analysis_1 %>% dplyr::select(hip_id_screen,
                                 study_visit_number_svl,
                                 liver_fat_perc,
                                 lept,
                                 hba,
                                 delta_hba,
                                 tg_lv,
                                 igf_lv,
                                 hdl_lv,
                                 fasting_glucose,
                                 fasting_insulin,
                                 insulin_sensitivity,
                                 insulin_secretion_mm,
                                 disposition_index,
                                 visceral,
                                 per_visceral,
                                 subq_fat,
                                 adiponect_lv,
                                 crp_lv,
                                 alt,
                                 ast,
                                 delta_liver_fat_perc) %>% 
  filter(!is.na(liver_fat_perc)) %>%  filter(!is.na(delta_liver_fat_perc))

# what to do about missing data
```

# Linear Models

The following models look at liver fat percentage vs (leptin, hba1c, fasting insulin, fasting glucose, triglycerides, IGF-1, AIRg, SI, and DI) separately and without any clustering by subject. 

Each variable has a plot and linear model. To interpret the model, look at the estimate next to the variable name. This is the slope of the line. If the variable goes up by 1 unit, then liver fat goes up by whatever the estimate is. Then look at the p-value (Pr(>|t|)) in the same row as the estimate to determine significance. 

 
```{r, results='asis'}
predictors <- names(dat)[-c(1:3)]

for (pred in predictors){
  cat("\n")
  cat(paste("##",pred))
  cat("\n")
  fml <- as.formula(paste("liver_fat_perc ~ ",pred))
  model <- lme(fml,
               random = ~1|hip_id_screen,
               data = dat,
               na.action = na.omit)
  corr_plot <- ggplot(data = dat, 
                      aes_string(y = "liver_fat_perc",
                                 x = pred)) +
    geom_point() +
    geom_smooth(method = "lm")
  r_squared <- r.squaredGLMM(model)[1]
  r <- sqrt(r_squared)
  print(corr_plot)
  cat("\n")
  #print(paste("R^2 = ",,3)))
  print(paste("R-squared = ",round(r_squared,3)))
  cat("\n")
  print(paste("R = ",round(r,3)))
  cat("\n")
  print(kable(summary(model)$tTable))
}
```

```{r}
baseline <- dat %>% filter(study_visit_number_svl == "Tanner 2/3")
follow_up <- dat %>% filter(study_visit_number_svl == "Tanner 5") %>% 
  dplyr::select(hip_id_screen, liver_fat_perc)

delta_set <- merge(baseline, follow_up, by = "hip_id_screen", all = T)
delta_set$delta_liver_fat <- delta_set$liver_fat_perc.y - delta_set$liver_fat_perc.x

delta_set <- delta_set %>% filter(!is.na(delta_liver_fat))
```

# Change in Liver Fat Percentage - Simple Linear Regression

The following models predict change in liver fat percentage using baseline liver fat percentage and baseline values for leptin, hba1c, fasting insulin, fasting glucose, triglycerides, IGF-1, AIRg, SI, and DI. 

These models can answer the question if any baseline values on their own can predict change in liver fat percentage at follow up. 

Interpreting the baseline value of liver fat percentage (liver_fat_perc.x): for higher baseline levels of liver fat percentage, change in liver fat percentage from baseline to follow up is lower. 

```{r, results='asis'}
for (pred in predictors){
  fml <- as.formula(paste("delta_liver_fat ~ liver_fat_perc.x +",pred))
  model <- lm(fml,
               data = delta_set)
  print(kable(summary(model)$coefficients))
}
```

# Change in Liver Fat Percentage - Multiple Regression

The following models predict change in liver fat percentage from baseline values. All baseline values are included in the model. In the second model, backwards selection is used to eliminate unnecessary covariates. 

These models can answer the question if baseline values can collectively predict change in liver fat percentage at follow up.

```{r}
fml <- as.formula(paste("delta_liver_fat ~ liver_fat_perc.x +",paste(predictors, collapse = "+")))
model <- lm(fml,
               data = delta_set)
kable(summary(model)$coefficients)
# backwords selected model
step_model <- stepAIC(model, trace = 0)
kable(summary(step_model)$coefficients)
```