---
title: "WatchPAT vs. PSG Deming Regression"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(knitr)
library(mcr)
library(dplyr)
library(blandr)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/Melanie Green/Watchpat/Data raw"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/BDC/Projects"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Melanie Green/Watchpat/Data raw"
}
knitr::opts_knit$set(root.dir = home_dir)
setwd(home_dir)
```

```{r data, include=FALSE}
data <- read.csv("./WatchPAT x PSG data 11.30.2022.csv")
data <- data %>% filter(!is.na(PSG.AHI))
data <- data %>% filter(PSG.sleep..4.hours==1)

# create variables for each method to indicate >=5, >=15 and >=30 events per hour
data$Watchpat.AHI.5 <- ifelse(data$Watchpat.AHI>=5,1,0)
data$PSG.AHI.5 <- ifelse(data$PSG.AHI>=5,1,0)
data$Watchpat.AHI.15 <- ifelse(data$Watchpat.AHI>=15,1,0)
data$PSG.AHI.15 <- ifelse(data$PSG.AHI>=15,1,0)
data$Watchpat.AHI.30 <- ifelse(data$Watchpat.AHI>=30,1,0)
data$PSG.AHI.30 <- ifelse(data$PSG.AHI>=30,1,0)

dem.reg <- mcreg(x=data$Watchpat.AHI,y=data$PSG.AHI, method.reg = "Deming")
```

# Deming regression

Deming regression was performed with WatchPAT AHI as the independent variable and PSG AHI as the dependent variable. Therefore, the following equation can be used to estimate the PSG AHI based on a WatchPAT AHI value:

$$PSG_{AHI} = \beta_0 + \beta_1 * WatchPAT_{AHI}$$

where $\beta_0$ is the intercept from the Deming regression and $\beta_1$ is the slope from the Deming regression.

```{r echo=FALSE, comment=""}
kable(summary(dem.reg))
```

# Bland-Altman plot

```{r echo=FALSE, comment=""}
blandr.draw(data$Watchpat.AHI, data$PSG.AHI, ciDisplay = FALSE , ciShading = FALSE )
```

```{r echo=FALSE, comment=""}
blandr.output.text(data$Watchpat.AHI, data$PSG.AHI, sig.level=0.95 )
```

# Sensitivity and Specificity

## >=5 events per hour