---
title: "CALICO Aim 2 Analyses - Lean Group"
author: "Tim Vigers"
date: "today"
date-format: long
format: pdf
bibliography: /Users/timvigers/Documents/Miscellaneous/zotero.bib
csl: /Users/timvigers/Documents/GitHub/styles/american-medical-association.csl
editor: source
execute:
  warning: false
  echo: false
---

```{r setup}
#| include: false
library(Hmisc)
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(gt)
library(gtsummary)
knitr::opts_knit$set(root.dir = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO")
```

```{r data import}
# Load data
load("./Data_Clean/analysis_data.RData")
# Combine factor levels
levels(df$insur_type) <- c(
  "Public", "Private", "Military", "Other/None", "Other/None"
)
df$insur_type <- relevel(df$insur_type, ref = "Private")
levels(df$combined_race) <- c(
  "African American", "Other", "Asian", "Caucasian", "More than one", "Other",
  "Other"
)
df$combined_race <- relevel(df$combined_race, ref = "Caucasian")
# Set table options
mycontrols <-
  tableby.control(numeric.stats = c("Nmiss2", "meansd", "medianq1q3", "range"))
# First visit only
cv1 <- df %>%
  group_by(record_number) %>%
  slice_min(redcap_repeat_instance) %>%
  ungroup()
# Remove crazy values for now (ask Grayson to fix in REDCap)
df$cv_monthssincepcosdx[which.max(df$cv_monthssincepcosdx)] <- NA
df$cv_weight[which.max(df$cv_weight)] <- NA
df$cv_weight[which.max(df$cv_weight)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_bmi[which.max(df$cv_bmi)] <- NA
df$cv_dbp[which.max(df$cv_dbp)] <- NA
df$cv_age[which.max(df$cv_age)] <- 17.2
df$weight_cat[df$record_number == "KC_24" &
  df$redcap_repeat_instance == 1] <- NA
df$weight_cat[df$record_number == "BCH15"] <- NA
# Exclude visits where people were on weight loss medication
weight_loss <- df %>%
  filter(
    cv_medications___25 == "Checked" | cv_medications___26 == "Checked" |
      cv_medications___27 == "Checked" | cv_medications___28 == "Checked" |
      cv_medications___29 == "Checked"
  )
progesterone_meds <- df %>%
  filter(
    cv_medications___9 == "Checked" | cv_medications___10 == "Checked" |
      cv_medications___11 == "Checked" | cv_medications___12 == "Checked"
  )
df <- df %>% filter(
  cv_medications___25 != "Checked", cv_medications___26 != "Checked",
  cv_medications___27 != "Checked", cv_medications___28 != "Checked",
  cv_medications___29 != "Checked", cv_medications___17 != "Checked",
  cv_medications___9 != "Checked", cv_medications___10 != "Checked",
  cv_medications___11 != "Checked", cv_medications___12 != "Checked"
)
# Weight group at first visit
df <- df %>%
  group_by(record_number) %>%
  mutate(weight_cat = first(weight_cat, na_rm = T))
# Stratify by weight group
df <- df %>% filter(weight_cat == "Normal weight")
# Get values at first visit
baseline <- df %>%
  group_by(record_number) %>%
  slice_min(row_number()) %>%
  select(
    record_number, cv_weight, cv_bmi, cv_bmi_percentile, pcosdx_age,
    combined_race, insur_type, cv_a1c, cv_hdl, cv_tg, cv_alt, cv_sbp, ec_ever,
    metformin_ever, lifestyle_ever
  ) %>%
  ungroup()
levels(baseline$ec_ever) <- c("EC Never", "EC Ever")
levels(baseline$metformin_ever) <- c("Metformin Never", "Metformin Ever")
levels(baseline$lifestyle_ever) <- c("Lifestyle Never", "Lifestyle Ever")
# Set table options
mycontrols <-
  tableby.control(
    numeric.stats = c("N", "Nmiss2", "meansd", "range"),
    cat.stats = c("N", "Nmiss2", "countpct")
  )
# Baseline formula
f <- ~ cv_weight + cv_bmi +
  kwt(cv_bmi_percentile, "N", "Nmiss2", "medianq1q3", "range") + pcosdx_age +
  combined_race + fe(insur_type) + cv_a1c + cv_hdl + cv_tg + cv_alt + cv_sbp +
  ec_ever + metformin_ever + lifestyle_ever
```

# Data cleaning

- KC_16's 5th visit has a `cv_monthssincepcosdx` value of 12,027 because the date of follow up is 09-03-3019. This visit is excluded for now.

- DEN-3010 has a weight of 1,152, which is excluded for now.

- DEN-3004 has a weight of 1,123.3, which is excluded for now. Same with their high BMI.

- DEN-3006 has a height of 1.55 cm, so their BMI is excluded for now.

- DEN-3010 has a BMI of 443.9, which is excluded for now.

- COL-1624 has a DBP of 701, which is excluded for now.

- KC_54 has a BMI of 237.3, which is excluded for now.

- KC_16 has a follow up age of 1017.2, which was changed to 17.2.

- Visits where the participant was actively on a weight loss medication were excluded from these analyses. So, if any of `cv_medications___25` ("Topiramate for weight loss"), `cv_medications___26` ("Phentermine for weight"), `cv_medications___27` ("Topirimate/phentermine for weight loss"), `cv_medications___28` ("Liraglutiade (saxcenda) for weight loss"), or `cv_medications___29` ("Semaglutide (Wygovy/Ozempic) for weight loss") were equal to "Checked," that row was excluded. There were a total of `r length(unique(weight_loss$record_number))` participants with a visit excluded this way, and a total of `r as.numeric(table(weight_loss$cv_medications___25)["Checked"])` visits with `cv_medications___25` checked, `r as.numeric(table(weight_loss$cv_medications___26)["Checked"])` visits with `cv_medications___26` checked, `r as.numeric(table(weight_loss$cv_medications___27)["Checked"])` visits with `cv_medications___27` checked, `r as.numeric(table(weight_loss$cv_medications___28)["Checked"])` visits with `cv_medications___28` checked, and `r as.numeric(table(weight_loss$cv_medications___29)["Checked"])` visits with `cv_medications___29` checked.

- Visits where the participant was on atypical antipsychotics were excluded (`cv_medications___17` == "Checked"). 

- We also excluded `r nrow(progesterone_meds)` visits where the participant was on progesterone-containing medications. There were `r sum(progesterone_meds$cv_medications___9=="Checked")` with `cv_medication_9` checked, `r sum(progesterone_meds$cv_medications___10=="Checked")` with `cv_medication_10` checked, `r sum(progesterone_meds$cv_medications___11=="Checked")` with `cv_medication_11` checked, and `r sum(progesterone_meds$cv_medications___12=="Checked")` with `cv_medication_12` checked.

# Methods

For each continuous outcome, we fit a linear mixed effects model with random effects for participant, and an interaction effect between time and medication status. 

To evaluate the effect of starting a new medication on each outcome, we also fit a linear spline model with months from medication start as the time variable and a single knot at 0 (medication start).

All models were adjusted for age, race, and insurance status. EC models were adjusted for Metformin use, and vice versa. Population averaged model results are for a hypothetical participant assuming a mean baseline weight, mean age, caucasian race, and on private insurance.

Analyses were stratified by weight category at first visit. If BMI percentile was available, < 85 was considered normal weight, >= 85 and < 95 was considered overweight, and >= 95 was considered obese. If percentile was not available, a raw BMI of < 25 was considered normal weight, >= 25 and < 30 was considered overweight, and >= 30 was considered obese.

All mixed models were fit using the `lme4` R package in version `r paste0(R.version$major,".",R.version$minor)`. @rcoreteamLanguageEnvironmentStatistical2024

# Estrogen-containing medication

Participants were considered to be on estrogen-containing (EC) medications when `cv_medications___5` (estrogen-containing pill), `cv_medications___6` (estrogen-containing patch), or `cv_medications___7` (estrogen-containing ring) boxes were checked in REDCap.

```{r}
# Make a dataset for spline models
ec_only <- df %>%
  filter(ec_ever == "Yes") %>%
  mutate(
    time_from_first_ec = (cv_age - age_first_ec) * 12,
    x = (time_from_first_ec > 0) * time_from_first_ec
  )
label(ec_only$time_from_first_ec) <- "Months From First EC"
label(ec_only$x) <- "Slope Change After EC"
```

## Comparisons at first visit

```{r results='asis'}
t1 <- tableby(update(f, ec_ever ~ . - ec_ever),
  data = baseline,
  control = mycontrols
)
summary(t1, pfootnote = T, digits = 4, digits.p = 4)
```

## Weight (kg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_weight, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## BMI

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_bmi, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_a1c, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_tg, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_hdl, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## ALT (IU/L) 

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_alt, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(ec)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_sbp, group = record_number,
    color = ec
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On EC?") +
  theme_bw()
p
```

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = ec, color = ec)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On EC?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$ec)["No"])` "No" and `r as.numeric(table(mod_df$ec)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From EC Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

# Metformin

Participants were considered to be on Metformin when `cv_medications___1` was checked in REDCap.

```{r}
# Make a dataset for spline models
metformin_only <- df %>%
  filter(metformin_ever == "Yes") %>%
  mutate(
    time_from_first_metformin = (cv_age - age_first_metformin) * 12,
    x = (time_from_first_metformin > 0) * time_from_first_metformin
  )
label(metformin_only$time_from_first_metformin) <- "Months From First Metformin"
label(metformin_only$x) <- "Slope Change After Metformin"
```

## Comparisons at first visit

```{r results='asis'}
t1 <- tableby(update(f, metformin_ever ~ . - metformin_ever),
  data = baseline,
  control = mycontrols
)
summary(t1, pfootnote = T, digits = 4, digits.p = 4)
```

## Weight (kg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_weight, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## BMI

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_bmi, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_a1c, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_tg, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_hdl, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## ALT (IU/L) 

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_alt, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(metformin)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_sbp, group = record_number,
    color = metformin
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Metformin?") +
  theme_bw()
p
```

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = metformin, color = metformin)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Metformin?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$metformin)["No"])` "No" and `r as.numeric(table(mod_df$metformin)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec +
  (1 | record_number), data = metformin_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Metformin Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

# Lifestyle Medicine

Participants were considered to be "on lifestyle medicine" when not on Metformin or EC as described above.

```{r}
# Make a dataset for spline models
lifestyle_only <- df %>%
  filter(lifestyle_ever == "Yes") %>%
  mutate(
    time_from_first_lifestyle = (cv_age - age_first_lifestyle) * 12,
    x = (time_from_first_lifestyle > 0) * time_from_first_lifestyle
  )
label(lifestyle_only$time_from_first_lifestyle) <- "Months From First Lifestyle Medicine"
label(lifestyle_only$x) <- "Slope Change After Lifestyle Medicine"
```

## Comparisons at first visit

```{r results='asis'}
t1 <- tableby(update(f, lifestyle_ever ~ . - lifestyle_ever),
  data = baseline,
  control = mycontrols
)
summary(t1, pfootnote = T, digits = 4, digits.p = 4)
```

## Weight (kg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_weight, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## BMI

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_bmi, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_bmi, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_a1c, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_a1c, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_tg, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_tg, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_hdl, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_hdl, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## ALT (IU/L) 

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_alt, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_alt, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Spaghetti plot

```{r}
p <- df %>%
  filter(!is.na(lifestyle)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_sbp, group = record_number,
    color = lifestyle
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On Lifestyle Medicine?") +
  theme_bw()
p
```

### Model results

#### Lifestyle Medicine users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = lifestyle, color = lifestyle)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On Lifestyle Medicine?") +
  theme_classic()
p
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
```

The model above was fit using `r nrow(mod_df)` observations (`r as.numeric(table(mod_df$lifestyle)["No"])` "No" and `r as.numeric(table(mod_df$lifestyle)["Yes"])` "Yes"). In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on lifestyle medicine and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on lifestyle medicine compared to not on lifestyle medicine. The second table shows the slopes for those not on lifestyle medicine and on lifestyle medicine, and the third table shows the difference in slopes (both table estimates are averaged over the other variables in the model).

#### Change pre- vs. post-lifestyle medicine (lifestyle medicine users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type +
  (1 | record_number), data = lifestyle_only)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age, na.rm = T)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA, newdata = mod_df)
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_point(aes(y = cv_sbp, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Months From Lifestyle Medicine Start") +
  theme_classic()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

The model above was fit using `r nrow(mod_df)` observations. In the table, the row labeled "Months From First Lifestyle Medicine" is the slope prior to starting medication, and the "Slope Change After Lifestyle Medicine" row shows the average change in slope after starting the medication.
