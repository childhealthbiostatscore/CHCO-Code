---
title: "Long-Acting Reversible Contraception (LARC) Analyses for BCH"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-width: 12
    fig-height: 9
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: C:/Users/timvigers/Dropbox/Miscellaneous/zotero.bib
csl: C:/Users/timvigers/Documents/GitHub/styles/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(gtsummary)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
#| include: false
# Load data
load("./Data_Clean/analysis_data.RData")
```

# Data cleaning

- Participants were assumed to be on LARC if `cv_medications___10` ("Progesterone implant") or `cv_medications___11` ("Progesterone IUD") were checked at a given visit.

- There are 10 participants who were started on either implant or IUD at a clinic visit, but who don't have the medication listed at the next visit. For the purposes of these analysis, I assumed that the new medications fields should be ignored and that the current medications field better reflects who was actually on LARC.

# Demographics

```{r results='asis'}
#| label: tbl-table-1
#| tbl-cap: Participant demographics at first visit
df %>%
  filter(is.na(df$redcap_repeat_instrument)) %>%
  select(larc_ever, all_of(demo_vars), combined_race) %>%
  tbl_summary(by = larc_ever, missing_text = "Missing") %>%
  add_overall() %>%
  add_p(test.args = all_tests("fisher.test") ~ list(simulate.p.value = T)) %>%
  separate_p_footnotes()
```

# Mixed models

## Weight

1. Log transform?
2. How many visit do we want to look at?
3. Do we want a different x-axis like time from diagnosis?

```{r}
# Plot
df %>%
  filter(redcap_repeat_instrument == "Clinical Visit") %>%
  ggplot(aes(
    x = factor((redcap_repeat_instance)), y = cv_weight, group = record_number,
    color = larc
  )) +
  geom_line(alpha = 0.1) +
  geom_smooth(aes(group = larc), se = F) +
  theme_bw()
# Model
```
