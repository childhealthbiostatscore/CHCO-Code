---
title: "Long-Acting Reversible Contraception (LARC) Analyses for BCH"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-width: 12
    fig-height: 9
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Documents/Miscellaneous/zotero.bib
csl: /Users/timvigers/GitHub/styles/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
library(Hmisc)
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(gt)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
#| include: false
# Load data
load("./Data_Clean/analysis_data.RData")
# Set table options
mycontrols <-
  tableby.control(numeric.stats = c("Nmiss2", "meansd", "medianq1q3", "range"))
# First visit only
cv1 <- df %>%
  group_by(record_number) %>%
  slice_min(redcap_repeat_instance) %>%
  ungroup()
```

# Data cleaning

- Participants were assumed to be on LARC if `cv_medications___10` ("Progesterone implant") or `cv_medications___11` ("Progesterone IUD") were checked at a given visit.

- There are 10 participants who were started on either implant or IUD at a clinic visit, but who don't have the medication listed at the next visit. For the purposes of these analysis, I assumed that the new medications fields should be ignored and that the current medications field better reflects who was actually on LARC.

- Months since PCOS diagnosis was used as the time variable in longitudinal analyses, and was treated as a continuous variable.

# Demographics

```{r results='asis'}
#| label: tbl-table-1
#| tbl-cap: Participant demographics by LARC use at first visit
f <- as.formula(paste0(
  "larc_ever ~ ",
  paste0(c(
    demo_vars, "combined_race", "age_first_larc", "time_pcos_to_first_larc",
    "time_menarche_to_first_larc"
  ), collapse = "+")
))
t1 <- tableby(f, data = cv1, control = mycontrols)
summary(t1, labelTranslations = labels(df), pfootnote = T)
```

# Mixed models

For each continuous outcome, we fit a linear mixed effects model with random effects for participant and time (months from PCOS diagnosis), and an interaction effect between time and LARC status. To evaluate the effect of starting LARC on each outcome, we also fit a linear spline model with years from LARC start as the time variable and a single knot at 0 (LARC start). 

## Weight

### Spaghetti plot

```{r}
#| warning: false
df %>%
  filter(!is.na(larc)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_weight, group = record_number,
    color = larc
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On LARC?") +
  theme_bw()
```

### Model results

#### LARC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * larc +
    (1 + cv_monthssincepcosdx | record_number),
  data = df
)
# Model plot
mod_df <- mod@frame
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA)
ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = larc, color = larc)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On LARC?") +
  theme_classic()
# Model summary
mod %>% gtsummary::tbl_regression()
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
gt(as.data.frame(pairs(emt))) %>% fmt_number(decimals = 3)
```

#### Change pre- vs. post-LARC (LARC users only)

```{r}
# Make a dataset for spline models
larc_only <- df %>%
  filter(larc_ever == "Yes") %>%
  mutate(
    time_from_first_larc = cv_age - age_first_larc,
    x = (time_from_first_larc > 0) * time_from_first_larc
  ) %>%
  dplyr::select(
    record_number, redcap_repeat_instance, cv_weight, larc, cv_age,
    cv_monthssincepcosdx, age_first_larc, time_from_first_larc, x
  )
label(larc_only$time_from_first_larc) <- "Time From First LARC"
label(larc_only$x) <- "Slope Change After LARC"
# Fit mixed model
change_mod <- lmer(cv_weight ~ time_from_first_larc + x +
  (1 + time_from_first_larc | record_number), data = larc_only)
# Model plot
mod_df <- change_mod@frame
mod_df$ind_pred <- predict(change_mod)
mod_df$pop_pred <- predict(change_mod, re.form = NA)
ggplot(mod_df, aes(x = time_from_first_larc)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred)) +
  xlab("Years From LARC Start") +
  theme_classic()
# Model summary
change_mod %>% gtsummary::tbl_regression()
```
