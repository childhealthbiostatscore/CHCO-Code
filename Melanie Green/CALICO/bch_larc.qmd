---
title: "Long-Acting Reversible Contraception (LARC) Analyses for BCH"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    fig-width: 12
    fig-height: 9
    page-layout: full
    theme:
      light: flatly
      dark: darkly
bibliography: /Users/timvigers/Dropbox/Miscellaneous/zotero.bib
csl: /Users/timvigers/GitHub/styles/american-medical-association.csl
editor: source
---

```{r setup}
#| include: false
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(gt)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Windows" = "C:/Users/timvigers/OneDrive - The University of Colorado Denver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
#| include: false
# Load data
load("./Data_Clean/analysis_data.RData")
# Set table options
mycontrols <-
  tableby.control(numeric.stats = c("Nmiss2", "meansd", "medianq1q3", "range"))
# First visit only
cv1 <- df %>%
  group_by(record_number) %>%
  slice_min(redcap_repeat_instance) %>%
  ungroup()
```

# Data cleaning

- Participants were assumed to be on LARC if `cv_medications___10` ("Progesterone implant") or `cv_medications___11` ("Progesterone IUD") were checked at a given visit.

- There are 10 participants who were started on either implant or IUD at a clinic visit, but who don't have the medication listed at the next visit. For the purposes of these analysis, I assumed that the new medications fields should be ignored and that the current medications field better reflects who was actually on LARC.

- Months since PCOS diagnosis was used as the time variable in longitudinal analyses, and was treated as a continuous variable.

- CHOP2024-34 has a months since PCOS diagnosis value of 12019.6, which is excluded from these analyses.

- Has COL-1638 really had PCOS for 19 years? That seems like an outlier.

# Demographics

```{r results='asis'}
#| label: tbl-table-1
#| tbl-cap: Participant demographics by LARC use at first visit
f <- as.formula(paste0(
  "larc_ever ~ ",
  paste0(c(
    demo_vars, "combined_race", "age_first_larc", "time_pcos_to_first_larc",
    "time_menarche_to_first_larc"
  ), collapse = "+")
))
t1 <- tableby(f, data = cv1, control = mycontrols)
summary(t1, labelTranslations = labels(df), pfootnote = T)
```

# Mixed models

## Weight

1. Log transform?
2. How many visits do we want to look at?
3. Do we want a different x-axis like time from diagnosis?

### Spaghetti plot

```{r}
#| warning: false
df %>%
  filter(!is.na(larc)) %>%
  ggplot(aes(
    x = cv_monthssincepcosdx, y = cv_weight, group = record_number,
    color = larc
  )) +
  geom_line(alpha = 0.3) +
  labs(color = "On LARC?") +
  theme_bw()
```

### Model results

```{r}
# Fit mixed model
mod <-
  lmer(cv_weight ~ cv_monthssincepcosdx * larc + (1 | record_number), data = df)
# Model plot
mod_df <- mod@frame
mod_df$ind_pred <- predict(mod)
mod_df$pop_pred <- predict(mod, re.form = NA)
ggplot(mod_df, aes(x = cv_monthssincepcosdx)) +
  geom_point(aes(y = cv_weight, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = ind_pred, group = record_number),
    alpha = 0.05, show.legend = F
  ) +
  geom_line(aes(y = pop_pred, group = larc, color = larc)) +
  xlab("Months from PCOS Dx") +
  labs(color = "On LARC?") +
  theme_classic()
# Model summary
mod %>% gtsummary::tbl_regression()
# EMMs
emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 3)
gt(as.data.frame(pairs(emt))) %>% fmt_number(decimals = 3)
```
