---
title: "CALICO Aim 2 Analyses"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(Hmisc)
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(gtsummary)
library(gt)
library(ggeffects)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# Load data
load("./Data_Clean/analysis_data.RData")
# Combine factor levels
levels(df$insur_type) <- c(
  "Public", "Private", "Military", "Other/None", "Other/None"
)
df$insur_type <- relevel(df$insur_type, ref = "Private")
levels(df$combined_race) <- c(
  "African American", "Other", "Asian", "Caucasian", "More than one", "Other",
  "Other"
)
df$combined_race <- relevel(df$combined_race, ref = "Caucasian")
# Remove crazy values for now (ask Grayson to fix in REDCap)
df$cv_dbp[df$cv_dbp >= 200] <- NA
df$cv_bmi[df$cv_bmi >= 200] <- NA
df$cv_weight[df$cv_weight >= 1000] <- NA
df$cv_monthssincepcosdx[df$cv_monthssincepcosdx >= 1000] <- NA
df$cv_age[which.max(df$cv_age)] <- 17.2
df$weight_cat[df$record_number == "KC_24" &
  df$redcap_repeat_instance == 1] <- NA
df$weight_cat[df$record_number == "BCH15"] <- NA
# Get time of medication start for EC, Metformin, "lifestyle", and baseline
# weight
df <- df %>%
  arrange(record_number, cv_monthssincepcosdx) %>%
  group_by(record_number) %>%
  mutate(
    time_of_first_ec = first(cv_monthssincepcosdx[ec == "Yes"], na_rm = T),
    time_from_first_ec = cv_monthssincepcosdx - time_of_first_ec,
    time_of_first_metformin =
      first(cv_monthssincepcosdx[metformin == "Yes"], na_rm = T),
    time_from_first_metformin = cv_monthssincepcosdx - time_of_first_metformin,
    time_of_first_lifestyle =
      first(cv_monthssincepcosdx[lifestyle == "Yes"], na_rm = T),
    time_from_first_lifestyle = cv_monthssincepcosdx - time_of_first_lifestyle,
    baseline_weight = first(cv_weight, na_rm = T),
    baseline_bmi = first(cv_weight, na_rm = T)
  )
label(df$time_from_first_ec) <- "Time from First Visit on EC"
label(df$time_from_first_metformin) <- "Time from First Visit on Metformin"
label(df$time_from_first_lifestyle) <-
  "Time from First Visit Not on Metformin or EC"
label(df$baseline_weight) <- "Baseline Weight (kg)"
label(df$baseline_bmi) <- "Baseline BMI"
# Exclude visits where people were on weight loss medication or progesterone
weight_loss <- df %>%
  filter(
    cv_medications___25 == "Checked" | cv_medications___26 == "Checked" |
      cv_medications___27 == "Checked" | cv_medications___28 == "Checked" |
      cv_medications___29 == "Checked"
  )
progesterone_meds <- df %>%
  filter(
    cv_medications___9 == "Checked" | cv_medications___10 == "Checked" |
      cv_medications___11 == "Checked" | cv_medications___12 == "Checked"
  )
spironolactone <- df %>% filter(cv_medications___16 == "Checked")
df <- df %>% filter(
  cv_medications___25 != "Checked", cv_medications___26 != "Checked",
  cv_medications___27 != "Checked", cv_medications___28 != "Checked",
  cv_medications___29 != "Checked",
  cv_medications___16 != "Checked", cv_medications___17 != "Checked",
  cv_medications___9 != "Checked", cv_medications___10 != "Checked",
  cv_medications___11 != "Checked", cv_medications___12 != "Checked"
)
# Simplify the dataset
df <- df %>%
  select(
    record_number, combined_race, insur_type, cv_age, pcosdx_age,
    baseline_weight, baseline_bmi, cv_monthssincepcosdx, cv_medications___16,
    ec, metformin, lifestyle, time_from_first_ec, time_from_first_metformin,
    time_from_first_lifestyle, cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl,
    cv_alt, cv_sbp
  ) %>%
  arrange(record_number, cv_monthssincepcosdx)
# Write for Melanie and Grayson to check
write.csv(df,
  file = "./Data_Clean/aim_2_cleaned_data.csv", row.names = F, na = ""
)
# Set table options
mycontrols <-
  tableby.control(
    numeric.stats = c("N", "Nmiss2", "meansd", "range"),
    cat.stats = c("N", "Nmiss2", "countpct")
  )
```

# Data cleaning

- KC_16's 5th visit has a `cv_monthssincepcosdx` value of 12,027 because the date of follow up is 09-03-3019. This visit is excluded for now.

- DEN-3010 has a weight of 1,152, which is excluded for now.

- DEN-3004 has a weight of 1,123.3, which is excluded for now. Same with their high BMI.

- DEN-3006 has a height of 1.55 cm, so their BMI is excluded for now.

- DEN-3010 has a BMI of 443.9, which is excluded for now.

- COL-1624 has a DBP of 701, which is excluded for now.

- KC_54 has a BMI of 237.3, which is excluded for now.

- KC_16 has a follow up age of 1017.2, which was changed to 17.2.

- Visits where the participant was actively on a weight loss medication were excluded from these analyses. So, if any of `cv_medications___25` ("Topiramate for weight loss"), `cv_medications___26` ("Phentermine for weight"), `cv_medications___27` ("Topirimate/phentermine for weight loss"), `cv_medications___28` ("Liraglutiade (saxcenda) for weight loss"), or `cv_medications___29` ("Semaglutide (Wygovy/Ozempic) for weight loss") were equal to "Checked," that row was excluded. There were a total of `r length(unique(weight_loss$record_number))` participants with a visit excluded this way, and a total of `r as.numeric(table(weight_loss$cv_medications___25)["Checked"])` visits with `cv_medications___25` checked, `r as.numeric(table(weight_loss$cv_medications___26)["Checked"])` visits with `cv_medications___26` checked, `r as.numeric(table(weight_loss$cv_medications___27)["Checked"])` visits with `cv_medications___27` checked, `r as.numeric(table(weight_loss$cv_medications___28)["Checked"])` visits with `cv_medications___28` checked, and `r as.numeric(table(weight_loss$cv_medications___29)["Checked"])` visits with `cv_medications___29` checked.

- Visits where the participant was on atypical antipsychotics were excluded (`cv_medications___17` == "Checked"). 

- We also excluded `r nrow(progesterone_meds)` visits where the participant was on progesterone-containing medications. There were `r sum(progesterone_meds$cv_medications___9=="Checked")` with `cv_medication_9` checked, `r sum(progesterone_meds$cv_medications___10=="Checked")` with `cv_medication_10` checked, `r sum(progesterone_meds$cv_medications___11=="Checked")` with `cv_medication_11` checked, and `r sum(progesterone_meds$cv_medications___12=="Checked")` with `cv_medication_12` checked.

- Visits where the participant was on spironolactone were excluded (`r nrow(spironolactone)` with `cv_medications___16` checked)

- About 25% of clinic visits were missing `cv_age` so I recalculated this variable using `cv_monthssincepcosdx` and `pcosdx_age`.

# Methods

For each continuous outcome, we fit a linear mixed effects model with random effects for participant, and an interaction effect between time and medication status. 

To evaluate the effect of starting a new medication on each outcome, we also fit a linear spline model with months from medication start as the time variable and a single knot at 0 (medication start).

All models were adjusted for race, insurance status at diagnosis, age, and spironolactone use. EC models were adjusted for Metformin use, and vice versa.

Analyses were stratified by weight category at first visit. If BMI percentile was available, < 85 was considered normal weight, >= 85 and < 95 was considered overweight, and >= 95 was considered obese. If percentile was not available, a raw BMI of < 25 was considered normal weight, >= 25 and < 30 was considered overweight, and >= 30 was considered obese.

All mixed models were fit using the `lme4` R package in version `r paste0(R.version$major,".",R.version$minor)`. @rcoreteamLanguageEnvironmentStatistical2024

# Estrogen-containing medication

Participants were considered to be on estrogen-containing (EC) medications when `cv_medications___5` (estrogen-containing pill), `cv_medications___6` (estrogen-containing patch), or `cv_medications___7` (estrogen-containing ring) boxes were checked in REDCap.

## Weight (kg)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * ec + cv_age + baseline_weight +
    combined_race + insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
never_ec <- setdiff(
  df$record_number,
  unique(df$record_number[df$ec == "Yes"])
)
# Create a dataset for the spline model
ec_12_month_spline <- df %>%
  filter(
    !record_number %in% never_ec,
    (time_from_first_ec < 0 & time_from_first_ec > -12) |
      time_from_first_ec >= 0 & ec == "Yes"
  ) %>%
  mutate(x = (time_from_first_ec > 0) * time_from_first_ec) %>%
  arrange(record_number, cv_monthssincepcosdx)
label(ec_12_month_spline$x) <- "Change in Slope After EC Start"
# Write for Melanie and Grayson to check
write.csv(ec_12_month_spline,
  file = "./Data_Clean/ec_12_month_spline.csv", row.names = F, na = ""
)
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_ec + x + baseline_weight +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## BMI

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * ec + cv_age + baseline_bmi + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_ec + x + baseline_bmi +
  cv_age + combined_race + insur_type + metformin +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * ec + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_a1c ~ time_from_first_ec + x + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = ec_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * ec + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_tg ~ time_from_first_ec + x + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = ec_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * ec + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_hdl ~ time_from_first_ec + x + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = ec_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * ec + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_alt ~ time_from_first_ec + x + cv_age + combined_race + insur_type +
    metformin + (1 | record_number),
  data = ec_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Model results

#### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * ec + cv_age + combined_race +
    insur_type + metformin + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC.

#### Change pre- vs. post-EC (EC users only)

To evaluate change in outcomes pre- vs. post-EC, we limited the dataset to people who were on EC at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_sbp ~ time_from_first_ec + x + cv_age + combined_race + insur_type +
    metformin + (1 | record_number),
  data = ec_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

# Metformin

## Weight (kg)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * metformin + cv_age + baseline_weight +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
never_metformin <- setdiff(
  df$record_number,
  unique(df$record_number[df$metformin == "Yes"])
)
# Create a dataset for the spline model
metformin_12_month_spline <- df %>%
  filter(
    !record_number %in% never_metformin,
    (time_from_first_metformin < 0 & time_from_first_metformin > -12) |
      time_from_first_metformin >= 0 & metformin == "Yes"
  ) %>%
  mutate(x = (time_from_first_metformin > 0) * time_from_first_metformin) %>%
  arrange(record_number, cv_monthssincepcosdx)
label(metformin_12_month_spline$x) <- "Change in Slope After Metformin Start"
# Write for Melanie and Grayson to check
write.csv(metformin_12_month_spline,
  file = "./Data_Clean/metformin_12_month_spline.csv", row.names = F, na = ""
)
# Fit mixed model with change point
change_mod <- lmer(
  cv_weight ~ time_from_first_metformin + x + baseline_weight +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## BMI

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * metformin + cv_age + baseline_bmi +
    combined_race + insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_bmi ~ time_from_first_metformin + x + baseline_bmi +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * metformin + cv_age + combined_race +
    insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_a1c ~ time_from_first_metformin + x +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * metformin + cv_age + combined_race +
    insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_tg ~ time_from_first_metformin + x +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * metformin + cv_age + combined_race +
    insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_hdl ~ time_from_first_metformin + x +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * metformin + cv_age + combined_race +
    insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_alt ~ time_from_first_metformin + x +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Model results

#### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * metformin + cv_age + combined_race +
    insur_type + ec + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin.

#### Change pre- vs. post-Metformin (Metformin users only)

To evaluate change in outcomes pre- vs. post-Metformin, we limited the dataset to people who were on Metformin at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_sbp ~ time_from_first_metformin + x +
    cv_age + combined_race + insur_type + ec + (1 | record_number),
  data = metformin_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

# Lifestyle

## Weight (kg)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_weight +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
never_lifestyle <- setdiff(
  df$record_number,
  unique(df$record_number[df$lifestyle == "Yes"])
)
# Create a dataset for the spline model
lifestyle_12_month_spline <- df %>%
  filter(
    !record_number %in% never_lifestyle,
    (time_from_first_lifestyle < 0 & time_from_first_lifestyle > -12) |
      time_from_first_lifestyle >= 0 & lifestyle == "Yes"
  ) %>%
  mutate(x = (time_from_first_lifestyle > 0) * time_from_first_lifestyle) %>%
  arrange(record_number, cv_monthssincepcosdx)
label(lifestyle_12_month_spline$x) <- "Change in Slope After Lifestyle Start"
# Write for Melanie and Grayson to check
write.csv(lifestyle_12_month_spline,
  file = "./Data_Clean/lifestyle_12_month_spline.csv", row.names = F, na = ""
)
# Fit mixed model with change point
change_mod <- lmer(
  cv_weight ~ time_from_first_lifestyle + x + baseline_weight +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## BMI

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_bmi +
    combined_race + insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_bmi ~ time_from_first_lifestyle + x + baseline_bmi +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * lifestyle + cv_age + combined_race +
    insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_a1c ~ time_from_first_lifestyle + x +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * lifestyle + cv_age + combined_race +
    insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_tg ~ time_from_first_lifestyle + x +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * lifestyle + cv_age + combined_race +
    insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_hdl ~ time_from_first_lifestyle + x +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * lifestyle + cv_age + combined_race +
    insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_alt ~ time_from_first_lifestyle + x +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Model results

#### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * lifestyle + cv_age + combined_race +
    insur_type + (1 | record_number),
  data = df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle and in the reference group for categorical variables. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle.

#### Change pre- vs. post-Lifestyle (Lifestyle users only)

To evaluate change in outcomes pre- vs. post-Lifestyle, we limited the dataset to people who were on Lifestyle at some point. We also limited the "before" medication data to observations within 12 months prior to medication start. All clinic visits after first medication exposure where the participants were recorded as not on medication were excluded from the analyses. 

```{r}
# Fit mixed model with change point
change_mod <- lmer(
  cv_sbp ~ time_from_first_lifestyle + x +
    cv_age + combined_race + insur_type + (1 | record_number),
  data = lifestyle_12_month_spline
)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey"
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.
