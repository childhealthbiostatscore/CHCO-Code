---
title: "CALICO Aim 2 Analyses"
author: "Tim Vigers"
date: "today"
date-format: long
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    fig-cap-location: top
    page-layout: full
editor: source
---

```{r setup}
#| include: false
library(Hmisc)
library(tidyverse)
library(arsenal)
library(lmerTest)
library(performance)
library(emmeans)
library(ggeffects)
home_dir <- switch(Sys.info()["sysname"],
  "Darwin" = "/Users/timvigers/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Vigers/BDC/Janet Snell-Bergeon/CALICO",
  "Linux" = "/home/timvigers/OneDrive/Vigers/BDC/Janet Snell-Bergeon/CALICO"
)
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data import}
# Load data
load("./Data_Clean/analysis_data.RData")
# Combine factor levels
levels(df$insur_type) <- c(
  "Public", "Private", "Military", "Other/None", "Other/None"
)
df$insur_type <- relevel(df$insur_type, ref = "Private")
levels(df$combined_race) <- c(
  "African American", "Other", "Asian", "Caucasian", "More than one", "Other",
  "Other"
)
df$combined_race <- relevel(df$combined_race, ref = "Caucasian")
# Write a function to determine which visits to include
visits_exclude <- function(data = d, column) {
  # To dataframe
  data <- as.data.frame(data)
  # Yes and no run lengths, and the length of time between
  r <- rle(as.character(data[, column]))
  r <- data.frame(value = r$values, length = r$lengths)
  # Get the end
  r$end <- cumsum(r$length)
  # Get the start
  r$start <- r$end - r$length + 1
  # Length of time between start and end
  r$months <- as.numeric(data$cv_monthssincepcosdx[r$end] -
    data$cv_monthssincepcosdx[r$start])
  # If they only have one unique value, don't remove anything
  if (nrow(r) == 1) {
    data$remove <- NA
  } else if (r$value[1] == "Yes") {
    # If they start as "Yes" remove everything after first "No"
    data$remove[r$start[2]:nrow(data)] <- "Remove"
  } else if (r$value[1] == "No") {
    # If they start a medication after diagnosis, check that they are on it
    # for at least 3 months
    first_yes <- which(r$value == "Yes" & r$months > 3)[1]
    if (is.na(first_yes) & any(r$value == "Yes" & (r$end > r$start))) {
      # If there is no 3 month stretch, but there are consecutive visits, remove
      # everything after the first "Yes"
      data$remove[r$start[2]:nrow(data)] <- "Remove"
    } else if (is.na(first_yes) & !any(r$value == "Yes" & (r$end > r$start))) {
      data$remove <- NA
    } else if (r$end[first_yes] == nrow(data)) {
      # If the first stretch of "yes" values doesn't end, don't exclude anything
      data$remove <- NA
    } else {
      # Otherwise remove anything after the end of the first "Yes" stretch
      data$remove[(r$end[first_yes] + 1):nrow(data)] <- "Remove"
    }
    # Remove any visits with a "Yes" singleton
    data$remove[r[r$value == "Yes" & r$length == 1, "start"]] <- "Remove"
  }
  # # Checking
  # t <- data %>% select(record_number, cv_monthssincepcosdx, lifestyle, remove)
  # r$record_number <- data$record_number[1]
  # return(r)
  # Return
  return(data$remove)
}
# This is probably not the most elegant approach, but it seems to work.
dfs <- split(data.frame(df), df$record_number)
dfs <- lapply(dfs, function(d) {
  print(d$record_number[1])
  # Get removal vector for each med
  d$ec_remove <- visits_exclude(d, "ec")
  d$metformin_remove <- visits_exclude(d, "metformin")
  d$lifestyle_remove <- visits_exclude(d, "lifestyle")
  # Return new dataframe for combining later
  return(d)
})
t <- do.call(rbind, dfs)
t <- t %>%
  select(
    record_number, cv_monthssincepcosdx, ec, ec_remove, metformin,
    metformin_remove, lifestyle, lifestyle_remove
  )
write.csv(t,
  file = "./Data_Clean/aim_2_data_check.csv", row.names = F, na = ""
)
# Get time of medication start for EC, Metformin, "Lifestyle", plus baseline
# weight and BMI
df <- df %>%
  arrange(record_number, cv_monthssincepcosdx) %>%
  group_by(record_number) %>%
  mutate(
    time_of_first_weight_loss = first(cv_monthssincepcosdx[weight_loss == "Yes"], na_rm = T),
    time_from_first_weight_loss = cv_monthssincepcosdx - time_of_first_weight_loss,
    time_of_first_progesterone = first(cv_monthssincepcosdx[progesterone == "Yes"], na_rm = T),
    time_from_first_progesterone = cv_monthssincepcosdx - time_of_first_progesterone,
    ec_diff = as.numeric(ec) - lead(as.numeric(ec)),
    time_of_first_ec = first(cv_monthssincepcosdx[ec == "Yes" & ec_diff == 0], na_rm = T),
    time_of_last_ec = first(cv_monthssincepcosdx[ec == "Yes" & ec_diff == 1], na_rm = T),
    time_from_first_ec = cv_monthssincepcosdx - time_of_first_ec,
    metformin_diff = as.numeric(metformin) - lead(as.numeric(metformin)),
    time_of_first_metformin = first(cv_monthssincepcosdx[metformin == "Yes" &
      metformin_diff == 0], na_rm = T),
    time_from_first_metformin = cv_monthssincepcosdx - time_of_first_metformin,
    lifestyle_diff = as.numeric(lifestyle) - lead(as.numeric(lifestyle)),
    time_of_first_lifestyle = first(cv_monthssincepcosdx[lifestyle == "Yes" &
      lifestyle_diff == 0], na_rm = T),
    time_from_first_lifestyle = cv_monthssincepcosdx - time_of_first_lifestyle,
    baseline_weight = first(cv_weight, na_rm = T),
    baseline_bmi = first(cv_bmi, na_rm = T)
  )
label(df$time_from_first_weight_loss) <- "Months from First Visit on Weight Loss Medication"
label(df$time_from_first_progesterone) <-
  "Months from First Visit on Progesterone-Containing Medication"
label(df$time_from_first_ec) <- "Months from First Visit on EC"
label(df$time_from_first_metformin) <- "Months from First Visit on Metformin"
label(df$time_from_first_lifestyle) <-
  "Months from First Visit Not on Metformin or EC"
label(df$baseline_weight) <- "Baseline Weight (kg)"
label(df$baseline_bmi) <- "Baseline BMI (kg/m2)"
# For weight loss medication and progesterone, remove all visits after
# they first start
df$weight_loss_remove <- NA
df$weight_loss_remove[which(df$time_from_first_weight_loss >= 0)] <- "Remove"
df <- df %>%
  group_by(record_number) %>%
  fill(weight_loss_remove, .direction = "down")
df$progesterone_remove <- NA
df$progesterone_remove[which(df$time_from_first_progesterone >= 0)] <- "Remove"
df <- df %>%
  group_by(record_number) %>%
  fill(progesterone_remove, .direction = "down")
# Don't allow people to go on and off medication, so for example once they've
# started EC for the first time, exclude any visits where they go back to
# not on EC after that. If they have random "Yes" visits but never consistently
# started medication, remove those visits
df$ec_remove <- NA
df$ec_remove[which(df$time_from_first_ec > 0 & df$ec == "No")] <- "Remove"
df <- df %>%
  group_by(record_number) %>%
  fill(ec_remove, .direction = "down")
df$ec_remove[df$ec == "Yes" & is.na(df$time_from_first_ec)] <- "Remove"
df$metformin_remove <- NA
df$metformin_remove[which(df$time_from_first_metformin > 0 & df$metformin == "No")] <- "Remove"
df <- df %>%
  group_by(record_number) %>%
  fill(metformin_remove, .direction = "down")
df$metformin_remove[df$metformin == "Yes" & is.na(df$time_from_first_metformin)] <- "Remove"
df$lifestyle_remove <- NA
df$lifestyle_remove[which(df$time_from_first_lifestyle > 0 & df$lifestyle == "No")] <- "Remove"
df <- df %>%
  group_by(record_number) %>%
  fill(lifestyle_remove, .direction = "down")
df$lifestyle_remove[df$lifestyle == "Yes" & is.na(df$time_from_first_lifestyle)] <- "Remove"
# Simplify the dataset and write for checking
df <- df %>%
  select(
    record_number, combined_race, insur_type, cv_age, pcosdx_age,
    cv_monthssincepcosdx, baseline_weight, baseline_bmi,
    cv_medications___16,
    time_from_first_weight_loss, weight_loss, weight_loss_remove,
    time_from_first_progesterone, progesterone, progesterone_remove,
    time_from_first_ec, ec, ec_remove,
    time_from_first_metformin, metformin, metformin_remove,
    time_from_first_lifestyle, lifestyle, lifestyle_remove,
    cv_weight, cv_bmi, cv_a1c, cv_tg, cv_hdl, cv_alt, cv_sbp
  )
write.csv(df,
  file = "./Data_Clean/aim_2_data_check.csv", row.names = F, na = ""
)
```

# Data cleaning

- Visits where the participant was actively on a weight loss medication were excluded from these analyses. So, if any of `cv_medications___25` ("Topiramate for weight loss"), `cv_medications___26` ("Phentermine for weight"), `cv_medications___27` ("Topirimate/phentermine for weight loss"), `cv_medications___28` ("Liraglutiade (saxcenda) for weight loss"), or `cv_medications___29` ("Semaglutide (Wygovy/Ozempic) for weight loss") were equal to "Checked," that row was excluded. There were a total of `r length(unique(weight_loss$record_number))` participants with a visit excluded this way, and a total of `r as.numeric(table(weight_loss$cv_medications___25)["Checked"])` visits with `cv_medications___25` checked, `r as.numeric(table(weight_loss$cv_medications___26)["Checked"])` visits with `cv_medications___26` checked, `r as.numeric(table(weight_loss$cv_medications___27)["Checked"])` visits with `cv_medications___27` checked, `r as.numeric(table(weight_loss$cv_medications___28)["Checked"])` visits with `cv_medications___28` checked, and `r as.numeric(table(weight_loss$cv_medications___29)["Checked"])` visits with `cv_medications___29` checked.

- Visits where the participant was on atypical antipsychotics were excluded (`cv_medications___17` == "Checked"). 

- We also excluded `r nrow(progesterone_meds)` visits where the participant was on progesterone-containing medications. There were `r sum(progesterone_meds$cv_medications___9=="Checked")` with `cv_medication_9` checked, `r sum(progesterone_meds$cv_medications___10=="Checked")` with `cv_medication_10` checked, `r sum(progesterone_meds$cv_medications___11=="Checked")` with `cv_medication_11` checked, and `r sum(progesterone_meds$cv_medications___12=="Checked")` with `cv_medication_12` checked.

- About 25% of clinic visits were missing `cv_age` so I recalculated this variable using `cv_monthssincepcosdx` and `pcosdx_age`.

- For participants who were not consistently on a given medication, we excluded all visits after they first went off a medication. For example, BCH12 had one visit 2.5 months prior to starting EC (`cv_monthssincepcosdx` = 0), a visit where they started EC (`cv_monthssincepcosdx` = 2.5), a third visit where they were not on EC (`cv_monthssincepcosdx` = 33.2), and then four additional visits where they were on EC. The first visit where they were not on EC and all following visits were excluded from all EC analyses.

# Methods

For each continuous outcome, we fit a linear mixed effects model with random intercept for participant and random slope for time if possible (if the random slope model did not converge we used just the random intercept), and an interaction effect between time and medication status. 

To evaluate the effect of starting a new medication on each outcome, we also fit a linear spline model with months from medication start as the time variable and a single knot at 0 (medication start). For the spline analysis, we limited the dataset to people who were on a given medication at some point. We also limited the "before" medication data to observations within 12 months prior to medication start.

All models were adjusted for race, insurance status at diagnosis, age at clinic visit, and spironolactone use. EC models were adjusted for Metformin use, and vice versa.

Analyses were stratified by weight category at first visit. If BMI percentile was available, < 85 was considered normal weight, >= 85 and < 95 was considered overweight, and >= 95 was considered obese. If percentile was not available, a raw BMI of < 25 was considered normal weight, >= 25 and < 30 was considered overweight, and >= 30 was considered obese.

All mixed models were fit using the `lme4` R package in version `r paste0(R.version$major,".",R.version$minor)`. @rcoreteamLanguageEnvironmentStatistical2024

# Estrogen-containing medication

Participants were considered to be on estrogen-containing (EC) medications when `cv_medications___5` (estrogen-containing pill), `cv_medications___6` (estrogen-containing patch), or `cv_medications___7` (estrogen-containing ring) boxes were checked in REDCap.

```{r}
ec_df <- df %>% filter(is.na(ec_remove))
# Create a spline model dataset
ec_12_month_spline <- ec_df %>%
  filter(time_from_first_ec >= -12) %>%
  mutate(x = (time_from_first_ec > 0) * time_from_first_ec) %>%
  arrange(record_number, time_from_first_ec)
label(ec_12_month_spline$x) <- "Change in Slope After EC Start"
# Write for Melanie and Grayson to check
write.csv(ec_df,
  file = "./Data_Clean/ec_data.csv", row.names = F, na = ""
)
write.csv(ec_12_month_spline,
  file = "./Data_Clean/ec_12_month_spline.csv", row.names = F, na = ""
)
```

## Weight (kg)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * ec + cv_age + baseline_weight +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_ec + x + baseline_weight +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * ec + cv_age + baseline_bmi +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_ec + x + baseline_bmi +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HbA1c (%)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### EC users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * ec + cv_age +
    combined_race + insur_type + metformin + cv_medications___16 +
    (1 | record_number),
  data = ec_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "ec")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "ec", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on EC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on EC compared to not on EC. The second table shows the slopes for those not on EC and on EC, again holding all variables in the model constant.

### Change pre- vs. post-EC (EC users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_ec + x +
  cv_age + combined_race + insur_type + metformin + cv_medications___16 +
  (1 | record_number), data = ec_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$metformin <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_ec)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From EC Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First EC" is the slope prior to starting medication, and the "Slope Change After EC" row shows the average change in slope after starting the medication.

# Metformin

```{r}
# Don't allow people to go on and off medication, so for example once they've
# started EC for the first time, exclude any visits where they go back to
# not on EC after that
metformin_remove <- which(df$time_from_first_metformin > 0 & df$metformin == "No")
metformin_df <- df[-metformin_remove, ]
# Create a spline model dataset
metformin_12_month_spline <- metformin_df %>%
  filter(time_from_first_metformin > -12) %>%
  mutate(x = (time_from_first_metformin > 0) * time_from_first_metformin) %>%
  arrange(record_number, time_from_first_metformin)
label(metformin_12_month_spline$x) <- "Change in Slope After Metformin Start"
# Write for Melanie and Grayson to check
write.csv(metformin_df,
  file = "./Data_Clean/metformin_data.csv", row.names = F, na = ""
)
write.csv(metformin_12_month_spline,
  file = "./Data_Clean/metformin_12_month_spline.csv", row.names = F, na = ""
)
```

## Weight (kg)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * metformin + cv_age + baseline_weight +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_metformin + x + baseline_weight +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * metformin + cv_age + baseline_bmi +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_metformin + x + baseline_bmi +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Metformin users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * metformin + cv_age +
    combined_race + insur_type + ec + cv_medications___16 +
    (1 | record_number),
  data = metformin_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "metformin")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "metformin", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Metformin, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Metformin compared to not on Metformin. The second table shows the slopes for those not on Metformin and on Metformin, again holding all variables in the model constant.

### Change pre- vs. post-Metformin (Metformin users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_metformin + x +
  cv_age + combined_race + insur_type + ec + cv_medications___16 +
  (1 | record_number), data = metformin_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$ec <- "No"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_metformin)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Metformin Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Metformin" is the slope prior to starting medication, and the "Slope Change After Metformin" row shows the average change in slope after starting the medication.

# Lifestyle

```{r}
# Don't allow people to go on and off medication, so for example once they've
# started EC for the first time, exclude any visits where they go back to
# not on EC after that
lifestyle_remove <- which(df$time_from_first_lifestyle > 0 & df$lifestyle == "No")
lifestyle_df <- df[-lifestyle_remove, ]
# Create a spline model dataset
lifestyle_12_month_spline <- lifestyle_df %>%
  filter(time_from_first_lifestyle > -12) %>%
  mutate(x = (time_from_first_lifestyle > 0) * time_from_first_lifestyle) %>%
  arrange(record_number, time_from_first_lifestyle)
label(lifestyle_12_month_spline$x) <- "Change in Slope After Lifestyle Start"
# Write for Melanie and Grayson to check
write.csv(lifestyle_df,
  file = "./Data_Clean/lifestyle_data.csv", row.names = F, na = ""
)
write.csv(lifestyle_12_month_spline,
  file = "./Data_Clean/lifestyle_12_month_spline.csv", row.names = F, na = ""
)
```

## Weight (kg)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_weight ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_weight +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_weight ~ time_from_first_lifestyle + x + baseline_weight +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_weight <- mean(mod_df$baseline_weight)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("Weight (kg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## BMI (kg/m2)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_bmi ~ cv_monthssincepcosdx * lifestyle + cv_age + baseline_bmi +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_bmi ~ time_from_first_lifestyle + x + baseline_bmi +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$baseline_bmi <- mean(mod_df$baseline_bmi)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("BMI (kg/m2)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HbA1c (%)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_a1c ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_a1c ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HbA1c (%)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## TG (mg/dL)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_tg ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_tg ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("TG (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## HDL (mg/dL)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_hdl ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_hdl ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("HDL (mg/dL)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## ALT (IU/L)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_alt ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_alt ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("ALT (IU/L)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

## SBP (mmHg)

### Lifestyle users vs. non-users

```{r}
# Fit mixed model
mod <- lmer(
  cv_sbp ~ cv_monthssincepcosdx * lifestyle + cv_age +
    combined_race + insur_type + cv_medications___16 +
    (1 | record_number),
  data = lifestyle_df
)
# Model plot
plot(predict_response(mod, c("cv_monthssincepcosdx", "lifestyle")))
# Model summary
mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
# EMMs
emt <- emtrends(mod, "lifestyle", var = "cv_monthssincepcosdx")
gt(as.data.frame(emt)) %>% fmt_number(decimals = 4)
```

In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on Lifestyle, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on Lifestyle compared to not on Lifestyle. The second table shows the slopes for those not on Lifestyle and on Lifestyle, again holding all variables in the model constant.

### Change pre- vs. post-Lifestyle (Lifestyle users only)

```{r}
# Fit mixed model with change point
change_mod <- lmer(cv_sbp ~ time_from_first_lifestyle + x +
  cv_age + combined_race + insur_type + cv_medications___16 +
  (1 | record_number), data = lifestyle_12_month_spline)
# Model plot
mod_df <- change_mod@frame
mod_df$cv_age <- mean(mod_df$cv_age)
mod_df$combined_race <- "Caucasian"
mod_df$insur_type <- "Private"
mod_df$cv_medications___16 <- "Unchecked"
mod_df$ind_pred <- predict(change_mod)
pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T)
mod_df$pop_pred <- pred$fit
mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit
mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit
p <- ggplot(mod_df, aes(x = time_from_first_lifestyle)) +
  geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul),
    colour = "lightgrey", fill = "lightgrey", alpha = 0.5
  ) +
  geom_line(aes(y = pop_pred)) +
  ylab("SBP (mmHg)") +
  xlab("Months From Lifestyle Start") +
  theme_bw()
p
# Model summary
change_mod %>% tbl_regression(
  pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001),
  estimate_fun = ~ style_number(.x, digits = 4)
)
```

In the above table, the row labeled "Months From First Lifestyle" is the slope prior to starting medication, and the "Slope Change After Lifestyle" row shows the average change in slope after starting the medication.

<!-- # LARC -->

<!-- ```{r} -->
<!-- # Don't allow people to go on and off medication, so for example once they've -->
<!-- # started EC for the first time, exclude any visits where they go back to -->
<!-- # not on EC after that -->
<!-- larc_remove <- which(df$time_from_first_larc > 0 & df$larc == "No") -->
<!-- larc_df <- df[-larc_remove, ] -->
<!-- # Create a spline model dataset -->
<!-- larc_12_month_spline <- larc_df %>% -->
<!--   filter(time_from_first_larc > -12) %>% -->
<!--   mutate(x = (time_from_first_larc > 0) * time_from_first_larc) %>% -->
<!--   arrange(record_number, time_from_first_larc) -->
<!-- label(larc_12_month_spline$x) <- "Change in Slope After LARC Start" -->
<!-- # Write for Melanie and Grayson to check -->
<!-- write.csv(larc_df, -->
<!--   file = "./Data_Clean/larc_data.csv", row.names = F, na = "" -->
<!-- ) -->
<!-- write.csv(larc_12_month_spline, -->
<!--   file = "./Data_Clean/larc_12_month_spline.csv", row.names = F, na = "" -->
<!-- ) -->
<!-- ``` -->

<!-- ## Weight (kg) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_weight ~ cv_monthssincepcosdx * larc + cv_age + baseline_weight + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_weight ~ time_from_first_larc + x + baseline_weight + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$baseline_weight <- mean(mod_df$baseline_weight) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("Weight (kg)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## BMI (kg/m2) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_bmi ~ cv_monthssincepcosdx * larc + cv_age + baseline_bmi + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_bmi ~ time_from_first_larc + x + baseline_bmi + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$baseline_bmi <- mean(mod_df$baseline_bmi) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("BMI (kg/m2)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## HbA1c (%) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_a1c ~ cv_monthssincepcosdx * larc + cv_age + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_a1c ~ time_from_first_larc + x + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("HbA1c (%)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## TG (mg/dL) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_tg ~ cv_monthssincepcosdx * larc + cv_age + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_tg ~ time_from_first_larc + x + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("TG (mg/dL)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## HDL (mg/dL) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_hdl ~ cv_monthssincepcosdx * larc + cv_age + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_hdl ~ time_from_first_larc + x + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("HDL (mg/dL)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## ALT (IU/L) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_alt ~ cv_monthssincepcosdx * larc + cv_age + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_alt ~ time_from_first_larc + x + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("ALT (IU/L)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->

<!-- ## SBP (mmHg) -->

<!-- ### LARC users vs. non-users -->

<!-- ```{r} -->
<!-- # Fit mixed model -->
<!-- mod <- lmer( -->
<!--   cv_sbp ~ cv_monthssincepcosdx * larc + cv_age + -->
<!--     combined_race + insur_type + cv_medications___16 + -->
<!--     (1 | record_number), -->
<!--   data = larc_df -->
<!-- ) -->
<!-- # Model plot -->
<!-- plot(predict_response(mod, c("cv_monthssincepcosdx", "larc"))) -->
<!-- # Model summary -->
<!-- mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- # EMMs -->
<!-- emt <- emtrends(mod, "larc", var = "cv_monthssincepcosdx") -->
<!-- gt(as.data.frame(emt)) %>% fmt_number(decimals = 4) -->
<!-- ``` -->

<!-- In the first table, the row labelled "Months since PCOS diagnosis" indicates the slope for a participant not on LARC, holding all other variables in the model constant. The interaction term labelled "Months since PCOS diagnosis * Yes" indicates the difference in slope between someone on LARC compared to not on LARC. The second table shows the slopes for those not on LARC and on LARC, again holding all variables in the model constant. -->

<!-- ### Change pre- vs. post-LARC (LARC users only) -->

<!-- ```{r} -->
<!-- # Fit mixed model with change point -->
<!-- change_mod <- lmer(cv_sbp ~ time_from_first_larc + x + -->
<!--   cv_age + combined_race + insur_type + cv_medications___16 + -->
<!--   (1 | record_number), data = larc_12_month_spline) -->
<!-- # Model plot -->
<!-- mod_df <- change_mod@frame -->
<!-- mod_df$cv_age <- mean(mod_df$cv_age) -->
<!-- mod_df$combined_race <- "Caucasian" -->
<!-- mod_df$insur_type <- "Private" -->
<!-- mod_df$cv_medications___16 <- "Unchecked" -->
<!-- mod_df$ind_pred <- predict(change_mod) -->
<!-- pred <- predict(change_mod, re.form = NA, newdata = mod_df, se.fit = T) -->
<!-- mod_df$pop_pred <- pred$fit -->
<!-- mod_df$pop_pred_ll <- pred$fit - 1.96 * pred$se.fit -->
<!-- mod_df$pop_pred_ul <- pred$fit + 1.96 * pred$se.fit -->
<!-- p <- ggplot(mod_df, aes(x = time_from_first_larc)) + -->
<!--   geom_ribbon(aes(ymin = pop_pred_ll, ymax = pop_pred_ul), -->
<!--     colour = "lightgrey", fill = "lightgrey", alpha = 0.5 -->
<!--   ) + -->
<!--   geom_line(aes(y = pop_pred)) + -->
<!--   ylab("SBP (mmHg)") + -->
<!--   xlab("Months From LARC Start") + -->
<!--   theme_bw() -->
<!-- p -->
<!-- # Model summary -->
<!-- change_mod %>% tbl_regression( -->
<!--   pvalue_fun = ~ format.pval(.x, digits = 4, eps = 0.0001), -->
<!--   estimate_fun = ~ style_number(.x, digits = 4) -->
<!-- ) -->
<!-- ``` -->

<!-- In the above table, the row labeled "Months From First LARC" is the slope prior to starting medication, and the "Slope Change After LARC" row shows the average change in slope after starting the medication. -->
