---
title: "EarlyGlargine_analysis"
author: "Casey Sakamoto"
date: "2/16/2022"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(arsenal)
library(readxl)
library(readr)
library(Hmisc)
library(tidyverse)
library(performance)
library(knitr)
library(lubridate)
library(stringr)
library(table1)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Laura/Peds Endo/Ohman/Early glargine prospective"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Ohman/Early glargine prospective"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Ohman/Early glargine prospective"
}
knitr::opts_knit$set(root.dir = home_dir)

# data
EG_primary_outcome = readRDS(file = "S:/Laura/Peds Endo/Ohman/Early glargine prospective/EG_primary_outcome.rds")
EG_patient_char = readRDS(file = "S:/Laura/Peds Endo/Ohman/Early glargine prospective/EG_patient_char.rds")
```

# 1 Background

The purpose of this analysis is to summarize patient characteristics by treatment groups and T1D onset, and to examine the difference in rebound hyperglycemia between the two study groups.

# 2 Outstanding Data Questions/ Remarks

There are only a few things of note that stuck out to me with regards to the data itself:

* 1 subj missing age and 2 missing t1d variables

+ other variables have minimal missing data besides hba1c, which has 12 subjects missing values

* for the duration of t1d, subjects with new onset t1d has split data between 0 years, and missing. Is it ok to treat these missing values as missing, or is something else going on here?

# 3 Methods

Subjects who withdrew or screen failures were not included in analysis.

Tables generated using the *table1* package in R, with t-tests and chi-squared tests used to compare variables across either treatment group or diabetes diagnosis.

The primary outcome is the rate of rebound IV within 12 hours of IV insulin discontinuation. A Chi-squared test was used to evaluate the difference in rebound hyperglycemia between the two study groups.

# 4 Results

Using a cutoff of >180mg/dL, 76.0% of subjects experienced hyperglycemia. When stratified by treatment group, 76.9% of subjects in the early group and 75.0% of subjects in the late group experienced hyperglycemia. There is not enough evidence to suggest that IV rebound rate and study group are related (p = 0.8736)

Using a cutoff of >250mg/dL, 48.0% of subjects experienced hyperglycemia. When stratified by treatment group, 42.3% of subjects in the early group and 54.2% of subjects in the late group experienced hyperglycemia. There is not enough evidence to suggest that IV rebound rate and study group are related (p = 0.7856)

Using a cutoff of >300mg/dL, 26.0% of subjects experienced hyperglycemia. When stratified by treatment group, 23.1% of subjects in the early group and 29.2% of subjects in the late group experienced hyperglycemia. There is not enough evidence to suggest that IV rebound rate and study group are related (p = 0.8769)

# 4.1 Patient Characteristics Table

```{r Patient Characteristics, echo=FALSE, cache=TRUE}
# table 1
#  function for p-values
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

# tables
EG_demog_table1 =  table1( ~ nih_sex + age_at_consent + nih_race + nih_ethnicity + diabetes_diagnosis + hba1c + ph + bicarbonate + glargine_dose_per_kg
                        | study_group, data = EG_patient_char, topclass="Rtable1-zebra",
                         render.continuous=c( "Median [IQR]"="Median [Q1, Q3]"), overall=F, extra.col=list(`P-value`=pvalue))

T1D_lab_table1 =  table1( ~ `duration_of_t1d (years)` + home_regimen + hba1c + ph + bicarbonate + glargine_dose_per_kg 
                       | diabetes_diagnosis, data = EG_patient_char, topclass="Rtable1-zebra",
                        render.continuous=c( "Median [IQR]"="Median [Q1, Q3]"), overall=F, extra.col=list(`P-value`=pvalue))


EG_demog_table1 # between study groups, most variables look very similar; hba1c, bicarbonate may be a bit different
T1D_lab_table1 # between t1d status, hba1c, bicarbonate, glargine dose may be a bit different
```

# 5 Code Appendix
```{r Primary Outcome, cache=TRUE}
# need to derive the outcome variable: first filter out values that are before iv stop, or after 12 hr post stop
EG_primary_outcome = EG_primary_outcome %>% filter(timediff > 0 & timediff < 12)

# look at glucometer values within the 12hr window (note: a few 180's so i opted for 180 as the cutoff rather than 179)
EG_primary_outcome = EG_primary_outcome %>% mutate(hg_12hr = case_when(glucometer >=  180 ~ 1,
                                                                             TRUE ~ 0),
                                                   hg_12hr250 = case_when(glucometer >=  250 ~ 1,
                                                                             TRUE ~ 0),
                                                   hg_12hr300 = case_when(glucometer >=  300 ~ 1,
                                                                             TRUE ~ 0))

# hyperglycemia: did they have glucose > 180 ANY time within 12 hr of iv stop
EG_primary_outcome = EG_primary_outcome %>% group_by(`Patient ID`) %>% mutate(hyperglycemia = max(hg_12hr),
                                                                              hyperglycemia250 = max(hg_12hr250),
                                                                              hyperglycemia300 = max(hg_12hr300))


# check proportion of those who got Hyperglycemia
EG_prop = EG_primary_outcome %>% group_by(`Patient ID`, study_group) %>% summarise("hyperglycemia" = max(hyperglycemia))
mean(EG_prop$hyperglycemia) #.76 got hg

# by study group
EG_prop %>% group_by(study_group) %>% summarise("hyperglycemia" = mean(hyperglycemia))

# add this into the patient characteristics data frame
EG_prop2 = EG_prop %>% select(`Patient ID`, hyperglycemia)
EG_patient_char = full_join(EG_patient_char, EG_prop2)

# chi sq test for difference in treatment groups
chisq.test(EG_prop$hyperglycemia, EG_prop$study_group, correct = FALSE)

# could also adjust for covariates using logistic regression
eg_logreg = glm(as.factor(hyperglycemia) ~ study_group + age_at_consent + nih_sex + diabetes_diagnosis, family = "binomial", data = EG_patient_char)
summary(eg_logreg)

##################### using 250 threshold #############################
EG_prop250 = EG_primary_outcome %>% group_by(`Patient ID`) %>% summarise("hyperglycemia250" = max(hyperglycemia250))
mean(EG_prop250$hyperglycemia250) #.48 got hg at 250 criteria


# add this into the patient characteristics data frame
EG_patient_char = full_join(EG_patient_char, EG_prop250)
EG_patient_char %>% group_by(study_group) %>% summarise("hyperglycemia250" = mean(hyperglycemia250)) # .42 early vs .54 late

# chi sq test
chisq.test(EG_patient_char$hyperglycemia250, EG_prop$study_group, correct = FALSE)

#######################################################################

######################## 300 threshold ##################################
EG_prop300 = EG_primary_outcome %>% group_by(`Patient ID`) %>% summarise("hyperglycemia300" = max(hyperglycemia300))
mean(EG_prop300$hyperglycemia300) #.26 got hg at 300 criteria

# add this into the patient characteristics data frame
EG_patient_char = full_join(EG_patient_char, EG_prop300)
EG_patient_char %>% group_by(study_group) %>% summarise("hyperglycemia300" = mean(hyperglycemia300)) # .23 early vs .29 late

# chi sq test 
chisq.test(EG_patient_char$hyperglycemia300, EG_prop$study_group, correct = FALSE)
##################################################################
```

