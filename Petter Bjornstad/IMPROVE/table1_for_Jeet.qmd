---
title: "IMPROVE"
author: "Tim Vigers"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    page-layout: full
editor: source
---

```{r}
#| include: false
library(tidyverse)
library(arsenal)
library(knitr)
# Import and filter
df <- read.csv("/Volumes/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Data Harmonization/Data Clean/harmonized_dataset.csv", na.strings = "")
df <- df %>% filter(study == "IMPROVE", visit %in% c("baseline", "12_months_post_surgery"))
# Select variables for T1
df <- df %>%
  select(
    record_id, visit, weight, bmi,
    bod_pod_body_fat, gfr_raw_plasma, gfr_bsa_plasma,
    ff, acr_u,albuminuria_cat, elevated_albuminuria,
    contains("fsoc_"), map, sbp, dbp, fbg, hba1c, airg, acprg,
    contains("glom_volume"), mes_matrix_area, mes_index,
    contains("mes_volume"), glom_nuc_count,
    metformin_timepoint, insulin_med_timepoint,
    sglti_timepoint, raasi_timepoint,kit_id
  ) %>%
  group_by(record_id, visit) %>%
  summarise_all(~ last(na.omit(.x)))
# Additional formatting
df$visit <- factor(df$visit,
                   levels = c("baseline", "12_months_post_surgery"),
                   labels = c("Baseline", "12 Months Post Surgery")
)
ids <- df$record_id[which(duplicated(df$record_id))]
df <- df %>% filter(record_id %in% ids)
# Get names
var_names <- read.csv("/Volumes/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Data Harmonization/data_dictionary_master.csv", na.strings = "")
vars <- colnames(df)[3:(ncol(df)-1)]
var_names <- var_names[var_names$variable_name %in% vars, ]
labels <- as.list(var_names$label)
names(labels) <- var_names$variable_name
```

```{r results='asis'}
#| label: tbl-t1
#| tbl-cap: Comparisons by Group (Full Cohort)
t1 <- paired(visit ~ 
               weight + bmi + bod_pod_body_fat + gfr_raw_plasma + gfr_bsa_plasma + 
               ff + kwt(acr_u,"Nmiss", "median", "q1q3", "range") + 
               albuminuria_cat + elevated_albuminuria +
               fsoc_l_cortex + fsoc_l_kidney + fsoc_l_medulla + 
               fsoc_r_cortex + fsoc_r_kidney + fsoc_r_medulla + map + sbp + 
               dbp + fbg + hba1c + airg + acprg + raw_m + glom_volume_con + glom_volume_weibel + 
               glom_volume_wiggins + mes_matrix_area + mes_index + mes_volume_con + 
               mes_volume_weibel + mes_volume_wiggins + glom_nuc_count + 
               metformin_timepoint + insulin_med_timepoint + sglti_timepoint + 
               raasi_timepoint, 
             data = df, id = record_id)
summary(t1, labelTranslations = labels,pfootnote = T)
```

```{r}
# Calculate albuminuria category change
df %>% arrange(record_id,visit) %>%
  group_by(record_id) %>% 
  summarise(alb_change = paste0(albuminuria_cat[1],"->",albuminuria_cat[2])) %>%
  kable(.,col.names = c("ID","Albuminuria Change"))
df %>% arrange(record_id,visit) %>%
  group_by(record_id) %>% 
  summarise(alb_change = paste0(albuminuria_cat[1],"->",albuminuria_cat[2])) %>%
  count(alb_change) %>%
  kable(.,col.names = c("Albuminuria Change","n"))
```

```{r results='asis'}
#| label: tbl-t2
#| tbl-cap: Comparisons by Group (VSG Only)
ids = c("IT_07","IT_08","IT_10","IT_11","IT_12")
t2 <- paired(visit ~ 
               weight +bmi + gfr_raw_plasma + gfr_bsa_plasma + 
               ff + signed.rank(acr_u,"Nmiss", "median", "q1q3", "range") + 
               albuminuria_cat + notest(elevated_albuminuria) +
               fsoc_r_cortex + fsoc_r_kidney + fsoc_r_medulla + map + sbp + 
               dbp + fbg + hba1c + airg + acprg + raw_m + glom_volume_con + glom_volume_weibel + 
               glom_volume_wiggins + mes_matrix_area + mes_index + mes_volume_con + 
               mes_volume_weibel + mes_volume_wiggins + glom_nuc_count + 
               metformin_timepoint + insulin_med_timepoint + notest(sglti_timepoint) + 
               raasi_timepoint, 
             data = df[df$record_id %in% ids,], id = record_id)
summary(t2, labelTranslations = labels,pfootnote = T)
```

```{r}
# Calculate albuminuria category change
df %>% arrange(record_id,visit) %>% filter(record_id %in% ids) %>%
  group_by(record_id) %>% 
  summarise(alb_change = paste0(albuminuria_cat[1],"->",albuminuria_cat[2])) %>%
  kable(.,col.names = c("ID","Albuminuria Change"))
df %>% arrange(record_id,visit) %>%
  group_by(record_id) %>%  filter(record_id %in% ids) %>%
  summarise(alb_change = paste0(albuminuria_cat[1],"->",albuminuria_cat[2])) %>%
  count(alb_change) %>%
  kable(.,col.names = c("Albuminuria Change","n"))
```
