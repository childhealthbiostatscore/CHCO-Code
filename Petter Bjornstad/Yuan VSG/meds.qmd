---
title: "VSG analysis - meds in SMT group"
author: "Laura Pyle"
format:
  html:
    toc: true
    toc-depth: 5
    toc-float: true
    code-fold: true
    self-contained: true
    page-layout: full
editor: source
---


```{r}
#| include: false
library(tidyverse)
library(arsenal)
library(knitr)

# specify user for paths
user <- Sys.info()[["user"]]
if (user == "laurapyle") {
  data_path <- "/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Clean"
} else if (user == "lpyle") {
  data_path <- "/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Clean"
} else if (user == "pylell") {
  data_path <- "/Users/pylell/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Clean"
} else {
  stop("Unknown user: please specify root path for this user.")
}
setwd(data_path)

# Import and filter
df <- read.csv("./harmonized_dataset.csv", na.strings = "")
collapsed_data <- df	%>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, first(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, first(na.omit(.x)))),
                   .by = c(record_id, visit))

meds <- collapsed_data %>% select(record_id, mrn, visit, rh_id, rh2_id, study,
    ends_with("_timepoint"),
    ends_with("_ever"),
    starts_with("epic_")
)

ids_keep <- c("RH-68-T",  "RH-49-T",  "RH-63-T",  "RH-23-T",  "RH-71-T",  "RH-62-T",  "RH-50-T",  "RH-74-T",
              "RH-72-T",  "RH-76-T",  "RH-77-T",  "RH-75-T",  "RH-67-T",  "RH2-51-T", "RH2-53-T", "RH2-07-O",
              "RH-93-T",  "RH-91-T",  "RH-23-T",  "RH2-11-O", "RH2-23-T", "RH2-22-T", "RH2-38-T", "RH2-21-T",
              "RH-67-T",  "RH2-55-T", "RH2-36-O", "RH2-43-T", "RH2-42-T")

meds <- meds %>% filter(rh_id %in% ids_keep | rh2_id %in% ids_keep)
meds <- meds %>% filter(study %in% c("RENAL-HEIR", "RENAL-HEIRitage"))

# count who has 2 visits
count <- as.data.frame(table(meds$mrn))
colnames(count) <- c("mrn", "visits")
count$mrn <- as.numeric(as.character(count$mrn))
meds <- full_join(meds, count, by = "mrn")

# assign baseline and follow-up
meds_new <- meds %>% mutate(visit_new = case_when(
  visits == 1 & study == "RENAL-HEIR" ~ "baseline",
  visits == 1 & study == "RENAL-HEIRitage" ~ "baseline",
  visits == 2 & study == "RENAL-HEIR" ~ "baseline",
  visits == 2 & study == "RENAL-HEIRitage" ~ "follow-up"
))
```

```{r include=F}
# t <- tableby(visit_new ~ sglt2i_ever + epic_ever_bb_1 + epic_ever_bb_2 + epic_ever_ccb_1 + epic_ever_ccb_2 + epic_ever_diuretic_1 + epic_ever_diuretics_2 + 
#                epic_ever_fibrate_1 + epic_ever_fibrate_2 + epic_ever_glp1ra_1 + epic_ever_glp1ra_2 + epic_ever_insulin_1 + epic_ever_insulin_2 +
#                epic_ever_mfm_1 + epic_ever_mfm_2 + epic_ever_mra_1 + epic_ever_mra_2 + epic_ever_phentermine_1 + epic_ever_phentermine_2 +
#                epic_ever_raasi_1 + epic_ever_raasi_2 + epic_ever_sglt2i_1 + epic_ever_sglt2i_2 + epic_ever_statin_1 + epic_ever_statin_2 + 
#                epic_ever_topiramate_1 + epic_ever_topiramate_2 + epic_ever_tzd_1 + epic_ever_tzd_2 + epic_ever_uric_1 + epic_ever_uric_2, 
#               data = meds_new, total = F)

t <- tableby(visit_new ~ fibrates_timepoint + glp1_agonist_timepoint +  insulin_med_timepoint +  
               metformin_timepoint +  raasi_timepoint + sglti_timepoint + tzd_timepoint, 
              data = meds_new, total = F)
```

```{r results='asis'}
summary(t)
```