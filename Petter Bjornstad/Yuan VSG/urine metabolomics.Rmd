---
title: "VSG vs SMT urine metabolomics"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(limma)
library(dplyr)
library(caret)
library(purrr)
library(multtest)
library(openxlsx)
library(tableone)
library(EnhancedVolcano)
library(knitr)
library(ggpubr)
library(readxl)
library(stringr)
library(tidyr)
library(dplyr)
library(parallel)
library(lmerTest)
library(stringr)

# specify user for paths
user <- Sys.info()[["user"]]
if (user == "laurapyle") {
  data_path <- '/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/AstraZeneca'
  vsg_path <- '/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG'
  results_path <- '/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG/Results'
} else if (user == "lpyle") {
  data_path <- '/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/AstraZeneca'
  vsg_path <- '/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG'
  results_path <- '/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG/Results'
} else if (user == "pylell") {
  data_path <- '/Users/pylell/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/AstraZeneca'
  vsg_path <- '/Users/pylell/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG'
  results_path <- '/Users/pylell/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/VSG/Results'
}else {
  stop("Unknown user: please specify root path for this user.")
}

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
```

```{r functions, include=FALSE}
clean_variable_names <- function(data) {
  # Get current names
  old_names <- names(data)
  
  # Create new names
  new_names <- gsub(" ", "", old_names)           # Remove spaces
  new_names <- gsub("-", "_", new_names)          # Replace hyphens with underscores
  new_names <- gsub("[()]", "", new_names)        # Remove parentheses
  new_names <- gsub("_", "", new_names)
  new_names <- str_remove_all(new_names, "_")
  
  # Apply new names
  names(data) <- new_names
  
  # Optional: Print what changed for verification
  changed <- old_names != new_names
  if (any(changed)) {
    cat("Changed variable names:\n")
    for (i in which(changed)) {
      cat(sprintf("  '%s' -> '%s'\n", old_names[i], new_names[i]))
    }
  }
  
  return(data)
}


scaleFUN <- function(x) sprintf("%.2f", x)

# Volcano plot
volcano <- function(data, lab = "metabolite", xcol = "Estimate", ycol = "Pr...t..",
                    top = 15,
                    xlimit = c(-1, 1), ylimit = c(0, -log10(10e-7)),
                    xlabel = "logFC cohort:visit", pCutoff = 0.05, overlaps = 20,
                    log_t = T) {
  data <- as.data.frame(data)
  t <- data[data[, "Pr...t.."] <= pCutoff, ]
  if (log_t) {
    t <- t[order(abs(log(t[, ycol])), decreasing = F), ]
  } else {
    t <- t[order(abs(t[, ycol]), decreasing = F), ]
  }
  data$top <- data[, "metabolite"] %in% t[1:top, "metabolite"]
  data$logp <- -log10(data[, ycol])
  data$fc <- data[, xcol]
  data$sig <- data[, ycol] <= pCutoff
  p <- ggplot(data = data, aes(x = fc, y = logp, color = sig)) +
    geom_hline(yintercept = -log10(pCutoff), linetype = "dashed") +
    geom_point(size = 2.5) +
    geom_label_repel(
      data = data[data$top, ], aes(label = metabolite), color = "black",
      max.overlaps = overlaps, nudge_x = 0.6, nudge_y = 0.5
    ) +
    scale_color_manual(values = c("grey", "#3e6dbf")) +
    xlab(xlabel) + scale_x_continuous(labels = scaleFUN) +
    ylab(bquote(~ -Log[10] ~ italic(P))) +
    theme_bw() +
    theme(legend.position = "none")
  return(p)
}

capitalize_first_letter <- function(metabolite) {
  sub("([a-zA-Z])", "\\U\\1", metabolite, perl = TRUE)
}

```

```{r, include=FALSE}
# QUESTIONS
# In the RPC2 analysis, we did not normalize by creatinine - I think this is because the metabolites are semi-quantitative

# based on emails with Filippos Michopoulos, I believe this is the correct version of the data to use
# metabolites are log-2 transformed
# time has been merged with ID
filename <- "RPC2 targeted normalised data combined PN with dose.xlsx"
full_path <- file.path(data_path, filename)
data <- read_xlsx(full_path, sheet = "Targeted data")
#creat <- read_xlsx(full_path, sheet = "Creatinine quant")
#data <- left_join(data, creat, by = "ID")
data <- data %>% filter(!Dose == "QC")
data$Peak.Area <- data$`Peak Area`
data$`Peak Area` <- NULL
# NAs introduced by coercion but this is OK because those peak areas were missing
data$temp <- as.numeric(data$Peak.Area)
data_keep <- data %>% select(ID, Dose, Metabolite, Peak.Area)

data_wide <- data_keep %>%
  pivot_wider(
    id_cols = c(ID, Dose),
    names_from = Metabolite,
    values_from = Peak.Area
  )
data_wide <- data_wide %>% mutate(visit = case_when(
  str_detect(ID, "12M") ~ "12 months",
  str_detect(ID, "BL") ~ "Baseline",
  .default = "Baseline"
))
data_wide <- data_wide %>% mutate(ID = str_remove(ID, "_BL"))
data_wide <- data_wide %>% mutate(ID = str_remove(ID, "_12M"))
data_wide$ID <- str_replace(data_wide$ID, "IT2D", "IT")
data_wide$ID <- str_replace_all(data_wide$ID, "_", "-")
data_wide$record_id <- data_wide$ID
data_wide$ID <- NULL

# create separate dfs for IMPROVE and RH/RH2 since they will be merged slightly differently
data_wide_improve <- data_wide %>% filter(grepl("IT", record_id))
data_wide_improve$updated_pre_post <- ifelse(data_wide_improve$visit == "Baseline", "pre", "post")
data_wide_improve$updated_record_id <- data_wide_improve$record_id
data_wide_rh <- data_wide %>% filter(grepl("RH", record_id))

# read in Long's data
filename <- "patient_cohort_prepost_table.xlsx"
full_path <- file.path(vsg_path, filename)
vsg_smt_patients <- read_xlsx(full_path, sheet = "patient_cohort_prepost_table")
vsg_smt_patients$record_id <- ifelse(vsg_smt_patients$cohort == "IMPROVE", str_replace(vsg_smt_patients$record_id, "_", "-"), vsg_smt_patients$record_id)
vsg_smt_patients <- vsg_smt_patients %>% mutate(time = case_when(
  cohort == "IMPROVE" & updated_pre_post == "pre" ~ "baseline",
  cohort == "IMPROVE" & updated_pre_post == "post" ~ "12_months_post_surgery",
  cohort != "IMPROVE" ~ "baseline"
  )
)
vsg_smt_patients$updated_record_id <- str_replace(vsg_smt_patients$updated_record_id, "_", "-")
vsg_smt_patients_improve <- vsg_smt_patients %>% filter(updated_cohort == "IMPROVE")
vsg_smt_patients_improve_keep <- vsg_smt_patients_improve %>% select(updated_record_id, updated_pre_post)
vsg_smt_patients_rh <- vsg_smt_patients %>% filter(updated_cohort %in% c("RENAL HEIR", "RENAL HEIRITAGE"))

final_improve <- left_join(vsg_smt_patients_improve_keep, data_wide_improve, by = c("updated_record_id", "updated_pre_post"))
final_improve$record_id <- final_improve$updated_record_id
final_improve$cohort <- "VSG"
final_rh <- left_join(vsg_smt_patients_rh, data_wide_rh, by = "record_id")
final_rh <- final_rh %>% select(-c(cohort, pre_post, updated_cohort, comment, time))
final_rh$cohort <- "SMT"

final <- rbind(final_improve, final_rh)
final$vis_num <- ifelse(final$updated_pre_post == "pre", 1, 2)
final$visit <- NULL

# rename columns
#final <- clean_variable_names(final)

forseqs <- final %>% select(-c(updated_record_id, updated_pre_post, Dose, record_id, cohort, vis_num,
                               `_Flavin_adenine_dinucleotide_N`))
seqs <- colnames(forseqs)
final[seqs] <- apply(final[seqs], 2, as.numeric) 
```

```{r, include=FALSE}
# Parallel processing
cl <- makeForkCluster(8)
rows <- parLapply(cl, seqs, function(y) {
  f <- as.formula(paste0("`", y, "` ~ cohort*vis_num + (1|updated_record_id)"))
  m <- lmer(f, data = final)
  row <- c(summary(m)$coef[4,], y)
  row <- t(row)
  row <- as.data.frame(row)
  row[1:5] <- apply(row[1:5], 2, as.numeric)
  return(row)
})
stopCluster(cl)

# Save results
lmm_res <- data.frame(do.call(rbind, rows))
colnames(lmm_res) <- c(colnames(lmm_res)[1:5], "metabolite")
lmm_res$metabolite <- str_remove_all(lmm_res$metabolite, "_")
lmm_res$metabolite <- capitalize_first_letter(lmm_res$metabolite)

# write all results to file
filename <- "VSG vs SMT urine metabolomics.csv"
full_path <- file.path(vsg_path, filename)
write.csv(lmm_res, full_path, row.names = FALSE)
```

```{r, include=FALSE}
# volcano plot
v <- volcano(lmm_res, log_t = FALSE)
v <- v  +
  theme(plot.title = element_text(hjust = 0.5))
```

Volcano plot of the differences in differences for 

cohort: effect of VSG compared to SMT
visit: visit 2 vs. visit 1
cohort*visit: positive if the change in VSG is greater than change in SMT


```{r}
v
```
