---
title: "SWEETHEART & ULTRA Imaging"
author: "Ye Ji Choi"
format:
  revealjs:
    embed-resources: true
    scrollable: true
    transition: slide
    controls-layout: bottom-right
    menu: true
    toc: true
    toc-depth: 3
    fontsize: 15
    number-sections: true
---

Left ventricular (LV), right ventricular (RV) global functions
ESV: End-systolic volume	(mL)
EDV: End-diastolic volume (mL)	
SV: Stroke volume	(mL)
CO: Cardiac output	 (L/min)
EF: Ejection fraction (%)	
HR: Heart rate (1/min)	
thickness_diast: Global myocardial thickness at diastole (mm)	
thickness_total: Global myocardial thickness assessed across the entire cardiac cycle, with values comparable to those measured at systole (mm)
MyoMass_diast: Global myocardial mass at diastole
MyoMass_syst: Global myocardial mass at systole

Left ventricular global peak strain (systolic function)
GRS: Global radial strain (%)
GCS: Global circumferential strain (%)
GLS: Global longitudinal strain (%)	

Tissue characteristics
T1 (ms)	
T2* (ms)

Intracardiac 4D flow
Mitral valve inflow (diastolic function)
E wave: Early diastolic peak inflow velocity (cm/s)
A wave: Peak inflow velocity during atrial contraction (cm/s)
E/A ratio: Ratio of E wave to A wave peak inflow velocity (–)

Aortic 4D flow (Region of interest: thoracic aorta)
PWV: Pulse wave velocity (central arterial stiffness) (m/s) 	
MeanWSS: Mean wall shear stress (Pa)	
MedianWSS: Median wall shear stress (Pa)
High5pctWSS: Median of 5% highest wall shear stress (Pa)

```{r include = F}
library(jsonlite)
library(aws.s3)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(lmerTest)
library(emmeans)
library(broom)
library(ggbeeswarm)
library(lemon)
library(quantreg)
library(readxl)
library(lubridate)
library(dplyr)
library(ggplot2)
library(purrr)
library(cowplot)
library(ggpubr)
```

```{r include = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```

```{r}
harm_dat <- read.csv(file.path(root_path, "Data Harmonization/Data Clean/harmonized_dataset.csv"), na = "")

ultra_swht_coenrolled <- harm_dat %>%
  filter(study == "ULTRA" & !is.na(swht_id)) %>%
  pull(swht_id) %>%
  unique()

ultra_swht_coenrolled_ultra <- harm_dat %>%
  filter(study == "ULTRA" & !is.na(swht_id)) %>%
  pull(ultra_id) %>%
  unique()

harm_dat_subset <- harm_dat %>%
  filter(study == "ULTRA" | !is.na(swht_id)) %>%
  mutate(imaging_visit_id = case_when(record_id %in% ultra_swht_coenrolled_ultra & study == "ULTRA" & imaging_visit == 1 ~ "ultra_swht_baseline",
                                      imaging_visit == 1 ~ "ultra_baseline", 
                                      imaging_visit == 2 ~ "ultra_follow_up",
                                      record_id %in% ultra_swht_coenrolled & study == "SWEETHEART" ~ "ultra_swht_follow_up",
                                      study == "SWEETHEART" ~ "swht_cs"),
         coenrolled_id = case_when(!is.na(swht_id) ~ "swht_coenrolled",
                                   !is.na(ultra_id) ~ "ultra_coenrolled"),
         sex = case_when(study == "ULTRA" ~ "Male", T ~ sex),
         age = interval(dob, imaging_date) / years(1))%>%
  # dplyr::select(swht_id, record_id, mrn, group, sex, age, imaging_visit_id, study, all_of(im_vars)) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, imaging_visit_id)) %>%
  filter(study != "ULTRA" | study == "ULTRA" & !is.na(imaging_visit_id)) %>%
  group_by(mrn, coenrolled_id) %>%
  fill(everything(), .direction = "down") %>%
  ungroup() %>%
  filter(!is.na(imaging_date)) %>%
  mutate(uacr_100 = case_when(acr_u >= 100 ~ "UACR >=100 mg/g",
                              acr_u < 100 ~ "UACR <100 mg/g"),
         uacr_group = case_when(
           eGFR_CKD_epi < 90 | acr_u >= 100 ~ "eGFR < 90 and/or UACR >=100 mg/g",
           eGFR_CKD_epi >= 90 & acr_u < 100 ~ "eGFR >= 90 and UACR <100 mg/g",
           TRUE ~ NA_character_
         ),
         uacr_group = factor(
           uacr_group,
           levels = c("eGFR >= 90 and UACR <100 mg/g",
                      "eGFR < 90 and/or UACR >=100 mg/g")
         ),
         
         dkd_group_100 = case_when(
           eGFR_CKD_epi < 90 | acr_u >= 100 ~ "DKD",
           eGFR_CKD_epi >= 90 & acr_u < 100 ~ "non_DKD",
           TRUE ~ NA_character_
         ),

         dkd_group_30 = case_when(
           eGFR_CKD_epi < 90 | acr_u >= 30 ~ "DKD",
           eGFR_CKD_epi >= 90 & acr_u < 30 ~ "non_DKD",
           TRUE ~ NA_character_
         ),
         # eGFR categories
         egfr_cat = case_when(
           eGFR_CKD_epi < 60                      ~ "<60",
           eGFR_CKD_epi >= 60 & eGFR_CKD_epi < 90 ~ "60–<90",
           eGFR_CKD_epi >= 90                     ~ "≥90",
           TRUE ~ NA_character_
         ),
         egfr_cat = factor(egfr_cat, levels = c("<60", "60–<90", "≥90")),
         # ACR categories
         acr_u_cat3 = case_when(
           acr_u < 30                  ~ "<30",
           acr_u >= 30 & acr_u < 300   ~ "30–<300",
           acr_u >= 300                ~ "≥300",
           TRUE ~ NA_character_
         ),
         acr_u_cat3 = factor(acr_u_cat3, levels = c("<30", "30–<300", "≥300")),
         acr_u_cat300 = case_when(
           acr_u < 300                  ~ "<300",
           acr_u >= 300                ~ "≥300",
           TRUE ~ NA_character_
         ),
         long_peak   = case_when(long_peak   == 0 ~ NA_real_, TRUE ~ long_peak),
         circum_peak = case_when(circum_peak == 0 ~ NA_real_, TRUE ~ circum_peak),
         radial_peak = case_when(radial_peak == 0 ~ NA_real_, TRUE ~ radial_peak),
         log_acr_u = log(acr_u))


harm_dat_subset_baseline <- harm_dat_subset %>%
  filter(imaging_visit_id != "ultra_follow_up")

harm_dat_subset_obt2d <- harm_dat_subset %>%
  filter(group != "Lean Control" & imaging_visit_id != "ultra_follow_up")

harm_dat_subset_t2d <- harm_dat_subset %>%
  filter(group == "Type 2 Diabetes" & imaging_visit_id != "ultra_follow_up")

```

```{r}
summary(arsenal::tableby(imaging_visit_id ~ group + age + sex + bmi + kwt(acr_u, "Nmiss", "medianq1q3") + hba1c +
                           dkd_group_30 + dkd_group_100, data = harm_dat_subset))

summary(arsenal::tableby(group ~ imaging_visit_id + age + sex + bmi + kwt(acr_u, "Nmiss", "medianq1q3") + hba1c + eGFR_CKD_epi +
                           acr_u_cat3 +
                           dkd_group_30 + dkd_group_100, data = subset(harm_dat_subset, imaging_visit_id != "ultra_follow_up")))
summary(arsenal::tableby(sex ~ group + imaging_visit_id + age + sex + bmi + kwt(acr_u, "Nmiss", "medianq1q3") + hba1c + eGFR_CKD_epi +
                           dkd_group_30 + dkd_group_100, data = subset(harm_dat_subset, imaging_visit_id != "ultra_follow_up" & group != "Lean Control")))

subset(harm_dat_subset, rvef < 40 & imaging_visit_id != "ultra_follow_up" & group != "Lean Control")$record_id
subset(harm_dat_subset, rvef < 40 & imaging_visit_id != "ultra_follow_up" & group != "Lean Control")$rvef
```

```{r}
plot_boxgrid <- function(df, 
                        vars = im_vars, 
                        log_vars = NULL, 
                        group_var, 
                        id_var = "mrn",  # ID variable for pairing
                        paired = FALSE,   # Enable paired tests
                        var_labels = NULL, 
                        ncol = 3, 
                        per_page = 9, 
                        fill_colors = c("#f08080", "#98c1d9"), 
                        save = TRUE, 
                        save_dir = paste0(root_path, "/ULTRA_SWEETHEART/Results/Figures/Box plots"), 
                        file_prefix = "plot_page", 
                        file_type = "png", 
                        width = 12, 
                        height = 12, 
                        dpi = 300, 
                        show_legend = FALSE, 
                        fill_label = NULL, 
                        text_size = 18, 
                        star_size = 10) {
  
  # Convert numeric vars/log_vars to names if needed
  if (is.numeric(vars)) vars <- names(df)[vars]
  if (!is.null(log_vars) && is.numeric(log_vars)) log_vars <- names(df)[log_vars]
  
  get_legend_plot <- function(p) {
    cowplot::get_legend(
      p + theme(legend.position = "right")
    )
  }
  
  # ---------------------------------------------
  # 1. Create log10 transformed columns
  # ---------------------------------------------
  if (!is.null(log_vars)) {
    for (v in log_vars) {
      df[[paste0(v, "_log10")]] <- log10(df[[v]])
    }
  }
  
  # ---------------------------------------------
  # 2. If paired, filter to complete pairs only
  # ---------------------------------------------
  if (paired) {
    # Identify IDs that have data in all groups
    complete_ids <- df %>%
      group_by(.data[[id_var]]) %>%
      summarise(n_groups = n_distinct(.data[[group_var]]), .groups = "drop") %>%
      filter(n_groups == length(unique(df[[group_var]]))) %>%
      pull(.data[[id_var]])
    
    df <- df %>% filter(.data[[id_var]] %in% complete_ids)
    
    message(sprintf("Using %d complete pairs for paired analysis", length(complete_ids)))
  }
  
  # ---------------------------------------------
  # 3. Generate plots
  # ---------------------------------------------
  plots <- purrr::map(seq_along(vars), function(i) {
    v <- vars[i]
    
    if (!is.null(log_vars) && v %in% log_vars) {
      ycol <- paste0(v, "_log10")
      base_label <- if (!is.null(var_labels) && v %in% names(var_labels)) var_labels[[v]] else v
      ylab <- paste0("log10(", base_label, ")")
    } else {
      ycol <- v
      ylab <- if (!is.null(var_labels) && v %in% names(var_labels)) var_labels[[v]] else v
    }
    
    comps <- combn(unique(df[[group_var]]), 2, simplify = FALSE)
    
    p <- ggplot(df, aes(x = as.character(.data[[group_var]]), y = .data[[ycol]], fill = as.character(.data[[group_var]]))) +
      geom_boxplot(size = 1)
    
    # Add appropriate statistical test
    if (paired) {
      p <- p + stat_compare_means(
        comparisons = comps,
        method = "t.test",
        paired = TRUE,
        label = "p.signif",
        hide.ns = F,
        size = star_size
      )
    } else {
      p <- p + stat_compare_means(
        comparisons = comps,
        label = "p.signif",
        hide.ns = TRUE,
        size = star_size
      )
    }
    
    p <- p +
      labs(y = ylab, x = NULL, fill = fill_label) +
      scale_fill_manual(values = fill_colors) +
      scale_y_continuous(expand = expansion(mult = c(0.05, 0.35))) +
      theme(
        panel.background = element_blank(),
        text = element_text(size = text_size),
        axis.text.x = if (show_legend) element_blank() else element_text(angle = 60, hjust = 1),
        legend.position = "none"
      )
    
    p
  })
  
  legend <- get_legend_plot(plots[[1]])
  
  # ---------------------------------------------
  # 4. Save pages
  # ---------------------------------------------
  if (save) dir.create(save_dir, recursive = TRUE, showWarnings = FALSE)
  
  n_plots <- length(plots)
  pages <- ceiling(n_plots / per_page)
  
  for (page in seq_len(pages)) {
    start <- (page - 1) * per_page + 1
    end <- min(page * per_page, n_plots)
    
    page_grid <- cowplot::plot_grid(plotlist = plots[start:end], ncol = ncol)
    page_plot <- cowplot::plot_grid(
      page_grid,
      legend,
      ncol = 3,
      rel_widths = c(1, 0.1, 0.15)
    )
    
    print(page_plot)
    
    if (save) {
      outfile <- file.path(save_dir, sprintf("%s_%02d.%s", file_prefix, page, file_type))
      ggsave(outfile, page_plot, width = width, height = height, dpi = dpi)
    }
  }
  
  invisible(plots)
}
```

```{r echo = F}
im_vars_log <- c(
  "af_pwv_xcor3",
  "mv_flow_a",
  "mv_flow_e",
  "lv_myo_thickness_total",
  "lv_myo_thickness_dias")

im_vars <- c(
  "imaging_hr",
  "af_high5pctwss",
  "af_medianwss",
  "af_meanwss",
  "af_pwv_xcor3",
  "mv_flow_ea",
  "mv_flow_a",
  "mv_flow_e",
  "tt2",
  "tt1",
  "long_peak",
  "circum_peak",
  "radial_peak",
  "rvef",
  "lvef",
  "rvco",
  "lvco",
  "rvsv",
  "lvsv",
  "rvedv",
  "lvedv",
  "rvesv",
  "lvesv",
  "lv_myo_mass_syst",
  "lv_myo_mass_dias",
  "lv_myo_thickness_total",
  "lv_myo_thickness_dias")

im_vars_2 <- c(
  "imaging_hr",
  "rvedv",
  "lvedv",
  "rvesv",
  "lvesv",
  "rvsv",
  "lvsv",
  "rvco",
  "lvco",
  "lv_myo_mass_syst",
  "lv_myo_mass_dias",
  "lv_myo_thickness_total",
  "lv_myo_thickness_dias",
  "rvef",
  "lvef",
  "long_peak",
  "af_high5pctwss",
  "af_medianwss",
  "af_meanwss",
  "af_pwv_xcor3",
  "tt1",
  "tt2"
)

im_vars_2_labels <- c(
  imaging_hr                = "Heart rate",
  rvedv                     = "RV EDV",
  lvedv                     = "LV EDV",
  rvesv                     = "RV ESV",
  lvesv                     = "LV ESV",
  rvsv                      = "RV stroke\nvolume",
  lvsv                      = "LV stroke\nvolume",
  rvco                      = "RV cardiac\noutput",
  lvco                      = "LV cardiac\noutput",
  lv_myo_mass_syst          = "LV myocardial\nmass (systole)",
  lv_myo_mass_dias          = "LV myocardial\nmass (diastole)",
  lv_myo_thickness_total    = "LV\nmyocardial\nthickness (total)",
  lv_myo_thickness_dias     = "LV\nmyocardial\nthickness (diastole)",
  rvef                      = "RV\nejection fraction",
  lvef                      = "LV\nejection fraction",
  long_peak                 = "LV global\nlongitudinal strain",
  af_high5pctwss            = "Aortic wall shear\nstress (top 5%)",
  af_medianwss              = "Aortic wall shear\nstress (median)",
  af_meanwss                = "Aortic wall shear\nstress (mean)",
  af_pwv_xcor3              = "Aortic\nPWV",
  tt1                       = "T1",
  tt2                       = "T2*"
)
```

```{r echo = F}
plot_boxgrid(
  df = harm_dat_subset_baseline,
  group_var = "group",
  log_vars = im_vars_log,
  fill_colors = c("#588157", "#f08080", "#98c1d9"),
  file_prefix = "baseline_group"
)

plot_boxgrid(
  df = harm_dat_subset_obt2d,
  group_var = "sex",
  log_vars = im_vars_log,
  file_prefix = "obt2d_sex"
)

plot_boxgrid(
  df = harm_dat_subset_obt2d,
  vars = im_vars_2,
  var_labels = im_vars_2_labels,
  group_var = "sex",
  log_vars = im_vars_log,
  file_prefix = "obt2d_sex",
  ncol = 5,
  per_page = 22,
  show_legend = T,
  fill_label = "Sex",
  width = 18,
  text_size = 20,
  star_size = 12
)

table(harm_dat_subset_obt2d$group)

plot_boxgrid(
  df = subset(harm_dat_subset_obt2d, !is.na(dkd_group_30)),
  group_var = "dkd_group_30",
  log_vars = im_vars_log,
  file_prefix = "obt2d_dkd30"
)

plot_boxgrid(
  df = subset(harm_dat_subset_obt2d, !is.na(dkd_group_100)),
  group_var = "dkd_group_100",
  log_vars = im_vars_log,
  file_prefix = "obt2d_dkd100"
)

plot_boxgrid(
  df = subset(harm_dat_subset_obt2d, !is.na(acr_u_cat300)),
  group_var = "acr_u_cat300",
  log_vars = im_vars_log,
  var_labels = im_vars_2_labels,
  file_prefix = "obt2d_acr300",
  fill_label = "UACR\nCategory"
)

plot_boxgrid(
  df = subset(harm_dat_subset_t2d, !is.na(acr_u_cat300)),
  group_var = "acr_u_cat300",
  log_vars = im_vars_log,
  var_labels = im_vars_2_labels,
  file_prefix = "t2d_acr300",
  fill_label = "UACR\nCategory"
)

harm_dat_subset <- harm_dat_subset %>% arrange(mrn, imaging_visit)
plot_boxgrid(
  df = subset(harm_dat_subset, 
              imaging_visit_id %in% c("ultra_baseline", "ultra_swht_baseline", "ultra_follow_up")),
  group_var = "imaging_visit",
  log_vars = im_vars_log,
  var_labels = im_vars_2_labels,
  file_prefix = "ultra_prepost",
  paired = T
)

harm_dat_subset <- harm_dat_subset %>% arrange(mrn, imaging_visit_id)

plot_boxgrid(
  df = subset(harm_dat_subset, 
              imaging_visit_id %in% c("ultra_swht_baseline", "ultra_swht_follow_up")),
  group_var = "imaging_visit_id",
  log_vars = im_vars_log,
  var_labels = im_vars_2_labels,
  file_prefix = "longitudinal",
  paired = T
)


map(im_vars, ~ hist(harm_dat_subset[[.x]],
                    main = .x,
                    xlab = .x))
```

# correlation with log(UACR), eGFR, BMI, and HbA1c
```{r}
harm_dat_subset <- harm_dat_subset %>%
  mutate(across(
    all_of(im_vars_log),
    ~ ifelse(.x <= 0, NA, log10(.x)),
    .names = "{.col}_log10"
  ))

imaging_for_cor <- c(
  im_vars,                        # original vars
  paste0(im_vars_log, "_log10")   # log versions
)

anchor_vars <- c("log_acr_u", "eGFR_CKD_epi", "bmi", "hba1c")

cor_df <- expand.grid(
  imaging = imaging_for_cor,
  anchor = anchor_vars,
  stringsAsFactors = FALSE
)

cor_df$rho <- NA
cor_df$pval <- NA

for (i in seq_len(nrow(cor_df))) {
  x <- harm_dat_subset[[cor_df$imaging[i]]]
  y <- harm_dat_subset[[cor_df$anchor[i]]]
  tmp <- cor.test(x, y, method = "spearman", exact = FALSE)
  
  cor_df$rho[i]  <- tmp$estimate
  cor_df$pval[i] <- tmp$p.value
}

cor_df$stars <- cut(
  cor_df$pval,
  breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
  labels = c("***", "**", "*", "")
)

ggplot(cor_df, aes(x = anchor, y = imaging, fill = rho)) +
  geom_tile(color = "white") +
  geom_text(aes(label = stars), color = "black") +
  scale_fill_gradient2(
    low = "#2166ac", mid = "white", high = "#b2182b",
    midpoint = 0, limits = c(-1, 1)
  ) +
  theme_minimal(base_size = 14) +
  labs(fill = "rho")
```