---
title: "RENAL HEIR Analysis"
author: "Ye Ji Choi & Tim Vigers"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    theme: default
    page-layout: full
    embed-resources: true
editor: visual
---

```{r, include = F}
library(dplyr)
library(tidyr)
library(table1)
library(Hmisc)
library(rstatix)
library(purrr)
library(kableExtra)
library(knitr)
library(arsenal)
library(data.table)
library(ggpubr)
library(smplot2)
library(magrittr)
library(ppcor)
source("/Users/choiyej/GitHub/YC_CHCO/R Functions/correlation_function.R")
```

```{r, include = F}
dat <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/Data Clean/harmonized_dataset.csv", na.strings = c(" ", "", "-9999",-9999))
dict <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/data_dictionary_master.csv", na.strings = c(" ", "", "-9999",-9999)) %>%
  dplyr::select(variable_name, label)

dat <- dat %>%
  filter(study == "RENAL-HEIR") %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
            across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
            .by = record_id) %>%
  filter(participation_status=="Participated") %>%
  mutate(race_ethnicity_condensed = case_when(race == "White" & 
                                                ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
                                              race == "Black or African American" & 
                                                ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
                                              ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
                                              T ~ "Not Hispanic or Latino Other")) %>%
  mutate(elevated_albuminuria = case_when(elevated_albuminuria == "Yes" ~ "Elevated albuminuria",
                                          elevated_albuminuria == "No" ~ "Normoalbuminuria")) %>% 
  mutate_at(vars(starts_with("fsoc")), function(x) case_when(x < 0 ~ 0, T~x)) 

dat %<>%
  mutate(m_i = raw_m / steady_state_insulin,
         ht_tkv = total_kidney_volume_ml/height,
         lc_k2_f = lc_k2/lc_f,
         rc_k2_f = rc_k2/rc_f,
         lm_k2_f = lm_k2/lm_f,
         rm_k2_f = rm_k2/rm_f,
         lc_k2_k1 = lc_k2/lc_k1,
         rc_k2_k1 = rc_k2/rc_k1,
         lm_k2_k1 = lm_k2/lm_k1,
         rm_k2_k1 = rm_k2/rm_k1,
         avg_c_f = rowMeans(dplyr::select(., lc_f, rc_f), na.rm = T),
         avg_m_f = rowMeans(dplyr::select(., lm_f, rm_f), na.rm = T),
         avg_c_k2 = rowMeans(dplyr::select(., lc_k2, rc_k2), na.rm = T),
         avg_m_k2 = rowMeans(dplyr::select(., lm_k2, rm_k2), na.rm = T),
         avg_c_vb = rowMeans(dplyr::select(., lc_vb, rc_vb), na.rm = T),
         avg_m_vb = rowMeans(dplyr::select(., lm_vb, rm_vb), na.rm = T),
         avg_c_k1 = rowMeans(dplyr::select(., lc_k1, rc_k1), na.rm = T),
         avg_m_k1 = rowMeans(dplyr::select(., lm_k1, rm_k1), na.rm = T),
         avg_bl_cortex = rowMeans(dplyr::select(., bold_l_bl_cortex, bold_r_bl_cortex), na.rm = T),
         avg_bl_medulla = rowMeans(dplyr::select(., bold_l_bl_medulla, bold_r_bl_medulla), na.rm = T),
         avg_fsoc_medulla = rowMeans(dplyr::select(., fsoc_l_medulla, fsoc_r_medulla), na.rm = T),
         avg_pcasl3d = rowMeans(dplyr::select(., pcasl3d_left, pcasl3d_right), na.rm = T),
         avg_k1_wo_cyst = rowMeans(dplyr::select(., ltot_k1_wo_cyst, rtot_k1_wo_cyst), na.rm = T),
         avg_k2_wo_cyst = rowMeans(dplyr::select(., ltot_k2_wo_cyst, rtot_k2_wo_cyst), na.rm = T),
         egfr_hyper = case_when(eGFR_fas_cr >= 135 ~ "Yes", eGFR_fas_cr < 135 ~ "No"),
         insulin_cpep = steady_state_insulin / steady_state_cpeptide,
         smr = case_when(!is.na(breast_tanner) ~ breast_tanner,
                         !is.na(testicular_volume) ~ ceiling(testicular_volume),
                         sex == "Female" & age >= 14 & group == "Type 2 Diabetes"|
                           sex == "Male" & age >= 16  & group == "Type 2 Diabetes" ~ 5,
                         sex == "Female" & age >= 16 ~ 5,
                         sex == "Male" & age >= 17 ~ 5)) 

homa <- dat %>%
  dplyr::select(record_id, co_enroll_id, group, fasting_insulin, fbg, homa_ir, triglycerides, hba1c, waistcm, search_eis)

mgfr_sub <- subset(dat, group == "Lean Control", select = gfr_bsa_plasma) %>% dplyr::ungroup() %>%
  dplyr::summarise(mgfr_mean = mean(gfr_bsa_plasma), mgfr_sd = sd(gfr_bsa_plasma)) %>%
  mutate(mgfr_cutoff = mgfr_mean + (2*mgfr_sd))

dat <- dat %>%
  mutate(mgfr_hyper = case_when(gfr_bsa_plasma >= mgfr_sub$mgfr_cutoff ~ "Yes",
                                gfr_bsa_plasma < mgfr_sub$mgfr_cutoff ~ "No"))
dat$smr <- as.factor(dat$smr)

dat_obese_t2d <- dat %>%
  filter(group!="Lean Control")

dict <- setNames(data.frame(t(dict[ , - 1])), dict[ , 1])
dict %<>%
  mutate(egfr_hyper = "Hyperfiltration defined by eGFR FAS",
         mgfr_hyper = "Hyperfiltration defined by mGFR BSA",
         elevated_albuminuria = "Elevated Albuminuria",
         m_i = "M/I",
         race_ethnicity_condensed = "Race/Ethnicity",
         lc_k2_f = "Left Cortex K2/F (g/min)",
         rc_k2_f = "Right Cortex K2/F (g/min)",
         lm_k2_f = "Left Medulla K2/F (g/min)",
         rm_k2_f = "Right Medulla K2/F (g/min)",
         avg_c_f = "Average Cortex F (ml/min/g)",
         avg_m_f = "Average Medulla F (ml/min/g)",
         avg_c_k2 = "Average Cortex K2 (1/min) ",
         avg_m_k2 = "Average Medulla K2 (1/min) ",
         avg_c_vb = "Average Cortex vb",
         avg_m_vb = "Average Medulla vb",
         avg_c_k1 = "Average Cortex k1 (ml/g/min)",
         avg_m_k1 = "Average Medulla k1 (ml/g/min)",
         rtot_k1_wo_cyst = "Voxel-wise right k1",
         ltot_k1_wo_cyst = "Voxel-wise left k1",
         rtot_k2_wo_cyst = "Voxel-wise right k2",
         ltot_k2_wo_cyst = "Voxel-wise left k2",
         avg_k1_wo_cyst = "Voxel-wise Average k1",
         avg_k2_wo_cyst = "Voxel-wise Average k2",
         avg_c_k2_f = "Average Cortex k2/F",
         avg_c_k2_k1 = "Average Cortex k2/k1",
         erpf_raw_plasma = "RPF from plasma clearance",
         avg_pcasl3d = "Average cortex 3D ASL",
         avg_bl_cortex = "Average cortex R2*",
         avg_bl_medulla = "Average medulla R2*",
         avg_fsoc_medulla = "Average FSOC medulla",
         insulin_cpep = "Insulin/C-peptide ratio",
         smr = "Tanner stage")
```

```{r include = F}
# Distribution check
# dat %>%
#   dplyr::select(age, bmi, weight, height, waistcm, hba1c, sbp, dbp, cholesterol, ldl, hdl, triglycerides ,eGFR_fas_cr, eGFR_fas_cr_cysc, acr_u, homa_ir, search_eis, insulin_cpep) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
# 
# dat %>%
#   dplyr::select(dexa_lean_kg, dexa_fat_kg, dexa_body_fat, dexa_trunk_kg, fasting_ffa, ffa_suppression, fasting_insulin, steady_state_insulin, steady_state_cpeptide, raw_m, m_i, di, airg, acprg) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
# 
# dat %>%
#   dplyr::select(gfr_raw_plasma,  gfr_bsa_plasma,  erpf_raw_plasma,  erpf_bsa_plasma,  ff,  glomerular_pressure,  ra,  re,  rvr,  total_kidney_volume_ml, pcasl3d_left, pcasl3d_right, adc_left, adc_right, bold_l_bl_cortex, bold_r_bl_cortex,  bold_l_bl_medulla, bold_r_bl_medulla,   fsoc_l_medulla, fsoc_r_medulla, fsoc_l_medulla, fsoc_r_medulla) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
# 
```

```{r include=F}
# Label data
dict <- dict[intersect(names(dat), names(dict))]
dict[setdiff(names(dat), names(dict))] <- ""
Hmisc::label(dat) = dict[match(names(dat), names(dict))]

dict <- dict[intersect(names(dat_obese_t2d), names(dict))]
dict[setdiff(names(dat_obese_t2d), names(dict))] <- ""
Hmisc::label(dat_obese_t2d) = dict[match(names(dat_obese_t2d), names(dict))]
```

# Table 1

## All Participants

```{r, include=F}
table_one <- tableby(group ~ age + diabetes_duration + sex + fe(race_ethnicity_condensed) + bmi + weight + height + waistcm + kwt(hba1c, "Nmiss", "median", "q1q3", "range") + sbp + dbp + cholesterol + ldl + hdl +  homa_ir + kwt(search_eis, "Nmiss", "median", "q1q3", "range") + kwt(triglycerides, "Nmiss", "median", "q1q3", "range") + kwt(eGFR_fas_cr, "Nmiss", "median", "q1q3", "range") + kwt(eGFR_fas_cr_cysc, "Nmiss", "median", "q1q3", "range") + kwt(acr_u, "Nmiss", "median", "q1q3", "range") + fe(elevated_albuminuria) + fe(metformin_timepoint) + fe(insulin_med_timepoint) +  fe(sglti_timepoint) + fe(tzd_timepoint) + fe(raasi_timepoint) + fe(statin) + fe(fibrates_timepoint) + fe(egfr_hyper) + fe(mgfr_hyper) + fe(glp1_agonist_timepoint) + fe(smr), data = dat)
```

```{r results='asis'}
table_one <- summary(table_one, pfootnote = T, digits=3, digits.pct=0)
table_one
```

```{r, include=F}
as.data.frame(table_one)
write.csv2(as.data.frame(table_one),"/Users/choiyej/GitHub/YC_CHCO/RH/t1.csv", row.names = F)
```

## Obese and T2D Only

```{r, include=F}
table_one_lim <- tableby(group ~ age + diabetes_duration + sex + fe(race_ethnicity_condensed) + bmi + weight + height + waistcm + kwt(hba1c, "Nmiss", "median", "q1q3", "range") + sbp + dbp + cholesterol + ldl + hdl + search_eis + homa_ir + kwt(triglycerides, "Nmiss", "median", "q1q3", "range") + kwt(eGFR_fas_cr, "Nmiss", "median", "q1q3", "range") + kwt(eGFR_fas_cr_cysc, "Nmiss", "median", "q1q3", "range") + kwt(acr_u, "Nmiss", "median", "q1q3", "range") + + fe(elevated_albuminuria) + fe(egfr_hyper) + fe(mgfr_hyper) + fe(metformin_timepoint) + fe(insulin_med_timepoint) +  fe(sglti_timepoint) + fe(tzd_timepoint) + fe(raasi_timepoint) + fe(statin) + fe(fibrates_timepoint)+ fe(glp1_agonist_timepoint), data = dat_obese_t2d)
```

```{r results='asis'}
table_one_lim <- summary(table_one_lim, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_one_lim
```

```{r, include=F}
as.data.frame(table_one_lim)
write.csv2(as.data.frame(table_one_lim),"/Users/choiyej/GitHub/YC_CHCO/RH/t1.1.csv", row.names = F)
```

# Table 2

## All Participants

```{r, include = F}
table_two <- tableby(group ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range"), data = dat)
```

```{r results='asis'}
table_two <- summary(table_two, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_two
```

```{r, include=F}
as.data.frame(table_two)
write.csv2(as.data.frame(table_two),"/Users/choiyej/GitHub/YC_CHCO/RH/t_2.csv", row.names = F)
```

## Obese and T2D Only

```{r, include=F}
table_two_lim <- tableby(group ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range") + kwt(insulin_cpep, "Nmiss", "median", "q1q3", "range"), data = dat_obese_t2d)
```

```{r results='asis'}
table_two_lim <- summary(table_two_lim, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_two_lim
```

```{r, include=F}
as.data.frame(table_two_lim)
write.csv2(as.data.frame(table_two_lim),"/Users/choiyej/GitHub/YC_CHCO/RH/t_2.1.csv", row.names = F)
```
## Excluding RAASi and SGLTi

```{r, include=F}
table_two_raas_sglt <- tableby(group ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range") + kwt(insulin_cpep, "Nmiss", "median", "q1q3", "range"), data = subset(dat_obese_t2d, raasi_timepoint == "No" & sglti_timepoint == "No"))
```

```{r results='asis'}
table_two_raas_sglt <- summary(table_two_raas_sglt, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_two_raas_sglt
```

```{r, include=F}
as.data.frame(table_two_raas_sglt)
write.csv2(as.data.frame(table_two_raas_sglt),"/Users/choiyej/GitHub/YC_CHCO/RH/t_2.2.csv", row.names = F)
```

# Table 3

## All Participants

```{r, include = F}
table_three <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla + fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d + avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla, data = dat)

table_three_lean <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla +  fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d + avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla, data = subset(dat, group != "Lean Control"))

table_three_obese <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla + fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d + avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla, data = subset(dat, group != "Obese Control"))

table_three_t2d <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr + pcasl3d_left + pcasl3d_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla + fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d + avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla, data = subset(dat, group != "Type 2 Diabetes"))
```

```{r results='asis'}
table_three <- summary(table_three, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three

table_three_lean <- summary(table_three_lean, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three_lean

table_three_obese <- summary(table_three_obese, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three_obese

table_three_t2d <- summary(table_three_t2d, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three_t2d
```

```{r, include = F}
as.data.frame(table_three)
write.csv2(as.data.frame(table_three),"/Users/choiyej/GitHub/YC_CHCO/RH/t_3.csv", row.names = F)
```


## Obese and T2D Only

```{r, include=F}
table_three_lim <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + ht_adj_tkv + pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla +   fsoc_l_medulla + fsoc_r_medulla , data = dat_obese_t2d)
```

```{r results='asis'}
table_three_lim <- summary(table_three_lim, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three_lim
```

```{r, include = F}
as.data.frame(table_three_lim)
write.csv2(as.data.frame(table_three_lim),"/Users/choiyej/GitHub/YC_CHCO/RH/t_3.1.csv", row.names = F)
```

## Excluding RAASi and SGLT2i

```{r, include=F}
table_three_raas_sglt <- tableby(group ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + ht_adj_tkv + pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla +   fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d + avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla , data = subset(dat, sglti_timepoint == "No" & raasi_timepoint == "No"))
```

```{r results='asis'}
table_three_raas_sglt <- summary(table_three_raas_sglt, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_three_raas_sglt
```

```{r, include = F}
as.data.frame(table_three_raas_sglt)
write.csv2(as.data.frame(table_three_raas_sglt),"/Users/choiyej/GitHub/YC_CHCO/RH/t_3.2.csv", row.names = F)
```



# Table 4 (Tables)
Non-parametric variables:

-   UACR
-   eGFR
-   hba1c
-   triglycerides
-   acprg
-   airg
-   DI
-   fasting_insulin
-   ffa_suppression
-   m_i
-   steady_state_insulin
-   re

```{r}
source("/Users/choiyej/GitHub/YC_CHCO/R Functions/correlation_function.R")
dat %<>%
  mutate(avg_bl_cortex_row = avg_bl_cortex, 
         avg_bl_medulla_row = avg_bl_medulla, 
         avg_fsoc_medulla_row = avg_fsoc_medulla)
dict %<>%
  mutate(acprg = "ACPRg",
         airg = "AIRg",
         dexa_body_fat = "Body fat (%)",
         dexa_fat_kg = "Fat mass (kg)",
         dexa_lean_mass = "Lean mass (%)",
         di = "DI",
         erpf_bsa_plasma = "RPF (BSA)",
         erpf_raw_plasma = "RPF",
         gfr_bsa_plasma = "GFR (BSA)",
         gfr_raw_plasma = "GFR",
         glomerular_pressure = "Pglo",
         rvr = "RVR",
         avg_bl_cortex_row = avg_bl_cortex,
         avg_bl_medulla_row = avg_bl_medulla, 
         avg_fsoc_medulla_row = avg_fsoc_medulla)

# Save correlation table in csv format for all participants (pearson)
correlation_table_minimal(dat, c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure",
                                 "rvr", "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla",
                                 "dexa_lean_mass","dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                                 "acr_u", "hba1c", "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                          n_cols = 7, dict = dict, cor_method = "pearson",
                          save_path = "/Users/choiyej/GitHub/YC_CHCO/RH/pearson_all.csv")

# Save correlation table in csv format for all participants (spearman)
correlation_table_minimal(dat, c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure",
                                 "rvr", "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla",
                                 "dexa_lean_mass","dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                                 "acr_u", "hba1c", "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                          n_cols = 7, dict = dict, cor_method = "spearman",
                          save_path = "/Users/choiyej/GitHub/YC_CHCO/RH/spearman_all.csv")

# Save correlation table in csv format for T2D and obese only (pearson)
correlation_table_minimal(subset(dat, group != "Lean Control"), 
                          c("gfr_raw_plasma","erpf_raw_plasma","glomerular_pressure","rvr",
                            "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla",
                            "dexa_lean_mass", "dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                            "fasting_ffa", "ffa_suppression","fasting_insulin", "steady_state_insulin",
                            "steady_state_cpeptide", "raw_m","m_i","di", "airg","acprg",
                            "hba1c", "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                            n_cols = 7, dict = dict, cor_method = "pearson",
                            save_path = "/Users/choiyej/GitHub/YC_CHCO/RH/co_obeset2d_2_pearson.csv")

# Save correlation table in csv format for T2D and obese only (spearman)
correlation_table_minimal(subset(dat, group != "Lean Control"), 
                          c("gfr_raw_plasma","erpf_raw_plasma","glomerular_pressure","rvr",
                            "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla",
                            "dexa_lean_mass", "dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                            "fasting_ffa", "ffa_suppression","fasting_insulin", "steady_state_insulin",
                            "steady_state_cpeptide", "raw_m","m_i","di", "airg","acprg",
                            "hba1c", "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                            n_cols = 7, dict = dict, cor_method = "spearman",
                            save_path = "/Users/choiyej/GitHub/YC_CHCO/RH/co_obeset2d_2_spearman.csv")
```

# Table 4 (Heatmap plots)
```{r warning=F}
# Correlation heatmaps
# Adding sig of multivariable linear regression (adjusting for sex and hba1c) to pearson correlation
png(height = 1000, width = 1200, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation1_sex_hba1c.png", res = 170)
corr_plot_ver2(dat, X = c("dexa_lean_mass", "dexa_fat_kg", "dexa_body_fat",  "dexa_trunk_kg", 
                          "acr_u","hba1c","avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
                        Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure", "rvr", 
                             "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex + hba1c",
                   dict = dict)
dev.off()

# Adding sig of multivariable linear regression (adjusting for sex and hba1c) to spearman correlation
png(height = 1000, width = 1200, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation1_sex_hba1c_spearman.png", res = 170)
corr_plot_ver2(dat, X = c("dexa_lean_mass", "dexa_fat_kg", "dexa_body_fat", "dexa_trunk_kg", 
                          "acr_u","hba1c","avg_bl_cortex",  "avg_bl_medulla", "avg_fsoc_medulla"),
               Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure", "rvr", 
                     "avg_bl_cortex_row",  "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex + hba1c",
                   cor_method = "spearman",
                   dict = dict)
dev.off()
# Adding sig of multivariable linear regression (adjusting for sex only) to spearman correlation
png(height = 1000, width = 1200, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation1_sex_spearman.png", res = 170)
corr_plot_ver2(dat, X = c("dexa_lean_mass",  "dexa_fat_kg", "dexa_body_fat", "dexa_trunk_kg", 
                          "acr_u","hba1c","avg_bl_cortex",  "avg_bl_medulla", 
                          "avg_fsoc_medulla"),
               Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure", "rvr",  "avg_bl_cortex_row", 
                     "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex",
                   cor_method = "spearman",
                   dict = dict)
dev.off()
# Partial pearson correlations adjusting for BMI
png(height = 1000, width = 1200, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation1_partial.png", res = 170)
pcor.plot(dat, 
          X = c("dexa_lean_mass", "dexa_fat_kg", "dexa_body_fat", "dexa_trunk_kg", 
                "acr_u","hba1c", "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
          Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure",  "rvr", 
                "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
          Z = "bmi", 
          dict = dict)
dev.off()
# Partial spearman correlation adjusting for BMI 
png(height = 1000, width = 1200, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation2_partial.png", res = 170)
pcor.plot(dat, 
          X = c("dexa_lean_mass", "dexa_fat_kg", "dexa_body_fat", "dexa_trunk_kg", 
                "acr_u","hba1c", "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
          Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure",  "rvr", 
                "avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
          Z = "bmi", dict = dict,
                   cor_method = "spearman")
dev.off()
```
## Obese and T2D
```{r}
# Add multivariable linear regression significance adjusting for sex and hba1c to pearson correlation in obese and T2D only
png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation3.1_sex_hba1c.png", res = 170)
corr_plot_ver2(subset(dat, group != "Lean Control"), 
               X = c("dexa_lean_mass","dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                     "fasting_ffa", "ffa_suppression", "fasting_insulin", "steady_state_insulin",
                     "steady_state_cpeptide", "raw_m","m_i","di", "airg","acprg",
                     "hba1c","avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
               Y = c("gfr_raw_plasma", "erpf_raw_plasma", "glomerular_pressure", 
                     "rvr","avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex + hba1c", 
                   dict = dict)
dev.off()
# Add multivariable linear regression significance adjusting for sex and hba1c to spearman correlation in obese and T2D only
png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation3.1_sex_hba1c_2.png", res = 170)
corr_plot_ver2(subset(dat, group != "Lean Control"), 
               X = c("dexa_lean_mass","dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                     "fasting_ffa","ffa_suppression","fasting_insulin","steady_state_insulin",
                     "steady_state_cpeptide","raw_m","m_i","di","airg","acprg",
                     "hba1c","avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
               Y = c("gfr_raw_plasma", "erpf_raw_plasma",  "glomerular_pressure", 
                     "rvr","avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex + hba1c",
                   cor_method = "spearman",
                   dict = dict)
dev.off()
# Add multivariable linear regression significance adjusting for sex to spearman correlation in obese and T2D only
png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation3.1_sex_2.png", res = 170)
corr_plot_ver2(subset(dat, group != "Lean Control"), 
               X = c("dexa_lean_mass","dexa_fat_kg","dexa_body_fat","dexa_trunk_kg",
                     "fasting_ffa","ffa_suppression","fasting_insulin","steady_state_insulin",
                     "steady_state_cpeptide","raw_m","m_i","di","airg","acprg",
                     "hba1c","avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
               Y = c("gfr_raw_plasma", "erpf_raw_plasma",  "glomerular_pressure", 
                     "rvr","avg_bl_cortex_row", "avg_bl_medulla_row", "avg_fsoc_medulla_row"), 
                   adj_var = "sex",
                   cor_method = "spearman",
                   dict = dict)
dev.off()

# Partial correlation adjusting for BMI
png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation3.1_partial.png", res = 170)
pcor.plot(subset(dat, group != "Lean Control"), 
          X = c("dexa_lean_mass","dexa_fat_kg","dexa_body_fat", "dexa_trunk_kg", "fasting_ffa",
                "ffa_suppression","fasting_insulin", "steady_state_insulin","steady_state_cpeptide",
                "raw_m", "m_i",  "di",  "airg", "acprg","hba1c",
                "avg_bl_cortex", "avg_bl_medulla", "avg_fsoc_medulla"),
          Y = c("gfr_raw_plasma",  "erpf_raw_plasma",  "glomerular_pressure", "rvr",
                "avg_bl_cortex_row", "avg_bl_medulla_row",  "avg_fsoc_medulla_row"), 
          Z = "bmi", dict = dict)
dev.off()
```

```{r}

png(height = 1000, width = 1100, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation4.png", res = 170)
corr_plot_modified(subset(dat, group != "Lean Control"), X = c(
                             "ffa_suppression",
                             "fasting_insulin", 
                             "steady_state_insulin", 
                             "m_i", 
                             "di",
                             "airg",
                             "acprg",
                             "acr_u", "hba1c"),
                   Y = c("gfr_raw_plasma", 
                   "gfr_bsa_plasma",
                   "erpf_raw_plasma", 
                   "erpf_bsa_plasma", 
                   "glomerular_pressure", 
                   "rvr", 
                   "avg_bl_cortex", 
                   "avg_bl_medulla", 
                   "avg_fsoc_medulla"), dict = dict, cor_method = "spearman")
dev.off()

png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation4.1.png", res = 170)
corr_plot_modified(subset(dat, group != "Lean Control"), X = c("dexa_lean_mass",
                                         "dexa_fat_kg",
                                         "dexa_body_fat",
                                         "dexa_trunk_kg",
                                         "fasting_ffa",
                                         "ffa_suppression",
                                         "fasting_insulin",
                                         "steady_state_insulin",
                                         "steady_state_cpeptide",
                                         "raw_m",
                                         "m_i",
                                         "di",
                                         "airg",
                                         "acprg", "hba1c",
                                         "avg_bl_cortex_row", 
                             "avg_bl_medulla_row", 
                             "avg_fsoc_medulla_row"),
                   Y = c("gfr_raw_plasma", 
                   "erpf_raw_plasma", 
                   "glomerular_pressure", 
                   "rvr", 
                   "avg_bl_cortex", 
                   "avg_bl_medulla", 
                   "avg_fsoc_medulla"), dict = dict, cor_method = "spearman")
dev.off()

# Partial correlation adjusting for BMI
png(height = 1400, width = 1000, file = "/Users/choiyej/GitHub/YC_CHCO/RH/correlation4.1_partial.png", res = 170)
pcor.plot(subset(dat, group != "Lean Control"), X = c("dexa_lean_mass",
                                         "dexa_fat_kg",
                                         "dexa_body_fat",
                                         "dexa_trunk_kg",
                                         "fasting_ffa",
                                         "ffa_suppression",
                                         "fasting_insulin",
                                         "steady_state_insulin",
                                         "steady_state_cpeptide",
                                         "raw_m",
                                         "m_i",
                                         "di",
                                         "airg",
                                         "acprg", "hba1c",
                                         "avg_bl_cortex", 
                             "avg_bl_medulla", 
                             "avg_fsoc_medulla"),
                   Y = c("gfr_raw_plasma", 
                   "erpf_raw_plasma", 
                   "glomerular_pressure", 
                   "rvr", 
                   "avg_bl_cortex_row", 
                   "avg_bl_medulla_row", 
                   "avg_fsoc_medulla_row"),
          Z = "bmi", dict = dict, cor_method = "spearman")
dev.off()

```

# Table 5

## All Participants

```{r, include = F}
table_five <- tableby(elevated_albuminuria ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + ht_adj_tkv +  pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla + fsoc_l_medulla + fsoc_r_medulla + fsoc_l_medulla + fsoc_r_medulla,  data = dat)
```

```{r results='asis'}
table_five <- summary(table_five, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_five
```

```{r, include = F}
as.data.frame(table_five)
write.csv2(as.data.frame(table_five),"/Users/choiyej/GitHub/YC_CHCO/RH/t_5.csv", row.names = F)
```

## T2D Only

```{r, include=F}
table_five_lim <- tableby(elevated_albuminuria ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + ht_adj_tkv +  pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla + fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d +  avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla,  data = subset(dat, group == "Type 2 Diabetes"))
```

```{r results='asis'}
table_five_lim <- summary(table_five_lim, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_five_lim
```

```{r, include = F}
as.data.frame(table_five_lim)
write.csv2(as.data.frame(table_five_lim),"/Users/choiyej/GitHub/YC_CHCO/RH/t_5.1.csv", row.names = F)
```

# Table 6

## All Participants

```{r, include = F}
table_six <- tableby(elevated_albuminuria ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range"), data = dat)
```

```{r results='asis'}
table_six <- summary(table_six, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_six
```

```{r, include = F}
as.data.frame(table_six)
write.csv2(as.data.frame(table_six),"/Users/choiyej/GitHub/YC_CHCO/RH/t_6.csv", row.names = F)
```

## T2D Only

```{r, include=F}
table_six_lim <- tableby(elevated_albuminuria ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range"), data = subset(dat, group == "Type 2 Diabetes"))
```

```{r results='asis'}
table_six_lim <- summary(table_six_lim, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_six_lim
```

```{r, include = F}
as.data.frame(table_six_lim)
write.csv2(as.data.frame(table_six_lim),"/Users/choiyej/GitHub/YC_CHCO/RH/t_6.1.csv", row.names = F)
```

# Table 5 (by hyperfiltration)

```{r, include=F}
table_five_lim_hyper <- tableby(mgfr_hyper ~ gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  ff +  glomerular_pressure +  ra +  kwt(re, "Nmiss", "median", "q1q3", "range") +  rvr +  total_kidney_volume_ml + ht_adj_tkv +  pcasl3d_left + pcasl3d_right + adc_left + adc_right + bold_l_bl_cortex + bold_r_bl_cortex +  bold_l_bl_medulla + bold_r_bl_medulla +   fsoc_l_medulla + fsoc_r_medulla + avg_pcasl3d +  avg_bl_cortex + avg_bl_medulla + avg_fsoc_medulla,  data = subset(dat, group == "Type 2 Diabetes"))
```

```{r results='asis'}
table_five_lim_hyper <- summary(table_five_lim_hyper, pfootnote = T, text = NULL, digits=3, digits.pct=0)
table_five_lim_hyper
```

```{r, include = F}
as.data.frame(table_five_lim_hyper)
write.csv2(as.data.frame(table_five_lim_hyper),"/Users/choiyej/GitHub/YC_CHCO/RH/t_5.2.csv", row.names = F)
```

# Table 6 (by hyperfiltration)

## T2D Only

```{r, include=F}
table_six_lim_hyper <- tableby(mgfr_hyper ~ dexa_lean_kg + dexa_fat_kg + dexa_body_fat + dexa_trunk_kg + fasting_ffa + kwt(ffa_suppression, "Nmiss", "median", "q1q3", "range") + kwt(fasting_insulin, "Nmiss", "median", "q1q3", "range") + kwt(steady_state_insulin, "Nmiss", "median", "q1q3", "range") + steady_state_cpeptide + raw_m + kwt(m_i, "Nmiss", "median", "q1q3", "range") + kwt(di, "Nmiss", "median", "q1q3", "range") + kwt(airg, "Nmiss", "median", "q1q3", "range") + kwt(acprg, "Nmiss", "median", "q1q3", "range"), data = subset(dat, group == "Type 2 Diabetes"))
```

```{r results='asis'}
table_six_lim_hyper <- summary(table_six_lim_hyper, pfootnote = T, text = NULL, digits=1, digits.pct=0)
table_six_lim_hyper
```

```{r, include = F}
as.data.frame(table_six_lim_hyper)
write.csv2(as.data.frame(table_six_lim_hyper),"/Users/choiyej/GitHub/YC_CHCO/RH/t_6.2.csv", row.names = F)
```
# Pairwise comparison

```{r}
# Table 1
TukeyHSD(aov(bmi ~ group, data = dat), "group")
TukeyHSD(aov(weight ~ group, data = dat), "group")
TukeyHSD(aov(height ~ group, data = dat), "group")
TukeyHSD(aov(waistcm ~ group, data = dat), "group")
TukeyHSD(aov(sbp ~ group, data = dat), "group")
TukeyHSD(aov(cholesterol ~ group, data = dat), "group")
TukeyHSD(aov(ldl ~ group, data = dat), "group")
TukeyHSD(aov(hdl ~ group, data = dat), "group")
dunn_test(triglycerides ~ group, data = dat)
dunn_test(search_eis ~ group, data = dat)
dunn_test(eGFR_fas_cr ~ group, data = dat)
dunn_test(acr_u ~ group, data = dat)
dunn_test(hba1c ~ group, data = dat)
# Table 2
TukeyHSD(aov(dexa_lean_kg ~ group, data = dat), "group")
TukeyHSD(aov(dexa_fat_kg ~ group, data = dat), "group")
TukeyHSD(aov(dexa_trunk_kg ~ group, data = dat), "group")
# Table 3
TukeyHSD(aov(gfr_raw_plasma ~ group, data = dat), "group")
TukeyHSD(aov(gfr_bsa_plasma ~ group, data = dat), "group")
TukeyHSD(aov(erpf_raw_plasma ~ group, data = dat), "group")
TukeyHSD(aov(erpf_bsa_plasma ~ group, data = dat), "group")
TukeyHSD(aov(ff ~ group, data = dat), "group")
TukeyHSD(aov(glomerular_pressure ~ group, data = dat), "group")
TukeyHSD(aov(ra ~ group, data = dat), "group")
dunn_test(re ~ group, data = dat)
TukeyHSD(aov(rvr ~ group, data = dat), "group")
TukeyHSD(aov(avg_pcasl3d ~ group, data = dat), "group")
TukeyHSD(aov(avg_c_r2 ~ group, data = dat), "group")
TukeyHSD(aov(avg_m_r2 ~ group, data = dat), "group")
TukeyHSD(aov(avg_m_fsoc ~ group, data = dat), "group")
# Supplemental table 3
TukeyHSD(aov(bold_l_bl_cortex ~ group, data = dat), "group")
TukeyHSD(aov(bold_r_bl_cortex ~ group, data = dat), "group")
TukeyHSD(aov(avg_c_r2 ~ group, data = dat), "group")
TukeyHSD(aov(bold_l_bl_medulla ~ group, data = dat), "group")
TukeyHSD(aov(bold_r_bl_medulla ~ group, data = dat), "group")
TukeyHSD(aov(avg_m_r2 ~ group, data = dat), "group")
TukeyHSD(aov(fsoc_l_medulla ~ group, data = dat), "group")
TukeyHSD(aov(fsoc_r_medulla ~ group, data = dat), "group")
TukeyHSD(aov(avg_m_fsoc ~ group, data = dat), "group")
```

# Multivariable analysis

```{r include = F}
# Function to extract coefficient and p-value for each model adjusting for sex
lm_extract <- function(data, x_vars, y_vars, adj_var) {
  lm_extracted <- data.frame(y = character(0),
                             x = character(0),
                             adj_var = character(0),
                             x_coef = numeric(0),
                             x_pval = numeric(0), 
                             p_sig = character(0))
  for (i in 1:length(x_vars)) {
    if(x_vars[i] != y_vars[i]) {
      lm_formula <- as.formula(paste0(y_vars[i], "~", x_vars[i], "+", adj_var))
      lm_model <- lm(lm_formula, data = data)
      lm_summary <- summary(lm_model)
      lm_coef <- lm_summary$coefficient[x_vars[i], "Estimate"]
      lm_p_val <- lm_summary$coefficient[x_vars[i], "Pr(>|t|)"]
      lm_extracted <- rbind(lm_extracted,
                            data.frame(
                              y = label(data$y_vars[i]),
                              x = label(data$x_vars[i]),
                              adj_var = label(data$adj_var),
                              x_coef = round(lm_coef,3),
                              x_pval = round(lm_p_val,3),
                              p_sig = stars.pval(lm_p_val)))
    }
  }
  return(lm_extracted)
}

# Function to extract coefficient and p-value for each model adjusting for sex
f_extract_group <- function(data, group, y_vars, adj_var) {
  group <- rep(group, times = length(y_vars))
  f_extracted <- data.frame(y = character(0),
                             x = character(0),
                             adj_var = character(0),
                             f_stat = numeric(0),
                             group_pval = numeric(0), 
                             p_sig = character(0))
  for (i in 1:length(group)) {
    if(group[i] != y_vars[i]) {
      lm_formula_1 <- as.formula(paste0(y_vars[i], "~", group[i], "+", adj_var))
      lm_formula_2 <- as.formula(paste0(y_vars[i], "~", adj_var))
      lm_model_1 <- lm(lm_formula_1, data = data)
      lm_model_2 <- lm(lm_formula_2, data = data)
      anova_summary <- anova(lm_model_1, lm_model_2)
      f_stat <- anova_summary[2, "F"]
      f_pval <- anova_summary[2, "Pr(>F)"]
      f_extracted <- rbind(f_extracted,
                            data.frame(
                              y = y_vars[i],
                              x = group[i],
                              adj_var = adj_var,
                              f_stat = round(f_stat,3),
                              group_pval = round(f_pval,3),
                              p_sig = stars.pval(f_pval)))
    }
  }
  return(f_extracted)
}
```

```{r}
lm_extract(data = dat, 
           x_vars = rep(c("dexa_lean_mass", 
                        "dexa_fat_kg", 
                        "dexa_body_fat", 
                        "dexa_trunk_kg", 
                        "acr_u",
                        "hba1c",
                        "avg_bl_cortex", 
                        "avg_bl_medulla", 
                        "avg_fsoc_medulla"), times = 7),
           y_vars = rep(c("gfr_raw_plasma", 
                          "erpf_raw_plasma", 
                          "glomerular_pressure", 
                          "rvr", 
                          "avg_bl_cortex_row", 
                          "avg_bl_medulla_row", 
                          "avg_fsoc_medulla_row"), each = 9),
           adj_var = "sex")

lm_extract(data = dat, 
           x_vars = rep(c("dexa_lean_mass", 
                        "dexa_fat_kg", 
                        "dexa_body_fat", 
                        "dexa_trunk_kg", 
                        "acr_u",
                        "hba1c",
                        "avg_bl_cortex", 
                        "avg_bl_medulla", 
                        "avg_fsoc_medulla"), times = 7),
           y_vars = rep(c("gfr_raw_plasma", 
                          "erpf_raw_plasma", 
                          "glomerular_pressure", 
                          "rvr", 
                          "avg_bl_cortex_row", 
                          "avg_bl_medulla_row", 
                          "avg_fsoc_medulla_row"), each = 9),
           adj_var = "hba1c")


f_extract_group(dat,
                group = "group",
                y_vars =  c("waistcm", "hba1c", "sbp", "dbp", "cholesterol", "ldl", "hdl",  
                            "homa_ir", "search_eis", "triglycerides", "eGFR_fas_cr", 
                            "eGFR_fas_cr_cysc", "acr_u", "dexa_lean_kg", "dexa_fat_kg", "dexa_trunk_kg",
                            "gfr_raw_plasma",  "gfr_bsa_plasma",  "erpf_raw_plasma",  "erpf_bsa_plasma",  
                            "ff",  "glomerular_pressure",  "ra",  "re",  "rvr", "avg_pcasl3d", 
                            "avg_bl_cortex",  "avg_bl_medulla", "avg_fsoc_medulla"),
           adj_var = "sex")
```

```{r include = F}
dat$group <- relevel(factor(dat$group), ref="Type 2 Diabetes")
summary(lm(bold_l_bl_medulla ~ group + sex + bmi + race_ethnicity_condensed, data=dat))
summary(lm(bold_r_bl_medulla ~ group + sex + bmi + race_ethnicity_condensed, data=dat))

summary(lm(fsoc_l_medulla ~ group + sex + bmi, data=dat))
summary(lm(fsoc_r_medulla ~ group + sex + bmi, data=dat))
summary(lm(fsoc_l_medulla ~ group + sex + bmi + race_ethnicity_condensed, data=dat))
summary(lm(fsoc_r_medulla ~ group + sex + bmi + race_ethnicity_condensed, data=dat))

summary(lm(fsoc_l_medulla ~ group + weight, data = dat))
summary(lm(fsoc_r_medulla ~ group + weight, data = dat))
summary(lm(avg_fsoc_medulla ~ group, data = dat))
summary(lm(avg_fsoc_medulla ~ group + weight, data = dat))
anova(lm(avg_fsoc_medulla ~ group, data = dat), lm(avg_fsoc_medulla ~ group + weight, data = dat))
pairs(lsmeans((lm(avg_fsoc_medulla ~ group + weight, data = dat)), specs=c("group")))

# Sensitivity analysis - excluding participants on RAASi and SGLTi
pairs(lsmeans((lm(avg_fsoc_medulla ~ group + weight, data = subset(dat, raasi_timepoint == "No" & sglti_timepoint == "No"))), specs=c("group")))


```

# Interactions

```{r include = F}
# All groups
summary(lm(glomerular_pressure ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat))
summary(lm(glomerular_pressure ~ dexa_body_fat + group + dexa_body_fat*group, data = dat))
summary(lm(glomerular_pressure ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat))
summary(lm(avg_m_r2 ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat))
summary(lm(avg_m_r2 ~ dexa_body_fat + group + dexa_body_fat*group, data = dat))
summary(lm(avg_m_r2 ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat))
summary(lm(avg_m_fsoc ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat))
summary(lm(avg_m_fsoc ~ dexa_body_fat + group + dexa_body_fat*group, data = dat))
summary(lm(avg_m_fsoc ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat))

# T2D only
# Fat mass vs. GFR, RPF, Pglo, R2* cortex, R2* medulla, FSOC medulla
summary(lm(gfr_raw_plasma ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))
summary(lm(erpf_raw_plasma ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))
summary(lm(glomerular_pressure ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))
summary(lm(avg_bl_cortex ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))
summary(lm(avg_bl_medulla ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))
summary(lm(avg_fsoc_medulla ~ dexa_fat_kg + group + dexa_fat_kg*group, data = dat_obese_t2d))

# Trunk mass
summary(lm(gfr_raw_plasma ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))
summary(lm(erpf_raw_plasma ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))
summary(lm(glomerular_pressure ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))
summary(lm(avg_bl_cortex ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))
summary(lm(avg_bl_medulla ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))
summary(lm(avg_fsoc_medulla ~ dexa_trunk_kg + group + dexa_trunk_kg*group, data = dat_obese_t2d))

# M-value
summary(lm(glomerular_pressure ~ raw_m + group + raw_m*group, data = dat_obese_t2d))

# FSOC
summary(lm(avg_fsoc_medulla ~ airg + group + airg*group, data = dat_obese_t2d))
summary(lm(avg_fsoc_medulla ~ acprg + group + acprg*group, data = dat_obese_t2d))
```

# Individual level data (all participants)

```{r warning = F}
# Pglo vs. Fat mass (kg)
pglo1 <- ggplot(dat, aes(dexa_fat_kg, glomerular_pressure)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$glomerular_pressure),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Pglo vs. trunk mass (kg)
pglo2 <- ggplot(dat, aes(dexa_trunk_kg, glomerular_pressure)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$glomerular_pressure),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Pglo vs. Fat percentage
pglo3 <- ggplot(dat, aes(dexa_body_fat, glomerular_pressure)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$glomerular_pressure),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

pglo <- ggarrange(pglo1, pglo2, pglo3,
                     ncol = 2, nrow = 2, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/pglo.png", pglo)

# Left cortex R2* vs. Fat mass
cr21 <- ggplot(dat, aes(dexa_fat_kg, bold_l_bl_cortex)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$bold_l_bl_cortex),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right cortex R2* vs. Fat mass
cr22 <- ggplot(dat, aes(dexa_fat_kg, bold_r_bl_cortex)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$bold_r_bl_cortex),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Left cortex R2* vs. Trunk mass
cr23 <- ggplot(dat, aes(dexa_trunk_kg, bold_l_bl_cortex)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$bold_l_bl_cortex),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right cortex R2* vs. Trunk mass
cr24 <- ggplot(dat, aes(dexa_trunk_kg, bold_r_bl_cortex)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$bold_r_bl_cortex),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

cr2 <- ggarrange(cr21, cr22, cr23, cr24,
                     ncol = 2, nrow = 2, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/cr2.png", cr2)

# Left medulla R2* vs. Fat percentage
mr21 <- ggplot(dat, aes(dexa_body_fat, bold_l_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$bold_l_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla R2* vs. Fat percentage
mr22 <- ggplot(dat, aes(dexa_body_fat, bold_r_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$bold_r_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Left medulla R2* vs. Fat mass
mr23 <- ggplot(dat, aes(dexa_fat_kg, bold_l_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$bold_l_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla R2* vs. Fat mass
mr24 <- ggplot(dat, aes(dexa_fat_kg, bold_r_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$bold_r_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Left medulla R2* vs. Trunk mass
mr25 <- ggplot(dat, aes(dexa_trunk_kg, bold_l_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$bold_l_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla R2* vs. Trunk mass
mr26 <- ggplot(dat, aes(dexa_trunk_kg, bold_r_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$bold_r_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

mr2 <- ggarrange(mr21, mr22, mr23, mr24,
                 mr25, mr26,
                     ncol = 2, nrow = 3, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/mr2.png", mr2, height = 2700, units = "px")

# Left medulla FSOC vs. Fat mass
fsoc1 <- ggplot(dat, aes(dexa_fat_kg, fsoc_l_medulla)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$fsoc_l_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla FSOC vs. Fat mass
fsoc2 <- ggplot(dat, aes(dexa_fat_kg, fsoc_r_medulla)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$fsoc_r_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Left medulla FSOC vs. Trunk mass
fsoc3 <- ggplot(dat, aes(dexa_trunk_kg, fsoc_l_medulla)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$fsoc_l_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla FSOC vs. Trunk mass
fsoc4 <- ggplot(dat, aes(dexa_trunk_kg, fsoc_r_medulla)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$fsoc_r_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Left medulla FSOC vs. Fat percentage
fsoc5 <- ggplot(dat, aes(dexa_body_fat, fsoc_l_medulla)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$fsoc_l_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Right medulla FSOC vs. Fat percentage
fsoc6 <- ggplot(dat, aes(dexa_body_fat, fsoc_r_medulla)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$fsoc_r_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

fsoc <- ggarrange(fsoc1, fsoc2, fsoc3, 
                  fsoc4, fsoc5, fsoc6,
                     ncol = 2, nrow = 3, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/fsoc.png", fsoc, height = 2700, units = "px")
```

# Individual level data (T2D/Obese)

```{r warning = F}
# GFR vs. Fat mass (kg)
gfr1 <- ggplot(subset(dat, group != "Lean Control"), aes(dexa_fat_kg, gfr_raw_plasma)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$gfr_raw_plasma),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# GFR vs. trunk mass (kg)
gfr2 <- ggplot(subset(dat, group != "Lean Control"), aes(dexa_trunk_kg, gfr_raw_plasma)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$gfr_raw_plasma),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# RPF vs. Fat mass (kg)
rpf1 <- ggplot(subset(dat, group != "Lean Control"), aes(dexa_fat_kg, erpf_raw_plasma)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$erpf_raw_plasma),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# RPF vs. trunk mass (kg)
rpf2 <- ggplot(subset(dat, group != "Lean Control"), aes(dexa_trunk_kg, erpf_raw_plasma)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$erpf_raw_plasma),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Pglo vs. trunk mass (kg)
pglo2_1 <- ggplot(subset(dat, group != "Lean Control"), aes(dexa_trunk_kg, glomerular_pressure)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$glomerular_pressure),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Pglo vs. M-value
pglo2_2 <- ggplot(subset(dat, group != "Lean Control"), aes(raw_m, glomerular_pressure)) +
  labs(x = Hmisc::label(dat$raw_m),
       y = Hmisc::label(dat$glomerular_pressure),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

gfr_rpf_pglo <- ggarrange(gfr1, gfr2, rpf1, rpf2,
                          pglo2_1, pglo2_2,
                     ncol = 2, nrow = 3, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/gfr_rpf_pglo.png", gfr_rpf_pglo, height = 2700, units = "px")

# Left medulla FSOC vs. AIRg
fsoc2_1 <- ggplot(subset(dat, group != "Lean Control"), aes(airg, fsoc_l_medulla)) +
  labs(x = Hmisc::label(dat$airg),
       y = Hmisc::label(dat$fsoc_l_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Right medulla FSOC vs. AIRg
fsoc2_2 <- ggplot(subset(dat, group != "Lean Control"), aes(airg, fsoc_r_medulla)) +
  labs(x = Hmisc::label(dat$airg),
       y = Hmisc::label(dat$fsoc_r_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Left medulla FSOC vs. ACPRg
fsoc2_3 <- ggplot(subset(dat, group != "Lean Control"), aes(acprg, fsoc_l_medulla)) +
  labs(x = Hmisc::label(dat$acprg),
       y = Hmisc::label(dat$fsoc_l_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Right medulla FSOC vs. ACPRg
fsoc2_4 <- ggplot(subset(dat, group != "Lean Control"), aes(acprg, fsoc_r_medulla)) +
  labs(x = Hmisc::label(dat$acprg),
       y = Hmisc::label(dat$fsoc_r_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

fsoc_2 <- ggarrange(fsoc2_1, fsoc2_2, fsoc2_3, fsoc2_4, 
                     ncol = 2, nrow = 2, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/fsoc_2.png", fsoc_2)

```

# AVERAGE Individual level data (all participants)

```{r warning = F}
# Average medulla R2* vs. Fat percentage
avg1 <- ggplot(dat, aes(dexa_body_fat, avg_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$avg_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Average medulla R2* vs. Fat mass
avg2 <- ggplot(dat, aes(dexa_fat_kg, avg_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$avg_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Average medulla R2* vs. Trunk mass
avg3 <- ggplot(dat, aes(dexa_trunk_kg, avg_bl_medulla)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$avg_bl_medulla),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Average medulla FSOC vs. Fat mass
avg4 <- ggplot(dat, aes(dexa_fat_kg, avg_m_fsoc)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$avg_m_fsoc),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Average medulla FSOC vs. Trunk mass
avg5 <- ggplot(dat, aes(dexa_trunk_kg, avg_m_fsoc)) +
  labs(x = Hmisc::label(dat$dexa_trunk_kg),
       y = Hmisc::label(dat$avg_m_fsoc),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

# Average medulla FSOC vs. Fat percentage
avg6 <- ggplot(dat, aes(dexa_body_fat, avg_m_fsoc)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$avg_m_fsoc),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#ffba49', '#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'pearson',
              linetype = 'dashed') +
  sm_corr_theme()

avg_plot_1 <- ggarrange(pglo1, pglo3, pglo2, 
                        avg2, avg1, avg3,
                        avg4, avg6, avg5,
                     ncol = 3, nrow = 3, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/avg_1.png", avg_plot_1, width = 2700, height = 2700, units = "px")
```

# Individual level data (T2D/Obese)

```{r warning = F}
# Average medulla FSOC vs. AIRg
avg2_1 <- ggplot(subset(dat, group != "Lean Control"), aes(airg, avg_m_fsoc)) +
  labs(x = Hmisc::label(dat$airg),
       y = Hmisc::label(dat$avg_m_fsoc),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

# Average medulla FSOC vs. ACPRg
avg2_2 <- ggplot(subset(dat, group != "Lean Control"), aes(acprg, avg_m_fsoc)) +
  labs(x = Hmisc::label(dat$acprg),
       y = Hmisc::label(dat$avg_m_fsoc),
       color  = "Group") +
  geom_point(aes(color=group)) +
  scale_color_manual(values=c('#20a39e', "#ef5b5b")) +
  sm_statCorr(color = '#5A5A5A', corr_method = 'spearman',
              linetype = 'dashed', digits = 3) +
  sm_corr_theme()

avg_plot_2 <- ggarrange(gfr1, gfr2, 
                        rpf1, rpf2,
                        pglo2_2, pglo2_1, 
                        avg2_1, avg2_2, 
                        ncol = 2, nrow = 4, common.legend = T)
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/avg_2.png", avg_plot_2, height = 3200, units = "px")

```

# RISE Plot

```{r warning = F, message = F}
#| echo: False
# RISE figures
library(ellipse)
library(shape)
library(RColorBrewer)

dat_obese_t2d %<>%
  remove_labels() %>%
  mutate(bcell_airg = case_when(airg > 0.01 & group == "Type 2 Diabetes" ~ "Type 2 Diabetes**",
                                group == "Type 2 Diabetes" ~ "T2D + Glycemic failure",
                                group == "Obese Control" ~ "Obese Control"),
         bcell_acprg = case_when(airg > 0.01 & group == "Type 2 Diabetes" ~ "Type 2 Diabetes*",
                                group == "Type 2 Diabetes" ~ "T2D + Glycemic failure",
                                group == "Obese Control" ~ "Obese Control"),
         neg_airg = case_when(airg <= 0.00 ~ 1, T ~ 0),
         neg_acprg = case_when(acprg <= 0.00 ~ 1, T ~ 0),
         airg = case_when(airg < 0.0 ~ 0.01, T ~ airg),
         acprg = case_when(acprg < 0.0 ~ 0.01, T ~ acprg))

acprg_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), log(acprg))) +
  geom_point(aes(color = group,
                 shape = group),
             size = 3) +
  labs(color = "Group",
       shape = "Group",
       fill = NULL,
       x = "M-Value",
       y = "Log(ACPRg)",
       tag = "A") +
  # geom_smooth(color = "black") +
  stat_ellipse(geom = "polygon",
               alpha = 0.25,
               aes(fill = group)) +
  stat_ellipse(data = . %>% filter(bcell_acprg != "T2D + Glycemic failure"),
               geom = "polygon",
               alpha = 0.25,
               aes(fill = bcell_acprg)) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 14)) +
  guides(fill = guide_legend(nrow=3),
         color = guide_legend(nrow=3))

airg_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), log(airg))) +
  geom_point(aes(color = group,
                 shape = group),
             size = 3)  +
  labs(color = "Group",
       shape = "Group",
       fill = NULL,
       x = "M-Value",
       y = "Log(AIRg)",
       tag = "B") +
  # geom_smooth(color = "black") +
  stat_ellipse(geom = "polygon",
               alpha = 0.25,
               aes(fill = group)) +
  stat_ellipse(data = . %>% filter(bcell_airg != "T2D + Glycemic failure"),
               geom = "polygon",
               alpha = 0.25,
               aes(fill = bcell_airg)) +
  theme_bw() +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 14))

di_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), log(di))) +
  geom_point(aes(color = group,
                 shape = group),
             size = 3) +
  labs(color = "Group",
       shape = "Group",
       fill = NULL,
       x = "M-Value",
       y = "Log(DI)",
       tag = "C") +
  # geom_smooth(color = "black") +
  stat_ellipse(geom = "polygon",
               alpha = 0.25,
               aes(fill = group)) +
  stat_ellipse(data = . %>% filter(bcell_airg != "T2D + Glycemic failure"),
               geom = "polygon",
               alpha = 0.25,
               aes(fill = bcell_airg))  +
  theme_bw() +
  theme(axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 14))

arranged_m <- ggarrange(acprg_plot, airg_plot,
          common.legend = T,
          ncol = 2, nrow = 1)

annotate_figure(arranged_m, bottom = text_grob("*Excluding participants with \u2264 0 AIRg and/or ACPRg.",
                                               size = 14
                                               ))
ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/mvalue_figures.png", plot = last_plot(),
       width = 8, height = 5)
```

```{r warning = F, message = F}
#| echo: False
# RISE figures
# library(ellipse)
# library(shape)
# library(RColorBrewer)
# 
# dat_obese_t2d %<>%
#   mutate(bcell_airg = case_when(airg > 0.01 & group == "Type 2 Diabetes" ~ "Type 2 Diabetes**",
#                                 group == "Type 2 Diabetes" ~ "T2D + Glycemic failure",
#                                 group == "Obese Control" ~ "Obese Control"),
#          bcell_acprg = case_when(airg > 0.01 & group == "Type 2 Diabetes" ~ "Type 2 Diabetes*",
#                                 group == "Type 2 Diabetes" ~ "T2D + Glycemic failure",
#                                 group == "Obese Control" ~ "Obese Control"),
#          neg_airg = case_when(airg == 0.01 ~ 1, T ~ 0),
#          neg_acprg = case_when(acprg == 0.01 ~ 1, T ~ 0)) 
# 
# acprg_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), (acprg))) +
#   geom_point(aes(color = group,
#                  shape = group),
#              size = 3) +
#   labs(color = "Group",
#        shape = "Group",
#        fill = NULL,
#        x = "M-Value",
#        y = "(ACPRg)",
#        tag = "A") +
#   # geom_smooth(color = "black") +
#   stat_ellipse(geom = "polygon",
#                alpha = 0.25,
#                aes(fill = group))
#   theme_bw() +
#   theme(axis.title.x = element_text(size = 14),
#         axis.title.y = element_text(size = 14),
#         legend.text = element_text(size = 14)) +
#   guides(fill = guide_legend(nrow=3),
#          color = guide_legend(nrow=3))
# 
# airg_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), (airg))) +
#   geom_point(aes(color = group,
#                  shape = group),
#              size = 3)  +
#   labs(color = "Group",
#        shape = "Group",
#        fill = NULL,
#        x = "M-Value",
#        y = "(AIRg)",
#        tag = "B") +
#   # geom_smooth(color = "black") +
#   stat_ellipse(geom = "polygon",
#                alpha = 0.25,
#                aes(fill = group)) +
#   theme_bw() +
#   theme(axis.title.x = element_text(size = 14),
#         axis.title.y = element_text(size = 14),
#         legend.text = element_text(size = 14))
# 
# di_plot <- ggplot(dat_obese_t2d, mapping = aes((raw_m), (di))) +
#   geom_point(aes(color = group,
#                  shape = group),
#              size = 3) +
#   labs(color = "Group",
#        shape = "Group",
#        fill = NULL,
#        x = "M-Value",
#        y = "(DI)",
#        tag = "C") +
#   # geom_smooth(color = "black") +
#   stat_ellipse(geom = "polygon",
#                alpha = 0.25,
#                aes(fill = group)) +
#   theme_bw() +
#   theme(axis.title.x = element_text(size = 14),
#         axis.title.y = element_text(size = 14),
#         legend.text = element_text(size = 14))
# 
# arranged_m <- ggarrange(acprg_plot, airg_plot, di_plot, 
#           common.legend = T,
#           ncol = 1, nrow = 3)
# 
# annotate_figure(arranged_m, bottom = text_grob("*Excluding participants with \u2264 0 AIRg and/or ACPRg.",
#                                                size = 14
#                                                ))
# ggsave("/Users/choiyej/GitHub/YC_CHCO/RH/mvalue_figures.png", plot = last_plot(),
#        width = 5, height = 12)
```

