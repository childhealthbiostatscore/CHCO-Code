---
title: "SGLT2i manuscript - clinical characteristics"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(arsenal)
library(tidyverse)
library(broom)
library(performance)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,fig.height = 10,fig.width = 10)
```

# BOLD MRI

## Data skim

```{r}
# Import data
bold_data = read.csv("/Users/timvigers/Dropbox/Work/CHCO/Petter Bjornstad/Data Harmonization/Data Clean/merged_dataset_2022-10-12.csv",stringsAsFactors = T,na.strings = "")
# List variables
demo_vars = c("age","gender", "eGFR_fas_cr", "gfr","gfr_bsa","bmi")
bold_vars = c("bold_r_bl_cortex","bold_r_bl_medulla","bold_r_bl_kidney",
              "bold_r_pf_cortex","bold_r_pf_medulla","bold_r_pf_kidney",
              "bold_l_bl_cortex","bold_l_bl_medulla","bold_l_bl_kidney",
              "bold_l_pf_cortex","bold_l_pf_medulla","bold_l_pf_kidney",
              "fsoc_r_cortex","fsoc_r_medulla","fsoc_r_kidney",
              "fsoc_l_cortex","fsoc_l_medulla","fsoc_l_kidney")
# Filter and select
bold_data = bold_data %>% 
  filter(group == "T2D",co_enroll == "No",
         case_when(study=="IMPROVE" ~ visit=="Pre-Surgery",T ~ visit=="Baseline")) %>%
  select(subject_id,study,visit,group,sglt2_inhibitors,all_of(demo_vars),all_of(bold_vars))
# Summarize
skimr::skim(bold_data)
# Write CSV in case Petter wants to check the data
write.csv(bold_data,file = "~/Dropbox/Work/CHCO/Petter Bjornstad/T2D scRNA SGLT2i/Data clean/bold_data.csv",row.names = F,na="")
```

## Group comparisons (T2D only) unadjusted

```{r results='asis'}
f = as.formula(paste0("sglt2_inhibitors~",
                      paste0(demo_vars,collapse = "+"),"+",
                      paste0(bold_vars,collapse = "+")))
t_bold <- tableby(formula = f,data = bold_data, control = list(digits = 2))
summary(t_bold,pfootnote = T)
```

## Group comparisons (T2D only) adjusted for sex, BMI and GFR

```{r results='asis'}
# Predictors
pred = c("sglt2_inhibitors","gender","bmi","gfr")
pred_f = paste0("~",paste0(pred,collapse = "+"))
# Loop through outcomes
for (var in bold_vars) {
  f = as.formula(paste0(var,pred_f))
  m = lm(f,data = bold_data)
  res = tidy(m)
  res$term = c("(Intercept)","SGLT2 inhibitors = Yes","Male","BMI","GFR")
  cat("\n")
  cat(paste0("### ",var))
  cat("\n")
  print(kable(res))
  cat("\n")
  cat(paste("Model fit on",nobs(m),"observations."))
  cat("\n")
  print(check_model(m,check = c("outliers","vif","qq","normality")))
  cat("\n")
}
```
