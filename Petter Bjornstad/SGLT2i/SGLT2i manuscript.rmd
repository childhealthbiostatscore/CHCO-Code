---
title: "SGLT2i manuscript - clinical characteristics"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(tableone)
library(dplyr)
library(knitr)
library(questionr)
library(skimr)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

# read in CROCODILE
source("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\CROCODILE-SGLT2iDescriptiveSta_R_2021-12-02_1719.r")
croc <- data
data <- NULL

# read in IMPROVET2D
source("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\IMPROVET2D-SGLT2iManuscriptDesc_R_2021-12-02_1719.r")
improve <- data
data <- NULL

# read in RENALHEIR
source("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\RENALHEIR-SGLT2iManuscriptDesc_R_2021-12-02_1718.r")
heir <- data
data <- NULL

# read in Michigan data
# michigan <- read.csv("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\data_set_without_hpi.csv",na.strings = c("NA",""," "))
michigan <- read.csv("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\clinical_from_RDS.csv",na.strings = c("NA",""," "))

# correct one value
michigan$total_protein <- ifelse(michigan$ID=="CRC-09",7.5,michigan$total_protein)

# calculate pglo_abs
michigan$TotProtgdL <- michigan$total_protein
michigan$HCt <- michigan$hematocrit
michigan$MAP_clamp <- michigan$clamp_map
michigan$HCt_clamp <- michigan$HCt/100
michigan$GFRabsmLs <- michigan$gfr/60
michigan$ERPFabsmLs <- michigan$rpf/60
michigan$FFabs <- michigan$gfr/michigan$rpf
michigan$RBFabs <- michigan$rpf/(1-michigan$HCt_clamp)
michigan$RBFGomabs <- michigan$ERPFabsmLs/(1-michigan$HCt_clamp)
michigan$RVRAbs <- michigan$MAP_clamp/michigan$RBFabs
michigan$Kfg <- ifelse(michigan$Group %in% c("T1D","T2D"),0.1012,0.1733)
michigan$deltaPFabs <- michigan$GFRabsmLs/michigan$Kfg
michigan$Cm_abs <- (michigan$TotProtgdL/michigan$FFabs)*log(1/(1-michigan$FFabs))
michigan$Pg_abs <- 5*(michigan$Cm_abs-2)
michigan$Pglo_abs <- michigan$Pg_abs+michigan$deltaPFabs+10
michigan$Ra_abs <- ((michigan$MAP_clamp - michigan$Pglo_abs)/michigan$RBFGomabs)*1328
michigan$Re_abs <- (michigan$GFRabsmLs/(michigan$Kfg*(michigan$RBFGomabs-michigan$GFRabsmLs)))*1328

write.csv(michigan,"E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data clean\\data_set_without_hpi_with_pgloabs.csv",na = "",row.names = F)

michigan$clamp_height_m <- michigan$clamp_height/100
michigan$clamp_bmi <- michigan$clamp_weight/(michigan$clamp_height_m^2)
michigan$screen_elevated_albuminuria <- as.factor(ifelse(michigan$screen_urine_mab>=30,1,
                                               ifelse(is.na(michigan$screen_urine_mab),NA,0)))
michigan$clamp_elevated_albuminuria <- as.factor(ifelse(michigan$clamp_urine_mab_baseline>=30,1,
                                               ifelse(is.na(michigan$clamp_urine_mab_baseline),NA,0)))
michigan$sex <- as.factor(michigan$sex)
michigan$Glomerular.Nuclear.Count <- NULL
michigan$Fractional.Interstitial.Area <- NULL

# merge in morphometrics
morph <- read.csv("E:\\Petter Bjornstad\\T2D scRNA SGLT2i\\Data raw\\PB Morpho 2-2022.csv")
morph$KL.ID <- morph$Study.ID
morph <- morph %>% select(-c("Study.ID","Group","ID","Priority.24.."))
morph$KL.ID <- ifelse(morph$KL.ID=="KL-0010097","KL-0019097",morph$KL.ID)
michigan <- merge(michigan, morph, by="KL.ID", all.x = T, all.y = F)

# use Tim's code to calculate eGFR by FAS
source("C:\\Users\\pylell\\Documents\\GitHub\\shared-resources\\Data Cleaning\\Calculated Variables\\eGFR.r")
x <- egfr_calc(age=michigan$Age,serum_creatinine = michigan$serum_creatinine, cystatin_c = michigan$cystatin_c,
               bun=michigan$labs_bun, height = michigan$clamp_height_m*100, sex = michigan$sex,
               female="0", male="1")
michigan$eGFR_fas_cr <- x$eGFR_fas_cr
michigan$eGFR_fas_cr_cysc <- x$eGFR_fas_cr_cysc

# exclude T1D for this paper
t1data <- michigan[!michigan$Group=="T1D",]
t1data$three_groups <- ifelse(t1data$Group=="HC","Healthy Controls",
                                ifelse(t1data$SGLT2i=="YES","T2D SGLT2i","T2D No SGLT2i"))

vars <- c("Age","sex","clamp_bmi","dxa_body_fat","cholesterol","ldl","hdl","triglycerides","clamp_sbp","clamp_dbp","clamp_map","clamp_acr_baseline",
          "screen_elevated_albuminuria","clamp_elevated_albuminuria","hba1c","gfr","gfr_bsa","eGFR_fas_cr",
          "serum_creatinine","GIR","labs_bun","Metformin",
          "Insulin","TZD","GLPYES",
          "Fractional.Interstitial.Area",
          "Glomerular.Tuft.Area..um.2.",
          "Glomerular.Volume...Weibel..10.6.um.3.",
          "Glomerular.Volume...Wiggins..10.6.um.3.",
          "Glomerular.Volume...Consensus..10.6.um.3.",
          "Mesangial.Matrix.Area..um.2.",
          "Mesangial.Index....",
          "Mesangial.Volume...Weibel..10.6.um.3.",
          "Mesangial.Volume...Wiggins..10.6.um.3.",
          "Mesangial.Volume...Consensus..10.6.um.3.",
          "Mesangial.Nuclear.Count",
          "Glomerular.Nuclear.Count",
          "SGLT2i_duration_in_all",
          "SGLT2i_duration_in_exposed")
nonnorm <- c("Glomerular.Tuft.Area..um.2.",
          "Glomerular.Volume...Weibel..10.6.um.3.",
          "Glomerular.Volume...Wiggins..10.6.um.3.",
          "Glomerular.Volume...Consensus..10.6.um.3.",
          "Mesangial.Matrix.Area..um.2.",
          "Mesangial.Volume...Weibel..10.6.um.3.",
          "Mesangial.Volume...Wiggins..10.6.um.3.",
          "Mesangial.Volume...Consensus..10.6.um.3.",
          "Mesangial.Nuclear.Count",
          "Glomerular.Nuclear.Count",
          "SGLT2i_duration_in_all",
          "SGLT2i_duration_in_exposed","clamp_acr_baseline")
exact <- c("screen_elevated_albuminuria","clamp_elevated_albuminuria","Metformin","Insulin","TZD","GLPYES")
t1 <- CreateTableOne(vars = vars, data = t1data, strata = "Group", test = TRUE)
t1 <- print(t1,nonnormal = nonnorm, exact=exact)
freq.na(t1data[,vars])

# exclude controls now
t1data_nocontrol <- t1data[!t1data$three_groups == "Healthy Controls",]
t2 <- CreateTableOne(vars = vars, data = t1data_nocontrol, strata = "three_groups", test = TRUE)
t2 <- print(t2,nonnormal = nonnorm, exact=exact)


```

# Data summary

```{r echo=FALSE}
skim(t1data[,vars])
```

# Table 1a - healthy controls vs T2D (T2D SGLT2i + T2D no SGLT2i).  

P-values are from Fisher's exact test (if test="exact") or chi-square test for categorical variables,Mann-Whitney test (if test="nonnorm") or t-tests for continuous variables.

```{r echo=FALSE}

kable(t1)
```

# Table 1b - T2D SGLT2i vs. T2D no SGLT2i.  

P-values are from Fisher's exact test (if test="exact") or chi-square test for categorical variables, Mann-Whitney test (if test="nonnorm") or t-tests for continuous variables.

```{r echo=FALSE}

kable(t2)
```

