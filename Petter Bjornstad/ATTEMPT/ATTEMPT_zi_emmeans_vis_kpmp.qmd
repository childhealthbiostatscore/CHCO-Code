---
title: "ATTEMPT (KPMP cell types) emmeans visualization"
author: "Ye Ji Choi"
date: "r lubridate::today()"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---


```{r echo = F, include = F}
library(jsonlite)
library(aws.s3)
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
library(ComplexUpset)
library(ggupset)
library(Hmisc)
library(ggrounded)
library(circlize)
library(tidyverse)
library(openxlsx)
library(biomaRt)
```

```{r echo = F, include = F}
source("~/GitHub/CHCO-Code/Petter Bjornstad/ATTEMPT/attempt_functions.R")
```

```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```

# nebula

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT

celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  IC = c("IC-A", "IC-B", "aIC"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK"),
  Immune_myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_lymphoid = c("CD4+ T", "CD8+ T", "B", "NK"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD"
)

celltype_groups_nonkpmp <- list(
  PT               = c("PT-1", "PT-2", "PT-3", "PT-4", "PT-5"),
  TAL              = c("TAL-1", "TAL-2", "TAL-3"),
  PC               = c("tPC-IC", "PC-1", "PC-2"),
  IC               = c("IC-A", "IC-B"),
  EC               = c("EC-PTC", "EC-GC", "EC-AEA", "EC-LYM"),
  Immune           = c("MAC", "MON", "NKT/NKC", "T", "B"),
  Immune_myeloid   = c("MAC", "MON"),
  Immune_lymphoid  = c("NKT/NKC", "T", "B"),
  FIBVSMCP         = c("VSMC/P", "FIB"),
  POD              = "POD"
)

## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT
mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl") # to join full name description

# Top 2000 HVG
for (cell in names(celltype_groups))  {
  input_path <- paste0("grouped/", cell, "/HVG/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  # Get gene symbols
  gene_symbols <- processed$results$Gene
  
  # Query Ensembl
  gene_info <- getBM(
    attributes = c("hgnc_symbol", "description", "gene_biotype"),
    filters = "hgnc_symbol",
    values = gene_symbols,
    mart = mart
  ) %>%
    dplyr::rename(Gene = hgnc_symbol)
  
  # Join annotation
  annotated_df <- processed$results %>%
    left_join(gene_info, by = "Gene")

  # Assign to variable dynamically
  var_name <- paste0(tolower(cell), "_hvg_kpmp")
  assign(var_name, annotated_df, envir = .GlobalEnv)
  
  var_name <- paste0(lower_cell, "_hvg_kpmp_cov")
  assign(var_name, processed$overdispersion)
  
  write.csv(annotated_df, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/", tolower(cell), "_kpmp_hvg_res.csv"), row.names = F)
}

# Top 2000 HVG subtypes
for (cell in unlist(celltype_groups))  {
  print(paste0("Processing: ", cell))
  cell <- gsub("/", "_", cell)
  input_path <- paste0("individual/", cell, "/HVG/nebula/individual_", 
                       tolower(cell),
                       "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")
  
  processed <- process_nebula_results(cell_df)
  
  # Check if processed results has 0 rows
  if (nrow(processed$results) == 0) {
    print(paste0("Skipping ", cell, " - no rows in processed results"))
    next
  }
  
  # Get gene symbols
  gene_symbols <- processed$results$Gene
  # Query Ensembl
  gene_info <- getBM(
    attributes = c("hgnc_symbol", "description", "gene_biotype"),
    filters = "hgnc_symbol",
    values = gene_symbols,
    mart = mart
  ) %>%
    dplyr::rename(Gene = hgnc_symbol)
  # Join annotation
  annotated_df <- processed$results %>%
    left_join(gene_info, by = "Gene")
  cell <- gsub("-", "_", cell)
  cell <- gsub("\\+\\s", "_", cell)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_hvg_kpmp")
  print(var_name)
  assign(var_name, processed$results)
  
  var_name <- paste0(lower_cell, "_hvg_kpmp_cov")
  assign(var_name, processed$overdispersion)
  
  write.csv(annotated_df, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/", tolower(cell), "_kpmp_hvg_res.csv"), row.names = F)

}

# Full gene set
for (cell in names(celltype_groups))  {
print(paste0("Processing: ", cell))
  input_path <- paste0("grouped/", cell, "/ALL/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_kpmp")

  assign(var_name, processed$results)
}

# Full gene set subtypes
for (cell in unlist(celltype_groups))  {
print(paste0("Processing: ", cell))
  cell <- gsub("/", "_", cell)
  input_path <- paste0("individual/", cell, "/ALL/nebula/individual_",
                       tolower(cell),
                       "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  cell <- gsub("-", "_", cell)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_kpmp")

  assign(var_name, processed$results)
}
```

```{r echo = F, eval = F}
# save all as one excel spreadsheet with full gene names
top50_wb <- createWorkbook()

# Loop through and extract top 50 genes per cell type
for (cell in names(celltype_groups))  {
  var_name <- paste0(tolower(cell), "_hvg_kpmp")
  df <- get(var_name)

  # Extract top 50 by lowest p-value
  top_genes <- df %>%
    arrange(`p_treatmentDapagliflozin:visitPOST`) %>%
    slice_head(n = 50)

  # Add a worksheet and write the top genes
  addWorksheet(top50_wb, sheetName = cell)
  writeData(top50_wb, sheet = cell, x = top_genes)
}

# # Save the workbook
saveWorkbook(top50_wb, file = "//Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/top50_hvg_nebula_results_by_kpmp_celltype.xlsx", overwrite = TRUE)
```

#### IPA input save

```{r echo = F, eval = F}
# save input for IPA
for (cell in names(celltype_groups)){
  ## HVG
  hvg_df <- get(paste0(tolower(cell), "_hvg_kpmp"))
  hvg_ipa_DiD <- hvg_df %>%
    dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr)
  colnames(hvg_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")
  
  write.csv(hvg_ipa_DiD, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kpmp/nebula/", 
                            tolower(cell), "_nebula_pooled_ipa_input_DiD.csv"), row.names = F)
  
    ## FULL
  df <- get(paste0(tolower(cell), "_kpmp"))
  ipa_DiD <- df %>%
    dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr)
  colnames(ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")
  
  write.csv(ipa_DiD, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kpmp/nebula/", 
                            tolower(cell), "_nebula_pooled_ipa_input_DiD_full.csv"), row.names = F)
  
}
```

# Volcanos

```{r echo = F}
# HVG
for (cell in names(celltype_groups)) {
  lower_cell <- tolower(cell)
  df_name <- paste0(lower_cell, "_hvg_kpmp")
  df <- get(df_name)
  
  plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             paste0("nebula/", df_name, "_kpmp_DiD"),
             formula = "treatment * visit",
             cell_type = cell)

plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             paste0("nebula/", df_name, "_kpmp_DiD"),
             formula = "treatment * visit",
             cell_type = cell)
  
}

# ALL
for (cell in names(celltype_groups)) {
  lower_cell <- tolower(cell)
  df_name <- paste0(lower_cell, "_kpmp")
  df <- get(df_name)
  
  plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             paste0("nebula/", df_name, "_kpmp_DiD"),
             formula = "treatment * visit",
             cell_type = cell)

plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             paste0("nebula/", df_name, "_kpmp_DiD"),
             formula = "treatment * visit",
             cell_type = cell)
}


# cell = "EC_GC"
#   lower_cell <- tolower(cell)
#   df_name <- paste0(lower_cell, "_hvg_kpmp")
#   df <- get(df_name)
#   
#   plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
#              "p_treatmentDapagliflozin:visitPOST",
#              NULL,
#              "logFC Treatment(Dapagliflozin):Visit(POST)", 
#              "-log10(p-value)",
#              paste0("nebula/", df_name, "_kpmp_DiD"),
#              formula = "treatment * visit",
#              cell_type = cell)
# 
# plot_volcano(df, "logFC_treatmentDapagliflozin:visitPOST", 
#              "fdr",
#              NULL,
#              "logFC Treatment(Dapagliflozin):Visit(POST)", 
#              "-log10(FDR adjusted p-value)",
#              paste0("nebula/", df_name, "_kpmp_DiD"),
#              formula = "treatment * visit",
#              cell_type = cell)
```

### PT

#### PT Subtypes

```{r echo = F}
pt_plots <- create_gene_expression_plots(
  main_results = pt_hvg_kpmp,
  subtype_results_list = list(
    "PT-S1/S2" = pt_s1_s2_hvg_kpmp,
    "PT-S3" = pt_s3_hvg_kpmp,
    "aPT" = apt_hvg_kpmp
  ),
  cell_type_prefix = "PT",
  cell_type_labels = c("PT-S1/S2", "PT-S3", "aPT"),
  output_prefix = "kpmp_PT_hvg",
  full_formula = T,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
pt_plots$combined_plot
```


### TAL

#### TAL Subtypes

```{r echo = F}
tal_plots <- create_gene_expression_plots(
  main_results = tal_hvg_kpmp,
  subtype_results_list = list(
    "C-TAL-1" = c_tal_1_hvg_kpmp,
    "C-TAL-2" = c_tal_2_hvg_kpmp,
    "aTAL" = atal_hvg_kpmp,
    "dTAL" = dtal_hvg_kpmp
  ),
  cell_type_prefix = "TAL",
  cell_type_labels = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  output_prefix = "kpmp_TAL_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
tal_plots$combined_plot
```

### PC

#### PC Subtypes

```{r echo = F}
pc_plots <- create_gene_expression_plots(
  main_results = pc_hvg_kpmp,
  subtype_results_list = list(
    "CCD-PC" = ccd_pc_hvg_kpmp,
    "CNT-PC" = cnt_pc_hvg_kpmp,
    "dCCD-PC" = dccd_pc_hvg_kpmp,
    "M-PC" = m_pc_hvg_kpmp,
    "tPC-IC" = tpc_ic_hvg_kpmp
  ),
  cell_type_prefix = "PC",
  cell_type_labels = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  output_prefix = "kpmp_PC_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
```

### Immune (very few cells)

#### Immune Subtypes

```{r echo = F}
immune_plots <- create_gene_expression_plots(
  main_results = immune_hvg_kpmp,
  subtype_results_list = list(
    "MAC" = mac_hvg_kpmp,
    "MON" = mon_hvg_kpmp,
    "cDC" = cdc_hvg_kpmp,
    # "pDC" = pdc_hvg_kpmp,
    "CD4+ T" = cd4_t_hvg_kpmp,
    "CD8+ T" = cd8_t_hvg_kpmp,
    "B" = b_hvg_kpmp,
    "NK" = nk_hvg_kpmp
  ),
  cell_type_prefix = "Immune",
  cell_type_labels = c("MAC", "MON", "cDC",  "CD4+ T", "CD8+ T", "B", "NK"),
  output_prefix = "kpmp_Immune_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)

```


### Immune (Myeloid)

#### Immune Subtypes (Myeloid)

```{r echo = F}
immune_myeloid_plots <- create_gene_expression_plots(
  main_results = immune_myeloid_hvg_kpmp,
  subtype_results_list = list(
    "MAC" = mac_hvg_kpmp,
    "MON" = mon_hvg_kpmp,
    "cDC" = cdc_hvg_kpmp
    # "pDC" = pdc_hvg_kpmp
  ),
  cell_type_prefix = "Immune Myeloid",
  cell_type_labels = c("MAC", "MON", "cDC"),
  output_prefix = "kpmp_Immune_Myeloid_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)

```

### Immune (Lymphoid)

#### Immune Subtypes (Lymphoid)

```{r echo = F}
immune_lymphoid_plots <- create_gene_expression_plots(
  main_results = immune_lymphoid_hvg_kpmp,
  subtype_results_list = list(
    "CD4+ T" = cd4_t_hvg_kpmp,
    "CD8+ T" = cd8_t_hvg_kpmp,
    "B" = b_hvg_kpmp,
    "NK" = nk_hvg_kpmp
  ),
  cell_type_prefix = "Immune Lymphoid",
  cell_type_labels = c("CD4+ T", "CD8+ T", "B", "NK"),
  output_prefix = "kpmp_Immune_Lymphoid_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)

```

### IC

#### IC Subtypes

```{r echo = F}
ic_plots <- create_gene_expression_plots(
  main_results = ic_hvg_kpmp,
  subtype_results_list = list(
    "IC-A" = ic_a_hvg_kpmp,
    "IC-B" = ic_b_hvg_kpmp,
    "aIC" = aic_hvg_kpmp
  ),
  cell_type_prefix = "IC",
  cell_type_labels = c("IC-A", "IC-B", "aIC"),
  output_prefix = "kpmp_IC_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
```


### EC

#### EC Subtypes

```{r echo = F}
ec_plots <- create_gene_expression_plots(
  main_results = ec_hvg_kpmp,
  subtype_results_list = list(
    "EC-AVR" = ec_avr_hvg_kpmp,
    "EC-GC" = ec_gc_hvg_kpmp,
    "EC-PTC" = ec_ptc_hvg_kpmp,
    "EC-AEA" = ec_aea_hvg_kpmp,
    "EC-LYM" = ec_lym_hvg_kpmp,
    "EC/VSMC" = ec_vsmc_hvg_kpmp
  ),
  cell_type_prefix = "EC",
  cell_type_labels = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  output_prefix = "kpmp_EC_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
```


### FIB/VSMC/P

#### FIBVSMCP Subtypes

```{r echo = F}
vsmc_p_fib_plots <- create_gene_expression_plots(
  main_results = vsmc_p_fib_hvg_kpmp,
  subtype_results_list = list(
    "VSMC/P" = vsmc_p_hvg_kpmp,
    "FIB" = fib_hvg_kpmp
  ),
  cell_type_prefix = "VSMC_P_FIB",
  cell_type_labels = c("VSMC/P", "FIB"),
  output_prefix = "kpmp_VSMC_P_FIB_hvg",
  full_formula = TRUE,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
```

### POD

```{r echo = F}
pod_hvg_plots <- create_gene_expression_plots(
  main_results = pod_hvg_kpmp,
  subtype_results_list = list(
    "POD" = pod_hvg_kpmp),
  cell_type_labels = c("POD"),
  cell_type_prefix = "POD",
  formula = "treatment * visit",
  output_prefix = "kpmp_POD_hvg",
  full_formula = T,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
pod_hvg_plots$combined_plot
```

```{r echo = F}
pod_plots <- create_gene_expression_plots(
  main_results = pod_kpmp,
  subtype_results_list = list(
    "POD" = pod_kpmp),
  cell_type_labels = c("POD"),
  cell_type_prefix = "POD",
  formula = "treatment * visit",
  output_prefix = "kpmp_POD",
  full_formula = T,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
```

## Combined volcano

```{r echo = F}
# plot_volcano(pt_hvg_kpmp, "logFC_treatmentDapagliflozin:visitPOST", 
#              "fdr",
#              "PT (REML & pooled Offset)", 
#              "logFC Treatment(Dapagliflozin):Visit(POST)", 
#              "-log10(FDR adjusted p-value)",
#              "nebula/pt_hvg_kpmp_DiD")

combined_nebula_reml_pooled <- 
  rbind(pt_hvg_kpmp %>%
          mutate(celltype = "PT"), 
        tal_hvg_kpmp %>%
          mutate(celltype = "TAL"),
        pc_hvg_kpmp %>%
          mutate(celltype = "PC"),
        immune_hvg_kpmp %>%
          mutate(celltype = "Immune"),
        immune_myeloid_hvg_kpmp %>%
          filter(`logFC_treatmentDapagliflozin:visitPOST` > -10) %>%
          mutate(celltype = "Immune (Myeloid)"),
        immune_lymphoid_hvg_kpmp %>%
          filter(`logFC_treatmentDapagliflozin:visitPOST` > -10) %>%
          mutate(celltype = "Immune (Lymphoid)"),
        ic_hvg_kpmp %>%
          mutate(celltype = "IC"),
        ec_hvg_kpmp %>%
          mutate(celltype = "EC"),
        vsmc_p_fib_hvg_kpmp %>%
          mutate(celltype = "VSMC_P_FIB"),
        pod_hvg_kpmp %>%
          filter(`logFC_treatmentDapagliflozin:visitPOST` > -10) %>%
          mutate(celltype = "POD")) %>%
  mutate(fdr_cat = case_when(fdr < 0.05 & 
                               `logFC_treatmentDapagliflozin:visitPOST` > 0 ~
                               "Positive & P < 0.05",
                             fdr < 0.05 & 
                               `logFC_treatmentDapagliflozin:visitPOST` < 0 ~
                               "Negative & P < 0.05",
                             T ~ "P > 0.05"))

combined_nebula_reml_pooled$celltype <- factor(combined_nebula_reml_pooled$celltype, 
                                               labels = c("PT", "TAL","EC","IC", "POD", "PC",
                                                                "VSMC/P, FIB", "Immune", 
                                                                "Immune (L)", "Immune (M)"),
                                               levels = c("PT", "TAL","EC","IC", "POD", "PC",
                                                                "VSMC_P_FIB", "Immune", "Immune (Lymphoid)", 
                                                                "Immune (Myeloid)"))

# volcano plot with no label
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_cat)) +
  geom_jitter(alpha = 0.3, size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.ticks.x = element_blank(),
        text = element_text(size = 15),
        plot.margin = margin(0, 0, 0, 0)) +
  labs(x = NULL, 
       y = "DiD") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Cell type comparison/celltype_deg_combined_kpmp.png", width = 5, height = 4, dpi = 600)


# find genes that are significant in more than one celltype
shared_genes <- combined_nebula_reml_pooled %>%
  filter(fdr < 0.05) %>%
  group_by(Gene) %>%
  dplyr::summarise(sig_gene_count = n(), .groups = "drop") %>%
  filter(sig_gene_count > 1) %>%
  arrange(desc(sig_gene_count)) %>%
  pull(Gene)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% shared_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  color = "black",
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in TCA cycle
tca_genes <- c(
  "ACO1", "ACO2", "IDH1", "IDH2", "IDH3A", "IDH3B", "IDH3G", "OGDH", "OGDHL",
  "SUCLA2", "SUCLG1", "SUCLG2", "SDHA", "SDHB", "SDHC", "SDHD", "FH", "MDH1",
  "MDH2", "FAS", "CS"
)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% tca_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in oxphos cycle
oxphos_genes <- c(
  "NDUFS6",  "SDHB", "SDHC", "SDHD",
  "UQCRC1", "UQCRC2", "COX4I1", "COX4I2", "ATP5PF"
)
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% oxphos_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# ggsave(
#   filename = "",
#   width = 4,
#   height = 4,
#   dpi = 300
# )

```

## Number of DEGs

```{r echo = F}
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  IC = c("IC-A", "IC-B", "aIC"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK"),
  Immune_myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_lymphoid = c("CD4+ T", "CD8+ T", "B", "NK"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD"
)
celltype_list <- tolower(names(celltype_groups))
names_hvg_kpmp <- paste0(celltype_list, "_hvg_kpmp")

# Create a named list of data frames
df_list <- mget(names_hvg_kpmp)
names(df_list) <- toupper(celltype_list)  # Set uppercase names for celltype labeling

# Combine and add celltype column
combined <- bind_rows(df_list, .id = "celltype")

# Create the summary table
deg_summary <- combined %>%
  mutate(direction_fdr = case_when(
    `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr < 0.05 ~ "+",
    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr < 0.05 ~ "-",
    TRUE ~ "NS")) %>%
  filter(direction_fdr != "NS") %>%
  dplyr::select(direction_fdr, celltype) %>%
  table() %>%
  as.data.frame()
deg_summary$celltype <- factor(deg_summary$celltype, labels = c("PT", "TAL","EC","IC", "POD", "PC",
                                                                "VSMC/P, FIB", "Immune", 
                                                                "Immune (L)", "Immune (M)"),
                               levels = c("PT", "TAL","EC","IC", "POD", "PC",
                                                                "VSMC_P_FIB", "IMMUNE", 
                                                                "IMMUNE_LYMPHOID", "IMMUNE_MYELOID"))
deg_summary$direction_fdr <- factor(deg_summary$direction_fdr, levels = c("+", "-"))

# Create the summary table
deg_summary_wide <- combined %>%
  mutate(direction_fdr = case_when(
    `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr < 0.05 ~ "+",
    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr < 0.05 ~ "-",
    TRUE ~ "NS")) %>%
  filter(direction_fdr != "NS") %>%
  count(direction_fdr, celltype) %>%
  pivot_wider(names_from = celltype, values_from = n, values_fill = 0) %>%
  as.data.frame()

save(deg_summary_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_comparison_kpmp.RData")

deg_summary %>%
  mutate(Freq = case_when(direction_fdr == "-" ~ -Freq, T ~ Freq)) %>%
  ggplot(aes(x = celltype, y = Freq, fill = direction_fdr)) +
  geom_col(position = "stack") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#343a40") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.ticks.x = element_blank(),
        text = element_text(size = 15),
        legend.position = c(0.8, 0.8),
        plot.margin = margin(0, 0, 0, 0)) +
  scale_fill_manual(values = c("-" = "#457b9d",
                               "+" = "#f28482")) +
  labs(fill = "DiD Direction", 
       x = NULL)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Cell type comparison/celltype_deg_stacked_barplot_kpmp.png",
       width = 5, height = 4, dpi = 600)
```

## Transcript overlap analysis

```{r echo = F}
# upset plot
# combined
upset_combined_dat <- combined %>%
  filter(fdr < 0.05) %>%
  mutate(direction_fdr = case_when(`logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr < 0.05 ~ "+",
                                   `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr < 0.05 ~ "-")) %>%
  dplyr::select(celltype, Gene) %>%
  mutate(present = 1) %>%
  distinct() %>%
  pivot_wider(names_from = celltype, values_from = present, values_fill = 0) %>%
  as.data.frame() %>%
  dplyr::rename(Immune = IMMUNE,
                `VSMC/P, FIB` = VSMC_P_FIB)


vertical_upset(
  upset_combined_dat,
  sets = c("PT", "TAL", "EC", "IC", "POD", "PC", 
           "VSMC/P, FIB", "Immune"),
  show_set_sizes = TRUE,
  connect_lines  = TRUE, 
  min_size = 3,
  bar_fill = "#d5d5d5",
  multi_bar_fill = "#588b8b"
)

ggsave(filename = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Cell type comparison/celltype_deg_upset_kpmp.png",
       width = 5, height = 10, dpi = 600)

```

```{r echo = F}
combined_sig <- combined %>%
  filter(fdr < 0.05) %>%
  dplyr::select(Gene, celltype) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID"))

unique_genes_per_celltype <- combined_sig %>%
  group_by(Gene) %>%
  mutate(n_celltypes = n()) %>%
  ungroup() %>%
  filter(n_celltypes == 1) %>%  # Genes appearing in only one cell type
  count(celltype) %>%
  dplyr::rename(unique_genes = n) %>%
  mutate(unique_genes = unique_genes/2) # duplicates plotted

chord_plot_dat <- combined_sig %>%
  # Self-join to find all celltype pairs for each gene
  inner_join(combined_sig, by = "Gene", suffix = c("_1", "_2"), relationship = "many-to-many") %>%
  # # Remove self-pairs (same celltype)
  filter(celltype_1 != celltype_2) %>%
  # Count shared genes between each celltype pair
  count(celltype_1, celltype_2) %>%
  # Create symmetric matrix
  pivot_wider(names_from = celltype_2, values_from = n, values_fill = 0) %>%
  column_to_rownames("celltype_1") %>%
  as.matrix()
chord_plot_dat <- chord_plot_dat[, rownames(chord_plot_dat)]
# Add unique genes to the diagonal
for(ct in unique_genes_per_celltype$celltype) {
  if(ct %in% rownames(chord_plot_dat)) {
    chord_plot_dat[ct, ct] <- unique_genes_per_celltype$unique_genes[unique_genes_per_celltype$celltype == ct]
  }
}

chord_plot_dat[upper.tri(chord_plot_dat)] <- 0

cell_types <- rownames(chord_plot_dat)
cell_colors <- setNames(c("#f26b21", "#fcec52", "#cbdb47", "#99ca3c", 
                          "#208b3a", "#fbb040", "#f78e31"), cell_types)

# cell_colors <- setNames(c("#1", "#4", "#5", "#6", 
#                           "#7", "#3", "#2"), cell_types)

# Create blended colors for ribbons
col_fun_blend <- function(mat) {
  n <- nrow(mat)
  col_mat <- matrix(NA, n, n)
  for(i in 1:n) {
    for(j in 1:n) {
      if(mat[i,j] > 0) {
        # Blend the two cell type colors
        col1 <- col2rgb(cell_colors[rownames(mat)[i]])
        col2 <- col2rgb(cell_colors[rownames(mat)[j]])
        blended <- rgb((col1[1] + col2[1])/2/255,
                       (col1[2] + col2[2])/2/255,
                       (col1[3] + col2[3])/2/255,
                       alpha = 0.6)
        col_mat[i,j] <- blended
      }
    }
  }
  return(col_mat)
}

chord_colors_blended <- col_fun_blend(chord_plot_dat)


# Create a logical matrix with same dimensions as chord_plot_dat
logical_matrix <- matrix(TRUE, 
                         nrow = nrow(chord_plot_dat), 
                         ncol = ncol(chord_plot_dat),
                         dimnames = list(rownames(chord_plot_dat), 
                                         colnames(chord_plot_dat)))

# Set diagonal to FALSE
diag(logical_matrix) <- FALSE

# Open PNG device
png("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Proportions/celltype_deg_chordplot.png", width = 800, height = 800, res = 150)

# Your plotting code
circos.clear()
chordDiagram(chord_plot_dat, transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T)

# Close the device
dev.off()
circos.clear()
```

```{r echo = F}
# Create set sizes data frame
set_sizes_df <- combined_sig %>%
  count(celltype) %>%
  filter(celltype %in% cell_types) %>%
  arrange(match(celltype, cell_types))

# Initialize the plot
circos.clear()
circos.par("track.height" = 0.1, 
           "gap.after" = rep(3, length(cell_types)),
           "start.degree" = 90)

# par(
#   family = "Outfit", cex = 2, col = "black", # font family, size, color
#   mai = rep(0.5, 4) # plot margin in inches
# ) 

# Create chord diagram
chordDiagram(chord_plot_dat, 
             transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T,
             link.border = "black", link.lwd = 0.2,
             preAllocateTracks = list(track.height = 0.001)
)

# Add barplot track
circos.track(ylim = c(0, max(set_sizes_df$n) * 1.1),
             bg.border = NA,
             track.height = 0.2,
             panel.fun = function(x, y) {
               sector.index = get.cell.meta.data("sector.index")
               xlim = get.cell.meta.data("xlim")
               
               # Get the value for this sector
               value = set_sizes_df$n[set_sizes_df$celltype == sector.index]
               
               # Draw rectangle (bar)
               circos.rect(xlim[1], 0, xlim[2], value,
                           col = cell_colors[sector.index],
                           border = cell_colors[sector.index])
               
               # Add text label
               circos.text(mean(xlim), value + max(set_sizes_df$n) * 0.02,
                           labels = value,
                           sector.index = sector.index,
                           facing = "inside",
                           niceFacing = TRUE,
                           cex = 1,
                           adj = c(0.5, 0))
             })

# Add y-axis for the barplot
circos.yaxis(side = "left", 
             sector.index = cell_types[1],
             labels.cex = 0.5,
             at = pretty(c(0, max(set_sizes_df$n)), n = 3))

circos.clear()
```

```{r echo = F}
upset_combined_df %>%
  arrange(desc(lengths(celltype)))

combined_wide <- combined %>%
  filter(fdr < 0.05) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID")) %>%
  mutate(logFC_direction = case_when(`logFC_treatmentDapagliflozin:visitPOST` < 0 ~ "-",
                                     `logFC_treatmentDapagliflozin:visitPOST` > 0 ~ "+")) %>%
  dplyr::select(Gene, celltype, logFC_direction) %>%
  pivot_wider(
    names_from = celltype,
    values_from = logFC_direction,
    values_fn = list(direction = identity)) %>%
  rowwise() %>%
  dplyr::mutate(n_pos = sum(c_across(PT:FIBVSMCP) == "+", na.rm = TRUE),
                n_neg = sum(c_across(PT:FIBVSMCP) == "-", na.rm = TRUE),
                n_total = sum(!is.na(c_across(PT:FIBVSMCP)))) %>%
  ungroup() %>%
  arrange(desc(n_total))

save(combined_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_concordance.RData")


gene_list_4 <- combined_wide %>%
  filter(n_total >= 4) %>%
  pull(Gene)

save(gene_list_4, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/gene_list_greater_than_3.RData")

```

## Investigate outlier

```{r echo = F}
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` > 10)

# immune cell: TRHDE-AS1
# immune cell: FGF14
# fib/vsmc/p: PSAT1
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

```{r echo = F}
# read in all the results by looping through cell types
names(celltype_groups)

for (cell in names(celltype_groups)){
  ipa_res <- read_excel(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/kpmp/nebula/full ", tolower(cell), "_kpmp_DiD.xls"), skip = 1)
  colnames(ipa_res) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
  var_name = paste0(tolower(cell), "_kpmp_ipa")
  assign(var_name, ipa_res, envir = .GlobalEnv)
}
```

### PT

```{r echo = F}
library(ggbreak)
pt_kpmp_ipa_top <- pt_kpmp_ipa %>%
  arrange(desc(neg_log_p)) %>%
  filter(!is.na(z)) %>%
  head(20) %>%
  mutate(pathway_wrapped = sapply(pathway, function(x) {
    # Find all space positions
    space_positions <- gregexpr(" ", x)[[1]]
    
    # If less than 3 spaces, return original
    if(length(space_positions) < 3 || space_positions[1] == -1) return(x)
    
    # Convert to character vector
    chars <- strsplit(x, "")[[1]]
    
    # Replace every 3rd space with newline
    space_count <- 0
    for(i in 1:length(chars)) {
      if(chars[i] == " ") {
        space_count <- space_count + 1
        if(space_count %% 4 == 0) {
          chars[i] <- "\n"
        }
      }
    }
    
    # Rejoin characters
    paste(chars, collapse = "")
  }))
pt_kpmp_ipa_top$pathway_wrapped <- factor(pt_kpmp_ipa_top$pathway_wrapped, 
                                          levels = (pt_kpmp_ipa_top$pathway_wrapped))
pt_kpmp_ipa_top$pathway <- factor(pt_kpmp_ipa_top$pathway, 
                                          levels = (pt_kpmp_ipa_top$pathway))
break_point <- min(pt_kpmp_ipa_top$neg_log_p) - 0.2
pt_kpmp_ipa_top %>%
  ggplot(aes(y = pathway, x = z, fill = z)) +
  geom_col(width = 0.5) + 
  geom_text(label = pt_kpmp_ipa_top$pathway, 
            x = 0,
            # hjust = ifelse(pt_kpmp_ipa_top$z < 0, -0.05, 1.05),
            # color = ifelse(pt_kpmp_ipa_top$z < 0, "#89c2d9", "#ee7674")
            ) +
  scale_fill_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(), legend.position = "top",
        axis.text.y = element_blank())  +
  labs(y = NULL, x = "-log(p-value)", fill = "Z-score") +
  scale_x_continuous(
    expand = expansion(mult = c(0.5, 0.5)))
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/kpmp/full_pt_ipa.png")

# pt_kpmp_ipa_top %>%
#   ggplot(aes(x = pathway, y = neg_log_p, fill = z)) +
#   geom_col_rounded(width = 0.5) + 
#   geom_text_repel(label = (pt_kpmp_ipa_top$pathway),
#             nudge_y = seq(from = 20, to = 5, length.out = nrow(pt_kpmp_ipa_top)),
#             force = 10,
#             xlim = c(-Inf, Inf),
#             direction = "y",
#             vjust = "outward",
#             max.overlaps = Inf,
#             color = ifelse(pt_kpmp_ipa_top$z<0, 
#                                    fill_alpha("#1E5A8A", 1), fill_alpha("#CC4C4A", 1)),
#             segment.color = ifelse(pt_kpmp_ipa_top$z<0, 
#                                    fill_alpha("#89c2d9", 0.2), fill_alpha("#ee7674", 0.2))) +
#   scale_fill_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
#   theme_minimal() +
#   theme(panel.grid = element_blank(), legend.position = "bottom",
#         axis.text.x = element_blank(),
#         text = element_text(size = 15, family = "Arial"))  +
#   scale_x_discrete(
#     expand = expansion(mult = c(0.5, 0.5)))  +
#     scale_y_continuous(
#     expand = expansion(mult = c(0, 0.2)))  +
#   labs(x = NULL, y = "-log(p-value)", fill = "Z-score")
# ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/kpmp/full_pt_ipa.png")

```

```{r echo = F}
pt_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_DiD_pathways_nebula.xls", skip = 1)
pt_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_dapa_pathways_nebula.xls", skip = 1)
pt_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_placebo_pathways_nebula.xls", skip = 1)

colnames(pt_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_nebula <- pt_pathways_nebula %>%
  full_join(pt_dapa_nebula) %>% full_join(pt_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_nebula$scenario <- factor(pt_pathways_merged_nebula$scenario,
                                             levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                        "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                        "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                        "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways

```{r echo = F}
pt_pathways_inhibited_nebula <- pt_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_nebula$pathway <- reorder(pt_pathways_inhibited_nebula$pathway, pt_pathways_inhibited_nebula$neg_log_p)

pt_top30_inhibited_nebula <- pt_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_nebula <- pt_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_nebula$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_nebula))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_nebula + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_nebula <- pt_pathways_inhibited_nebula %>%
  filter(z <= -2)
pt_top30_inhibited_2_nebula <- pt_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_nebula$z), max(-pt_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) 

## top30_inhibited_nebula + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_nebula <- pt_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_nebula$pathway <- reorder(pt_pathways_activated_nebula$pathway, pt_pathways_activated_nebula$neg_log_p)

pt_top30_activated_nebula <- pt_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_nebula <- pt_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_nebula <- pt_pathways_activated_nebula %>%
  filter(z > 2)
pt_top30_activated_2_nebula <- pt_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_nebula$z), max(pt_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_nebula$name <- factor(pt_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

pt_pos_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_nebula$name <- factor(pt_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_nebula
pt_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_DiD_pathways_nebula.xls", skip = 1)
tal_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_dapa_pathways_nebula.xls", skip = 1)
tal_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_placebo_pathways_nebula.xls", skip = 1)

colnames(tal_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_nebula <- tal_pathways_nebula %>%
  full_join(tal_dapa_nebula) %>% full_join(tal_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_nebula$scenario <- factor(tal_pathways_merged_nebula$scenario,
                                              levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                         "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                         "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                         "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_nebula <- tal_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_nebula$pathway <- reorder(tal_pathways_inhibited_nebula$pathway, tal_pathways_inhibited_nebula$neg_log_p)

tal_top30_inhibited_nebula <- tal_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_nebula <- tal_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_nebula <- tal_pathways_inhibited_nebula %>%
  filter(z < -2)
tal_top30_inhibited_2_nebula <- tal_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_nebula$z), max(-tal_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_nebula <- tal_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_nebula$pathway <- reorder(tal_pathways_activated_nebula$pathway, tal_pathways_activated_nebula$neg_log_p)

tal_top30_activated_nebula <- tal_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 2.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_nebula <- tal_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_nebula <- tal_pathways_activated_nebula %>%
  filter(z > 2)
tal_top30_activated_2_nebula <- tal_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_nebula$z), max(tal_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_nebula$name <- factor(tal_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

tal_pos_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_nebula$name <- factor(tal_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_nebula
tal_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_DiD_pathways_nebula.xls", skip = 1)
pc_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_dapa_pathways_nebula.xls", skip = 1)
pc_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_placebo_pathways_nebula.xls", skip = 1)

colnames(pc_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_nebula <- pc_pathways_nebula %>%
  full_join(pc_dapa_nebula) %>% full_join(pc_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_nebula$scenario <- factor(pc_pathways_merged_nebula$scenario,
                                             levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                        "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                        "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                        "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_nebula <- pc_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_nebula$pathway <- reorder(pc_pathways_inhibited_nebula$pathway, pc_pathways_inhibited_nebula$neg_log_p)

pc_top30_inhibited_nebula <- pc_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_nebula <- pc_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_nebula <- pc_pathways_inhibited_nebula %>%
  filter(z < -2)
pc_top30_inhibited_2_nebula <- pc_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_nebula$z), max(-pc_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_nebula <- pc_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_nebula$pathway <- reorder(pc_pathways_activated_nebula$pathway, pc_pathways_activated_nebula$neg_log_p)

pc_top30_activated_nebula <- pc_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_nebula <- pc_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_nebula <- pc_pathways_activated_nebula %>%
  filter(z > 2)
pc_top30_activated_2_nebula <- pc_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_nebula$z), max(pc_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_nebula$name <- factor(pc_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

pc_pos_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_nebula$name <- factor(pc_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_nebula
pc_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_DiD_pathways_nebula.xls", skip = 1)
immune_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_dapa_pathways_nebula.xls", skip = 1)
immune_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_placebo_pathways_nebula.xls", skip = 1)

colnames(immune_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_nebula <- immune_pathways_nebula %>%
  full_join(immune_dapa_nebula) %>% full_join(immune_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_nebula$scenario <- factor(immune_pathways_merged_nebula$scenario,
                                                 levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                            "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                            "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                            "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_nebula <- immune_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_nebula$pathway <- reorder(immune_pathways_inhibited_nebula$pathway, immune_pathways_inhibited_nebula$neg_log_p)

immune_top30_inhibited_nebula <- immune_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_nebula <- immune_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_nebula <- immune_pathways_inhibited_nebula %>%
  filter(z < -2)
immune_top30_inhibited_2_nebula <- immune_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_nebula$z), max(-immune_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_nebula <- immune_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_nebula$pathway <- reorder(immune_pathways_activated_nebula$pathway, immune_pathways_activated_nebula$neg_log_p)

immune_top30_activated_nebula <- immune_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_nebula <- immune_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_nebula <- immune_pathways_activated_nebula %>%
  filter(z > 2)
immune_top30_activated_2_nebula <- immune_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_nebula$z), max(immune_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_nebula$name <- factor(immune_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

immune_pos_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_nebula$name <- factor(immune_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_nebula
immune_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_DiD_pathways_nebula.xls", skip = 1)
ic_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_dapa_pathways_nebula.xls", skip = 1)
ic_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_placebo_pathways_nebula.xls", skip = 1)

colnames(ic_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_nebula <- ic_pathways_nebula %>%
  full_join(ic_dapa_nebula) %>% full_join(ic_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_nebula$scenario <- factor(ic_pathways_merged_nebula$scenario,
                                             levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                        "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                        "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                        "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_nebula <- ic_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_nebula$pathway <- reorder(ic_pathways_inhibited_nebula$pathway, ic_pathways_inhibited_nebula$neg_log_p)

ic_top30_inhibited_nebula <- ic_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_nebula <- ic_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_nebula <- ic_pathways_inhibited_nebula %>%
  filter(z < -2)
ic_top30_inhibited_2_nebula <- ic_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_nebula$z), max(-ic_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_nebula <- ic_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_nebula$pathway <- reorder(ic_pathways_activated_nebula$pathway, ic_pathways_activated_nebula$neg_log_p)

ic_top30_activated_nebula <- ic_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_nebula <- ic_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_nebula <- ic_pathways_activated_nebula %>%
  filter(z > 2)
ic_top30_activated_2_nebula <- ic_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_nebula$z), max(ic_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_nebula$name <- factor(ic_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

ic_pos_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_nebula$name <- factor(ic_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_nebula
ic_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_DiD_pathways_nebula.xls", skip = 1)
ec_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_dapa_pathways_nebula.xls", skip = 1)
ec_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_placebo_pathways_nebula.xls", skip = 1)

colnames(ec_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_nebula <- ec_pathways_nebula %>%
  full_join(ec_dapa_nebula) %>% full_join(ec_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_nebula$scenario <- factor(ec_pathways_merged_nebula$scenario,
                                             levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                        "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                        "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                        "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_nebula <- ec_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_nebula$pathway <- reorder(ec_pathways_inhibited_nebula$pathway, ec_pathways_inhibited_nebula$neg_log_p)

ec_top30_inhibited_nebula <- ec_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_nebula <- ec_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_nebula <- ec_pathways_inhibited_nebula %>%
  filter(z < -2)
ec_top30_inhibited_2_nebula <- ec_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_nebula$z), max(-ec_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_nebula <- ec_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_nebula$pathway <- reorder(ec_pathways_activated_nebula$pathway, ec_pathways_activated_nebula$neg_log_p)

ec_top30_activated_nebula <- ec_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_nebula <- ec_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_nebula <- ec_pathways_activated_nebula %>%
  filter(z > 2)
ec_top30_activated_2_nebula <- ec_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_nebula$z), max(ec_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_nebula$name <- factor(ec_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

ec_pos_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_nebula$name <- factor(ec_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_nebula
ec_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_DiD_pathways_nebula.xls", skip = 1)
dtl_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_dapa_pathways_nebula.xls", skip = 1)
dtl_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_placebo_pathways_nebula.xls", skip = 1)

colnames(dtl_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_nebula <- dtl_pathways_nebula %>%
  full_join(dtl_dapa_nebula) %>% full_join(dtl_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_nebula$scenario <- factor(dtl_pathways_merged_nebula$scenario,
                                              levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                         "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                         "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                         "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_nebula <- dtl_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_nebula$pathway <- reorder(dtl_pathways_inhibited_nebula$pathway, dtl_pathways_inhibited_nebula$neg_log_p)

dtl_top30_inhibited_nebula <- dtl_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_nebula <- dtl_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_nebula <- dtl_pathways_inhibited_nebula %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_nebula <- dtl_pathways_inhibited_sig_nebula[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_nebula$z), max(-dtl_pathways_inhibited_sig_nebula$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_inhibited_pathways_2_kpmp.png",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_nebula <- dtl_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_nebula$pathway <- reorder(dtl_pathways_activated_nebula$pathway, dtl_pathways_activated_nebula$neg_log_p)

dtl_top30_activated_nebula <- dtl_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_nebula <- dtl_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_nebula <- dtl_pathways_activated_nebula %>%
  filter(z > 2)
dtl_top30_activated_2_nebula <- dtl_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_nebula$z), max(dtl_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_nebula$name <- factor(dtl_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

dtl_pos_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_nebula$name <- factor(dtl_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_nebula
dtl_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
vsmc_p_fib_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/vsmc_p_fib_DiD_pathways_nebula.xls", skip = 1)
vsmc_p_fib_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/vsmc_p_fib_dapa_pathways_nebula.xls", skip = 1)
vsmc_p_fib_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/vsmc_p_fib_placebo_pathways_nebula.xls", skip = 1)

colnames(vsmc_p_fib_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(vsmc_p_fib_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(vsmc_p_fib_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

vsmc_p_fib_pathways_merged_nebula <- vsmc_p_fib_pathways_nebula %>%
  full_join(vsmc_p_fib_dapa_nebula) %>% full_join(vsmc_p_fib_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

vsmc_p_fib_pathways_merged_nebula$scenario <- factor(vsmc_p_fib_pathways_merged_nebula$scenario,
                                                   levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                              "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                              "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                              "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
vsmc_p_fib_pathways_inhibited_nebula <- vsmc_p_fib_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

vsmc_p_fib_pathways_inhibited_nebula$pathway <- reorder(vsmc_p_fib_pathways_inhibited_nebula$pathway, vsmc_p_fib_pathways_inhibited_nebula$neg_log_p)

vsmc_p_fib_top30_inhibited_nebula <- vsmc_p_fib_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_vsmc_p_fib_pathways_inhibited_nebula <- vsmc_p_fib_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_top30_inhibited_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
vsmc_p_fib_pathways_inhibited_sig_nebula <- vsmc_p_fib_pathways_inhibited_nebula %>%
  filter(z < -2)
vsmc_p_fib_top30_inhibited_2_nebula <- vsmc_p_fib_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-vsmc_p_fib_pathways_inhibited_sig_nebula$z), max(-vsmc_p_fib_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_top_inhibited_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
vsmc_p_fib_pathways_activated_nebula <- vsmc_p_fib_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

vsmc_p_fib_pathways_activated_nebula$pathway <- reorder(vsmc_p_fib_pathways_activated_nebula$pathway, vsmc_p_fib_pathways_activated_nebula$neg_log_p)

vsmc_p_fib_top30_activated_nebula <- vsmc_p_fib_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_vsmc_p_fib_pathways_activated_nebula <- vsmc_p_fib_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_top30_activated_pathways_nebula_kpmp.png",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
vsmc_p_fib_pathways_activated_sig_nebula <- vsmc_p_fib_pathways_activated_nebula %>%
  filter(z > 2)
vsmc_p_fib_top30_activated_2_nebula <- vsmc_p_fib_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(vsmc_p_fib_pathways_activated_sig_nebula$z), max(vsmc_p_fib_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_top_activated_pathways_2_kpmp.png",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
vsmc_p_fib_neg_pathways_merged_long_nebula <- vsmc_p_fib_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
vsmc_p_fib_neg_pathways_merged_long_nebula$name <- factor(vsmc_p_fib_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

vsmc_p_fib_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/vsmc_p_fib_top10_inhibited_pathway_zscores_kpmp.png",
       scale = 1.5)

vsmc_p_fib_pos_pathways_merged_long_nebula <- vsmc_p_fib_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
vsmc_p_fib_pos_pathways_merged_long_nebula$name <- factor(vsmc_p_fib_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

vsmc_p_fib_pos_pathways_merged_long_nebula
vsmc_p_fib_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
       x = NULL,
       fill = "Treatment",
       title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/vsmc_p_fib_top10_activated_pathway_zscores_kpmp.png",
       scale = 1.5)
```


# Model comparison

* Model 1: Nested visit, zero inflation

* Model 2: No nested visit, zero inflation

```{r echo = F}
## PT
pt_nc <- c(pt_nonconverged_percentage_mod1,
           pt_nonconverged_percentage_mod2)
```


```{r echo = F}
## TAL
tal_nc <- c(tal_nonconverged_percentage_mod1,
            tal_nonconverged_percentage_mod2)
```

```{r echo = F}
## PC
pc_nc <- c(pc_nonconverged_percentage_mod1,
           pc_nonconverged_percentage_mod2)
```

```{r echo = F}
## Immune
immune_nc <- c(immune_nonconverged_percentage_mod1,
               immune_nonconverged_percentage_mod2)
```

```{r echo = F}
## IC
ic_nc <- c(ic_nonconverged_percentage_mod1,
           ic_nonconverged_percentage_mod2)

```

```{r echo = F}
## EC
ec_nc <- c(ec_nonconverged_percentage_mod1,
           ec_nonconverged_percentage_mod2)
```

```{r echo = F}
## FIB/VSMC/P
vsmc_p_fib_nc <- c(vsmc_p_fib_nonconverged_percentage_mod1,
                 vsmc_p_fib_nonconverged_percentage_mod2)
```


```{r echo = F}
mods <- c("Model 1 (Nested Visit, ZINB)",
          "Model 2 (No nested visit, ZINB)")
mods_df <- data.frame(mods, pt_nc, tal_nc, pc_nc, immune_nc, ic_nc, ec_nc, vsmc_p_fib_nc)
colnames(mods_df) <- c("Model", "PT", "TAL", "PC", "Immune", "IC", "EC", "FIB, VSMC/P")
kable(mods_df, digits = 2)
```

```{r echo = F}
prefixes <- c("pt", "tal", "pc", "ic", "ec", "vsmc_p_fib", "immune")
mods <- paste0("mod", 1:2)

base_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/"

for (prefix in prefixes) {
  for (mod in mods) {
    obj_name <- paste0(prefix, "_nonconverged_genes_", mod)
    save_path <- file.path(base_path, paste0(obj_name, "_zi.rds"))
    saveRDS(get(obj_name), file = save_path)
  }
}
```

```{r echo = F}
sheet_list <- list()  # Store all data frames here
mods <- paste0("mod", 1:2)
for (prefix in prefixes) {
  for (mod in mods) {
    # Construct the name of the data frame (e.g., pt_emmeans_diff_DiD_mod1)
    df_name <- paste0(prefix, "_emmeans_diff_DiD_", mod)
    
    # Check if the data frame exists
    if (exists(df_name)) {
      df <- get(df_name)
      
      # Positive top 20
      pos_top20 <- df %>%
        arrange(`Expr p-value`) %>%
        filter(`Expr Other` > 0) %>%
        head(20)
      
      sheet_name_pos <- paste0(toupper(prefix), "_", mod, "_POS_Top20")
      sheet_list[[sheet_name_pos]] <- pos_top20
      
      # Negative top 20
      neg_top20 <- df %>%
        arrange((`Expr p-value`)) %>%
        filter(`Expr Other` < 0) %>%
        head(20)
      
      sheet_name_neg <- paste0(toupper(prefix), "_", mod, "_NEG_Top20")
      sheet_list[[sheet_name_neg]] <- neg_top20
    }
  }
}

# Write all to an Excel file
library(writexl)

write_xlsx(sheet_list, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/DiD_Top20_By_CellType_Mod_zi.xlsx")
```


# Non-intuitive transcripts

```{r echo = F}
vars <- c("mgfr_jodal", "mgfr_jodal_bsa", "hba1c", "weight")
celltype_list <- c("pt", "tal", "pc", "ic", "vsmc_p_fib")

# Create fallback mapping
var_fallback_map <- list(
  "mgfr_jodal" = c("gfr_raw_plasma", "mgfr_jodal"),
  "mgfr_jodal_bsa" = c("gfr_bsa_plasma", "mgfr_jodal_bsa"),
  "hba1c" = c("hba1c"),
  "weight" = c("weight")
)

# Create an empty list to store results
croc_res_select_vars <- list()

# Loop through combinations
for (ct in celltype_list) {
  for (v in vars) {
    # Get list of variable names to try
    vars_to_try <- var_fallback_map[[v]]
    
    # Construct S3 path
    s3_path <- paste0("/associations/nebula/", v, "/croc_", ct, "_", v, "_select_transcripts.rds")
    
    # Try each variable name until one works
    success <- FALSE
    for (var_name in vars_to_try) {
      
      message("Trying to read: ", s3_path)
      result <- tryCatch({
        rds_obj <- s3readRDS(s3_path, bucket = "attempt", region = "")
        
        # Process results
        processed <- process_nebula_results(rds_obj, pval_col = paste0("p_", var_name))$results
        
        # Select and rename columns to standardize them
        processed <- processed %>%
          dplyr::select(
            logFC = matches(paste0("logFC_", var_name)),
            p_value = matches(paste0("p_", var_name)),
            fdr,
            Gene,
            gene_id,
            gene
          )
        
        # Add cell type and variable columns
        processed$cell_type <- ct
        processed$variable <- v
        
        # Store in list with descriptive name
        name <- paste(ct, v, sep = "_")
        croc_res_select_vars[[name]] <- processed
        
        success <- TRUE
        message("Successfully read: ", s3_path)
        "success"
        
      }, warning = function(w) {
        message("Warning encountered: ", w$message)
        message("Trying alternative variable name...")
        "warning"
      }, error = function(e) {
        message("Error encountered: ", e$message)
        message("Trying alternative variable name...")
        "error"
      })
      
      if (result == "success") {
        break
      }
    }
    
    if (!success) {
      message(paste("Could not read data for cell type:", ct, "and variable:", v))
    }
  }
}

# Combine all dataframes into one
combined_df <- do.call(rbind, croc_res_select_vars)
rownames(combined_df) <- NULL

combined_df

croc_res_select_vars$tal_mgfr_jodal

# heatmap

# combined_df %>%
#   filter(variable == "mgfr_jodal") %>%
#   ggplot(aes(x = Gene, y = toupper(cell_type), fill = logFC)) +
#   geom_tile()
# 
# combined_df %>%
#   filter(variable == "hba1c") %>%
#   ggplot(aes(x = Gene, y = toupper(cell_type), fill = logFC)) +
#   geom_tile()


```

```{r echo = F}
# ATTEMPT BL

vars <- c("mgfr_jodal", "mgfr_jodal_bsa", "hba1c", "weight")
celltype_list <- c("pt", "tal", "pc", "ic", "vsmc_p_fib")

# Create fallback mapping
var_fallback_map <- list(
  "mgfr_jodal" = c("gfr_raw_plasma", "mgfr_jodal"),
  "mgfr_jodal_bsa" = c("gfr_bsa_plasma", "mgfr_jodal_bsa"),
  "hba1c" = c("hba1c"),
  "weight" = c("weight")
)

# Create an empty list to store results
attempt_res_select_vars <- list()

# Loop through combinations
for (ct in celltype_list) {
  for (v in vars) {
    # Get list of variable names to try
    vars_to_try <- var_fallback_map[[v]]
    
    # Construct S3 path
    s3_path <- paste0("/associations/nebula/", v, "/attempt_", ct, "_", v, "_select_transcripts.rds")
    
    # Try each variable name until one works
    success <- FALSE
    for (var_name in vars_to_try) {
      
      message("Trying to read: ", s3_path)
      result <- tryCatch({
        rds_obj <- s3readRDS(s3_path, bucket = "attempt", region = "")
        
        # Process results
        processed <- process_nebula_results(rds_obj, pval_col = paste0("p_", var_name))$results
        
        # Select and rename columns to standardize them
        processed <- processed %>%
          dplyr::select(
            logFC = matches(paste0("logFC_", var_name)),
            p_value = matches(paste0("p_", var_name)),
            fdr,
            Gene,
            gene_id,
            gene
          )
        
        # Add cell type and variable columns
        processed$cell_type <- ct
        processed$variable <- v
        
        # Store in list with descriptive name
        name <- paste(ct, v, sep = "_")
        attempt_res_select_vars[[name]] <- processed
        
        success <- TRUE
        message("Successfully read: ", s3_path)
        "success"
        
      }, warning = function(w) {
        message("Warning encountered: ", w$message)
        message("Trying alternative variable name...")
        "warning"
      }, error = function(e) {
        message("Error encountered: ", e$message)
        message("Trying alternative variable name...")
        "error"
      })
      
      if (result == "success") {
        break
      }
    }
    
    if (!success) {
      message(paste("Could not read data for cell type:", ct, "and variable:", v))
    }
  }
}

# Combine all dataframes into one
combined_df <- do.call(rbind, attempt_res_select_vars)
rownames(combined_df) <- NULL

combined_df

attempt_res_select_vars$tal_mgfr_jodal

# heatmap

combined_df %>%
  filter(variable == "mgfr_jodal") %>%
  ggplot(aes(x = Gene, y = toupper(cell_type), fill = logFC)) +
  geom_tile()

combined_df %>%
  filter(variable == "hba1c") %>%
  ggplot(aes(x = Gene, y = toupper(cell_type), fill = logFC)) +
  geom_tile() +
  scale_fill_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(legend.title.position = "top",
        legend.title = element_text(hjust = 0.5, size = 10),
        legend.position = "top",
        panel.grid = element_blank(),
        text = element_text(size = 15),
        legend.text = element_text(size = 10),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
  labs(x = NULL, y = NULL)


```