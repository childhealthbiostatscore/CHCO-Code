---
title: "ATTEMPT scRNA (KPMP cell types) correlations visualization"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r echo = F, include = F}
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
library(jsonlite)
library(aws.s3)
library(fgsea)
library(reshape2)
library(simplifyEnrichment)
library(ggarchery)
```

* mediation framework


```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)

source("~/GitHub/CHCO-Code/Petter Bjornstad/ATTEMPT/attempt_functions.R")
```

# Define clinical directions
```{r echo = F}
clinical_directions <- data.frame(variable = c("mgfr_jodal", "mgfr_jodal_bsa", "tir", "hba1c", "weight", "avg_c_r2", "avg_k_r2", "avg_ketones"),
                                  direction = c("-", "-", "+", "-", "-", "+","+", "+"))

```

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT

celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  IC = c("IC-A", "IC-B", "aIC"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK"),
  Immune_myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_lymphoid = c("CD4+ T", "CD8+ T", "B", "NK"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD"
)

## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT
# mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl") # to join full name description

# Top 2000 HVG
for (cell in names(celltype_groups))  {
  print(paste0("Processing: ", cell))
  input_path <- paste0("grouped/", cell, "/HVG/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  # Get gene symbols
  gene_symbols <- processed$results$Gene
  
  # Query Ensembl
  # gene_info <- getBM(
  #   attributes = c("hgnc_symbol", "description", "gene_biotype"),
  #   filters = "hgnc_symbol",
  #   values = gene_symbols,
  #   mart = mart
  # ) %>%
  #   dplyr::rename(Gene = hgnc_symbol)
  
  # Join annotation
  annotated_df <- processed$results 
  # %>%
  #   left_join(gene_info, by = "Gene")

  # Assign to variable dynamically
  var_name <- paste0(tolower(cell), "_hvg_kpmp")
  assign(var_name, annotated_df, envir = .GlobalEnv)
}

# Top 2000 HVG subtypes
for (cell in unlist(celltype_groups))  {
  print(paste0("Processing: ", cell))
  cell <- gsub("/", "_", cell)
  input_path <- paste0("individual/", cell, "/HVG/nebula/individual_", 
                       tolower(cell),
                       "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")
  
  processed <- process_nebula_results(cell_df)
  
  # # Get gene symbols
  # gene_symbols <- processed$results$Gene
  # 
  # # Query Ensembl
  # gene_info <- getBM(
  #   attributes = c("hgnc_symbol", "description", "gene_biotype"),
  #   filters = "hgnc_symbol",
  #   values = gene_symbols,
  #   mart = mart
  # ) %>%
  #   dplyr::rename(Gene = hgnc_symbol)
  # 
  # # Join annotation
  # annotated_df <- processed$results %>%
  #   left_join(gene_info, by = "Gene")

  cell <- gsub("-", "_", cell)
  cell <- gsub("\\+\\s", "_", cell)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_hvg_kpmp")
  print(var_name)
  assign(var_name, processed$results)
  # write.csv(processed$results, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/",tolower(cell),"_kpmp_hvg_res.csv"), row.names = F)
}

# # Full gene set
# for (cell in names(celltype_groups))  {
# print(paste0("Processing: ", cell))
#   input_path <- paste0("kpmp_grouped/", cell, "/ALL/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
#   cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")
#   
#   processed <- process_nebula_results(cell_df)
#   lower_cell <- tolower(cell)
#   var_name <- paste0(lower_cell, "_kpmp")
#   
#   assign(var_name, processed$results)
# }

# # Full gene set subtypes
# for (cell in names(celltype_groups))  {
# print(paste0("Processing: ", cell))
#   input_path <- paste0("kpmp_individual/", cell, "/ALL/nebula/kpmp_individual_", 
#                        tolower(cell),
#                        "_kpmp_attempt_nebula_res_reml_pooled.rds")
#   cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")
#   
#   processed <- process_nebula_results(cell_df)
#   cell <- gsub("-", "_", cell)
#   lower_cell <- tolower(cell)
#   var_name <- paste0(lower_cell, "_kpmp")
#   
#   assign(var_name, processed$results)
# }
```

```{r echo = F}
celltype_groups <- list(
  # PT = c("PT-S1/S2", "PT-S3", "aPT"),
  # TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  # PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  # EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  # IC = c("IC-A", "IC-B", "aIC"),
  # Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK"),
  # Immune_myeloid = c("MAC", "MON", "cDC", "pDC"),
  # Immune_lymphoid = c("CD4+ T", "CD8+", "T", "B", "NK"),
  # VSMC_P_FIB = c("VSMC/P", "FIB"),
  # POD = "POD",
  EC_GC = "EC-GC"
)

clin_vars <- c("mgfr_jodal_delta", "mgfr_jodal_bsa_delta", "tir_delta", 
               "hba1c_delta", "weight_delta", "avg_c_r2_delta", "avg_k_r2_delta",
               "avg_ketones_delta")

## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT
# mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl") # to join full name description

# Top 2000 HVG
for (cell in names(celltype_groups))  {
  for(var in clin_vars) {
    print(paste0("Processing: ", cell, " - ", var))
    processed <- process_nebula_results_clin(cell_type = cell, clinical_var = var, 
                                             cell_subtype = celltype_groups[[cell]])
    # Get gene symbols
    # gene_symbols <- processed$results$Gene
    # 
    # # Query Ensembl
    # gene_info <- getBM(
    #   attributes = c("hgnc_symbol", "description", "gene_biotype"),
    #   filters = "hgnc_symbol",
    #   values = gene_symbols,
    #   mart = mart
    # ) %>%
    #   dplyr::rename(Gene = hgnc_symbol)
    
    # Join annotation
    annotated_df <- processed$results 
    # %>%
    #   left_join(gene_info, by = "Gene")
    
    # Assign to variable dynamically
    var_name <- paste0(tolower(cell), "_", var, "_hvg_kpmp")
    assign(var_name, annotated_df, envir = .GlobalEnv)
  }
}
```

# PT

```{r echo = F}
plot_volcano_concordance(pt_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "PT",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```


```{r echo = F}
plot_volcano_associations(pt_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "PT Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")

plot_volcano_associations(pt_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "PT Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_trtcolors_logfc0.3",
                          treatment_results = subset(pt_hvg_kpmp,
                                                     abs(`logFC_treatmentDapagliflozin:visitPOST`) > 0.3),
                          treatment_p_col = "fdr",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```


```{r echo =F, eval = F}
plot_volcano(pt_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL, 
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_pt_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")

plot_volcano(pt_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL, 
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_mgfr_jodal_fdr_kpmp",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")
```

```{r echo = F}
plot_volcano_concordance(pt_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "PT",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_mgfr_jodal <- pt_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_pt_mgfr_jodal) <- pt_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_pt_mgfr_jodal <- sort(rankings_pt_mgfr_jodal, decreasing = TRUE)
plot(rankings_pt_mgfr_jodal)
min(rankings_pt_mgfr_jodal)
max(rankings_pt_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_pt_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_pt_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_pt_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_pt_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_mgfr_jodal_filtered, title = "PT Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_pt_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_mgfr_jodal_filtered, title = "PT Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_pt_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_mgfr_jodal, title = "PT Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(pt_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "PT \u0394 BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_bsa_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")

plot_volcano_associations(pt_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "PT \u0394 BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_mgfr_jodal_bsa_trtcolors_logfc0.3",
                          treatment_results = subset(pt_hvg_kpmp, 
                                                     abs(`logFC_treatmentDapagliflozin:visitPOST`) > 0.3),
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(pt_mgfr_jodal_bsa_delta_hvg_kpmp, 
                         "logFC_mgfr_jodal_bsa_delta", 
                         "p_mgfr_jodal_bsa_delta",
                         "logFC \u0394 mGFR (BSA)", 
                         "-log10(p-value)",
                         "nebula/kpmp_pt_mgfr_jodal_bsa_trtcolors",
                         treatment_results = pt_hvg_kpmp,
                         treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                         formula = "\u0394 mGFR (BSA) + treatment",
                         positive_text = "Positively associated with \n\u0394 mGFR (BSA)",
                         negative_text = "Negatively associated with \n\u0394 mGFR (BSA)",
                         clinical_direction = 
                           clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                         cell_type = "PT",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(pt_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_pt_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")

plot_volcano(pt_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")
```


#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_mgfr_jodal_bsa <- pt_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_pt_mgfr_jodal_bsa) <- pt_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_pt_mgfr_jodal_bsa <- sort(rankings_pt_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_pt_mgfr_jodal_bsa)
min(rankings_pt_mgfr_jodal_bsa)
max(rankings_pt_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_pt_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_pt_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_pt_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_pt_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_mgfr_jodal_bsa_filtered, title = "PT Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_pt_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_mgfr_jodal_bsa_filtered, title = "PT Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_pt_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_mgfr_jodal_bsa_filtered, title = "PT Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(pt_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "PT \u0394 TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_tir_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(pt_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_tir_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "PT",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(pt_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_pt_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "PT")

plot_volcano(pt_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_tir <- pt_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_pt_tir) <- pt_tir_delta_hvg_kpmp$Gene
rankings_pt_tir <- sort(rankings_pt_tir, decreasing = TRUE)
plot(rankings_pt_tir)
min(rankings_pt_tir)
max(rankings_pt_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_tir <- fgsea(pathways = reactome,
                              stats = rankings_pt_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_tir <- fgsea(pathways = go,
                        stats = rankings_pt_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_tir[, padj < 0.05], na.rm = T), sum(reactome_res_pt_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_tir[, padj < 0.05], na.rm = T), sum(go_res_pt_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_tir_filtered, title = "PT Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_tir_filtered <- filter_redundant_pathways(reactome_res_pt_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_tir_filtered, title = "PT Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_tir_filtered <- filter_redundant_pathways(go_res_pt_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_tir_filtered, title = "PT Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(pt_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "PT \u0394 HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_hba1c_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```


```{r echo = F}
plot_volcano_concordance(pt_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_hba1c_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "PT",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(pt_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_pt_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "PT")

plot_volcano(pt_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_hba1c <- pt_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_pt_hba1c) <- pt_hba1c_delta_hvg_kpmp$Gene
rankings_pt_hba1c <- sort(rankings_pt_hba1c, decreasing = TRUE)
plot(rankings_pt_hba1c)
min(rankings_pt_hba1c)
max(rankings_pt_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_pt_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_hba1c <- fgsea(pathways = go,
                        stats = rankings_pt_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_pt_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_hba1c[, padj < 0.05], na.rm = T), sum(go_res_pt_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_hba1c_filtered, title = "PT Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_hba1c_filtered <- filter_redundant_pathways(reactome_res_pt_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_hba1c_filtered, title = "PT Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_hba1c_filtered <- filter_redundant_pathways(go_res_pt_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_hba1c, title = "PT Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Weight

```{r echo = F}
plot_volcano_associations(pt_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "PT \u0394 Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_weight_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```


```{r echo = F}
plot_volcano_concordance(pt_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_weight_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "PT",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```



```{r echo =F, eval = F}
plot_volcano(pt_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_pt_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "PT")

plot_volcano(pt_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_weight <- pt_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_pt_weight) <- pt_weight_delta_hvg_kpmp$Gene
rankings_pt_weight <- sort(rankings_pt_weight, decreasing = TRUE)
plot(rankings_pt_weight)
min(rankings_pt_weight)
max(rankings_pt_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_weight <- fgsea(pathways = reactome,
                              stats = rankings_pt_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_weight <- fgsea(pathways = go,
                        stats = rankings_pt_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_weight[, padj < 0.05], na.rm = T), sum(reactome_res_pt_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_weight[, padj < 0.05], na.rm = T), sum(go_res_pt_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_weight_filtered, title = "PT Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_weight_filtered <- filter_redundant_pathways(reactome_res_pt_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_weight_filtered, title = "PT Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_weight_filtered <- filter_redundant_pathways(go_res_pt_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_weight_filtered, title = "PT Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
pt_avg_c_r2_delta_hvg_kpmp <- subset(pt_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)
plot_volcano_associations(pt_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "PT avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_c_r2_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(pt_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_c_r2_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "PT",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(pt_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_pt_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "PT")

plot_volcano(subset(pt_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_avg_c_r2 <- pt_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_pt_avg_c_r2) <- pt_avg_c_r2_delta_hvg_kpmp$Gene
rankings_pt_avg_c_r2 <- sort(rankings_pt_avg_c_r2, decreasing = TRUE)
plot(rankings_pt_avg_c_r2)
min(rankings_pt_avg_c_r2)
max(rankings_pt_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_pt_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_pt_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_pt_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_pt_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_avg_c_r2_filtered, title = "PT Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_pt_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_avg_c_r2, title = "PT Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_avg_c_r2_filtered <- filter_redundant_pathways(go_res_pt_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_avg_c_r2_filtered, title = "PT Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*


```{r echo = F}
pt_avg_k_r2_delta_hvg_kpmp <- subset(pt_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)
plot_volcano_associations(subset(pt_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "PT avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_k_r2_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```


```{r echo = F}
plot_volcano_concordance(pt_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_k_r2_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "PT",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(pt_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_pt_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "PT")

plot_volcano(subset(pt_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_avg_k_r2 <- pt_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_pt_avg_k_r2) <- pt_avg_k_r2_delta_hvg_kpmp$Gene
rankings_pt_avg_k_r2 <- sort(rankings_pt_avg_k_r2, decreasing = TRUE)
plot(rankings_pt_avg_k_r2)
min(rankings_pt_avg_k_r2)
max(rankings_pt_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_pt_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_pt_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_pt_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_pt_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_avg_k_r2_filtered, title = "PT Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_pt_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_avg_k_r2_filtered, title = "PT Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_avg_k_r2_filtered <- filter_redundant_pathways(go_res_pt_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_avg_k_r2_filtered, title = "PT Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Ketones

```{r echo = F}
pt_avg_ketones_delta_hvg_kpmp <- subset(pt_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)
plot_volcano_associations(subset(pt_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "PT ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_ketones_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(pt_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_ketones_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "PT",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.3,
                         force = 80)
```

```{r echo =F, eval = F}
plot_volcano(subset(pt_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_pt_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "PT")

plot_volcano(subset(pt_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pt_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "PT")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_avg_ketones <- pt_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_pt_avg_ketones) <- pt_avg_ketones_delta_hvg_kpmp$Gene
rankings_pt_avg_ketones <- sort(rankings_pt_avg_ketones, decreasing = TRUE)
plot(rankings_pt_avg_ketones)
min(rankings_pt_avg_ketones)
max(rankings_pt_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pt_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_pt_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_pt_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_pt_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_pt_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pt_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_avg_ketones_filtered, title = "PT Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pt_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_pt_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_avg_ketones_filtered, title = "PT Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pt_avg_ketones_filtered <- filter_redundant_pathways(go_res_pt_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_avg_ketones_filtered, title = "PT Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# TAL

## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(tal_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "TAL Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_mgfr_jodal_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```


```{r echo = F}
plot_volcano_concordance(tal_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_mgfr_jodal_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(tal_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_tal_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "TAL")

plot_volcano(tal_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_mgfr_jodal <- tal_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_tal_mgfr_jodal) <- tal_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_tal_mgfr_jodal <- sort(rankings_tal_mgfr_jodal, decreasing = TRUE)
plot(rankings_tal_mgfr_jodal)
min(rankings_tal_mgfr_jodal)
max(rankings_tal_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_tal_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_tal_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_tal_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_tal_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_mgfr_jodal, title = "TAL Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_tal_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_mgfr_jodal_filtered, title = "TAL Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_tal_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_mgfr_jodal, title = "TAL Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(tal_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "TAL BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_mgfr_jodal_bsa_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```


```{r echo = F}
plot_volcano_concordance(tal_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_mgfr_jodal_bsa_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = 
                           clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(tal_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_tal_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "TAL")

plot_volcano(tal_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_mgfr_jodal_bsa <- tal_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_tal_mgfr_jodal_bsa) <- tal_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_tal_mgfr_jodal_bsa <- sort(rankings_tal_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_tal_mgfr_jodal_bsa)
min(rankings_tal_mgfr_jodal_bsa)
max(rankings_tal_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_tal_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_tal_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_tal_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_tal_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_mgfr_jodal_bsa_filtered, title = "TAL Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_tal_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_mgfr_jodal_bsa_filtered, title = "TAL Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_tal_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_mgfr_jodal_bsa_filtered, title = "TAL Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(tal_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "TAL TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_tir_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          legend_position = c(0.95, 0.8))
```


```{r echo = F}
plot_volcano_concordance(tal_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_tir_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          legend_position = "top",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```



```{r echo =F, eval = F}
plot_volcano(tal_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_tal_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "TAL")

plot_volcano(tal_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_tir <- tal_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_tal_tir) <- tal_tir_delta_hvg_kpmp$Gene
rankings_tal_tir <- sort(rankings_tal_tir, decreasing = TRUE)
plot(rankings_tal_tir)
min(rankings_tal_tir)
max(rankings_tal_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_tir <- fgsea(pathways = reactome,
                              stats = rankings_tal_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_tir <- fgsea(pathways = go,
                        stats = rankings_tal_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_tir[, padj < 0.05], na.rm = T), sum(reactome_res_tal_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_tir[, padj < 0.05], na.rm = T), sum(go_res_tal_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_tir_filtered, title = "TAL Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_tir_filtered <- filter_redundant_pathways(reactome_res_tal_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_tir_filtered, title = "TAL Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_tir_filtered <- filter_redundant_pathways(go_res_tal_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_tir_filtered, title = "TAL Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(tal_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "TAL HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_hba1c_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(tal_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_hba1c_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          legend_position = "top",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "HbA1c\n-0.47", top_n = 20,
                         force = 10)
```


```{r echo =F, eval = F}
plot_volcano(tal_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_tal_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "TAL")

plot_volcano(tal_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_hba1c <- tal_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_tal_hba1c) <- tal_hba1c_delta_hvg_kpmp$Gene
rankings_tal_hba1c <- sort(rankings_tal_hba1c, decreasing = TRUE)
plot(rankings_tal_hba1c)
min(rankings_tal_hba1c)
max(rankings_tal_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_tal_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_hba1c <- fgsea(pathways = go,
                        stats = rankings_tal_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_tal_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_hba1c[, padj < 0.05], na.rm = T), sum(go_res_tal_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_hba1c_filtered, title = "TAL Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_hba1c_filtered <- filter_redundant_pathways(reactome_res_tal_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_hba1c_filtered, title = "TAL Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_hba1c_filtered <- filter_redundant_pathways(go_res_tal_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_hba1c_filtered, title = "TAL Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight

```{r echo = F}
plot_volcano_associations(tal_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "TAL Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_weight_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```

```{r echo = F}
plot_volcano_concordance(tal_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_weight_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "Weight\n-2.9", top_n = 20,
                         box.padding = 0.15, force = 60)
```

```{r echo =F, eval = F}
plot_volcano(tal_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_tal_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight"m
             cell_type = "TAL")

plot_volcano(tal_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight"m
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_weight <- tal_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_tal_weight) <- tal_weight_delta_hvg_kpmp$Gene
rankings_tal_weight <- sort(rankings_tal_weight, decreasing = TRUE)
plot(rankings_tal_weight)
min(rankings_tal_weight)
max(rankings_tal_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_weight <- fgsea(pathways = reactome,
                              stats = rankings_tal_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_weight <- fgsea(pathways = go,
                        stats = rankings_tal_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_weight[, padj < 0.05], na.rm = T), sum(reactome_res_tal_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_weight[, padj < 0.05], na.rm = T), sum(go_res_tal_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_weight_filtered, title = "TAL Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_weight_filtered <- filter_redundant_pathways(reactome_res_tal_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_weight, title = "TAL Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_weight_filtered <- filter_redundant_pathways(go_res_tal_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_weight_filtered, title = "TAL Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
tal_avg_c_r2_delta_hvg_kpmp <- subset(tal_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)
plot_volcano_associations(tal_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "TAL avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_c_r2_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(tal_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_c_r2_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(tal_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_tal_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "TAL")

plot_volcano(subset(tal_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_avg_c_r2 <- tal_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_tal_avg_c_r2) <- tal_avg_c_r2_delta_hvg_kpmp$Gene
rankings_tal_avg_c_r2 <- sort(rankings_tal_avg_c_r2, decreasing = TRUE)
plot(rankings_tal_avg_c_r2)
min(rankings_tal_avg_c_r2)
max(rankings_tal_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_tal_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_tal_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_tal_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_tal_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_avg_c_r2_filtered, title = "TAL Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_tal_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_avg_c_r2_filtered, title = "TAL Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_avg_c_r2_filtered <- filter_redundant_pathways(go_res_tal_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_avg_c_r2_filtered, title = "TAL Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Avg kidney R2*

```{r echo = F}
tal_avg_k_r2_delta_hvg_kpmp <- subset(tal_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)

plot_volcano_associations(tal_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "TAL avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_k_r2_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(tal_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_k_r2_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(tal_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_tal_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "TAL")

plot_volcano(subset(tal_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "TAL")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_avg_k_r2 <- tal_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_tal_avg_k_r2) <- tal_avg_k_r2_delta_hvg_kpmp$Gene
rankings_tal_avg_k_r2 <- sort(rankings_tal_avg_k_r2, decreasing = TRUE)
plot(rankings_tal_avg_k_r2)
min(rankings_tal_avg_k_r2)
max(rankings_tal_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_tal_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_tal_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_tal_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_tal_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_avg_k_r2_filtered, title = "TAL Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_tal_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_avg_k_r2_filtered, title = "TAL Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### GO
```{r echo = F, eval = F}
go_res_tal_avg_k_r2_filtered <- filter_redundant_pathways(go_res_tal_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_avg_k_r2_filtered, title = "TAL Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones

```{r echo = F}
tal_avg_ketones_delta_hvg_kpmp <- subset(tal_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(subset(tal_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "TAL ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_ketones_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(tal_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_tal_avg_ketones_trtcolors",
                          treatment_results = tal_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "TAL",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.2,
                         force = 120)
```

```{r echo =F, eval = F}
plot_volcano(subset(tal_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_tal_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "TAL")

plot_volcano(subset(tal_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_tal_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "TAL")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercetal = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_avg_ketones <- tal_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_tal_avg_ketones) <- tal_avg_ketones_delta_hvg_kpmp$Gene
rankings_tal_avg_ketones <- sort(rankings_tal_avg_ketones, decreasing = TRUE)
plot(rankings_tal_avg_ketones)
min(rankings_tal_avg_ketones)
max(rankings_tal_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_tal_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_tal_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_tal_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_tal_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_tal_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_tal_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_avg_ketones_filtered, title = "TAL Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_tal_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_tal_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_avg_ketones_filtered, title = "TAL Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_tal_avg_ketones_filtered <- filter_redundant_pathways(go_res_tal_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_avg_ketones_filtered, title = "TAL Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# Immune Cells
## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(immune_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "Immune Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_mgfr_jodal_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_mgfr_jodal_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune")

plot_volcano(immune_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_mgfr_jodal <- immune_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_immune_mgfr_jodal) <- immune_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_immune_mgfr_jodal <- sort(rankings_immune_mgfr_jodal, decreasing = TRUE)
plot(rankings_immune_mgfr_jodal)
min(rankings_immune_mgfr_jodal)
max(rankings_immune_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_immune_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_immune_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_immune_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_immune_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_mgfr_jodal_filtered, title = "Immune Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_immune_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_mgfr_jodal_filtered, title = "Immune Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_immune_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_mgfr_jodal, title = "Immune Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(immune_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "Immune BSA mGFR (BSA)", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20,
                         force = 80, box.padding = 0.2)
```

```{r echo =F, eval = F}
plot_volcano(immune_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune")

plot_volcano(immune_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_mgfr_jodal_bsa <- immune_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_immune_mgfr_jodal_bsa) <- immune_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_immune_mgfr_jodal_bsa <- sort(rankings_immune_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_immune_mgfr_jodal_bsa)
min(rankings_immune_mgfr_jodal_bsa)
max(rankings_immune_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_immune_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_immune_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_immune_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_immune_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_mgfr_jodal_bsa_filtered, title = "Immune Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_immune_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_mgfr_jodal_bsa_filtered, title = "Immune Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_immune_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_mgfr_jodal_bsa_filtered, title = "Immune Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(immune_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "Immune TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_tir_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(immune_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_tir_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_immune_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune")

plot_volcano(immune_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_tir <- immune_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_immune_tir) <- immune_tir_delta_hvg_kpmp$Gene
rankings_immune_tir <- sort(rankings_immune_tir, decreasing = TRUE)
plot(rankings_immune_tir)
min(rankings_immune_tir)
max(rankings_immune_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_tir <- fgsea(pathways = reactome,
                              stats = rankings_immune_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_tir <- fgsea(pathways = go,
                        stats = rankings_immune_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_tir[, padj < 0.05], na.rm = T), sum(reactome_res_immune_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_tir[, padj < 0.05], na.rm = T), sum(go_res_immune_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_tir_filtered, title = "Immune Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_tir_filtered <- filter_redundant_pathways(reactome_res_immune_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_tir_filtered, title = "Immune Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_tir_filtered <- filter_redundant_pathways(go_res_immune_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_tir_filtered, title = "Immune Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(immune_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "Immune HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_hba1c_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```


```{r echo = F}
plot_volcano_concordance(immune_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_hba1c_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_immune_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune")

plot_volcano(immune_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_hba1c <- immune_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_immune_hba1c) <- immune_hba1c_delta_hvg_kpmp$Gene
rankings_immune_hba1c <- sort(rankings_immune_hba1c, decreasing = TRUE)
plot(rankings_immune_hba1c)
min(rankings_immune_hba1c)
max(rankings_immune_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_immune_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_hba1c <- fgsea(pathways = go,
                        stats = rankings_immune_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_immune_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_hba1c[, padj < 0.05], na.rm = T), sum(go_res_immune_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_hba1c_filtered, title = "Immune Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_hba1c_filtered <- filter_redundant_pathways(reactome_res_immune_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_hba1c, title = "Immune Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_hba1c_filtered <- filter_redundant_pathways(go_res_immune_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_hba1c, title = "Immune Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight


```{r echo = F}
plot_volcano_associations(immune_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "Immune Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_weight_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```

```{r echo = F}
plot_volcano_concordance(immune_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_weight_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_immune_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune")

plot_volcano(immune_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_weight <- immune_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_immune_weight) <- immune_weight_delta_hvg_kpmp$Gene
rankings_immune_weight <- sort(rankings_immune_weight, decreasing = TRUE)
plot(rankings_immune_weight)
min(rankings_immune_weight)
max(rankings_immune_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_weight <- fgsea(pathways = reactome,
                              stats = rankings_immune_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_weight <- fgsea(pathways = go,
                        stats = rankings_immune_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_weight[, padj < 0.05], na.rm = T), sum(reactome_res_immune_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_weight[, padj < 0.05], na.rm = T), sum(go_res_immune_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_weight_filtered, title = "Immune Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_weight_filtered <- filter_redundant_pathways(reactome_res_immune_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_weight_filtered, title = "Immune Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_weight_filtered <- filter_redundant_pathways(go_res_immune_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_weight_filtered, title = "Immune Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
immune_avg_c_r2_delta_hvg_kpmp <- subset(immune_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(immune_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "Immune avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_c_r2_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_c_r2_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(immune_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune")

plot_volcano(subset(immune_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_avg_c_r2 <- immune_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_immune_avg_c_r2) <- immune_avg_c_r2_delta_hvg_kpmp$Gene
rankings_immune_avg_c_r2 <- sort(rankings_immune_avg_c_r2, decreasing = TRUE)
plot(rankings_immune_avg_c_r2)
min(rankings_immune_avg_c_r2)
max(rankings_immune_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_avg_c_r2_filtered, title = "Immune Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_immune_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_avg_c_r2_filtered, title = "Immune Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_avg_c_r2_filtered <- filter_redundant_pathways(go_res_immune_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_avg_c_r2_filtered, title = "Immune Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*


```{r echo = F}
immune_avg_k_r2_delta_hvg_kpmp <- subset(immune_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)

plot_volcano_associations(immune_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "Immune avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_k_r2_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_k_r2_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20,
                         force = 80, box.padding = 0.05)
```

```{r echo =F, eval = F}
plot_volcano(subset(immune_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "Immune")

plot_volcano(subset(immune_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "Immune")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_avg_k_r2 <- immune_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_immune_avg_k_r2) <- immune_avg_k_r2_delta_hvg_kpmp$Gene
rankings_immune_avg_k_r2 <- sort(rankings_immune_avg_k_r2, decreasing = TRUE)
plot(rankings_immune_avg_k_r2)
min(rankings_immune_avg_k_r2)
max(rankings_immune_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_avg_k_r2_filtered, title = "Immune Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_immune_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_avg_k_r2_filtered, title = "Immune Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_avg_k_r2_filtered <- filter_redundant_pathways(go_res_immune_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_avg_k_r2_filtered, title = "Immune Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones

```{r echo = F}
immune_avg_ketones_delta_hvg_kpmp <- subset(immune_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(subset(immune_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "Immune ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_ketones_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(immune_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_avg_ketones_trtcolors",
                          treatment_results = immune_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "Immune",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.1,
                         force = 50)
```

```{r echo =F, eval = F}
plot_volcano(subset(immune_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_immune_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune")

plot_volcano(subset(immune_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capiimmuneize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xinterceimmune = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_avg_ketones <- immune_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_immune_avg_ketones) <- immune_avg_ketones_delta_hvg_kpmp$Gene
rankings_immune_avg_ketones <- sort(rankings_immune_avg_ketones, decreasing = TRUE)
plot(rankings_immune_avg_ketones)
min(rankings_immune_avg_ketones)
max(rankings_immune_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_immune_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_immune_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_immune_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_immune_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_avg_ketones_filtered, title = "Immune Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_immune_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_avg_ketones_filtered, title = "Immune Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_avg_ketones_filtered <- filter_redundant_pathways(go_res_immune_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_avg_ketones_filtered, title = "Immune Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


# Immune Cells (Myeloid)


## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(immune_myeloid_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "Immune - Myeloid Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_mgfr_jodal_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_mgfr_jodal_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "mGFR\n-11.5", top_n = 20,
                         force = 80, box.padding = 0.05)
```

```{r echo =F, eval = F}
plot_volcano(immune_myeloid_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_mgfr_jodal <- immune_myeloid_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_immune_myeloid_mgfr_jodal) <- immune_myeloid_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_immune_myeloid_mgfr_jodal <- sort(rankings_immune_myeloid_mgfr_jodal, decreasing = TRUE)
plot(rankings_immune_myeloid_mgfr_jodal)
min(rankings_immune_myeloid_mgfr_jodal)
max(rankings_immune_myeloid_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_mgfr_jodal_filtered, title = "Immune_Myeloid Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_mgfr_jodal_filtered, title = "Immune_Myeloid Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_immune_myeloid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_mgfr_jodal_filtered, title = "Immune_Myeloid Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "Immune - Myeloid BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20,
                         force = 40, box.padding = 0.25)
```

```{r echo =F, eval = F}
plot_volcano(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_mgfr_jodal_bsa <- immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_immune_myeloid_mgfr_jodal_bsa) <- immune_myeloid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_immune_myeloid_mgfr_jodal_bsa <- sort(rankings_immune_myeloid_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_immune_myeloid_mgfr_jodal_bsa)
min(rankings_immune_myeloid_mgfr_jodal_bsa)
max(rankings_immune_myeloid_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_mgfr_jodal_bsa_filtered, title = "Immune_Myeloid Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_mgfr_jodal_bsa_filtered, title = "Immune_Myeloid Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_immune_myeloid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_mgfr_jodal_bsa_filtered, title = "Immune_Myeloid Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(immune_myeloid_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "Immune - Myeloid TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_tir_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_tir_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(immune_myeloid_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_tir <- immune_myeloid_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_immune_myeloid_tir) <- immune_myeloid_tir_delta_hvg_kpmp$Gene
rankings_immune_myeloid_tir <- sort(rankings_immune_myeloid_tir, decreasing = TRUE)
plot(rankings_immune_myeloid_tir)
min(rankings_immune_myeloid_tir)
max(rankings_immune_myeloid_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_tir <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_tir <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_tir[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_tir[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_tir_filtered, title = "Immune_Myeloid Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_tir_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_tir_filtered, title = "Immune_Myeloid Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_tir_filtered <- filter_redundant_pathways(go_res_immune_myeloid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_tir_filtered, title = "Immune_Myeloid Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(immune_myeloid_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "Immune - Myeloid HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_hba1c_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_hba1c_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_myeloid_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_hba1c <- immune_myeloid_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_immune_myeloid_hba1c) <- immune_myeloid_hba1c_delta_hvg_kpmp$Gene
rankings_immune_myeloid_hba1c <- sort(rankings_immune_myeloid_hba1c, decreasing = TRUE)
plot(rankings_immune_myeloid_hba1c)
min(rankings_immune_myeloid_hba1c)
max(rankings_immune_myeloid_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_hba1c <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_hba1c[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_hba1c_filtered, title = "Immune_Myeloid Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_hba1c_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_hba1c_filtered, title = "Immune_Myeloid Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_hba1c_filtered <- filter_redundant_pathways(go_res_immune_myeloid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_hba1c_filtered, title = "Immune_Myeloid Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight


```{r echo = F}
plot_volcano_associations(immune_myeloid_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "Immune - Myeloid Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_weight_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_weight_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_myeloid_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_weight <- immune_myeloid_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_immune_myeloid_weight) <- immune_myeloid_weight_delta_hvg_kpmp$Gene
rankings_immune_myeloid_weight <- sort(rankings_immune_myeloid_weight, decreasing = TRUE)
plot(rankings_immune_myeloid_weight)
min(rankings_immune_myeloid_weight)
max(rankings_immune_myeloid_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_weight <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_weight <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_weight[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_weight[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_weight_filtered, title = "Immune_Myeloid Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_weight_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_weight_filtered, title = "Immune_Myeloid Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_weight_filtered <- filter_redundant_pathways(go_res_immune_myeloid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_weight_filtered, title = "Immune_Myeloid Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
immune_myeloid_avg_c_r2_delta_hvg_kpmp <- subset(immune_myeloid_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(immune_myeloid_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "Immune - Myeloid avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_c_r2_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_c_r2_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(immune_myeloid_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune (Myeloid)")

plot_volcano(subset(immune_myeloid_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_avg_c_r2 <- immune_myeloid_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_immune_myeloid_avg_c_r2) <- immune_myeloid_avg_c_r2_delta_hvg_kpmp$Gene
rankings_immune_myeloid_avg_c_r2 <- sort(rankings_immune_myeloid_avg_c_r2, decreasing = TRUE)
plot(rankings_immune_myeloid_avg_c_r2)
min(rankings_immune_myeloid_avg_c_r2)
max(rankings_immune_myeloid_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_avg_c_r2_filtered, title = "Immune_Myeloid Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_avg_c_r2_filtered, title = "Immune_Myeloid Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_avg_c_r2_filtered <- filter_redundant_pathways(go_res_immune_myeloid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_avg_c_r2_filtered, title = "Immune_Myeloid Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*


```{r echo = F}
immune_myeloid_avg_k_r2_delta_hvg_kpmp <- subset(immune_myeloid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)
plot_volcano_associations(immune_myeloid_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "Immune - Myeloid avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_k_r2_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_k_r2_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(immune_myeloid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "Immune (Myeloid)")

plot_volcano(subset(immune_myeloid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_avg_k_r2 <- immune_myeloid_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_immune_myeloid_avg_k_r2) <- immune_myeloid_avg_k_r2_delta_hvg_kpmp$Gene
rankings_immune_myeloid_avg_k_r2 <- sort(rankings_immune_myeloid_avg_k_r2, decreasing = TRUE)
plot(rankings_immune_myeloid_avg_k_r2)
min(rankings_immune_myeloid_avg_k_r2)
max(rankings_immune_myeloid_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_avg_k_r2_filtered, title = "Immune_Myeloid Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_avg_k_r2_filtered, title = "Immune_Myeloid Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_avg_k_r2_filtered <- filter_redundant_pathways(go_res_immune_myeloid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_avg_k_r2_filtered, title = "Immune_Myeloid Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones


```{r echo = F}
immune_myeloid_avg_ketones_delta_hvg_kpmp <- subset(immune_myeloid_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(immune_myeloid_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "Immune - Myeloid ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_ketones_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```

```{r echo = F}
plot_volcano_concordance(immune_myeloid_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_myeloid_avg_ketones_trtcolors",
                          treatment_results = immune_myeloid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "Immune (Myeloid)",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(immune_myeloid_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_immune_myeloid_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune (Myeloid)")

plot_volcano(subset(immune_myeloid_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_myeloid_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_avg_ketones <- immune_myeloid_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_immune_myeloid_avg_ketones) <- immune_myeloid_avg_ketones_delta_hvg_kpmp$Gene
rankings_immune_myeloid_avg_ketones <- sort(rankings_immune_myeloid_avg_ketones, decreasing = TRUE)
plot(rankings_immune_myeloid_avg_ketones)
min(rankings_immune_myeloid_avg_ketones)
max(rankings_immune_myeloid_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_myeloid_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_avg_ketones_filtered, title = "Immune_Myeloid Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_myeloid_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_avg_ketones_filtered, title = "Immune_Myeloid Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_myeloid_avg_ketones_filtered <- filter_redundant_pathways(go_res_immune_myeloid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_avg_ketones_filtered, title = "Immune_Myeloid Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# Immune Cells (Lymphoid)


## mGFR (Raw)
```{r echo = F}
# Read in nebula results saved to kopah
immune_lymphoid_mgfr_jodal_res <- s3readRDS('associations/nebula/mgfr_jodal/immune_lymphoid_attempt_nebula_mgfr_jodal.rds', bucket = "attempt", region = "")

# nebula only keeps results for converged
immune_lymphoid_mgfr_jodal_convergence <- map_dfr(
  names(immune_lymphoid_mgfr_jodal_res),
  function(gene_name) {
    converged <- immune_lymphoid_mgfr_jodal_res[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_lymphoid_mgfr_jodal_converged <- immune_lymphoid_mgfr_jodal_convergence %>%
  filter(Convergence_Code >=-10)

immune_lymphoid_mgfr_jodal_delta_hvg_kpmp <- map_dfr(
  names(immune_lymphoid_mgfr_jodal_res),
  function(gene_name) {
    df <- immune_lymphoid_mgfr_jodal_res[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_lymphoid_mgfr_jodal_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_lymphoid_mgfr_jodal_delta_hvg_kpmp <- immune_lymphoid_mgfr_jodal_delta_hvg_kpmp %>%
  ungroup() %>%
  mutate(fdr_interaction = p.adjust(p_mgfr_jodal_delta, method = "fdr"))

immune_lymphoid_mgfr_jodal_delta_hvg_kpmp_disp <- map_dfr(
  names(immune_lymphoid_mgfr_jodal_res),
  function(gene_name) {
    df <- immune_lymphoid_mgfr_jodal_res[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

write.csv(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_lymphoid_mgfr_jodal.csv", row.names = F)

```

```{r echo = F}
plot_volcano_associations(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "Immune - Lymphoid Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_mgfr_jodal_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_mgfr_jodal_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Myeloid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_mgfr_jodal <- immune_lymphoid_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_immune_lymphoid_mgfr_jodal) <- immune_lymphoid_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_mgfr_jodal <- sort(rankings_immune_lymphoid_mgfr_jodal, decreasing = TRUE)
plot(rankings_immune_lymphoid_mgfr_jodal)
min(rankings_immune_lymphoid_mgfr_jodal)
max(rankings_immune_lymphoid_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_mgfr_jodal_filtered, title = "Immune_Lymphoid Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_mgfr_jodal_filtered, title = "Immune_Lymphoid Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_mgfr_jodal_filtered, title = "Immune_Lymphoid Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "Immune - Lymphoid BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_mgfr_jodal_bsa_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Lymphoid)")

plot_volcano(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_mgfr_jodal_bsa <- immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_immune_lymphoid_mgfr_jodal_bsa) <- immune_lymphoid_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_mgfr_jodal_bsa <- sort(rankings_immune_lymphoid_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_immune_lymphoid_mgfr_jodal_bsa)
min(rankings_immune_lymphoid_mgfr_jodal_bsa)
max(rankings_immune_lymphoid_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_mgfr_jodal_bsa_filtered, title = "Immune_Lymphoid Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_mgfr_jodal_bsa_filtered, title = "Immune_Lymphoid Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_mgfr_jodal_bsa_filtered, title = "Immune_Lymphoid Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(immune_lymphoid_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "Immune - Lymphoid TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_tir_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_tir_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_lymphoid_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune (Lymphoid)")

plot_volcano(immune_lymphoid_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_tir <- immune_lymphoid_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_immune_lymphoid_tir) <- immune_lymphoid_tir_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_tir <- sort(rankings_immune_lymphoid_tir, decreasing = TRUE)
plot(rankings_immune_lymphoid_tir)
min(rankings_immune_lymphoid_tir)
max(rankings_immune_lymphoid_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_tir <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_tir <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_tir[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_tir[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_tir_filtered, title = "Immune_Lymphoid Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_tir_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_tir_filtered, title = "Immune_Lymphoid Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_tir_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_tir_filtered, title = "Immune_Lymphoid Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(immune_lymphoid_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "Immune - Lymphoid HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_hba1c_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_hba1c_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_lymphoid_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune (Lymphoid)")

plot_volcano(immune_lymphoid_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_hba1c <- immune_lymphoid_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_immune_lymphoid_hba1c) <- immune_lymphoid_hba1c_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_hba1c <- sort(rankings_immune_lymphoid_hba1c, decreasing = TRUE)
plot(rankings_immune_lymphoid_hba1c)
min(rankings_immune_lymphoid_hba1c)
max(rankings_immune_lymphoid_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_hba1c <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_hba1c[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_hba1c_filtered, title = "Immune_Lymphoid Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_hba1c_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_hba1c_filtered, title = "Immune_Lymphoid Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_hba1c_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_hba1c_filtered, title = "Immune_Lymphoid Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight

```{r echo = F}
plot_volcano_associations(immune_lymphoid_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "Immune - Lymphoid Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_weight_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_weight_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(immune_lymphoid_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune (Lymphoid)")

plot_volcano(immune_lymphoid_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_weight <- immune_lymphoid_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_immune_lymphoid_weight) <- immune_lymphoid_weight_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_weight <- sort(rankings_immune_lymphoid_weight, decreasing = TRUE)
plot(rankings_immune_lymphoid_weight)
min(rankings_immune_lymphoid_weight)
max(rankings_immune_lymphoid_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_weight <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_weight <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_weight[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_weight[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_weight_filtered, title = "Immune_Lymphoid Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_weight_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_weight_filtered, title = "Immune_Lymphoid Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_weight_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_weight_filtered, title = "Immune_Lymphoid Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
immune_lymphoid_avg_c_r2_delta_hvg_kpmp <- subset(immune_lymphoid_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(immune_lymphoid_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "Immune - Lymphoid avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_c_r2_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_c_r2_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(subset(immune_lymphoid_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune (Lymphoid)")

plot_volcano(subset(immune_lymphoid_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_avg_c_r2 <- immune_lymphoid_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_immune_lymphoid_avg_c_r2) <- immune_lymphoid_avg_c_r2_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_avg_c_r2 <- sort(rankings_immune_lymphoid_avg_c_r2, decreasing = TRUE)
plot(rankings_immune_lymphoid_avg_c_r2)
min(rankings_immune_lymphoid_avg_c_r2)
max(rankings_immune_lymphoid_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_avg_c_r2_filtered, title = "Immune_Lymphoid Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_avg_c_r2_filtered, title = "Immune_Lymphoid Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_avg_c_r2_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_avg_c_r2_filtered, title = "Immune_Lymphoid Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*


```{r echo = F}
immune_lymphoid_avg_k_r2_delta_hvg_kpmp <- subset(immune_lymphoid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)

plot_volcano_associations(immune_lymphoid_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "Immune - Lymphoid avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_k_r2_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_k_r2_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(immune_lymphoid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
            NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
            cell_type = "Immune (Lymphoid)")

plot_volcano(subset(immune_lymphoid_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_avg_k_r2 <- immune_lymphoid_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_immune_lymphoid_avg_k_r2) <- immune_lymphoid_avg_k_r2_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_avg_k_r2 <- sort(rankings_immune_lymphoid_avg_k_r2, decreasing = TRUE)
plot(rankings_immune_lymphoid_avg_k_r2)
min(rankings_immune_lymphoid_avg_k_r2)
max(rankings_immune_lymphoid_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_avg_k_r2_filtered, title = "Immune_Lymphoid Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_avg_k_r2_filtered, title = "Immune_Lymphoid Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_avg_k_r2_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_avg_k_r2_filtered, title = "Immune_Lymphoid Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones


```{r echo = F}
immune_lymphoid_avg_ketones_delta_hvg_kpmp <- subset(immune_lymphoid_avg_ketones_delta_hvg_kpmp, abs(logFC_avg_ketones_delta) < 10)
plot_volcano_associations(immune_lymphoid_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "Immune - Lymphoid ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_ketones_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```

```{r echo = F}
plot_volcano_concordance(immune_lymphoid_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_immune_lymphoid_avg_ketones_trtcolors",
                          treatment_results = immune_lymphoid_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "Immune (Lymphoid)",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(immune_lymphoid_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_immune_lymphoid_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune (Lymphoid)")

plot_volcano(subset(immune_lymphoid_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_immune_lymphoid_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "Immune (Lymphoid)")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_avg_ketones <- immune_lymphoid_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_immune_lymphoid_avg_ketones) <- immune_lymphoid_avg_ketones_delta_hvg_kpmp$Gene
rankings_immune_lymphoid_avg_ketones <- sort(rankings_immune_lymphoid_avg_ketones, decreasing = TRUE)
plot(rankings_immune_lymphoid_avg_ketones)
min(rankings_immune_lymphoid_avg_ketones)
max(rankings_immune_lymphoid_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_immune_lymphoid_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_avg_ketones_filtered, title = "Immune_Lymphoid Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_immune_lymphoid_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_avg_ketones_filtered, title = "Immune_Lymphoid Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_immune_lymphoid_avg_ketones_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_avg_ketones_filtered, title = "Immune_Lymphoid Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# PC
## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(pc_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "PC Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_mgfr_jodal_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(pc_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_mgfr_jodal_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "PC",
                         arrow_label = "mGFR\n-11.5", top_n = 20,
                         force = 80, box.padding = 0.1)
```

```{r echo =F, eval = F}
plot_volcano(pc_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_pc_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PC")

plot_volcano(pc_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_mgfr_jodal <- pc_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_pc_mgfr_jodal) <- pc_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_pc_mgfr_jodal <- sort(rankings_pc_mgfr_jodal, decreasing = TRUE)
plot(rankings_pc_mgfr_jodal)
min(rankings_pc_mgfr_jodal)
max(rankings_pc_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_pc_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_pc_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_pc_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_pc_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_mgfr_jodal_filtered, title = "PC Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_pc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_mgfr_jodal_filtered, title = "PC Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_pc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_mgfr_jodal_filtered, title = "PC Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(pc_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "PC BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_mgfr_jodal_bsa_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(pc_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_mgfr_jodal_bsa_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "PC",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20,
                         force = 10, box.padding = 1)
```

```{r echo =F, eval = F}
plot_volcano(pc_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_pc_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PC")

plot_volcano(pc_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_mgfr_jodal_bsa <- pc_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_pc_mgfr_jodal_bsa) <- pc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_pc_mgfr_jodal_bsa <- sort(rankings_pc_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_pc_mgfr_jodal_bsa)
min(rankings_pc_mgfr_jodal_bsa)
max(rankings_pc_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_pc_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_pc_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_pc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_pc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_mgfr_jodal_bsa_filtered, title = "PC Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_pc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_mgfr_jodal_bsa_filtered, title = "PC Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_pc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_mgfr_jodal_bsa_filtered, title = "PC Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(subset(pc_tir_delta_hvg_kpmp, logFC_tir_delta >-10), 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "PC TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_tir_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(subset(pc_tir_delta_hvg_kpmp, logFC_tir_delta >-10), 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_tir_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "PC",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(pc_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_pc_tir",
             cell_type = "PC")

plot_volcano(pc_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_tir_fdr",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_tir <- pc_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_pc_tir) <- pc_tir_delta_hvg_kpmp$Gene
rankings_pc_tir <- sort(rankings_pc_tir, decreasing = TRUE)
plot(rankings_pc_tir)
min(rankings_pc_tir)
max(rankings_pc_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_tir <- fgsea(pathways = reactome,
                              stats = rankings_pc_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_tir <- fgsea(pathways = go,
                        stats = rankings_pc_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_tir[, padj < 0.05], na.rm = T), sum(reactome_res_pc_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_tir[, padj < 0.05], na.rm = T), sum(go_res_pc_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_tir_filtered, title = "PC Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_tir_filtered <- filter_redundant_pathways(reactome_res_pc_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_tir_filtered, title = "PC Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_tir_filtered <- filter_redundant_pathways(go_res_pc_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_tir_filtered, title = "PC Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(pc_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "PC HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_hba1c_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(pc_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_hba1c_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "PC",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(pc_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_pc_hba1c",
             cell_type = "PC")

plot_volcano(pc_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_hba1c_fdr",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_hba1c <- pc_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_pc_hba1c) <- pc_hba1c_delta_hvg_kpmp$Gene
rankings_pc_hba1c <- sort(rankings_pc_hba1c, decreasing = TRUE)
plot(rankings_pc_hba1c)
min(rankings_pc_hba1c)
max(rankings_pc_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_pc_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_hba1c <- fgsea(pathways = go,
                        stats = rankings_pc_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_pc_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_hba1c[, padj < 0.05], na.rm = T), sum(go_res_pc_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_hba1c_filtered, title = "PC Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_hba1c_filtered <- filter_redundant_pathways(reactome_res_pc_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_hba1c_filtered, title = "PC Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_hba1c_filtered <- filter_redundant_pathways(go_res_pc_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_hba1c_filtered, title = "PC Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight

```{r echo = F}
plot_volcano_associations(pc_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "PC Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_weight_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          legend_position = c(0.95, 0.9))
```

```{r echo = F}
plot_volcano_concordance(pc_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_weight_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "PC",
                         arrow_label = "Weight\n-2.9", top_n = 20,
                         force = 40, box.padding = 0.25)
```

```{r echo =F, eval = F}
plot_volcano(pc_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_pc_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "PC")

plot_volcano(pc_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_weight <- pc_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_pc_weight) <- pc_weight_delta_hvg_kpmp$Gene
rankings_pc_weight <- sort(rankings_pc_weight, decreasing = TRUE)
plot(rankings_pc_weight)
min(rankings_pc_weight)
max(rankings_pc_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_weight <- fgsea(pathways = reactome,
                              stats = rankings_pc_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_weight <- fgsea(pathways = go,
                        stats = rankings_pc_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_weight[, padj < 0.05], na.rm = T), sum(reactome_res_pc_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_weight[, padj < 0.05], na.rm = T), sum(go_res_pc_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_weight_filtered, title = "PC Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_weight_filtered <- filter_redundant_pathways(reactome_res_pc_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_weight_filtered, title = "PC Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_weight_filtered <- filter_redundant_pathways(go_res_pc_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_weight_filtered, title = "PC Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
pc_avg_c_r2_delta_hvg_kpmp <- subset(pc_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(pc_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "PC avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_c_r2_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(pc_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_c_r2_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "PC",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20,
                         force = 35, box.padding = 0.25)
```


```{r echo =F, eval = F}
plot_volcano(subset(pc_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_pc_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "PC")

plot_volcano(subset(pc_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_avg_c_r2 <- pc_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_pc_avg_c_r2) <- pc_avg_c_r2_delta_hvg_kpmp$Gene
rankings_pc_avg_c_r2 <- sort(rankings_pc_avg_c_r2, decreasing = TRUE)
plot(rankings_pc_avg_c_r2)
min(rankings_pc_avg_c_r2)
max(rankings_pc_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_pc_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_pc_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_pc_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_pc_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_avg_c_r2_filtered, title = "PC Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_pc_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_avg_c_r2_filtered, title = "PC Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_avg_c_r2_filtered <- filter_redundant_pathways(go_res_pc_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_avg_c_r2_filtered, title = "PC Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*

```{r echo = F}
pc_avg_k_r2_delta_hvg_kpmp <- subset(pc_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)
plot_volcano_associations(pc_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "PC avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_k_r2_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          legend_position = c(0.95,0.8))
```

```{r echo = F}
plot_volcano_concordance(pc_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_k_r2_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "PC",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20,
                         force = 40, box.padding = 0.25)
```


```{r echo =F, eval = F}
plot_volcano(subset(pc_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_pc_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "PC")

plot_volcano(subset(pc_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "PC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_avg_k_r2 <- pc_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_pc_avg_k_r2) <- pc_avg_k_r2_delta_hvg_kpmp$Gene
rankings_pc_avg_k_r2 <- sort(rankings_pc_avg_k_r2, decreasing = TRUE)
plot(rankings_pc_avg_k_r2)
min(rankings_pc_avg_k_r2)
max(rankings_pc_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_pc_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_pc_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_pc_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_pc_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_avg_k_r2_filtered, title = "PC Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_pc_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_avg_k_r2_filtered, title = "PC Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_avg_k_r2_filtered <- filter_redundant_pathways(go_res_pc_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_avg_k_r2_filtered, title = "PC Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones

```{r echo = F}
pc_avg_ketones_delta_hvg_kpmp <- subset(pc_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(subset(pc_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "PC ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_ketones_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(pc_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_pc_avg_ketones_trtcolors",
                          treatment_results = pc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "PC",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.1,
                         force = 80)
```

```{r echo =F, eval = F}
plot_volcano(subset(pc_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_pc_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "PC")

plot_volcano(subset(pc_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_pc_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "PC")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capipcize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercepc = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_avg_ketones <- pc_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_pc_avg_ketones) <- pc_avg_ketones_delta_hvg_kpmp$Gene
rankings_pc_avg_ketones <- sort(rankings_pc_avg_ketones, decreasing = TRUE)
plot(rankings_pc_avg_ketones)
min(rankings_pc_avg_ketones)
max(rankings_pc_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_pc_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_pc_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_pc_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_pc_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_pc_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_pc_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_avg_ketones_filtered, title = "PC Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_pc_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_pc_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_avg_ketones_filtered, title = "PC Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_pc_avg_ketones_filtered <- filter_redundant_pathways(go_res_pc_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_avg_ketones_filtered, title = "PC Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# IC

## mGFR (Raw)


```{r echo = F}
plot_volcano_associations(ic_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "IC Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_mgfr_jodal_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(ic_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_mgfr_jodal_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "IC",
                         arrow_label = "mGFR\n-11.5", top_n = 20,
                         force = 120, box.padding = 0.1)
```


```{r echo =F, eval = F}
plot_volcano(ic_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_ic_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "IC")

plot_volcano(ic_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_mgfr_jodal <- ic_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_ic_mgfr_jodal) <- ic_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_ic_mgfr_jodal <- sort(rankings_ic_mgfr_jodal, decreasing = TRUE)
plot(rankings_ic_mgfr_jodal)
min(rankings_ic_mgfr_jodal)
max(rankings_ic_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_ic_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_ic_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_ic_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_ic_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_mgfr_jodal_filtered, title = "IC Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_ic_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_mgfr_jodal_filtered, title = "IC Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_ic_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_mgfr_jodal_filtered, title = "IC Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(ic_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "IC BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(ic_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "IC",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20, 
                         force = 80, box.padding = 0.2)
```


```{r echo =F, eval = F}
plot_volcano(ic_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
            NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_ic_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
            cell_type = "IC")

plot_volcano(ic_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_mgfr_jodal_bsa <- ic_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_ic_mgfr_jodal_bsa) <- ic_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_ic_mgfr_jodal_bsa <- sort(rankings_ic_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_ic_mgfr_jodal_bsa)
min(rankings_ic_mgfr_jodal_bsa)
max(rankings_ic_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_ic_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_ic_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_ic_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_ic_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_mgfr_jodal_bsa_filtered, title = "IC Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_ic_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_mgfr_jodal_bsa_filtered, title = "IC Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_ic_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_mgfr_jodal_bsa_filtered, title = "IC Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(ic_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "IC TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_tir_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(ic_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_tir_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "IC",
                         arrow_label = "TIR\n+9.3", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(ic_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_ic_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "IC")

plot_volcano(ic_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_tir <- ic_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_ic_tir) <- ic_tir_delta_hvg_kpmp$Gene
rankings_ic_tir <- sort(rankings_ic_tir, decreasing = TRUE)
plot(rankings_ic_tir)
min(rankings_ic_tir)
max(rankings_ic_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_tir <- fgsea(pathways = reactome,
                              stats = rankings_ic_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_tir <- fgsea(pathways = go,
                        stats = rankings_ic_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_tir[, padj < 0.05], na.rm = T), sum(reactome_res_ic_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_tir[, padj < 0.05], na.rm = T), sum(go_res_ic_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_tir_filtered, title = "IC Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_tir_filtered <- filter_redundant_pathways(reactome_res_ic_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_tir_filtered, title = "IC Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_tir_filtered <- filter_redundant_pathways(go_res_ic_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_tir_filtered, title = "IC Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(ic_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "IC HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_hba1c_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```

```{r echo = F}
plot_volcano_concordance(ic_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_hba1c_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "IC",
                         arrow_label = "HbA1c\n-0.47", top_n = 20,
                         force = 50, box.padding = 0.15)
```


```{r echo =F, eval = F}
plot_volcano(ic_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_ic_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "IC")

plot_volcano(ic_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_hba1c <- ic_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_ic_hba1c) <- ic_hba1c_delta_hvg_kpmp$Gene
rankings_ic_hba1c <- sort(rankings_ic_hba1c, decreasing = TRUE)
plot(rankings_ic_hba1c)
min(rankings_ic_hba1c)
max(rankings_ic_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_ic_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_hba1c <- fgsea(pathways = go,
                        stats = rankings_ic_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_ic_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_hba1c[, padj < 0.05], na.rm = T), sum(go_res_ic_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_hba1c_filtered, title = "IC Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_hba1c_filtered <- filter_redundant_pathways(reactome_res_ic_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_hba1c_filtered, title = "IC Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_hba1c_filtered <- filter_redundant_pathways(go_res_ic_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_hba1c_filtered, title = "IC Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight

```{r echo = F}
plot_volcano_associations(ic_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "IC Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_weight_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          legend_position = c(0.95, 0.9))
```

```{r echo = F}
plot_volcano_concordance(ic_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_weight_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "IC",
                         arrow_label = "Weight\n-2.9", top_n = 20,
                         force = 20, box.padding = .6)
```


```{r echo =F, eval = F}
plot_volcano(ic_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_ic_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "IC")

plot_volcano(ic_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_weight <- ic_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_ic_weight) <- ic_weight_delta_hvg_kpmp$Gene
rankings_ic_weight <- sort(rankings_ic_weight, decreasing = TRUE)
plot(rankings_ic_weight)
min(rankings_ic_weight)
max(rankings_ic_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_weight <- fgsea(pathways = reactome,
                              stats = rankings_ic_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_weight <- fgsea(pathways = go,
                        stats = rankings_ic_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_weight[, padj < 0.05], na.rm = T), sum(reactome_res_ic_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_weight[, padj < 0.05], na.rm = T), sum(go_res_ic_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_weight_filtered, title = "IC Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_weight_filtered <- filter_redundant_pathways(reactome_res_ic_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_weight_filtered, title = "IC Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_weight_filtered <- filter_redundant_pathways(go_res_ic_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_weight_filtered, title = "IC Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
ic_avg_c_r2_delta_hvg_kpmp <- subset(ic_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(ic_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "IC avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_c_r2_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(ic_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_c_r2_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "IC",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(ic_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_ic_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "IC")

plot_volcano(subset(ic_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_avg_c_r2 <- ic_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_ic_avg_c_r2) <- ic_avg_c_r2_delta_hvg_kpmp$Gene
rankings_ic_avg_c_r2 <- sort(rankings_ic_avg_c_r2, decreasing = TRUE)
plot(rankings_ic_avg_c_r2)
min(rankings_ic_avg_c_r2)
max(rankings_ic_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_ic_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_ic_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_ic_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_ic_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_avg_c_r2_filtered, title = "IC Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_ic_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_avg_c_r2_filtered, title = "IC Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_avg_c_r2_filtered <- filter_redundant_pathways(go_res_ic_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_avg_c_r2_filtered, title = "IC Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*

```{r echo = F}
ic_avg_k_r2_delta_hvg_kpmp <- subset(ic_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)

plot_volcano_associations(ic_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "IC avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_k_r2_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          legend_position = c(0.95,0.8))
```

```{r echo = F}
plot_volcano_concordance(ic_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_k_r2_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "IC",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20,
                         force = 40, box.padding = 0.25)
```


```{r echo =F, eval = F}
plot_volcano(subset(ic_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_ic_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "IC")

plot_volcano(subset(ic_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "IC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_avg_k_r2 <- ic_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_ic_avg_k_r2) <- ic_avg_k_r2_delta_hvg_kpmp$Gene
rankings_ic_avg_k_r2 <- sort(rankings_ic_avg_k_r2, decreasing = TRUE)
plot(rankings_ic_avg_k_r2)
min(rankings_ic_avg_k_r2)
max(rankings_ic_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_ic_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_ic_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_ic_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_ic_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_avg_k_r2_filtered, title = "IC Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_ic_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_avg_k_r2_filtered, title = "IC Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_avg_k_r2_filtered <- filter_redundant_pathways(go_res_ic_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_avg_k_r2_filtered, title = "IC Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones

```{r echo = F}
ic_avg_ketones_delta_hvg_kpmp <- subset(ic_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(subset(ic_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "IC ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_ketones_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(ic_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_ic_avg_ketones_trtcolors",
                          treatment_results = ic_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "IC",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.01,
                         force = 250)
```

```{r echo =F, eval = F}
plot_volcano(subset(ic_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_ic_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "IC")

plot_volcano(subset(ic_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ic_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "IC")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capiicize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xinterceic = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_avg_ketones <- ic_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_ic_avg_ketones) <- ic_avg_ketones_delta_hvg_kpmp$Gene
rankings_ic_avg_ketones <- sort(rankings_ic_avg_ketones, decreasing = TRUE)
plot(rankings_ic_avg_ketones)
min(rankings_ic_avg_ketones)
max(rankings_ic_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ic_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_ic_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_ic_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_ic_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_ic_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ic_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_avg_ketones_filtered, title = "IC Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ic_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_ic_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_avg_ketones_filtered, title = "IC Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ic_avg_ketones_filtered <- filter_redundant_pathways(go_res_ic_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_avg_ketones_filtered, title = "IC Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# EC

## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(ec_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "EC Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_mgfr_jodal_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(ec_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_mgfr_jodal_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "EC",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(ec_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_ec_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC")

plot_volcano(ec_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_mgfr_jodal <- ec_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_ec_mgfr_jodal) <- ec_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_ec_mgfr_jodal <- sort(rankings_ec_mgfr_jodal, decreasing = TRUE)
plot(rankings_ec_mgfr_jodal)
min(rankings_ec_mgfr_jodal)
max(rankings_ec_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_ec_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_ec_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_ec_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_ec_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_mgfr_jodal_filtered, title = "EC Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_ec_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_mgfr_jodal_filtered, title = "EC Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_ec_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_mgfr_jodal_filtered, title = "EC Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(ec_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "EC BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(ec_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "EC",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20,
                         force = 140, box.padding = 0.05)
```


```{r echo =F, eval = F}
plot_volcano(ec_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_ec_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC")

plot_volcano(ec_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_mgfr_jodal_bsa <- ec_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_ec_mgfr_jodal_bsa) <- ec_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_ec_mgfr_jodal_bsa <- sort(rankings_ec_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_ec_mgfr_jodal_bsa)
min(rankings_ec_mgfr_jodal_bsa)
max(rankings_ec_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_ec_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_ec_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_ec_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_ec_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_mgfr_jodal_bsa_filtered, title = "EC Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_ec_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_mgfr_jodal_bsa_filtered, title = "EC Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_ec_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_mgfr_jodal_bsa_filtered, title = "EC Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## EC-GC
## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(ec_gc_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "EC-GC Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_gc_mgfr_jodal_trtcolors",
                          treatment_results = ec_gc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(ec_gc_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_gc_mgfr_jodal_trtcolors",
                          treatment_results = ec_gc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "EC-GC",
                         arrow_label = "mGFR\n-11.5", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(ec_gc_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_ec_gc_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC-GC")

plot_volcano(ec_gc_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_gc_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC-GC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_gc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_gc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_gc_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_gc_mgfr_jodal <- ec_gc_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_ec_gc_mgfr_jodal) <- ec_gc_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_ec_gc_mgfr_jodal <- sort(rankings_ec_gc_mgfr_jodal, decreasing = TRUE)
plot(rankings_ec_gc_mgfr_jodal)
min(rankings_ec_gc_mgfr_jodal)
max(rankings_ec_gc_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_gc_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_gc_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_gc_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_ec_gc_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_gc_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_ec_gc_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_gc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_gc_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_gc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_ec_gc_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_gc_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_ec_gc_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_gc_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_gc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_gc_mgfr_jodal_filtered, title = "EC-GC Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_gc_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_ec_gc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_gc_mgfr_jodal_filtered, title = "EC-GC Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_gc_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_ec_gc_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_gc_mgfr_jodal_filtered, title = "EC-GC Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "EC-GC BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_gc_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ec_gc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR")
```

```{r echo = F}
plot_volcano_concordance(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_gc_mgfr_jodal_bsa_trtcolors",
                          treatment_results = ec_gc_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "EC-GC",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20,
                         force = 140, box.padding = 0.05)
```


```{r echo =F, eval = F}
plot_volcano(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_ec_gc_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC-GC")

plot_volcano(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_gc_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "EC-GC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_gc_mgfr_jodal_bsa <- ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_ec_gc_mgfr_jodal_bsa) <- ec_gc_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_ec_gc_mgfr_jodal_bsa <- sort(rankings_ec_gc_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_ec_gc_mgfr_jodal_bsa)
min(rankings_ec_gc_mgfr_jodal_bsa)
max(rankings_ec_gc_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_gc_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_gc_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_gc_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_ec_gc_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_gc_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_ec_gc_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_gc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_gc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_gc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_ec_gc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_gc_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_ec_gc_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_gc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_gc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_gc_mgfr_jodal_bsa_filtered, title = "EC-GC Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_gc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_ec_gc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_gc_mgfr_jodal_bsa_filtered, title = "EC-GC Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_gc_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_ec_gc_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_gc_mgfr_jodal_bsa_filtered, title = "EC-GC Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_gc_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(ec_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "EC TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_tir_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR")
```

```{r echo = F}
plot_volcano_concordance(ec_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_tir_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "EC",
                         arrow_label = "TIR\n+9.3", top_n = 20,
                         force = 100, box.padding = 0.05)
```

```{r echo =F, eval = F}
plot_volcano(ec_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_ec_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "EC")

plot_volcano(ec_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_tir <- ec_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_ec_tir) <- ec_tir_delta_hvg_kpmp$Gene
rankings_ec_tir <- sort(rankings_ec_tir, decreasing = TRUE)
plot(rankings_ec_tir)
min(rankings_ec_tir)
max(rankings_ec_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_tir <- fgsea(pathways = reactome,
                              stats = rankings_ec_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_tir <- fgsea(pathways = go,
                        stats = rankings_ec_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_tir[, padj < 0.05], na.rm = T), sum(reactome_res_ec_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_tir[, padj < 0.05], na.rm = T), sum(go_res_ec_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_tir_filtered, title = "EC Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_tir_filtered <- filter_redundant_pathways(reactome_res_ec_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_tir_filtered, title = "EC Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_tir_filtered <- filter_redundant_pathways(go_res_ec_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_tir_filtered, title = "EC Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(ec_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "EC HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_hba1c_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c")
```

```{r echo = F}
plot_volcano_concordance(ec_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_hba1c_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "EC",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(ec_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_ec_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "EC")

plot_volcano(ec_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_hba1c <- ec_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_ec_hba1c) <- ec_hba1c_delta_hvg_kpmp$Gene
rankings_ec_hba1c <- sort(rankings_ec_hba1c, decreasing = TRUE)
plot(rankings_ec_hba1c)
min(rankings_ec_hba1c)
max(rankings_ec_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_ec_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_hba1c <- fgsea(pathways = go,
                        stats = rankings_ec_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_ec_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_hba1c[, padj < 0.05], na.rm = T), sum(go_res_ec_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_hba1c_filtered, title = "EC Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_hba1c_filtered <- filter_redundant_pathways(reactome_res_ec_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_hba1c_filtered, title = "EC Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_hba1c_filtered <- filter_redundant_pathways(go_res_ec_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_hba1c_filtered, title = "EC Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Weight

```{r echo = F}
plot_volcano_associations(ec_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "EC Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_weight_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight")
```

```{r echo = F}
plot_volcano_concordance(ec_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_weight_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "EC",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(ec_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_ec_weight",
             cell_type = "EC")

plot_volcano(ec_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_weight_fdr",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_weight <- ec_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_ec_weight) <- ec_weight_delta_hvg_kpmp$Gene
rankings_ec_weight <- sort(rankings_ec_weight, decreasing = TRUE)
plot(rankings_ec_weight)
min(rankings_ec_weight)
max(rankings_ec_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_weight <- fgsea(pathways = reactome,
                              stats = rankings_ec_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_weight <- fgsea(pathways = go,
                        stats = rankings_ec_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_weight[, padj < 0.05], na.rm = T), sum(reactome_res_ec_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_weight[, padj < 0.05], na.rm = T), sum(go_res_ec_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_weight_filtered, title = "EC Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_weight_filtered <- filter_redundant_pathways(reactome_res_ec_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_weight_filtered, title = "EC Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_weight_filtered <- filter_redundant_pathways(go_res_ec_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_weight_filtered, title = "EC Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
ec_avg_c_r2_delta_hvg_kpmp <- subset(ec_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)

plot_volcano_associations(ec_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "EC avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_c_r2_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(ec_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_c_r2_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "EC",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(ec_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_ec_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "EC")

plot_volcano(subset(ec_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_avg_c_r2 <- ec_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_ec_avg_c_r2) <- ec_avg_c_r2_delta_hvg_kpmp$Gene
rankings_ec_avg_c_r2 <- sort(rankings_ec_avg_c_r2, decreasing = TRUE)
plot(rankings_ec_avg_c_r2)
min(rankings_ec_avg_c_r2)
max(rankings_ec_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_ec_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_ec_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_ec_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_ec_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_avg_c_r2_filtered, title = "EC Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_ec_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_avg_c_r2_filtered, title = "EC Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_avg_c_r2_filtered <- filter_redundant_pathways(go_res_ec_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_avg_c_r2_filtered, title = "EC Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*

```{r echo = F}
ec_avg_k_r2_delta_hvg_kpmp <- subset(ec_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)

plot_volcano_associations(ec_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "EC avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_k_r2_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```

```{r echo = F}
plot_volcano_concordance(ec_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_k_r2_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "EC",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(subset(ec_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_ec_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "EC")

plot_volcano(subset(ec_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "EC")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_avg_k_r2 <- ec_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_ec_avg_k_r2) <- ec_avg_k_r2_delta_hvg_kpmp$Gene
rankings_ec_avg_k_r2 <- sort(rankings_ec_avg_k_r2, decreasing = TRUE)
plot(rankings_ec_avg_k_r2)
min(rankings_ec_avg_k_r2)
max(rankings_ec_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_ec_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_ec_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_ec_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_ec_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_avg_k_r2_filtered, title = "EC Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_ec_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_avg_k_r2_filtered, title = "EC Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_avg_k_r2_filtered <- filter_redundant_pathways(go_res_ec_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_avg_k_r2_filtered, title = "EC Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Ketones

```{r echo = F}
ec_avg_ketones_delta_hvg_kpmp <- subset(ec_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)

plot_volcano_associations(subset(ec_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "EC ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_ketones_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(ec_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_ec_avg_ketones_trtcolors",
                          treatment_results = ec_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "EC",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.01,
                         force = 250)
```

```{r echo =F, eval = F}
plot_volcano(subset(ec_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_ec_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "EC")

plot_volcano(subset(ec_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_ec_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "EC")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capiecize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xinterceec = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_avg_ketones <- ec_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_ec_avg_ketones) <- ec_avg_ketones_delta_hvg_kpmp$Gene
rankings_ec_avg_ketones <- sort(rankings_ec_avg_ketones, decreasing = TRUE)
plot(rankings_ec_avg_ketones)
min(rankings_ec_avg_ketones)
max(rankings_ec_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_ec_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_ec_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_ec_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_ec_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_ec_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_ec_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_avg_ketones_filtered, title = "EC Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_ec_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_ec_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_avg_ketones_filtered, title = "EC Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_ec_avg_ketones_filtered <- filter_redundant_pathways(go_res_ec_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_avg_ketones_filtered, title = "EC Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

# FIB/VSMC/P

## mGFR (Raw)

```{r echo = F}
plot_volcano_associations(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "FIB, VSMC/P Raw mGFR", 
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_mgfr_jodal_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_delta", 
                          "p_mgfr_jodal_delta",
                          "logFC \u0394 mGFR (Raw)", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_mgfr_jodal_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (Raw) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "mGFR\n-11.5", top_n = 20,
                         force = 40, box.padding = 0.8)
```


```{r echo =F, eval = F}
plot_volcano(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "p_mgfr_jodal_delta",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_mgfr_jodal",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "FIB, VSMC/P")

plot_volcano(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp, "logFC_mgfr_jodal_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (Raw)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_mgfr_jodal_fdr",
             formula = "\u0394 mGFR (Raw) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_mgfr_jodal <- vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp$logFC_mgfr_jodal_delta
names(rankings_vsmc_p_fib_mgfr_jodal) <- vsmc_p_fib_mgfr_jodal_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_mgfr_jodal <- sort(rankings_vsmc_p_fib_mgfr_jodal, decreasing = TRUE)
plot(rankings_vsmc_p_fib_mgfr_jodal)
min(rankings_vsmc_p_fib_mgfr_jodal)
max(rankings_vsmc_p_fib_mgfr_jodal)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_mgfr_jodal <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_mgfr_jodal,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_mgfr_jodal <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_mgfr_jodal,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_mgfr_jodal <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_mgfr_jodal,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_mgfr_jodal[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_mgfr_jodal[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_mgfr_jodal[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_mgfr_jodal[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_mgfr_jodal[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_mgfr_jodal_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_mgfr_jodal_filtered, title = "FIB, VSMC/P Top 30 Raw mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_mgfr_jodal_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_mgfr_jodal_filtered, title = "FIB, VSMC/P Top 30  Raw mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_mgfr_jodal_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_mgfr_jodal, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_mgfr_jodal_filtered, title = "FIB, VSMC/P Top 30  Raw mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## mGFR (BSA)

```{r echo = F}
plot_volcano_associations(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "FIB, VSMC/P BSA mGFR", 
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_mgfr_jodal_bsa_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp, 
                          "logFC_mgfr_jodal_bsa_delta", 
                          "p_mgfr_jodal_bsa_delta",
                          "logFC \u0394 mGFR (BSA)", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_mgfr_jodal_bsa_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 mGFR (BSA) + treatment",
                          positive_text = "Positively associated with \n\u0394 mGFR",
                          negative_text = "Negatively associated with \n\u0394 mGFR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "p_mgfr_jodal_bsa_delta",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_mgfr_jodal_bsa",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "FIB, VSMC/P")

plot_volcano(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp, "logFC_mgfr_jodal_bsa_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 mGFR (BSA)", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_mgfr_jodal_bsa_fdr",
             formula = "\u0394 mGFR (BSA) + treatment",
             positive_text = "Positively associated with \n\u0394 mGFR",
             negative_text = "Negatively associated with \n\u0394 mGFR",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_mgfr_jodal_bsa <- vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp$logFC_mgfr_jodal_bsa_delta
names(rankings_vsmc_p_fib_mgfr_jodal_bsa) <- vsmc_p_fib_mgfr_jodal_bsa_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_mgfr_jodal_bsa <- sort(rankings_vsmc_p_fib_mgfr_jodal_bsa, decreasing = TRUE)
plot(rankings_vsmc_p_fib_mgfr_jodal_bsa)
min(rankings_vsmc_p_fib_mgfr_jodal_bsa)
max(rankings_vsmc_p_fib_mgfr_jodal_bsa)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_mgfr_jodal_bsa,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_mgfr_jodal_bsa <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_mgfr_jodal_bsa,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_mgfr_jodal_bsa <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_mgfr_jodal_bsa,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_mgfr_jodal_bsa[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_mgfr_jodal_bsa[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_mgfr_jodal_bsa_filtered, title = "FIB, VSMC/P Top 30 BSA mGFR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_bsa_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_mgfr_jodal_bsa_filtered, title = "FIB, VSMC/P Top 30 BSA mGFR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_bsa_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_mgfr_jodal_bsa_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_mgfr_jodal_bsa, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_mgfr_jodal_bsa_filtered, title = "FIB, VSMC/P Top 30 BSA mGFR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_mgfr_jodal_bsa_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## TIR

```{r echo = F}
plot_volcano_associations(vsmc_p_fib_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "FIB, VSMC/P TIR", 
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_tir_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_tir_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "TIR\n+9.3", top_n = 20,
                         force = 120, box.padding = 0.00)
```


```{r echo =F, eval = F}
plot_volcano(vsmc_p_fib_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "p_tir_delta",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_tir",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "FIB, VSMC/P")

plot_volcano(vsmc_p_fib_tir_delta_hvg_kpmp, "logFC_tir_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 TIR", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_tir_fdr",
             formula = "\u0394 TIR + treatment",
             positive_text = "Positively associated with \n\u0394 TIR",
             negative_text = "Negatively associated with \n\u0394 TIR",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_tir_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_tir_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_tir <- vsmc_p_fib_tir_delta_hvg_kpmp$logFC_tir_delta
names(rankings_vsmc_p_fib_tir) <- vsmc_p_fib_tir_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_tir <- sort(rankings_vsmc_p_fib_tir, decreasing = TRUE)
plot(rankings_vsmc_p_fib_tir)
min(rankings_vsmc_p_fib_tir)
max(rankings_vsmc_p_fib_tir)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_tir <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_tir,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_tir <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_tir,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_tir <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_tir,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_tir[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_tir[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_tir[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_tir[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_tir[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_tir[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_tir_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_tir, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_tir_filtered, title = "FIB, VSMC/P Top 30 TIR Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_tir_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_tir_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_tir, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_tir_filtered, title = "FIB, VSMC/P Top 30  TIR Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_tir_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_tir_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_tir, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_tir_filtered, title = "FIB, VSMC/P Top 30  TIR Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_tir_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## HbA1c

```{r echo = F}
plot_volcano_associations(vsmc_p_fib_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "FIB, VSMC/P HbA1c", 
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_hba1c_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_hba1c_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)
```


```{r echo =F, eval = F}
plot_volcano(vsmc_p_fib_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "p_hba1c_delta",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_hba1c",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "FIB, VSMC/P")

plot_volcano(vsmc_p_fib_hba1c_delta_hvg_kpmp, "logFC_hba1c_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 HbA1c", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_hba1c_fdr",
             formula = "\u0394 HbA1c + treatment",
             positive_text = "Positively associated with \n\u0394 HbA1c",
             negative_text = "Negatively associated with \n\u0394 HbA1c",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_hba1c_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_hba1c <- vsmc_p_fib_hba1c_delta_hvg_kpmp$logFC_hba1c_delta
names(rankings_vsmc_p_fib_hba1c) <- vsmc_p_fib_hba1c_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_hba1c <- sort(rankings_vsmc_p_fib_hba1c, decreasing = TRUE)
plot(rankings_vsmc_p_fib_hba1c)
min(rankings_vsmc_p_fib_hba1c)
max(rankings_vsmc_p_fib_hba1c)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_hba1c <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_hba1c,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_hba1c <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_hba1c,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_hba1c <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_hba1c,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_hba1c[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_hba1c[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_hba1c[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_hba1c[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_hba1c[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_hba1c[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_hba1c_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_hba1c_filtered, title = "FIB, VSMC/P Top 30 HbA1c Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_hba1c_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_hba1c_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_hba1c_filtered, title = "FIB, VSMC/P Top 30  HbA1c Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_hba1c_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_hba1c_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_hba1c, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_hba1c_filtered, title = "FIB, VSMC/P Top 30  HbA1c Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_hba1c_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Weight

```{r echo = F}
plot_volcano_associations(vsmc_p_fib_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "FIB, VSMC/P Weight", 
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_weight_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          legend_position = c(0.95, 0.8))
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_weight_delta_hvg_kpmp, 
                          "logFC_weight_delta", 
                          "p_weight_delta",
                          "logFC \u0394 Weight", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_weight_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 Weight + treatment",
                          positive_text = "Positively associated with \n\u0394 Weight",
                          negative_text = "Negatively associated with \n\u0394 Weight",
                          clinical_direction = clinical_directions[clinical_directions$variable == "weight",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "Weight\n-2.9", top_n = 20)
```

```{r echo =F, eval = F}
plot_volcano(vsmc_p_fib_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "p_weight_delta",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_weight",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "FIB, VSMC/P")

plot_volcano(vsmc_p_fib_weight_delta_hvg_kpmp, "logFC_weight_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Weight", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_weight_fdr",
             formula = "\u0394 weight + treatment",
             positive_text = "Positively associated with \n\u0394 weight",
             negative_text = "Negatively associated with \n\u0394 weight",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_weight_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_weight_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_weight <- vsmc_p_fib_weight_delta_hvg_kpmp$logFC_weight_delta
names(rankings_vsmc_p_fib_weight) <- vsmc_p_fib_weight_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_weight <- sort(rankings_vsmc_p_fib_weight, decreasing = TRUE)
plot(rankings_vsmc_p_fib_weight)
min(rankings_vsmc_p_fib_weight)
max(rankings_vsmc_p_fib_weight)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_weight <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_weight,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_weight <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_weight,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_weight <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_weight,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_weight[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_weight[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_weight[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_weight[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_weight[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_weight[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_weight_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_weight, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_weight_filtered, title = "FIB, VSMC/P Top 30 Weight Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_weight_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_weight_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_weight, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_weight_filtered, title = "FIB, VSMC/P Top 30  Weight Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_weight_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_weight_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_weight, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_weight_filtered, title = "FIB, VSMC/P Top 30  Weight Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_weight_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


## Avg cortical R2*

```{r echo = F}
vsmc_p_fib_avg_c_r2_delta_hvg_kpmp <- subset(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp, abs(logFC_avg_c_r2_delta) < 10)
plot_volcano_associations(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "FIB, VSMC/P avg cortical R2*", 
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_c_r2_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*")
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp, 
                          "logFC_avg_c_r2_delta", 
                          "p_avg_c_r2_delta",
                          "logFC \u0394 avg cortical R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_c_r2_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg cortical R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg cortical R2*",
                          negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_c_r2",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "Cortical R2*\n+0.27", top_n = 20,
                         force = 160, box.padding = 0.02)
```

```{r echo =F, eval = F}
plot_volcano(subset(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "p_avg_c_r2_delta",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_c_r2",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "FIB, VSMC/P")

plot_volcano(subset(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp, logFC_avg_c_r2_delta >-10), "logFC_avg_c_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Cortical R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_c_r2_fdr",
             formula = "\u0394 avg cortical R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg cortical R2*",
             negative_text = "Negatively associated with \n\u0394 avg cortical R2*",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_avg_c_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_avg_c_r2 <- vsmc_p_fib_avg_c_r2_delta_hvg_kpmp$logFC_avg_c_r2_delta
names(rankings_vsmc_p_fib_avg_c_r2) <- vsmc_p_fib_avg_c_r2_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_avg_c_r2 <- sort(rankings_vsmc_p_fib_avg_c_r2, decreasing = TRUE)
plot(rankings_vsmc_p_fib_avg_c_r2)
min(rankings_vsmc_p_fib_avg_c_r2)
max(rankings_vsmc_p_fib_avg_c_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_avg_c_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_avg_c_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_avg_c_r2 <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_avg_c_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_avg_c_r2 <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_avg_c_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_avg_c_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_avg_c_r2[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_avg_c_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_avg_c_r2[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_avg_c_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_avg_c_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_avg_c_r2_filtered, title = "FIB, VSMC/P Top 30 Avg Cortical R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_c_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_avg_c_r2_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_avg_c_r2_filtered, title = "FIB, VSMC/P Top 30  Avg Cortical R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_c_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_avg_c_r2_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_avg_c_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_avg_c_r2_filtered, title = "FIB, VSMC/P Top 30  Avg Cortical R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_c_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```



## Avg kidney R2*

```{r echo = F}
vsmc_p_fib_avg_k_r2_delta_hvg_kpmp <- subset(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10)
plot_volcano_associations(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "FIB, VSMC/P avg kidney R2*", 
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_k_r2_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*")
```

```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_k_r2_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20,
                         box.padding = 0.1, force = 90)
```

```{r echo =F, eval = F}
plot_volcano(subset(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "p_avg_k_r2_delta",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_k_r2",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "FIB, VSMC/P")

plot_volcano(subset(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp, logFC_avg_k_r2_delta >-10), "logFC_avg_k_r2_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 Avg Kidney R2*", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_k_r2_fdr",
             formula = "\u0394 avg kidney R2* + treatment",
             positive_text = "Positively associated with \n\u0394 avg kidney R2*",
             negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_avg_k_r2_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_avg_k_r2 <- vsmc_p_fib_avg_k_r2_delta_hvg_kpmp$logFC_avg_k_r2_delta
names(rankings_vsmc_p_fib_avg_k_r2) <- vsmc_p_fib_avg_k_r2_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_avg_k_r2 <- sort(rankings_vsmc_p_fib_avg_k_r2, decreasing = TRUE)
plot(rankings_vsmc_p_fib_avg_k_r2)
min(rankings_vsmc_p_fib_avg_k_r2)
max(rankings_vsmc_p_fib_avg_k_r2)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_avg_k_r2 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_avg_k_r2,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_avg_k_r2 <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_avg_k_r2,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_avg_k_r2 <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_avg_k_r2,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_avg_k_r2[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_avg_k_r2[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_avg_k_r2[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_avg_k_r2[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_avg_k_r2[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_avg_k_r2_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_avg_k_r2_filtered, title = "FIB, VSMC/P Top 30 Avg Kidney R2* Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_k_r2_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_avg_k_r2_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_avg_k_r2_filtered, title = "FIB, VSMC/P Top 30  Avg Kidney R2* Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_k_r2_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_avg_k_r2_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_avg_k_r2, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_avg_k_r2_filtered, title = "FIB, VSMC/P Top 30  Avg Kidney R2* Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_k_r2_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Ketones

```{r echo = F}
vsmc_p_fib_avg_ketones_delta_hvg_kpmp <- subset(vsmc_p_fib_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10)
plot_volcano_associations(subset(vsmc_p_fib_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "FIB, VSMC/P ketones", 
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_ketones_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones")
```


```{r echo = F}
plot_volcano_concordance(vsmc_p_fib_avg_ketones_delta_hvg_kpmp, 
                          "logFC_avg_ketones_delta", 
                          "p_avg_ketones_delta",
                          "logFC \u0394 ketones", 
                          "-log10(p-value)",
                          "nebula/kpmp_vsmc_p_fib_avg_ketones_trtcolors",
                          treatment_results = vsmc_p_fib_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 ketones + treatment",
                          positive_text = "Positively associated with \n\u0394 ketones",
                          negative_text = "Negatively associated with \n\u0394 ketones",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_ketones",]$direction, 
                          cell_type = "FIB, VSMC/P",
                         arrow_label = "Ketones\n+0.22", top_n = 20,
                         box.padding = 0.01,
                         force = 50)
```

```{r echo =F, eval = F}
plot_volcano(subset(vsmc_p_fib_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "p_avg_ketones_delta",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_ketones",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "FIB, VSMC/P")

plot_volcano(subset(vsmc_p_fib_avg_ketones_delta_hvg_kpmp, logFC_avg_ketones_delta >-10), "logFC_avg_ketones_delta", 
             "fdr_interaction",
             NULL,
             "logFC \u0394 ketones", 
             "-log10(FDR adjusted p-value)",
             "nebula/kpmp_vsmc_p_fib_avg_ketones_fdr",
             formula = "\u0394 ketones + treatment",
             positive_text = "Positively associated with \n\u0394 ketones",
             negative_text = "Negatively associated with \n\u0394 ketones",
             cell_type = "FIB, VSMC/P")
```

#### GSEA (fgsea)
```{r echo = F, eval = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capivsmc_p_fibize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercevsmc_p_fib = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F, eval = F}
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA"
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(vsmc_p_fib_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(vsmc_p_fib_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(vsmc_p_fib_avg_ketones_delta_hvg_kpmp$Gene), savefile = FALSE)

# rank genes by logFC
rankings_vsmc_p_fib_avg_ketones <- vsmc_p_fib_avg_ketones_delta_hvg_kpmp$logFC_avg_ketones_delta
names(rankings_vsmc_p_fib_avg_ketones) <- vsmc_p_fib_avg_ketones_delta_hvg_kpmp$Gene
rankings_vsmc_p_fib_avg_ketones <- sort(rankings_vsmc_p_fib_avg_ketones, decreasing = TRUE)
plot(rankings_vsmc_p_fib_avg_ketones)
min(rankings_vsmc_p_fib_avg_ketones)
max(rankings_vsmc_p_fib_avg_ketones)
```

```{r echo = F, eval = F}
set.seed(1234)

kegg_legacy_res_vsmc_p_fib_avg_ketones <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_vsmc_p_fib_avg_ketones,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_vsmc_p_fib_avg_ketones <- fgsea(pathways = reactome,
                              stats = rankings_vsmc_p_fib_avg_ketones,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_vsmc_p_fib_avg_ketones <- fgsea(pathways = go,
                        stats = rankings_vsmc_p_fib_avg_ketones,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_vsmc_p_fib_avg_ketones[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_vsmc_p_fib_avg_ketones[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_vsmc_p_fib_avg_ketones[, padj < 0.05], na.rm = T), sum(reactome_res_vsmc_p_fib_avg_ketones[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_vsmc_p_fib_avg_ketones[, padj < 0.05], na.rm = T), sum(go_res_vsmc_p_fib_avg_ketones[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F, eval = F}
kegg_legacy_res_vsmc_p_fib_avg_ketones_filtered <- filter_redundant_pathways(kegg_legacy_res_vsmc_p_fib_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_vsmc_p_fib_avg_ketones_filtered, title = "FIB, VSMC/P Top 30 ketones Associations KEGG", xmin = 1, xmax = 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_ketones_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F, eval = F}
reactome_res_vsmc_p_fib_avg_ketones_filtered <- filter_redundant_pathways(reactome_res_vsmc_p_fib_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_vsmc_p_fib_avg_ketones_filtered, title = "FIB, VSMC/P Top 30  ketones Associations REACTOME", xmin = 1.1, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_ketones_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F, eval = F}
go_res_vsmc_p_fib_avg_ketones_filtered <- filter_redundant_pathways(go_res_vsmc_p_fib_avg_ketones, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_vsmc_p_fib_avg_ketones_filtered, title = "FIB, VSMC/P Top 30  ketones Associations GO", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/vsmc_p_fib_avg_ketones_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
