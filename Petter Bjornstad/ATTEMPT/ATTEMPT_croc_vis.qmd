---
title: "ATTEMPT CROCODILE comparison visualization"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r echo = F, include = F}
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
library(ComplexUpset)
library(ggupset)
library(Hmisc)
library(ggrounded)
library(circlize)
library(tidyverse)
```

```{r echo = F, include = F}
dbs <- c("GO_Biological_Process_2023", 
         "KEGG_2021_Human",
         "Reactome_2022", 
         "Reactome_Pathways_2024")

# function to get precise p-value for large df in volcano plots
safe_pval <- function(t_stat, df, digits = 30) {
  logpt <- pt(q = abs(t_stat), df - 2, log.p = TRUE)
  explogpt <- exp(logpt)
  2*(1-as.numeric(sprintf(paste0("%.", digits, "e"), explogpt)))
}

# function for GSEA
# Set relevant paths
list.files()
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA/"

# Functions ===================================================
## Function: Adjacency matrix to list -------------------------
matrix_to_list <- function(pws){
  pws.l <- list()
  for (pw in colnames(pws)) {
    pws.l[[pw]] <- rownames(pws)[as.logical(pws[, pw])]
  }
  return(pws.l)
}

## Function: prepare_gmt --------------------------------------
prepare_gmt <- function(gmt_file, genes_in_data, savefile = FALSE){

  # Read in gmt file
  gmt <- gmtPathways(gmt_file)
  hidden <- unique(unlist(gmt))
  
  # Convert gmt file to a matrix with the genes as rows and for each go annotation (columns) the values are 0 or 1
  mat <- matrix(NA, dimnames = list(hidden, names(gmt)),
                nrow = length(hidden), ncol = length(gmt))
  for (i in 1:dim(mat)[2]){
    mat[,i] <- as.numeric(hidden %in% gmt[[i]])
  }
  
  #Subset to the genes that are present in our data to avoid bias
  hidden1 <- intersect(genes_in_data, hidden)
  mat <- mat[hidden1, colnames(mat)[which(colSums(mat[hidden1,])>5)]] # filter for gene sets with more than 5 genes annotated
  # And get the list again
  final_list <- matrix_to_list(mat) # for this we use the function we previously defined
  
  if(savefile){
    saveRDS(final_list, file = paste0(gsub('.gmt', '', gmt_file), '_subset_', format(Sys.time(), '%d%m'), '.RData'))
  }
  
  print('Wohoo! .gmt conversion successfull!:)')
  return(final_list)
}

# Download gene sets .gmt files
#https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
```

```{r echo = F}
filter_redundant_pathways <- function(gsea_result, overlap_pct = 0.3) {
  # Check required columns
  if (!all(c("pathway", "leadingEdge", "padj") %in% colnames(gsea_result))) {
    stop("Input data frame must have 'pathway', 'leadingEdge', and 'padj' columns.")
  }
  
  # Extract leading edge and name them
  leading_edges <- gsea_result$leadingEdge
  names(leading_edges) <- gsea_result$pathway
  
  # Compute Jaccard overlap matrix
  overlap_matrix <- sapply(leading_edges, function(x) 
    sapply(leading_edges, function(y) 
      length(intersect(x, y)) / length(union(x, y))
    )
  )
  
  # Identify pairs with high overlap
  overlap_pairs <- which(overlap_matrix > overlap_pct & lower.tri(overlap_matrix), arr.ind = TRUE)
  
  # If no overlaps found, return original
  if (nrow(overlap_pairs) == 0) {
    message("No redundant pathways found with overlap above threshold.")
    return(gsea_result)
  }
  
  # Create overlap graph
  library(igraph)
  edges <- data.frame(
    from = rownames(overlap_matrix)[overlap_pairs[,1]],
    to   = colnames(overlap_matrix)[overlap_pairs[,2]]
  )
  g <- graph_from_data_frame(edges, directed = FALSE)
  components <- components(g)
  
  # Cluster terms and select representative from each
  redundant_clusters <- split(names(components$membership), components$membership)
  representative_terms <- sapply(redundant_clusters, function(cluster_terms) {
    sub <- gsea_result[gsea_result$pathway %in% cluster_terms, ]
    sub[which.min(sub$padj), "pathway"]
  })
  
  # Keep only representative + non-overlapping terms
  all_overlapping <- unique(unlist(redundant_clusters))
  non_overlapping <- setdiff(gsea_result$pathway, all_overlapping)
  final_terms <- c(non_overlapping, representative_terms)
  
  # Return filtered GSEA result
  gsea_result[gsea_result$pathway %in% final_terms, ]
}
```

# Model 1 (Nested visit + ZIF)
## emmeans
### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pt_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/pt_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
pt_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/pt_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
# List of acronyms to uppercase
acronyms <- c("rna", "dna", "mtor", "foxo", "ppar", "nmd", "fgfr", "robo", 
              "bhl", "cov", "jak", "stat", "wnt", "hiv", "bcl", "mapk",
              "pt", "tal", "pc", "ic", "ec", "fibvsmcp",
              unique(pt_emmeans_df_mod1$Gene))
special_mixed <- c("rrna", "mrna", "trna", "gtpase", "atpase", "robos", "slits", "fibvsmcp")
special_replacements <- c("rRNA", "mRNA", "tRNA", "GTPase", "ATPase", "ROBOs", "SLITs", "FIB/VSMC/P")

replace_mixed_case <- function(text, from, to) {
  for (i in seq_along(from)) {
    pattern <- paste0("\\b", from[i], "\\b")
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), to[i])
  }
  return(text)
}

capitalize_acronyms <- function(text, terms) {
  for (term in terms) {
    pattern <- paste0("\\b", term, "\\b")
    replacement <- toupper(term)
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), replacement)
  }
  return(text)
}
plot_fgsea <- function(fgsea_res,
                            top_n = 30,
                            title = "Top Enriched Pathways",
                            xmax = 3,
                            xnudge = xlimit/100,
                            text1 = 6.5,
                            text2 = 18,
                            text3 = 20,
                       face = "plain") {
  
fgsea_res <- fgsea_res %>%
  arrange(pval) %>%
  head(top_n) %>%
  mutate(
    direction = case_when(NES < 0 ~ "Negative", NES > 0 ~ "Positive"),
    pathway_clean = str_remove(pathway, "^KEGG_"), 
    pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
    pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
    pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
    pathway_clean = str_replace_all(pathway_clean, "_", " "),
    pathway_clean = str_to_sentence(pathway_clean),
    pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
    pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
    pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
    pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
    pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
    pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
    pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
    pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
    pathway_clean = paste0(pathway_clean, " (", size, ")")
  ) %>%
  arrange(pval)

  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, fgsea_res$pval)
  
  fgsea_res %>%
    ggplot(aes(x = -log10(pval), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = abs(NES), color = direction, alpha = 0.8)) +
    geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0")) +
    scale_x_continuous(limits = c(0, xlimit), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "-log(p-value)",
      y = "Pathways",
      color = "Direction",
      size = "NES",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F}
## keep converged model results only
pt_model_filtered_mod1 <- pt_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pt_emmeans_filtered_mod1 <- pt_emmeans_df_mod1 %>%
  filter(Gene %in% pt_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))

## non-converged genes percentage
pt_nonconverged_genes_mod1 <- unique((pt_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)

pt_nonconverged_percentage_mod1 <- (length(unique(pt_nonconverged_genes_mod1))/length(unique(pt_model_df_mod1$Gene)))*100

pt_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(pt_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(pt_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pt_emmeans_diff_mod1 <- pt_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pt_emmeans_diff_placebo_mod1 <- pt_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pt_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
pt_emmeans_diff_dapa_mod1 <- pt_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pt_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pt_emmeans_diff_wide_mod1 <- pt_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pt_emmeans_diff_DiD_mod1 <- pt_emmeans_diff_wide_mod1 %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(pt_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pt_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pt_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pt_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pt_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pt_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots

```{r echo = F}
plot_volcano <- function(data, fc, p_col, title_suffix, x_axis, y_axis, file_suffix, p_thresh = 0.05) {
  set.seed(1)
  top_pos <- data %>%
    dplyr::filter(!!sym(fc) > 0 & !!sym(p_col) < p_thresh) %>%
    dplyr::arrange(!!sym(p_col)) %>%
    slice_head(n=20)

  top_neg <- data %>%
    dplyr::filter(!!sym(fc) < 0 & !!sym(p_col) < p_thresh) %>%
    dplyr::arrange(!!sym(p_col)) %>%
    slice_head(n=20)

  data <- data %>%
    dplyr::mutate(top_color = case_when(Gene %in% top_pos$Gene ~ "#f28482",
                                 Gene %in% top_neg$Gene ~ "#457b9d",
                                 TRUE ~ "#ced4da"),
           top_size = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), 1.3, 1),
           top_lab  = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), Gene, ""))

  p <- ggplot(data, aes(x = !!sym(fc), y = -log10(!!sym(p_col)))) +
    geom_hline(yintercept = -log10(p_thresh), linetype = "dashed", color = "darkgrey") +
    geom_point(alpha = 0.5, aes(color = top_color, size = top_size)) +
    geom_text_repel(aes(label = top_lab, color = top_color),
                    size = 3, max.overlaps = Inf,
                    force = 6, segment.alpha = 0.3, segment.size = 0.3) +
    labs(title = paste(title_suffix),
         x = paste(x_axis),
         y = paste(y_axis)) +
    scale_size_continuous(range = c(1, 1.3)) + 
    scale_color_manual(values = c("#457b9d"="#457b9d", "#ced4da"="#ced4da", "#f28482"="#f28482")) +
    theme_minimal() +
    theme(legend.title = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          title = element_text(size = 9)) +
    guides(color = "none", size = "none")

  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Volcano Plots/", file_suffix, ".jpeg"), plot = p, width = 7, height = 5)
  return(p)
}

```

```{r echo = F, eval = F}
# Placebo
plot_volcano(pt_emmeans_diff_placebo_mod1, "Expr Other", "Expr p-value",
             "Model 1 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pt_placebo_pvalue_mod1")

plot_volcano(pt_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pt_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(pt_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pt_dapa_pvalue_mod1")

plot_volcano(pt_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pt_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(pt_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pt_DiD_pvalue_mod1")

plot_volcano(pt_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pt_DiD_adj_pvalue_mod1")
```



### TAL
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
tal_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/tal_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
tal_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/tal_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
tal_model_filtered_mod1 <- tal_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
tal_emmeans_filtered_mod1 <- tal_emmeans_df_mod1 %>%
  filter(Gene %in% tal_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
tal_nonconverged_genes_mod1 <- unique((tal_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
tal_nonconverged_percentage_mod1 <- (length(unique(tal_nonconverged_genes_mod1))/length(unique(tal_model_df_mod1$Gene)))*100
tal_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(tal_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(tal_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F}
## compute emmean difference in POST - PRE in each treatment group
tal_emmeans_diff_mod1 <- tal_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
tal_emmeans_diff_placebo_mod1 <- tal_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/tal_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
tal_emmeans_diff_dapa_mod1 <- tal_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/tal_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
safe_pval <- function(t_stat, df, digits = 30) {
  logpt <- pt(q = abs(t_stat), df - 2, log.p = TRUE)
  explogpt <- exp(logpt)
  2*(1-as.numeric(sprintf(paste0("%.", digits, "e"), explogpt)))
}

## DiD (Differences in Differences)
tal_emmeans_diff_wide_mod1  <- tal_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

tal_emmeans_diff_DiD_mod1 <- tal_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(tal_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(tal_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(tal_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/tal_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
tal_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

tal_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(tal_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/tal_placebo_pvalue_mod1")

plot_volcano(tal_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/tal_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(tal_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/tal_dapa_pvalue_mod1")

plot_volcano(tal_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/tal_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(tal_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/tal_DiD_pvalue_mod1")

plot_volcano(tal_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/tal_DiD_adj_pvalue_mod1")

```

### PC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pc_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/pc_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
pc_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/pc_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
pc_model_filtered_mod1 <- pc_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pc_emmeans_filtered_mod1 <- pc_emmeans_df_mod1 %>%
  filter(Gene %in% pc_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
pc_nonconverged_genes_mod1 <- unique((pc_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pc_nonconverged_percentage_mod1 <- (length(unique(pc_nonconverged_genes_mod1))/length(unique(pc_model_df_mod1$Gene)))*100
pc_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(pc_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(pc_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pc_emmeans_diff_mod1 <- pc_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pc_emmeans_diff_placebo_mod1 <- pc_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pc_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
pc_emmeans_diff_dapa_mod1 <- pc_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pc_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pc_emmeans_diff_wide_mod1  <- pc_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pc_emmeans_diff_DiD_mod1 <- pc_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(pc_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pc_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pc_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/pc_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pc_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pc_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(pc_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pc_placebo_pvalue_mod1")

plot_volcano(pc_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pc_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(pc_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pc_dapa_pvalue_mod1")

plot_volcano(pc_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pc_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(pc_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/pc_DiD_pvalue_mod1")

plot_volcano(pc_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/pc_DiD_adj_pvalue_mod1")
```



### Immune (very few cells)
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
immune_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/immune_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
immune_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/immune_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
immune_model_filtered_mod1 <- immune_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
immune_emmeans_filtered_mod1 <- immune_emmeans_df_mod1 %>%
  filter(Gene %in% immune_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
immune_nonconverged_genes_mod1 <- unique((immune_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
immune_nonconverged_percentage_mod1 <- (length(unique(immune_nonconverged_genes_mod1))/length(unique(immune_model_df_mod1$Gene)))*100
immune_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(immune_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(immune_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
immune_emmeans_diff_mod1 <- immune_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
immune_emmeans_diff_placebo_mod1 <- immune_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/immune_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
immune_emmeans_diff_dapa_mod1 <- immune_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/immune_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
immune_emmeans_diff_wide_mod1  <- immune_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

immune_emmeans_diff_DiD_mod1 <- immune_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(immune_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(immune_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(immune_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/immune_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
immune_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

immune_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(immune_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/immune_placebo_pvalue_mod1")

plot_volcano(immune_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/immune_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(immune_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/immune_dapa_pvalue_mod1")

plot_volcano(immune_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/immune_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(immune_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/immune_DiD_pvalue_mod1")

plot_volcano(immune_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/immune_DiD_adj_pvalue_mod1")
```
### IC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ic_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/ic_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
ic_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/ic_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
ic_model_filtered_mod1 <- ic_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ic_emmeans_filtered_mod1 <- ic_emmeans_df_mod1 %>%
  filter(Gene %in% ic_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ic_nonconverged_genes_mod1 <- unique((ic_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ic_nonconverged_percentage_mod1 <- (length(unique(ic_nonconverged_genes_mod1))/length(unique(ic_model_df_mod1$Gene)))*100
ic_nonconverged_percentage_mod1

```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(ic_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(ic_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ic_emmeans_diff_mod1 <- ic_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ic_emmeans_diff_placebo_mod1 <- ic_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ic_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
ic_emmeans_diff_dapa_mod1 <- ic_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ic_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ic_emmeans_diff_wide_mod1  <- ic_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ic_emmeans_diff_DiD_mod1 <- ic_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(ic_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ic_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ic_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ic_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ic_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ic_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(ic_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ic_placebo_pvalue_mod1")

plot_volcano(ic_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ic_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(ic_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ic_dapa_pvalue_mod1")

plot_volcano(ic_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ic_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(ic_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ic_DiD_pvalue_mod1")

plot_volcano(ic_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ic_DiD_adj_pvalue_mod1")
```

### EC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ec_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/ec_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
ec_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/ec_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
ec_model_filtered_mod1 <- ec_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ec_emmeans_filtered_mod1 <- ec_emmeans_df_mod1 %>%
  filter(Gene %in% ec_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ec_nonconverged_genes_mod1 <- unique((ec_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ec_nonconverged_percentage_mod1 <- (length(unique(ec_nonconverged_genes_mod1))/length(unique(ec_model_df_mod1$Gene)))*100
ec_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(ec_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(ec_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ec_emmeans_diff_mod1 <- ec_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ec_emmeans_diff_placebo_mod1 <- ec_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ec_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
ec_emmeans_diff_dapa_mod1 <- ec_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ec_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ec_emmeans_diff_wide_mod1  <- ec_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ec_emmeans_diff_DiD_mod1 <- ec_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(ec_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ec_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ec_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/ec_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ec_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ec_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(ec_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ec_placebo_pvalue_mod1")

plot_volcano(ec_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ec_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(ec_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ec_dapa_pvalue_mod1")

plot_volcano(ec_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ec_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(ec_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/ec_DiD_pvalue_mod1")

plot_volcano(ec_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/ec_DiD_adj_pvalue_mod1")
```


### DTL (very few cells)
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
dtl_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/dtl_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
dtl_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/dtl_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
dtl_model_filtered_mod1 <- dtl_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
dtl_emmeans_filtered_mod1 <- dtl_emmeans_df_mod1 %>%
  filter(Gene %in% dtl_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
dtl_nonconverged_genes <- unique((dtl_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
(length(unique(dtl_nonconverged_genes))/length(unique(dtl_model_df_mod1$Gene)))*100
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(dtl_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(dtl_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
dtl_emmeans_diff_mod1 <- dtl_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
dtl_emmeans_diff_placebo_mod1 <- dtl_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
dtl_emmeans_diff_dapa_mod1 <- dtl_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
dtl_emmeans_diff_wide_mod1  <- dtl_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

dtl_emmeans_diff_DiD_mod1 <- dtl_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(dtl_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(dtl_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
## write.csv(dtl_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
dtl_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

dtl_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
fibvsmcp_model_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/fibvsmcp_attempt_scrna_mm_model_combined_counts.rds")

## read emmeans dataframe (rendered in Hyak)
fibvsmcp_emmeans_df_mod1 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/1 Nested visit and zero inflation/fibvsmcp_attempt_scrna_mm_emmeans_combined_counts.rds")
```

```{r echo = F}
## keep converged model results only
fibvsmcp_model_filtered_mod1 <- fibvsmcp_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
fibvsmcp_emmeans_filtered_mod1 <- fibvsmcp_emmeans_df_mod1 %>%
  filter(Gene %in% fibvsmcp_model_filtered_mod1$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
fibvsmcp_nonconverged_genes_mod1 <- unique((fibvsmcp_model_df_mod1 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)

fibvsmcp_nonconverged_percentage_mod1 <- (length(unique(fibvsmcp_nonconverged_genes_mod1))/length(unique(fibvsmcp_model_df_mod1$Gene)))*100
fibvsmcp_nonconverged_percentage_mod1
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod1 <- subset(fibvsmcp_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod1$Gene, levels = ordered_model_mod1$Gene)
sig_genes <- subset(fibvsmcp_model_filtered_mod1, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
fibvsmcp_emmeans_diff_mod1 <- fibvsmcp_emmeans_filtered_mod1 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
fibvsmcp_emmeans_diff_placebo_mod1 <- fibvsmcp_emmeans_diff_mod1 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_placebo_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_placebo_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/fibvsmcp_emmeans_diff_placebo_zi.csv", row.names = F)

### Dapa
fibvsmcp_emmeans_diff_dapa_mod1 <- fibvsmcp_emmeans_diff_mod1 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_dapa_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_dapa_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/fibvsmcp_emmeans_diff_dapa_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
fibvsmcp_emmeans_diff_wide_mod1  <- fibvsmcp_emmeans_diff_mod1 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

fibvsmcp_emmeans_diff_DiD_mod1 <- fibvsmcp_emmeans_diff_wide_mod1  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
                SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
                t_stat_DiD = DiD / SE_DiD,  ## t-statistic
                p_value_DiD = safe_pval(t_stat_DiD, nrow(fibvsmcp_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(fibvsmcp_emmeans_diff_DiD_mod1) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(fibvsmcp_emmeans_diff_DiD_mod1, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/1 Nested visit and zero inflation/fibvsmcp_emmeans_diff_DiD_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
fibvsmcp_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

fibvsmcp_emmeans_diff_mod1 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(fibvsmcp_emmeans_diff_placebo_mod1,  "Expr Other", "Expr p-value",
             "Model 1 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_placebo_pvalue_mod1")

plot_volcano(fibvsmcp_emmeans_diff_placebo_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_placebo_adj_pvalue_mod1")
# Dapa
plot_volcano(fibvsmcp_emmeans_diff_dapa_mod1,  "Expr Other", "Expr p-value",
             "Model 1 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_dapa_pvalue_mod1")

plot_volcano(fibvsmcp_emmeans_diff_dapa_mod1,  "Expr Other", "Expr False Discovery Rate", 
             "Model 1 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_dapa_adj_pvalue_mod1")

# DiD
plot_volcano(fibvsmcp_emmeans_diff_DiD_mod1,  "Expr Other", "Expr p-value", "Model 1 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_DiD_pvalue_mod1")

plot_volcano(fibvsmcp_emmeans_diff_DiD_mod1,  "Expr Other", "Expr False Discovery Rate", "Model 1 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/1 Nested visit and zero inflation/fibvsmcp_DiD_adj_pvalue_mod1")
```


## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_DiD_pathways.xls", skip = 1) 
pt_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_dapa_pathways.xls", skip = 1) 
pt_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pt_placebo_pathways.xls", skip = 1) 

colnames(pt_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_mod1 <- pt_pathways_mod1 %>%
  full_join(pt_dapa_mod1) %>% full_join(pt_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_mod1$scenario <- factor(pt_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_mod1 <- pt_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_mod1$pathway <- reorder(pt_pathways_inhibited_mod1$pathway, pt_pathways_inhibited_mod1$neg_log_p)
  
pt_top30_inhibited_mod1 <- pt_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_mod1 <- pt_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_mod1$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_mod1))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_mod1 + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_mod1 <- pt_pathways_inhibited_mod1 %>%
  filter(z <= -2)
pt_top30_inhibited_2_mod1 <- pt_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_mod1$z), max(-pt_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) 

## top30_inhibited_mod1 + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_mod1 <- pt_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_mod1$pathway <- reorder(pt_pathways_activated_mod1$pathway, pt_pathways_activated_mod1$neg_log_p)
  
pt_top30_activated_mod1 <- pt_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_mod1 <- pt_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_mod1 <- pt_pathways_activated_mod1 %>%
  filter(z > 2)
pt_top30_activated_2_mod1 <- pt_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_mod1$z), max(pt_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pt_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_mod1 <- pt_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_mod1$name <- factor(pt_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pt_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_mod1 <- pt_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_mod1$name <- factor(pt_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_mod1
pt_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pt_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_DiD_pathways.xls", skip = 1) 
tal_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_dapa_pathways.xls", skip = 1) 
tal_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/tal_placebo_pathways.xls", skip = 1) 

colnames(tal_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_mod1 <- tal_pathways_mod1 %>%
  full_join(tal_dapa_mod1) %>% full_join(tal_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_mod1$scenario <- factor(tal_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_mod1 <- tal_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_mod1$pathway <- reorder(tal_pathways_inhibited_mod1$pathway, tal_pathways_inhibited_mod1$neg_log_p)
  
tal_top30_inhibited_mod1 <- tal_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_mod1 <- tal_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_mod1 <- tal_pathways_inhibited_mod1 %>%
  filter(z < -2)
tal_top30_inhibited_2_mod1 <- tal_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_mod1$z), max(-tal_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_mod1 <- tal_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_mod1$pathway <- reorder(tal_pathways_activated_mod1$pathway, tal_pathways_activated_mod1$neg_log_p)
  
tal_top30_activated_mod1 <- tal_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 2.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_mod1 <- tal_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_mod1 <- tal_pathways_activated_mod1 %>%
  filter(z > 2)
tal_top30_activated_2_mod1 <- tal_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_mod1$z), max(tal_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/tal_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_mod1 <- tal_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_mod1$name <- factor(tal_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/tal_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_mod1 <- tal_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_mod1$name <- factor(tal_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_mod1
tal_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/tal_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_DiD_pathways.xls", skip = 1) 
pc_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_dapa_pathways.xls", skip = 1) 
pc_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/pc_placebo_pathways.xls", skip = 1) 

colnames(pc_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_mod1 <- pc_pathways_mod1 %>%
  full_join(pc_dapa_mod1) %>% full_join(pc_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_mod1$scenario <- factor(pc_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_mod1 <- pc_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_mod1$pathway <- reorder(pc_pathways_inhibited_mod1$pathway, pc_pathways_inhibited_mod1$neg_log_p)
  
pc_top30_inhibited_mod1 <- pc_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_mod1 <- pc_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_mod1 <- pc_pathways_inhibited_mod1 %>%
  filter(z < -2)
pc_top30_inhibited_2_mod1 <- pc_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_mod1$z), max(-pc_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_mod1 <- pc_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_mod1$pathway <- reorder(pc_pathways_activated_mod1$pathway, pc_pathways_activated_mod1$neg_log_p)
  
pc_top30_activated_mod1 <- pc_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_mod1 <- pc_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_mod1 <- pc_pathways_activated_mod1 %>%
  filter(z > 2)
pc_top30_activated_2_mod1 <- pc_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_mod1$z), max(pc_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/pc_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_mod1 <- pc_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_mod1$name <- factor(pc_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pc_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_mod1 <- pc_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_mod1$name <- factor(pc_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_mod1
pc_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/pc_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_DiD_pathways.xls", skip = 1) 
immune_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_dapa_pathways.xls", skip = 1) 
immune_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/immune_placebo_pathways.xls", skip = 1) 

colnames(immune_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_mod1 <- immune_pathways_mod1 %>%
  full_join(immune_dapa_mod1) %>% full_join(immune_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_mod1$scenario <- factor(immune_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_mod1 <- immune_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_mod1$pathway <- reorder(immune_pathways_inhibited_mod1$pathway, immune_pathways_inhibited_mod1$neg_log_p)
  
immune_top30_inhibited_mod1 <- immune_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_mod1 <- immune_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_mod1 <- immune_pathways_inhibited_mod1 %>%
  filter(z < -2)
immune_top30_inhibited_2_mod1 <- immune_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_mod1$z), max(-immune_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_mod1 <- immune_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_mod1$pathway <- reorder(immune_pathways_activated_mod1$pathway, immune_pathways_activated_mod1$neg_log_p)
  
immune_top30_activated_mod1 <- immune_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_mod1 <- immune_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_mod1 <- immune_pathways_activated_mod1 %>%
  filter(z > 2)
immune_top30_activated_2_mod1 <- immune_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_mod1$z), max(immune_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/immune_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_mod1 <- immune_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_mod1$name <- factor(immune_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/immune_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_mod1 <- immune_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_mod1$name <- factor(immune_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_mod1
immune_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/immune_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_DiD_pathways.xls", skip = 1) 
ic_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_dapa_pathways.xls", skip = 1) 
ic_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ic_placebo_pathways.xls", skip = 1) 

colnames(ic_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_mod1 <- ic_pathways_mod1 %>%
  full_join(ic_dapa_mod1) %>% full_join(ic_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_mod1$scenario <- factor(ic_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_mod1 <- ic_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_mod1$pathway <- reorder(ic_pathways_inhibited_mod1$pathway, ic_pathways_inhibited_mod1$neg_log_p)
  
ic_top30_inhibited_mod1 <- ic_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_mod1 <- ic_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_mod1 <- ic_pathways_inhibited_mod1 %>%
  filter(z < -2)
ic_top30_inhibited_2_mod1 <- ic_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_mod1$z), max(-ic_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_mod1 <- ic_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_mod1$pathway <- reorder(ic_pathways_activated_mod1$pathway, ic_pathways_activated_mod1$neg_log_p)
  
ic_top30_activated_mod1 <- ic_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_mod1 <- ic_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_mod1 <- ic_pathways_activated_mod1 %>%
  filter(z > 2)
ic_top30_activated_2_mod1 <- ic_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_mod1$z), max(ic_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ic_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_mod1 <- ic_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_mod1$name <- factor(ic_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ic_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_mod1 <- ic_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_mod1$name <- factor(ic_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_mod1
ic_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ic_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_DiD_pathways.xls", skip = 1) 
ec_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_dapa_pathways.xls", skip = 1) 
ec_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/ec_placebo_pathways.xls", skip = 1) 

colnames(ec_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_mod1 <- ec_pathways_mod1 %>%
  full_join(ec_dapa_mod1) %>% full_join(ec_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_mod1$scenario <- factor(ec_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_mod1 <- ec_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_mod1$pathway <- reorder(ec_pathways_inhibited_mod1$pathway, ec_pathways_inhibited_mod1$neg_log_p)
  
ec_top30_inhibited_mod1 <- ec_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_mod1 <- ec_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_mod1 <- ec_pathways_inhibited_mod1 %>%
  filter(z < -2)
ec_top30_inhibited_2_mod1 <- ec_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_mod1$z), max(-ec_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_mod1 <- ec_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_mod1$pathway <- reorder(ec_pathways_activated_mod1$pathway, ec_pathways_activated_mod1$neg_log_p)
  
ec_top30_activated_mod1 <- ec_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_mod1 <- ec_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_mod1 <- ec_pathways_activated_mod1 %>%
  filter(z > 2)
ec_top30_activated_2_mod1 <- ec_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_mod1$z), max(ec_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/ec_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_mod1 <- ec_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_mod1$name <- factor(ec_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ec_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_mod1 <- ec_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_mod1$name <- factor(ec_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_mod1
ec_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/ec_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_DiD_pathways.xls", skip = 1) 
dtl_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_dapa_pathways.xls", skip = 1) 
dtl_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/dtl_placebo_pathways.xls", skip = 1) 

colnames(dtl_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_mod1 <- dtl_pathways_mod1 %>%
  full_join(dtl_dapa_mod1) %>% full_join(dtl_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_mod1$scenario <- factor(dtl_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_mod1 <- dtl_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_mod1$pathway <- reorder(dtl_pathways_inhibited_mod1$pathway, dtl_pathways_inhibited_mod1$neg_log_p)
  
dtl_top30_inhibited_mod1 <- dtl_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_mod1 <- dtl_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_mod1 <- dtl_pathways_inhibited_mod1 %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_mod1 <- dtl_pathways_inhibited_sig_mod1[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_mod1$z), max(-dtl_pathways_inhibited_sig_mod1$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top_inhibited_pathways_2.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_mod1 <- dtl_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_mod1$pathway <- reorder(dtl_pathways_activated_mod1$pathway, dtl_pathways_activated_mod1$neg_log_p)
  
dtl_top30_activated_mod1 <- dtl_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_mod1 <- dtl_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_mod1 <- dtl_pathways_activated_mod1 %>%
  filter(z > 2)
dtl_top30_activated_2_mod1 <- dtl_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_mod1$z), max(dtl_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/dtl_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_mod1 <- dtl_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_mod1$name <- factor(dtl_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/dtl_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_mod1 <- dtl_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_mod1$name <- factor(dtl_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_mod1
dtl_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/dtl_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_DiD_pathways.xls", skip = 1) 
fibvsmcp_dapa_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_dapa_pathways.xls", skip = 1) 
fibvsmcp_placebo_mod1 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/1 Nested visit and zero inflation/fibvsmcp_placebo_pathways.xls", skip = 1) 

colnames(fibvsmcp_pathways_mod1) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_mod1) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_placebo_mod1) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_mod1 <- fibvsmcp_pathways_mod1 %>%
  full_join(fibvsmcp_dapa_mod1) %>% full_join(fibvsmcp_placebo_mod1) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_mod1$scenario <- factor(fibvsmcp_pathways_merged_mod1$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_mod1 <- fibvsmcp_pathways_merged_mod1 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_mod1$pathway <- reorder(fibvsmcp_pathways_inhibited_mod1$pathway, fibvsmcp_pathways_inhibited_mod1$neg_log_p)
  
fibvsmcp_top30_inhibited_mod1 <- fibvsmcp_pathways_inhibited_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_mod1 <- fibvsmcp_pathways_inhibited_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top30_inhibited_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_mod1 <- fibvsmcp_pathways_inhibited_mod1 %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_mod1 <- fibvsmcp_pathways_inhibited_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_mod1$z), max(-fibvsmcp_pathways_inhibited_sig_mod1$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_mod1 <- fibvsmcp_pathways_merged_mod1 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_mod1$pathway <- reorder(fibvsmcp_pathways_activated_mod1$pathway, fibvsmcp_pathways_activated_mod1$neg_log_p)
  
fibvsmcp_top30_activated_mod1 <- fibvsmcp_pathways_activated_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_mod1 <- fibvsmcp_pathways_activated_mod1 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top30_activated_pathways_mod1.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_mod1 <- fibvsmcp_pathways_activated_mod1 %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_mod1 <- fibvsmcp_pathways_activated_sig_mod1[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_mod1$z), max(fibvsmcp_pathways_activated_sig_mod1$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/1 Nested visit and zero inflation/fibvsmcp_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_mod1 <- fibvsmcp_pathways_merged_mod1 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_mod1$name <- factor(fibvsmcp_neg_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/fibvsmcp_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_mod1 <- fibvsmcp_pathways_merged_mod1 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_mod1$name <- factor(fibvsmcp_pos_pathways_merged_long_mod1$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_mod1
fibvsmcp_pos_pathways_merged_long_mod1 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/1 Nested visit and zero inflation/fibvsmcp_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

# Model 2 (NO Nested visit + ZIF)
## emmeans
### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pt_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/pt_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
pt_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/pt_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F}
## keep converged model results only
pt_model_filtered_mod2 <- pt_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pt_emmeans_filtered_mod2 <- pt_emmeans_df_mod2 %>%
  filter(Gene %in% pt_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))

## non-converged genes percentage
pt_nonconverged_genes_mod2 <- unique((pt_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pt_nonconverged_percentage_mod2 <- (length(unique(pt_nonconverged_genes_mod2))/length(unique(pt_model_df_mod2$Gene)))*100
pt_nonconverged_percentage_mod2
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(pt_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(pt_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pt_emmeans_diff_mod2 <- pt_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pt_emmeans_diff_placebo_mod2 <- pt_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pt_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
pt_emmeans_diff_dapa_mod2 <- pt_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pt_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pt_emmeans_diff_wide_mod2  <- pt_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pt_emmeans_diff_DiD_mod2 <- pt_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(pt_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pt_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pt_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pt_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pt_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pt_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots

```{r echo = F, eval = F}
# Placebo
plot_volcano(pt_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_placebo_pvalue_mod2")

plot_volcano(pt_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(pt_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_dapa_pvalue_mod2")

plot_volcano(pt_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(pt_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_DiD_pvalue_mod2")

plot_volcano(pt_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pt_DiD_adj_pvalue_mod2")
```



### TAL
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
tal_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/tal_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
tal_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/tal_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
tal_model_filtered_mod2 <- tal_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
tal_emmeans_filtered_mod2 <- tal_emmeans_df_mod2 %>%
  filter(Gene %in% tal_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
tal_nonconverged_genes_mod2 <- unique((tal_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
tal_nonconverged_percentage_mod2 <- (length(unique(tal_nonconverged_genes_mod2))/length(unique(tal_model_df_mod2$Gene)))*100
tal_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(tal_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(tal_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
tal_emmeans_diff_mod2 <- tal_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
tal_emmeans_diff_placebo_mod2 <- tal_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/tal_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
tal_emmeans_diff_dapa_mod2 <- tal_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/tal_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
tal_emmeans_diff_wide_mod2  <- tal_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

tal_emmeans_diff_DiD_mod2 <- tal_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(tal_emmeans_diff_mod1))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(tal_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(tal_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/tal_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
tal_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

tal_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(tal_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_placebo_pvalue_mod2")

plot_volcano(tal_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(tal_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_dapa_pvalue_mod2")

plot_volcano(tal_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(tal_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_DiD_pvalue_mod2")

plot_volcano(tal_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/tal_DiD_adj_pvalue_mod2")
```




### PC
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
pc_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/pc_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
pc_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/pc_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
pc_model_filtered_mod2 <- pc_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pc_emmeans_filtered_mod2 <- pc_emmeans_df_mod2 %>%
  filter(Gene %in% pc_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
pc_nonconverged_genes_mod2 <- unique((pc_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pc_nonconverged_percentage_mod2 <- (length(unique(pc_nonconverged_genes_mod2))/length(unique(pc_model_df_mod2$Gene)))*100
pc_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(pc_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(pc_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
pc_emmeans_diff_mod2 <- pc_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pc_emmeans_diff_placebo_mod2 <- pc_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pc_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
pc_emmeans_diff_dapa_mod2 <- pc_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pc_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
pc_emmeans_diff_wide_mod2  <- pc_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pc_emmeans_diff_DiD_mod2 <- pc_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(pc_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pc_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pc_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/pc_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
pc_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pc_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(pc_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_placebo_pvalue_mod2")

plot_volcano(pc_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(pc_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_dapa_pvalue_mod2")

plot_volcano(pc_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(pc_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_DiD_pvalue_mod2")

plot_volcano(pc_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/pc_DiD_adj_pvalue_mod2")
```


### Immune (very few cells)
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
immune_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/immune_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
immune_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/immune_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
immune_model_filtered_mod2 <- immune_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
immune_emmeans_filtered_mod2 <- immune_emmeans_df_mod2 %>%
  filter(Gene %in% immune_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
immune_nonconverged_genes_mod2 <- unique((immune_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
immune_nonconverged_percentage_mod2 <- (length(unique(immune_nonconverged_genes_mod2))/length(unique(immune_model_df_mod2$Gene)))*100
immune_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(immune_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(immune_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
immune_emmeans_diff_mod2 <- immune_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
immune_emmeans_diff_placebo_mod2 <- immune_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/immune_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
immune_emmeans_diff_dapa_mod2 <- immune_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/immune_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
immune_emmeans_diff_wide_mod2  <- immune_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

immune_emmeans_diff_DiD_mod2 <- immune_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(immune_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(immune_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(immune_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/immune_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
immune_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

immune_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(immune_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_placebo_pvalue_mod2")

plot_volcano(immune_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(immune_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_dapa_pvalue_mod2")

plot_volcano(immune_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(immune_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_DiD_pvalue_mod2")

plot_volcano(immune_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/immune_DiD_adj_pvalue_mod2")
```


### IC
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
ic_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/ic_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
ic_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/ic_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
ic_model_filtered_mod2 <- ic_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ic_emmeans_filtered_mod2 <- ic_emmeans_df_mod2 %>%
  filter(Gene %in% ic_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ic_nonconverged_genes_mod2 <- unique((ic_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ic_nonconverged_percentage_mod2 <- (length(unique(ic_nonconverged_genes_mod2))/length(unique(ic_model_df_mod2$Gene)))*100
ic_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(ic_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(ic_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
ic_emmeans_diff_mod2 <- ic_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ic_emmeans_diff_placebo_mod2 <- ic_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ic_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
ic_emmeans_diff_dapa_mod2 <- ic_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ic_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
ic_emmeans_diff_wide_mod2  <- ic_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ic_emmeans_diff_DiD_mod2 <- ic_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(ic_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ic_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ic_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ic_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
ic_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ic_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(ic_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_placebo_pvalue_mod2")

plot_volcano(ic_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(ic_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_dapa_pvalue_mod2")

plot_volcano(ic_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(ic_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_DiD_pvalue_mod2")

plot_volcano(ic_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ic_DiD_adj_pvalue_mod2")
```



### EC
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
ec_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/ec_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
ec_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/ec_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
ec_model_filtered_mod2 <- ec_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ec_emmeans_filtered_mod2 <- ec_emmeans_df_mod2 %>%
  filter(Gene %in% ec_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ec_nonconverged_genes_mod2 <- unique((ec_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ec_nonconverged_percentage_mod2 <- (length(unique(ec_nonconverged_genes_mod2))/length(unique(ec_model_df_mod2$Gene)))*100
ec_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(ec_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(ec_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
ec_emmeans_diff_mod2 <- ec_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ec_emmeans_diff_placebo_mod2 <- ec_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ec_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
ec_emmeans_diff_dapa_mod2 <- ec_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ec_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
ec_emmeans_diff_wide_mod2  <- ec_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ec_emmeans_diff_DiD_mod2 <- ec_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(ic_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ec_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ec_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/ec_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
ec_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ec_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(ec_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_placebo_pvalue_mod2")

plot_volcano(ec_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(ec_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_dapa_pvalue_mod2")

plot_volcano(ec_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(ec_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_DiD_pvalue_mod2")

plot_volcano(ec_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/ec_DiD_adj_pvalue_mod2")
```


### DTL (very few cells)
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
dtl_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/dtl_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
dtl_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/dtl_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
dtl_model_filtered_mod2 <- dtl_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
dtl_emmeans_filtered_mod2 <- dtl_emmeans_df_mod2 %>%
  filter(Gene %in% dtl_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
dtl_nonconverged_genes <- unique((dtl_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
(length(unique(dtl_nonconverged_genes))/length(unique(dtl_model_df_mod2$Gene)))*100
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(dtl_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(dtl_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
dtl_emmeans_diff_mod2 <- dtl_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
dtl_emmeans_diff_placebo_mod2 <- dtl_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
dtl_emmeans_diff_dapa_mod2 <- dtl_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
dtl_emmeans_diff_wide_mod2  <- dtl_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

dtl_emmeans_diff_DiD_mod2 <- dtl_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(dtl_emmeans_diff))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(dtl_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
## write.csv(dtl_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/dtl_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
dtl_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

dtl_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

### FIB/VSMC/P
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
fibvsmcp_model_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/fibvsmcp_attempt_scrna_mm_model_combined_2_counts.rds")

## read emmeans dataframe (rendered in Hyak)
fibvsmcp_emmeans_df_mod2 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/kopah/2 Zero inflation and no nested visit/fibvsmcp_attempt_scrna_mm_emmeans_combined_2_counts.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
fibvsmcp_model_filtered_mod2 <- fibvsmcp_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
fibvsmcp_emmeans_filtered_mod2 <- fibvsmcp_emmeans_df_mod2 %>%
  filter(Gene %in% fibvsmcp_model_filtered_mod2$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
fibvsmcp_nonconverged_genes_mod2 <- unique((fibvsmcp_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
fibvsmcp_nonconverged_percentage_mod2 <- (length(unique(fibvsmcp_nonconverged_genes_mod2))/length(unique(fibvsmcp_model_df_mod2$Gene)))*100
fibvsmcp_nonconverged_percentage_mod2
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod2 <- subset(fibvsmcp_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod2$Gene, levels = ordered_model_mod2$Gene)
sig_genes <- subset(fibvsmcp_model_filtered_mod2, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
fibvsmcp_emmeans_diff_mod2 <- fibvsmcp_emmeans_filtered_mod2 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
fibvsmcp_emmeans_diff_placebo_mod2 <- fibvsmcp_emmeans_diff_mod2 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_placebo_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_placebo_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/fibvsmcp_emmeans_diff_placebo_2_zi.csv", row.names = F)

### Dapa
fibvsmcp_emmeans_diff_dapa_mod2 <- fibvsmcp_emmeans_diff_mod2 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_dapa_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_dapa_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/fibvsmcp_emmeans_diff_dapa_2_zi.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
fibvsmcp_emmeans_diff_wide_mod2  <- fibvsmcp_emmeans_diff_mod2 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

fibvsmcp_emmeans_diff_DiD_mod2 <- fibvsmcp_emmeans_diff_wide_mod2  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(fibvsmcp_emmeans_diff_mod2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(fibvsmcp_emmeans_diff_DiD_mod2) <- c("Gene", "Expr Other",  "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(fibvsmcp_emmeans_diff_DiD_mod2, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/2 Zero inflation and no nested visit/fibvsmcp_emmeans_diff_DiD_2_zi.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
fibvsmcp_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

fibvsmcp_emmeans_diff_mod2 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F, eval = F}
# Placebo
plot_volcano(fibvsmcp_emmeans_diff_placebo_mod2,  "Expr Other", "Expr p-value",
             "Model 2 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_placebo_pvalue_mod2")

plot_volcano(fibvsmcp_emmeans_diff_placebo_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_placebo_adj_pvalue_mod2")
# Dapa
plot_volcano(fibvsmcp_emmeans_diff_dapa_mod2,  "Expr Other", "Expr p-value",
             "Model 2 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_dapa_pvalue_mod2")

plot_volcano(fibvsmcp_emmeans_diff_dapa_mod2,  "Expr Other", "Expr False Discovery Rate", 
             "Model 2 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_dapa_adj_pvalue_mod2")

# DiD
plot_volcano(fibvsmcp_emmeans_diff_DiD_mod2,  "Expr Other", "Expr p-value", "Model 2 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_DiD_pvalue_mod2")

plot_volcano(fibvsmcp_emmeans_diff_DiD_mod2,  "Expr Other", "Expr False Discovery Rate", "Model 2 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "ZI/2 Zero inflation and no nested visit/fibvsmcp_DiD_adj_pvalue_mod2")
```


## Troubleshooting...
```{r echo = F, eval = F}
## PT
pt_nonconverged_genes_mod2 <- (pt_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pt_nonconverged_genes_mod2))/length(unique(pt_model_df_mod2$Gene)))*100
## TAL
tal_nonconverged_genes_mod2 <- (tal_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(tal_nonconverged_genes_mod2))/length(unique(tal_model_df_mod2$Gene)))*100
## PC
pc_nonconverged_genes_mod2 <- (pc_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pc_nonconverged_genes_mod2))/length(unique(pc_model_df_mod2$Gene)))*100
## Immune
immune_nonconverged_genes_mod2 <- (immune_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(immune_nonconverged_genes_mod2))/length(unique(immune_model_df_mod2$Gene)))*100
## IC
ic_nonconverged_genes_mod2 <- (ic_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ic_nonconverged_genes_mod2))/length(unique(ic_model_df_mod2$Gene)))*100
## EC
ec_nonconverged_genes_mod2 <- (ec_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ec_nonconverged_genes_mod2))/length(unique(ec_model_df_mod2$Gene)))*100
## DTL
## dtl_nonconverged_genes_mod2 <- (dtl_model_df_mod2 %>%
##   group_by(Gene) %>%
##   filter(all(is.na(PValue))))$Gene
## (length(unique(dtl_nonconverged_genes_mod2))/length(unique(dtl_model_df_mod2$Gene)))*100
## FIB/VSMC/P
fibvsmcp_nonconverged_genes_mod2 <- (fibvsmcp_model_df_mod2 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(fibvsmcp_nonconverged_genes_mod2))/length(unique(fibvsmcp_model_df_mod2$Gene)))*100

nonconverged_list <- list(pt = pt_nonconverged_genes_mod2,
                          immune = immune_nonconverged_genes_mod2,
                          ic = ic_nonconverged_genes_mod2,
                          ec = ec_nonconverged_genes_mod2,
                          #dtl = dtl_nonconverged_genes_mod2,
                          fibvsmcp = fibvsmcp_nonconverged_genes_mod2,
                          tal = tal_nonconverged_genes_mod2,
                          pc = pc_nonconverged_genes_mod2)
UpSetR::upset(fromList(nonconverged_list), order.by = "freq")
```

# nebula

### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_pt_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res.rds")

nebula_pt_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res_reml.rds")

nebula_pt_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res_reml_offset.rds")

nebula_pt_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_pt_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res_reml_pooled.rds")
```
#### ML
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence <- map_dfr(
  names(nebula_pt_results_list),
  function(gene_name) {
    converged <- nebula_pt_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged <- pt_nebula_convergence %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined <- map_dfr(
  names(nebula_pt_results_list),
  function(gene_name) {
    df <- nebula_pt_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pt_nebula_res_combined <- pt_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined <- map_dfr(
  names(nebula_pt_results_list),
  function(gene_name) {
    df <- nebula_pt_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PT", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula")

plot_volcano(pt_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PT", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula")
```
#### REML
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence_reml <- map_dfr(
  names(nebula_pt_results_list_reml),
  function(gene_name) {
    converged <- nebula_pt_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged_reml <- pt_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined_reml <- map_dfr(
  names(nebula_pt_results_list_reml),
  function(gene_name) {
    df <- nebula_pt_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
pt_nebula_res_combined_reml <- pt_nebula_res_combined_reml%>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined_reml <- map_dfr(
  names(nebula_pt_results_list_reml),
  function(gene_name) {
    df <- nebula_pt_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PT (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml")

plot_volcano(pt_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PT (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml")
```

#### REML + Offset
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_pt_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_pt_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged_reml_offset <- pt_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_pt_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pt_nebula_res_combined_reml_offset <- pt_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_pt_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PT (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_offset")

plot_volcano(pt_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PT (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_offset")
```
#### GSEA (fgsea)
```{r echo = F}
plot_fgsea_transpose <- function(fgsea_res,
                       top_n = 30,
                       title = "Top Enriched Pathways",
                       xmin = 0,
                       xmax = 3,
                       xnudge = (xmax - xmin)/100,
                       text1 = 6.5,
                       text2 = 18,
                       text3 = 20) {
  
  fgsea_res <- fgsea_res %>%
    arrange(pval) %>%
    head(top_n) %>%
    mutate(
      direction = case_when((NES < 0 & pval <= 0.05 ~ "Negative"), 
                            (NES > 0 & pval <= 0.05 ~ "Positive"),
                            (NES < 0 & pval > 0.05 ~ "Negative p > 0.05"), 
                            (NES > 0 & pval > 0.05 ~ "Positive p > 0.05")),
      face = case_when((NES < 0 & pval <= 0.05 ~ "bold"), 
                            (NES > 0 & pval <= 0.05 ~ "bold"),
                            (NES < 0 & pval > 0.05 ~ "plain"), 
                            (NES > 0 & pval > 0.05 ~ "plain")),
      pathway_clean = str_remove(pathway, "^KEGG_"), 
      pathway_clean = str_remove(pathway_clean, "^REACTOME_"), 
      pathway_clean = str_remove(pathway_clean, "^GOBP_"), 
      pathway_clean = str_remove(pathway_clean, "^GOMF_"), 
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_sentence(pathway_clean),
      pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
      pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
      pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
      pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
      pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
      pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
      pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
      pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
      pathway_clean = paste0(pathway_clean, " (", size, ")")
    ) %>%
    arrange(pval)
  
  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, -abs(fgsea_res$NES))
  
  fgsea_res %>%
    ggplot(aes(x = abs(NES), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = -log10(pval), color = direction, alpha = 0.8)) +
    # geom_vline(xintercept = 2, linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face), 
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0", 
                                  "Positive p > 0.05" = "#e18c80", "Negative p > 0.05" = "#7ab6d1")) +
    scale_x_continuous(limits = c(xmin, xmax), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "NES",
      y = "Pathways",
      color = "Direction",
      size = "-log(p-value)",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(), 
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}
```

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_nebula_reml_offset <- pt_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pt_nebula_reml_offset) <- pt_nebula_res_combined_reml_offset$Gene
rankings_pt_nebula_reml_offset <- sort(rankings_pt_nebula_reml_offset, decreasing = TRUE)
plot(rankings_pt_nebula_reml_offset)
min(rankings_pt_nebula_reml_offset)
max(rankings_pt_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_pt_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_pt_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_pt_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
##### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_pt_nebula_reml_offset, title = "PT nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.2, xmax = 2.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_pt_nebula_reml_offset, title = "PT nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.5, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea_transpose(go_res_pt_nebula_reml_offset, title = "PT nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```


#### REML + TMM Offset
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_pt_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_pt_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged_reml_tmm <- pt_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_pt_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pt_nebula_res_combined_reml_tmm <- pt_nebula_res_combined_reml_tmm%>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_pt_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PT (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_tmm")

plot_volcano(pt_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PT (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_tmm")
```

#### REML + pooled Offset
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_pt_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged_reml_pooled <- pt_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled%>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PT (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_pooled")

plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PT (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_pt_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# pt_nebula_res_combined_reml_pooled
pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
pt_nebula_pooled_ipa_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(pt_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
pt_nebula_pooled_ipa_placebo <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(pt_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
pt_nebula_pooled_ipa_dapa <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(pt_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_nebula_reml_pooled <- pt_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pt_nebula_reml_pooled) <- pt_nebula_res_combined_reml_pooled$Gene
rankings_pt_nebula_reml_pooled <- sort(rankings_pt_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_pt_nebula_reml_pooled)
min(rankings_pt_nebula_reml_pooled)
max(rankings_pt_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_pt_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_pt_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_pt_nebula_reml_pooled_pos <- kegg_legacy_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_pt_nebula_reml_pooled_neg <- kegg_legacy_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 3.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_pt_nebula_reml_pooled_pos <- reactome_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_pt_nebula_reml_pooled_neg <- reactome_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 4.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_pt_nebula_reml_pooled_pos <- go_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_pt_nebula_reml_pooled_neg <- go_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### TAL

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_tal_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res.rds")

nebula_tal_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml.rds")

nebula_tal_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_offset.rds")

nebula_tal_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_tal_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence <- map_dfr(
  names(nebula_tal_results_list),
  function(gene_name) {
    converged <- nebula_tal_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged <- tal_nebula_convergence %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined <- map_dfr(
  names(nebula_tal_results_list),
  function(gene_name) {
    df <- nebula_tal_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

tal_nebula_res_combined <- tal_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined <- map_dfr(
  names(nebula_tal_results_list),
  function(gene_name) {
    df <- nebula_tal_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "TAL", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula")

plot_volcano(tal_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "TAL", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml <- map_dfr(
  names(nebula_tal_results_list_reml),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml <- tal_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml <- map_dfr(
  names(nebula_tal_results_list_reml),
  function(gene_name) {
    df <- nebula_tal_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

tal_nebula_res_combined_reml <- tal_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined_reml <- map_dfr(
  names(nebula_tal_results_list_reml),
  function(gene_name) {
    df <- nebula_tal_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "TAL (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml")

plot_volcano(tal_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "TAL (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml_offset <- tal_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

tal_nebula_res_combined_reml_offset <- tal_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_tal_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "TAL (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_offset")

plot_volcano(tal_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "TAL (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_nebula_reml_offset <- tal_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_tal_nebula_reml_offset) <- tal_nebula_res_combined_reml_offset$Gene
rankings_tal_nebula_reml_offset <- sort(rankings_tal_nebula_reml_offset, decreasing = TRUE)
plot(rankings_tal_nebula_reml_offset)
min(rankings_tal_nebula_reml_offset)
max(rankings_tal_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_tal_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_tal_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_tal_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.3, xmax = 3.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.5, xmax = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_tal_nebula_reml_offset, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.5, xmax = 3.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_tal_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml_tmm <- tal_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_tal_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
tal_nebula_res_combined_reml_tmm <- tal_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_tal_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "TAL (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_tmm")

plot_volcano(tal_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "TAL (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_tmm")
```

#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml_pooled <- tal_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "TAL (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_pooled")

plot_volcano(tal_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "TAL (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_tal_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# tal_nebula_res_combined_reml_pooled
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
tal_nebula_pooled_ipa_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(tal_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
tal_nebula_pooled_ipa_placebo <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(tal_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
tal_nebula_pooled_ipa_dapa <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(tal_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_nebula_reml_pooled <- tal_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_tal_nebula_reml_pooled) <- tal_nebula_res_combined_reml_pooled$Gene
rankings_tal_nebula_reml_pooled <- sort(rankings_tal_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_tal_nebula_reml_pooled)
min(rankings_tal_nebula_reml_pooled)
max(rankings_tal_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_tal_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_tal_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_tal_nebula_reml_pooled_pos <- kegg_legacy_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_tal_nebula_reml_pooled_neg <- kegg_legacy_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_tal_nebula_reml_pooled_pos <- reactome_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_tal_nebula_reml_pooled_neg <- reactome_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_tal_nebula_reml_pooled_pos <- go_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_tal_nebula_reml_pooled_neg <- go_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### PC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_pc_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res.rds")

nebula_pc_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml.rds")

nebula_pc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_offset.rds")

nebula_pc_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_pc_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence <- map_dfr(
  names(nebula_pc_results_list),
  function(gene_name) {
    converged <- nebula_pc_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged <- pc_nebula_convergence %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined <- map_dfr(
  names(nebula_pc_results_list),
  function(gene_name) {
    df <- nebula_pc_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pc_nebula_res_combined <- pc_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined <- map_dfr(
  names(nebula_pc_results_list),
  function(gene_name) {
    df <- nebula_pc_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula")

plot_volcano(pc_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml <- map_dfr(
  names(nebula_pc_results_list_reml),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml <- pc_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml <- map_dfr(
  names(nebula_pc_results_list_reml),
  function(gene_name) {
    df <- nebula_pc_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
pc_nebula_res_combined_reml <- pc_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined_reml <- map_dfr(
  names(nebula_pc_results_list_reml),
  function(gene_name) {
    df <- nebula_pc_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml")

plot_volcano(pc_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml_offset <- pc_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pc_nebula_res_combined_reml_offset <- pc_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_pc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_offset")

plot_volcano(pc_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_offset")
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_pc_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml_tmm <- pc_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_pc_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pc_nebula_res_combined_reml_tmm <- pc_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_pc_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_tmm")

plot_volcano(pc_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_tmm")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml_pooled <- pc_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "PC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_pooled")

plot_volcano(pc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "PC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_pc_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# pc_nebula_res_combined_reml_pooled
pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
pc_nebula_pooled_ipa_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(pc_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
pc_nebula_pooled_ipa_placebo <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(pc_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
pc_nebula_pooled_ipa_dapa <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(pc_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_nebula_reml_pooled <- pc_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pc_nebula_reml_pooled) <- pc_nebula_res_combined_reml_pooled$Gene
rankings_pc_nebula_reml_pooled <- sort(rankings_pc_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_pc_nebula_reml_pooled)
min(rankings_pc_nebula_reml_pooled)
max(rankings_pc_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_pc_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_pc_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_pc_nebula_reml_pooled_pos <- kegg_legacy_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_pc_nebula_reml_pooled_neg <- kegg_legacy_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.1, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_pc_nebula_reml_pooled_pos <- reactome_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_pc_nebula_reml_pooled_neg <- reactome_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_pc_nebula_reml_pooled_pos <- go_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_pc_nebula_reml_pooled_neg <- go_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### Immune (very few cells)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res.rds")

nebula_immune_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml.rds")

nebula_immune_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_offset.rds")

nebula_immune_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_immune_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence <- map_dfr(
  names(nebula_immune_results_list),
  function(gene_name) {
    converged <- nebula_immune_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged <- immune_nebula_convergence %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined <- map_dfr(
  names(nebula_immune_results_list),
  function(gene_name) {
    df <- nebula_immune_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined <- immune_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined <- map_dfr(
  names(nebula_immune_results_list),
  function(gene_name) {
    df <- nebula_immune_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined <- immune_nebula_res_combined %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula")

plot_volcano(immune_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml <- map_dfr(
  names(nebula_immune_results_list_reml),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml <- immune_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml <- map_dfr(
  names(nebula_immune_results_list_reml),
  function(gene_name) {
    df <- nebula_immune_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
immune_nebula_res_combined_reml <- immune_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined_reml <- map_dfr(
  names(nebula_immune_results_list_reml),
  function(gene_name) {
    df <- nebula_immune_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml <- subset(immune_nebula_res_combined_reml, `logFC_treatmentDapagliflozin:visitPOST` <10)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml")

plot_volcano(immune_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml_offset <- immune_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml_offset <- immune_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_immune_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml_offset <- immune_nebula_res_combined_reml_offset %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_offset")

plot_volcano(immune_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_nebula_reml_offset <- pc_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pc_nebula_reml_offset) <- pc_nebula_res_combined_reml_offset$Gene
rankings_pc_nebula_reml_offset <- sort(rankings_pc_nebula_reml_offset, decreasing = TRUE)
plot(rankings_pc_nebula_reml_offset)
min(rankings_pc_nebula_reml_offset)
max(rankings_pc_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_pc_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_pc_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_pc_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_pc_nebula_reml_offset, title = "PC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.2, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_pc_nebula_reml_offset, title = "PC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.4, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_pc_nebula_reml_offset, title = "PC nebula Top 30 GO (REML & Library size offset)", xmin = 1.5, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_immune_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml_tmm <- immune_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_immune_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml_tmm <- immune_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_immune_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_tmm")

plot_volcano(immune_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_tmm")
```

#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml_pooled <- immune_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_pooled")

plot_volcano(immune_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_pooled")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_nebula_res_combined_reml_pooled
immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_nebula_pooled_ipa_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_nebula_pooled_ipa_placebo <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_nebula_pooled_ipa_dapa <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_nebula_reml_pooled <- immune_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_nebula_reml_pooled) <- immune_nebula_res_combined_reml_pooled$Gene
rankings_immune_nebula_reml_pooled <- sort(rankings_immune_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_nebula_reml_pooled)
min(rankings_immune_nebula_reml_pooled)
max(rankings_immune_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 0.9, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_nebula_reml_pooled_pos <- kegg_legacy_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_nebula_reml_pooled_neg <- kegg_legacy_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_nebula_reml_pooled_pos <- reactome_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_nebula_reml_pooled_neg <- reactome_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_nebula_reml_pooled, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_nebula_reml_pooled_pos <- go_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_nebula_reml_pooled_neg <- go_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### Immune (Myeloid)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_myeloid_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_myeloid_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_myeloid_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_myeloid_nebula_converged_reml_pooled <- immune_myeloid_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_myeloid_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_myeloid_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_myeloid_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10 & 
           `logFC_treatmentDapagliflozin:visitPOST`> -10)
```

```{r echo =F}
plot_volcano(immune_myeloid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune - Myeloid (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_myeloid_placebo_pvalue_nebula_reml_pooled")

plot_volcano(immune_myeloid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune - Myeloid (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_myeloid_placebo_pvalue_nebula_reml_pooled")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_myeloid_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_myeloid_nebula_res_combined_reml_pooled
immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_myeloid_nebula_pooled_ipa_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_myeloid_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_myeloid_nebula_pooled_ipa_placebo <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_myeloid_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_myeloid_nebula_pooled_ipa_dapa <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_myeloid_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_nebula_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_myeloid_nebula_reml_pooled) <- immune_myeloid_nebula_res_combined_reml_pooled$Gene
rankings_immune_myeloid_nebula_reml_pooled <- sort(rankings_immune_myeloid_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_myeloid_nebula_reml_pooled)
min(rankings_immune_myeloid_nebula_reml_pooled)
max(rankings_immune_myeloid_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered, title = "Immune - Myeloid (Myeloid) nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.05, xmax = 2.15)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_nebula_reml_pooled, title = "Immune - Myeloid (Myeloid) nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.3, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_myeloid_nebula_reml_pooled_pos <- reactome_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_myeloid_nebula_reml_pooled_neg <- reactome_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_nebula_reml_pooled, title = "Immune - Myeloid (Myeloid) nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_myeloid_nebula_reml_pooled_pos <- go_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_myeloid_nebula_reml_pooled_neg <- go_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### Immune (Lymphoid)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_lymphoid_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_lymphoid_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_lymphoid_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_lymphoid_nebula_converged_reml_pooled <- immune_lymphoid_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_lymphoid_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_lymphoid_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_lymphoid_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10 &
           `logFC_treatmentDapagliflozin:visitPOST` > -10)
```

```{r echo =F}
plot_volcano(immune_lymphoid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "Immune - Lymphoid (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_lymphoid_placebo_pvalue_nebula_reml_pooled")

plot_volcano(immune_lymphoid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "Immune - Lymphoid (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_lymphoid_placebo_pvalue_nebula_reml_pooled")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_lymphoid_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_lymphoid_nebula_res_combined_reml_pooled
immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_lymphoid_nebula_pooled_ipa_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_lymphoid_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_lymphoid_nebula_pooled_ipa_placebo <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_lymphoid_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_lymphoid_nebula_pooled_ipa_dapa <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_lymphoid_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_nebula_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_lymphoid_nebula_reml_pooled) <- immune_lymphoid_nebula_res_combined_reml_pooled$Gene
rankings_immune_lymphoid_nebula_reml_pooled <- sort(rankings_immune_lymphoid_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_lymphoid_nebula_reml_pooled)
min(rankings_immune_lymphoid_nebula_reml_pooled)
max(rankings_immune_lymphoid_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid  nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.38, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_lymphoid_nebula_reml_pooled_pos <- reactome_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_lymphoid_nebula_reml_pooled_neg <- reactome_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_lymphoid_nebula_reml_pooled_pos <- go_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_lymphoid_nebula_reml_pooled_neg <- go_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### IC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_ic_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res.rds")

nebula_ic_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml.rds")

nebula_ic_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_offset.rds")

nebula_ic_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_ic_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence <- map_dfr(
  names(nebula_ic_results_list),
  function(gene_name) {
    converged <- nebula_ic_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged <- ic_nebula_convergence %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined <- map_dfr(
  names(nebula_ic_results_list),
  function(gene_name) {
    df <- nebula_ic_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined <- ic_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined <- map_dfr(
  names(nebula_ic_results_list),
  function(gene_name) {
    df <- nebula_ic_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "IC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula")

plot_volcano(ic_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "IC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml <- map_dfr(
  names(nebula_ic_results_list_reml),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml <- ic_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml <- map_dfr(
  names(nebula_ic_results_list_reml),
  function(gene_name) {
    df <- nebula_ic_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined_reml <- ic_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined_reml <- map_dfr(
  names(nebula_ic_results_list_reml),
  function(gene_name) {
    df <- nebula_ic_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "IC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml")

plot_volcano(ic_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "IC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml_offset <- ic_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined_reml_offset <- ic_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_ic_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "IC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_offset")

plot_volcano(ic_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "IC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_nebula_reml_offset <- ic_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ic_nebula_reml_offset) <- ic_nebula_res_combined_reml_offset$Gene
rankings_ic_nebula_reml_offset <- sort(rankings_ic_nebula_reml_offset, decreasing = TRUE)
plot(rankings_ic_nebula_reml_offset)
min(rankings_ic_nebula_reml_offset)
max(rankings_ic_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_ic_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_ic_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_ic_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_ic_nebula_reml_offset, title = "IC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_ic_nebula_reml_offset, title = "IC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_ic_nebula_reml_offset, title = "IC nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_ic_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml_tmm <- ic_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_ic_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined_reml_tmm <- ic_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_ic_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "IC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_tmm")

plot_volcano(ic_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "IC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_tmm")
```

#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml_pooled <- ic_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "IC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_pooled")

plot_volcano(ic_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "IC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_ic_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# ic_nebula_res_combined_reml_pooled
ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
ic_nebula_pooled_ipa_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(ic_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
ic_nebula_pooled_ipa_placebo <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(ic_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
ic_nebula_pooled_ipa_dapa <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(ic_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_nebula_reml_pooled <- ic_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ic_nebula_reml_pooled) <- ic_nebula_res_combined_reml_pooled$Gene
rankings_ic_nebula_reml_pooled <- sort(rankings_ic_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_ic_nebula_reml_pooled)
min(rankings_ic_nebula_reml_pooled)
max(rankings_ic_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_ic_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_ic_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.35, xmax = 2.55)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_ic_nebula_reml_pooled_pos <- kegg_legacy_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_ic_nebula_reml_pooled_neg <- kegg_legacy_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.75, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_ic_nebula_reml_pooled_pos <- reactome_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_ic_nebula_reml_pooled_neg <- reactome_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 GO (REML & Library size offset)", xmin = 1.8, xmax = 2.9)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_ic_nebula_reml_pooled_pos <- go_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_ic_nebula_reml_pooled_neg <- go_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### EC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_ec_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res.rds")

nebula_ec_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml.rds")

nebula_ec_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_offset.rds")

nebula_ec_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_ec_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence <- map_dfr(
  names(nebula_ec_results_list),
  function(gene_name) {
    converged <- nebula_ec_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged <- ec_nebula_convergence %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined <- map_dfr(
  names(nebula_ec_results_list),
  function(gene_name) {
    df <- nebula_ec_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined <- ec_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined <- map_dfr(
  names(nebula_ec_results_list),
  function(gene_name) {
    df <- nebula_ec_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "EC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula")

plot_volcano(ec_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "EC", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml <- map_dfr(
  names(nebula_ec_results_list_reml),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml <- ec_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml <- map_dfr(
  names(nebula_ec_results_list_reml),
  function(gene_name) {
    df <- nebula_ec_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined_reml <- ec_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined_reml <- map_dfr(
  names(nebula_ec_results_list_reml),
  function(gene_name) {
    df <- nebula_ec_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "EC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml")

plot_volcano(ec_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "EC (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml_offset <- ec_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined_reml_offset <- ec_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_ec_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "EC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_offset")

plot_volcano(ec_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "EC (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_nebula_reml_offset <- ec_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ec_nebula_reml_offset) <- ec_nebula_res_combined_reml_offset$Gene
rankings_ec_nebula_reml_offset <- sort(rankings_ec_nebula_reml_offset, decreasing = TRUE)
plot(rankings_ec_nebula_reml_offset)
min(rankings_ec_nebula_reml_offset)
max(rankings_ec_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_ec_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_ec_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_ec_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_ec_nebula_reml_offset, title = "EC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_ec_nebula_reml_offset, title = "EC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.3, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_ec_nebula_reml_offset, title = "EC nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_ec_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml_tmm <- ec_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_ec_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined_reml_tmm <- ec_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_ec_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "EC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_tmm")

plot_volcano(ec_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "EC (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_tmm")
```
#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml_pooled <- ec_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "EC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_pooled")

plot_volcano(ec_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "EC (REML & pooled Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_ec_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# ec_nebula_res_combined_reml_pooled
ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
ec_nebula_pooled_ipa_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(ec_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
ec_nebula_pooled_ipa_placebo <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(ec_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
ec_nebula_pooled_ipa_dapa <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(ec_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_nebula_reml_pooled <- ec_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ec_nebula_reml_pooled) <- ec_nebula_res_combined_reml_pooled$Gene
rankings_ec_nebula_reml_pooled <- sort(rankings_ec_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_ec_nebula_reml_pooled)
min(rankings_ec_nebula_reml_pooled)
max(rankings_ec_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_ec_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_ec_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_nebula_reml_pooled_filtered, title = "EC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.18, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_ec_nebula_reml_pooled_pos <- kegg_legacy_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_ec_nebula_reml_pooled_neg <- kegg_legacy_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_nebula_reml_pooled, title = "EC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.3, xmax = 1.9)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_ec_nebula_reml_pooled_pos <- reactome_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_ec_nebula_reml_pooled_neg <- reactome_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_nebula_reml_pooled, title = "EC nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_ec_nebula_reml_pooled_pos <- go_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_ec_nebula_reml_pooled_neg <- go_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_fibvsmc_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res.rds")

nebula_fibvsmc_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml.rds")

nebula_fibvsmc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_offset.rds")

nebula_fibvsmc_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_fibvsmc_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### ML
```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence <- map_dfr(
  names(nebula_fibvsmc_results_list),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged <- fibvsmc_nebula_convergence %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined <- map_dfr(
  names(nebula_fibvsmc_results_list),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

fibvsmc_nebula_res_combined <- fibvsmc_nebula_res_combined %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined <- map_dfr(
  names(nebula_fibvsmc_results_list),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined <- fibvsmc_nebula_res_combined %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "FIB/VSMC/P", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula")

plot_volcano(fibvsmc_nebula_res_combined, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "FIB/VSMC/P", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula")
```

#### REML
```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml <- map_dfr(
  names(nebula_fibvsmc_results_list_reml),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml <- fibvsmc_nebula_convergence_reml %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml <- map_dfr(
  names(nebula_fibvsmc_results_list_reml),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined_reml <- fibvsmc_nebula_res_combined_reml %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined_reml <- map_dfr(
  names(nebula_fibvsmc_results_list_reml),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "FIB/VSMC/P (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml")

plot_volcano(fibvsmc_nebula_res_combined_reml, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "FIB/VSMC/P (REML)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml")
```

#### REML + Offset

```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml_offset <- fibvsmc_nebula_convergence_reml_offset %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml_offset$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined_reml_offset <- fibvsmc_nebula_res_combined_reml_offset %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined_reml_offset <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_offset),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_offset[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "FIB/VSMC/P (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_offset")

plot_volcano(fibvsmc_nebula_res_combined_reml_offset, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "FIB/VSMC/P (REML & Library size offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_offset")
```
##### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmc_nebula_res_combined_reml_offset$Gene), savefile = FALSE)

# rank genes by logFC
rankings_fibvsmc_nebula_reml_offset <- fibvsmc_nebula_res_combined_reml_offset$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_fibvsmc_nebula_reml_offset) <- fibvsmc_nebula_res_combined_reml_offset$Gene
rankings_fibvsmc_nebula_reml_offset <- sort(rankings_fibvsmc_nebula_reml_offset, decreasing = TRUE)
plot(rankings_fibvsmc_nebula_reml_offset)
min(rankings_fibvsmc_nebula_reml_offset)
max(rankings_fibvsmc_nebula_reml_offset)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmc_nebula_reml_offset,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmc_nebula_reml_offset,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmc_nebula_reml_offset <- fgsea(pathways = go,
                        stats = rankings_fibvsmc_nebula_reml_offset,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(reactome_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_fibvsmc_nebula_reml_offset[, padj < 0.05], na.rm = T), sum(go_res_fibvsmc_nebula_reml_offset[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```
###### KEGG Legacy
```{r echo = F}
plot_fgsea_transpose(kegg_legacy_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME
```{r echo = F}
plot_fgsea_transpose(reactome_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.4, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### GO
```{r echo = F}
plot_fgsea_transpose(go_res_fibvsmc_nebula_reml_offset, title = "FIB/VSMC/P nebula Top 30 GO (REML & Library size offset)", xmin = 1.45, xmax = 2.5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### REML + TMM Offset

```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml_tmm <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_tmm),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml_tmm[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml_tmm <- fibvsmc_nebula_convergence_reml_tmm %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml_tmm <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_tmm[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml_tmm$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined_reml_tmm <- fibvsmc_nebula_res_combined_reml_tmm %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined_reml_tmm <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_tmm),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_tmm[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "FIB/VSMC/P (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_tmm")

plot_volcano(fibvsmc_nebula_res_combined_reml_tmm, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "FIB/VSMC/P (REML & TMM Offset)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_tmm")
```

#### REML + pooled pooled

```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml_pooled <- fibvsmc_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             "FIB/VSMC/P (REML & pooled pooled)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_pooled")

plot_volcano(fibvsmc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             "FIB/VSMC/P (REML & pooled pooled)", 
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_pooled")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_fibvsmc_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# fibvsmc_nebula_res_combined_reml_pooled
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
fibvsmc_nebula_pooled_ipa_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(fibvsmc_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
fibvsmc_nebula_pooled_ipa_placebo <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(fibvsmc_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
fibvsmc_nebula_pooled_ipa_dapa <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(fibvsmc_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_fibvsmc_nebula_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_fibvsmc_nebula_reml_pooled) <- fibvsmc_nebula_res_combined_reml_pooled$Gene
rankings_fibvsmc_nebula_reml_pooled <- sort(rankings_fibvsmc_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_fibvsmc_nebula_reml_pooled)
min(rankings_fibvsmc_nebula_reml_pooled)
max(rankings_fibvsmc_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmc_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmc_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_fibvsmc_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 2.7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_fibvsmc_nebula_reml_pooled_pos <- reactome_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_fibvsmc_nebula_reml_pooled_neg <- reactome_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_fibvsmc_nebula_reml_pooled_pos <- go_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_fibvsmc_nebula_reml_pooled_neg <- go_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```



## Combined volcano

```{r echo = F}
# plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
#              "fdr_interaction",
#              "PT (REML & pooled Offset)", 
#              "logFC Treatment(Dapagliflozin):Visit(POST)", 
#              "-log10(FDR adjusted p-value)",
#              "nebula/pt_placebo_pvalue_nebula_reml_pooled")

combined_nebula_reml_pooled <- 
  rbind(pt_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "PT"), 
        tal_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "TAL"),
        pc_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "PC"),
        immune_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "Immune"),
        ic_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "IC"),
        ec_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "EC"),
        fibvsmc_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "FIB/VSMC/P")) %>%
  mutate(fdr_interaction_cat = case_when(fdr_interaction < 0.05 & 
                                           `logFC_treatmentDapagliflozin:visitPOST` > 0 ~
                                           "Positive & P < 0.05",
                                         fdr_interaction < 0.05 & 
                                           `logFC_treatmentDapagliflozin:visitPOST` < 0 ~
                                           "Negative & P < 0.05",
                                         T ~ "P > 0.05"))


# volcano plot with no label
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))


# find genes that are significant in more than one celltype
shared_genes <- combined_nebula_reml_pooled %>%
  filter(fdr_interaction < 0.05) %>%
  group_by(Gene) %>%
  dplyr::summarise(sig_gene_count = n(), .groups = "drop") %>%
  filter(sig_gene_count > 1) %>%
  arrange(desc(sig_gene_count)) %>%
  pull(Gene)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% shared_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  color = "black",
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in TCA cycle
tca_genes <- c(
  "ACO1", "ACO2", "IDH1", "IDH2", "IDH3A", "IDH3B", "IDH3G", "OGDH", "OGDHL",
  "SUCLA2", "SUCLG1", "SUCLG2", "SDHA", "SDHB", "SDHC", "SDHD", "FH", "MDH1",
  "MDH2", "FAS", "CS"
)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% tca_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in oxphos cycle
oxphos_genes <- c(
  "NDUFS6",  "SDHB", "SDHC", "SDHD",
  "UQCRC1", "UQCRC2", "COX4I1", "COX4I2", "ATP5PF"
)
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% oxphos_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# ggsave(
#   filename = "",
#   width = 4,
#   height = 4,
#   dpi = 300
# )

```

## Number of DEGs
```{r echo = F}
celltype_list <- c("pt", "tal", "pc", "immune", "immune_myeloid", "immune_lymphoid", "ic", "ec", "fibvsmc")
names_nebula_res_combined_reml_pooled <- paste0(celltype_list, "_nebula_res_combined_reml_pooled")

# Create a named list of data frames
df_list <- mget(names_nebula_res_combined_reml_pooled)
names(df_list) <- toupper(celltype_list)  # Set uppercase names for celltype labeling

# Combine and add celltype column
combined <- bind_rows(df_list, .id = "celltype")

# Create the summary table
deg_summary <- combined %>%
  mutate(direction_fdr = case_when(
           `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
           `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-",
           TRUE ~ "NS")) %>%
  dplyr::select(direction_fdr, celltype) %>%
  table() %>%
  as.data.frame()
deg_summary$celltype <- factor(deg_summary$celltype, levels = c("PT", "TAL", "PC", "IC", "EC", "FIBVSMC", "IMMUNE",
                   "IMMUNE_MYELOID", "IMMUNE_LYMPHOID"))
# Create the summary table
deg_summary_wide <- combined %>%
  mutate(direction_fdr = case_when(
    `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-",
    TRUE ~ "NS")) %>%
  count(direction_fdr, celltype) %>%
  pivot_wider(names_from = celltype, values_from = n, values_fill = 0) %>%
  as.data.frame()

save(deg_summary_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_comparison.RData")

deg_summary %>%
  ggplot(aes(x = celltype, y = Freq, fill = direction_fdr)) +
  geom_col(position = "stack") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 70, hjust = 1)) +
  scale_fill_manual(values = c("-" = "#457b9d",
                               "+" = "#f28482",
                               "NS" = "#ced4da")) +
  labs(fill = "DEG Direction", 
       x = NULL)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Cell type comparison/celltype_deg_stacked_barplot.jpeg",
       width = 5, height = 4)

```

## Transcript overlap analysis

```{r echo = F}
# upset plot
# combined
# upset_combined_dat <- combined %>%
#   filter(fdr_interaction < 0.05) %>%
#   mutate(direction_fdr = case_when(`logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
#                                    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-")) %>%
#   dplyr::select(celltype, Gene) %>%
#   mutate(present = 1) %>%
#   distinct() %>%
#   pivot_wider(names_from = celltype, values_from = present, values_fill = 0) %>%
#   as.data.frame()


# UpSetR::upset(upset_combined_dat)


upset_combined_df <- combined %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID")) %>%
  filter(fdr_interaction < 0.05) %>%
  dplyr::select(celltype, Gene, `logFC_treatmentDapagliflozin:visitPOST`, fdr_interaction) %>%
  group_by(Gene) %>%
  dplyr::summarize(
    celltype = list(unique(celltype))
  ) %>%
  arrange(lengths(celltype))
set_sizes <- upset_combined_df %>%
  unnest(celltype) %>%
  dplyr::count(celltype, name = "size") %>%
  arrange(desc(size))

ordered <- set_sizes$celltype           # vector of cell types in the desired order
combo_ordered <- data.frame(combo_strings = map_chr(unique(upset_combined_df$celltype), ~ str_c(sort(.x), collapse = "-")),
                            combo_ranks = map(unique(upset_combined_df$celltype), ~ match(.x, ordered)) %>%
                              map(~ .x[!is.na(.x)]) %>%
                              map_chr(~ str_c(sprintf("%02d", .x), collapse = "-"))) %>%
  mutate(combo_size = str_count(combo_ranks, "-") + 1,
         combo_first = as.numeric(map_chr(combo_ranks, ~ {
           nums <- as.integer(str_split(.x, "-", simplify = TRUE))
           sprintf("%02d", min(nums, na.rm = TRUE))
         }))) %>%  # count number of ranks
  arrange(combo_first, combo_size)

upset_plot <- upset_combined_df %>%
  mutate(overlap_category = case_when(lengths(celltype) > 2 ~ "2+",
                               T ~ "1-2")) %>%
  ggplot(aes(x = celltype)) +
  geom_bar_rounded(aes(fill = overlap_category)) +
  scale_x_mergelist(sep = "-", position = "bottom",
                    limits = combo_ordered$combo_strings) +
  axis_combmatrix(sep = "-", levels = ordered,
                  override_plotting_function = function(df){
                    print(class(df))
                    print(df)
                    df %>%
                      mutate(celltype_lengths = case_when(
                        ! observed ~ "Not observed",
                        T ~ as.character(lengths(labels_split)))) %>%
    ggplot(aes(x= at, y= single_label)) +
      geom_rect(aes(fill= index %% 2 == 0), ymin=df$index-0.5, ymax=df$index+0.5, xmin=0, xmax=1) +
      geom_point(aes(color= celltype_lengths), size = 4) +
      geom_line(data= function(dat) dat[dat$observed, ,drop=FALSE], aes(group = labels, color= celltype_lengths), linewidth= 0.5) +
      ylab("") + xlab("") +
      scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
      scale_fill_manual(values= c(`TRUE` = "white", `FALSE` = "white")) +
      scale_color_manual(values= c("1" = "#bbc7dc",
                                   "2" = "#bbc7dc",
                                   "3" = "#6d90b9",
                                   "4" = "#6d90b9",
                                   "5" = "#6d90b9",
                                   "6" = "#6d90b9",
                                   "7" = "#6d90b9",
                                   "Not observed" = "#F7F7F7")) +
      guides(color="none", fill="none") +
      theme(
        panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.length = unit(0, "pt"),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank(),
        text = element_text(size = 20)
      )
  }) +
  scale_fill_manual(values= c("1-2" = "#bbc7dc",
                              "2+" = "#6d90b9")) +
  geom_text(stat='count', aes(label=after_stat(count), 
            color = overlap_category),
            vjust=0.5, hjust = -0.2, angle = 90, size = 6) +
  scale_color_manual(values= c("1-2" = "#bbc7dc",
                               "2+" = "#6d90b9")) +
  theme_bw() +
  labs(x = NULL, y = "Count", fill = "# of overlaps") +
  theme(panel.grid = element_blank(),
        text = element_text(size = 25),
        legend.position = c(0.92,0.9),
        legend.key.size = unit(60, "pt")) +
  guides(color = "none")

p_side <- ggplot(set_sizes, aes(x = -size, y = fct_rev(factor(celltype, levels = c(ordered))))) +
  geom_col(width = 0.6, color = "#385674") +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(labels = abs) + 
  theme_minimal(base_size = 25) +
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(), 
    text = element_text(size = 25)) +
  coord_cartesian(expand = FALSE)

library(cowplot)

ggdraw() +
  draw_plot(
    cowplot::plot_grid(
      cowplot::plot_grid(
        NULL,
        p_side + theme(plot.margin = unit(c(1, -3, -15, 10), "pt")),
        ncol = 1, rel_heights = c(5.5, 1)
      ),
      upset_plot,
      nrow = 1,
      rel_widths = c(0.3, 3)
    ),
    x = 0.05, y = 0.05, width = 0.95, height = 0.95  # shrink to add outer padding
  )
ggsave(filename = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Upset/celltype_deg_upset.jpeg",
       width = 30, height = 15)

```
```{r echo = F}

combined_sig <- combined %>%
  filter(fdr_interaction < 0.05) %>%
  dplyr::select(Gene, celltype) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID"))

unique_genes_per_celltype <- combined_sig %>%
  group_by(Gene) %>%
  mutate(n_celltypes = n()) %>%
  ungroup() %>%
  filter(n_celltypes == 1) %>%  # Genes appearing in only one cell type
  count(celltype) %>%
  dplyr::rename(unique_genes = n) %>%
  mutate(unique_genes = unique_genes/2) # duplicates plotted

chord_plot_dat <- combined_sig %>%
  # Self-join to find all celltype pairs for each gene
  inner_join(combined_sig, by = "Gene", suffix = c("_1", "_2"), relationship = "many-to-many") %>%
  # # Remove self-pairs (same celltype)
  filter(celltype_1 != celltype_2) %>%
  # Count shared genes between each celltype pair
  count(celltype_1, celltype_2) %>%
  # Create symmetric matrix
  pivot_wider(names_from = celltype_2, values_from = n, values_fill = 0) %>%
  column_to_rownames("celltype_1") %>%
  as.matrix()
chord_plot_dat <- chord_plot_dat[, rownames(chord_plot_dat)]
# Add unique genes to the diagonal
for(ct in unique_genes_per_celltype$celltype) {
  if(ct %in% rownames(chord_plot_dat)) {
    chord_plot_dat[ct, ct] <- unique_genes_per_celltype$unique_genes[unique_genes_per_celltype$celltype == ct]
  }
}

chord_plot_dat[upper.tri(chord_plot_dat)] <- 0

cell_types <- rownames(chord_plot_dat)
cell_colors <- setNames(c("#f26b21", "#fcec52", "#cbdb47", "#99ca3c", 
                          "#208b3a", "#fbb040", "#f78e31"), cell_types)

# cell_colors <- setNames(c("#1", "#4", "#5", "#6", 
#                           "#7", "#3", "#2"), cell_types)

# Create blended colors for ribbons
col_fun_blend <- function(mat) {
  n <- nrow(mat)
  col_mat <- matrix(NA, n, n)
  for(i in 1:n) {
    for(j in 1:n) {
      if(mat[i,j] > 0) {
        # Blend the two cell type colors
        col1 <- col2rgb(cell_colors[rownames(mat)[i]])
        col2 <- col2rgb(cell_colors[rownames(mat)[j]])
        blended <- rgb((col1[1] + col2[1])/2/255,
                       (col1[2] + col2[2])/2/255,
                       (col1[3] + col2[3])/2/255,
                       alpha = 0.6)
        col_mat[i,j] <- blended
      }
    }
  }
  return(col_mat)
}

chord_colors_blended <- col_fun_blend(chord_plot_dat)


# Create a logical matrix with same dimensions as chord_plot_dat
logical_matrix <- matrix(TRUE, 
                        nrow = nrow(chord_plot_dat), 
                        ncol = ncol(chord_plot_dat),
                        dimnames = list(rownames(chord_plot_dat), 
                                      colnames(chord_plot_dat)))

# Set diagonal to FALSE
diag(logical_matrix) <- FALSE

# Open PNG device
png("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Proportions/celltype_deg_chordplot.png", width = 800, height = 800, res = 150)

# Your plotting code
circos.clear()
chordDiagram(chord_plot_dat, transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T)

# Close the device
dev.off()
circos.clear()
```

```{r echo = F}
# Create set sizes data frame
set_sizes_df <- combined_sig %>%
  count(celltype) %>%
  filter(celltype %in% cell_types) %>%
  arrange(match(celltype, cell_types))

# Initialize the plot
circos.clear()
circos.par("track.height" = 0.1, 
           "gap.after" = rep(3, length(cell_types)),
           "start.degree" = 90)

# par(
#   family = "Outfit", cex = 2, col = "black", # font family, size, color
#   mai = rep(0.5, 4) # plot margin in inches
# ) 

# Create chord diagram
chordDiagram(chord_plot_dat, 
             transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T,
             link.border = "black", link.lwd = 0.2,
             preAllocateTracks = list(track.height = 0.001)
             )

# Add barplot track
circos.track(ylim = c(0, max(set_sizes_df$n) * 1.1),
             bg.border = NA,
             track.height = 0.2,
             panel.fun = function(x, y) {
               sector.index = get.cell.meta.data("sector.index")
               xlim = get.cell.meta.data("xlim")
               
               # Get the value for this sector
               value = set_sizes_df$n[set_sizes_df$celltype == sector.index]
               
               # Draw rectangle (bar)
               circos.rect(xlim[1], 0, xlim[2], value,
                          col = cell_colors[sector.index],
                          border = cell_colors[sector.index])
               
               # Add text label
               circos.text(mean(xlim), value + max(set_sizes_df$n) * 0.02,
                          labels = value,
                          sector.index = sector.index,
                          facing = "inside",
                          niceFacing = TRUE,
                          cex = 1,
                          adj = c(0.5, 0))
             })

# Add y-axis for the barplot
circos.yaxis(side = "left", 
             sector.index = cell_types[1],
             labels.cex = 0.5,
             at = pretty(c(0, max(set_sizes_df$n)), n = 3))

circos.clear()
```

```{r echo = F}
upset_combined_df %>%
  arrange(desc(lengths(celltype)))

combined_wide <- combined %>%
  filter(fdr_interaction < 0.05) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID")) %>%
  mutate(logFC_direction = case_when(`logFC_treatmentDapagliflozin:visitPOST` < 0 ~ "-",
                                     `logFC_treatmentDapagliflozin:visitPOST` > 0 ~ "+")) %>%
  dplyr::select(Gene, celltype, logFC_direction) %>%
  pivot_wider(
    names_from = celltype,
    values_from = logFC_direction,
    values_fn = list(direction = identity)) %>%
  rowwise() %>%
  dplyr::mutate(n_pos = sum(c_across(PT:FIBVSMC) == "+", na.rm = TRUE),
                n_neg = sum(c_across(PT:FIBVSMC) == "-", na.rm = TRUE),
                n_total = sum(!is.na(c_across(PT:FIBVSMC)))) %>%
  ungroup() %>%
  arrange(desc(n_total))

save(combined_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_concordance.RData")


gene_list_4 <- combined_wide %>%
  filter(n_total >= 4) %>%
  pull(Gene)

save(gene_list_4, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/gene_list_greater_than_3.RData")

```

## Investigate outlier

```{r echo = F}
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` > 10)

# immune cell: TRHDE-AS1
# immune cell: FGF14
# fib/vsmc/p: PSAT1
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_DiD_pathways_nebula.xls", skip = 1)
pt_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_dapa_pathways_nebula.xls", skip = 1)
pt_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_placebo_pathways_nebula.xls", skip = 1)

colnames(pt_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_nebula <- pt_pathways_nebula %>%
  full_join(pt_dapa_nebula) %>% full_join(pt_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_nebula$scenario <- factor(pt_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_nebula <- pt_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_nebula$pathway <- reorder(pt_pathways_inhibited_nebula$pathway, pt_pathways_inhibited_nebula$neg_log_p)
  
pt_top30_inhibited_nebula <- pt_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_nebula <- pt_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_nebula$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_nebula))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_nebula + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_nebula <- pt_pathways_inhibited_nebula %>%
  filter(z <= -2)
pt_top30_inhibited_2_nebula <- pt_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_nebula$z), max(-pt_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) 

## top30_inhibited_nebula + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_nebula <- pt_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_nebula$pathway <- reorder(pt_pathways_activated_nebula$pathway, pt_pathways_activated_nebula$neg_log_p)
  
pt_top30_activated_nebula <- pt_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_nebula <- pt_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_nebula <- pt_pathways_activated_nebula %>%
  filter(z > 2)
pt_top30_activated_2_nebula <- pt_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_nebula$z), max(pt_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_nebula$name <- factor(pt_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_nebula$name <- factor(pt_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_nebula
pt_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_DiD_pathways_nebula.xls", skip = 1)
tal_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_dapa_pathways_nebula.xls", skip = 1)
tal_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_placebo_pathways_nebula.xls", skip = 1)

colnames(tal_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_nebula <- tal_pathways_nebula %>%
  full_join(tal_dapa_nebula) %>% full_join(tal_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_nebula$scenario <- factor(tal_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_nebula <- tal_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_nebula$pathway <- reorder(tal_pathways_inhibited_nebula$pathway, tal_pathways_inhibited_nebula$neg_log_p)
  
tal_top30_inhibited_nebula <- tal_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_nebula <- tal_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_nebula <- tal_pathways_inhibited_nebula %>%
  filter(z < -2)
tal_top30_inhibited_2_nebula <- tal_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_nebula$z), max(-tal_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_nebula <- tal_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_nebula$pathway <- reorder(tal_pathways_activated_nebula$pathway, tal_pathways_activated_nebula$neg_log_p)
  
tal_top30_activated_nebula <- tal_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 2.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_nebula <- tal_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_nebula <- tal_pathways_activated_nebula %>%
  filter(z > 2)
tal_top30_activated_2_nebula <- tal_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_nebula$z), max(tal_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_nebula$name <- factor(tal_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_nebula$name <- factor(tal_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_nebula
tal_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_DiD_pathways_nebula.xls", skip = 1)
pc_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_dapa_pathways_nebula.xls", skip = 1)
pc_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_placebo_pathways_nebula.xls", skip = 1)

colnames(pc_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_nebula <- pc_pathways_nebula %>%
  full_join(pc_dapa_nebula) %>% full_join(pc_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_nebula$scenario <- factor(pc_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_nebula <- pc_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_nebula$pathway <- reorder(pc_pathways_inhibited_nebula$pathway, pc_pathways_inhibited_nebula$neg_log_p)
  
pc_top30_inhibited_nebula <- pc_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_nebula <- pc_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_nebula <- pc_pathways_inhibited_nebula %>%
  filter(z < -2)
pc_top30_inhibited_2_nebula <- pc_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_nebula$z), max(-pc_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_nebula <- pc_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_nebula$pathway <- reorder(pc_pathways_activated_nebula$pathway, pc_pathways_activated_nebula$neg_log_p)
  
pc_top30_activated_nebula <- pc_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_nebula <- pc_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_nebula <- pc_pathways_activated_nebula %>%
  filter(z > 2)
pc_top30_activated_2_nebula <- pc_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_nebula$z), max(pc_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_nebula$name <- factor(pc_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_nebula$name <- factor(pc_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_nebula
pc_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_DiD_pathways_nebula.xls", skip = 1)
immune_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_dapa_pathways_nebula.xls", skip = 1)
immune_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_placebo_pathways_nebula.xls", skip = 1)

colnames(immune_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_nebula <- immune_pathways_nebula %>%
  full_join(immune_dapa_nebula) %>% full_join(immune_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_nebula$scenario <- factor(immune_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_nebula <- immune_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_nebula$pathway <- reorder(immune_pathways_inhibited_nebula$pathway, immune_pathways_inhibited_nebula$neg_log_p)
  
immune_top30_inhibited_nebula <- immune_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_nebula <- immune_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_nebula <- immune_pathways_inhibited_nebula %>%
  filter(z < -2)
immune_top30_inhibited_2_nebula <- immune_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_nebula$z), max(-immune_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_nebula <- immune_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_nebula$pathway <- reorder(immune_pathways_activated_nebula$pathway, immune_pathways_activated_nebula$neg_log_p)
  
immune_top30_activated_nebula <- immune_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_nebula <- immune_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_nebula <- immune_pathways_activated_nebula %>%
  filter(z > 2)
immune_top30_activated_2_nebula <- immune_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_nebula$z), max(immune_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_nebula$name <- factor(immune_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_nebula$name <- factor(immune_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_nebula
immune_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_DiD_pathways_nebula.xls", skip = 1)
ic_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_dapa_pathways_nebula.xls", skip = 1)
ic_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_placebo_pathways_nebula.xls", skip = 1)

colnames(ic_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_nebula <- ic_pathways_nebula %>%
  full_join(ic_dapa_nebula) %>% full_join(ic_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_nebula$scenario <- factor(ic_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_nebula <- ic_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_nebula$pathway <- reorder(ic_pathways_inhibited_nebula$pathway, ic_pathways_inhibited_nebula$neg_log_p)
  
ic_top30_inhibited_nebula <- ic_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_nebula <- ic_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_nebula <- ic_pathways_inhibited_nebula %>%
  filter(z < -2)
ic_top30_inhibited_2_nebula <- ic_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_nebula$z), max(-ic_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_nebula <- ic_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_nebula$pathway <- reorder(ic_pathways_activated_nebula$pathway, ic_pathways_activated_nebula$neg_log_p)
  
ic_top30_activated_nebula <- ic_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_nebula <- ic_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_nebula <- ic_pathways_activated_nebula %>%
  filter(z > 2)
ic_top30_activated_2_nebula <- ic_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_nebula$z), max(ic_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_nebula$name <- factor(ic_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_nebula$name <- factor(ic_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_nebula
ic_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_DiD_pathways_nebula.xls", skip = 1)
ec_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_dapa_pathways_nebula.xls", skip = 1)
ec_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_placebo_pathways_nebula.xls", skip = 1)

colnames(ec_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_nebula <- ec_pathways_nebula %>%
  full_join(ec_dapa_nebula) %>% full_join(ec_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_nebula$scenario <- factor(ec_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_nebula <- ec_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_nebula$pathway <- reorder(ec_pathways_inhibited_nebula$pathway, ec_pathways_inhibited_nebula$neg_log_p)
  
ec_top30_inhibited_nebula <- ec_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_nebula <- ec_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_nebula <- ec_pathways_inhibited_nebula %>%
  filter(z < -2)
ec_top30_inhibited_2_nebula <- ec_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_nebula$z), max(-ec_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_nebula <- ec_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_nebula$pathway <- reorder(ec_pathways_activated_nebula$pathway, ec_pathways_activated_nebula$neg_log_p)
  
ec_top30_activated_nebula <- ec_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_nebula <- ec_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_nebula <- ec_pathways_activated_nebula %>%
  filter(z > 2)
ec_top30_activated_2_nebula <- ec_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_nebula$z), max(ec_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_nebula$name <- factor(ec_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_nebula$name <- factor(ec_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_nebula
ec_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_DiD_pathways_nebula.xls", skip = 1)
dtl_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_dapa_pathways_nebula.xls", skip = 1)
dtl_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_placebo_pathways_nebula.xls", skip = 1)

colnames(dtl_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_nebula <- dtl_pathways_nebula %>%
  full_join(dtl_dapa_nebula) %>% full_join(dtl_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_nebula$scenario <- factor(dtl_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_nebula <- dtl_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_nebula$pathway <- reorder(dtl_pathways_inhibited_nebula$pathway, dtl_pathways_inhibited_nebula$neg_log_p)
  
dtl_top30_inhibited_nebula <- dtl_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_nebula <- dtl_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_nebula <- dtl_pathways_inhibited_nebula %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_nebula <- dtl_pathways_inhibited_sig_nebula[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_nebula$z), max(-dtl_pathways_inhibited_sig_nebula$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_inhibited_pathways_2.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_nebula <- dtl_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_nebula$pathway <- reorder(dtl_pathways_activated_nebula$pathway, dtl_pathways_activated_nebula$neg_log_p)
  
dtl_top30_activated_nebula <- dtl_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_nebula <- dtl_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_nebula <- dtl_pathways_activated_nebula %>%
  filter(z > 2)
dtl_top30_activated_2_nebula <- dtl_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_nebula$z), max(dtl_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_nebula$name <- factor(dtl_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_nebula$name <- factor(dtl_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_nebula
dtl_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_DiD_pathways_nebula.xls", skip = 1)
fibvsmcp_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_dapa_pathways_nebula.xls", skip = 1)
fibvsmcp_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_placebo_pathways_nebula.xls", skip = 1)

colnames(fibvsmcp_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_nebula <- fibvsmcp_pathways_nebula %>%
  full_join(fibvsmcp_dapa_nebula) %>% full_join(fibvsmcp_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_nebula$scenario <- factor(fibvsmcp_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_nebula <- fibvsmcp_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_nebula$pathway <- reorder(fibvsmcp_pathways_inhibited_nebula$pathway, fibvsmcp_pathways_inhibited_nebula$neg_log_p)
  
fibvsmcp_top30_inhibited_nebula <- fibvsmcp_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_nebula <- fibvsmcp_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_nebula <- fibvsmcp_pathways_inhibited_nebula %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_nebula <- fibvsmcp_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_nebula$z), max(-fibvsmcp_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_nebula <- fibvsmcp_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_nebula$pathway <- reorder(fibvsmcp_pathways_activated_nebula$pathway, fibvsmcp_pathways_activated_nebula$neg_log_p)
  
fibvsmcp_top30_activated_nebula <- fibvsmcp_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_nebula <- fibvsmcp_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_nebula <- fibvsmcp_pathways_activated_nebula %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_nebula <- fibvsmcp_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_nebula$z), max(fibvsmcp_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_nebula <- fibvsmcp_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_nebula$name <- factor(fibvsmcp_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/fibvsmcp_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_nebula <- fibvsmcp_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_nebula$name <- factor(fibvsmcp_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_nebula
fibvsmcp_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/fibvsmcp_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```


# Model comparison

* Model 1: Nested visit, zero inflation

* Model 2: No nested visit, zero inflation

```{r echo = F}
## PT
pt_nc <- c(pt_nonconverged_percentage_mod1,
           pt_nonconverged_percentage_mod2)
```


```{r echo = F}
## TAL
tal_nc <- c(tal_nonconverged_percentage_mod1,
            tal_nonconverged_percentage_mod2)
```

```{r echo = F}
## PC
pc_nc <- c(pc_nonconverged_percentage_mod1,
           pc_nonconverged_percentage_mod2)
```

```{r echo = F}
## Immune
immune_nc <- c(immune_nonconverged_percentage_mod1,
               immune_nonconverged_percentage_mod2)
```

```{r echo = F}
## IC
ic_nc <- c(ic_nonconverged_percentage_mod1,
           ic_nonconverged_percentage_mod2)

```

```{r echo = F}
## EC
ec_nc <- c(ec_nonconverged_percentage_mod1,
           ec_nonconverged_percentage_mod2)
```

```{r echo = F}
## FIB/VSMC/P
fibvsmcp_nc <- c(fibvsmcp_nonconverged_percentage_mod1,
                 fibvsmcp_nonconverged_percentage_mod2)
```


```{r echo = F}
mods <- c("Model 1 (Nested Visit, ZINB)",
             "Model 2 (No nested visit, ZINB)")
mods_df <- data.frame(mods, pt_nc, tal_nc, pc_nc, immune_nc, ic_nc, ec_nc, fibvsmcp_nc)
colnames(mods_df) <- c("Model", "PT", "TAL", "PC", "Immune", "IC", "EC", "FIB, VSMC/P")
kable(mods_df, digits = 2)
```

```{r echo = F}
prefixes <- c("pt", "tal", "pc", "ic", "ec", "fibvsmcp", "immune")
mods <- paste0("mod", 1:2)

base_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/"

for (prefix in prefixes) {
  for (mod in mods) {
    obj_name <- paste0(prefix, "_nonconverged_genes_", mod)
    save_path <- file.path(base_path, paste0(obj_name, "_zi.rds"))
    saveRDS(get(obj_name), file = save_path)
  }
}
```

```{r echo = F}
sheet_list <- list()  # Store all data frames here
mods <- paste0("mod", 1:2)
for (prefix in prefixes) {
  for (mod in mods) {
    # Construct the name of the data frame (e.g., pt_emmeans_diff_DiD_mod1)
    df_name <- paste0(prefix, "_emmeans_diff_DiD_", mod)
    
    # Check if the data frame exists
    if (exists(df_name)) {
      df <- get(df_name)
      
      # Positive top 20
      pos_top20 <- df %>%
        arrange(`Expr p-value`) %>%
        filter(`Expr Other` > 0) %>%
        head(20)
      
      sheet_name_pos <- paste0(toupper(prefix), "_", mod, "_POS_Top20")
      sheet_list[[sheet_name_pos]] <- pos_top20
      
      # Negative top 20
      neg_top20 <- df %>%
        arrange((`Expr p-value`)) %>%
        filter(`Expr Other` < 0) %>%
        head(20)
      
      sheet_name_neg <- paste0(toupper(prefix), "_", mod, "_NEG_Top20")
      sheet_list[[sheet_name_neg]] <- neg_top20
    }
  }
}

# Write all to an Excel file
library(writexl)

write_xlsx(sheet_list, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/DiD_Top20_By_CellType_Mod_zi.xlsx")
```

