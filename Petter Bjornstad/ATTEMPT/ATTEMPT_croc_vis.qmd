---
title: "ATTEMPT CROCODILE comparison visualization"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---


# Use crocodile_nebula_vis.qmd instead


```{r echo = F, include = F}
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
library(ComplexUpset)
library(ggupset)
library(Hmisc)
library(ggrounded)
library(circlize)
library(tidyverse)

source("~/GitHub/CHCO-Code/Petter Bjornstad/ATTEMPT/attempt_functions.R")
```

# nebula

### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_pt_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pt_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### REML + pooled Offset
```{r echo = F}
# nebula only keeps results for converged
pt_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_pt_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pt_nebula_converged_reml_pooled <- pt_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

pt_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pt_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled%>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pt_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_pt_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pt_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_pooled",
             cell_type = "PT")

plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pt_placebo_pvalue_nebula_reml_pooled",
             cell_type = "PT")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_pt_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# pt_nebula_res_combined_reml_pooled
pt_nebula_res_combined_reml_pooled <- pt_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
pt_nebula_pooled_ipa_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(pt_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
pt_nebula_pooled_ipa_placebo <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(pt_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
pt_nebula_pooled_ipa_dapa <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(pt_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pt_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pt_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pt_nebula_reml_pooled <- pt_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pt_nebula_reml_pooled) <- pt_nebula_res_combined_reml_pooled$Gene
rankings_pt_nebula_reml_pooled <- sort(rankings_pt_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_pt_nebula_reml_pooled)
min(rankings_pt_nebula_reml_pooled)
max(rankings_pt_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_pt_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_pt_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pt_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_pt_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_pt_nebula_reml_pooled_pos <- kegg_legacy_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_pt_nebula_reml_pooled_neg <- kegg_legacy_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 3.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_pt_nebula_reml_pooled_pos <- reactome_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_pt_nebula_reml_pooled_neg <- reactome_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_pt_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_pt_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pt_nebula_reml_pooled_filtered, title = "PT nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 4.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pt_nebula_res_combined_reml_pooled_DiD <- pt_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pt_nebula_res_combined_reml_pooled_DiD$group <- factor(pt_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_pt_nebula_reml_pooled_pos <- go_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_pt_nebula_reml_pooled_neg <- go_res_pt_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pt_nebula_res_combined_reml_pooled_DiD_pos <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pt_nebula_res_combined_reml_pooled_DiD_neg <- pt_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pt_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pt_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### TAL

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_tal_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res.rds")

nebula_tal_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml.rds")

nebula_tal_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_offset.rds")

nebula_tal_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_tal_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/tal_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
tal_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_tal_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

tal_nebula_converged_reml_pooled <- tal_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

tal_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% tal_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

tal_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_tal_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_tal_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(tal_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_pooled",
             cell_type = "TAL")

plot_volcano(tal_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/tal_placebo_pvalue_nebula_reml_pooled",
             cell_type = "TAL")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_tal_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# tal_nebula_res_combined_reml_pooled
tal_nebula_res_combined_reml_pooled <- tal_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
tal_nebula_pooled_ipa_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(tal_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
tal_nebula_pooled_ipa_placebo <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(tal_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
tal_nebula_pooled_ipa_dapa <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(tal_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(tal_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/tal_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_tal_nebula_reml_pooled <- tal_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_tal_nebula_reml_pooled) <- tal_nebula_res_combined_reml_pooled$Gene
rankings_tal_nebula_reml_pooled <- sort(rankings_tal_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_tal_nebula_reml_pooled)
min(rankings_tal_nebula_reml_pooled)
max(rankings_tal_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_tal_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_tal_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_tal_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_tal_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_tal_nebula_reml_pooled_pos <- kegg_legacy_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_tal_nebula_reml_pooled_neg <- kegg_legacy_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_tal_nebula_reml_pooled_pos <- reactome_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_tal_nebula_reml_pooled_neg <- reactome_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_tal_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_tal_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_tal_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
tal_nebula_res_combined_reml_pooled_DiD <- tal_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

tal_nebula_res_combined_reml_pooled_DiD$group <- factor(tal_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_tal_nebula_reml_pooled_pos <- go_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_tal_nebula_reml_pooled_neg <- go_res_tal_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
tal_nebula_res_combined_reml_pooled_DiD_pos <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
tal_nebula_res_combined_reml_pooled_DiD_neg <- tal_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_tal_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- tal_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### PC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_pc_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res.rds")

nebula_pc_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml.rds")

nebula_pc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_offset.rds")

nebula_pc_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_pc_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/pc_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
pc_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_pc_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

pc_nebula_converged_reml_pooled <- pc_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

pc_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% pc_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

pc_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_pc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_pc_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(pc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_pooled",
             cell_type = "PC")

plot_volcano(pc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/pc_placebo_pvalue_nebula_reml_pooled",
             cell_type = "PC")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_pc_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# pc_nebula_res_combined_reml_pooled
pc_nebula_res_combined_reml_pooled <- pc_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
pc_nebula_pooled_ipa_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(pc_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
pc_nebula_pooled_ipa_placebo <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(pc_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
pc_nebula_pooled_ipa_dapa <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(pc_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(pc_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/pc_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_pc_nebula_reml_pooled <- pc_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_pc_nebula_reml_pooled) <- pc_nebula_res_combined_reml_pooled$Gene
rankings_pc_nebula_reml_pooled <- sort(rankings_pc_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_pc_nebula_reml_pooled)
min(rankings_pc_nebula_reml_pooled)
max(rankings_pc_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_pc_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_pc_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_pc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_pc_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_pc_nebula_reml_pooled_pos <- kegg_legacy_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_pc_nebula_reml_pooled_neg <- kegg_legacy_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.1, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_pc_nebula_reml_pooled_pos <- reactome_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_pc_nebula_reml_pooled_neg <- reactome_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_pc_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_pc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_pc_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
pc_nebula_res_combined_reml_pooled_DiD <- pc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

pc_nebula_res_combined_reml_pooled_DiD$group <- factor(pc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_pc_nebula_reml_pooled_pos <- go_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_pc_nebula_reml_pooled_neg <- go_res_pc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
pc_nebula_res_combined_reml_pooled_DiD_pos <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
pc_nebula_res_combined_reml_pooled_DiD_neg <- pc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_pc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- pc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### Immune (very few cells)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res.rds")

nebula_immune_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml.rds")

nebula_immune_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_offset.rds")

nebula_immune_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_immune_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_nebula_converged_reml_pooled <- immune_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(immune_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune")

plot_volcano(immune_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_nebula_res_combined_reml_pooled
immune_nebula_res_combined_reml_pooled <- immune_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_nebula_pooled_ipa_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_nebula_pooled_ipa_placebo <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_nebula_pooled_ipa_dapa <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_nebula_reml_pooled <- immune_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_nebula_reml_pooled) <- immune_nebula_res_combined_reml_pooled$Gene
rankings_immune_nebula_reml_pooled <- sort(rankings_immune_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_nebula_reml_pooled)
min(rankings_immune_nebula_reml_pooled)
max(rankings_immune_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 KEGG (REML & Library size offset)", xmin = 0.9, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_nebula_reml_pooled_pos <- kegg_legacy_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_nebula_reml_pooled_neg <- kegg_legacy_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_nebula_reml_pooled_filtered, title = "TAL nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_nebula_reml_pooled_pos <- reactome_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_nebula_reml_pooled_neg <- reactome_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_nebula_reml_pooled, title = "TAL nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_nebula_res_combined_reml_pooled_DiD <- immune_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_nebula_reml_pooled_pos <- go_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_nebula_reml_pooled_neg <- go_res_immune_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_nebula_res_combined_reml_pooled_DiD_pos <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_nebula_res_combined_reml_pooled_DiD_neg <- immune_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### Immune (Myeloid)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_myeloid_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_myeloid_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_myeloid_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_myeloid_nebula_converged_reml_pooled <- immune_myeloid_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_myeloid_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_myeloid_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_myeloid_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_myeloid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_myeloid_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10 & 
           `logFC_treatmentDapagliflozin:visitPOST`> -10)
```

```{r echo =F}
plot_volcano(immune_myeloid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_myeloid_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune (Myeloid)")

plot_volcano(immune_myeloid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_myeloid_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune (Myeloid)")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_myeloid_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_myeloid_nebula_res_combined_reml_pooled
immune_myeloid_nebula_res_combined_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_myeloid_nebula_pooled_ipa_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_myeloid_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_myeloid_nebula_pooled_ipa_placebo <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_myeloid_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_myeloid_nebula_pooled_ipa_dapa <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_myeloid_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_myeloid_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_myeloid_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_myeloid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_myeloid_nebula_reml_pooled <- immune_myeloid_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_myeloid_nebula_reml_pooled) <- immune_myeloid_nebula_res_combined_reml_pooled$Gene
rankings_immune_myeloid_nebula_reml_pooled <- sort(rankings_immune_myeloid_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_myeloid_nebula_reml_pooled)
min(rankings_immune_myeloid_nebula_reml_pooled)
max(rankings_immune_myeloid_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_myeloid_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_myeloid_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_myeloid_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_myeloid_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_myeloid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_myeloid_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered, title = "Immune - Myeloid (Myeloid) nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.05, xmax = 2.15)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_myeloid_nebula_reml_pooled, title = "Immune - Myeloid (Myeloid) nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.3, xmax = 2.1)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_myeloid_nebula_reml_pooled_pos <- reactome_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_myeloid_nebula_reml_pooled_neg <- reactome_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_myeloid_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_myeloid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_myeloid_nebula_reml_pooled, title = "Immune - Myeloid (Myeloid) nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_myeloid_nebula_res_combined_reml_pooled_DiD <- immune_myeloid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_myeloid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_myeloid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_myeloid_nebula_reml_pooled_pos <- go_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_myeloid_nebula_reml_pooled_neg <- go_res_immune_myeloid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_myeloid_nebula_res_combined_reml_pooled_DiD_pos <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_myeloid_nebula_res_combined_reml_pooled_DiD_neg <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_myeloid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_myeloid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_myeloid_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### Immune (Lymphoid)


```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_immune_lymphoid_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/immune_lymphoid_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
immune_lymphoid_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

immune_lymphoid_nebula_converged_reml_pooled <- immune_lymphoid_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

immune_lymphoid_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% immune_lymphoid_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

immune_lymphoid_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_immune_lymphoid_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_immune_lymphoid_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)


immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10 &
           `logFC_treatmentDapagliflozin:visitPOST` > -10)
```

```{r echo =F}
plot_volcano(immune_lymphoid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/immune_lymphoid_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune (Lymphoid)")

plot_volcano(immune_lymphoid_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/immune_lymphoid_placebo_pvalue_nebula_reml_pooled",
             cell_type = "Immune (Lymphoid)")
```


#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_immune_lymphoid_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# immune_lymphoid_nebula_res_combined_reml_pooled
immune_lymphoid_nebula_res_combined_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
immune_lymphoid_nebula_pooled_ipa_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(immune_lymphoid_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
immune_lymphoid_nebula_pooled_ipa_placebo <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(immune_lymphoid_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
immune_lymphoid_nebula_pooled_ipa_dapa <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(immune_lymphoid_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(immune_lymphoid_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/immune_lymphoid_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_lymphoid_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_immune_lymphoid_nebula_reml_pooled <- immune_lymphoid_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_immune_lymphoid_nebula_reml_pooled) <- immune_lymphoid_nebula_res_combined_reml_pooled$Gene
rankings_immune_lymphoid_nebula_reml_pooled <- sort(rankings_immune_lymphoid_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_immune_lymphoid_nebula_reml_pooled)
min(rankings_immune_lymphoid_nebula_reml_pooled)
max(rankings_immune_lymphoid_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_lymphoid_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_immune_lymphoid_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_lymphoid_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_immune_lymphoid_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_immune_lymphoid_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_immune_lymphoid_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid  nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.38, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_immune_lymphoid_nebula_reml_pooled_pos <- reactome_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_immune_lymphoid_nebula_reml_pooled_neg <- reactome_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_immune_lymphoid_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_immune_lymphoid_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_immune_lymphoid_nebula_reml_pooled, title = "Immune - Lymphoid nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
immune_lymphoid_nebula_res_combined_reml_pooled_DiD <- immune_lymphoid_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group <- factor(immune_lymphoid_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_immune_lymphoid_nebula_reml_pooled_pos <- go_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_immune_lymphoid_nebula_reml_pooled_neg <- go_res_immune_lymphoid_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_pos <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
immune_lymphoid_nebula_res_combined_reml_pooled_DiD_neg <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_immune_lymphoid_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- immune_lymphoid_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_lymphoid_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```


### IC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_ic_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res.rds")

nebula_ic_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml.rds")

nebula_ic_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_offset.rds")

nebula_ic_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_ic_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ic_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
ic_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_ic_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ic_nebula_converged_reml_pooled <- ic_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

ic_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ic_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ic_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_ic_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ic_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ic_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_pooled",
             cell_type = "IC")

plot_volcano(ic_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ic_placebo_pvalue_nebula_reml_pooled",
             cell_type = "IC")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_ic_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# ic_nebula_res_combined_reml_pooled
ic_nebula_res_combined_reml_pooled <- ic_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
ic_nebula_pooled_ipa_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(ic_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
ic_nebula_pooled_ipa_placebo <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(ic_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
ic_nebula_pooled_ipa_dapa <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(ic_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ic_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ic_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ic_nebula_reml_pooled <- ic_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ic_nebula_reml_pooled) <- ic_nebula_res_combined_reml_pooled$Gene
rankings_ic_nebula_reml_pooled <- sort(rankings_ic_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_ic_nebula_reml_pooled)
min(rankings_ic_nebula_reml_pooled)
max(rankings_ic_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_ic_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_ic_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ic_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_ic_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.35, xmax = 2.55)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_ic_nebula_reml_pooled_pos <- kegg_legacy_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_ic_nebula_reml_pooled_neg <- kegg_legacy_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.75, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_ic_nebula_reml_pooled_pos <- reactome_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_ic_nebula_reml_pooled_neg <- reactome_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_ic_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_ic_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ic_nebula_reml_pooled, title = "IC nebula Top 30 GO (REML & Library size offset)", xmin = 1.8, xmax = 2.9)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ic_nebula_res_combined_reml_pooled_DiD <- ic_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ic_nebula_res_combined_reml_pooled_DiD$group <- factor(ic_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_ic_nebula_reml_pooled_pos <- go_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_ic_nebula_reml_pooled_neg <- go_res_ic_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ic_nebula_res_combined_reml_pooled_DiD_pos <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ic_nebula_res_combined_reml_pooled_DiD_neg <- ic_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ic_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ic_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### EC

```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_ec_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res.rds")

nebula_ec_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml.rds")

nebula_ec_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_offset.rds")

nebula_ec_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_ec_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/ec_attempt_hvg_nebula_res_reml_pooled.rds")
```

#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
ec_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_ec_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

ec_nebula_converged_reml_pooled <- ec_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

ec_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% ec_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)

ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

ec_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_ec_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_ec_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
```

```{r echo =F}
plot_volcano(ec_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_pooled",
             cell_type = "EC")

plot_volcano(ec_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
            NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/ec_placebo_pvalue_nebula_reml_pooled",
            cell_type = "EC")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_ec_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# ec_nebula_res_combined_reml_pooled
ec_nebula_res_combined_reml_pooled <- ec_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
ec_nebula_pooled_ipa_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(ec_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
ec_nebula_pooled_ipa_placebo <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(ec_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
ec_nebula_pooled_ipa_dapa <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(ec_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(ec_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/ec_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_ec_nebula_reml_pooled <- ec_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_ec_nebula_reml_pooled) <- ec_nebula_res_combined_reml_pooled$Gene
rankings_ec_nebula_reml_pooled <- sort(rankings_ec_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_ec_nebula_reml_pooled)
min(rankings_ec_nebula_reml_pooled)
max(rankings_ec_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_ec_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_ec_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_ec_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_ec_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_ec_nebula_reml_pooled_filtered, title = "EC nebula Top 30 KEGG (REML & Library size offset)", xmin = 1.18, xmax = 1.8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_ec_nebula_reml_pooled_pos <- kegg_legacy_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_ec_nebula_reml_pooled_neg <- kegg_legacy_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_ec_nebula_reml_pooled, title = "EC nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.3, xmax = 1.9)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_ec_nebula_reml_pooled_pos <- reactome_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_ec_nebula_reml_pooled_neg <- reactome_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_ec_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_ec_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_ec_nebula_reml_pooled, title = "EC nebula Top 30 GO (REML & Library size offset)", xmin = 1.4, xmax = 2.2)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
ec_nebula_res_combined_reml_pooled_DiD <- ec_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

ec_nebula_res_combined_reml_pooled_DiD$group <- factor(ec_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_ec_nebula_reml_pooled_pos <- go_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_ec_nebula_reml_pooled_neg <- go_res_ec_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
ec_nebula_res_combined_reml_pooled_DiD_pos <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
ec_nebula_res_combined_reml_pooled_DiD_neg <- ec_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_ec_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- ec_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
nebula_fibvsmc_results_list <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res.rds")

nebula_fibvsmc_results_list_reml <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml.rds")

nebula_fibvsmc_results_list_reml_offset <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_offset.rds")

nebula_fibvsmc_results_list_reml_tmm <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_tmm.rds")

nebula_fibvsmc_results_list_reml_pooled <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/fibvsmc_attempt_hvg_nebula_res_reml_pooled.rds")
```


#### REML + pooled Offset

```{r echo = F}
# nebula only keeps results for converged
fibvsmc_nebula_convergence_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    converged <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

fibvsmc_nebula_converged_reml_pooled <- fibvsmc_nebula_convergence_reml_pooled %>%
  filter(Convergence_Code >=-10)

fibvsmc_nebula_res_combined_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$summary
    df <- df %>% filter(gene_name %in% fibvsmc_nebula_converged_reml_pooled$Gene) %>%
      mutate(Gene = gene_name)
    return(df)
  }
)
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  mutate(fdr_interaction = p.adjust(`p_treatmentDapagliflozin:visitPOST`, method = "fdr"))

fibvsmc_nebula_disp_combined_reml_pooled <- map_dfr(
  names(nebula_fibvsmc_results_list_reml_pooled),
  function(gene_name) {
    df <- nebula_fibvsmc_results_list_reml_pooled[[gene_name]]$overdispersion
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10)
```

```{r echo =F}
plot_volcano(fibvsmc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "p_treatmentDapagliflozin:visitPOST",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_pooled",
             cell_type = "FIB, VSMC/P")

plot_volcano(fibvsmc_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
             "fdr_interaction",
             NULL,
             "logFC Treatment(Dapagliflozin):Visit(POST)", 
             "-log10(FDR adjusted p-value)",
             "nebula/fibvsmc_placebo_pvalue_nebula_reml_pooled",
             cell_type = "FIB, VSMC/P")
```

#### IPA input save

```{r echo = F}
# pull covariance matrix for p-value calculations
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  rowwise() %>%
  mutate(
    # Derived logFCs
    placebo_pre = `logFC_(Intercept)`,
    placebo_post = placebo_pre + logFC_visitPOST,
    dapa_pre = placebo_pre + logFC_treatmentDapagliflozin,
    dapa_post = dapa_pre + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
    placebo_post_pre = placebo_post - placebo_pre,
    dapa_post_pre = dapa_post - dapa_pre,
    DiD = dapa_post_pre - placebo_post_pre,

    # Extract coefficients and SEs
    b2 = logFC_visitPOST,
    b3 = `logFC_treatmentDapagliflozin:visitPOST`,
    se2 = se_visitPOST,
    se3 = `se_treatmentDapagliflozin:visitPOST`,

    # Extract scalar covariance value from index 9 (Cov[3,4]) of lower triangle
    cov_b2_b3 = unlist(nebula_fibvsmc_results_list_reml_pooled[[Gene]]$covariance)[9],

    # Calculate SE for dapa_post_pre = b2 + b3
    se_dapa_post_pre = sqrt(se2^2 + se3^2 + 2 * cov_b2_b3),

    # Z-scores and p-values
    z_placebo_post_pre = b2 / se2,
    z_dapa_post_pre = (b2 + b3) / se_dapa_post_pre,
    z_DiD = b3 / se3,

    p_placebo_post_pre = 2 * pnorm(-abs(z_placebo_post_pre)),
    p_dapa_post_pre = 2 * pnorm(-abs(z_dapa_post_pre)),
    p_DiD = 2 * pnorm(-abs(z_DiD))
  ) %>%
  ungroup()

# fibvsmc_nebula_res_combined_reml_pooled
fibvsmc_nebula_res_combined_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled %>%
  mutate(placebo_pre = `logFC_(Intercept)`,
         placebo_post = `logFC_(Intercept)` + logFC_visitPOST,
         dapa_pre = `logFC_(Intercept)` + logFC_treatmentDapagliflozin,
         dapa_post = `logFC_(Intercept)` + logFC_treatmentDapagliflozin + logFC_visitPOST + `logFC_treatmentDapagliflozin:visitPOST`,
         placebo_post_pre = placebo_post - placebo_pre,
         dapa_post_pre = dapa_post - dapa_pre,
         DiD = dapa_post_pre - placebo_post_pre)

# save input for IPA
## Interaction or DiD
fibvsmc_nebula_pooled_ipa_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, `logFC_treatmentDapagliflozin:visitPOST`, `p_treatmentDapagliflozin:visitPOST`, fdr_interaction)
colnames(fibvsmc_nebula_pooled_ipa_DiD) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_DiD, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_DiD.csv", row.names = F)

## Placebo (or Visit)
fibvsmc_nebula_pooled_ipa_placebo <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, p_placebo_post_pre) %>%
  mutate(fdr_placebo_post_pre = p.adjust(p_placebo_post_pre, method = "fdr"))
colnames(fibvsmc_nebula_pooled_ipa_placebo) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_placebo, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_placebo.csv", row.names = F)

## Dapagliflozin
fibvsmc_nebula_pooled_ipa_dapa <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, dapa_post_pre, p_dapa_post_pre) %>%
  mutate(fdr_dapa_post_pre = p.adjust(p_dapa_post_pre, method = "fdr"))
colnames(fibvsmc_nebula_pooled_ipa_dapa) <- c("Gene", "Log Fold Change", "Expr p-value", "Expr False Discovery Rate")

write.csv(fibvsmc_nebula_pooled_ipa_dapa, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/emmeans/nebula/fibvsmc_nebula_pooled_ipa_input_dapa.csv", row.names = F)
```

#### GSEA (fgsea)

```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmc_nebula_res_combined_reml_pooled$Gene), savefile = FALSE)

# rank genes by logFC
rankings_fibvsmc_nebula_reml_pooled <- fibvsmc_nebula_res_combined_reml_pooled$`logFC_treatmentDapagliflozin:visitPOST`
names(rankings_fibvsmc_nebula_reml_pooled) <- fibvsmc_nebula_res_combined_reml_pooled$Gene
rankings_fibvsmc_nebula_reml_pooled <- sort(rankings_fibvsmc_nebula_reml_pooled, decreasing = TRUE)
plot(rankings_fibvsmc_nebula_reml_pooled)
min(rankings_fibvsmc_nebula_reml_pooled)
max(rankings_fibvsmc_nebula_reml_pooled)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmc_nebula_reml_pooled,
                                 scoreType = 'std', 
                                 minSize = 5,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmc_nebula_reml_pooled,
                              scoreType = 'std', 
                              minSize = 5,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmc_nebula_reml_pooled <- fgsea(pathways = go,
                        stats = rankings_fibvsmc_nebula_reml_pooled,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(kegg_legacy_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "REACTOME"=c(sum(reactome_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(reactome_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)),
                         "GO"=c(sum(go_res_fibvsmc_nebula_reml_pooled[, padj < 0.05], na.rm = T), sum(go_res_fibvsmc_nebula_reml_pooled[, pval < 0.05], na.rm = T)))
rownames(fgsea) <- c("adj.pval", "p.val")

```

##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(kegg_legacy_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 KEGG (REML & Library size offset)", xmin = 1, xmax = 2.3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
###### KEGG Legacy Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_kegg_legacy.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_kegg_legacy.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  kegg_legacy_subset <- kegg_legacy_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("KEGG", "", gsub("_", " ", kegg_legacy_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% kegg_legacy_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_kegg_legacy_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### REACTOME
```{r echo = F}
reactome_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(reactome_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(reactome_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 REACTOME (REML & Library size offset)", xmin = 1.2, xmax = 2.7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### REACTOME Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
reactome_res_fibvsmc_nebula_reml_pooled_pos <- reactome_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_reactome.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
reactome_res_fibvsmc_nebula_reml_pooled_neg <- reactome_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_reactome.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  reactome_subset <- reactome_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("REACTOME", "", gsub("_", " ", reactome_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% reactome_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_reactome_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```
##### GO
```{r echo = F}
go_res_fibvsmc_nebula_reml_pooled_filtered <- filter_redundant_pathways(go_res_fibvsmc_nebula_reml_pooled, overlap_pct = 0.3)

plot_fgsea_transpose(go_res_fibvsmc_nebula_reml_pooled_filtered, title = "FIB/VSMC/P nebula Top 30 GO (REML & Library size offset)", xmin = 1.3, xmax = 2.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

###### GO Top 10 Pathways Group specific changes in addition to DiD

```{r echo = F}
# Figures showing group specific changes in addition to DiD
fibvsmc_nebula_res_combined_reml_pooled_DiD <- fibvsmc_nebula_res_combined_reml_pooled %>%
  dplyr::select(Gene, placebo_post_pre, dapa_post_pre, DiD) %>%
  pivot_longer(cols = c(placebo_post_pre, dapa_post_pre, DiD),
               names_to = "group",
               values_to = "logFC") %>%
  mutate(group = case_when(group == "DiD" ~ "DiD",
                          group == "dapa_post_pre" ~ "Dapagliflozin",
                          group == "placebo_post_pre" ~ "Placebo"),
         w = case_when(group == "DiD" ~ 0.5,
                       group == "Dapagliflozin" ~ 0.3,
                       group == "Placebo" ~ 0.3),
         a = case_when(group == "DiD" ~ 0.7,
                       group == "Dapagliflozin" ~ 0.8,
                       group == "Placebo" ~ 0.8))

fibvsmc_nebula_res_combined_reml_pooled_DiD$group <- factor(fibvsmc_nebula_res_combined_reml_pooled_DiD$group, levels = c("DiD", "Placebo", "Dapagliflozin"))
```

###### Bar plots
```{r echo = FALSE}
# Positive NES
go_res_fibvsmc_nebula_reml_pooled_pos <- go_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES > 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", position = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_go.jpeg"))
}
```

```{r echo = FALSE}
# Negative NES
go_res_fibvsmc_nebula_reml_pooled_neg <- go_res_fibvsmc_nebula_reml_pooled_filtered %>%
  filter(NES < 0) %>%
  arrange(padj)

for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  g <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]]) %>%
    ggplot(aes(x = Gene, y = logFC, fill = group)) +
    geom_bar(stat = "identity", negition = "identity",
             aes(width = w, alpha = a)) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 6),
          panel.grid = element_blank(),
          axis.text.y = element_text(size = 12),
          legend.text = element_text(size = 12),
          plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
    scale_fill_manual(values = c("Placebo" = "#f28482",
                                 "Dapagliflozin" = "#669bbc",
                                 "DiD" = "#bb8588")) +
    labs(y = "logFC",
         x = NULL,
         fill = "Treatment",
         title = gsub("GOBP_", "", x = pathway)) +
    guides(alpha = "none") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

  print(g)
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_go.jpeg"))
}
```


###### Heatmap
```{r echo = F}
# Positive
fibvsmc_nebula_res_combined_reml_pooled_DiD_pos <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_pos[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_pos", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}

# Negative
fibvsmc_nebula_res_combined_reml_pooled_DiD_neg <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
  filter(logFC > 0 & group == "DiD") %>%
  arrange(desc(logFC)) %>%
  slice_head(n = 50) %>%
  pull(Gene)
for (i in 1:10) {
  go_subset <- go_res_fibvsmc_nebula_reml_pooled_neg[i,]
  pathway <- gsub("GOBP|GOMF|GOCC", "", gsub("_", " ", go_subset$pathway))
  
  heatmap_data <- fibvsmc_nebula_res_combined_reml_pooled_DiD %>%
    filter(Gene %in% go_subset$leadingEdge[[1]])

  g <- ggplot(heatmap_data, aes(x = group, y = Gene, fill = logFC)) +
    geom_tile(aes(alpha = a), color = NA) +  # remove tile borders
    scale_fill_gradient2(low = "#4575b4", mid = "white", high = "#d73027", midpoint = 0) +
    scale_alpha_continuous(range = c(0.7, 0.8)) +
    coord_fixed() +  # keeps square tiles, removes space from unequal axes
    theme_minimal(base_size = 10) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
      axis.text.y = element_text(size = 6),
      panel.grid = element_blank(),
      panel.spacing = unit(0, "pt"),
      plot.margin = margin(0, 0, 0, 0),
      legend.text = element_text(size = 9),
      legend.title = element_text(size = 9)
    ) +
    labs(
      y = NULL,
      x = NULL,
      fill = "logFC",
      title = pathway
    ) +
    guides(alpha = "none")

  print(g)

  ggsave(
    filename = paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmc_nebula_neg", i, "_go_heatmap.jpeg"),
    plot = g,
    width = 4,
    height = 4,
    dpi = 300
  )
}
```



## Combined volcano

```{r echo = F}
# plot_volcano(pt_nebula_res_combined_reml_pooled, "logFC_treatmentDapagliflozin:visitPOST", 
#              "fdr_interaction",
#              "PT (REML & pooled Offset)", 
#              "logFC Treatment(Dapagliflozin):Visit(POST)", 
#              "-log10(FDR adjusted p-value)",
#              "nebula/pt_placebo_pvalue_nebula_reml_pooled")

combined_nebula_reml_pooled <- 
  rbind(pt_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "PT"), 
        tal_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "TAL"),
        pc_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "PC"),
        immune_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "Immune"),
        ic_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "IC"),
        ec_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "EC"),
        fibvsmc_nebula_res_combined_reml_pooled %>%
          mutate(celltype = "FIB/VSMC/P")) %>%
  mutate(fdr_interaction_cat = case_when(fdr_interaction < 0.05 & 
                                           `logFC_treatmentDapagliflozin:visitPOST` > 0 ~
                                           "Positive & P < 0.05",
                                         fdr_interaction < 0.05 & 
                                           `logFC_treatmentDapagliflozin:visitPOST` < 0 ~
                                           "Negative & P < 0.05",
                                         T ~ "P > 0.05"))


# volcano plot with no label
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))


# find genes that are significant in more than one celltype
shared_genes <- combined_nebula_reml_pooled %>%
  filter(fdr_interaction < 0.05) %>%
  group_by(Gene) %>%
  dplyr::summarise(sig_gene_count = n(), .groups = "drop") %>%
  filter(sig_gene_count > 1) %>%
  arrange(desc(sig_gene_count)) %>%
  pull(Gene)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% shared_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  color = "black",
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in TCA cycle
tca_genes <- c(
  "ACO1", "ACO2", "IDH1", "IDH2", "IDH3A", "IDH3B", "IDH3G", "OGDH", "OGDHL",
  "SUCLA2", "SUCLG1", "SUCLG2", "SDHA", "SDHB", "SDHC", "SDHD", "FH", "MDH1",
  "MDH2", "FAS", "CS"
)

combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% tca_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# label genes in oxphos cycle
oxphos_genes <- c(
  "NDUFS6",  "SDHB", "SDHC", "SDHD",
  "UQCRC1", "UQCRC2", "COX4I1", "COX4I2", "ATP5PF"
)
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` < 10) %>%
  ggplot(aes(x = celltype, 
             y = `logFC_treatmentDapagliflozin:visitPOST`, 
             color = fdr_interaction_cat)) +
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text_repel(data = . %>% filter(Gene %in% oxphos_genes),
                  aes(label = Gene),
                  size = 3,
                  max.overlaps = 100,
                  box.padding = 0.3,
                  point.padding = 0.2,
                  min.segment.length = 0,
                  force = 150,
                  segment.size = 0.2,
                  show.legend = FALSE,
                  fontface = "bold") +
  theme(panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "none") +
  labs(x = NULL, 
       y = "Interaction logFC") +
  scale_color_manual(values = c("#457b9d", "#ced4da", "#f28482"))

# ggsave(
#   filename = "",
#   width = 4,
#   height = 4,
#   dpi = 300
# )

```

## Number of DEGs
```{r echo = F}
celltype_list <- c("pt", "tal", "pc", "immune", "immune_myeloid", "immune_lymphoid", "ic", "ec", "fibvsmc")
names_nebula_res_combined_reml_pooled <- paste0(celltype_list, "_nebula_res_combined_reml_pooled")

# Create a named list of data frames
df_list <- mget(names_nebula_res_combined_reml_pooled)
names(df_list) <- toupper(celltype_list)  # Set uppercase names for celltype labeling

# Combine and add celltype column
combined <- bind_rows(df_list, .id = "celltype")

# Create the summary table
deg_summary <- combined %>%
  mutate(direction_fdr = case_when(
           `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
           `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-",
           TRUE ~ "NS")) %>%
  dplyr::select(direction_fdr, celltype) %>%
  table() %>%
  as.data.frame()
deg_summary$celltype <- factor(deg_summary$celltype, levels = c("PT", "TAL", "PC", "IC", "EC", "FIBVSMC", "IMMUNE",
                   "IMMUNE_MYELOID", "IMMUNE_LYMPHOID"))
# Create the summary table
deg_summary_wide <- combined %>%
  mutate(direction_fdr = case_when(
    `logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-",
    TRUE ~ "NS")) %>%
  count(direction_fdr, celltype) %>%
  pivot_wider(names_from = celltype, values_from = n, values_fill = 0) %>%
  as.data.frame()

save(deg_summary_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_comparison.RData")

deg_summary %>%
  ggplot(aes(x = celltype, y = Freq, fill = direction_fdr)) +
  geom_col(position = "stack") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 70, hjust = 1)) +
  scale_fill_manual(values = c("-" = "#457b9d",
                               "+" = "#f28482",
                               "NS" = "#ced4da")) +
  labs(fill = "DEG Direction", 
       x = NULL)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Cell type comparison/celltype_deg_stacked_barplot.jpeg",
       width = 5, height = 4)

```

## Transcript overlap analysis

```{r echo = F}
# upset plot
# combined
# upset_combined_dat <- combined %>%
#   filter(fdr_interaction < 0.05) %>%
#   mutate(direction_fdr = case_when(`logFC_treatmentDapagliflozin:visitPOST` > 0 & fdr_interaction < 0.05 ~ "+",
#                                    `logFC_treatmentDapagliflozin:visitPOST` < 0 & fdr_interaction < 0.05 ~ "-")) %>%
#   dplyr::select(celltype, Gene) %>%
#   mutate(present = 1) %>%
#   distinct() %>%
#   pivot_wider(names_from = celltype, values_from = present, values_fill = 0) %>%
#   as.data.frame()


# UpSetR::upset(upset_combined_dat)


upset_combined_df <- combined %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID")) %>%
  filter(fdr_interaction < 0.05) %>%
  dplyr::select(celltype, Gene, `logFC_treatmentDapagliflozin:visitPOST`, fdr_interaction) %>%
  group_by(Gene) %>%
  dplyr::summarize(
    celltype = list(unique(celltype))
  ) %>%
  arrange(lengths(celltype))
set_sizes <- upset_combined_df %>%
  unnest(celltype) %>%
  dplyr::count(celltype, name = "size") %>%
  arrange(desc(size))

ordered <- set_sizes$celltype           # vector of cell types in the desired order
combo_ordered <- data.frame(combo_strings = map_chr(unique(upset_combined_df$celltype), ~ str_c(sort(.x), collapse = "-")),
                            combo_ranks = map(unique(upset_combined_df$celltype), ~ match(.x, ordered)) %>%
                              map(~ .x[!is.na(.x)]) %>%
                              map_chr(~ str_c(sprintf("%02d", .x), collapse = "-"))) %>%
  mutate(combo_size = str_count(combo_ranks, "-") + 1,
         combo_first = as.numeric(map_chr(combo_ranks, ~ {
           nums <- as.integer(str_split(.x, "-", simplify = TRUE))
           sprintf("%02d", min(nums, na.rm = TRUE))
         }))) %>%  # count number of ranks
  arrange(combo_first, combo_size)

upset_plot <- upset_combined_df %>%
  mutate(overlap_category = case_when(lengths(celltype) > 2 ~ "2+",
                               T ~ "1-2")) %>%
  ggplot(aes(x = celltype)) +
  geom_bar_rounded(aes(fill = overlap_category)) +
  scale_x_mergelist(sep = "-", position = "bottom",
                    limits = combo_ordered$combo_strings) +
  axis_combmatrix(sep = "-", levels = ordered,
                  override_plotting_function = function(df){
                    print(class(df))
                    print(df)
                    df %>%
                      mutate(celltype_lengths = case_when(
                        ! observed ~ "Not observed",
                        T ~ as.character(lengths(labels_split)))) %>%
    ggplot(aes(x= at, y= single_label)) +
      geom_rect(aes(fill= index %% 2 == 0), ymin=df$index-0.5, ymax=df$index+0.5, xmin=0, xmax=1) +
      geom_point(aes(color= celltype_lengths), size = 4) +
      geom_line(data= function(dat) dat[dat$observed, ,drop=FALSE], aes(group = labels, color= celltype_lengths), linewidth= 0.5) +
      ylab("") + xlab("") +
      scale_x_continuous(limits = c(0, 1), expand = c(0, 0)) +
      scale_fill_manual(values= c(`TRUE` = "white", `FALSE` = "white")) +
      scale_color_manual(values= c("1" = "#bbc7dc",
                                   "2" = "#bbc7dc",
                                   "3" = "#6d90b9",
                                   "4" = "#6d90b9",
                                   "5" = "#6d90b9",
                                   "6" = "#6d90b9",
                                   "7" = "#6d90b9",
                                   "Not observed" = "#F7F7F7")) +
      guides(color="none", fill="none") +
      theme(
        panel.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.ticks.length = unit(0, "pt"),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank(),
        text = element_text(size = 20)
      )
  }) +
  scale_fill_manual(values= c("1-2" = "#bbc7dc",
                              "2+" = "#6d90b9")) +
  geom_text(stat='count', aes(label=after_stat(count), 
            color = overlap_category),
            vjust=0.5, hjust = -0.2, angle = 90, size = 6) +
  scale_color_manual(values= c("1-2" = "#bbc7dc",
                               "2+" = "#6d90b9")) +
  theme_bw() +
  labs(x = NULL, y = "Count", fill = "# of overlaps") +
  theme(panel.grid = element_blank(),
        text = element_text(size = 25),
        legend.position = c(0.92,0.9),
        legend.key.size = unit(60, "pt")) +
  guides(color = "none")

p_side <- ggplot(set_sizes, aes(x = -size, y = fct_rev(factor(celltype, levels = c(ordered))))) +
  geom_col(width = 0.6, color = "#385674") +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(labels = abs) + 
  theme_minimal(base_size = 25) +
  theme(
    panel.grid = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(), 
    text = element_text(size = 25)) +
  coord_cartesian(expand = FALSE)

library(cowplot)

ggdraw() +
  draw_plot(
    cowplot::plot_grid(
      cowplot::plot_grid(
        NULL,
        p_side + theme(plot.margin = unit(c(1, -3, -15, 10), "pt")),
        ncol = 1, rel_heights = c(5.5, 1)
      ),
      upset_plot,
      nrow = 1,
      rel_widths = c(0.3, 3)
    ),
    x = 0.05, y = 0.05, width = 0.95, height = 0.95  # shrink to add outer padding
  )
ggsave(filename = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Upset/celltype_deg_upset.jpeg",
       width = 30, height = 15)

```
```{r echo = F}
combined_sig <- combined %>%
  filter(fdr_interaction < 0.05) %>%
  dplyr::select(Gene, celltype) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID"))

unique_genes_per_celltype <- combined_sig %>%
  group_by(Gene) %>%
  mutate(n_celltypes = n()) %>%
  ungroup() %>%
  filter(n_celltypes == 1) %>%  # Genes appearing in only one cell type
  count(celltype) %>%
  dplyr::rename(unique_genes = n) %>%
  mutate(unique_genes = unique_genes/2) # duplicates plotted

chord_plot_dat <- combined_sig %>%
  # Self-join to find all celltype pairs for each gene
  inner_join(combined_sig, by = "Gene", suffix = c("_1", "_2"), relationship = "many-to-many") %>%
  # # Remove self-pairs (same celltype)
  filter(celltype_1 != celltype_2) %>%
  # Count shared genes between each celltype pair
  count(celltype_1, celltype_2) %>%
  # Create symmetric matrix
  pivot_wider(names_from = celltype_2, values_from = n, values_fill = 0) %>%
  column_to_rownames("celltype_1") %>%
  as.matrix()
chord_plot_dat <- chord_plot_dat[, rownames(chord_plot_dat)]
# Add unique genes to the diagonal
for(ct in unique_genes_per_celltype$celltype) {
  if(ct %in% rownames(chord_plot_dat)) {
    chord_plot_dat[ct, ct] <- unique_genes_per_celltype$unique_genes[unique_genes_per_celltype$celltype == ct]
  }
}

chord_plot_dat[upper.tri(chord_plot_dat)] <- 0

cell_types <- rownames(chord_plot_dat)
cell_colors <- setNames(c("#f26b21", "#fcec52", "#cbdb47", "#99ca3c", 
                          "#208b3a", "#fbb040", "#f78e31"), cell_types)

# cell_colors <- setNames(c("#1", "#4", "#5", "#6", 
#                           "#7", "#3", "#2"), cell_types)

# Create blended colors for ribbons
col_fun_blend <- function(mat) {
  n <- nrow(mat)
  col_mat <- matrix(NA, n, n)
  for(i in 1:n) {
    for(j in 1:n) {
      if(mat[i,j] > 0) {
        # Blend the two cell type colors
        col1 <- col2rgb(cell_colors[rownames(mat)[i]])
        col2 <- col2rgb(cell_colors[rownames(mat)[j]])
        blended <- rgb((col1[1] + col2[1])/2/255,
                       (col1[2] + col2[2])/2/255,
                       (col1[3] + col2[3])/2/255,
                       alpha = 0.6)
        col_mat[i,j] <- blended
      }
    }
  }
  return(col_mat)
}

chord_colors_blended <- col_fun_blend(chord_plot_dat)


# Create a logical matrix with same dimensions as chord_plot_dat
logical_matrix <- matrix(TRUE, 
                        nrow = nrow(chord_plot_dat), 
                        ncol = ncol(chord_plot_dat),
                        dimnames = list(rownames(chord_plot_dat), 
                                      colnames(chord_plot_dat)))

# Set diagonal to FALSE
diag(logical_matrix) <- FALSE

# Open PNG device
png("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Proportions/celltype_deg_chordplot.png", width = 800, height = 800, res = 150)

# Your plotting code
circos.clear()
chordDiagram(chord_plot_dat, transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T)

# Close the device
dev.off()
circos.clear()
```

```{r echo = F}
# Create set sizes data frame
set_sizes_df <- combined_sig %>%
  count(celltype) %>%
  filter(celltype %in% cell_types) %>%
  arrange(match(celltype, cell_types))

# Initialize the plot
circos.clear()
circos.par("track.height" = 0.1, 
           "gap.after" = rep(3, length(cell_types)),
           "start.degree" = 90)

# par(
#   family = "Outfit", cex = 2, col = "black", # font family, size, color
#   mai = rep(0.5, 4) # plot margin in inches
# ) 

# Create chord diagram
chordDiagram(chord_plot_dat, 
             transparency = 0.1,
             grid.col = cell_colors,
             col = chord_colors_blended,
             annotationTrack = c("name", "grid"),
             link.largest.ontop = T,
             self.link = 1,
             link.visible = logical_matrix,
             link.sort = T,
             link.decreasing = T,
             link.border = "black", link.lwd = 0.2,
             preAllocateTracks = list(track.height = 0.001)
             )

# Add barplot track
circos.track(ylim = c(0, max(set_sizes_df$n) * 1.1),
             bg.border = NA,
             track.height = 0.2,
             panel.fun = function(x, y) {
               sector.index = get.cell.meta.data("sector.index")
               xlim = get.cell.meta.data("xlim")
               
               # Get the value for this sector
               value = set_sizes_df$n[set_sizes_df$celltype == sector.index]
               
               # Draw rectangle (bar)
               circos.rect(xlim[1], 0, xlim[2], value,
                          col = cell_colors[sector.index],
                          border = cell_colors[sector.index])
               
               # Add text label
               circos.text(mean(xlim), value + max(set_sizes_df$n) * 0.02,
                          labels = value,
                          sector.index = sector.index,
                          facing = "inside",
                          niceFacing = TRUE,
                          cex = 1,
                          adj = c(0.5, 0))
             })

# Add y-axis for the barplot
circos.yaxis(side = "left", 
             sector.index = cell_types[1],
             labels.cex = 0.5,
             at = pretty(c(0, max(set_sizes_df$n)), n = 3))

circos.clear()
```

```{r echo = F}
upset_combined_df %>%
  arrange(desc(lengths(celltype)))

combined_wide <- combined %>%
  filter(fdr_interaction < 0.05) %>%
  filter(celltype %nin% c("IMMUNE_MYELOID", "IMMUNE_LYMPHOID")) %>%
  mutate(logFC_direction = case_when(`logFC_treatmentDapagliflozin:visitPOST` < 0 ~ "-",
                                     `logFC_treatmentDapagliflozin:visitPOST` > 0 ~ "+")) %>%
  dplyr::select(Gene, celltype, logFC_direction) %>%
  pivot_wider(
    names_from = celltype,
    values_from = logFC_direction,
    values_fn = list(direction = identity)) %>%
  rowwise() %>%
  dplyr::mutate(n_pos = sum(c_across(PT:FIBVSMC) == "+", na.rm = TRUE),
                n_neg = sum(c_across(PT:FIBVSMC) == "-", na.rm = TRUE),
                n_total = sum(!is.na(c_across(PT:FIBVSMC)))) %>%
  ungroup() %>%
  arrange(desc(n_total))

save(combined_wide, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/celltype_deg_concordance.RData")


gene_list_4 <- combined_wide %>%
  filter(n_total >= 4) %>%
  pull(Gene)

save(gene_list_4, file = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/model comparison/gene_list_greater_than_3.RData")

```

## Investigate outlier

```{r echo = F}
combined_nebula_reml_pooled %>%
  filter(`logFC_treatmentDapagliflozin:visitPOST` > 10)

# immune cell: TRHDE-AS1
# immune cell: FGF14
# fib/vsmc/p: PSAT1
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_DiD_pathways_nebula.xls", skip = 1)
pt_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_dapa_pathways_nebula.xls", skip = 1)
pt_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pt_placebo_pathways_nebula.xls", skip = 1)

colnames(pt_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_nebula <- pt_pathways_nebula %>%
  full_join(pt_dapa_nebula) %>% full_join(pt_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_nebula$scenario <- factor(pt_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_nebula <- pt_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_nebula$pathway <- reorder(pt_pathways_inhibited_nebula$pathway, pt_pathways_inhibited_nebula$neg_log_p)
  
pt_top30_inhibited_nebula <- pt_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_nebula <- pt_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_nebula$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_nebula))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_nebula + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_nebula <- pt_pathways_inhibited_nebula %>%
  filter(z <= -2)
pt_top30_inhibited_2_nebula <- pt_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_nebula$z), max(-pt_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) 

## top30_inhibited_nebula + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_nebula <- pt_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_nebula$pathway <- reorder(pt_pathways_activated_nebula$pathway, pt_pathways_activated_nebula$neg_log_p)
  
pt_top30_activated_nebula <- pt_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.1) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_nebula <- pt_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_nebula <- pt_pathways_activated_nebula %>%
  filter(z > 2)
pt_top30_activated_2_nebula <- pt_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_nebula$z), max(pt_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pt_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_nebula$name <- factor(pt_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_nebula <- pt_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_nebula$name <- factor(pt_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_nebula
pt_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 20, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pt_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_DiD_pathways_nebula.xls", skip = 1)
tal_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_dapa_pathways_nebula.xls", skip = 1)
tal_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/tal_placebo_pathways_nebula.xls", skip = 1)

colnames(tal_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_nebula <- tal_pathways_nebula %>%
  full_join(tal_dapa_nebula) %>% full_join(tal_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_nebula$scenario <- factor(tal_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_nebula <- tal_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_nebula$pathway <- reorder(tal_pathways_inhibited_nebula$pathway, tal_pathways_inhibited_nebula$neg_log_p)
  
tal_top30_inhibited_nebula <- tal_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_nebula <- tal_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_nebula <- tal_pathways_inhibited_nebula %>%
  filter(z < -2)
tal_top30_inhibited_2_nebula <- tal_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_nebula$z), max(-tal_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_nebula <- tal_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_nebula$pathway <- reorder(tal_pathways_activated_nebula$pathway, tal_pathways_activated_nebula$neg_log_p)
  
tal_top30_activated_nebula <- tal_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 2.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_nebula <- tal_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_nebula <- tal_pathways_activated_nebula %>%
  filter(z > 2)
tal_top30_activated_2_nebula <- tal_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_nebula$z), max(tal_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/tal_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_nebula$name <- factor(tal_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_nebula <- tal_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_nebula$name <- factor(tal_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_nebula
tal_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/tal_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_DiD_pathways_nebula.xls", skip = 1)
pc_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_dapa_pathways_nebula.xls", skip = 1)
pc_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/pc_placebo_pathways_nebula.xls", skip = 1)

colnames(pc_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_nebula <- pc_pathways_nebula %>%
  full_join(pc_dapa_nebula) %>% full_join(pc_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_nebula$scenario <- factor(pc_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_nebula <- pc_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_nebula$pathway <- reorder(pc_pathways_inhibited_nebula$pathway, pc_pathways_inhibited_nebula$neg_log_p)
  
pc_top30_inhibited_nebula <- pc_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_nebula <- pc_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_nebula <- pc_pathways_inhibited_nebula %>%
  filter(z < -2)
pc_top30_inhibited_2_nebula <- pc_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_nebula$z), max(-pc_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_nebula <- pc_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_nebula$pathway <- reorder(pc_pathways_activated_nebula$pathway, pc_pathways_activated_nebula$neg_log_p)
  
pc_top30_activated_nebula <- pc_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_nebula <- pc_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_nebula <- pc_pathways_activated_nebula %>%
  filter(z > 2)
pc_top30_activated_2_nebula <- pc_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_nebula$z), max(pc_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/pc_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_nebula$name <- factor(pc_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_nebula <- pc_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_nebula$name <- factor(pc_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_nebula
pc_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/pc_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_DiD_pathways_nebula.xls", skip = 1)
immune_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_dapa_pathways_nebula.xls", skip = 1)
immune_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/immune_placebo_pathways_nebula.xls", skip = 1)

colnames(immune_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_nebula <- immune_pathways_nebula %>%
  full_join(immune_dapa_nebula) %>% full_join(immune_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_nebula$scenario <- factor(immune_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_nebula <- immune_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_nebula$pathway <- reorder(immune_pathways_inhibited_nebula$pathway, immune_pathways_inhibited_nebula$neg_log_p)
  
immune_top30_inhibited_nebula <- immune_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_nebula <- immune_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_nebula <- immune_pathways_inhibited_nebula %>%
  filter(z < -2)
immune_top30_inhibited_2_nebula <- immune_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_nebula$z), max(-immune_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_nebula <- immune_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_nebula$pathway <- reorder(immune_pathways_activated_nebula$pathway, immune_pathways_activated_nebula$neg_log_p)
  
immune_top30_activated_nebula <- immune_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_nebula <- immune_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_nebula <- immune_pathways_activated_nebula %>%
  filter(z > 2)
immune_top30_activated_2_nebula <- immune_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_nebula$z), max(immune_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/immune_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_nebula$name <- factor(immune_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_nebula <- immune_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_nebula$name <- factor(immune_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_nebula
immune_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/immune_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_DiD_pathways_nebula.xls", skip = 1)
ic_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_dapa_pathways_nebula.xls", skip = 1)
ic_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ic_placebo_pathways_nebula.xls", skip = 1)

colnames(ic_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_nebula <- ic_pathways_nebula %>%
  full_join(ic_dapa_nebula) %>% full_join(ic_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_nebula$scenario <- factor(ic_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_nebula <- ic_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_nebula$pathway <- reorder(ic_pathways_inhibited_nebula$pathway, ic_pathways_inhibited_nebula$neg_log_p)
  
ic_top30_inhibited_nebula <- ic_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_nebula <- ic_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_nebula <- ic_pathways_inhibited_nebula %>%
  filter(z < -2)
ic_top30_inhibited_2_nebula <- ic_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_nebula$z), max(-ic_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_nebula <- ic_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_nebula$pathway <- reorder(ic_pathways_activated_nebula$pathway, ic_pathways_activated_nebula$neg_log_p)
  
ic_top30_activated_nebula <- ic_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_nebula <- ic_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_nebula <- ic_pathways_activated_nebula %>%
  filter(z > 2)
ic_top30_activated_2_nebula <- ic_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_nebula$z), max(ic_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ic_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_nebula$name <- factor(ic_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_nebula <- ic_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_nebula$name <- factor(ic_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_nebula
ic_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ic_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_DiD_pathways_nebula.xls", skip = 1)
ec_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_dapa_pathways_nebula.xls", skip = 1)
ec_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/ec_placebo_pathways_nebula.xls", skip = 1)

colnames(ec_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_nebula <- ec_pathways_nebula %>%
  full_join(ec_dapa_nebula) %>% full_join(ec_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_nebula$scenario <- factor(ec_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_nebula <- ec_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_nebula$pathway <- reorder(ec_pathways_inhibited_nebula$pathway, ec_pathways_inhibited_nebula$neg_log_p)
  
ec_top30_inhibited_nebula <- ec_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_nebula <- ec_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_nebula <- ec_pathways_inhibited_nebula %>%
  filter(z < -2)
ec_top30_inhibited_2_nebula <- ec_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_nebula$z), max(-ec_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_nebula <- ec_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_nebula$pathway <- reorder(ec_pathways_activated_nebula$pathway, ec_pathways_activated_nebula$neg_log_p)
  
ec_top30_activated_nebula <- ec_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_nebula <- ec_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_nebula <- ec_pathways_activated_nebula %>%
  filter(z > 2)
ec_top30_activated_2_nebula <- ec_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_nebula$z), max(ec_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/ec_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_nebula$name <- factor(ec_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_nebula <- ec_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_nebula$name <- factor(ec_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_nebula
ec_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/ec_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_DiD_pathways_nebula.xls", skip = 1)
dtl_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_dapa_pathways_nebula.xls", skip = 1)
dtl_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/dtl_placebo_pathways_nebula.xls", skip = 1)

colnames(dtl_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_nebula <- dtl_pathways_nebula %>%
  full_join(dtl_dapa_nebula) %>% full_join(dtl_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_nebula$scenario <- factor(dtl_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_nebula <- dtl_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_nebula$pathway <- reorder(dtl_pathways_inhibited_nebula$pathway, dtl_pathways_inhibited_nebula$neg_log_p)
  
dtl_top30_inhibited_nebula <- dtl_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_nebula <- dtl_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_nebula <- dtl_pathways_inhibited_nebula %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_nebula <- dtl_pathways_inhibited_sig_nebula[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_nebula$z), max(-dtl_pathways_inhibited_sig_nebula$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_inhibited_pathways_2.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_nebula <- dtl_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_nebula$pathway <- reorder(dtl_pathways_activated_nebula$pathway, dtl_pathways_activated_nebula$neg_log_p)
  
dtl_top30_activated_nebula <- dtl_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_nebula <- dtl_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_nebula <- dtl_pathways_activated_nebula %>%
  filter(z > 2)
dtl_top30_activated_2_nebula <- dtl_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_nebula$z), max(dtl_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/dtl_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_nebula$name <- factor(dtl_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_nebula <- dtl_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_nebula$name <- factor(dtl_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_nebula
dtl_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/dtl_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_DiD_pathways_nebula.xls", skip = 1)
fibvsmcp_dapa_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_dapa_pathways_nebula.xls", skip = 1)
fibvsmcp_placebo_nebula <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/nebula/fibvsmc_placebo_pathways_nebula.xls", skip = 1)

colnames(fibvsmcp_pathways_nebula) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_nebula) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_placebo_nebula) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_nebula <- fibvsmcp_pathways_nebula %>%
  full_join(fibvsmcp_dapa_nebula) %>% full_join(fibvsmcp_placebo_nebula) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_nebula$scenario <- factor(fibvsmcp_pathways_merged_nebula$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_nebula <- fibvsmcp_pathways_merged_nebula %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_nebula$pathway <- reorder(fibvsmcp_pathways_inhibited_nebula$pathway, fibvsmcp_pathways_inhibited_nebula$neg_log_p)
  
fibvsmcp_top30_inhibited_nebula <- fibvsmcp_pathways_inhibited_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_nebula <- fibvsmcp_pathways_inhibited_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top30_inhibited_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_nebula <- fibvsmcp_pathways_inhibited_nebula %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_nebula <- fibvsmcp_pathways_inhibited_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_nebula$z), max(-fibvsmcp_pathways_inhibited_sig_nebula$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top_inhibited_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_nebula <- fibvsmcp_pathways_merged_nebula %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_nebula$pathway <- reorder(fibvsmcp_pathways_activated_nebula$pathway, fibvsmcp_pathways_activated_nebula$neg_log_p)
  
fibvsmcp_top30_activated_nebula <- fibvsmcp_pathways_activated_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_nebula <- fibvsmcp_pathways_activated_nebula %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top30_activated_pathways_nebula.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_nebula <- fibvsmcp_pathways_activated_nebula %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_nebula <- fibvsmcp_pathways_activated_sig_nebula[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_nebula$z), max(fibvsmcp_pathways_activated_sig_nebula$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/nebula/fibvsmcp_top_activated_pathways_2.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_nebula <- fibvsmcp_pathways_merged_nebula %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_nebula$name <- factor(fibvsmcp_neg_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/fibvsmcp_top10_inhibited_pathway_zscores.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_nebula <- fibvsmcp_pathways_merged_nebula %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_nebula$name <- factor(fibvsmcp_pos_pathways_merged_long_nebula$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_nebula
fibvsmcp_pos_pathways_merged_long_nebula %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/nebula/fibvsmcp_top10_activated_pathway_zscores.jpeg",
       scale = 1.5)
```

