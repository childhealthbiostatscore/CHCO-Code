---
title: "ATTEMPT & CROCODILE emmeans visualization"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r echo = F, include = F}
library(dplyr)
library(kableExtra)
library(knitr)
library(ggplot2)
library(purrr)
library(tidyr)
library(stats)
library(patchwork)
library(UpSetR)
library(readxl)
library(fgsea)
library(ReactomeGSA)
library(GSEABase)
library(enrichplot)
library(enrichR)
library(ggrepel)
library(forcats)
library(stringr)
```

```{r echo = F, include = F}
dbs <- c("GO_Biological_Process_2023", 
         "KEGG_2021_Human",
         "Reactome_2022", 
         "Reactome_Pathways_2024")

# function to get precise p-value for large df in volcano plots
safe_pval <- function(t_stat, df, digits = 30) {
  logpt <- pt(q = abs(t_stat), df - 2, log.p = TRUE)
  explogpt <- exp(logpt)
  2*(1-as.numeric(sprintf(paste0("%.", digits, "e"), explogpt)))
}

# function for GSEA
# Set relevant paths
list.files()
bg_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/GSEA/"

# Functions ===================================================
## Function: Adjacency matrix to list -------------------------
matrix_to_list <- function(pws){
  pws.l <- list()
  for (pw in colnames(pws)) {
    pws.l[[pw]] <- rownames(pws)[as.logical(pws[, pw])]
  }
  return(pws.l)
}

## Function: prepare_gmt --------------------------------------
prepare_gmt <- function(gmt_file, genes_in_data, savefile = FALSE){

  # Read in gmt file
  gmt <- gmtPathways(gmt_file)
  hidden <- unique(unlist(gmt))
  
  # Convert gmt file to a matrix with the genes as rows and for each go annotation (columns) the values are 0 or 1
  mat <- matrix(NA, dimnames = list(hidden, names(gmt)),
                nrow = length(hidden), ncol = length(gmt))
  for (i in 1:dim(mat)[2]){
    mat[,i] <- as.numeric(hidden %in% gmt[[i]])
  }
  
  #Subset to the genes that are present in our data to avoid bias
  hidden1 <- intersect(genes_in_data, hidden)
  mat <- mat[hidden1, colnames(mat)[which(colSums(mat[hidden1,])>5)]] # filter for gene sets with more than 5 genes annotated
  # And get the list again
  final_list <- matrix_to_list(mat) # for this we use the function we previously defined
  
  if(savefile){
    saveRDS(final_list, file = paste0(gsub('.gmt', '', gmt_file), '_subset_', format(Sys.time(), '%d%m'), '.RData'))
  }
  
  print('Wohoo! .gmt conversion successfull!:)')
  return(final_list)
}

# Download gene sets .gmt files
#https://www.gsea-msigdb.org/gsea/msigdb/collections.jsp
```

```{r echo = F}
# Define directory path to files rendered in Hyak
dir_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/data from hyak/"

rds_files <- list.files(
  path = dir_path, 
  pattern = "^[a-z]+_attempt_.*",
  full.names = TRUE
)

for (f in rds_files) {
  obj_name <- gsub("\\.rds$", "", basename(f))
  
  # S3 created gzcon files instead of RDS
  con <- gzcon(file(f, "rb"))
  obj <- readRDS(con)
  close(con)
  
  # Assign object to the global environment
  assign(obj_name, obj, envir = .GlobalEnv)
}
```

```{r echo = F}
plot_volcano <- function(data, expr_col, p_col, title_suffix, x_axis, y_axis, file_suffix, p_thresh = 0.05) {
  expr_sym <- sym(expr_col)
  pval_sym <- sym(p_col)
  
  top_pos <- data %>%
    filter(!!expr_sym > 0, !!pval_sym < p_thresh) %>%
    arrange(!!pval_sym) %>%
    slice_head(n=20)

  top_neg <- data %>%
    filter(!!expr_sym < 0, !!pval_sym < p_thresh) %>%
    arrange(!!pval_sym) %>%
    slice_head(n=20)

  data <- data %>%
    mutate(top_color = case_when(Gene %in% top_pos$Gene ~ "#f28482",
                                 Gene %in% top_neg$Gene ~ "#457b9d",
                                 TRUE ~ "#ced4da"),
           top_size = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), 1.3, 1),
           top_lab  = if_else(Gene %in% c(top_pos$Gene, top_neg$Gene), Gene, ""))


  p <- ggplot(data, aes(x = !!expr_sym, y = -log10(!!pval_sym))) +
    geom_hline(yintercept = -log10(p_thresh), linetype = "dashed", color = "darkgrey") +
    geom_point(alpha = 0.5, aes(color = top_color, size = top_size)) +
    geom_text_repel(aes(label = top_lab, color = top_color),
                    size = 3, max.overlaps = Inf,
                    force = 6, segment.alpha = 0.3, segment.size = 0.3) +
    labs(title = title_suffix,
         x = x_axis,
         y = y_axis) +
    scale_size_continuous(range = c(1, 1.3)) + 
    scale_color_manual(values = c("#457b9d"="#457b9d", "#ced4da"="#ced4da", "#f28482"="#f28482")) +
    theme_minimal() +
    theme(legend.title = element_blank(),
          panel.grid = element_blank(),
          text = element_text(size = 15),
          title = element_text(size = 9)) +
    guides(color = "none", size = "none")
  
  ggsave(paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Volcano Plots/CROCODILE comparison analysis/", file_suffix, ".jpeg"), plot = p, width = 7, height = 5)
  return(p)
}
```


```{r echo = F}
# List of acronyms to uppercase
acronyms <- c("rna", "dna", "mtor", "foxo", "ppar", "nmd", "fgfr", "robo",
              "bhl", "cov", "jak", "stat", "wnt", "hiv", "bcl", "mapk",
              "pt", "tal", "pc", "ic", "ec", "fibvsmcp",
              unique(pt_attempt_scrna_mm_emmeans_combined$Gene))
special_mixed <- c("rrna", "mrna", "trna", "gtpase", "atpase", "robos", "slits", "fibvsmcp")
special_replacements <- c("rRNA", "mRNA", "tRNA", "GTPase", "ATPase", "ROBOs", "SLITs", "FIB/VSMC/P")

replace_mixed_case <- function(text, from, to) {
  for (i in seq_along(from)) {
    pattern <- paste0("\\b", from[i], "\\b")
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), to[i])
  }
  return(text)
}

capitalize_acronyms <- function(text, terms) {
  for (term in terms) {
    pattern <- paste0("\\b", term, "\\b")
    replacement <- toupper(term)
    text <- str_replace_all(text, regex(pattern, ignore_case = TRUE), replacement)
  }
  return(text)
}
plot_fgsea <- function(fgsea_res,
                            top_n = 30,
                            title = "Top Enriched Pathways",
                            xlimit = 3,
                            xnudge = xlimit/100,
                            text1 = 6.5,
                            text2 = 18,
                            text3 = 20,
                       face = "plain") {

fgsea_res <- fgsea_res %>%
  arrange(pval) %>%
  head(top_n) %>%
  mutate(
    direction = case_when(NES < 0 ~ "Negative", NES > 0 ~ "Positive"),
    pathway_clean = str_remove(pathway, "^KEGG_"),
    pathway_clean = str_remove(pathway_clean, "^REACTOME_"),
    pathway_clean = str_remove(pathway_clean, "^GOBP_"),
    pathway_clean = str_remove(pathway_clean, "^GOMF_"),
    pathway_clean = str_replace_all(pathway_clean, "_", " "),
    pathway_clean = str_to_sentence(pathway_clean),
    pathway_clean = str_replace_all(pathway_clean, "\\bi\\b", "I"),
    pathway_clean = str_replace_all(pathway_clean, "\\bii\\b", "II"),
    pathway_clean = str_replace_all(pathway_clean, "\\biii\\b", "III"),
    pathway_clean = str_replace_all(pathway_clean, "\\biv\\b", "IV"),
    pathway_clean = str_replace_all(pathway_clean, "\\bv\\b", "V"),
    pathway_clean = str_replace_all(pathway_clean, regex("\\(immune\\)", ignore_case = TRUE), "(IMMUNE)"),
    pathway_clean = capitalize_acronyms(pathway_clean, acronyms),
    pathway_clean = replace_mixed_case(pathway_clean, special_mixed, special_replacements),
    pathway_clean = paste0(pathway_clean, " (", size, ")")
  ) %>%
  arrange(pval)

  fgsea_res$pathway_clean <- reorder(fgsea_res$pathway_clean, fgsea_res$pval)

  fgsea_res %>%
    ggplot(aes(x = -log10(pval), y = fct_rev(pathway_clean), label = pathway_clean)) +
    geom_point(aes(size = abs(NES), color = direction, alpha = 0.8)) +
    geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
    geom_text(aes(group = pathway_clean, color = direction, fontface = face),
              hjust = 0, size = text1, nudge_x = xnudge) +
    scale_size_binned() +
    scale_color_manual(values = c("Positive" = "#c75146", "Negative" = "#2c7da0")) +
    scale_x_continuous(limits = c(0, xlimit), expand = expansion(mult = c(0, 0))) +
    scale_y_discrete(expand = expansion(add = 1)) +
    labs(
      x = "-log(p-value)",
      y = "Pathways",
      color = "Direction",
      size = "NES",
      title = title
    ) +
    guides(alpha = "none") +
    theme_bw() +
    theme(
      axis.text.y = element_blank(),
      panel.grid = element_blank(),
      axis.text.x = element_text(size = text3),
      axis.title = element_text(size = text3),
      axis.ticks.y = element_blank(),
      legend.position = c(0.9, 0.2),
      legend.background = element_blank(),
      legend.box.background = element_rect(color = "black"),
      legend.title = element_text(size = text2),
      legend.text = element_text(size = text2),
      title = element_text(size = text3)
    )
}


plot_enrichr_results <- function(data, top_n = 10, title, file_path, bar_color = "#c75146", xadd = 10) {
  p <- ggplot(data[1:top_n, ], aes(x = reorder(Term, -Combined.Score), y = Combined.Score)) +
    geom_bar(stat = "identity", fill = bar_color) +
    geom_text(aes(label = Overlap), vjust = -0.5, size = 3) +
    labs(title = title,
         x = NULL,
         y = "Combined Score") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
          panel.grid = element_blank()) +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +  # fix here: y-axis should be continuous
    scale_x_discrete(expand = expansion(add = c(xadd, 0)))

  ggsave(file_path, plot = p, scale = 1.5, width = 8, height = 5)
  return(p)
}
```


# CROCODILE Results
## emmeans
### PT

```{r echo = F}
## keep converged model results only
pt_croc_model_filtered <- pt_attempt_scrna_mm_model_combined %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pt_croc_emmeans_filtered <- pt_attempt_scrna_mm_emmeans_combined %>%
  filter(Gene %in% pt_model_filtered$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))

## non-converged genes percentage
pt_croc_nonconverged_genes <- unique((pt_attempt_scrna_mm_model_combined %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pt_croc_nonconverged_percentage <- (length(unique(pt_croc_nonconverged_genes))/length(unique(pt_attempt_scrna_mm_model_combined$Gene)))*100
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
pt_croc_ordered_model <- subset(pt_model_filtered, Variable == "GroupType_1_Diabetes") %>%
  arrange(PValue)
pt_croc_gene_order <- factor(pt_croc_ordered_model$Gene, levels = ordered_model$Gene)
pt_croc_sig_genes <- subset(pt_model_filtered, Variable == "GroupType_1_Diabetes" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pt_croc_emmeans_diff <- pt_croc_emmeans_filtered %>%
  pivot_wider(names_from = Group, values_from = c(emmean, SE)) %>%
  group_by(Gene) %>%
  fill(ends_with("Control"), ends_with("Diabetes")) %>%
  mutate(diff_emmean = emmean_Type_1_Diabetes - emmean_Lean_Control,
         SE_diff = sqrt(SE_Type_1_Diabetes^2 + SE_Lean_Control^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(group_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

pt_croc_emmeans_diff_raw <- pt_croc_emmeans_diff
pt_croc_emmeans_diff <- pt_croc_emmeans_diff_raw %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_croc_emmeans_diff) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_croc_emmeans_diff, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/CROCODILE comparison analysis/emmeans/pt_croc_emmeans_diff.csv", row.names = F)
```

#### Volcano plots
```{r echo = F}
plot_volcano(pt_croc_emmeans_diff, "Expr p-value",
             "PT CROCODILE Group Comparison", 
             "EMM Delta (T1D - HC)", 
             "-log10(p-value)",
             "/pt_croc_pvalue")

# Counts
# Total, p-value, q-value
pt_croc_tot_pos <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` > 0))
pt_croc_tot_neg <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` < 0))
pt_croc_sig_pos <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
pt_croc_sig_neg <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
pt_croc_adj_sig_pos <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
pt_croc_adj_sig_neg <- nrow(pt_croc_emmeans_diff %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

pt_croc_count <- data.frame(total = c(pt_croc_tot_pos, pt_croc_tot_neg),
                            pvalue = c(pt_croc_sig_pos, pt_croc_sig_neg),
                            fdr = c(pt_croc_adj_sig_pos, pt_croc_adj_sig_neg))
rownames(pt_croc_count) <- c("Positive", "Negative")
kable(pt_croc_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))

```

#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# significant positive
pt_croc_pos <- (pt_croc_emmeans_diff %>% filter(`Expr p-value` < 0.05) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative
pt_croc_neg <- (pt_croc_emmeans_diff %>% filter(`Expr p-value` < 0.05) %>%
                  filter(`Expr Other` < 0))$Gene
#  positive
pt_croc_gsea_pos <- enrichr(pt_croc_pos, dbs)
#  negative
pt_croc_gsea_neg <- enrichr(pt_croc_neg, dbs)


pt_croc_gsea_pos
pt_croc_gsea_neg

plotEnrich(as.data.frame(pt_croc_gsea_pos[[1]]), title = "Positive - PT CROCODILE GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_go_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_pos[[2]]), title = "Model 3 Positive - PT CROCODILE KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_kegg_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_pos[[3]]), title = "Model 3 Positive - PT CROCODILE REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_reactome22_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_pos[[4]]), title = "Model 3 Positive - PT CROCODILE REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_reactome24_mod3.jpeg")

plotEnrich(as.data.frame(pt_croc_gsea_neg[[1]]), title = "Model 3 Negative - PT CROCODILE GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_go_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_neg[[2]]), title = "Model 3 Negative - PT CROCODILE KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_kegg_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_neg[[3]]), title = "Model 3 Negative - PT CROCODILE REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_reactome22_mod3.jpeg")
plotEnrich(as.data.frame(pt_croc_gsea_neg[[4]]), title = "Model 3 Negative - PT CROCODILE REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_reactome24_mod3.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_croc_model_filtered$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_croc_model_filtered$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_croc_model_filtered$Gene), savefile = FALSE)

# rank genes by t-stats
rankings_pt_croc <- pt_croc_emmeans_diff_raw$t_stat
names(rankings_pt_croc) <- pt_croc_emmeans_diff_raw$Gene
rankings_pt_croc <- sort(rankings_pt_croc, decreasing = TRUE)
plot(rankings_pt_croc)
min(rankings_pt_croc)
max(rankings_pt_croc)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_croc <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_croc,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_croc <- fgsea(pathways = reactome,
                              stats = rankings_pt_croc,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_croc <- fgsea(pathways = go,
                        stats = rankings_pt_croc,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_croc[, padj < 0.05]), sum(kegg_legacy_res_pt_croc[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_pt_croc[, padj < 0.05]), sum(reactome_res_pt_croc[, pval < 0.05])),
                         "GO"=c(sum(go_res_pt_croc[, padj < 0.05]), sum(go_res_pt_croc[, pval < 0.05])))
rownames(fgsea) <- c("adj.pval", "p.val")
fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_pt_croc, title = "PT CROCODILE Top 30 KEGG", xnudge = 0.03)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_kegg_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_pt_croc, title = "PT CROCODILE Top 30 REACTOME", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_reactome_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_pt_croc, title = "PT CROCODILE Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_go_pathways.jpeg",
       width = 27.5, height = 14, scale = 1)
```
#### Targeted approach in ATTEMPT (Model 3)

```{r echo = F}
## read ATTEMPT mixed model results dataframe (rendered in Hyak)
pt_attempt_model_df_mod3 <-  readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/pt_attempt_scrna_mm_model_combined_3.rds")

## read ATTEMPT emmeans dataframe (rendered in Hyak)
pt_attempt_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/pt_attempt_scrna_mm_emmeans_combined_3.rds")

### read ATTEMPT DiD emmeans
pt_emmeans_diff_DiD_mod3 <- read.csv("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/pt_emmeans_diff_DiD_3.csv")
```
##### Volcano plot
```{r echo = F}
# keep only genes that were significant in CROCODILE
pt_attempt_croc_DiD_emmeans_mod3 <- pt_emmeans_diff_DiD_mod3 %>%
  filter(Gene %in% pt_croc_sig_genes)
plot_volcano(pt_attempt_croc_DiD_emmeans_mod3, "Expr.Other", "Expr.p.value",
             "PT ATTEMPT Model 3 (Subset to p < 0.05 in CROCODILE)", 
             "DiD EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "/pt_attempt_croc_pvalue")

# Counts
# Total, p-value, q-value
pt_attempt_croc_tot_pos <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other > 0))
pt_attempt_croc_tot_neg <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other < 0))
pt_attempt_croc_sig_pos <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other > 0) %>% filter(Expr.p.value < 0.05))
pt_attempt_croc_sig_neg <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other < 0) %>% filter(Expr.p.value < 0.05))
pt_attempt_croc_adj_sig_pos <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other > 0) %>% filter(Expr.False.Discovery.Rate < 0.05))
pt_attempt_croc_adj_sig_neg <- nrow(pt_attempt_croc_DiD_emmeans_mod3 %>% filter(Expr.Other < 0) %>% filter(Expr.False.Discovery.Rate < 0.05))

pt_attempt_croc_count <- data.frame(total = c(pt_attempt_croc_tot_pos, pt_attempt_croc_tot_neg),
                            pvalue = c(pt_attempt_croc_sig_pos, pt_attempt_croc_sig_neg),
                            fdr = c(pt_attempt_croc_adj_sig_pos, pt_attempt_croc_adj_sig_neg))
rownames(pt_attempt_croc_count) <- c("Positive", "Negative")
kable(pt_attempt_croc_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```

##### Upset plot
```{r echo = F}
# Upset plot
pt_attempt_croc_DiD_emmeans_mod3_p_value <- pt_attempt_croc_DiD_emmeans_mod3 %>%
  filter(Expr.p.value < 0.05) %>%
  mutate(Direction = case_when(Expr.Other > 0 ~ "ATTEMPT +",
                               Expr.Other < 0 ~ "ATTEMPT -")) %>%
  dplyr::select(Gene, Direction)

pt_croc_emmeans_diff_p_value <- pt_croc_emmeans_diff %>%
  filter(`Expr p-value` < 0.05) %>%
  rename_with(~ gsub("[ -]", ".", .x)) %>%
  mutate(Direction = case_when(Expr.Other > 0 ~ "CROC +",
                               Expr.Other < 0 ~ "CROC -")) %>%
  dplyr::select(Gene, Direction)


pt_mod3_upset_df <- rbind(pt_attempt_croc_DiD_emmeans_mod3_p_value, pt_croc_emmeans_diff_p_value)

# Step 1: create a binary wide format (each direction = column)
wide_df <- pt_mod3_upset_df %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = Direction, values_from = present, values_fill = 0)

# Step 2: plot the upset
upset(wide_df, intersect = unique(pt_mod3_upset_df$Direction))

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Upset/CROCODILE comparison analysis/pt_attempt_croc_mod3_summary.jpeg")

pt_mod3_overlapping_genes <- wide_df %>%
  mutate(sum = rowSums(wide_df[2:5])) %>%
  filter(sum > 1) %>%
  pull(Gene)
```

##### GSEA (enrichR) in CROC
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# significant positive
pt_croc_pos_overlap <- (pt_croc_emmeans_diff %>% filter(Gene %in% pt_mod3_overlapping_genes) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative
pt_croc_neg_overlap <- (pt_croc_emmeans_diff %>% filter(Gene %in% pt_mod3_overlapping_genes) %>%
                  filter(`Expr Other` < 0))$Gene
#  positive
pt_croc_gsea_pos_overlap <- enrichr(pt_croc_pos_overlap, dbs)

pt_croc_pos_res_overlap_go <- pt_croc_gsea_pos_overlap[[1]]
pt_croc_pos_res_overlap_kegg <- pt_croc_gsea_pos_overlap[[2]]
pt_croc_pos_res_overlap_reactome22 <- pt_croc_gsea_pos_overlap[[3]]
pt_croc_pos_res_overlap_reactome24 <- pt_croc_gsea_pos_overlap[[4]]

# Create a bar plot with Overlap labels
plot_enrichr_results(
  data = pt_croc_pos_res_overlap_go,
  title = "Top GO Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE +)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_go_mod3_overlap.jpeg", xadd = 2.5)

plot_enrichr_results(
  data = pt_croc_pos_res_overlap_kegg,
  title = "Top KEGG Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE +)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_kegg_mod3_overlap.jpeg", xadd = 0)

plot_enrichr_results(
  data = pt_croc_pos_res_overlap_reactome22,
  title = "Top REACTOME '22 Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE +)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_reactome22_mod3_overlap.jpeg", xadd = 1)

plot_enrichr_results(
  data = pt_croc_pos_res_overlap_reactome24,
  title = "Top REACTOME '24 Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE +)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_pos_gsea_reactome24_mod3_overlap.jpeg", xadd = 1)

#  negative
pt_croc_gsea_neg_overlap <- enrichr(pt_croc_neg_overlap, dbs)
pt_croc_neg_res_overlap_go <- pt_croc_gsea_neg_overlap[[1]]
pt_croc_neg_res_overlap_kegg <- pt_croc_gsea_neg_overlap[[2]]
pt_croc_neg_res_overlap_reactome22 <- pt_croc_gsea_neg_overlap[[3]]
pt_croc_neg_res_overlap_reactome24 <- pt_croc_gsea_neg_overlap[[4]]

# Create a bar plot with Overlap labels
plot_enrichr_results(
  data = pt_croc_neg_res_overlap_go,
  bar_color = "#2c7da0",
  title = "Top GO Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE -)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_go_mod3_overlap.jpeg", xadd = 1)

plot_enrichr_results(
  data = pt_croc_neg_res_overlap_kegg,
  bar_color = "#2c7da0",
  title = "Top KEGG Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE -)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_kegg_mod3_overlap.jpeg", xadd = 1)

plot_enrichr_results(
  data = pt_croc_neg_res_overlap_reactome22,
  bar_color = "#2c7da0",
  title = "Top REACTOME '22 Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE -)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_reactome22_mod3_overlap.jpeg", xadd = 1)

plot_enrichr_results(
  data = pt_croc_neg_res_overlap_reactome24,
  bar_color = "#2c7da0",
  title = "Top REACTOME '24 Terms in Overlapping Genes from ATTEMPT Mod 3 (CROCODILE -)",
  file_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/CROCODILE comparison analysis/pt_croc_neg_gsea_reactome24_mod3_overlap.jpeg", xadd = 1)
```

##### GSEA (fgsea) in CROC
```{r echo = F}
# GSEA of overlapping significant genes in CROC
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_croc_model_filtered$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_croc_model_filtered$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_croc_model_filtered$Gene), savefile = FALSE)

# rank genes by t-stats
pt_croc_emmeans_diff_overlap <- subset(pt_croc_emmeans_diff_raw, Gene %in% pt_mod3_overlapping_genes)
rankings_pt_croc_overlap <- pt_croc_emmeans_diff_overlap$t_stat
names(rankings_pt_croc_overlap) <- pt_croc_emmeans_diff_overlap$Gene
rankings_pt_croc_overlap <- sort(rankings_pt_croc_overlap, decreasing = TRUE)
plot(rankings_pt_croc_overlap)
min(rankings_pt_croc_overlap)
max(rankings_pt_croc_overlap)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_croc_overlap <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_croc_overlap,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_croc_overlap <- fgsea(pathways = reactome,
                              stats = rankings_pt_croc_overlap,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_croc_overlap <- fgsea(pathways = go,
                        stats = rankings_pt_croc_overlap,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_croc_overlap[, padj < 0.05]), sum(kegg_legacy_res_pt_croc_overlap[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_pt_croc_overlap[, padj < 0.05]), sum(reactome_res_pt_croc_overlap[, pval < 0.05])),
                         "GO"=c(sum(go_res_pt_croc_overlap[, padj < 0.05]), sum(go_res_pt_croc_overlap[, pval < 0.05])))
rownames(fgsea) <- c("adj.pval", "p.val")
```

##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_pt_croc_overlap, title = "PT CROCODILE Top 30 KEGG (Subset to genes with p<0.05 in ATTEMPT & CROC)")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_kegg_pathways_overlap.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_pt_croc_overlap, title = "PT CROCODILE Top 30 REACTOME (Subset to genes with p<0.05 in ATTEMPT & CROC)", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_reactome_pathways_overlap.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_pt_croc_overlap, title = "PT CROCODILE Top 30 GO (Subset to genes with p<0.05 in ATTEMPT & CROC)", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/CROCODILE comparison analysis/pt_croc_top30_go_pathways_overlap.jpeg",
       width = 27.5, height = 14, scale = 1)
```








### TAL
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
tal_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/tal_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
tal_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/tal_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
tal_model_filtered_mod3 <- tal_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
tal_emmeans_filtered_mod3 <- tal_emmeans_df_mod3 %>%
  filter(Gene %in% tal_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
tal_nonconverged_genes_mod3 <- unique((tal_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
tal_nonconverged_percentage_mod3 <- (length(unique(tal_nonconverged_genes_mod3))/length(unique(tal_model_df_mod3$Gene)))*100
tal_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(tal_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(tal_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F}
## compute emmean difference in POST - PRE in each treatment group
tal_emmeans_diff_mod3 <- tal_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
tal_emmeans_diff_placebo_mod3 <- tal_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/tal_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
tal_emmeans_diff_dapa_mod3 <- tal_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/tal_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
tal_emmeans_diff_wide_mod3  <- tal_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

tal_emmeans_diff_DiD_mod3_raw <- tal_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(tal_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

tal_emmeans_diff_DiD_mod3 <-tal_emmeans_diff_DiD_mod3_raw %>% 
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(tal_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(tal_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/tal_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
tal_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

tal_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(tal_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/tal_placebo_pvalue_mod3")

plot_volcano(tal_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/tal_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(tal_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/tal_dapa_pvalue_mod3")

plot_volcano(tal_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/tal_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(tal_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/tal_DiD_pvalue_mod3")

plot_volcano(tal_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/tal_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
tal_mod3_tot_pos <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
tal_mod3_tot_neg <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
tal_mod3_sig_pos <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
tal_mod3_sig_neg <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
tal_mod3_adj_sig_pos <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
tal_mod3_adj_sig_neg <- nrow(tal_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

tal_mod3_count <- data.frame(total = c(tal_mod3_tot_pos, tal_mod3_tot_neg),
                            pvalue = c(tal_mod3_sig_pos, tal_mod3_sig_neg),
                            fdr = c(tal_mod3_adj_sig_pos, tal_mod3_adj_sig_neg))
rownames(tal_mod3_count) <- c("Positive", "Negative")
kable(tal_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# tal_placebo_pos <- (tal_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# tal_placebo_neg <- (tal_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# tal_dapa_pos <- (tal_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# tal_dapa_neg <- (tal_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
tal_DiD_pos_mod3 <- (tal_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
tal_DiD_neg_mod3 <- (tal_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# tal_gsea_placebo_pos_mod3 <- enrichr(tal_placebo_pos, dbs)
# # expected negative
# tal_gsea_placebo_neg_mod3 <- enrichr(tal_placebo_neg, dbs)
# # actual positive
# tal_gsea_dapa_pos_mod3 <- enrichr(tal_dapa_pos, dbs)
# # actual negative
# tal_gsea_dapa_neg_mod3 <- enrichr(tal_dapa_neg, dbs)
# DiD positive
tal_gsea_DiD_pos_mod3 <- enrichr(tal_DiD_pos_mod3, dbs)
# DiD negative
tal_gsea_DiD_neg_mod3 <- enrichr(tal_DiD_neg_mod3, dbs)

# tal_gsea_placebo_pos_mod3
# tal_gsea_placebo_neg_mod3
# tal_gsea_dapa_pos_mod3
# tal_gsea_dapa_neg_mod3
# tal_gsea_DiD_pos_mod3
# tal_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - TAL GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - TAL KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - TAL REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - TAL REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - TAL GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - TAL KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - TAL REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - TAL REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/tal_neg_DiD_gsea_reactome24.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_tal_mod3 <- tal_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_tal_mod3) <- tal_emmeans_diff_DiD_mod3_raw$Gene
rankings_tal_mod3 <- sort(rankings_tal_mod3, decreasing = TRUE)
plot(rankings_tal_mod3)
min(rankings_tal_mod3)
max(rankings_tal_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_tal_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_mod3 <- fgsea(pathways = go,
                        stats = rankings_tal_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_mod3[, padj < 0.05]), sum(kegg_legacy_res_tal_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_tal_mod3[, padj < 0.05]), sum(reactome_res_tal_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_tal_mod3[, padj < 0.05]), sum(go_res_tal_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_tal_mod3, title = "Model 3 TAL Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_tal_mod3, title = "Model 3 TAL Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_tal_mod3, title = "Model 3 TAL Top 30 GO", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### PC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pc_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/pc_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
pc_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/pc_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
pc_model_filtered_mod3 <- pc_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pc_emmeans_filtered_mod3 <- pc_emmeans_df_mod3 %>%
  filter(Gene %in% pc_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
pc_nonconverged_genes_mod3 <- unique((pc_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pc_nonconverged_percentage_mod3 <- (length(unique(pc_nonconverged_genes_mod3))/length(unique(pc_model_df_mod3$Gene)))*100
pc_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(pc_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(pc_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pc_emmeans_diff_mod3 <- pc_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pc_emmeans_diff_placebo_mod3 <- pc_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/pc_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
pc_emmeans_diff_dapa_mod3 <- pc_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/pc_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pc_emmeans_diff_wide_mod3  <- pc_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pc_emmeans_diff_DiD_mod3_raw <- pc_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(pc_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

pc_emmeans_diff_DiD_mod3 <- pc_emmeans_diff_DiD_mod3_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pc_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pc_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/pc_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pc_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pc_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(pc_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/pc_placebo_pvalue_mod3")

plot_volcano(pc_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/pc_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(pc_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/pc_dapa_pvalue_mod3")

plot_volcano(pc_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/pc_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(pc_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/pc_DiD_pvalue_mod3")

plot_volcano(pc_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/pc_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
pc_mod3_tot_pos <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
pc_mod3_tot_neg <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
pc_mod3_sig_pos <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
pc_mod3_sig_neg <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
pc_mod3_adj_sig_pos <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
pc_mod3_adj_sig_neg <- nrow(pc_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

pc_mod3_count <- data.frame(total = c(pc_mod3_tot_pos, pc_mod3_tot_neg),
                            pvalue = c(pc_mod3_sig_pos, pc_mod3_sig_neg),
                            fdr = c(pc_mod3_adj_sig_pos, pc_mod3_adj_sig_neg))
rownames(pc_mod3_count) <- c("Positive", "Negative")
kable(pc_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# pc_placebo_pos <- (pc_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# pc_placebo_neg <- (pc_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# pc_dapa_pos <- (pc_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# pc_dapa_neg <- (pc_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
pc_DiD_pos_mod3 <- (pc_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
pc_DiD_neg_mod3 <- (pc_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# pc_gsea_placebo_pos_mod3 <- enrichr(pc_placebo_pos, dbs)
# # expected negative
# pc_gsea_placebo_neg_mod3 <- enrichr(pc_placebo_neg, dbs)
# # actual positive
# pc_gsea_dapa_pos_mod3 <- enrichr(pc_dapa_pos, dbs)
# # actual negative
# pc_gsea_dapa_neg_mod3 <- enrichr(pc_dapa_neg, dbs)
# DiD positive
pc_gsea_DiD_pos_mod3 <- enrichr(pc_DiD_pos_mod3, dbs)
# DiD negative
pc_gsea_DiD_neg_mod3 <- enrichr(pc_DiD_neg_mod3, dbs)

# pc_gsea_placebo_pos_mod3
# pc_gsea_placebo_neg_mod3
# pc_gsea_dapa_pos_mod3
# pc_gsea_dapa_neg_mod3
# pc_gsea_DiD_pos_mod3
# pc_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - PC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - PC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - PC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - PC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - PC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - PC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - PC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - PC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/pc_neg_DiD_gsea_reactome24.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_pc_mod3 <- pc_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_pc_mod3) <- pc_emmeans_diff_DiD_mod3_raw$Gene
rankings_pc_mod3 <- sort(rankings_pc_mod3, decreasing = TRUE)
plot(rankings_pc_mod3)
min(rankings_pc_mod3)
max(rankings_pc_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_pc_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_mod3 <- fgsea(pathways = go,
                        stats = rankings_pc_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_mod3[, padj < 0.05]), sum(kegg_legacy_res_pc_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_pc_mod3[, padj < 0.05]), sum(reactome_res_pc_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_pc_mod3[, padj < 0.05]), sum(go_res_pc_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_pc_mod3, title = "Model 3 PC Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_pc_mod3, title = "Model 3 PC Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_pc_mod3, title = "Model 3 PC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### Immune (very few cells)
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
immune_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/immune_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
immune_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/immune_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
immune_model_filtered_mod3 <- immune_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
immune_emmeans_filtered_mod3 <- immune_emmeans_df_mod3 %>%
  filter(Gene %in% immune_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
immune_nonconverged_genes_mod3 <- unique((immune_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
immune_nonconverged_percentage_mod3 <- (length(unique(immune_nonconverged_genes_mod3))/length(unique(immune_model_df_mod3$Gene)))*100
immune_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(immune_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(immune_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
immune_emmeans_diff_mod3 <- immune_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
immune_emmeans_diff_placebo_mod3 <- immune_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/immune_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
immune_emmeans_diff_dapa_mod3 <- immune_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/immune_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
immune_emmeans_diff_wide_mod3  <- immune_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

immune_emmeans_diff_DiD_mod3_raw <- immune_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(immune_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr"))


immune_emmeans_diff_DiD_mod3 <- immune_emmeans_diff_DiD_mod3_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(immune_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(immune_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/immune_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
immune_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

immune_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(immune_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/immune_placebo_pvalue_mod3")

plot_volcano(immune_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/immune_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(immune_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/immune_dapa_pvalue_mod3")

plot_volcano(immune_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/immune_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(immune_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/immune_DiD_pvalue_mod3")

plot_volcano(immune_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/immune_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
immune_mod3_tot_pos <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
immune_mod3_tot_neg <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
immune_mod3_sig_pos <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
immune_mod3_sig_neg <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
immune_mod3_adj_sig_pos <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
immune_mod3_adj_sig_neg <- nrow(immune_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

immune_mod3_count <- data.frame(total = c(immune_mod3_tot_pos, immune_mod3_tot_neg),
                            pvalue = c(immune_mod3_sig_pos, immune_mod3_sig_neg),
                            fdr = c(immune_mod3_adj_sig_pos, immune_mod3_adj_sig_neg))
rownames(immune_mod3_count) <- c("Positive", "Negative")
kable(immune_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# immune_placebo_pos <- (immune_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# immune_placebo_neg <- (immune_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# immune_dapa_pos <- (immune_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# immune_dapa_neg <- (immune_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
immune_DiD_pos_mod3 <- (immune_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
immune_DiD_neg_mod3 <- (immune_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# immune_gsea_placebo_pos_mod3 <- enrichr(immune_placebo_pos, dbs)
# # expected negative
# immune_gsea_placebo_neg_mod3 <- enrichr(immune_placebo_neg, dbs)
# # actual positive
# immune_gsea_dapa_pos_mod3 <- enrichr(immune_dapa_pos, dbs)
# # actual negative
# immune_gsea_dapa_neg_mod3 <- enrichr(immune_dapa_neg, dbs)
# DiD positive
immune_gsea_DiD_pos_mod3 <- enrichr(immune_DiD_pos_mod3, dbs)
# DiD negative
immune_gsea_DiD_neg_mod3 <- enrichr(immune_DiD_neg_mod3, dbs)

# immune_gsea_placebo_pos_mod3
# immune_gsea_placebo_neg_mod3
# immune_gsea_dapa_pos_mod3
# immune_gsea_dapa_neg_mod3
# immune_gsea_DiD_pos_mod3
# immune_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - Immune GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - Immune KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - Immune REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - Immune REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - Immune GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - Immune KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - Immune REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - Immune REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/immune_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_immune_mod3 <- immune_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_immune_mod3) <- immune_emmeans_diff_DiD_mod3_raw$Gene
rankings_immune_mod3 <- sort(rankings_immune_mod3, decreasing = TRUE)
plot(rankings_immune_mod3)
min(rankings_immune_mod3)
max(rankings_immune_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_immune_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_mod3 <- fgsea(pathways = go,
                        stats = rankings_immune_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_mod3[, padj < 0.05]), sum(kegg_legacy_res_immune_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_immune_mod3[, padj < 0.05]), sum(reactome_res_immune_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_immune_mod3[, padj < 0.05]), sum(go_res_immune_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_immune_mod3, title = "Model 3 Immune Top 30 KEGG", xlim= 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_immune_mod3, title = "Model 3 Immune Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_immune_mod3, title = "Model 3 Immune Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### IC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ic_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/ic_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
ic_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/ic_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
ic_model_filtered_mod3 <- ic_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ic_emmeans_filtered_mod3 <- ic_emmeans_df_mod3 %>%
  filter(Gene %in% ic_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ic_nonconverged_genes_mod3 <- unique((ic_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ic_nonconverged_percentage_mod3 <- (length(unique(ic_nonconverged_genes_mod3))/length(unique(ic_model_df_mod3$Gene)))*100
ic_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(ic_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(ic_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ic_emmeans_diff_mod3 <- ic_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ic_emmeans_diff_placebo_mod3 <- ic_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ic_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
ic_emmeans_diff_dapa_mod3 <- ic_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ic_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ic_emmeans_diff_wide_mod3  <- ic_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ic_emmeans_diff_DiD_mod3_raw <- ic_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(ic_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 


ic_emmeans_diff_DiD_mod3 <- ic_emmeans_diff_DiD_mod3_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ic_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ic_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ic_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ic_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ic_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(ic_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ic_placebo_pvalue_mod3")

plot_volcano(ic_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ic_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(ic_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ic_dapa_pvalue_mod3")

plot_volcano(ic_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ic_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(ic_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ic_DiD_pvalue_mod3")

plot_volcano(ic_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ic_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
ic_mod3_tot_pos <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
ic_mod3_tot_neg <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
ic_mod3_sig_pos <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
ic_mod3_sig_neg <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
ic_mod3_adj_sig_pos <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
ic_mod3_adj_sig_neg <- nrow(ic_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

ic_mod3_count <- data.frame(total = c(ic_mod3_tot_pos, ic_mod3_tot_neg),
                            pvalue = c(ic_mod3_sig_pos, ic_mod3_sig_neg),
                            fdr = c(ic_mod3_adj_sig_pos, ic_mod3_adj_sig_neg))
rownames(ic_mod3_count) <- c("Positive", "Negative")
kable(ic_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# ic_placebo_pos <- (ic_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# ic_placebo_neg <- (ic_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# ic_dapa_pos <- (ic_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# ic_dapa_neg <- (ic_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
ic_DiD_pos_mod3 <- (ic_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
ic_DiD_neg_mod3 <- (ic_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# ic_gsea_placebo_pos_mod3 <- enrichr(ic_placebo_pos, dbs)
# # expected negative
# ic_gsea_placebo_neg_mod3 <- enrichr(ic_placebo_neg, dbs)
# # actual positive
# ic_gsea_dapa_pos_mod3 <- enrichr(ic_dapa_pos, dbs)
# # actual negative
# ic_gsea_dapa_neg_mod3 <- enrichr(ic_dapa_neg, dbs)
# DiD positive
ic_gsea_DiD_pos_mod3 <- enrichr(ic_DiD_pos_mod3, dbs)
# DiD negative
ic_gsea_DiD_neg_mod3 <- enrichr(ic_DiD_neg_mod3, dbs)

# ic_gsea_placebo_pos_mod3
# ic_gsea_placebo_neg_mod3
# ic_gsea_dapa_pos_mod3
# ic_gsea_dapa_neg_mod3
# ic_gsea_DiD_pos_mod3
# ic_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - IC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - IC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - IC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - IC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - IC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - IC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - IC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - IC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ic_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_ic_mod3 <- ic_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_ic_mod3) <- ic_emmeans_diff_DiD_mod3_raw$Gene
rankings_ic_mod3 <- sort(rankings_ic_mod3, decreasing = TRUE)
plot(rankings_ic_mod3)
min(rankings_ic_mod3)
max(rankings_ic_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_ic_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_mod3 <- fgsea(pathways = go,
                        stats = rankings_ic_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_mod3[, padj < 0.05]), sum(kegg_legacy_res_ic_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_ic_mod3[, padj < 0.05]), sum(reactome_res_ic_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_ic_mod3[, padj < 0.05]), sum(go_res_ic_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_ic_mod3, title = "Model 3 IC Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_ic_mod3, title = "Model 3 IC Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_ic_mod3, title = "Model 3 IC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### EC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ec_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/ec_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
ec_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/ec_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
ec_model_filtered_mod3 <- ec_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ec_emmeans_filtered_mod3 <- ec_emmeans_df_mod3 %>%
  filter(Gene %in% ec_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ec_nonconverged_genes_mod3 <- unique((ec_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ec_nonconverged_percentage_mod3 <- (length(unique(ec_nonconverged_genes_mod3))/length(unique(ec_model_df_mod3$Gene)))*100
ec_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(ec_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(ec_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ec_emmeans_diff_mod3 <- ec_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ec_emmeans_diff_placebo_mod3 <- ec_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ec_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
ec_emmeans_diff_dapa_mod3 <- ec_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ec_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ec_emmeans_diff_wide_mod3  <- ec_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ec_emmeans_diff_DiD_mod3_raw <- ec_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(ec_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

ec_emmeans_diff_DiD_mod3 <- ec_emmeans_diff_DiD_mod3_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ec_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ec_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/ec_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ec_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ec_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(ec_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ec_placebo_pvalue_mod3")

plot_volcano(ec_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ec_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(ec_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ec_dapa_pvalue_mod3")

plot_volcano(ec_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ec_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(ec_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/ec_DiD_pvalue_mod3")

plot_volcano(ec_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/ec_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
ec_mod3_tot_pos <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
ec_mod3_tot_neg <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
ec_mod3_sig_pos <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
ec_mod3_sig_neg <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
ec_mod3_adj_sig_pos <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
ec_mod3_adj_sig_neg <- nrow(ec_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

ec_mod3_count <- data.frame(total = c(ec_mod3_tot_pos, ec_mod3_tot_neg),
                            pvalue = c(ec_mod3_sig_pos, ec_mod3_sig_neg),
                            fdr = c(ec_mod3_adj_sig_pos, ec_mod3_adj_sig_neg))
rownames(ec_mod3_count) <- c("Positive", "Negative")
kable(ec_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# ec_placebo_pos <- (ec_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# ec_placebo_neg <- (ec_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# ec_dapa_pos <- (ec_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# ec_dapa_neg <- (ec_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
ec_DiD_pos_mod3 <- (ec_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
ec_DiD_neg_mod3 <- (ec_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# ec_gsea_placebo_pos_mod3 <- enrichr(ec_placebo_pos, dbs)
# # expected negative
# ec_gsea_placebo_neg_mod3 <- enrichr(ec_placebo_neg, dbs)
# # actual positive
# ec_gsea_dapa_pos_mod3 <- enrichr(ec_dapa_pos, dbs)
# # actual negative
# ec_gsea_dapa_neg_mod3 <- enrichr(ec_dapa_neg, dbs)
# DiD positive
ec_gsea_DiD_pos_mod3 <- enrichr(ec_DiD_pos_mod3, dbs)
# DiD negative
ec_gsea_DiD_neg_mod3 <- enrichr(ec_DiD_neg_mod3, dbs)

# ec_gsea_placebo_pos_mod3
# ec_gsea_placebo_neg_mod3
# ec_gsea_dapa_pos_mod3
# ec_gsea_dapa_neg_mod3
# ec_gsea_DiD_pos_mod3
# ec_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - EC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - EC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - EC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - EC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - EC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - EC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - EC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - EC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/ec_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_ec_mod3 <- ec_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_ec_mod3) <- ec_emmeans_diff_DiD_mod3_raw$Gene
rankings_ec_mod3 <- sort(rankings_ec_mod3, decreasing = TRUE)
plot(rankings_ec_mod3)
min(rankings_ec_mod3)
max(rankings_ec_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_ec_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_mod3 <- fgsea(pathways = go,
                        stats = rankings_ec_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_mod3[, padj < 0.05]), sum(kegg_legacy_res_ec_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_ec_mod3[, padj < 0.05]), sum(reactome_res_ec_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_ec_mod3[, padj < 0.05]), sum(go_res_ec_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_ec_mod3, title = "Model 3 EC Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_ec_mod3, title = "Model 3 EC Top 30 REACTOME", xlimit = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_ec_mod3, title = "Model 3 EC Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### DTL (very few cells)
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
dtl_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/dtl_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
dtl_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/dtl_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
dtl_model_filtered_mod3 <- dtl_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
dtl_emmeans_filtered_mod3 <- dtl_emmeans_df_mod3 %>%
  filter(Gene %in% dtl_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
dtl_nonconverged_genes <- (dtl_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(dtl_nonconverged_genes))/length(unique(dtl_model_df_mod3$Gene)))*100
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(dtl_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(dtl_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
dtl_emmeans_diff_mod3 <- dtl_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
dtl_emmeans_diff_placebo_mod3 <- dtl_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
dtl_emmeans_diff_dapa_mod3 <- dtl_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
dtl_emmeans_diff_wide_mod3  <- dtl_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

dtl_emmeans_diff_DiD_mod3 <- dtl_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(dtl_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 
# %>%
#   dplyr::select(Gene, DiD, p_value_DiD, q_value)
# colnames(dtl_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
# 
# ### Save for IPA
# ## write.csv(dtl_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
dtl_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

dtl_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
fibvsmcp_model_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/fibvsmcp_attempt_scrna_mm_model_combined_3.rds")

## read emmeans dataframe (rendered in Hyak)
fibvsmcp_emmeans_df_mod3 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/3 Nested visit and no zero inflation/fibvsmcp_attempt_scrna_mm_emmeans_combined_3.rds")
```

```{r echo = F}
## keep converged model results only
fibvsmcp_model_filtered_mod3 <- fibvsmcp_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
fibvsmcp_emmeans_filtered_mod3 <- fibvsmcp_emmeans_df_mod3 %>%
  filter(Gene %in% fibvsmcp_model_filtered_mod3$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
fibvsmcp_nonconverged_genes_mod3 <- unique((fibvsmcp_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
fibvsmcp_nonconverged_percentage_mod3 <- (length(unique(fibvsmcp_nonconverged_genes_mod3))/length(unique(fibvsmcp_model_df_mod3$Gene)))*100
fibvsmcp_nonconverged_percentage_mod3
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod3 <- subset(fibvsmcp_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod3$Gene, levels = ordered_model_mod3$Gene)
sig_genes <- subset(fibvsmcp_model_filtered_mod3, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
fibvsmcp_emmeans_diff_mod3 <- fibvsmcp_emmeans_filtered_mod3 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
fibvsmcp_emmeans_diff_placebo_mod3 <- fibvsmcp_emmeans_diff_mod3 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_placebo_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_placebo_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/fibvsmcp_emmeans_diff_placebo_3.csv", row.names = F)

### Dapa
fibvsmcp_emmeans_diff_dapa_mod3 <- fibvsmcp_emmeans_diff_mod3 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_dapa_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_dapa_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/fibvsmcp_emmeans_diff_dapa_3.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
fibvsmcp_emmeans_diff_wide_mod3  <- fibvsmcp_emmeans_diff_mod3 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

fibvsmcp_emmeans_diff_DiD_mod3_raw <- fibvsmcp_emmeans_diff_wide_mod3  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = safe_pval(t_stat_DiD, nrow(fibvsmcp_emmeans_diff_mod3))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

fibvsmcp_emmeans_diff_DiD_mod3 <-  fibvsmcp_emmeans_diff_DiD_mod3_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(fibvsmcp_emmeans_diff_DiD_mod3) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(fibvsmcp_emmeans_diff_DiD_mod3, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/3 Nested visit and no zero inflation/fibvsmcp_emmeans_diff_DiD_3.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
fibvsmcp_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

fibvsmcp_emmeans_diff_mod3 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(fibvsmcp_emmeans_diff_placebo_mod3, "Expr p-value",
             "Model 3 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_placebo_pvalue_mod3")

plot_volcano(fibvsmcp_emmeans_diff_placebo_mod3, "Expr False Discovery Rate", 
             "Model 3 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_placebo_adj_pvalue_mod3")
# Dapa
plot_volcano(fibvsmcp_emmeans_diff_dapa_mod3, "Expr p-value",
             "Model 3 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_dapa_pvalue_mod3")

plot_volcano(fibvsmcp_emmeans_diff_dapa_mod3, "Expr False Discovery Rate", 
             "Model 3 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_dapa_adj_pvalue_mod3")

# DiD
plot_volcano(fibvsmcp_emmeans_diff_DiD_mod3, "Expr p-value", "Model 3 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_DiD_pvalue_mod3")

plot_volcano(fibvsmcp_emmeans_diff_DiD_mod3, "Expr False Discovery Rate", "Model 3 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "3 Nested visit and no zero inflation/fibvsmcp_DiD_adj_pvalue_mod3")

# Counts
# Total, p-value, q-value
fibvsmcp_mod3_tot_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0))
fibvsmcp_mod3_tot_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0))
fibvsmcp_mod3_sig_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
fibvsmcp_mod3_sig_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
fibvsmcp_mod3_adj_sig_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
fibvsmcp_mod3_adj_sig_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

fibvsmcp_mod3_count <- data.frame(total = c(fibvsmcp_mod3_tot_pos, fibvsmcp_mod3_tot_neg),
                            pvalue = c(fibvsmcp_mod3_sig_pos, fibvsmcp_mod3_sig_neg),
                            fdr = c(fibvsmcp_mod3_adj_sig_pos, fibvsmcp_mod3_adj_sig_neg))
rownames(fibvsmcp_mod3_count) <- c("Positive", "Negative")
kable(fibvsmcp_mod3_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# fibvsmcp_placebo_pos <- (fibvsmcp_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# fibvsmcp_placebo_neg <- (fibvsmcp_emmeans_diff_placebo_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# fibvsmcp_dapa_pos <- (fibvsmcp_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# fibvsmcp_dapa_neg <- (fibvsmcp_emmeans_diff_dapa_mod3 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
fibvsmcp_DiD_pos_mod3 <- (fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
fibvsmcp_DiD_neg_mod3 <- (fibvsmcp_emmeans_diff_DiD_mod3 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# fibvsmcp_gsea_placebo_pos_mod3 <- enrichr(fibvsmcp_placebo_pos, dbs)
# # expected negative
# fibvsmcp_gsea_placebo_neg_mod3 <- enrichr(fibvsmcp_placebo_neg, dbs)
# # actual positive
# fibvsmcp_gsea_dapa_pos_mod3 <- enrichr(fibvsmcp_dapa_pos, dbs)
# # actual negative
# fibvsmcp_gsea_dapa_neg_mod3 <- enrichr(fibvsmcp_dapa_neg, dbs)
# DiD positive
fibvsmcp_gsea_DiD_pos_mod3 <- enrichr(fibvsmcp_DiD_pos_mod3, dbs)
# DiD negative
fibvsmcp_gsea_DiD_neg_mod3 <- enrichr(fibvsmcp_DiD_neg_mod3, dbs)

# fibvsmcp_gsea_placebo_pos_mod3
# fibvsmcp_gsea_placebo_neg_mod3
# fibvsmcp_gsea_dapa_pos_mod3
# fibvsmcp_gsea_dapa_neg_mod3
# fibvsmcp_gsea_DiD_pos_mod3
# fibvsmcp_gsea_DiD_neg_mod3
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod3[[1]]), title = "Model 3 Positive DiD - FIB/VSMC/P GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod3[[2]]), title = "Model 3 Positive DiD - FIB/VSMC/P KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod3[[3]]), title = "Model 3 Positive DiD - FIB/VSMC/P REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod3[[4]]), title = "Model 3 Positive DiD - FIB/VSMC/P REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod3[[1]]), title = "Model 3 Negative DiD - FIB/VSMC/P GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod3[[2]]), title = "Model 3 Negative DiD - FIB/VSMC/P KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod3[[3]]), title = "Model 3 Negative DiD - FIB/VSMC/P REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod3[[4]]), title = "Model 3 Negative DiD - FIB/VSMC/P REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/3 Nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmcp_model_filtered_mod3$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmcp_model_filtered_mod3$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmcp_model_filtered_mod3$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_fibvsmcp_mod3 <- fibvsmcp_emmeans_diff_DiD_mod3_raw$t_stat_DiD
names(rankings_fibvsmcp_mod3) <- fibvsmcp_emmeans_diff_DiD_mod3_raw$Gene
rankings_fibvsmcp_mod3 <- sort(rankings_fibvsmcp_mod3, decreasing = TRUE)
plot(rankings_fibvsmcp_mod3)
min(rankings_fibvsmcp_mod3)
max(rankings_fibvsmcp_mod3)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmcp_mod3 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmcp_mod3,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmcp_mod3 <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmcp_mod3,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmcp_mod3 <- fgsea(pathways = go,
                        stats = rankings_fibvsmcp_mod3,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod3_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmcp_mod3[, padj < 0.05]), sum(kegg_legacy_res_fibvsmcp_mod3[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_fibvsmcp_mod3[, padj < 0.05]), sum(reactome_res_fibvsmcp_mod3[, pval < 0.05])),
                         "GO"=c(sum(go_res_fibvsmcp_mod3[, padj < 0.05]), sum(go_res_fibvsmcp_mod3[, pval < 0.05])))
rownames(mod3_fgsea) <- c("adj.pval", "p.val")
mod3_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_fibvsmcp_mod3, title = "Model 3 FIB/VSMC/P Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_fibvsmcp_mod3, title = "Model 3 FIB/VSMC/P Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_fibvsmcp_mod3, title = "Model 3 FIB/VSMC/P Top 30 GO", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
## Troubleshooting...
```{r echo = F, eval = F}
## PT
pt_nonconverged_genes_mod3 <- (pt_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pt_nonconverged_genes_mod3))/length(unique(pt_model_df_mod3$Gene)))*100
## TAL
tal_nonconverged_genes_mod3 <- (tal_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(tal_nonconverged_genes_mod3))/length(unique(tal_model_df_mod3$Gene)))*100
## PC
pc_nonconverged_genes_mod3 <- (pc_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pc_nonconverged_genes_mod3))/length(unique(pc_model_df_mod3$Gene)))*100
## Immune
immune_nonconverged_genes_mod3 <- (immune_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(immune_nonconverged_genes_mod3))/length(unique(immune_model_df_mod3$Gene)))*100
## IC
ic_nonconverged_genes_mod3 <- (ic_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ic_nonconverged_genes_mod3))/length(unique(ic_model_df_mod3$Gene)))*100
## EC
ec_nonconverged_genes_mod3 <- (ec_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ec_nonconverged_genes_mod3))/length(unique(ec_model_df_mod3$Gene)))*100
## DTL
## dtl_nonconverged_genes_mod3 <- (dtl_model_df_mod3 %>%
##   group_by(Gene) %>%
##   filter(all(is.na(PValue))))$Gene
## (length(unique(dtl_nonconverged_genes_mod3))/length(unique(dtl_model_df_mod3$Gene)))*100
## FIB/VSMC/P
fibvsmcp_nonconverged_genes_mod3 <- (fibvsmcp_model_df_mod3 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(fibvsmcp_nonconverged_genes_mod3))/length(unique(fibvsmcp_model_df_mod3$Gene)))*100

nonconverged_list <- list(pt = pt_nonconverged_genes_mod3,
                          immune = immune_nonconverged_genes_mod3,
                          ic = ic_nonconverged_genes_mod3,
                          ec = ec_nonconverged_genes_mod3,
                          #dtl = dtl_nonconverged_genes_mod3,
                          #fibvsmcp = fibvsmcp_nonconverged_genes_mod3,
                          tal = tal_nonconverged_genes_mod3,
                          pc = pc_nonconverged_genes_mod3)
upset(fromList(nonconverged_list), order.by = "freq")
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pt_DiD_pathways_3.xls", skip = 1) 
pt_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pt_dapa_pathways_3.xls", skip = 1) 
pt_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pt_placebo_pathways_3.xls", skip = 1) 

colnames(pt_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_mod3 <- pt_pathways_mod3 %>%
  full_join(pt_dapa_mod3) %>% full_join(pt_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_mod3$scenario <- factor(pt_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_mod3 <- pt_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_mod3$pathway <- reorder(pt_pathways_inhibited_mod3$pathway, pt_pathways_inhibited_mod3$neg_log_p)
  
pt_top30_inhibited_mod3 <- pt_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_mod3 <- pt_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_mod3$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_mod3))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_mod3 + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pt_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_mod3 <- pt_pathways_inhibited_mod3 %>%
  filter(z <= -2)
pt_top30_inhibited_2_mod3 <- pt_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_mod3$z), max(-pt_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

## top30_inhibited_mod3 + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pt_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_mod3 <- pt_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_mod3$pathway <- reorder(pt_pathways_activated_mod3$pathway, pt_pathways_activated_mod3$neg_log_p)
  
pt_top30_activated_mod3 <- pt_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_mod3 <- pt_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pt_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_mod3 <- pt_pathways_activated_mod3 %>%
  filter(z > 2)
pt_top30_activated_2_mod3 <- pt_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_mod3$z), max(pt_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pt_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_mod3 <- pt_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_mod3$name <- factor(pt_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/pt_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_mod3 <- pt_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_mod3$name <- factor(pt_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_mod3
pt_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 40, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/pt_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/tal_DiD_pathways_3.xls", skip = 1) 
tal_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/tal_dapa_pathways_3.xls", skip = 1) 
tal_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/tal_placebo_pathways_3.xls", skip = 1) 

colnames(tal_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_mod3 <- tal_pathways_mod3 %>%
  full_join(tal_dapa_mod3) %>% full_join(tal_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_mod3$scenario <- factor(tal_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_mod3 <- tal_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_mod3$pathway <- reorder(tal_pathways_inhibited_mod3$pathway, tal_pathways_inhibited_mod3$neg_log_p)
  
tal_top30_inhibited_mod3 <- tal_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_mod3 <- tal_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/tal_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_mod3 <- tal_pathways_inhibited_mod3 %>%
  filter(z < -2)
tal_top30_inhibited_2_mod3 <- tal_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_mod3$z), max(-tal_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/tal_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_mod3 <- tal_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_mod3$pathway <- reorder(tal_pathways_activated_mod3$pathway, tal_pathways_activated_mod3$neg_log_p)
  
tal_top30_activated_mod3 <- tal_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_mod3 <- tal_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/tal_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_mod3 <- tal_pathways_activated_mod3 %>%
  filter(z > 2)
tal_top30_activated_2_mod3 <- tal_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_mod3$z), max(tal_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/tal_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_mod3 <- tal_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_mod3$name <- factor(tal_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/tal_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_mod3 <- tal_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_mod3$name <- factor(tal_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_mod3
tal_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/tal_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pc_DiD_pathways_3.xls", skip = 1) 
pc_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pc_dapa_pathways_3.xls", skip = 1) 
pc_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/pc_placebo_pathways_3.xls", skip = 1) 

colnames(pc_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_mod3 <- pc_pathways_mod3 %>%
  full_join(pc_dapa_mod3) %>% full_join(pc_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_mod3$scenario <- factor(pc_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_mod3 <- pc_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_mod3$pathway <- reorder(pc_pathways_inhibited_mod3$pathway, pc_pathways_inhibited_mod3$neg_log_p)
  
pc_top30_inhibited_mod3 <- pc_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.04) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_mod3 <- pc_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pc_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_mod3 <- pc_pathways_inhibited_mod3 %>%
  filter(z < -2)
pc_top30_inhibited_2_mod3 <- pc_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_mod3$z), max(-pc_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pc_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_mod3 <- pc_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_mod3$pathway <- reorder(pc_pathways_activated_mod3$pathway, pc_pathways_activated_mod3$neg_log_p)
  
pc_top30_activated_mod3 <- pc_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_mod3 <- pc_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pc_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_mod3 <- pc_pathways_activated_mod3 %>%
  filter(z > 2)
pc_top30_activated_2_mod3 <- pc_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_mod3$z), max(pc_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/pc_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_mod3 <- pc_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_mod3$name <- factor(pc_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/pc_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_mod3 <- pc_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_mod3$name <- factor(pc_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_mod3
pc_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/pc_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/immune_DiD_pathways_3.xls", skip = 1) 
immune_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/immune_dapa_pathways_3.xls", skip = 1) 
immune_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/immune_placebo_pathways_3.xls", skip = 1) 

colnames(immune_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_mod3 <- immune_pathways_mod3 %>%
  full_join(immune_dapa_mod3) %>% full_join(immune_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_mod3$scenario <- factor(immune_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_mod3 <- immune_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_mod3$pathway <- reorder(immune_pathways_inhibited_mod3$pathway, immune_pathways_inhibited_mod3$neg_log_p)
  
immune_top30_inhibited_mod3 <- immune_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_mod3 <- immune_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/immune_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_mod3 <- immune_pathways_inhibited_mod3 %>%
  filter(z < -2)
immune_top30_inhibited_2_mod3 <- immune_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_mod3$z), max(-immune_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/immune_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_mod3 <- immune_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_mod3$pathway <- reorder(immune_pathways_activated_mod3$pathway, immune_pathways_activated_mod3$neg_log_p)
  
immune_top30_activated_mod3 <- immune_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_mod3 <- immune_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/immune_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_mod3 <- immune_pathways_activated_mod3 %>%
  filter(z > 2)
immune_top30_activated_2_mod3 <- immune_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_mod3$z), max(immune_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/immune_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_mod3 <- immune_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_mod3$name <- factor(immune_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/immune_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_mod3 <- immune_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_mod3$name <- factor(immune_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_mod3
immune_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/immune_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ic_DiD_pathways_3.xls", skip = 1) 
ic_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ic_dapa_pathways_3.xls", skip = 1) 
ic_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ic_placebo_pathways_3.xls", skip = 1) 

colnames(ic_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_mod3 <- ic_pathways_mod3 %>%
  full_join(ic_dapa_mod3) %>% full_join(ic_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_mod3$scenario <- factor(ic_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_mod3 <- ic_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_mod3$pathway <- reorder(ic_pathways_inhibited_mod3$pathway, ic_pathways_inhibited_mod3$neg_log_p)
  
ic_top30_inhibited_mod3 <- ic_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_mod3 <- ic_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ic_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_mod3 <- ic_pathways_inhibited_mod3 %>%
  filter(z < -2)
ic_top30_inhibited_2_mod3 <- ic_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_mod3$z), max(-ic_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ic_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_mod3 <- ic_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_mod3$pathway <- reorder(ic_pathways_activated_mod3$pathway, ic_pathways_activated_mod3$neg_log_p)
  
ic_top30_activated_mod3 <- ic_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_mod3 <- ic_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ic_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_mod3 <- ic_pathways_activated_mod3 %>%
  filter(z > 2)
ic_top30_activated_2_mod3 <- ic_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_mod3$z), max(ic_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ic_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_mod3 <- ic_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_mod3$name <- factor(ic_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/ic_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_mod3 <- ic_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_mod3$name <- factor(ic_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_mod3
ic_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/ic_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ec_DiD_pathways_3.xls", skip = 1) 
ec_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ec_dapa_pathways_3.xls", skip = 1) 
ec_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/ec_placebo_pathways_3.xls", skip = 1) 

colnames(ec_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_mod3 <- ec_pathways_mod3 %>%
  full_join(ec_dapa_mod3) %>% full_join(ec_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_mod3$scenario <- factor(ec_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_mod3 <- ec_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_mod3$pathway <- reorder(ec_pathways_inhibited_mod3$pathway, ec_pathways_inhibited_mod3$neg_log_p)
  
ec_top30_inhibited_mod3 <- ec_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_mod3 <- ec_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ec_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_mod3 <- ec_pathways_inhibited_mod3 %>%
  filter(z < -2)
ec_top30_inhibited_2_mod3 <- ec_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_mod3$z), max(-ec_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ec_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_mod3 <- ec_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_mod3$pathway <- reorder(ec_pathways_activated_mod3$pathway, ec_pathways_activated_mod3$neg_log_p)
  
ec_top30_activated_mod3 <- ec_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_mod3 <- ec_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ec_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_mod3 <- ec_pathways_activated_mod3 %>%
  filter(z > 2)
ec_top30_activated_2_mod3 <- ec_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_mod3$z), max(ec_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/ec_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_mod3 <- ec_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_mod3$name <- factor(ec_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/ec_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_mod3 <- ec_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_mod3$name <- factor(ec_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_mod3
ec_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 90, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/ec_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/dtl_DiD_pathways_3.xls", skip = 1) 
dtl_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/dtl_dapa_pathways_3.xls", skip = 1) 
dtl_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/dtl_placebo_pathways_3.xls", skip = 1) 

colnames(dtl_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_mod3 <- dtl_pathways_mod3 %>%
  full_join(dtl_dapa_mod3) %>% full_join(dtl_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_mod3$scenario <- factor(dtl_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_mod3 <- dtl_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_mod3$pathway <- reorder(dtl_pathways_inhibited_mod3$pathway, dtl_pathways_inhibited_mod3$neg_log_p)
  
dtl_top30_inhibited_mod3 <- dtl_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_mod3 <- dtl_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/dtl_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_mod3 <- dtl_pathways_inhibited_mod3 %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_mod3 <- dtl_pathways_inhibited_sig_mod3[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_mod3$z), max(-dtl_pathways_inhibited_sig_mod3$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/dtl_top_inhibited_pathways_2_mod3.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_mod3 <- dtl_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_mod3$pathway <- reorder(dtl_pathways_activated_mod3$pathway, dtl_pathways_activated_mod3$neg_log_p)
  
dtl_top30_activated_mod3 <- dtl_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_mod3 <- dtl_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/dtl_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_mod3 <- dtl_pathways_activated_mod3 %>%
  filter(z > 2)
dtl_top30_activated_2_mod3 <- dtl_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_mod3$z), max(dtl_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/dtl_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_mod3 <- dtl_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_mod3$name <- factor(dtl_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/dtl_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_mod3 <- dtl_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_mod3$name <- factor(dtl_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_mod3
dtl_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/dtl_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/fibvsmcp_DiD_pathways_3.xls", skip = 1) 
fibvsmcp_dapa_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/fibvsmcp_dapa_pathways_3.xls", skip = 1) 
fibvsmcp_placebo_mod3 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/3 Nested visit and no zero inflation/fibvsmcp_placebo_pathways_3.xls", skip = 1) 

colnames(fibvsmcp_pathways_mod3) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_mod3) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_placebo_mod3) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_mod3 <- fibvsmcp_pathways_mod3 %>%
  full_join(fibvsmcp_dapa_mod3) %>% full_join(fibvsmcp_placebo_mod3) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_mod3$scenario <- factor(fibvsmcp_pathways_merged_mod3$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_mod3 <- fibvsmcp_pathways_merged_mod3 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_mod3$pathway <- reorder(fibvsmcp_pathways_inhibited_mod3$pathway, fibvsmcp_pathways_inhibited_mod3$neg_log_p)
  
fibvsmcp_top30_inhibited_mod3 <- fibvsmcp_pathways_inhibited_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_mod3 <- fibvsmcp_pathways_inhibited_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/fibvsmcp_top30_inhibited_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_mod3 <- fibvsmcp_pathways_inhibited_mod3 %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_mod3 <- fibvsmcp_pathways_inhibited_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_mod3$z), max(-fibvsmcp_pathways_inhibited_sig_mod3$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/fibvsmcp_top_inhibited_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_mod3 <- fibvsmcp_pathways_merged_mod3 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_mod3$pathway <- reorder(fibvsmcp_pathways_activated_mod3$pathway, fibvsmcp_pathways_activated_mod3$neg_log_p)
  
fibvsmcp_top30_activated_mod3 <- fibvsmcp_pathways_activated_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_mod3 <- fibvsmcp_pathways_activated_mod3 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/fibvsmcp_top30_activated_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_mod3 <- fibvsmcp_pathways_activated_mod3 %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_mod3 <- fibvsmcp_pathways_activated_sig_mod3[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_mod3$z), max(fibvsmcp_pathways_activated_sig_mod3$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/fibvsmcp_top_activated_pathways_2_mod3.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_mod3 <- fibvsmcp_pathways_merged_mod3 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_mod3$name <- factor(fibvsmcp_neg_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/fibvsmcp_top10_inhibited_pathway_zscores_mod3.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_mod3 <- fibvsmcp_pathways_merged_mod3 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_mod3$name <- factor(fibvsmcp_pos_pathways_merged_long_mod3$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_mod3
fibvsmcp_pos_pathways_merged_long_mod3 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/3 Nested visit and no zero inflation/fibvsmcp_top10_activated_pathway_zscores_mod3.jpeg",
       scale = 1.5)
```

# Model 4 (NO Nested visit + NO ZIF)
## emmeans
### PT
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pt_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/pt_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
pt_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/pt_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
pt_model_filtered_mod4 <- pt_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pt_emmeans_filtered_mod4 <- pt_emmeans_df_mod4 %>%
  filter(Gene %in% pt_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))

## non-converged genes percentage
pt_nonconverged_genes_mod4 <- unique((pt_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pt_nonconverged_percentage_mod4 <- (length(unique(pt_nonconverged_genes_mod4))/length(unique(pt_model_df_mod4$Gene)))*100
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(pt_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(pt_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pt_emmeans_diff_mod4 <- pt_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pt_emmeans_diff_placebo_mod4 <- pt_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pt_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
pt_emmeans_diff_dapa_mod4 <- pt_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pt_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pt_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pt_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pt_emmeans_diff_wide_mod4  <- pt_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pt_emmeans_diff_DiD_mod4_raw <- pt_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(pt_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

pt_emmeans_diff_DiD_mod4 <-  pt_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pt_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pt_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pt_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pt_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pt_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(pt_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pt_placebo_pvalue_mod4")

plot_volcano(pt_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 PT Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pt_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(pt_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pt_dapa_pvalue_mod4")

plot_volcano(pt_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 PT Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pt_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(pt_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pt_DiD_pvalue_mod4")

plot_volcano(pt_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 PT DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pt_DiD_adj_pvalue_mod4")

# Counts
# Total, p-value, q-value
pt_mod4_tot_pos <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
pt_mod4_tot_neg <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
pt_mod4_sig_pos <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
pt_mod4_sig_neg <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
pt_mod4_adj_sig_pos <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
pt_mod4_adj_sig_neg <- nrow(pt_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

pt_mod4_count <- data.frame(total = c(pt_mod4_tot_pos, pt_mod4_tot_neg),
                            pvalue = c(pt_mod4_sig_pos, pt_mod4_sig_neg),
                            fdr = c(pt_mod4_adj_sig_pos, pt_mod4_adj_sig_neg))
rownames(pt_mod4_count) <- c("Positive", "Negative")
kable(pt_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# pt_placebo_pos <- (pt_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# pt_placebo_neg <- (pt_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# pt_dapa_pos <- (pt_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# pt_dapa_neg <- (pt_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
pt_DiD_pos_mod4 <- (pt_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
pt_DiD_neg_mod4 <- (pt_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# pt_gsea_placebo_pos_mod4 <- enrichr(pt_placebo_pos, dbs)
# # expected negative
# pt_gsea_placebo_neg_mod4 <- enrichr(pt_placebo_neg, dbs)
# # actual positive
# pt_gsea_dapa_pos_mod4 <- enrichr(pt_dapa_pos, dbs)
# # actual negative
# pt_gsea_dapa_neg_mod4 <- enrichr(pt_dapa_neg, dbs)
# DiD positive
pt_gsea_DiD_pos_mod4 <- enrichr(pt_DiD_pos_mod4, dbs)
# DiD negative
pt_gsea_DiD_neg_mod4 <- enrichr(pt_DiD_neg_mod4, dbs)

# pt_gsea_placebo_pos_mod4
# pt_gsea_placebo_neg_mod4
# pt_gsea_dapa_pos_mod4
# pt_gsea_dapa_neg_mod4
# pt_gsea_DiD_pos_mod4
# pt_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(pt_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - PT GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - PT KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - PT REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - PT REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(pt_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - PT GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - PT KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - PT REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pt_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - PT REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pt_neg_DiD_gsea_reactome24.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pt_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pt_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pt_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_pt_mod4 <- pt_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_pt_mod4) <- pt_emmeans_diff_DiD_mod4_raw$Gene
rankings_pt_mod4 <- sort(rankings_pt_mod4, decreasing = TRUE)
plot(rankings_pt_mod4)
min(rankings_pt_mod4)
max(rankings_pt_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pt_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pt_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pt_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_pt_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pt_mod4 <- fgsea(pathways = go,
                        stats = rankings_pt_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pt_mod4[, padj < 0.05]), sum(kegg_legacy_res_pt_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_pt_mod4[, padj < 0.05]), sum(reactome_res_pt_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_pt_mod4[, padj < 0.05]), sum(go_res_pt_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_pt_mod4, title = "Model 4 PT Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_pt_mod4, title = "Model 4 PT Top 30 REACTOME", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_pt_mod4, title = "Model 4 PT Top 30 GO", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### TAL
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
tal_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/tal_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
tal_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/tal_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
tal_model_filtered_mod4 <- tal_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
tal_emmeans_filtered_mod4 <- tal_emmeans_df_mod4 %>%
  filter(Gene %in% tal_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
tal_nonconverged_genes_mod4 <- unique((tal_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
tal_nonconverged_percentage_mod4 <- (length(unique(tal_nonconverged_genes_mod4))/length(unique(tal_model_df_mod4$Gene)))*100
tal_nonconverged_percentage_mod4
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(tal_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(tal_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F}
## compute emmean difference in POST - PRE in each treatment group
tal_emmeans_diff_mod4 <- tal_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
tal_emmeans_diff_placebo_mod4 <- tal_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/tal_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
tal_emmeans_diff_dapa_mod4 <- tal_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(tal_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(tal_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/tal_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
tal_emmeans_diff_wide_mod4  <- tal_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

tal_emmeans_diff_DiD_mod4_raw <- tal_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(tal_emmeans_diff_mod1) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

tal_emmeans_diff_DiD_mod4  <- tal_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(tal_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(tal_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/tal_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
tal_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

tal_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(tal_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/tal_placebo_pvalue_mod4")

plot_volcano(tal_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 TAL Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/tal_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(tal_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/tal_dapa_pvalue_mod4")

plot_volcano(tal_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 TAL Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/tal_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(tal_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/tal_DiD_pvalue_mod4")

plot_volcano(tal_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 TAL DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/tal_DiD_adj_pvalue_mod4")

# Counts
# Total, p-value, q-value
tal_mod4_tot_pos <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
tal_mod4_tot_neg <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
tal_mod4_sig_pos <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
tal_mod4_sig_neg <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
tal_mod4_adj_sig_pos <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
tal_mod4_adj_sig_neg <- nrow(tal_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

tal_mod4_count <- data.frame(total = c(tal_mod4_tot_pos, tal_mod4_tot_neg),
                            pvalue = c(tal_mod4_sig_pos, tal_mod4_sig_neg),
                            fdr = c(tal_mod4_adj_sig_pos, tal_mod4_adj_sig_neg))
rownames(tal_mod4_count) <- c("Positive", "Negative")
kable(tal_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# tal_placebo_pos <- (tal_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# tal_placebo_neg <- (tal_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# tal_dapa_pos <- (tal_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# tal_dapa_neg <- (tal_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
tal_DiD_pos_mod4 <- (tal_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
tal_DiD_neg_mod4 <- (tal_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# tal_gsea_placebo_pos_mod4 <- enrichr(tal_placebo_pos, dbs)
# # expected negative
# tal_gsea_placebo_neg_mod4 <- enrichr(tal_placebo_neg, dbs)
# # actual positive
# tal_gsea_dapa_pos_mod4 <- enrichr(tal_dapa_pos, dbs)
# # actual negative
# tal_gsea_dapa_neg_mod4 <- enrichr(tal_dapa_neg, dbs)
# DiD positive
tal_gsea_DiD_pos_mod4 <- enrichr(tal_DiD_pos_mod4, dbs)
# DiD negative
tal_gsea_DiD_neg_mod4 <- enrichr(tal_DiD_neg_mod4, dbs)

# tal_gsea_placebo_pos_mod4
# tal_gsea_placebo_neg_mod4
# tal_gsea_dapa_pos_mod4
# tal_gsea_dapa_neg_mod4
# tal_gsea_DiD_pos_mod4
# tal_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - TAL GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - TAL KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - TAL REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - TAL REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - TAL GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - TAL KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - TAL REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(tal_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - TAL REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/tal_neg_DiD_gsea_reactome24.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(tal_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(tal_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(tal_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_tal_mod4 <- tal_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_tal_mod4) <- tal_emmeans_diff_DiD_mod4_raw$Gene
rankings_tal_mod4 <- sort(rankings_tal_mod4, decreasing = TRUE)
plot(rankings_tal_mod4)
min(rankings_tal_mod4)
max(rankings_tal_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_tal_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_tal_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_tal_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_tal_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_tal_mod4 <- fgsea(pathways = go,
                        stats = rankings_tal_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_tal_mod4[, padj < 0.05]), sum(kegg_legacy_res_tal_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_tal_mod4[, padj < 0.05]), sum(reactome_res_tal_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_tal_mod4[, padj < 0.05]), sum(go_res_tal_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_tal_mod4, title = "Model 4 TAL Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_tal_mod4, title = "Model 4 TAL Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_tal_mod4, title = "Model 4 TAL Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### PC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
pc_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/pc_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
pc_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/pc_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
pc_model_filtered_mod4 <- pc_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))

pc_emmeans_filtered_mod4 <- pc_emmeans_df_mod4 %>%
  filter(Gene %in% pc_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
pc_nonconverged_genes_mod4 <- unique((pc_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
pc_nonconverged_percentage_mod4 <- (length(unique(pc_nonconverged_genes_mod4))/length(unique(pc_model_df_mod4$Gene)))*100
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(pc_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(pc_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
pc_emmeans_diff_mod4 <- pc_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
pc_emmeans_diff_placebo_mod4 <- pc_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pc_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
pc_emmeans_diff_dapa_mod4 <- pc_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(pc_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(pc_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pc_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
pc_emmeans_diff_wide_mod4  <- pc_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

pc_emmeans_diff_DiD_mod4_raw <- pc_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(pc_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 
pc_emmeans_diff_DiD_mod4  <-  pc_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(pc_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(pc_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/pc_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
pc_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

pc_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(pc_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pc_placebo_pvalue_mod4")

plot_volcano(pc_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 PC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pc_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(pc_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pc_dapa_pvalue_mod4")

plot_volcano(pc_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 PC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pc_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(pc_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/pc_DiD_pvalue_mod4")

plot_volcano(pc_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 PC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/pc_DiD_adj_pvalue_mod4")

# Counts
# total, p-value, q-value
pc_mod4_tot_pos <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
pc_mod4_tot_neg <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
pc_mod4_sig_pos <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
pc_mod4_sig_neg <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
pc_mod4_adj_sig_pos <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
pc_mod4_adj_sig_neg <- nrow(pc_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

pc_mod4_count <- data.frame(total = c(pc_mod4_tot_pos, pc_mod4_tot_neg),
                            pvalue = c(pc_mod4_sig_pos, pc_mod4_sig_neg),
                            fdr = c(pc_mod4_adj_sig_pos, pc_mod4_adj_sig_neg))
rownames(pc_mod4_count) <- c("Positive", "Negative")
kable(pc_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# pc_placebo_pos <- (pc_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# pc_placebo_neg <- (pc_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# pc_dapa_pos <- (pc_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# pc_dapa_neg <- (pc_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
pc_DiD_pos_mod4 <- (pc_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
pc_DiD_neg_mod4 <- (pc_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# pc_gsea_placebo_pos_mod4 <- enrichr(pc_placebo_pos, dbs)
# # expected negative
# pc_gsea_placebo_neg_mod4 <- enrichr(pc_placebo_neg, dbs)
# # actual positive
# pc_gsea_dapa_pos_mod4 <- enrichr(pc_dapa_pos, dbs)
# # actual negative
# pc_gsea_dapa_neg_mod4 <- enrichr(pc_dapa_neg, dbs)
# DiD positive
pc_gsea_DiD_pos_mod4 <- enrichr(pc_DiD_pos_mod4, dbs)
# DiD negative
pc_gsea_DiD_neg_mod4 <- enrichr(pc_DiD_neg_mod4, dbs)

# pc_gsea_placebo_pos_mod4
# pc_gsea_placebo_neg_mod4
# pc_gsea_dapa_pos_mod4
# pc_gsea_dapa_neg_mod4
# pc_gsea_DiD_pos_mod4
# pc_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - PC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - PC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - PC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - PC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - PC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - PC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - PC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(pc_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - PC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/pc_neg_DiD_gsea_reactome24.jpeg")
```

#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(pc_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(pc_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(pc_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_pc_mod4 <- pc_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_pc_mod4) <- pc_emmeans_diff_DiD_mod4_raw$Gene
rankings_pc_mod4 <- sort(rankings_pc_mod4, decreasing = TRUE)
plot(rankings_pc_mod4)
min(rankings_pc_mod4)
max(rankings_pc_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_pc_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_pc_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_pc_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_pc_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_pc_mod4 <- fgsea(pathways = go,
                        stats = rankings_pc_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_pc_mod4[, padj < 0.05]), sum(kegg_legacy_res_pc_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_pc_mod4[, padj < 0.05]), sum(reactome_res_pc_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_pc_mod4[, padj < 0.05]), sum(go_res_pc_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_pc_mod4, title = "Model 4 PC Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_pc_mod4, title = "Model 4 PC Top 30 REACTOME", xlimit = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_pc_mod4, title = "Model 4 PC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### Immune (very few cells)
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
immune_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/immune_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
immune_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/immune_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
immune_model_filtered_mod4 <- immune_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
immune_emmeans_filtered_mod4 <- immune_emmeans_df_mod4 %>%
  filter(Gene %in% immune_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
immune_nonconverged_genes_mod4 <- unique((immune_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
immune_nonconverged_percentage_mod4 <- (length(unique(immune_nonconverged_genes_mod4))/length(unique(immune_model_df_mod4$Gene)))*100
immune_nonconverged_percentage_mod4
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(immune_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(immune_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
immune_emmeans_diff_mod4 <- immune_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
immune_emmeans_diff_placebo_mod4 <- immune_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/immune_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
immune_emmeans_diff_dapa_mod4 <- immune_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(immune_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(immune_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/immune_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
immune_emmeans_diff_wide_mod4  <- immune_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

immune_emmeans_diff_DiD_mod4_raw <- immune_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(immune_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 
immune_emmeans_diff_DiD_mod4 <- immune_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(immune_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(immune_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/immune_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
immune_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

immune_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(immune_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/immune_placebo_pvalue_mod4")

plot_volcano(immune_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 Immune Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/immune_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(immune_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/immune_dapa_pvalue_mod4")

plot_volcano(immune_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 Immune Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/immune_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(immune_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/immune_DiD_pvalue_mod4")

plot_volcano(immune_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 Immune DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/immune_DiD_adj_pvalue_mod4")

# Counts
# total, p-value, q-value
immune_mod4_tot_pos <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
immune_mod4_tot_neg <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
immune_mod4_sig_pos <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
immune_mod4_sig_neg <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
immune_mod4_adj_sig_pos <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
immune_mod4_adj_sig_neg <- nrow(immune_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

immune_mod4_count <- data.frame(total = c(immune_mod4_tot_pos, immune_mod4_tot_neg),
                            pvalue = c(immune_mod4_sig_pos, immune_mod4_sig_neg),
                            fdr = c(immune_mod4_adj_sig_pos, immune_mod4_adj_sig_neg))
rownames(immune_mod4_count) <- c("Positive", "Negative")
kable(immune_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# immune_placebo_pos <- (immune_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# immune_placebo_neg <- (immune_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# immune_dapa_pos <- (immune_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# immune_dapa_neg <- (immune_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
immune_DiD_pos_mod4 <- (immune_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
immune_DiD_neg_mod4 <- (immune_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# immune_gsea_placebo_pos_mod4 <- enrichr(immune_placebo_pos, dbs)
# # expected negative
# immune_gsea_placebo_neg_mod4 <- enrichr(immune_placebo_neg, dbs)
# # actual positive
# immune_gsea_dapa_pos_mod4 <- enrichr(immune_dapa_pos, dbs)
# # actual negative
# immune_gsea_dapa_neg_mod4 <- enrichr(immune_dapa_neg, dbs)
# DiD positive
immune_gsea_DiD_pos_mod4 <- enrichr(immune_DiD_pos_mod4, dbs)
# DiD negative
immune_gsea_DiD_neg_mod4 <- enrichr(immune_DiD_neg_mod4, dbs)

# immune_gsea_placebo_pos_mod4
# immune_gsea_placebo_neg_mod4
# immune_gsea_dapa_pos_mod4
# immune_gsea_dapa_neg_mod4
# immune_gsea_DiD_pos_mod4
# immune_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - Immune GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - Immune KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - Immune REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - Immune REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - Immune GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - Immune KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - Immune REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(immune_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - Immune REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/immune_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(immune_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(immune_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(immune_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_immune_mod4 <- immune_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_immune_mod4) <- immune_emmeans_diff_DiD_mod4_raw$Gene
rankings_immune_mod4 <- sort(rankings_immune_mod4, decreasing = TRUE)
plot(rankings_immune_mod4)
min(rankings_immune_mod4)
max(rankings_immune_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_immune_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_immune_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_immune_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_immune_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_immune_mod4 <- fgsea(pathways = go,
                        stats = rankings_immune_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_immune_mod4[, padj < 0.05]), sum(kegg_legacy_res_immune_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_immune_mod4[, padj < 0.05]), sum(reactome_res_immune_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_immune_mod4[, padj < 0.05]), sum(go_res_immune_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_immune_mod4, title = "Model 4 Immune Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_immune_mod4, title = "Model 4 Immune Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_immune_mod4, title = "Model 4 Immune Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### IC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ic_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/ic_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
ic_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/ic_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
ic_model_filtered_mod4 <- ic_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ic_emmeans_filtered_mod4 <- ic_emmeans_df_mod4 %>%
  filter(Gene %in% ic_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ic_nonconverged_genes_mod4 <- unique((ic_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ic_nonconverged_percentage_mod4 <- (length(unique(ic_nonconverged_genes_mod4))/length(unique(ic_model_df_mod4$Gene)))*100
ic_nonconverged_percentage_mod4
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(ic_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(ic_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ic_emmeans_diff_mod4 <- ic_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ic_emmeans_diff_placebo_mod4 <- ic_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ic_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
ic_emmeans_diff_dapa_mod4 <- ic_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ic_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ic_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ic_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ic_emmeans_diff_wide_mod4  <- ic_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ic_emmeans_diff_DiD_mod4_raw <- ic_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(ic_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 

ic_emmeans_diff_DiD_mod4  <- ic_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ic_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ic_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ic_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ic_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ic_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```
#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(ic_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ic_placebo_pvalue_mod4")

plot_volcano(ic_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 IC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ic_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(ic_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ic_dapa_pvalue_mod4")

plot_volcano(ic_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 IC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ic_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(ic_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ic_DiD_pvalue_mod4")

plot_volcano(ic_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 IC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ic_DiD_adj_pvalue_mod4")

# Counts
# total, p-value, q-value
ic_mod4_tot_pos <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
ic_mod4_tot_neg <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
ic_mod4_sig_pos <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
ic_mod4_sig_neg <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
ic_mod4_adj_sig_pos <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
ic_mod4_adj_sig_neg <- nrow(ic_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

ic_mod4_count <- data.frame(total = c(ic_mod4_tot_pos, ic_mod4_tot_neg),
                            pvalue = c(ic_mod4_sig_pos, ic_mod4_sig_neg),
                            fdr = c(ic_mod4_adj_sig_pos, ic_mod4_adj_sig_neg))
rownames(ic_mod4_count) <- c("Positive", "Negative")
kable(ic_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# ic_placebo_pos <- (ic_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# ic_placebo_neg <- (ic_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# ic_dapa_pos <- (ic_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# ic_dapa_neg <- (ic_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
ic_DiD_pos_mod4 <- (ic_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
ic_DiD_neg_mod4 <- (ic_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# ic_gsea_placebo_pos_mod4 <- enrichr(ic_placebo_pos, dbs)
# # expected negative
# ic_gsea_placebo_neg_mod4 <- enrichr(ic_placebo_neg, dbs)
# # actual positive
# ic_gsea_dapa_pos_mod4 <- enrichr(ic_dapa_pos, dbs)
# # actual negative
# ic_gsea_dapa_neg_mod4 <- enrichr(ic_dapa_neg, dbs)
# DiD positive
ic_gsea_DiD_pos_mod4 <- enrichr(ic_DiD_pos_mod4, dbs)
# DiD negative
ic_gsea_DiD_neg_mod4 <- enrichr(ic_DiD_neg_mod4, dbs)

# ic_gsea_placebo_pos_mod4
# ic_gsea_placebo_neg_mod4
# ic_gsea_dapa_pos_mod4
# ic_gsea_dapa_neg_mod4
# ic_gsea_DiD_pos_mod4
# ic_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - IC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - IC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - IC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - IC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - IC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - IC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - IC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ic_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - IC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ic_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ic_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ic_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ic_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_ic_mod4 <- ic_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_ic_mod4) <- ic_emmeans_diff_DiD_mod4_raw$Gene
rankings_ic_mod4 <- sort(rankings_ic_mod4, decreasing = TRUE)
plot(rankings_ic_mod4)
min(rankings_ic_mod4)
max(rankings_ic_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ic_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ic_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ic_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_ic_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ic_mod4 <- fgsea(pathways = go,
                        stats = rankings_ic_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ic_mod4[, padj < 0.05]), sum(kegg_legacy_res_ic_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_ic_mod4[, padj < 0.05]), sum(reactome_res_ic_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_ic_mod4[, padj < 0.05]), sum(go_res_ic_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_ic_mod4, title = "Model 4 IC Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_ic_mod4, title = "Model 4 IC Top 30 REACTOME", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_ic_mod4, title = "Model 4 IC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### EC
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
ec_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/ec_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
ec_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/ec_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
ec_model_filtered_mod4 <- ec_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
ec_emmeans_filtered_mod4 <- ec_emmeans_df_mod4 %>%
  filter(Gene %in% ec_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
ec_nonconverged_genes_mod4 <- unique((ec_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
ec_nonconverged_percentage_mod4 <- (length(unique(ec_nonconverged_genes_mod4))/length(unique(ec_model_df_mod4$Gene)))*100
ec_nonconverged_percentage_mod4
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(ec_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(ec_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
ec_emmeans_diff_mod4 <- ec_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
ec_emmeans_diff_placebo_mod4 <- ec_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ec_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
ec_emmeans_diff_dapa_mod4 <- ec_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(ec_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(ec_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ec_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
ec_emmeans_diff_wide_mod4  <- ec_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

ec_emmeans_diff_DiD_mod4_raw <- ec_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(ec_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr"))

ec_emmeans_diff_DiD_mod4  <- ec_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(ec_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(ec_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/ec_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
ec_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

ec_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(ec_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ec_placebo_pvalue_mod4")

plot_volcano(ec_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 EC Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ec_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(ec_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ec_dapa_pvalue_mod4")

plot_volcano(ec_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 EC Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ec_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(ec_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/ec_DiD_pvalue_mod4")

plot_volcano(ec_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 EC DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/ec_DiD_adj_pvalue_mod4")

# Counts
# total, p-value, q-value
ec_mod4_tot_pos <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
ec_mod4_tot_neg <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
ec_mod4_sig_pos <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
ec_mod4_sig_neg <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
ec_mod4_adj_sig_pos <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
ec_mod4_adj_sig_neg <- nrow(ec_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

ec_mod4_count <- data.frame(total = c(ec_mod4_tot_pos, ec_mod4_tot_neg),
                            pvalue = c(ec_mod4_sig_pos, ec_mod4_sig_neg),
                            fdr = c(ec_mod4_adj_sig_pos, ec_mod4_adj_sig_neg))
rownames(ec_mod4_count) <- c("Positive", "Negative")
kable(ec_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# ec_placebo_pos <- (ec_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# ec_placebo_neg <- (ec_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# ec_dapa_pos <- (ec_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# ec_dapa_neg <- (ec_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
ec_DiD_pos_mod4 <- (ec_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
ec_DiD_neg_mod4 <- (ec_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# ec_gsea_placebo_pos_mod4 <- enrichr(ec_placebo_pos, dbs)
# # expected negative
# ec_gsea_placebo_neg_mod4 <- enrichr(ec_placebo_neg, dbs)
# # actual positive
# ec_gsea_dapa_pos_mod4 <- enrichr(ec_dapa_pos, dbs)
# # actual negative
# ec_gsea_dapa_neg_mod4 <- enrichr(ec_dapa_neg, dbs)
# DiD positive
ec_gsea_DiD_pos_mod4 <- enrichr(ec_DiD_pos_mod4, dbs)
# DiD negative
ec_gsea_DiD_neg_mod4 <- enrichr(ec_DiD_neg_mod4, dbs)

# ec_gsea_placebo_pos_mod4
# ec_gsea_placebo_neg_mod4
# ec_gsea_dapa_pos_mod4
# ec_gsea_dapa_neg_mod4
# ec_gsea_DiD_pos_mod4
# ec_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - EC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - EC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - EC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - EC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - EC GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - EC KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - EC REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(ec_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - EC REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/ec_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(ec_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(ec_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(ec_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_ec_mod4 <- ec_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_ec_mod4) <- ec_emmeans_diff_DiD_mod4_raw$Gene
rankings_ec_mod4 <- sort(rankings_ec_mod4, decreasing = TRUE)
plot(rankings_ec_mod4)
min(rankings_ec_mod4)
max(rankings_ec_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_ec_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_ec_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_ec_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_ec_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_ec_mod4 <- fgsea(pathways = go,
                        stats = rankings_ec_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_ec_mod4[, padj < 0.05]), sum(kegg_legacy_res_ec_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_ec_mod4[, padj < 0.05]), sum(reactome_res_ec_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_ec_mod4[, padj < 0.05]), sum(go_res_ec_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_ec_mod4, title = "Model 4 EC Top 30 KEGG", xlim= 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_ec_mod4, title = "Model 4 EC Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_ec_mod4, title = "Model 4 EC Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### DTL (very few cells)
```{r echo = F, eval = F}
## read mixed model results dataframe (rendered in Hyak)
dtl_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/dtl_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
dtl_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/dtl_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F, eval = F}
## keep converged model results only
dtl_model_filtered_mod4 <- dtl_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
dtl_emmeans_filtered_mod4 <- dtl_emmeans_df_mod4 %>%
  filter(Gene %in% dtl_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
dtl_nonconverged_genes <- unique((dtl_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
(length(unique(dtl_nonconverged_genes))/length(unique(dtl_model_df_mod4$Gene)))*100
```

```{r echo = F, eval = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(dtl_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(dtl_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo = F, eval = F}
## compute emmean difference in POST - PRE in each treatment group
dtl_emmeans_diff_mod4 <- dtl_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
dtl_emmeans_diff_placebo_mod4 <- dtl_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
dtl_emmeans_diff_dapa_mod4 <- dtl_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(dtl_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
## write.csv(dtl_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F, eval = F}
## DiD (Differences in Differences)
dtl_emmeans_diff_wide_mod4  <- dtl_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

dtl_emmeans_diff_DiD_mod4 <- dtl_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(dtl_emmeans_diff) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 
# %>%
#   dplyr::select(Gene, DiD, p_value_DiD, q_value)
# colnames(dtl_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
# 
# ### Save for IPA
## write.csv(dtl_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/dtl_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F, eval = F}
dtl_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

dtl_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

### FIB/VSMC/P
```{r echo = F}
## read mixed model results dataframe (rendered in Hyak)
fibvsmcp_model_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/fibvsmcp_attempt_scrna_mm_model_combined_4.rds")

## read emmeans dataframe (rendered in Hyak)
fibvsmcp_emmeans_df_mod4 <- readRDS("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/kopah/4 No nested visit and no zero inflation/fibvsmcp_attempt_scrna_mm_emmeans_combined_4.rds")
```

```{r echo = F}
## keep converged model results only
fibvsmcp_model_filtered_mod4 <- fibvsmcp_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(!is.na(PValue)))
fibvsmcp_emmeans_filtered_mod4 <- fibvsmcp_emmeans_df_mod4 %>%
  filter(Gene %in% fibvsmcp_model_filtered_mod4$Gene) %>%
  group_by(Gene) %>%
  filter(all(!is.na(SE)))
## non-converged genes percentage
fibvsmcp_nonconverged_genes_mod4 <- unique((fibvsmcp_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene)
fibvsmcp_nonconverged_percentage_mod4 <- (length(unique(fibvsmcp_nonconverged_genes_mod4))/length(unique(fibvsmcp_model_df_mod4$Gene)))*100
fibvsmcp_nonconverged_percentage_mod4
```

```{r echo = F}
## arrange the model based on significance of interaction term in model
ordered_model_mod4 <- subset(fibvsmcp_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST") %>%
  arrange(PValue)
gene_order <- factor(ordered_model_mod4$Gene, levels = ordered_model_mod4$Gene)
sig_genes <- subset(fibvsmcp_model_filtered_mod4, Variable == "TreatmentDapagliflozin:VisitPOST" & PValue < 0.05)$Gene
```

```{r echo =F}
## compute emmean difference in POST - PRE in each treatment group
fibvsmcp_emmeans_diff_mod4 <- fibvsmcp_emmeans_filtered_mod4 %>%
  pivot_wider(names_from = Visit, values_from = c(emmean, SE)) %>%
  group_by(Treatment, Gene) %>%
  fill(ends_with("PRE"), ends_with("POST")) %>%
  mutate(diff_emmean = emmean_POST - emmean_PRE,
         SE_diff = sqrt(SE_POST^2 + SE_PRE^2),  ## Propagating SE for difference
         diff_lowerCL = diff_emmean - 1.96 * SE_diff,
         diff_upperCL = diff_emmean + 1.96 * SE_diff,
         t_stat = diff_emmean / SE_diff,  ## t-statistic
         p_value = 2 * pt(-abs(t_stat), df)) %>%
  filter(!is.na(diff_emmean)) %>%
  ungroup() %>%
  mutate(interaction_significance = case_when(Gene %in% sig_genes ~ "p<0.05", 
                                 T ~ "p>0.05"))

## separate out for placebo/dapa & save to run for IPA

### Placebo
fibvsmcp_emmeans_diff_placebo_mod4 <- fibvsmcp_emmeans_diff_mod4 %>%
  filter(Treatment == "Placebo") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_placebo_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_placebo_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/fibvsmcp_emmeans_diff_placebo_4.csv", row.names = F)

### Dapa
fibvsmcp_emmeans_diff_dapa_mod4 <- fibvsmcp_emmeans_diff_mod4 %>%
  filter(Treatment == "Dapagliflozin") %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value, method = "fdr")) %>%
  dplyr::select(Gene, diff_emmean, p_value, q_value)
colnames(fibvsmcp_emmeans_diff_dapa_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")
write.csv(fibvsmcp_emmeans_diff_dapa_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/fibvsmcp_emmeans_diff_dapa_4.csv", row.names = F)
```

```{r echo = F}
## DiD (Differences in Differences)
fibvsmcp_emmeans_diff_wide_mod4  <- fibvsmcp_emmeans_diff_mod4 %>%
  pivot_wider(names_from = Treatment, values_from = c(diff_emmean, SE_diff))

fibvsmcp_emmeans_diff_DiD_mod4_raw <- fibvsmcp_emmeans_diff_wide_mod4  %>%
  group_by(Gene) %>%
  fill(ends_with("Placebo"), ends_with("Dapagliflozin")) %>%
  dplyr::mutate(DiD = diff_emmean_Dapagliflozin - diff_emmean_Placebo,
         SE_DiD = sqrt(SE_diff_Dapagliflozin^2 + SE_diff_Placebo^2),  ## SE computation
         t_stat_DiD = DiD / SE_DiD,  ## t-statistic
         p_value_DiD = 2 * (1 - pt(abs(t_stat_DiD), df = nrow(fibvsmcp_emmeans_diff_mod4) - 2))) %>%
  dplyr::select(Gene, diff_emmean_Dapagliflozin,diff_emmean_Placebo, DiD, SE_DiD, t_stat_DiD, p_value_DiD) %>%
  filter(!is.na(DiD)) %>%
  ungroup() %>%
  mutate(q_value = p.adjust(p_value_DiD, method = "fdr")) 
fibvsmcp_emmeans_diff_DiD_mod4  <-  fibvsmcp_emmeans_diff_DiD_mod4_raw %>%
  dplyr::select(Gene, DiD, p_value_DiD, q_value)
colnames(fibvsmcp_emmeans_diff_DiD_mod4) <- c("Gene", "Expr Other", "Expr p-value", "Expr False Discovery Rate")

### Save for IPA
write.csv(fibvsmcp_emmeans_diff_DiD_mod4, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/emmeans/4 No nested visit and no zero inflation/fibvsmcp_emmeans_diff_DiD_4.csv", row.names = F)
```

#### Top genes delta plot
```{r echo = F}
fibvsmcp_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[1:10]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))

fibvsmcp_emmeans_diff_mod4 %>%
  filter(interaction_significance == "p<0.05") %>%
  filter(Gene %in% gene_order[11:20]) %>%
  ggplot(aes(x = Gene, y = diff_emmean, color = Treatment)) +
    geom_pointrange(aes(ymin = diff_lowerCL, ymax = diff_upperCL, alpha = 0.8),
                    position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        text = element_text(size = 12)) +
  guides(alpha = "none") +
  labs(y = "Delta (Post - Pre)",
       x = NULL) +
  scale_color_manual(values = c("Placebo" = "#df7373",
                                 "Dapagliflozin" = "#3e7cb1"))
```

#### Volcano plots
```{r echo = F}
# Placebo
plot_volcano(fibvsmcp_emmeans_diff_placebo_mod4, "Expr p-value",
             "Model 4 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_placebo_pvalue_mod4")

plot_volcano(fibvsmcp_emmeans_diff_placebo_mod4, "Expr False Discovery Rate", 
             "Model 4 FIB/VSMC/P Placebo", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_placebo_adj_pvalue_mod4")
# Dapa
plot_volcano(fibvsmcp_emmeans_diff_dapa_mod4, "Expr p-value",
             "Model 4 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_dapa_pvalue_mod4")

plot_volcano(fibvsmcp_emmeans_diff_dapa_mod4, "Expr False Discovery Rate", 
             "Model 4 FIB/VSMC/P Dapagliflozin", 
             "EMM Delta (POST - PRE)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_dapa_adj_pvalue_mod4")

# DiD
plot_volcano(fibvsmcp_emmeans_diff_DiD_mod4, "Expr p-value", "Model 4 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_DiD_pvalue_mod4")

plot_volcano(fibvsmcp_emmeans_diff_DiD_mod4, "Expr False Discovery Rate", "Model 4 FIB/VSMC/P DiD", 
             "DiD (Dapagliflozin - Placebo)", 
             "-log10(adj.p-value)",
             "4 No nested visit and no zero inflation/fibvsmcp_DiD_adj_pvalue_mod4")

# Counts
# total, p-value, q-value
fibvsmcp_mod4_tot_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0))
fibvsmcp_mod4_tot_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0))
fibvsmcp_mod4_sig_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr p-value` < 0.05))
fibvsmcp_mod4_sig_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr p-value` < 0.05))
fibvsmcp_mod4_adj_sig_pos <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` > 0) %>% filter(`Expr False Discovery Rate` < 0.05))
fibvsmcp_mod4_adj_sig_neg <- nrow(fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr Other` < 0) %>% filter(`Expr False Discovery Rate` < 0.05))

fibvsmcp_mod4_count <- data.frame(total = c(fibvsmcp_mod4_tot_pos, fibvsmcp_mod4_tot_neg),
                            pvalue = c(fibvsmcp_mod4_sig_pos, fibvsmcp_mod4_sig_neg),
                            fdr = c(fibvsmcp_mod4_adj_sig_pos, fibvsmcp_mod4_adj_sig_neg))
rownames(fibvsmcp_mod4_count) <- c("Positive", "Negative")
kable(fibvsmcp_mod4_count, col.names = c("Total", "P < 0.05", "P < 0.05 (FDR)"))
```
#### GSEA (enrichR)
```{r echo = F}
# pathways from emmeans
# enrichment analysis
# # significant positive in placebo (expected positive)
# fibvsmcp_placebo_pos <- (fibvsmcp_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in placebo (expected negative)
# fibvsmcp_placebo_neg <- (fibvsmcp_emmeans_diff_placebo_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# # significant positive in dapa (actual positive)
# fibvsmcp_dapa_pos <- (fibvsmcp_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` > 0))$Gene
# # significant negative in dapa (actual negative)
# fibvsmcp_dapa_neg <- (fibvsmcp_emmeans_diff_dapa_mod4 %>% filter(`Expr p-value` < 0.01) %>%
#                   filter(`Expr Other` < 0))$Gene
# significant positive in DiD
fibvsmcp_DiD_pos_mod4 <- (fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` > 0))$Gene
# significant negative in DiD
fibvsmcp_DiD_neg_mod4 <- (fibvsmcp_emmeans_diff_DiD_mod4 %>% filter(`Expr p-value` < 0.01) %>%
                  filter(`Expr Other` < 0))$Gene

# # expected positive
# fibvsmcp_gsea_placebo_pos_mod4 <- enrichr(fibvsmcp_placebo_pos, dbs)
# # expected negative
# fibvsmcp_gsea_placebo_neg_mod4 <- enrichr(fibvsmcp_placebo_neg, dbs)
# # actual positive
# fibvsmcp_gsea_dapa_pos_mod4 <- enrichr(fibvsmcp_dapa_pos, dbs)
# # actual negative
# fibvsmcp_gsea_dapa_neg_mod4 <- enrichr(fibvsmcp_dapa_neg, dbs)
# DiD positive
fibvsmcp_gsea_DiD_pos_mod4 <- enrichr(fibvsmcp_DiD_pos_mod4, dbs)
# DiD negative
fibvsmcp_gsea_DiD_neg_mod4 <- enrichr(fibvsmcp_DiD_neg_mod4, dbs)

# fibvsmcp_gsea_placebo_pos_mod4
# fibvsmcp_gsea_placebo_neg_mod4
# fibvsmcp_gsea_dapa_pos_mod4
# fibvsmcp_gsea_dapa_neg_mod4
# fibvsmcp_gsea_DiD_pos_mod4
# fibvsmcp_gsea_DiD_neg_mod4
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod4[[1]]), title = "Model 4 Positive DiD - FIB/VSMC/P GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod4[[2]]), title = "Model 4 Positive DiD - FIB/VSMC/P KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod4[[3]]), title = "Model 4 Positive DiD - FIB/VSMC/P REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_pos_mod4[[4]]), title = "Model 4 Positive DiD - FIB/VSMC/P REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_pos_DiD_gsea_reactome24.jpeg")

plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod4[[1]]), title = "Model 4 Negative DiD - FIB/VSMC/P GO")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_go.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod4[[2]]), title = "Model 4 Negative DiD - FIB/VSMC/P KEGG")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_kegg.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod4[[3]]), title = "Model 4 Negative DiD - FIB/VSMC/P REACTOME '22")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_reactome22.jpeg")
plotEnrich(as.data.frame(fibvsmcp_gsea_DiD_neg_mod4[[4]]), title = "Model 4 Negative DiD - FIB/VSMC/P REACTOME '24")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/GSEA/4 No nested visit and no zero inflation/fibvsmcp_neg_DiD_gsea_reactome24.jpeg")
```
#### GSEA (fgsea)
```{r echo = F}
# For GSEA
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(fibvsmcp_model_filtered_mod4$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(fibvsmcp_model_filtered_mod4$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(fibvsmcp_model_filtered_mod4$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_fibvsmcp_mod4 <- fibvsmcp_emmeans_diff_DiD_mod4_raw$t_stat_DiD
names(rankings_fibvsmcp_mod4) <- fibvsmcp_emmeans_diff_DiD_mod4_raw$Gene
rankings_fibvsmcp_mod4 <- sort(rankings_fibvsmcp_mod4, decreasing = TRUE)
plot(rankings_fibvsmcp_mod4)
min(rankings_fibvsmcp_mod4)
max(rankings_fibvsmcp_mod4)
```

```{r echo = F}
set.seed(1234)

kegg_legacy_res_fibvsmcp_mod4 <- fgsea(pathways = kegg_legacy,
                                 stats = rankings_fibvsmcp_mod4,
                                 scoreType = 'std', 
                                 minSize = 3,
                                 maxSize = 500,
                                 nproc = 1)

reactome_res_fibvsmcp_mod4 <- fgsea(pathways = reactome,
                              stats = rankings_fibvsmcp_mod4,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
go_res_fibvsmcp_mod4 <- fgsea(pathways = go,
                        stats = rankings_fibvsmcp_mod4,
                        scoreType = 'std', 
                        minSize = 5,
                        maxSize = 500,
                        nproc = 1)

mod4_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_fibvsmcp_mod4[, padj < 0.05]), sum(kegg_legacy_res_fibvsmcp_mod4[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_fibvsmcp_mod4[, padj < 0.05]), sum(reactome_res_fibvsmcp_mod4[, pval < 0.05])),
                         "GO"=c(sum(go_res_fibvsmcp_mod4[, padj < 0.05]), sum(go_res_fibvsmcp_mod4[, pval < 0.05])))
rownames(mod4_fgsea) <- c("adj.pval", "p.val")
mod4_fgsea
```
##### KEGG Legacy
```{r echo = F}
plot_fgsea(kegg_legacy_res_fibvsmcp_mod4, title = "Model 4 FIB/VSMC/P Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
plot_fgsea(reactome_res_fibvsmcp_mod4, title = "Model 4 FIB/VSMC/P Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
plot_fgsea(go_res_fibvsmcp_mod4, title = "Model 4 FIB/VSMC/P Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

## Troubleshooting...
```{r echo = F, eval = F}
## PT
pt_nonconverged_genes_mod4 <- (pt_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pt_nonconverged_genes_mod4))/length(unique(pt_model_df_mod4$Gene)))*100
## TAL
tal_nonconverged_genes_mod4 <- (tal_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(tal_nonconverged_genes_mod4))/length(unique(tal_model_df_mod4$Gene)))*100
## PC
pc_nonconverged_genes_mod4 <- (pc_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(pc_nonconverged_genes_mod4))/length(unique(pc_model_df_mod4$Gene)))*100
## Immune
immune_nonconverged_genes_mod4 <- (immune_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(immune_nonconverged_genes_mod4))/length(unique(immune_model_df_mod4$Gene)))*100
## IC
ic_nonconverged_genes_mod4 <- (ic_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ic_nonconverged_genes_mod4))/length(unique(ic_model_df_mod4$Gene)))*100
## EC
ec_nonconverged_genes_mod4 <- (ec_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(ec_nonconverged_genes_mod4))/length(unique(ec_model_df_mod4$Gene)))*100
## DTL
## dtl_nonconverged_genes_mod4 <- (dtl_model_df_mod4 %>%
##   group_by(Gene) %>%
##   filter(all(is.na(PValue))))$Gene
## (length(unique(dtl_nonconverged_genes_mod4))/length(unique(dtl_model_df_mod4$Gene)))*100
## FIB/VSMC/P
fibvsmcp_nonconverged_genes_mod4 <- (fibvsmcp_model_df_mod4 %>%
  group_by(Gene) %>%
  filter(all(is.na(PValue))))$Gene
(length(unique(fibvsmcp_nonconverged_genes_mod4))/length(unique(fibvsmcp_model_df_mod4$Gene)))*100

nonconverged_list <- list(pt = pt_nonconverged_genes_mod4,
                          immune = immune_nonconverged_genes_mod4,
                          #ic = ic_nonconverged_genes_mod4,
                          #ec = ec_nonconverged_genes_mod4,
                          #dtl = dtl_nonconverged_genes_mod4,
                          #fibvsmcp = fibvsmcp_nonconverged_genes_mod4,
                          tal = tal_nonconverged_genes_mod4)
                          #pc = pc_nonconverged_genes_mod4)
upset(fromList(nonconverged_list), order.by = "freq")
```

## IPA pathway results

```{r echo = F}
text1 = 6.5
text2 = 18
text3 = 20
scenario_colors = c("Activated in D, stable/inhibited in P" = "#81171b",
                    "Activated in both, more in D" = "#ad2e24",
                    "Stable in D, inhibited in P" = "#c75146",
                    "Inhibited in both, less in D" = "#ea8c55",
                    "Activated in P, stable/inhibited in D" = "#1d3461",
                    "Activated in both, less in D" = "#004ba8",
                    "Stable in P, inhibited in D" = "#2c7da0", 
                    "Inhibited in both, more in D" = "#22aed1")
```

### PT

```{r echo = F}
pt_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pt_DiD_pathways_4.xls", skip = 1) 
pt_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pt_dapa_pathways_4.xls", skip = 1) 
pt_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pt_placebo_pathways_4.xls", skip = 1) 

colnames(pt_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pt_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pt_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pt_pathways_merged_mod4 <- pt_pathways_mod4 %>%
  full_join(pt_dapa_mod4) %>% full_join(pt_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))
```


```{r echo = F}
pt_pathways_merged_mod4$scenario <- factor(pt_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pt_pathways_inhibited_mod4 <- pt_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_inhibited_mod4$pathway <- reorder(pt_pathways_inhibited_mod4$pathway, pt_pathways_inhibited_mod4$neg_log_p)
  
pt_top30_inhibited_mod4 <- pt_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_inhibited_mod4 <- pt_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()
## pt_inhibited_scenarios <- as.data.frame(table(pt_pathways_inhibited_mod4$scenario))[5:8,] %>%
##   mutate(percent = (Freq / nrow(pt_pathways_inhibited_mod4))*100) %>%
##   ggplot(aes(x = Var1, y = percent, fill = Var1)) + 
##   geom_col() +
##   scale_fill_manual(values = scenario_colors) +
##   scale_x_discrete(drop = T) +
##   theme_minimal() +
##   theme(panel.grid = element_blank(),
##         axis.text.x = element_text(size = text2,
##                                    angle = 30,
##                                    hjust = 1),
##         axis.ticks.y = element_blank(), 
##         legend.position = "none",
##         text = element_text(size = text3),
##         panel.background = element_rect(color="black")) +
##   labs(y = "Percent",
##        x = NULL,
##        fill = "Scenario") +
##   ylim(c(0,50))
## 
## pt_top30_inhibited_mod4 + inset_element(pt_inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.8, top = 0.6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pt_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pt_pathways_inhibited_sig_mod4 <- pt_pathways_inhibited_mod4 %>%
  filter(z <= -2)
pt_top30_inhibited_2_mod4 <- pt_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pt_pathways_inhibited_sig_mod4$z), max(-pt_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

## top30_inhibited_mod4 + inset_element(inhibited_scenarios, 
##                                left = 0.45, bottom = 0.01,
##                                right = 0.80, top = 0.6)
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pt_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pt_pathways_activated_mod4 <- pt_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pt_pathways_activated_mod4$pathway <- reorder(pt_pathways_activated_mod4$pathway, pt_pathways_activated_mod4$neg_log_p)
  
pt_top30_activated_mod4 <- pt_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pt_pathways_activated_mod4 <- pt_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pt_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pt_pathways_activated_sig_mod4 <- pt_pathways_activated_mod4 %>%
  filter(z > 2)
pt_top30_activated_2_mod4 <- pt_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pt_pathways_activated_sig_mod4$z), max(pt_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PT Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.125, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pt_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pt_neg_pathways_merged_long_mod4 <- pt_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_neg_pathways_merged_long_mod4$name <- factor(pt_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 40, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/pt_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

pt_pos_pathways_merged_long_mod4 <- pt_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pt_pos_pathways_merged_long_mod4$name <- factor(pt_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pt_pos_pathways_merged_long_mod4
pt_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 40, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PT Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/pt_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### TAL

```{r echo = F}
tal_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/tal_DiD_pathways_4.xls", skip = 1) 
tal_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/tal_dapa_pathways_4.xls", skip = 1) 
tal_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/tal_placebo_pathways_4.xls", skip = 1) 

colnames(tal_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(tal_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(tal_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

tal_pathways_merged_mod4 <- tal_pathways_mod4 %>%
  full_join(tal_dapa_mod4) %>% full_join(tal_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo)  %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

tal_pathways_merged_mod4$scenario <- factor(tal_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
tal_pathways_inhibited_mod4 <- tal_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_inhibited_mod4$pathway <- reorder(tal_pathways_inhibited_mod4$pathway, tal_pathways_inhibited_mod4$neg_log_p)
  
tal_top30_inhibited_mod4 <- tal_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_inhibited_mod4 <- tal_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/tal_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
tal_pathways_inhibited_sig_mod4 <- tal_pathways_inhibited_mod4 %>%
  filter(z < -2)
tal_top30_inhibited_2_mod4 <- tal_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-tal_pathways_inhibited_sig_mod4$z), max(-tal_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/tal_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
tal_pathways_activated_mod4 <- tal_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

tal_pathways_activated_mod4$pathway <- reorder(tal_pathways_activated_mod4$pathway, tal_pathways_activated_mod4$neg_log_p)
  
tal_top30_activated_mod4 <- tal_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_tal_pathways_activated_mod4 <- tal_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/tal_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
tal_pathways_activated_sig_mod4 <- tal_pathways_activated_mod4 %>%
  filter(z > 2)
tal_top30_activated_2_mod4 <- tal_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(tal_pathways_activated_sig_mod4$z), max(tal_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "TAL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/tal_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
tal_neg_pathways_merged_long_mod4 <- tal_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_neg_pathways_merged_long_mod4$name <- factor(tal_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/tal_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

tal_pos_pathways_merged_long_mod4 <- tal_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
tal_pos_pathways_merged_long_mod4$name <- factor(tal_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

tal_pos_pathways_merged_long_mod4
tal_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "TAL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/tal_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### PC

```{r echo = F}
pc_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pc_DiD_pathways_4.xls", skip = 1) 
pc_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pc_dapa_pathways_4.xls", skip = 1) 
pc_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/pc_placebo_pathways_4.xls", skip = 1) 

colnames(pc_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(pc_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(pc_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

pc_pathways_merged_mod4 <- pc_pathways_mod4 %>%
  full_join(pc_dapa_mod4) %>% full_join(pc_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

pc_pathways_merged_mod4$scenario <- factor(pc_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
pc_pathways_inhibited_mod4 <- pc_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_inhibited_mod4$pathway <- reorder(pc_pathways_inhibited_mod4$pathway, pc_pathways_inhibited_mod4$neg_log_p)
  
pc_top30_inhibited_mod4 <- pc_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.04) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_inhibited_mod4 <- pc_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pc_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
pc_pathways_inhibited_sig_mod4 <- pc_pathways_inhibited_mod4 %>%
  filter(z < -2)
pc_top30_inhibited_2_mod4 <- pc_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-pc_pathways_inhibited_sig_mod4$z), max(-pc_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pc_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
pc_pathways_activated_mod4 <- pc_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

pc_pathways_activated_mod4$pathway <- reorder(pc_pathways_activated_mod4$pathway, pc_pathways_activated_mod4$neg_log_p)
  
pc_top30_activated_mod4 <- pc_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_pc_pathways_activated_mod4 <- pc_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pc_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
pc_pathways_activated_sig_mod4 <- pc_pathways_activated_mod4 %>%
  filter(z > 2)
pc_top30_activated_2_mod4 <- pc_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(pc_pathways_activated_sig_mod4$z), max(pc_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "PC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.4, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/pc_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
pc_neg_pathways_merged_long_mod4 <- pc_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_neg_pathways_merged_long_mod4$name <- factor(pc_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/pc_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

pc_pos_pathways_merged_long_mod4 <- pc_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
pc_pos_pathways_merged_long_mod4$name <- factor(pc_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

pc_pos_pathways_merged_long_mod4
pc_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "PC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/pc_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### Immune (very few cells)

```{r echo = F}
immune_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/immune_DiD_pathways_4.xls", skip = 1) 
immune_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/immune_dapa_pathways_4.xls", skip = 1) 
immune_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/immune_placebo_pathways_4.xls", skip = 1) 

colnames(immune_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(immune_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(immune_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

immune_pathways_merged_mod4 <- immune_pathways_mod4 %>%
  full_join(immune_dapa_mod4) %>% full_join(immune_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

immune_pathways_merged_mod4$scenario <- factor(immune_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
immune_pathways_inhibited_mod4 <- immune_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_inhibited_mod4$pathway <- reorder(immune_pathways_inhibited_mod4$pathway, immune_pathways_inhibited_mod4$neg_log_p)
  
immune_top30_inhibited_mod4 <- immune_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_inhibited_mod4 <- immune_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/immune_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
immune_pathways_inhibited_sig_mod4 <- immune_pathways_inhibited_mod4 %>%
  filter(z < -2)
immune_top30_inhibited_2_mod4 <- immune_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-immune_pathways_inhibited_sig_mod4$z), max(-immune_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/immune_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
immune_pathways_activated_mod4 <- immune_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

immune_pathways_activated_mod4$pathway <- reorder(immune_pathways_activated_mod4$pathway, immune_pathways_activated_mod4$neg_log_p)
  
immune_top30_activated_mod4 <- immune_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_immune_pathways_activated_mod4 <- immune_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/immune_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
immune_pathways_activated_sig_mod4 <- immune_pathways_activated_mod4 %>%
  filter(z > 2)
immune_top30_activated_2_mod4 <- immune_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(immune_pathways_activated_sig_mod4$z), max(immune_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "Immune Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/immune_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
immune_neg_pathways_merged_long_mod4 <- immune_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_neg_pathways_merged_long_mod4$name <- factor(immune_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 60, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/immune_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

immune_pos_pathways_merged_long_mod4 <- immune_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
immune_pos_pathways_merged_long_mod4$name <- factor(immune_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

immune_pos_pathways_merged_long_mod4
immune_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "Immune Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/immune_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### IC

```{r echo = F}
ic_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ic_DiD_pathways_4.xls", skip = 1) 
ic_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ic_dapa_pathways_4.xls", skip = 1) 
ic_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ic_placebo_pathways_4.xls", skip = 1) 

colnames(ic_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ic_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ic_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ic_pathways_merged_mod4 <- ic_pathways_mod4 %>%
  full_join(ic_dapa_mod4) %>% full_join(ic_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ic_pathways_merged_mod4$scenario <- factor(ic_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ic_pathways_inhibited_mod4 <- ic_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_inhibited_mod4$pathway <- reorder(ic_pathways_inhibited_mod4$pathway, ic_pathways_inhibited_mod4$neg_log_p)
  
ic_top30_inhibited_mod4 <- ic_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_inhibited_mod4 <- ic_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ic_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ic_pathways_inhibited_sig_mod4 <- ic_pathways_inhibited_mod4 %>%
  filter(z < -2)
ic_top30_inhibited_2_mod4 <- ic_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ic_pathways_inhibited_sig_mod4$z), max(-ic_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ic_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ic_pathways_activated_mod4 <- ic_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ic_pathways_activated_mod4$pathway <- reorder(ic_pathways_activated_mod4$pathway, ic_pathways_activated_mod4$neg_log_p)
  
ic_top30_activated_mod4 <- ic_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ic_pathways_activated_mod4 <- ic_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ic_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ic_pathways_activated_sig_mod4 <- ic_pathways_activated_mod4 %>%
  filter(z > 2)
ic_top30_activated_2_mod4 <- ic_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ic_pathways_activated_sig_mod4$z), max(ic_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "IC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ic_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ic_neg_pathways_merged_long_mod4 <- ic_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_neg_pathways_merged_long_mod4$name <- factor(ic_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/ic_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

ic_pos_pathways_merged_long_mod4 <- ic_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ic_pos_pathways_merged_long_mod4$name <- factor(ic_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ic_pos_pathways_merged_long_mod4
ic_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 50, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "IC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/ic_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### EC

```{r echo = F}
ec_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ec_DiD_pathways_4.xls", skip = 1) 
ec_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ec_dapa_pathways_4.xls", skip = 1) 
ec_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/ec_placebo_pathways_4.xls", skip = 1) 

colnames(ec_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(ec_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(ec_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

ec_pathways_merged_mod4 <- ec_pathways_mod4 %>%
  full_join(ec_dapa_mod4) %>% full_join(ec_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

ec_pathways_merged_mod4$scenario <- factor(ec_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
ec_pathways_inhibited_mod4 <- ec_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_inhibited_mod4$pathway <- reorder(ec_pathways_inhibited_mod4$pathway, ec_pathways_inhibited_mod4$neg_log_p)
  
ec_top30_inhibited_mod4 <- ec_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.05) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_inhibited_mod4 <- ec_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ec_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
ec_pathways_inhibited_sig_mod4 <- ec_pathways_inhibited_mod4 %>%
  filter(z < -2)
ec_top30_inhibited_2_mod4 <- ec_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-ec_pathways_inhibited_sig_mod4$z), max(-ec_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.2, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ec_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
ec_pathways_activated_mod4 <- ec_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

ec_pathways_activated_mod4$pathway <- reorder(ec_pathways_activated_mod4$pathway, ec_pathways_activated_mod4$neg_log_p)
  
ec_top30_activated_mod4 <- ec_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_ec_pathways_activated_mod4 <- ec_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ec_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
ec_pathways_activated_sig_mod4 <- ec_pathways_activated_mod4 %>%
  filter(z > 2)
ec_top30_activated_2_mod4 <- ec_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(ec_pathways_activated_sig_mod4$z), max(ec_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "EC Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 2), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(1, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/ec_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```
#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
ec_neg_pathways_merged_long_mod4 <- ec_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_neg_pathways_merged_long_mod4$name <- factor(ec_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/ec_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

ec_pos_pathways_merged_long_mod4 <- ec_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
ec_pos_pathways_merged_long_mod4$name <- factor(ec_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

ec_pos_pathways_merged_long_mod4
ec_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 40, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "EC Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/ec_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### DTL (very few cells)

```{r echo = F, eval = F}
dtl_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/dtl_DiD_pathways_4.xls", skip = 1) 
dtl_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/dtl_dapa_pathways_4.xls", skip = 1) 
dtl_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/dtl_placebo_pathways_4.xls", skip = 1) 

colnames(dtl_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(dtl_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(dtl_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

dtl_pathways_merged_mod4 <- dtl_pathways_mod4 %>%
  full_join(dtl_dapa_mod4) %>% full_join(dtl_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

dtl_pathways_merged_mod4$scenario <- factor(dtl_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F, eval = F}
dtl_pathways_inhibited_mod4 <- dtl_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_inhibited_mod4$pathway <- reorder(dtl_pathways_inhibited_mod4$pathway, dtl_pathways_inhibited_mod4$neg_log_p)
  
dtl_top30_inhibited_mod4 <- dtl_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_inhibited_mod4 <- dtl_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/dtl_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2 (none significant)
## dtl_pathways_inhibited_sig_mod4 <- dtl_pathways_inhibited_mod4 %>%
##   filter(z < -2)
## dtl_top30_inhibited_2_mod4 <- dtl_pathways_inhibited_sig_mod4[1:30,] %>%
##   ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
##   geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
##   scale_size_continuous(range = c(min(-dtl_pathways_inhibited_sig_mod4$z), max(-dtl_pathways_inhibited_sig_mod4$z)),
##                         labels = function(x) paste0("-", x)) +
##   geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
##   geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
##   theme_bw() +
##   theme(axis.text.y = element_blank(),
##         panel.grid = element_blank(),
##         axis.text.x = element_text(size = text3),
##         axis.title = element_text(size = text3),
##         axis.ticks.y = element_blank(), 
##         legend.position = c(0.9,0.2),
##         legend.background = element_blank(),
##         legend.box.background = element_rect(color = "black"),
##         legend.title = element_text(size = text2),
##         legend.text = element_text(size = text2),
##         title = element_text (size = text3)) +
##   labs(x = "-log(p-value)",
##        y = "Pathways",
##        color = "Scenario",
##        size = "Z-score",
##        title = "DTL Top Inhibited Pathways (Z < -2)")   +
##   scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
##   scale_color_manual(values = scenario_colors)  +
##   scale_y_discrete(expand = expansion(mult = c(0.5, 0.01))) 
## 
## ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/dtl_top_inhibited_pathways_2_mod4.jpeg",
##        width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F, eval = F}
dtl_pathways_activated_mod4 <- dtl_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

dtl_pathways_activated_mod4$pathway <- reorder(dtl_pathways_activated_mod4$pathway, dtl_pathways_activated_mod4$neg_log_p)
  
dtl_top30_activated_mod4 <- dtl_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.03) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_dtl_pathways_activated_mod4 <- dtl_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/dtl_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
dtl_pathways_activated_sig_mod4 <- dtl_pathways_activated_mod4 %>%
  filter(z > 2)
dtl_top30_activated_2_mod4 <- dtl_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(dtl_pathways_activated_sig_mod4$z), max(dtl_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "DTL Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 4), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.05, 0.05))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/dtl_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, eval = F}
## z-scores in bar charts
dtl_neg_pathways_merged_long_mod4 <- dtl_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_neg_pathways_merged_long_mod4$name <- factor(dtl_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/dtl_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

dtl_pos_pathways_merged_long_mod4 <- dtl_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
dtl_pos_pathways_merged_long_mod4$name <- factor(dtl_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

dtl_pos_pathways_merged_long_mod4
dtl_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "DTL Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/dtl_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

### FIB/VSMC/P

```{r echo = F}
fibvsmcp_pathways_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/fibvsmcp_DiD_pathways_4.xls", skip = 1) 
fibvsmcp_dapa_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/fibvsmcp_dapa_pathways_4.xls", skip = 1) 
fibvsmcp_placebo_mod4 <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/IPA/4 No nested visit and no zero inflation/fibvsmcp_placebo_pathways_4.xls", skip = 1) 

colnames(fibvsmcp_pathways_mod4) <- c("pathway", "neg_log_p", "ratio", "z", "genes")
colnames(fibvsmcp_dapa_mod4) <- c("pathway", "neg_log_p_dapa", "ratio_dapa", "z_dapa", "genes_dapa")
colnames(fibvsmcp_placebo_mod4) <- c("pathway", "neg_log_p_placebo", "ratio_placebo", "z_placebo", "genes_placebo")

fibvsmcp_pathways_merged_mod4 <- fibvsmcp_pathways_mod4 %>%
  full_join(fibvsmcp_dapa_mod4) %>% full_join(fibvsmcp_placebo_mod4) %>%
  dplyr::select(pathway, neg_log_p, z, neg_log_p_dapa, z_dapa, neg_log_p_placebo, z_placebo) %>%
  mutate(scenario = case_when(
    z_dapa > 0 & z_placebo > 0 & z_placebo < z_dapa ~ "Activated in both, more in D",
    z_dapa > 0 & z_placebo > 0 & z_placebo > z_dapa ~ "Activated in both, less in D",
    z_dapa > 0 & (z_placebo < 0  | z_placebo == 0) ~ "Activated in D, stable/inhibited in P",
    z_dapa < 0 & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo < z_dapa ~ "Inhibited in both, less in D",
    z_dapa < 0 & z_placebo < 0 & z_placebo > z_dapa ~ "Inhibited in both, more in D",
    (z_dapa == 0) & z_placebo > 0 ~ "Activated in P, stable/inhibited in D",
    (z_dapa == 0) & z_placebo < 0 ~ "Stable in D, inhibited in P",
    z_dapa < 0 & (z_placebo == 0) ~ "Stable in P, inhibited in D"))

fibvsmcp_pathways_merged_mod4$scenario <- factor(fibvsmcp_pathways_merged_mod4$scenario,
                                      levels = c("Activated in D, stable/inhibited in P","Activated in both, more in D",
                                                 "Stable in D, inhibited in P","Inhibited in both, less in D",
                                                 "Activated in P, stable/inhibited in D","Activated in both, less in D",
                                                 "Stable in P, inhibited in D", "Inhibited in both, more in D"))
```

#### Inhibited Pathways
```{r echo = F}
fibvsmcp_pathways_inhibited_mod4 <- fibvsmcp_pathways_merged_mod4 %>%
  filter(z < 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_inhibited_mod4$pathway <- reorder(fibvsmcp_pathways_inhibited_mod4$pathway, fibvsmcp_pathways_inhibited_mod4$neg_log_p)
  
fibvsmcp_top30_inhibited_mod4 <- fibvsmcp_pathways_inhibited_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Inhibited Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_inhibited_mod4 <- fibvsmcp_pathways_inhibited_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/fibvsmcp_top30_inhibited_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z < -2
fibvsmcp_pathways_inhibited_sig_mod4 <- fibvsmcp_pathways_inhibited_mod4 %>%
  filter(z < -2)
fibvsmcp_top30_inhibited_2_mod4 <- fibvsmcp_pathways_inhibited_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(-fibvsmcp_pathways_inhibited_sig_mod4$z), max(-fibvsmcp_pathways_inhibited_sig_mod4$z)),
                        labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.01) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Inhibited Pathways (Z < -2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors)  +
  scale_y_discrete(expand = expansion(mult = c(0.3, 0))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/fibvsmcp_top_inhibited_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Activated Pathways
```{r echo = F}
fibvsmcp_pathways_activated_mod4 <- fibvsmcp_pathways_merged_mod4 %>%
  filter(z > 0) %>%
  arrange(dplyr::desc(neg_log_p))

fibvsmcp_pathways_activated_mod4$pathway <- reorder(fibvsmcp_pathways_activated_mod4$pathway, fibvsmcp_pathways_activated_mod4$neg_log_p)
  
fibvsmcp_top30_activated_mod4 <- fibvsmcp_pathways_activated_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(0,10),labels = function(x) paste0("-", x)) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top 30 Activated Pathways")   +
  scale_x_continuous(limits = c(0, 3), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(add = 1)) 
n_fibvsmcp_pathways_activated_mod4 <- fibvsmcp_pathways_activated_mod4 %>%
  filter(neg_log_p > -log10(0.05)) %>%
  nrow()

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/fibvsmcp_top30_activated_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)

########### Limited to z > 2
fibvsmcp_pathways_activated_sig_mod4 <- fibvsmcp_pathways_activated_mod4 %>%
  filter(z > 2)
fibvsmcp_top30_activated_2_mod4 <- fibvsmcp_pathways_activated_sig_mod4[1:30,] %>%
  ggplot(aes(x = neg_log_p, y = pathway, label = pathway)) +
  geom_point(aes(size = abs(z), color = scenario), alpha = 0.8) +
  scale_size_continuous(range = c(min(fibvsmcp_pathways_activated_sig_mod4$z), max(fibvsmcp_pathways_activated_sig_mod4$z))) +
  geom_vline(xintercept = -log10(0.05), linetype = "dashed") +
  geom_text(aes(group = pathway, color = scenario), hjust = 0, size = text1, nudge_x = 0.02) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        panel.grid = element_blank(),
        axis.text.x = element_text(size = text3),
        axis.title = element_text(size = text3),
        axis.ticks.y = element_blank(), 
        legend.position = c(0.9,0.2),
        legend.background = element_blank(),
        legend.box.background = element_rect(color = "black"),
        legend.title = element_text(size = text2),
        legend.text = element_text(size = text2),
        title = element_text (size = text3)) +
  labs(x = "-log(p-value)",
       y = "Pathways",
       color = "Scenario",
       size = "Z-score",
       title = "FIB/VSMC/P Top Activated Pathways (Z > 2)")   +
  scale_x_continuous(limits = c(0, 1.5), expand = c(0, 0)) +
  scale_color_manual(values = scenario_colors) +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.025))) 

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/fibvsmcp_top_activated_pathways_2_mod4.jpeg",
       width = 27.5, height = 10, scale = 1)
```

#### Z-Score Bar charts
```{r echo = F, warning = F}
## z-scores in bar charts
fibvsmcp_neg_pathways_merged_long_mod4 <- fibvsmcp_pathways_merged_mod4 %>% 
  filter(z < 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_neg_pathways_merged_long_mod4$name <- factor(fibvsmcp_neg_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_neg_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 12, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Inhibited Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")
ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/fibvsmcp_top10_inhibited_pathway_zscores_mod4.jpeg",
       scale = 1.5)

fibvsmcp_pos_pathways_merged_long_mod4 <- fibvsmcp_pathways_merged_mod4 %>% 
  filter(z > 0) %>%
  head(10) %>%
  pivot_longer(cols = c("z", "z_dapa", "z_placebo")) %>%
  mutate(name = case_when(name == "z" ~ "DiD",
                          name == "z_dapa" ~ "Dapagliflozin",
                          name == "z_placebo" ~ "Placebo"),
         w = case_when(name == "DiD" ~ 0.5,
                       name == "Dapagliflozin" ~ 0.3,
                       name == "Placebo" ~ 0.3),
         a = case_when(name == "DiD" ~ 0.7,
                       name == "Dapagliflozin" ~ 0.8,
                       name == "Placebo" ~ 0.8))
fibvsmcp_pos_pathways_merged_long_mod4$name <- factor(fibvsmcp_pos_pathways_merged_long_mod4$name, levels = c("DiD", "Placebo", "Dapagliflozin"))

fibvsmcp_pos_pathways_merged_long_mod4
fibvsmcp_pos_pathways_merged_long_mod4 %>%
  mutate(pathway = factor(pathway, levels = unique(pathway))) %>%
  ggplot(aes(x = pathway, y = value, fill = name)) +
  geom_bar(stat = "identity", position = "identity",
           aes(width=w, alpha = a)) +
  scale_alpha_continuous(range = c(0.7, 0.8)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.grid = element_blank(),
        axis.text.y = element_text(size = 12),
        legend.text = element_text(size = 12),
        plot.margin = margin(10, 10, 10, 10, unit = "pt")) +
  scale_fill_manual(values = c("Placebo" = "#f28482",
                               "Dapagliflozin" = "#669bbc",
                               "DiD" = "#bb8588")) +
  labs(y = "Z-score",
      x = NULL,
      fill = "Treatment",
      title = "FIB/VSMC/P Top 10 Activated Pathways") +
  guides(alpha = "none") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgray")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Z score bar plots/4 No nested visit and no zero inflation/fibvsmcp_top10_activated_pathway_zscores_mod4.jpeg",
       scale = 1.5)
```

# Model comparison

* Model 1: Nested visit, zero inflation

* Model 2: No nested visit, zero inflation

* Model 3: Nested visit, no zero inflation

* Model 4: No nested visit, no zero inflation

```{r echo = F}
## PT
pt_nc <- c(pt_nonconverged_percentage_mod1,
           pt_nonconverged_percentage_mod2,
           pt_nonconverged_percentage_mod3,
           pt_nonconverged_percentage_mod4)
```


```{r echo = F}
## TAL
tal_nc <- c(tal_nonconverged_percentage_mod1,
            tal_nonconverged_percentage_mod2,
            tal_nonconverged_percentage_mod3,
            tal_nonconverged_percentage_mod4)
```

```{r echo = F}
## PC
pc_nc <- c(pc_nonconverged_percentage_mod1,
           pc_nonconverged_percentage_mod2,
           pc_nonconverged_percentage_mod3,
           pc_nonconverged_percentage_mod4)
```

```{r echo = F}
## Immune
immune_nc <- c(immune_nonconverged_percentage_mod1,
               immune_nonconverged_percentage_mod2,
               immune_nonconverged_percentage_mod3,
               immune_nonconverged_percentage_mod4)
```

```{r echo = F}
## IC
ic_nc <- c(ic_nonconverged_percentage_mod1,
           ic_nonconverged_percentage_mod2,
           ic_nonconverged_percentage_mod3,
           ic_nonconverged_percentage_mod4)

```

```{r echo = F}
## EC
ec_nc <- c(ec_nonconverged_percentage_mod1,
           ec_nonconverged_percentage_mod2,
           ec_nonconverged_percentage_mod3,
           ec_nonconverged_percentage_mod4)
```

```{r echo = F}
## FIB/VSMC/P
fibvsmcp_nc <- c(fibvsmcp_nonconverged_percentage_mod1,
                 fibvsmcp_nonconverged_percentage_mod2,
                 fibvsmcp_nonconverged_percentage_mod3,
                 fibvsmcp_nonconverged_percentage_mod4)
```


```{r echo = F}
mods <- c("Model 1 (Nested Visit, ZIF)",
             "Model 2 (No nested visit, ZIF)",
             "Model 3 (Nested visit, no ZIF)",
             "Model 4 (No nested visit, no ZIF)")
mods_df <- data.frame(mods, pt_nc, tal_nc, pc_nc, immune_nc, ic_nc, ec_nc, fibvsmcp_nc)
colnames(mods_df) <- c("Model", "PT", "TAL", "PC", "Immune", "IC", "EC", "FIB, VSMC/P")
kable(mods_df, digits = 2)
```

```{r echo = F}
prefixes <- c("pt", "tal", "pc", "ic", "ec", "fibvsmcp", "immune")
mods <- paste0("mod", 1:4)

base_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/model comparison/"

for (prefix in prefixes) {
  for (mod in mods) {
    obj_name <- paste0(prefix, "_nonconverged_genes_", mod)
    save_path <- file.path(base_path, paste0(obj_name, ".rds"))
    saveRDS(get(obj_name), file = save_path)
  }
}
```

```{r echo = F}
sheet_list <- list()  # Store all data frames here
mods <- paste0("mod", 3:4)
for (prefix in prefixes) {
  for (mod in mods) {
    # Construct the name of the data frame (e.g., pt_emmeans_diff_DiD_mod3)
    df_name <- paste0(prefix, "_emmeans_diff_DiD_", mod)
    
    # Check if the data frame exists
    if (exists(df_name)) {
      df <- get(df_name)
      
      # Positive top 20
      pos_top20 <- df %>%
        arrange(`Expr p-value`) %>%
        filter(`Expr Other` > 0) %>%
        head(20)
      
      sheet_name_pos <- paste0(toupper(prefix), "_", mod, "_POS_Top20")
      sheet_list[[sheet_name_pos]] <- pos_top20
      
      # Negative top 20
      neg_top20 <- df %>%
        arrange((`Expr p-value`)) %>%
        filter(`Expr Other` < 0) %>%
        head(20)
      
      sheet_name_neg <- paste0(toupper(prefix), "_", mod, "_NEG_Top20")
      sheet_list[[sheet_name_neg]] <- neg_top20
    }
  }
}

# Write all to an Excel file
library(writexl)

write_xlsx(sheet_list, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Data Clean/model comparison/DiD_Top20_By_CellType_Mod.xlsx")
```

# Overlap
```{r echo = F}
gsea_bg <- c("kegg_legacy", "reactome", "go")
prefixes <- c("pt", "tal", "pc", "ic", "ec", "fibvsmcp", "immune")
mod34 <- c("mod3", "mod4")
# Loop through gsea backgrounds and combine results
combined_results <- list()

for (bg in gsea_bg) {
  temp_list <- list()
  
  for (prefix in prefixes) {
    for (mod in mod34) {
      df_name <- paste0(bg, "_res_", prefix, "_", mod)
      
      if (exists(df_name)) {
        df <- get(df_name)
        
        # Add metadata columns for tracking
        df$prefix <- prefix
        df$mod <- mod
        
        temp_list[[df_name]] <- df
      }
    }
  }
  
  # Combine all data frames for the current gsea background
  combined_results[[bg]] <- bind_rows(temp_list)
}

kegg_legacy_all <- combined_results[["kegg_legacy"]]
reactome_all    <- combined_results[["reactome"]]
go_all          <- combined_results[["go"]]
```

## KEGG

```{r echo = F}
# model 3 GSEA significant (p < 0.05) overlap
kegg_matrix_mod3 <- kegg_legacy_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(kegg_matrix_mod3, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_kegg_mod3 <- kegg_legacy_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_kegg_mod3 <- common_pathways_kegg_mod3 %>%
  left_join(kegg_matrix_mod3) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()

# model 4 GSEA significant (p < 0.05) overlap
kegg_matrix_mod4 <- kegg_legacy_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(kegg_matrix_mod4, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_kegg_mod4 <- kegg_legacy_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_kegg_mod4 <- common_pathways_kegg_mod4 %>%
  left_join(kegg_matrix_mod4) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()
```
## REACTOME

```{r echo = F}
# model 3 GSEA significant (p < 0.05) overlap
reactome_matrix_mod3 <- reactome_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(reactome_matrix_mod3, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_reactome_mod3 <- reactome_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_reactome_mod3 <- common_pathways_reactome_mod3 %>%
  left_join(reactome_matrix_mod3) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()

# model 4 GSEA significant (p < 0.05) overlap
reactome_matrix_mod4 <- reactome_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(reactome_matrix_mod4, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_reactome_mod4 <- reactome_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_reactome_mod4 <- common_pathways_reactome_mod4 %>%
  left_join(reactome_matrix_mod4) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()
```

## GO

```{r echo = F}
# model 3 GSEA significant (p < 0.05) overlap
go_matrix_mod3 <- go_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(go_matrix_mod3, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_go_mod3 <- go_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod3") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_go_mod3 <- common_pathways_go_mod3 %>%
  left_join(go_matrix_mod3) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()

# model 4 GSEA significant (p < 0.05) overlap
go_matrix_mod4 <- go_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  dplyr::select(pathway, prefix) %>%
  distinct() %>%
  mutate(present = 1) %>%
  pivot_wider(names_from = prefix, values_from = present, values_fill = 0)
upset(go_matrix_mod4, 
      intersect = prefixes,
      name = "Significant Pathway Presence",
      base_annotations=list('Intersection size'=intersection_size(text_angles = c(90, 0))),
      width_ratio = 0.15)

common_pathways_go_mod4 <- go_all %>%
  filter(pval < 0.05) %>%
  filter(mod == "mod4") %>%
  group_by(pathway) %>%
  summarize(n_prefixes = n_distinct(prefix), .groups = "drop") %>%
  filter(n_prefixes > 1) %>% 
  arrange(desc(n_prefixes))
common_pathways_go_mod4 <- common_pathways_go_mod4 %>%
  left_join(go_matrix_mod4) %>%
  rowwise() %>%
  mutate(shared_prefixes = paste0("(", toupper(prefixes)[c_across(all_of(prefixes)) == 1], ")", collapse = "")) %>%
  ungroup()
```



## Rerun figures for GSEA (fgsea) with overlap information
### Model 3
#### PT
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pt_mod3_overlap <- kegg_legacy_res_pt_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_pt_mod3_overlap, title = "Model 3 PT Top 30 KEGG", xnudge = 0.03)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pt_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_pt_mod3_overlap <- reactome_res_pt_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_pt_mod3_overlap, title = "Model 3 PT Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pt_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### GO
```{r echo = F}
go_res_pt_mod3_overlap <- go_res_pt_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_pt_mod3_overlap, title = "Model 3 PT Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pt_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

#### TAL
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_tal_mod3_overlap <- kegg_legacy_res_tal_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_tal_mod3_overlap, title = "Model 3 TAL Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_tal_mod3_overlap <- reactome_res_tal_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_tal_mod3_overlap, title = "Model 3 TAL Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_tal_mod3_overlap <- go_res_tal_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_tal_mod3_overlap, title = "Model 3 TAL Top 30 GO", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/tal_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### PC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pc_mod3_overlap <- kegg_legacy_res_pc_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(kegg_legacy_res_pc_mod3_overlap, title = "Model 3 PC Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_pc_mod3_overlap <- reactome_res_pc_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_pc_mod3_overlap, title = "Model 3 PC Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_pc_mod3_overlap <- go_res_pc_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_pc_mod3_overlap, title = "Model 3 PC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/pc_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### Immune (very few cells)
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_mod3_overlap <- kegg_legacy_res_immune_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(kegg_legacy_res_immune_mod3_overlap, title = "Model 3 Immune Top 30 KEGG", xlim= 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_immune_mod3_overlap <- reactome_res_immune_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_immune_mod3_overlap, title = "Model 3 Immune Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_immune_mod3_overlap <- go_res_immune_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_immune_mod3_overlap, title = "Model 3 Immune Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/immune_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### IC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ic_mod3_overlap <- kegg_legacy_res_ic_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(kegg_legacy_res_ic_mod3_overlap, title = "Model 3 IC Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_ic_mod3_overlap <- reactome_res_ic_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_ic_mod3_overlap, title = "Model 3 IC Top 30 REACTOME", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_ic_mod3_overlap <- go_res_ic_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_ic_mod3_overlap, title = "Model 3 IC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ic_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### EC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ec_mod3_overlap <- kegg_legacy_res_ec_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(kegg_legacy_res_ec_mod3_overlap, title = "Model 3 EC Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_ec_mod3_overlap <- reactome_res_ec_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_ec_mod3_overlap, title = "Model 3 EC Top 30 REACTOME", xlimit = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_ec_mod3_overlap <- go_res_ec_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_ec_mod3_overlap, title = "Model 3 EC Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/ec_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### FIB/VSMC/P
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_fibvsmcp_mod3_overlap <- kegg_legacy_res_fibvsmcp_mod3 %>%
  left_join(common_pathways_kegg_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(kegg_legacy_res_fibvsmcp_mod3_overlap, title = "Model 3 FIB/VSMC/P Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_kegg_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_fibvsmcp_mod3_overlap <- reactome_res_fibvsmcp_mod3 %>%
  left_join(common_pathways_reactome_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_fibvsmcp_mod3_overlap, title = "Model 3 FIB/VSMC/P Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_reactome_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_fibvsmcp_mod3_overlap <- go_res_fibvsmcp_mod3 %>%
  left_join(common_pathways_go_mod3) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_fibvsmcp_mod3_overlap, title = "Model 3 FIB/VSMC/P Top 30 GO", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/3 Nested visit and no zero inflation/gsea/fibvsmcp_top30_go_pathways_mod3.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### Model 4
#### PT
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pt_mod4_overlap <- kegg_legacy_res_pt_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_pt_mod4_overlap, title = "Model 4 PT Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_pt_mod4_overlap <- reactome_res_pt_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(reactome_res_pt_mod4_overlap, title = "Model 4 PT Top 30 REACTOME", xlimit = 6)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_pt_mod4_overlap <- go_res_pt_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(go_res_pt_mod4_overlap, title = "Model 4 PT Top 30 GO", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pt_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
### TAL
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_tal_mod4_overlap <- kegg_legacy_res_tal_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_tal_mod4_overlap, title = "Model 4 TAL Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_tal_mod4_overlap <- reactome_res_tal_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_tal_mod4_overlap, title = "Model 4 TAL Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_tal_mod4_overlap <- go_res_tal_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_tal_mod4_overlap, title = "Model 4 TAL Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/tal_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### PC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_pc_mod4_overlap <- kegg_legacy_res_pc_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_pc_mod4_overlap, title = "Model 4 PC Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_pc_mod4_overlap <- reactome_res_pc_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_pc_mod4_overlap, title = "Model 4 PC Top 30 REACTOME", xlimit = 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_pc_mod4_overlap <- go_res_pc_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_pc_mod4_overlap, title = "Model 4 PC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/pc_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### Immune (very few cells)
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_immune_mod4_overlap <- kegg_legacy_res_immune_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_immune_mod4_overlap, title = "Model 4 Immune Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_immune_mod4_overlap <- reactome_res_immune_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_immune_mod4_overlap, title = "Model 4 Immune Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_immune_mod4_overlap <- go_res_immune_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_immune_mod4_overlap, title = "Model 4 Immune Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/immune_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

### IC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ic_mod4_overlap <- kegg_legacy_res_ic_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_ic_mod4_overlap, title = "Model 4 IC Top 30 KEGG", xlim= 4)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_ic_mod4_overlap <- reactome_res_ic_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_ic_mod4_overlap, title = "Model 4 IC Top 30 REACTOME", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_ic_mod4_overlap <- go_res_ic_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_ic_mod4_overlap, title = "Model 4 IC Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ic_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### EC
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_ec_mod4_overlap <- kegg_legacy_res_ec_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_ec_mod4_overlap, title = "Model 4 EC Top 30 KEGG", xlim= 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_ec_mod4_overlap <- reactome_res_ec_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_ec_mod4_overlap, title = "Model 4 EC Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_ec_mod4_overlap <- go_res_ec_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_ec_mod4_overlap, title = "Model 4 EC Top 30 GO", xlimit = 7)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/ec_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```


### FIB/VSMC/P
##### KEGG Legacy
```{r echo = F}
kegg_legacy_res_fibvsmcp_mod4_overlap <- kegg_legacy_res_fibvsmcp_mod4 %>%
  left_join(common_pathways_kegg_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))

plot_fgsea(kegg_legacy_res_fibvsmcp_mod4_overlap, title = "Model 4 FIB/VSMC/P Top 30 KEGG", xlim= 3)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_kegg_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```

##### REACTOME
```{r echo = F}
reactome_res_fibvsmcp_mod4_overlap <- reactome_res_fibvsmcp_mod4 %>%
  left_join(common_pathways_reactome_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(reactome_res_fibvsmcp_mod4_overlap, title = "Model 4 FIB/VSMC/P Top 30 REACTOME", xlimit = 5)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_reactome_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
##### GO
```{r echo = F}
go_res_fibvsmcp_mod4_overlap <- go_res_fibvsmcp_mod4 %>%
  left_join(common_pathways_go_mod4) %>%
  mutate(face = case_when(is.na(n_prefixes) ~ "plain",
                          T ~ "bold"),
         pathway = case_when(!is.na(n_prefixes) ~ paste0(pathway, " ", shared_prefixes),
                             T~ pathway))
plot_fgsea(go_res_fibvsmcp_mod4_overlap, title = "Model 4 FIB/VSMC/P Top 30 GO", xlimit = 8)

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Pathways/4 No nested visit and no zero inflation/gsea/fibvsmcp_top30_go_pathways_mod4.jpeg",
       width = 27.5, height = 14, scale = 1)
```
# Model 3 and 4 comparison
```{r echo = F}


```