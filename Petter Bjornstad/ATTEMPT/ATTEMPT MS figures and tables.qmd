---
title: "ATTEMPT MS figures and tables"
author: "Ye Ji Choi"
format:
  docx:
    reference-doc: custom-reference.docx
    fig-cap-location: top
    tbl-cap-location: top
execute:
  echo: false
  warning: false
  message: false
---

```{r echo = F}
library(dplyr)
library(tidyr)
library(knitr)
library(patchwork)
library(magick)
library(ggplot2)
library(purrr)
library(Hmisc)
library(jsonlite)
library(aws.s3)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(lmerTest)
library(emmeans)
library(broom)
library(ggbeeswarm)
library(lemon)
library(quantreg)
library(arsenal)
library(ggpubr)
library(magick)
library(ggrounded)
```

```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```


```{r echo = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else {
  stop("Unknown user: please specify root path for this user.")
}

base_path <- paste0(root_path, "/ATTEMPT/Results/Figures")
source(file.path(git_path, "Resources/YC/R Functions/correlation_function.R"))
source(file.path(git_path, "ATTEMPT/attempt_functions.R"))
```


```{r echo = F}
attempt_dat <- s3readRDS(object = "cleaned_data/attempt_dat.rds", bucket = "attempt", region = "")

delta_df <- s3readRDS(object = "cleaned_data/attempt_delta_df.rds", bucket = "attempt", region = "")

table_labs <- list(
  age = "Age (years)",
  sex = "Sex",
  weight = "Weight (kg)",
  height = "Height (cm)",
  bmi = "BMI (kg/m²)",
  hba1c = "HbA1c (%)",
  emu_urine_acr_mean = "Urine ACR (mg/g)",
  creatinine_s = "Serum creatinine (mg/dL)",
  cystatin_c_s = "Serum cystatin C (mg/L)",
  albumin_serum_gl = "Serum albumin (g/L)",
  cgm_tir = "CGM time in range (%)",
  diabetes_dx_duration = "Diabetes duration (years)",
  sbp = "Systolic BP (mmHg)",
  dbp = "Diastolic BP (mmHg)",
  cholesterol_serum_mmoll = "Total cholesterol (mmol/L)",
  triglycerides_serum_mmoll = "Triglycerides (mmol/L)",
  pulse = "Pulse (bpm)",
  ldl_serum_mmoll = "LDL cholesterol (mmol/L)",
  hdl_serum_mmoll = "HDL cholesterol (mmol/L)",
  mgfr_jodal_bsa = "mGFR BSA-adjusted (mL/min/1.73m²)",
  mgfr_jodal = "mGFR (mL/min)",
  mri_r2_cortex_l = "MRI R2* left cortex",
  mri_r2_cortex_r = "MRI R2* right cortex",
  avg_c_r2 = "Cortical R2*",
  mri_r2_kidney_l = "MRI R2* left kidney",
  mri_r2_kidney_r = "MRI R2* right kidney",
  avg_k_r2 = "Kidney R2*"
)

# Apply labels to your data
for(var in names(table_labs)) {
  if(var %in% names(attempt_dat)) {
    label(attempt_dat[[var]]) <- table_labs[[var]]
  }
}

table_controls <-tableby.control(
  total = FALSE,
  numeric.stats = c("meansd"),
  cat.stats = c("countpct"),
  digits = 1, 
  numeric.simplify = T
)

# List of variables to copy
vars_to_copy <- c('mgfr_jodal_bsa', 'mgfr_jodal', 'mri_r2_cortex_l', 
                  'mri_r2_cortex_r', 'avg_c_r2', 'mri_r2_kidney_l', 
                  'mri_r2_kidney_r', 'avg_k_r2')

# Get values from visit -4
visit_minus4_values <- attempt_dat[attempt_dat$visit == -4, c('subject_id', vars_to_copy)]

# For each subject, copy their visit -4 values to visit 0
for(subject in unique(visit_minus4_values$subject_id)) {
  # Get the values for this subject at visit -4
  patient_values <- visit_minus4_values[visit_minus4_values$subject_id == subject, vars_to_copy]
  
  # Update visit 0 for this subject
  for(var in vars_to_copy) {
    attempt_dat[attempt_dat$subject_id == subject & attempt_dat$visit == 0, var] <- patient_values[[var]]
  }
}
```

```{r include = F}
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC"),
  IC = c("IC-A", "IC-B", "aIC"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK"),
  Immune_myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_lymphoid = c("CD4+ T", "CD8+ T", "B", "NK"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD"
)

## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT

# Top 2000 HVG
for (cell in names(celltype_groups))  {
  input_path <- paste0("grouped/", cell, "/HVG/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)

    # Join annotation
  annotated_df <- processed$results

  # Assign to variable dynamically
  var_name <- paste0(tolower(cell), "_hvg_kpmp")
  assign(var_name, annotated_df, envir = .GlobalEnv)
  
  write.csv(annotated_df, paste0("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/nebula/", tolower(cell), "_kpmp_hvg_res.csv"), row.names = F)
}

# Top 2000 HVG subtypes
for (cell in unlist(celltype_groups))  {
  print(paste0("Processing: ", cell))
  cell <- gsub("/", "_", cell)
  input_path <- paste0("individual/", cell, "/HVG/nebula/individual_", 
                       tolower(cell),
                       "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")
  
  processed <- process_nebula_results(cell_df)
  
  # Check if processed results has 0 rows
  if (nrow(processed$results) == 0) {
    print(paste0("Skipping ", cell, " - no rows in processed results"))
    next
  }
  
  annotated_df <- processed$results 
  cell <- gsub("-", "_", cell)
  cell <- gsub("\\+\\s", "_", cell)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_hvg_kpmp")
  print(var_name)
  assign(var_name, processed$results)
  
  var_name <- paste0(lower_cell, "_hvg_kpmp_cov")
  assign(var_name, processed$overdispersion)
}

# Full gene set
for (cell in names(celltype_groups))  {
print(paste0("Processing: ", cell))
  input_path <- paste0("grouped/", cell, "/ALL/nebula/", "grouped_", tolower(cell), "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_kpmp")

  assign(var_name, processed$results)
}

# Full gene set subtypes
for (cell in unlist(celltype_groups))  {
print(paste0("Processing: ", cell))
  cell <- gsub("/", "_", cell)
  input_path <- paste0("individual/", cell, "/ALL/nebula/individual_",
                       tolower(cell),
                       "_kpmp_attempt_nebula_res_reml_pooled.rds")
  cell_df <- s3readRDS(input_path, bucket = "attempt", region = "")

  processed <- process_nebula_results(cell_df)
  cell <- gsub("-", "_", cell)
  lower_cell <- tolower(cell)
  var_name <- paste0(lower_cell, "_kpmp")

  assign(var_name, processed$results)
}

clin_vars <- c("mgfr_jodal_delta", "mgfr_jodal_bsa_delta", "tir_delta", 
               "hba1c_delta", "weight_delta", "avg_c_r2_delta", "avg_k_r2_delta",
               "avg_ketones_delta")

## read mixed model results dataframe (rendered in Hyak)
# process and read all results from ATTEMPT
# mart <- useMart("ensembl", dataset = "hsapiens_gene_ensembl") # to join full name description

# Top 2000 HVG
for (cell in names(celltype_groups))  {
  for(var in clin_vars) {
    print(paste0("Processing: ", cell, " - ", var))
    processed <- process_nebula_results_clin(cell_type = cell, clinical_var = var, 
                                             cell_subtype = celltype_groups[[cell]])
    # Get gene symbols
    # gene_symbols <- processed$results$Gene
    # 
    # # Query Ensembl
    # gene_info <- getBM(
    #   attributes = c("hgnc_symbol", "description", "gene_biotype"),
    #   filters = "hgnc_symbol",
    #   values = gene_symbols,
    #   mart = mart
    # ) %>%
    #   dplyr::rename(Gene = hgnc_symbol)
    
    # Join annotation
    annotated_df <- processed$results 
    # %>%
    #   left_join(gene_info, by = "Gene")
    
    # Assign to variable dynamically
    var_name <- paste0(tolower(cell), "_", var, "_hvg_kpmp")
    assign(var_name, annotated_df, envir = .GlobalEnv)
  }
}

clinical_directions <- data.frame(variable = 
                                    c("mgfr_jodal", "mgfr_jodal_bsa", 
                                      "tir","hba1c", "weight", 
                                      "avg_c_r2", "avg_k_r2", "avg_ketones"),
                                  direction = 
                                    c("-", "-", 
                                      "+", "-", "-", 
                                      "+","+", "+"))
```

# Tables

## Section 2A

```{r echo = F}
#| label: tbl-full-baseline
#| tbl-cap: "Participant characteristics at baseline."

kable(summary(arsenal::tableby(
  treatment ~ 
    age + 
    sex + 
    weight + 
    height + 
    bmi + 
    hba1c + 
    kwt(emu_urine_acr_mean, "medianq1q3") + 
    creatinine_s + 
    cystatin_c_s + 
    albumin_serum_gl + 
    cgm_tir + 
    diabetes_dx_duration + 
    sbp + 
    dbp + 
    cholesterol_serum_mmoll + 
    triglycerides_serum_mmoll + 
    pulse + 
    ldl_serum_mmoll + 
    hdl_serum_mmoll +
     mgfr_jodal_bsa + mgfr_jodal + avg_c_r2 + avg_k_r2, 
  data = subset(attempt_dat, visit == 0),
  control = table_controls
)), digits = 1)

```

```{r echo = F}
#| label: tbl-co-baseline
#| tbl-cap: "Participant characteristics at baseline in CO"

kable(summary(arsenal::tableby(
  treatment ~ 
    age + 
    sex + 
    weight + 
    height + 
    bmi + 
    hba1c + 
    kwt(emu_urine_acr_mean, "medianq1q3") + 
    creatinine_s + 
    cystatin_c_s + 
    albumin_serum_gl + 
    cgm_tir + 
    diabetes_dx_duration + 
    sbp + 
    dbp + 
    cholesterol_serum_mmoll + 
    triglycerides_serum_mmoll + 
    pulse + 
    ldl_serum_mmoll + 
    hdl_serum_mmoll +
     mgfr_jodal_bsa + mgfr_jodal + avg_c_r2 + avg_k_r2, 
  data = subset(attempt_dat, visit == 0 & site == "Denver"),
  control = table_controls
)), digits = 1)
```

## Section 2D

```{r}
#| label: tbl-histology
#| tbl-cap: "Qualitative histology assessment of baseline kidney biopsies. Data provided by Jeff - placeholder for final analysis"

# Minimal placeholder
placeholder_df <- data.frame(
  Placeholder = "[Table to be inserted]"
)

kable(placeholder_df, 
      col.names = NULL,
      align = "c")
```


Table: Cell type groupings. {#tbl-cell-type-groupings}

| General type        | KPMP Sub type                                  |
|---------------------|------------------------------------------------|
| PT                  | PT-S1/S2, PT-S3, aPT                           |
| TAL                 | C-TAL-1, C-TAL-2, aTAL, dTAL                   |
| PC                  | CCD-PC, CNT-PC, dCCD-PC, M-PC, tPC-IC          |
| IC                  | IC-A, IC-B, aIC                                |
| EC                  | EC-AVR, EC-GC, EC-PTC, EC-AEA, EC-LYM, EC/VSMC |
| Immune (Myeloid)    | MAC, MON, cDC, pDC                             |
| Immune (Lymphoid)   | CD4+ T, CD8+ T, B, NK                          |
| VSMC/P, FIB         | VSMC/P, FIB                                    |
| POD                 | POD                                            |

# Figures

## Section 2A

```{r}
#| label: fig-consort
#| fig-cap: "CONSORT flow diagram showing participant enrollment, allocation, follow-up, and analysis"

knitr::include_graphics(file.path(base_path, "ATTEMPT_FU_Consort_diagram.png"))
```

## Section 2B

```{r, include = F}
# create panels
# (A) Change in mGFR by baseline mGFR
mgfr_jodal_bsa_category_bars <- plot_delta_by_category(
  data = attempt_dat,
  id_var = "subject_id",
  treatment_var = "treatment",
  value_var = "mgfr_jodal_bsa",
  visit_var = "visit",
  visit_baseline = -4,
  visit_pre = -4,
  visit_post = 16,
  bin_by_tertiles = F,
  bin_breaks = c(-Inf, 90, 110, Inf),
  bin_labels = c("<90", "90-110", "\u2265110"),
  proper_name =  "mGFR (BSA)"
) + theme(axis.text.x = element_text(angle = 60, hjust = 1))

# (B)
delta_mgfr_jodal_bsa_denver <- plot_mean_ci_stars(subset(delta_df, visit %in% c(-4,16) & site == "Denver"),
                   y_var = mgfr_jodal_bsa, 
                   y_axis_title = "\u0394 mGFR (BSA)",
                   legend_position = c(0.3,0.2),
                   visits_to_plot = c(-4, 16),
                   baseline_visit = -4,
                   covariates = "site")

# (C)
delta_hba1c_overtime_2_denver <- plot_mean_ci_stars(data = subset(delta_df, site == "Denver"), y_var = hba1c, 
                   y_axis_title = "\u0394 HbA1c (%)",
                  legend_position = c(0.3,0.2),
                  visits_to_plot = c(0, 4, 16)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.1)

# (D)
delta_tir_overtime_denver <- plot_mean_ci_stars(data = subset(delta_df, visit %in% c(0,16) & site == "Denver", test_method = "ancova"), 
                   y_var = tir, y_axis_title = "\u0394 Time in Range (%)",
                   legend_position = c(0.3,0.8),
                    visits_to_plot = c(0, 16)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.1)

ggarrange(mgfr_jodal_bsa_category_bars, delta_mgfr_jodal_bsa_denver, delta_hba1c_overtime_2_denver, delta_tir_overtime_denver, ncol=2, nrow=2, common.legend = TRUE, legend="bottom", labels = "AUTO")

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Panels/mgfr_hba1c_tir_overtime.png", width = 10, height = 7, dpi = 300)
```


```{r, out.width="100%"}
#| label: fig-mgfr-tertiles-panel
#| fig-cap: "(A) Change in mGFR by baseline mGFR in full cohort, (B) Change in mGFR over time in Colorado cohort, (C) Change in HbA1c over time in Colorado cohort, (D) Change in TIR over time in Colorado cohort"

knitr::include_graphics(file.path(base_path, "Panels/mgfr_hba1c_tir_overtime.png")) 
```

## Section 2C

```{r, include = F}
# create panels
# (A) Change in mGFR by baseline mGFR
delta_avg_k_r2_overtime <- plot_mean_ci_stars(data = delta_df, 
                   visits_to_plot = c(-4, 16), baseline_visit = -4,
                   y_var = avg_k_r2, y_axis_title = "\u0394 Kidney R2*",
                   legend_position = c(0.3,0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.1)

# (B)
avg_k_r2_category_bars <- plot_delta_by_category(
  data = attempt_dat,
  id_var = "subject_id",
  treatment_var = "treatment",
  value_var = "avg_k_r2",
  visit_var = "visit",
  visit_baseline = -4,
  visit_pre = -4,
  visit_post = 16,
  bin_by_tertiles = T,
  top_padding = 0.5,
  proper_name =  "Kidney R2*",
  output_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Plot over time/avg_k_r2_category_bars.png"
)

# (C)
avg_k_r2_by_mgfr_category_bars <- plot_delta_by_category(
  data = attempt_dat,
  id_var = "subject_id",
  treatment_var = "treatment",
  x_var = "mgfr_jodal_bsa",
  value_var = "avg_k_r2",
  visit_var = "visit",
  visit_baseline = -4,
  visit_pre = -4,
  visit_post = 16,
  bin_by_tertiles = F,
  proper_name =  "Kidney R2*",
  x_label = "\nBaseline mGFR (BSA)",
  bin_breaks = c(-Inf, 90, 110, Inf),
  bin_labels = c("<90", "90-110", "\u2265110"),
  output_path = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Plot over time/avg_k_r2_by_mgfr_category_bars.png"
) + theme(axis.text.x = element_text(angle = 60, hjust = 1))

# (D) Change in mGFR by baseline mGFR
delta_avg_k_r2_overtime_denver <- plot_mean_ci_stars(data = subset(delta_df, 
                                                                   site == "Denver"), 
                   visits_to_plot = c(-4, 16),
                   y_var = avg_k_r2, y_axis_title = "\u0394 Kidney R2*",
                   legend_position = c(0.3,0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.1)

# (E)
delta_avg_c_r2_overtime_denver <- plot_mean_ci_stars(data = subset(delta_df, 
                                                                   site == "Denver"), 
                   visits_to_plot = c(-4, 16),
                   y_var = avg_c_r2, y_axis_title = "\u0394 Cortical R2*",
                   legend_position = c(0.3,0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.1)

ggarrange(delta_avg_k_r2_overtime, NULL, avg_k_r2_category_bars, avg_k_r2_by_mgfr_category_bars,
          delta_avg_k_r2_overtime_denver, delta_avg_c_r2_overtime_denver, ncol=2, nrow=3, common.legend = TRUE, legend="bottom", labels = c("A", "", "B", "C", "D", "E"))

ggsave("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Panels/avg_k_r2_panel.png", width = 10, height = 10, dpi = 300)
```


```{r, out.width="100%"}
#| label: fig-r2star-timeline
#| fig-cap: "(A) Longitudinal changes in full cohort kidney R2* measurements over the study period, (B) Change in kidney R2* with baseline kidney R2* in full cohort. (C) Change in kidney R2* with baseline mGFR in full cohort. (D) Longitudinal changes in Colorado cohort kidney R2* measurements over the study period, and (E) cortical R2* measurements over the study period."

knitr::include_graphics(file.path(base_path, "Panels/avg_k_r2_panel.png"))
```

## Section 2E

```{r, out.width="100%", out.height = NULL}
#| label: fig-umap
#| fig-cap: "UMAP dimensionality reduction of single-cell RNA sequencing data from kidney biopsies"

knitr::include_graphics(file.path(base_path, "UMAP/attempt_umap_kpmpcelltype.png"))
```

```{r, out.width="100%"}
#| label: fig-upset
#| fig-cap: "(A) UpSet plot showing the overlap of differentially expressed genes across kidney cell types. Only intersections with size > 3 are displayed. Intersections corresponding to genes unique to a single cell type are omitted for clarity. Bars representing overlaps across ≥ 3 cell types are highlighted in blue. (B) Bar plot showing the frequency of differentially expressed genes by cell type, separated by direction of effect (DiD > 0 in red, DiD < 0 in blue). (C) Scatter plot of DiD values for each gene, grouped by cell type. Points above zero indicate positive DiD, and points below zero indicate negative DiD."
#| fig-dpi: 300

# Read images
img1 <- image_read(file.path(base_path, "Cell type comparison/celltype_deg_upset_kpmp.png"))
img2 <- image_read(file.path(base_path, "Cell type comparison/celltype_deg_stacked_barplot_kpmp.png"))
img3 <- image_read(file.path(base_path, "Cell type comparison/celltype_deg_combined_kpmp.png"))

# Convert to ggplot objects
p1 <- image_ggplot(img1)
p2 <- image_ggplot(img2)
p3 <- image_ggplot(img3)

(p1) + (p2 / p3) +
  plot_annotation(tag_levels = 'A')
```

```{r, out.width="100%"}
#| label: fig-segment-phoom
#| fig-cap: "Segmental distribution of kidney cell populations (Placeholder)"
#| fig-dpi: 300
knitr::include_graphics(file.path(base_path, "Pathways and transcripts in ATTEMPT-2.png"))
```

### Section 2E: PT cells

```{r, include = F}
pt_plots <- create_gene_expression_plots(
  main_results = pt_hvg_kpmp,
  subtype_results_list = list(
    "PT-S1/S2" = pt_s1_s2_hvg_kpmp,
    "PT-S3" = pt_s3_hvg_kpmp,
    "aPT" = apt_hvg_kpmp
  ),
  cell_type_prefix = "PT",
  cell_type_labels = c("PT-S1/S2", "PT-S3", "aPT"),
  output_prefix = "kpmp_PT_hvg",
  full_formula = T,
  volcano_text_size = 15,
  volcano_caption_size = 12,
  formula = "treatment * visit",
  output_dir = "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/ATTEMPT/Results/Figures/Dot Plots/"
)
pt_main_plot <- pt_plots$combined_plot

# clinical associations figures
pt_mgfr <- plot_volcano_concordance(pt_mgfr_jodal_bsa_delta_hvg_kpmp, 
                         "logFC_mgfr_jodal_bsa_delta", 
                         "p_mgfr_jodal_bsa_delta",
                         "logFC \u0394 mGFR (BSA)", 
                         "-log10(p-value)",
                         "nebula/kpmp_pt_mgfr_jodal_bsa_trtcolors",
                         treatment_results = pt_hvg_kpmp,
                         treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                         formula = "\u0394 mGFR (BSA) + treatment",
                         positive_text = "Positively associated with \n\u0394 mGFR (BSA)",
                         negative_text = "Negatively associated with \n\u0394 mGFR (BSA)",
                         clinical_direction = 
                           clinical_directions[clinical_directions$variable == "mgfr_jodal_bsa",]$direction, 
                         cell_type = "PT",
                         arrow_label = "mGFR\n-8.2",
                         top_n = 20)

# clinical associations figures
pt_hba1c <- plot_volcano_concordance(pt_hba1c_delta_hvg_kpmp, 
                          "logFC_hba1c_delta", 
                          "p_hba1c_delta",
                          "logFC \u0394 HbA1c", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_hba1c_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 HbA1c + treatment",
                          positive_text = "Positively associated with \n\u0394 HbA1c",
                          negative_text = "Negatively associated with \n\u0394 HbA1c",
                          clinical_direction = clinical_directions[clinical_directions$variable == "hba1c",]$direction, 
                          cell_type = "PT",
                         arrow_label = "HbA1c\n-0.47", top_n = 20)

# clinical associations figures
pt_tir <- plot_volcano_concordance(pt_tir_delta_hvg_kpmp, 
                          "logFC_tir_delta", 
                          "p_tir_delta",
                          "logFC \u0394 TIR", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_tir_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 TIR + treatment",
                          positive_text = "Positively associated with \n\u0394 TIR",
                          negative_text = "Negatively associated with \n\u0394 TIR",
                          clinical_direction = clinical_directions[clinical_directions$variable == "tir",]$direction, 
                          cell_type = "PT",
                         arrow_label = "TIR\n+9.3", top_n = 20)

# clinical associations figures
pt_avg_k_r2 <- plot_volcano_concordance(pt_avg_k_r2_delta_hvg_kpmp, 
                          "logFC_avg_k_r2_delta", 
                          "p_avg_k_r2_delta",
                          "logFC \u0394 avg kidney R2*", 
                          "-log10(p-value)",
                          "nebula/kpmp_pt_avg_k_r2_trtcolors",
                          treatment_results = pt_hvg_kpmp,
                          treatment_p_col = "p_treatmentDapagliflozin:visitPOST",
                          formula = "\u0394 avg kidney R2* + treatment",
                          positive_text = "Positively associated with \n\u0394 avg kidney R2*",
                          negative_text = "Negatively associated with \n\u0394 avg kidney R2*",
                          clinical_direction = clinical_directions[clinical_directions$variable == "avg_k_r2",]$direction, 
                          cell_type = "PT",
                         arrow_label = "Kidney R2*\n+0.50", top_n = 20)
```

```{r, out.width="100%"}
#| label: fig-pt-panel
#| fig-cap: "Proximal tubule gene expression analysis. (A) Comprehensive panel showing dot plot, volcano plot, and heatmap of differentially expressed genes. (B-E) Proximal tubule gene expression correlations with clinical outcomes. Volcano plots showing gene expression changes correlated with (B) change in mGFR, (C) change in HbA1c, (D) change in time in range, and (E) change in kidney R2*"
#| fig-dpi: 300

# Convert to ggplot objects
p1 <- pt_main_plot
p2 <- pt_mgfr
p3 <- pt_hba1c
p4 <- pt_tir
p5 <- pt_avg_k_r2

p1 / (p2 + p3) / (p4 + p5)  + 
  plot_annotation(tag_levels = 'A')
```


```{r, out.width="100%"}
#| label: fig-pt-pseudotime
#| fig-cap: "Proximal tubule pseudotime trajectory analysis. (A) PCA plot with inferred lineage trajectory. (B) Cell density distribution along pseudotime"
#| fig-dpi: 300

# Read images
img1 <- image_read(file.path(base_path, "Slingshot/attempt_pca_pt_kpmp_slingshot.png"))
img2 <- image_read(file.path(base_path, "Slingshot/attempt_pt_kpmp_slingshot_density_trtvisit.png"))

img3 <- image_read(file.path(base_path, "Slingshot/attempt_pt_kpmp_slingshot_density_trtvisit.png"))

img2 <- image_read(file.path(base_path, "Slingshot/attempt_pt_kpmp_slingshot_density_trtvisit.png"))

# Convert to ggplot objects
p1 <- image_ggplot(img1)
p2 <- image_ggplot(img2)

(p1 + p2)  + 
  plot_annotation(tag_levels = 'A')
```

```{r, out.width="100%"}
#| label: fig-pt-pseudotime-clinical
#| fig-cap: "Clinical parameter changes along proximal tubule pseudotime. Correlation of pseudotime progression with change in mGFR and change in HbA1c"
#| fig-dpi: 300

knitr::include_graphics(file.path(base_path, "Slingshot/attempt_density_pt_kpmp_hba1c_deltadelta_slingshot.png"))
```

### Section 2E: Other cell types

```{r, out.width="100%"}
#| label: fig-pod-pc-panel
#| fig-cap: "Combined analysis of podocyte and principal cell populations. Multi-panel figure showing gene expression patterns and treatment responses"
#| fig-dpi: 300

# Read images
img1 <- image_read(file.path(base_path, "Dot Plots/kpmp_pod_hvg_subtypes_nebula_scores_volcano_heat.png"))
img2 <- image_read(file.path(base_path, "Dot Plots/kpmp_PC_hvg_subtypes_nebula_scores_volcano_heat.png"))
img3 <- image_read(file.path(base_path,  "Dot Plots/kpmp_Immune_hvg_subtypes_nebula_scores_volcano_heat.png"))
img4 <- image_read(file.path(base_path,  "Dot Plots/kpmp_VSMC_P_FIB_hvg_subtypes_nebula_scores_volcano_heat.png"))

# Convert to ggplot objects
p1 <- image_ggplot(img1)
p2 <- image_ggplot(img2)
p3 <- image_ggplot(img3)
p4 <- image_ggplot(img4)

(p1 + p2) / (p3 + p4) + 
  plot_annotation(tag_levels = 'A')
```

## Section 2F

```{r, out.width="100%"}
#| label: fig-urine-proteins
#| fig-cap: "Differential abundance of urinary proteins. Volcano plot showing significantly changed proteins in urine samples following treatment"
#| fig-dpi: 300

knitr::include_graphics(file.path(base_path, "Proteomics/Volcano Plots/Volcano_DiD_urine_proteomics_adjp_mixed.png"))
```

## Section 2G

```{r, out.width="100%", out.height = NULL}
#| label: fig-croc-reversals
#| fig-cap: "CROCODILE reversal analysis. Volcano plot displaying gene expression changes associated with improved renal outcomes"
#| fig-dpi: 300

# Read images
img1 <- image_read(file.path(base_path, "CROCODILE comparison/Volcano Plots/kpmp_pt_targeted_volcano_attempt_directions_labeled.png"))
img2 <- image_read(file.path(base_path, "CROCODILE comparison/Volcano Plots/kpmp_tal_targeted_volcano_attempt_directions_labeled.png"))
img3 <- image_read(file.path(base_path, "CROCODILE comparison/Volcano Plots/kpmp_ec_targeted_volcano_attempt_directions_labeled.png"))
img4 <- image_read(file.path(base_path, "CROCODILE comparison/Volcano Plots/kpmp_ic_targeted_volcano_attempt_directions_labeled.png"))

# Convert to ggplot objects
p1 <- image_ggplot(img1)
p2 <- image_ggplot(img2)
p3 <- image_ggplot(img3)
p4 <- image_ggplot(img4)

(p1 + p2) / (p3 + p4) + 
  plot_annotation(tag_levels = 'A')
```