---
title: "Teen-LABS and IMPROVE - JAK-STAT ligands"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r libraries,echo=FALSE, include=F}
library(knitr)
library(tidyverse)
library(Hmisc)
library(readxl)
library(RColorBrewer)
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
```

```{r clean data,echo=FALSE}
# source("/Users/timvigers/GitHub/CHCO-Code/Petter Bjornstad/Teen-LABS/create_teen_labs_analysis_dataset.R")
load("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Teen Labs/Data_Cleaned/analysis_dataset.RData")
# Tim already log transformed proteins when creating dataframe


# keep only the proteins we need
analyte_igf <- analyte_info %>% filter(UniProt %in% c("P10912", "P01236", "P41159", "P60568", "P05231", "P29459|P29460",
                                                      "P29460|Q9NPF7"))
apt_keep <- analyte_igf$AptName
df_keep <- df %>% select(all_of(c("ID", "visit", apt_keep)))
df_keep <- df_keep %>% filter(visit %in% c("Month 1", "Year 1"))
df_wide <- reshape(df_keep, timevar = "visit", idvar = "ID", direction = "wide")

# not sure if I'll need this
# emmdf_keep$uniqname <- paste0(emmdf_keep$Target,"_",emmdf_keep$AptName)  

```

```{r include=FALSE}
# write a function to make each panel of the plot
panel_in_boxplot <- function(data, seq, month1var, year1var) {
  comparison_groups <- list(c("before", "after"))
  analytes_temp <- analyte_info
  analytes_temp$Target_apt <- paste0(analytes_temp$Target, " (", analytes_temp$AptName, ")")
  TA <- analytes_temp$Target_apt[match(seq, analytes_temp$AptName)]  
  before <-  data %>% select(all_of(month1var)) 
  after <-  data %>% select(all_of(year1var))
  ba <- cbind(before, after)
  complete_check <- complete.cases(ba)
  ba <- ba[complete_check,]
  before <- as.numeric(ba[,1])
  after <- as.numeric(ba[,2])
  d <- data.frame(before = before, after = after)
  p <- ggpaired(d,
        cond1 = "before", cond2 = "after",
        line.color = "grey")  +
  geom_boxplot(fill = "#fcb1a6") +  
  labs(x = NULL,
       y = TA) + 
  theme(axis.title.x = element_text(size = 16),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14,
                                   angle = 0), 
        legend.text = element_text(size = 16)) +
        #,
   #     panel.background = element_rect(fill = "#f2e9e4",
    #                                    color = "grey")) + 
  scale_fill_manual(values = c("#c2dfe3", "#fff9ec",
                                "#fcb1a6", "#fb6376")) +
  scale_x_discrete(labels = c("Month 1", "Year 1")) +
  stat_compare_means(comparisons = comparison_groups,
                     paired = TRUE,
                     method = "wilcox.test",
                     label = "p.signif", size = 4, vjust = -2) + 
  # stat_compare_means(paired = TRUE,
  #                   method = "wilcox.test",
  #                   aes(label = paste0("p",scales::label_pvalue(add_p = TRUE)(..p..)),),
  #   parse = TRUE, size = 4, vjust = -2) +  
    
  scale_y_continuous(expand = expansion(mult = c(0, 0.3)))
}

# function call for above template
p_seq.10967.12 <- panel_in_boxplot(data = df_wide, seq = "seq.10967.12", month1var = "seq.10967.12.Month 1", year1var = "seq.10967.12.Year 1")
p_seq.10365.132 <- panel_in_boxplot(data = df_wide, seq = "seq.10365.132", month1var = "seq.10365.132.Month 1", year1var = "seq.10365.132.Year 1")
p_seq.10367.62 <- panel_in_boxplot(data = df_wide, seq = "seq.10367.62", month1var = "seq.10367.62.Month 1", year1var = "seq.10367.62.Year 1")
p_seq.2573.20 <- panel_in_boxplot(data = df_wide, seq = "seq.2573.20", month1var = "seq.2573.20.Month 1", year1var = "seq.2573.20.Year 1")
p_seq.2575.5 <- panel_in_boxplot(data = df_wide, seq = "seq.2575.5", month1var = "seq.2575.5.Month 1", year1var = "seq.2575.5.Year 1")
p_seq.2585.2 <- panel_in_boxplot(data = df_wide, seq = "seq.2585.2", month1var = "seq.2585.2.Month 1", year1var = "seq.2585.2.Year 1")
p_seq.2948.58 <- panel_in_boxplot(data = df_wide, seq = "seq.2948.58", month1var = "seq.2948.58.Month 1", year1var = "seq.2948.58.Year 1")
p_seq.3070.1 <- panel_in_boxplot(data = df_wide, seq = "seq.3070.1", month1var = "seq.3070.1.Month 1", year1var = "seq.3070.1.Year 1")
p_seq.4673.13 <- panel_in_boxplot(data = df_wide, seq = "seq.4673.13", month1var = "seq.4673.13.Month 1", year1var = "seq.4673.13.Year 1")
p_seq.8484.24 <- panel_in_boxplot(data = df_wide, seq = "seq.8484.24", month1var = "seq.8484.24.Month 1", year1var = "seq.8484.24.Year 1")

# arrange
grpbox <- ggarrange(p_seq.10967.12,p_seq.2585.2,
                    p_seq.2575.5,p_seq.8484.24,
                    p_seq.10365.132,p_seq.10367.62,
                    p_seq.2573.20,p_seq.2948.58,
                    p_seq.3070.1,p_seq.4673.13,
                    nrow = 5, ncol = 2,
                    common.legend = T)
png(height = 3000, width = 2500, file = "/Users/pylell/Dropbox/IMPROVE, Teen-LABS, TODAY combined analysis/Teen-LABS results/Proteomics/Teen-LABS_JAK_STAT_ligands.png", res = 170)
grpbox
dev.off()
```

