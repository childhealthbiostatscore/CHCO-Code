---
title: "Voxelwise Functional Data Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 5
    toc_float: yes
---

```{r setup, include=FALSE}
library(redcapAPI)
library(tidyverse)
library(tidyfun)
library(refundr)
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
# Import crocodile data
# API import
tokens <- read.csv("~/Documents/Work/CHCO/Petter Bjornstad/Data Harmonization/api_tokens.csv")
uri <- "https://redcap.ucdenver.edu/api/"
rcon <- redcapConnection(url = uri, token = tokens$Token[tokens$Study == "CROCODILE"])
crocodile <- exportRecords(rcon, forms = "demographics", labels = F)
crocodile <- crocodile %>% select(record_id, group, age_consent, sex)
crocodile$record_id <- as.numeric(crocodile$record_id)
# Import voxelwise data
df <- read.csv("~/Documents/Work/CHCO/Petter Bjornstad/CROCODILE/Data_Cleaned/voxelwise_rows.csv")
# Split by region and parameter, delete unnecessary columns
lcortex_k1 <- df[df$region == "lcortex" & df$parameter == "k1", ]
lcortex_k1$region <- NULL
lcortex_k1$parameter <- NULL
lcortex_k1 <- lcortex_k1[, colSums(is.na(lcortex_k1)) < nrow(lcortex_k1)]

lcortex_k2 <- df[df$region == "lcortex" & df$parameter == "k2", ]
lcortex_k2$region <- NULL
lcortex_k2$parameter <- NULL
lcortex_k2 <- lcortex_k2[, colSums(is.na(lcortex_k2)) < nrow(lcortex_k2)]

lmedulla_k1 <- df[df$region == "lmedulla" & df$parameter == "k1", ]
lmedulla_k1$region <- NULL
lmedulla_k1$parameter <- NULL
lmedulla_k1 <- lmedulla_k1[, colSums(is.na(lmedulla_k1)) < nrow(lmedulla_k1)]

lmedulla_k2 <- df[df$region == "lmedulla" & df$parameter == "k2", ]
lmedulla_k2$region <- NULL
lmedulla_k2$parameter <- NULL
lmedulla_k2 <- lmedulla_k2[, colSums(is.na(lmedulla_k2)) < nrow(lmedulla_k2)]

rcortex_k1 <- df[df$region == "rcortex" & df$parameter == "k1", ]
rcortex_k1$region <- NULL
rcortex_k1$parameter <- NULL
rcortex_k1 <- rcortex_k1[, colSums(is.na(rcortex_k1)) < nrow(rcortex_k1)]

rcortex_k2 <- df[df$region == "rcortex" & df$parameter == "k2", ]
rcortex_k2$region <- NULL
rcortex_k2$parameter <- NULL
rcortex_k2 <- rcortex_k2[, colSums(is.na(rcortex_k2)) < nrow(rcortex_k2)]

rmedulla_k1 <- df[df$region == "rmedulla" & df$parameter == "k1", ]
rmedulla_k1$region <- NULL
rmedulla_k1$parameter <- NULL
rmedulla_k1 <- rmedulla_k1[, colSums(is.na(rmedulla_k1)) < nrow(rmedulla_k1)]

rmedulla_k2 <- df[df$region == "rmedulla" & df$parameter == "k2", ]
rmedulla_k2$region <- NULL
rmedulla_k2$parameter <- NULL
rmedulla_k2 <- rmedulla_k2[, colSums(is.na(rmedulla_k2)) < nrow(rmedulla_k2)]
# Convert to functional
fda_lcortex_k1 <- tibble(record_id = lcortex_k1$record_id)
fda_lcortex_k1$lcortex_k1 <- tfd(data.matrix(lcortex_k1[, 2:ncol(lcortex_k1)]))
fda_lcortex_k2 <- tibble(record_id = lcortex_k2$record_id)
fda_lcortex_k2$lcortex_k2 <- tfd(data.matrix(lcortex_k2[, 2:ncol(lcortex_k2)]))

fda_lmedulla_k1 <- tibble(record_id = lmedulla_k1$record_id)
fda_lmedulla_k1$lmedulla_k1 <- tfd(data.matrix(lmedulla_k1[, 2:ncol(lmedulla_k1)]))
fda_lmedulla_k2 <- tibble(record_id = lmedulla_k2$record_id)
fda_lmedulla_k2$lmedulla_k2 <- tfd(data.matrix(lmedulla_k2[, 2:ncol(lmedulla_k2)]))

fda_rcortex_k1 <- tibble(record_id = rcortex_k1$record_id)
fda_rcortex_k1$rcortex_k1 <- tfd(data.matrix(rcortex_k1[, 2:ncol(rcortex_k1)]))
fda_rcortex_k2 <- tibble(record_id = rcortex_k2$record_id)
fda_rcortex_k2$rcortex_k2 <- tfd(data.matrix(rcortex_k2[, 2:ncol(rcortex_k2)]))

fda_rmedulla_k1 <- tibble(record_id = rmedulla_k1$record_id)
fda_rmedulla_k1$rmedulla_k1 <- tfd(data.matrix(rmedulla_k1[, 2:ncol(rmedulla_k1)]))
fda_rmedulla_k2 <- tibble(record_id = rmedulla_k2$record_id)
fda_rmedulla_k2$rmedulla_k2 <- tfd(data.matrix(rmedulla_k2[, 2:ncol(rmedulla_k2)]))
# Merge
crocodile <- crocodile[crocodile$record_id %in% unique(df$record_id), ]
fda_df <- full_join(crocodile, fda_lcortex_k1, by = "record_id")
fda_df <- full_join(fda_df, fda_lcortex_k2, by = "record_id")
fda_df <- full_join(fda_df, fda_lmedulla_k1, by = "record_id")
fda_df <- full_join(fda_df, fda_lmedulla_k2, by = "record_id")
fda_df <- full_join(fda_df, fda_rcortex_k1, by = "record_id")
fda_df <- full_join(fda_df, fda_rcortex_k2, by = "record_id")
fda_df <- full_join(fda_df, fda_rmedulla_k1, by = "record_id")
fda_df <- full_join(fda_df, fda_rmedulla_k2, by = "record_id")
# Clean up workspace
rm(list=setdiff(ls(), "fda_df"))
```

# Plots

```{r}
fda_df %>% 
  ggplot(aes(tf = lcortex_k1,color = group)) + geom_spaghetti(alpha = 0.5) +
  theme_bw() + theme(legend.title = element_blank())
```

# FPCA

## Left cortex K1

```{r}
fpca = rfr_fpca(Y = "lcortex_k1", data = fda_df)

fda_df %>% 
  modelr::add_predictions(fpca, var = "cca_fits") %>% 
  filter(case == "control") %>% 
  ggplot(aes(y = cca_fits)) + 
  geom_spaghetti(alpha = .4) + 
  geom_spaghetti(aes(y = cca), color = "blue", alpha = .3) + 
  facet_grid(~sex)
```

# Questions

1. What is the best way to represent this image data in 3D form? How much information are we losing by converting it to a vector, since I would assume that regions that are close together in a 3D image would be more correlated than regions farther apart.

2. Is the question simply "are the groups different?" Or are we interested in specific regions?
