---
title: "Phoom's 2026 EDNSG Abstract CROC->PANDA"
author: "Ye Ji Choi"
format: 
  html:
    embed-resources: true
date: "`r lubridate::today()`"
---

```{r, include = F}
library(dplyr)
library(tidyr)
library(table1)
library(arsenal)
library(Hmisc)
library(purrr)
library(REDCapR)
library(jsonlite)
```

```{r, include = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r, include = F}
dat <- read.csv(file.path(root_path, "Data Harmonization/Data Clean/harmonized_dataset.csv"), na.strings = c(" ", "", "-9999",-9999))
dict <- read.csv(file.path(root_path, "Data Harmonization/data_dictionary_master.csv"), na.strings = c(" ", "", "-9999",-9999)) %>%
  dplyr::select(variable_name, label)
patho_qual <- read.csv(file.path(root_path, "Kidney Morphometrics/Data_Cleaned/croc_panda_patho_qual.csv"), na.strings = "")
# REDCap tokens
api_tok <- read.csv(file.path(root_path, "Data Harmonization/api_tokens.csv"))

panda_tok <- api_tok[api_tok$Study == "PANDA",]$Token
croc_tok <- api_tok[api_tok$Study == "CROCODILE",]$Token
attempt_tok <- api_tok[api_tok$Study == "ATTEMPT",]$Token

# Extract MRNs for matching
PANDA_rc <- redcap_read(redcap_uri = "https://redcap.ucdenver.edu/api/",
                        token = panda_tok)$data
CROC_rc <- redcap_read(redcap_uri = "https://redcap.ucdenver.edu/api/",
                        token = croc_tok)$data
ATTEMPT_rc <- redcap_read(redcap_uri = "https://redcap.ucdenver.edu/api/",
                        token = attempt_tok)$data

PANDA_mrn <- PANDA_rc %>% dplyr::select(record_id, mrn, name_last, name_first) %>% distinct(record_id, .keep_all = T) 
CROC_mrn <- CROC_rc %>% dplyr::select(record_id, mrn, name_last, name_first) %>% distinct(record_id, .keep_all = T) %>%
  mutate(record_id = case_when(record_id <10 ~ paste0("CRC-0", record_id),
                             record_id >= 10 ~ paste0("CRC-", record_id)))
ATTEMPT_mrn <- ATTEMPT_rc %>%
  dplyr::select(subject_id, mrn, name_last, name_first) %>% 
  distinct(subject_id, .keep_all = T) %>%
  dplyr::rename("record_id" = "subject_id")
ATTEMPT_mrn$record_id <- as.character(ATTEMPT_mrn$record_id)

combined_mrn <- bind_rows(PANDA_mrn, CROC_mrn, ATTEMPT_mrn) %>%
  mutate(co_enroll_study = case_when(startsWith(record_id, "PNDA-1") & (mrn %in% CROC_mrn$mrn) ~ "CO_CROC (Follow up)",
                                     startsWith(record_id, "CRC") & (mrn %in% PANDA_mrn$mrn) ~ "CO_CROC (Initial visit)",
                                     startsWith(record_id, "PNDA-1") & (mrn %in% ATTEMPT_mrn$mrn) ~ "CO_ATTEMPT",
                                     startsWith(record_id, "PNDA-1") ~ "CO_De Novo",
                                     startsWith(record_id, "PNDA-2") | startsWith(record_id, "PNDA 2") ~ "UW_De Novo")) %>%
  filter(!is.na(co_enroll_study)) 

dat <- dat %>%
  filter(study == "PANDA"|study == "CROCODILE") %>%
  right_join(combined_mrn) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
            across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
            .by = c(record_id, visit)) %>%
  group_by(mrn) %>%
  fill(hba1c) %>% fill(acr_u) %>% ungroup() %>%
  # filter(participation_status != "Removed"|is.na(participation_status)) %>%
  # filter(!is.na(kidney_side)|!is.na(kit_id)) %>%
  mutate(race_ethnicity_condensed = case_when(race == "White" & 
                                                ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
                                              race == "Black or African American" & 
                                                ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
                                              ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
                                              T ~ "Not Hispanic or Latino Other"),
         race = case_when(race == "Black/African American & White" ~ "More than one", T ~ race), 
         obtained_lm_em = if_else(core_diagnostic == 1, "Yes", "No"),
         obtained_cryo_hypotherm = if_else(core_hypo_cryo == 1, "Yes", "No"),
         obtained_oct = if_else(core_oct == 1, "Yes", "No"),
         obtained_rnalater = if_else(core_rna == 1, "Yes", "No"),
         hba1c_group = case_when(hba1c < 7 ~ "<7%",
                                 hba1c < 9 ~ "7-<9%",
                                 hba1c >= 9 ~ ">=9%"),
         egfr_cat = case_when(eGFR_CKD_epi < 45 ~ "<45 mL/min/1.73m2",
                              eGFR_CKD_epi < 60 ~ "45-<60 mL/min/1.73m2",
                              eGFR_CKD_epi < 90 ~ "60-<90 mL/min/1.73m2",
                              eGFR_CKD_epi >=90  ~ ">=90 mL/min/1.73m2"),
         t1d_duration_category = case_when(diabetes_duration < 10 ~ "<10",
                                           diabetes_duration < 15 ~ "10-<15",
                                           diabetes_duration < 20 ~ "15-<20",
                                           diabetes_duration < 25 ~ "20-<25",
                                           diabetes_duration < 30 ~ "25-<30",
                                           diabetes_duration >= 30 ~ ">=30"))

dat$co_enroll_study <- factor(dat$co_enroll_study, 
                              levels = c("UW_De Novo", "CO_De Novo", "CO_CROC (Initial visit)",
                                         "CO_CROC (Follow up)", "CO_ATTEMPT"))
dat$sex <- factor(dat$sex, levels = c("Male", "Female"))
dat$hba1c_group <- factor(dat$hba1c_group, levels = c("<7%", "7-<9%", ">=9%"))
dat$race <- factor(dat$race, levels = c("Asian", "Black or African American", "White", "More than one", "Other", "Unknown"))
dat$egfr_cat <- factor(dat$egfr_cat, levels = c("<45 mL/min/1.73m2",
                                                "45-<60 mL/min/1.73m2",
                                                "60-<90 mL/min/1.73m2",
                                                ">=90 mL/min/1.73m2"))
dat$t1d_duration_category <- factor(dat$t1d_duration_category, 
                                    levels = c("<10","10-<15","15-<20","20-<25","25-<30", ">=30"))
```

# Type 1 Diabetes Follow Up

```{r, include = F}
# 1) Keep only CO_CROC initial + follow-up
croc_only <- dat %>%
  filter(co_enroll_study %in% c("CO_CROC (Initial visit)", "CO_CROC (Follow up)")) %>%
  filter(visit == "baseline")

# --- replace `visit_date` below with your actual date field ---
# e.g. mutate(visit_date = as.Date(biopsy_date)) or as.Date(biopsy_date, "%m/%d/%Y")

croc_only <- croc_only %>%
  mutate(
    date = as.Date(date)
  )

# 2) Pull baseline/follow-up dates per MRN and compute follow-up time
croc_fu <- croc_only %>%
  dplyr::summarise(
    baseline_date = min(date[co_enroll_study == "CO_CROC (Initial visit)"], na.rm = TRUE),
    followup_date = min(date[co_enroll_study == "CO_CROC (Follow up)"], na.rm = TRUE),
    .by = mrn
  ) %>%
  mutate(followup_date = case_when(followup_date != Inf ~ followup_date)) %>%
  mutate(
    days_to_followup  = as.numeric(followup_date - baseline_date),
    years_to_followup = days_to_followup / 365.25,
    co_enroll_study = case_when(!is.na(followup_date) ~ "CO_CROC (Follow up)",
                                T ~ "CO_CROC (Initial visit)")
  )

croc_only <- croc_only %>%
  left_join(croc_fu) %>%
  left_join(patho_qual)
```

```{r echo = F, results='asis', warning = F}
croc_only$croc_visit = ifelse(croc_only$co_enroll_study == "CO_CROC (Follow up)", "Visit 2", "Visit 1")

summary(arsenal::tableby(croc_visit ~ kwt(years_to_followup, "medianq1q3") + group + sex,
                data = croc_only), test = F)

summary(arsenal::paired(croc_visit ~  age + hba1c + signed.rank(acr_u, "Nmiss", "medianq1q3") +
                          diabetes_duration +
                weight + height + bmi + gfr_raw_plasma + gfr_bsa_plasma +
                erpf_raw_plasma + erpf_bsa_plasma + avg_pcascl + avg_c_adc + avg_c_r2 + avg_k_r2 +
                total_kidney_volume_ml + ht_adj_tkv + p1_raw_m + p1_raw_leanm + p1_gc_m + p1_gc_leanm +
                  p2_raw_m + p2_raw_leanm + p2_gc_m + p2_gc_leanm + gir_190 + m_i_p2_raw_lean +
                  glom_enlarged + tubulointerstitium + vessels,
                id = croc_id, data = croc_only))

# View(subset(croc_only, select = c(record_id,visit, kit_id, croc_id, panda_id, croc_visit, avg_pcascl, avg_c_adc, avg_c_r2)))

```

# Type 2 Diabetes Follow Up (ASN oral)

```{r}
harm_dat_collapsed <- harm_dat %>%
  group_by(record_id, visit) %>%
  fill(date, .direction = "updown") %>% ungroup() %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit)) %>%
  dplyr::mutate(race_ethnicity_condensed = case_when(race == "White" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
                                                     race == "Black or African American" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
                                                     ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
                                                     T ~ "Not Hispanic or Latino Other")) %>%
  arrange(record_id) %>%
  mutate(agem = age*12)

# RH/RH2 subset
rh_rh2_croc_panther <- harm_dat_collapsed %>% 
  filter(study %in% c("RENAL-HEIR", "RENAL-HEIRitage", "CROCODILE", "PANTHER")) %>%
  filter(group %in% c("Type 2 Diabetes", "Obese Control", "Lean Control")) %>%
  filter(visit == "baseline")

bmi_percentile = ext_bmiz(data = subset(rh_rh2_croc_panther, 
                                        select = c("record_id", "sex", "agem", "weight", "height", "bmi")),
                          wt = "weight", ht = "height") %>%
  dplyr::select(record_id, bmip)
  
rh_rh2_croc_panther_unique <- rh_rh2_croc_panther %>%
  left_join(bmi_percentile) %>%
  arrange(mrn, date) %>%
  distinct(mrn, date, .keep_all = TRUE) %>%
  group_by(mrn) %>%
  mutate(
    date = as.Date(date),
    date_diff_days = case_when(is.na(lag(date)) ~ 0, 
                               T ~ as.numeric(difftime(date, lag(date), units = "days"))),
    date_diff_years = date_diff_days/365,
    new_cluster = if_else(is.na(lag(date)) | date_diff_days > 7,
                          1, 0),
    cluster_id = cumsum(replace_na(new_cluster, 1))
  ) %>%
  group_by(mrn, cluster_id) %>%
  slice_min(order_by = date, with_ties = FALSE) %>%
  ungroup() %>%
  #stratify T2D and OB in RH/RH2 by UACR >= 100 mg/g and look at the kidney MRI parameters.. I want to include some of this preliminary data in my slides for Spain
  # eGFR <60 for eGFR_CKD_epi AND/OR UACR>= 100 mg/g
  # in other words, to be in the high risk group EITHER eGFR <60 AND/OR UACR>= 100mg/g
  # so if you have UACR >= 100 mg/g but eGFR >60 you qualify, or if you have UACR <100 but eGFR <60 you qualify, and if you have both, i.e., UACR >= 100 and eGFR <60 you qualify
  mutate(uacr_100 = case_when(acr_u >= 100 ~ "UACR >=100 mg/g",
                              acr_u < 100 ~ "UACR <100 mg/g"),
         uacr_group = case_when(eGFR_CKD_epi < 75 | acr_u >= 100 ~ "eGFR < 75 and/or UACR >=100 mg/g",
                                eGFR_CKD_epi >=75 | acr_u < 100 ~ "eGFR >= 75 and UACR <100 mg/g"),
         uacr_group = factor(uacr_group, levels = c("eGFR >= 75 and UACR <100 mg/g",
                                                    "eGFR < 75 and/or UACR >=100 mg/g")),
         # eGFR categories
         egfr_cat = case_when(
           eGFR_CKD_epi < 60                      ~ "<60",
           eGFR_CKD_epi >= 60 & eGFR_CKD_epi < 90 ~ "60–<90",
           eGFR_CKD_epi >= 90                     ~ "≥90",
           TRUE ~ NA_character_
         ),
         egfr_cat = factor(egfr_cat, levels = c("<60", "60–<90", "≥90")),
         # ACR categories
         acr_u_cat3 = case_when(
           acr_u < 30                  ~ "<30",
           acr_u >= 30 & acr_u < 300   ~ "30–<300",
           acr_u >= 300                ~ "≥300",
           TRUE ~ NA_character_
         ),
         acr_u_cat3 = factor(acr_u_cat3, levels = c("<30", "30–<300", "≥300")),
         bmi_cat = case_when(
           # Adults (≥18 years)
           age >= 18 & bmi < 25                ~ "Lean",
           age >= 18 & bmi >= 25 & bmi < 30    ~ "Overweight",
           age >= 18 & bmi >= 30               ~ "Obese",
           
           # Pediatrics (<18 years)
           age < 18 & bmip < 85      ~ "Lean",
           age < 18 & bmip >= 85 & bmip < 95 ~ "Overweight",
           age < 18 & bmip >= 95     ~ "Obese",
           
           TRUE ~ NA_character_
         ),
         bmi_cat = factor(
           bmi_cat,
           levels = c("Lean", "Overweight", "Obese")
         ),
         group_risk = case_when(bmip >= 95 | hba1c >=6 | group == "Type 2 Diabetes" ~ "High",
                                bmip < 85 & hba1c <=5.6 ~ "Low"),
         tkv_combined = coalesce(total_kidney_volume_ml, total_kidney_volume_ml_manual),
         htadjtkv_combined = coalesce(ht_adj_tkv, ht_adj_tkv_manual),
  )

rh_rh2_unique <- rh_rh2_croc_panther_unique %>%
  filter(group %nin% c("Lean Control")) %>%
  filter(study != "PANTHER")

rh_rh2_unique_follow_up <- rh_rh2_unique %>%
  group_by(mrn) %>%
  filter(n() > 1) %>%
  ungroup() %>%
  mutate(study_visit = case_when(study == "RENAL-HEIR" ~ "Baseline",
                                 T ~ "Follow up"))
rh_rh2_unique_follow_up$log_uacr <- log(rh_rh2_unique_follow_up$acr_u)

# delta dataframe
clinical_vars <- c("eGFR_CKD_epi", "eGFR_fas_cr", "gfr_bsa_plasma", "erpf_bsa_plasma", 
                   "htadjtkv_combined", "log_uacr")
rh_rh2_delta <- rh_rh2_unique_follow_up %>%
  # Pivot wider to get baseline and follow-up in separate columns
  pivot_wider(
    id_cols = mrn,
    names_from = study_visit,
    values_from = all_of(clinical_vars),
    names_sep = "_"
  ) %>%
  
  # Calculate deltas (follow-up - baseline)
  mutate(
    delta_gfr_bsa_plasma = `gfr_bsa_plasma_Follow up` - gfr_bsa_plasma_Baseline,
    delta_eGFR_CKD_epi = `eGFR_CKD_epi_Follow up` - eGFR_CKD_epi_Baseline,
    delta_eGFR_fas_cr = `eGFR_fas_cr_Follow up` - eGFR_fas_cr_Baseline,
    delta_erpf_bsa_plasma = `erpf_bsa_plasma_Follow up` - erpf_bsa_plasma_Baseline,
    delta_htadjtkv_combined = `htadjtkv_combined_Follow up` - htadjtkv_combined_Baseline,
    delta_log_uacr = `log_uacr_Follow up` - log_uacr_Baseline
  ) %>%
  dplyr::select(mrn, starts_with("delta_"), ends_with("Baseline")) 
 
rh_rh2_unique_follow_up <- rh_rh2_unique_follow_up %>%
  left_join(rh_rh2_delta) %>%
  mutate(
    across(
      starts_with("delta_"),
      ~ ifelse(study == "RENAL-HEIR", 0, .x)
    )
  )

```

```{r echo = F, results = 'asis'}
# RH follow up
# determine follow up by screen date and MRN
summary(arsenal::tableby(study_visit ~ age + sex + bmi + group + uacr_group + diabetes_duration + sbp + dbp + hba1c + gfr_bsa_plasma + erpf_bsa_plasma + kwt(date_diff_years, "medianq1q3") + htadjtkv_combined + avg_c_r2 + avg_k_r2 + avg_c_adc + avg_pcascl + acr_u_cat3 + kwt(acr_u, "medianq1q3"), data = rh_rh2_unique_follow_up, digits = 1))

summary(arsenal::paired(study_visit ~ age + sex + bmi + group + uacr_group + diabetes_duration + sbp + dbp + hba1c + gfr_bsa_plasma + erpf_bsa_plasma + signed.rank(date_diff_years, "medianq1q3") + htadjtkv_combined + avg_c_r2 + avg_k_r2  + avg_pcascl + acr_u_cat3 + signed.rank(acr_u, "medianq1q3"), data = rh_rh2_unique_follow_up, digits = 1, id = mrn))
```

# Figure combining both T1D and T2D for abstract

```{r}
plot_visits <- function(df, visit_var = "croc_visit", 
                        y_var = "hba1c", id_var = "mrn", 
                        visits = c("Visit 1", "Visit 2"), 
                        paired = TRUE, method = "t.test", title = "HbA1c", 
                        line_color = "#033860", box_size = 2, 
                        line_alpha = 0.5, text_size = 25, stat_size = 10, vjust = 0, 
                        colors = c("#087CA7", "#004385"), 
                        expand_mult = c(0.05, 0.25), 
                        label = "p.format", caption_digits = 1, 
                        caption_txt = NULL, 
                        show_caption = TRUE, 
                        sym_cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1), 
                        sym_symbols = c("p<0.0001", "p<0.001", "p<0.01", "p<0.05", "p<0.1", "NS")) {
  stopifnot(is.data.frame(df))
  for (v in c(visit_var, y_var, id_var)) {
    if (!v %in% names(df)) stop("Column not found in df: ", v)
  }
  if (length(visits) != 2) stop("`visits` must be length 2 (e.g., c('Visit 1','Visit 2')).")
  if (length(colors) < 2) stop("`colors` must have at least 2 values.")

  dat <- df |>
    dplyr::filter(.data[[visit_var]] %in% visits) |>
    dplyr::mutate(!!visit_var := factor(.data[[visit_var]], levels = visits))

  summ <- dat |>
    dplyr::group_by(.data[[visit_var]]) |>
    dplyr::summarise(
      n = sum(!is.na(.data[[y_var]])),
      mean = mean(.data[[y_var]], na.rm = TRUE),
      sd = stats::sd(.data[[y_var]], na.rm = TRUE),
      .groups = "drop"
    ) |>
    dplyr::mutate(
      mean_r = round(mean, caption_digits),
      sd_r = round(sd, caption_digits)
    )

  get_stat <- function(v, col) {
    out <- summ |>
      dplyr::filter(.data[[visit_var]] == v) |>
      dplyr::pull({{ col }})
    if (length(out) == 0) NA_real_ else out[1]
  }

  v1 <- visits[1]; v2 <- visits[2]
  v1_mean <- get_stat(v1, mean_r); v1_sd <- get_stat(v1, sd_r); v1_n <- get_stat(v1, n)
  v2_mean <- get_stat(v2, mean_r); v2_sd <- get_stat(v2, sd_r); v2_n <- get_stat(v2, n)

  dat_test <- dat
  if (paired) {
    dat_test <- dat_test |>
      dplyr::group_by(.data[[id_var]]) |>
      dplyr::filter(dplyr::n() == 2, !any(is.na(.data[[y_var]]))) |>
      dplyr::ungroup()
  } else {
    dat_test <- dat_test |>
      dplyr::filter(!is.na(.data[[y_var]]))
  }

  p_val <- NA_real_
  if (paired) {
    wide <- dat_test |>
      dplyr::select(dplyr::all_of(c(id_var, visit_var, y_var))) |>
      tidyr::pivot_wider(names_from = dplyr::all_of(visit_var), values_from = dplyr::all_of(y_var))
    if (nrow(wide) >= 2) {
      x1 <- wide[[v1]]
      x2 <- wide[[v2]]
      tt <- stats::t.test(x1, x2, paired = TRUE)
      p_val <- tt$p.value
    }
  } else {
    x1 <- dat_test |> dplyr::filter(.data[[visit_var]] == v1) |> dplyr::pull(.data[[y_var]])
    x2 <- dat_test |> dplyr::filter(.data[[visit_var]] == v2) |> dplyr::pull(.data[[y_var]])
    if (length(x1) >= 2 && length(x2) >= 2) {
      tt <- stats::t.test(x1, x2, paired = FALSE)
      p_val <- tt$p.value
    }
  }

  p_txt <- if (is.na(p_val)) "NA" else format.pval(p_val, digits = 3, eps = 1e-3)

  if (is.null(caption_txt)) {
    caption_txt <- paste0(
      title, ": ",
      v1_mean, " \u00B1 ", v1_sd, " vs. ",
      v2_mean, " \u00B1 ", v2_sd
    )
  }

  p <- ggplot2::ggplot(dat, ggplot2::aes(x = .data[[visit_var]], y = .data[[y_var]], color = .data[[visit_var]])) +
    ggplot2::geom_boxplot(outliers = FALSE, size = box_size) +
    ggplot2::geom_line(ggplot2::aes(group = .data[[id_var]]), alpha = line_alpha, color = line_color) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      panel.grid = ggplot2::element_blank(),
      text = ggplot2::element_text(size = text_size),
      legend.position = "none",
      plot.title = ggplot2::element_text(hjust = 0.5, face = "bold"),
      plot.caption = ggplot2::element_text(hjust = 0.5, size = text_size * 0.8),
      plot.caption.position = "plot"
    ) +
    ggplot2::labs(x = NULL, y = NULL, title = title,
                  caption = if (show_caption) caption_txt else NULL) +
    ggplot2::scale_color_manual(values = colors)

  if (!is.na(p_val)) {
    y_range <- range(dat[[y_var]], na.rm = TRUE)
    y_position <- y_range[2] + diff(y_range) * expand_mult[2] * 0.5
    
    p_label <- if (label == "p.format") {
      p_txt
    } else if (label == "p.signif") {
      cut_idx <- findInterval(p_val, sym_cutpoints)
      if (cut_idx > 0 && cut_idx <= length(sym_symbols)) {
        sym_symbols[cut_idx]
      } else {
        p_txt
      }
    } else {
      p_txt
    }
    
    p <- p +
      ggplot2::annotate("segment", x = 1, xend = 2, y = y_position, yend = y_position) +
      ggplot2::annotate("text", x = 1.5, y = y_position, label = p_label, 
                       size = stat_size, vjust = vjust - 1)
  }

  p <- p + ggplot2::scale_y_continuous(expand = ggplot2::expansion(mult = expand_mult))

  return(p)
}

```

```{r}
plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "hba1c",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "HbA1c")

croc_only$log_acr_u <- log(croc_only$acr_u)
plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "log_acr_u",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "log(UACR)",
            caption_txt = "UACR: 5.2 [3.3, 7.5] vs. 5.0 [3.9, 6.8]")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "gfr_bsa_plasma",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "mGFR")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "avg_c_adc",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "Cortical ADC")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "avg_pcascl",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "pCASL")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "avg_k_r2",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "Kidney R2*")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "ht_adj_tkv",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "TKV")

plot_visits(croc_only,
            visit_var = "croc_visit",
            y_var = "erpf_bsa_plasma",
            id_var = "mrn",
            visits = c("Visit 1", "Visit 2"),
            title = "ERPF")
```

```{r}
plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "hba1c",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "HbA1c",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

rh_rh2_unique_follow_up$log_acr_u <- log(rh_rh2_unique_follow_up$acr_u)
plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "log_acr_u",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "log(UACR)",
            caption_txt = "UACR: 5.4 [4.4, 4.08] vs. 9.6 [4.2, 141.2]",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "gfr_bsa_plasma",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "mGFR",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "avg_c_adc",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "Cortical ADC",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "avg_pcascl",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "pCASL",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "avg_k_r2",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "Kidney R2*",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "htadjtkv_combined",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "TKV",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")

plot_visits(rh_rh2_unique_follow_up,
            visit_var = "study_visit",
            y_var = "erpf_bsa_plasma",
            id_var = "mrn",
            visits = c("Baseline", "Follow up"),
            title = "ERPF",
            colors = c("#588157", "#3A5A40"),
            line_color = "#A3B18A")
```