---
title: "KNIGHT Proteomics"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
date-format: long
knit: (function(rmdfile, ...) { rmarkdown::render(rmdfile, output_dir='/Users/pylell/Dropbox/KNIGHT/') })
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r libraries, echo = F, warning = F}
#| include: false
library(limma)
library(clusterProfiler)
library(ReactomePA)
library(enrichplot)
library(Hmisc)
library(knitr)
library(tidyverse)
library(gtsummary)
library(ggpubr)
library(lmerTest)
library(parallel)
library(emmeans)
library(RColorBrewer)
library(VennDiagram)
library(broom.mixed)
library(readxl)
library(dplyr)
library(stringr)
library(ggrepel)
library(correlation)
library(psych)
library(SomaPlotr)
library(openxlsx)
library(sjlabelled)

options(scipen = 999)
```

```{r functions, include=FALSE}
volcano <- function(data, lab = "Target", xcol = "logFC", ycol = "adj.P.Val",
                    top = 14,
                    xlimit = c(-1, 1), ylimit = c(0, -log10(10e-7)),
                    xlabel = "logFC", pCutoff = 0.05, overlaps = 20,
                    log_t = F) {
  data <- as.data.frame(data)
  data <- data %>% arrange(adj.P.Val)
  t <- data[data[, "adj.P.Val"] <= pCutoff, ]
  if (log_t) {
    t <- t[order(abs(log(t[, "adj.P.Val"])), decreasing = F), ]
  } else {
    t <- t[order(abs(t[, "adj.P.Val"]), decreasing = F), ]
  }
  data$top <- data[, "AptName"] %in% t[1:top, "AptName"]
  data$logp <- -log10(data[, ycol])
  data$fc <- data[, xcol]
  data$sig <- data[, ycol] <= pCutoff
  p <- ggplot(data = data, aes(x = fc, y = logp, color = sig)) +
    geom_hline(yintercept = -log10(pCutoff), linetype = "dashed") +
    geom_point(size = 2) +
    geom_label_repel(
      data = data[data$top, ], aes(label = Target), color = "black",
      max.overlaps = overlaps
    ) +
    scale_color_manual(values = c("grey", "#3e6dbf")) +
    xlab(xlabel) +
    ylab(bquote(~ -Log[10] ~ italic(Q))) +
    theme_bw() +
    theme(legend.position = "none")
  return(p)
}

plotVolcano_mod <- function (data, FC, p.value, labels, identify = FALSE, fc.cutoff = 1, 
  pt.size = 2.5, text.size = 3, cutoff = 0.05/nrow(data), sig_fc_lab = "Significant & Fold-Change",
  sig_lab = "Significant", fc_lab = "Fold-Change", ns_lab = "Non-Significant", 
  sig_fc_lab_col = "#f28482", sig_lab_col = "#f6bd60",
  fc_lab_col = "#84a59d", ns_lab_col = "#dad7cd",
  main = NULL, x.lab = NULL, ...) 
{
  .fc <- enquo(FC)
  .p <- enquo(p.value)
  if (all(pull(data, !!.fc) >= 0)) {
    warning("It appears you are not passing log2-transformed ", 
      "fold-change values. Please check.", call. = FALSE)
  }
  if (is.null(main)) {
    main <- "Volcano Plot of Significant Fold Changes"
  }
  if (is.null(x.lab)) {
    x.lab <- bquote(italic(log)[2] ~ (Fold ~ Change))
  }
  y.lab <- bquote(-italic(log)[10] ~ (p - value))
  plot_df <- dplyr::mutate(data, group = case_when((-log10(!!.p) >= 
    -log10(cutoff)) & (abs(!!.fc) >= fc.cutoff) ~ sig_fc_lab, 
    -log10(!!.p) >= -log10(cutoff) ~ sig_lab, abs(!!.fc) >= 
      fc.cutoff ~ fc_lab, TRUE ~ ns_lab), 
    type = grepl(paste0("^", sig_lab, "|", sig_fc_lab, "|Significant"), group))

  create_col_vector <- function(label_values, colors) {
    cols <- setNames(colors, label_values)
    return(cols)
  }
  
  label_values = c(ns_lab, fc_lab, sig_lab, sig_fc_lab)
  label_colors = c(ns_lab_col, fc_lab_col, sig_lab_col, sig_fc_lab_col)
  cols <- create_col_vector(label_values, label_colors)

  p <- ggplot(plot_df, aes(x = !!.fc, y = -log10(!!.p), color = group)) + 
    geom_point(alpha = 0.5, size = pt.size, ...) + scale_color_manual(values = cols, 
    name = "") + labs(x = x.lab, y = y.lab, title = main) + 
    geom_vline(xintercept = c(-1, 1) * fc.cutoff, color = "grey", 
      linetype = "longdash", alpha = 0.75) + geom_vline(xintercept = 0, 
    color = "grey50", linetype = "solid") + theme_soma() + 
    NULL
  if (identify) {
    p <- p + geom_text(data = dplyr::filter(plot_df, type), 
      aes(label = !!enquo(labels)), hjust = 0, nudge_x = 0.05, 
      size = text.size, color = "black", check_overlap = TRUE)
  }
  p
}

plotVolcano_mod_new <- function (data, FC, p.value, labels, identify = FALSE, identify_manual = NULL, fc.cutoff = 1, 
  label_apt = F, pt.size = 2.5, text.size = 3, cutoff = 0.05/nrow(data), 
  sig_fc_pos_lab = "Significant & Fold-Change (+)",
  sig_fc_neg_lab = "Significant & Fold-Change (-)", 
  sig_lab = "Significant", 
  fc_lab = "Fold-Change", ns_lab = "Non-Significant", 
  sig_fc_pos_lab_col = "#f28482", sig_fc_neg_lab_col = "#8ecae6", sig_lab_col = "#f6bd60",
  fc_lab_col = "#84a59d", ns_lab_col = "#dad7cd",
  main = NULL, x.lab = NULL, sig_fc_lab = NULL, overlaps = 10, ...) 
{
  .fc <- enquo(FC)
  .p <- enquo(p.value)
  .label <- enquo(labels)
  
  if (all(pull(data, !!.fc) >= 0)) {
    warning("It appears you are not passing log2-transformed ", 
      "fold-change values. Please check.", call. = FALSE)
  }
  if (is.null(main)) {
    main <- "Volcano Plot of Significant Fold Changes"
  }
  if (is.null(x.lab)) {
    x.lab <- bquote(italic(log)[2] ~ (Fold ~ Change))
  }
  y.lab <- bquote(-italic(log)[10] ~ (p - value))
  plot_df <- dplyr::mutate(data, 
                           group = case_when((-log10(!!.p) >= -log10(cutoff)) & (abs(!!.fc) >= fc.cutoff & !!.fc > 0) ~ sig_fc_pos_lab, 
                                             (-log10(!!.p) >= -log10(cutoff)) & (abs(!!.fc) >= fc.cutoff & !!.fc < 0) ~ sig_fc_neg_lab, 
                                             -log10(!!.p) >= -log10(cutoff) ~ sig_lab, abs(!!.fc) >= fc.cutoff ~ fc_lab, 
                                             TRUE ~ ns_lab), 
    type = grepl(paste0("^", sig_lab, "|", sig_fc_lab, "|Significant"), group))

  create_col_vector <- function(label_values, colors) {
    cols <- setNames(colors, label_values)
    return(cols)
  }
  
  label_values = c(ns_lab, fc_lab, sig_lab, sig_fc_pos_lab, sig_fc_neg_lab)
  label_colors = c(ns_lab_col, fc_lab_col, sig_lab_col, sig_fc_pos_lab_col, sig_fc_neg_lab_col)
  cols <- create_col_vector(label_values, label_colors)

  p <- ggplot(plot_df, aes(x = !!.fc, y = -log10(!!.p), color = group)) + 
    geom_point(alpha = 0.5, size = pt.size) + scale_color_manual(values = cols, 
    name = "") + labs(x = x.lab, y = y.lab, title = main) + 
    geom_vline(xintercept = c(-1, 1) * fc.cutoff, color = "grey", 
      linetype = "longdash", alpha = 0.75, ...) + geom_vline(xintercept = 0, 
    color = "grey50", linetype = "solid") + theme_soma() + 
    NULL
  if (identify) {
    p <- p + geom_text(data = dplyr::filter(plot_df, type), 
      aes(label = !!enquo(labels)), hjust = "inward", vjust = 0, nudge_x = 0.05, 
      size = text.size, color = "black", check_overlap = TRUE)
  }
  if (!is.null(identify_manual) & label_apt) {
    plot_df <- plot_df %>%
        dplyr::mutate(label_col = rownames(plot_df))
    p <- p + geom_label_repel(
      data = dplyr::filter(plot_df, !!.label %in% identify_manual & !!.p < 0.05), aes(label = Target_apt), color = "black", min.segment.length = 0,
      max.overlaps = overlaps, nudge_x = -0.3, force = 6,
    ) 
  }
  if (!is.null(identify_manual) & !label_apt) {
    p <- p + geom_text(data = dplyr::filter(plot_df, !!.label %in% identify_manual & !!.p < 0.05), 
      aes(label = !!enquo(label_apt)), hjust = "inward", vjust = 0, nudge_x = 0.05, 
      size = text.size, color = "black", check_overlap = TRUE)
  }
  p
}

```

```{r, include=F}
# Load correlation function
source("/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad/Resources/YC/R Functions/correlation_function.R")
source("~/Documents/Github/shared-resources/Machine Learning/Tim - ElasticNet CV/easy_elasticnet.R")

load("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Somalogic data/knight_soma.Rdata")
load("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Somalogic data/analytes.Rdata")

# read in linkage file for Natalie's studies
link <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Somalogic data/BCF-23-091 Linker File 10.05.2023.csv")
link$Study.ID <- link$Sequence.Number
redcap <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Somalogic data/200572DataKNIGHT_DATA_LABELS_2023-12-10_1551.csv")
redcap <- redcap %>% filter(Event.Name == "Screening")
redcap <- redcap %>% select(Study.ID, Sex.assigned.at.birth)
link <- merge(link, redcap, by="Study.ID", all.x = T, all.y = F)
link$SampleDescription <- link$Barcode
link <- link %>% select(SampleDescription, Study.ID, Timepoint.Label, Sex.assigned.at.birth)
knight_soma <- full_join(knight_soma, link, by="SampleDescription")

# read in linkage file for Netherlands samples
# actually, not sure I need these...there is a field called TimePoint
#nethlink <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Somalogic data/sample ID and visit labels SOMAscan WUS-23-004.csv")
#nethlink <- nethlink %>% filter(str_detect(SampleId, "KGHT"))
#nethlink <- nethlink %>% select(GTAC_ID, TimePoint)
#knight_soma$GTAC_ID <- str_sub(knight_soma$SampleId, 1, 10)
#knight_soma <- merge(knight_soma, nethlink, by="GTAC_ID", all.x = T, all.y = T)

# create new variable for harmonized time point
knight_soma$time <-  
  case_when(
  knight_soma$TimePoint == "V1" ~ 1,
  knight_soma$TimePoint == "V2" ~ 2,
  knight_soma$Timepoint.Label == "Baseline" ~ 1,
  knight_soma$Timepoint.Label == "M3" ~ 2,
  .default = NA
)

knight_soma$group <-  
  case_when(
  str_sub(knight_soma$SampleDescription, 1, 2) == "MV" ~ "MTF",
  str_sub(knight_soma$SampleDescription, 1, 2) == "VM" ~ "FTM",
  knight_soma$Sex.assigned.at.birth == "Male" ~ "MTF",
  knight_soma$Sex.assigned.at.birth == "Female" ~ "FTM",
  .default = NA
)

knight_soma$Study.ID <- ifelse(is.na(knight_soma$Study.ID), knight_soma$SampleDescription, knight_soma$Study.ID)
knight_soma$Study.ID <- ifelse(knight_soma$Study.ID == "572.01", "572.010", knight_soma$Study.ID)

# identify columns corresponding to proteins
#is_seq <- function(.x) grepl("^seq\\.[0-9]{4}", .x) # regex for analytes
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(knight_soma))
# log transform
knight_soma <- knight_soma %>% modify_if(is_seq(names(.)), log)

# read in extra variables from AMC
sexhormones <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Data_raw/Excel KNIGHT - sex hormones.csv")
sexhormones <- sexhormones %>% select(study_nr, Visit, estradiol_CU, testosteron_CU)
# one value for testosterone doesn't make sense per Sarah
sexhormones$testosteron_CU <- ifelse(sexhormones$testosteron_CU == 3600, NA, sexhormones$testosteron_CU)
extravars <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Data_raw/Excel KNIGHT extra data + variables.csv")
neth <- full_join(sexhormones, extravars, by=c("study_nr","Visit"))
gfr <-  read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Data_raw/Excel KNIGHT -GFR ERPF.csv")
gfr <- gfr %>% select(study_nr, Visit, GFR..mL.min., ERPF..mL.min.)
neth <- full_join(neth, gfr, by = c("study_nr", "Visit"))
neth$time <- ifelse(neth$Visit == 0, 1, 2)
neth$Study.ID <- neth$study_nr
neth$Study.ID <- str_replace(neth$Study.ID, ",", ".")

knight_soma$Study.ID <- str_replace(knight_soma$Study.ID, "MV ", "")
knight_soma$Study.ID <- str_replace(knight_soma$Study.ID, "VM ", "")
check <- full_join(knight_soma, neth, by = c("Study.ID", "time"))
knight_soma <- full_join(knight_soma, neth, by = c("Study.ID", "time"))

# convert uric acid
knight_soma$Plasma_uric_acid <- ifelse(is.na(knight_soma$Plasma_uric_acid), knight_soma$Plasma_uric_acid_mg_dL*59.48, knight_soma$Plasma_uric_acid)

# drop visit variable - use time instead
knight_soma$Visit <- NULL

# remove 3 participants with missing proteomics
knight_soma <- knight_soma %>% filter(!is.na(seq.10000.28))

# calculate change in sex hormones, uric acid, M-value, GFR/EFPF
delta_temp <- knight_soma %>% select(Study.ID, time, testosteron_CU, estradiol_CU, M_value_corrected,
                                Plasma_uric_acid, URklaring, FEUA, GFR..mL.min., ERPF..mL.min.)
delta <- delta_temp %>% arrange(Study.ID, time) %>% group_by(Study.ID) %>% pivot_wider(names_from = time,
                                                                                        values_from = c(testosteron_CU, estradiol_CU, M_value_corrected,
                                                                                                        Plasma_uric_acid, URklaring, FEUA,
                                                                                                        GFR..mL.min., ERPF..mL.min.))
delta$delta_testoseron_CU <- delta$testosteron_CU_2 - delta$testosteron_CU_1
delta$delta_estradiol_CU <- delta$estradiol_CU_2 - delta$estradiol_CU_1
delta$delta_M_value_corrected <- delta$M_value_corrected_2 - delta$M_value_corrected_1
delta$delta_Plasma_uric_acid <- delta$Plasma_uric_acid_2 - delta$Plasma_uric_acid_1
delta$delta_URklaring <- delta$URklaring_2 - delta$URklaring_1
delta$delta_FEUA <- delta$FEUA_2 - delta$FEUA_1
delta$delta_GFR..mL.min. <- delta$GFR..mL.min._2 - delta$GFR..mL.min._1
delta$delta_ERPF..mL.min. <- delta$ERPF..mL.min._2 - delta$ERPF..mL.min._1

# Calculate change in each protein
df_diff <- knight_soma %>%
  arrange(Study.ID, time) %>%
  group_by(Study.ID, group) %>%
  reframe(across(contains("seq"), ~ diff(as.numeric(.x))))
# Merge in changes in other variables
df_diff <- full_join(df_diff, delta, by="Study.ID")

# read in CRC data and create datasets for comparison of KNIGHT to CRC
# follow-up MTF vs CRC F, follow-up FTM vs CRC M
# baseline MTF vs CRC M, baseline FTM vs CRC F
crc_soma <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Clean/soma_harmonized_dataset.csv", na.strings = "")
crc_soma <- crc_soma %>%
  filter(
    study %in% c("CROCODILE"), participation_status == "Participated", group == "Lean Control"
  ) %>%
group_by(record_id, visit) %>%
  summarise(across(where(is.character), ~ last(na.omit(.x))),
    across(where(is.factor), ~ last(na.omit(.x))),
    across(where(is.numeric), ~ mean(.x, na.rm = T)),
    .groups = "drop"
  ) %>%
  mutate_all(~ ifelse(is.nan(.), NA, .))
# Import proteomics data for RH and IMPROVE
load("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Combined SomaScan/analytes.Rdata")
crc_soma <- crc_soma %>% dplyr::select(record_id, visit, sex, contains("seq."))
# Transform
crc_soma[, 4:ncol(crc_soma)] <- lapply(crc_soma[, 4:ncol(crc_soma)], log)
crc_soma$group <- ifelse(crc_soma$sex == "Female", "CRC_F", "CRC_M")
crc_soma$Study.ID <- crc_soma$record_id
crc_soma$record_id <- NULL
crc_soma$sex <- NULL
crc_soma$time <- NA
crc_soma$visit <- NULL
crc_soma <- remove_all_labels(crc_soma)
# combine
knight_crc <- knight_soma %>% select(Study.ID, group, time, contains("seq."))
knight_crc <- remove_all_labels(knight_crc)
knight_crc <- bind_rows(knight_crc,crc_soma)
knight_crc <- knight_crc %>% filter(!is.na(seq.10000.28))
```

```{r, include=FALSE}
#| label: tbl-characteristics
#| tbl-cap: Participant characteristics
#df %>%
#  dplyr::select(
#    SEX, age, ETHN, RACE, SURG, diab, diab_resolved, sbp, dbp, hrate, bfat, bmi,
#    weight, height, UACRATIO, albuminuria, CYSC, visit
#  ) %>%
#  tbl_summary(by = visit, missing_text = "Missing") %>%
#  modify_header(label = "**Visit**") %>%
#  bold_labels() %>%
#  as_kable_extra()
```

# Questions/comments

1)  Converted CO plasma uric acid from mg/dL to umol/L to be on same scale as AMC
2)  Removed 3 participants without proteomic data (572.011, 572.012, 572.019)

# Univariable analyses

## Male to Female

```{r, include=FALSE}
# First MTF
# Limma setup
# Y needs "genes" in rows
y <- df_diff %>%
  filter(group == "MTF") %>%
  dplyr::select(contains("seq")) %>%
  t()
# Design matrix
design_mat <- model.matrix(~1, data = df_diff[df_diff$group == "MTF",])
# Fit
fit <- lmFit(y, design_mat)
fit <- eBayes(fit)
res <- topTable(fit, coef = 1, number = dim(y)[1], sort.by = "p")
res$AptName <- row.names(res)
res$Target <- analytes$Target[match(rownames(res), analytes$AptName)]
res$TargetFullName <- analytes$TargetFullName[match(rownames(res), analytes$AptName)]
res$UniProt <- analytes$UniProt[match(rownames(res), analytes$AptName)]
write.csv(res, file = "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/limma_MTF_results.csv", row.names = F)
write.csv(res, file = "/Users/pylell/Dropbox/KNIGHT/limma_MTF_results.csv", row.names = F)
# Write results for online enrichment
res_for_enrichment <- topTable(fit, coef = 1, number = dim(y)[1], sort.by = "p")
res_for_enrichment <- res_for_enrichment[order(res_for_enrichment$logFC, decreasing = T), ]
res_for_enrichment$UniProt <- analytes$UniProt[match(rownames(res_for_enrichment), analytes$AptName)]
res_for_enrichment <- res_for_enrichment[, c("UniProt", "AveExpr")]
#write.csv(res_for_enrichment, file = "/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Teen Labs/Results/limma_intercept_only_results.csv", row.names = F)
# Table
#kable(res[1:10, ], digits = 3, row.names = F)

top_mtf <- res
top_mtf$AptName <- row.names(top_mtf)
v_mtf <- volcano(top_mtf)
```

```{r, echo=FALSE, warning=FALSE}
v_mtf
ggsave(
  filename = "/Users/pylell/Dropbox/KNIGHT/MTF_volcano.jpeg", plot = v_mtf,
  width = 1600, height = 900, units = "px", scale = 2
)
```

There were `r nrow(res[res$adj.P.Val < 0.05,])` proteins significantly different after p value adjustment. Of these, `r sum(res[res$adj.P.Val < 0.05,]$logFC>0)` were higher on average at the second visit compared to the first, and `r sum(res[res$adj.P.Val < 0.05,]$logFC<0)` were lower. See separate output file for univariate results.

### Gene set enrichment analysis (GSEA) with Reactome

GSEA tests whether proteins in a particular biological pathway are more likely to have a large effect size compared to proteins in other biological pathways.

```{r, include=FALSE}
res$EntrezGeneID <- analytes$EntrezGeneID[match(rownames(res), analytes$AptName)]
de <- res$logFC
names(de) <- res$EntrezGeneID
de <- de[names(de) != ""]
de <- de[!duplicated(names(de))]
de <- sort(de, decreasing = T)
all_prots_gse <- gsePathway(de,
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  verbose = FALSE
)
```

```{r, echo=FALSE, warning=FALSE}
dotplot(all_prots_gse)
```

### Over-representation analysis

ORA tests whether the number of differentially expressed proteins in a pathway is larger than would be expected by chance. GSEA is a more robust analysis, but the advantage of ORA is that pathways can be separated into those that are upregulated and downregulated. A pathway can be both upregulated and downregulated, if some genes are upregulated and others are downregulated.

```{r, include=FALSE}
up <- rownames(res)[res$logFC > 0]
up <- analytes$EntrezGeneID[match(up, analytes$AptName)]
up <- up[up != ""]
down <- rownames(res)[res$logFC < 0]
down <- analytes$EntrezGeneID[match(down, analytes$AptName)]
down <- down[down != ""]
# Reactome enrichment
upreact <- enrichPathway(up)
upreact <- setReadable(upreact, "org.Hs.eg.db", "ENTREZID")
downreact <- enrichPathway(down)
downreact <- setReadable(downreact, "org.Hs.eg.db", "ENTREZID")
```

```{r, echo=FALSE, warning=FALSE}
#| fig-width: 7
#| fig-height: 10
# Plots
updot <- dotplot(upreact) + ggtitle("Upregulated") +
  theme(plot.title = element_text(hjust = 0.5))
downdot <- dotplot(downreact) + ggtitle("Downregulated") +
  theme(plot.title = element_text(hjust = 0.5))
updot
downdot
```

## Female to Male

```{r, include=FALSE}
# First MTF
# Limma setup
# Y needs "genes" in rows
y <- df_diff %>%
  filter(group == "FTM") %>%
  dplyr::select(contains("seq")) %>%
  t()
# Design matrix
design_mat <- model.matrix(~1, data = df_diff[df_diff$group == "FTM",])
# Fit
fit <- lmFit(y, design_mat)
fit <- eBayes(fit)
res <- topTable(fit, coef = 1, number = dim(y)[1], sort.by = "p")
res$AptName <- row.names(res)
res$Target <- analytes$Target[match(rownames(res), analytes$AptName)]
res$TargetFullName <- analytes$TargetFullName[match(rownames(res), analytes$AptName)]
res$UniProt <- analytes$UniProt[match(rownames(res), analytes$AptName)]
write.csv(res, file = "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/limma_FTM_results.csv", row.names = F)
write.csv(res, file = "/Users/pylell/Dropbox/KNIGHT/limma_FTM_results.csv", row.names = F)
# Write results for online enrichment
res_for_enrichment <- topTable(fit, coef = 1, number = dim(y)[1], sort.by = "p")
res_for_enrichment <- res_for_enrichment[order(res_for_enrichment$logFC, decreasing = T), ]
res_for_enrichment$UniProt <- analytes$UniProt[match(rownames(res_for_enrichment), analytes$AptName)]
res_for_enrichment <- res_for_enrichment[, c("UniProt", "AveExpr")]
#write.csv(res_for_enrichment, file = "/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Teen Labs/Results/limma_intercept_only_results.csv", row.names = F)
# Table
#kable(res[1:10, ], digits = 3, row.names = F)

top_ftm <- res
top_ftm$AptName <- row.names(top_ftm)
v_ftm <- volcano(top_ftm, top = 10, overlaps = 10)
```

```{r, echo=FALSE, warning=FALSE}
v_ftm
ggsave(
  filename = "/Users/pylell/Dropbox/KNIGHT/FTM_volcano.jpeg", plot = v_ftm,
  width = 1600, height = 900, units = "px", scale = 2
)
```

There were `r nrow(res[res$adj.P.Val < 0.05,])` proteins significantly different after p value adjustment. Of these, `r sum(res[res$adj.P.Val < 0.05,]$logFC>0)` were higher on average at the second visit compared to the first, and `r sum(res[res$adj.P.Val < 0.05,]$logFC<0)` were lower. See separate output file for univariate results.

### Gene set enrichment analysis (GSEA) with Reactome

GSEA tests whether proteins in a particular biological pathway are more likely to have a large effect size compared to proteins in other biological pathways.

```{r, include=FALSE}
res$EntrezGeneID <- analytes$EntrezGeneID[match(rownames(res), analytes$AptName)]
de <- res$logFC
names(de) <- res$EntrezGeneID
de <- de[names(de) != ""]
de <- de[!duplicated(names(de))]
de <- sort(de, decreasing = T)
all_prots_gse <- gsePathway(de,
  pvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  verbose = FALSE
)
```

```{r, echo=FALSE, warning=FALSE}
dotplot(all_prots_gse)
```

### Over-representation analysis

ORA tests whether the number of differentially expressed proteins in a pathway is larger than would be expected by chance. GSEA is a more robust analysis, but the advantage of ORA is that pathways can be separated into those that are upregulated and downregulated. A pathway can be both upregulated and downregulated, if some genes are upregulated and others are downregulated.

```{r, include=FALSE}
up <- rownames(res)[res$logFC > 0]
up <- analytes$EntrezGeneID[match(up, analytes$AptName)]
up <- up[up != ""]
down <- rownames(res)[res$logFC < 0]
down <- analytes$EntrezGeneID[match(down, analytes$AptName)]
down <- down[down != ""]
# Reactome enrichment
upreact <- enrichPathway(up)
upreact <- setReadable(upreact, "org.Hs.eg.db", "ENTREZID")
downreact <- enrichPathway(down)
downreact <- setReadable(downreact, "org.Hs.eg.db", "ENTREZID")
```

```{r, echo=FALSE, warning=FALSE}
#| fig-width: 7
#| fig-height: 10
updot <- dotplot(upreact) + ggtitle("Upregulated") +
  theme(plot.title = element_text(hjust = 0.5))
downdot <- dotplot(downreact) + ggtitle("Downregulated") +
  theme(plot.title = element_text(hjust = 0.5))
updot 
downdot
```

## Correlations (MTF and FTM combined)

### Change in protein vs. change in testosterone

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_testoseron_CU)
corr_testosterone_CU <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_testosterone_CU_r <- data.frame(spearman_delta_testosterone = (corr_testosterone_CU$r %>% t() ))
corr_testosterone_CU_p <- data.frame(p.value = (corr_testosterone_CU$p.adj %>% t() ))
corr_testosterone_CU_mat <- cbind(corr_testosterone_CU_r, corr_testosterone_CU_p)
colnames(corr_testosterone_CU_mat) <- c("spearman_delta_testosterone", "q.value")

corr_testosterone_CU_mat <- corr_testosterone_CU_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") 
  # column_to_rownames("Target") %>%
  #dplyr::select(spearman_delta_testosterone, p.value, Target)

corr_testosterone_CU_mat$Target_apt <- paste0(corr_testosterone_CU_mat$Target, " (", corr_testosterone_CU_mat$AptName, ")")

corr_testosterone_CU_mat <- corr_testosterone_CU_mat %>%
  column_to_rownames("Target_apt") 

corr_testosterone_CU_mat$Target_apt <- paste0(corr_testosterone_CU_mat$Target, " (", corr_testosterone_CU_mat$AptName, ")")  
  
corr_testosterone_CU_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_testosterone_CU_mat_save_r <- data.frame(spearman_delta_testosterone = (corr_testosterone_CU_mat_save$r %>% t() ))
corr_testosterone_CU_mat_save_p <- data.frame(p.value = (corr_testosterone_CU_mat_save$p.adj %>% t() ))
corr_testosterone_CU_mat_save <- cbind(corr_testosterone_CU_mat_save_r, corr_testosterone_CU_mat_save_p)
colnames(corr_testosterone_CU_mat_save) <- c("spearman_delta_testosterone", "q.value")
corr_testosterone_CU_mat_save <- corr_testosterone_CU_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_testosterone_CU_mat, 
            FC = spearman_delta_testosterone, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in testosterone",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
  
png(height = 1500, width = 2000, file = "//Users/pylell/Dropbox/KNIGHT/testosterone_corr_volcano_plot.png", res = 300)
  plotVolcano_mod_new(data = corr_testosterone_CU_mat, 
            FC = spearman_delta_testosterone, 
            p.value = q.value, 
            labels = Target, 
            label_apt = T, 
            identify = F,
            identify_manual = c("PSA", "BPSA", "LEAP-1",
                                "SAP", "Carbonic anhydrase 6", 
                                "GLDN", "CBLN4", "adiponectin",
                                "IL-1 R4", "RNase 2"),
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_pos_lab = "q < 0.05 (Positive correlation)",
            sig_fc_neg_lab = "q < 0.05 (Negative correlation)") 
dev.off()    
```

### Change in protein vs. change in estradiol

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_estradiol_CU)
corr_estradiol_CU <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_estradiol_CU_r <- data.frame(spearman_delta_estradiol = (corr_estradiol_CU$r %>% t() ))
corr_estradiol_CU_p <- data.frame(p.value = (corr_estradiol_CU$p.adj %>% t() ))
corr_estradiol_CU_mat <- cbind(corr_estradiol_CU_r, corr_estradiol_CU_p)
colnames(corr_estradiol_CU_mat) <- c("spearman_delta_estradiol", "q.value")

corr_estradiol_CU_mat <- corr_estradiol_CU_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") 
  
corr_estradiol_CU_mat$Target_apt <- paste0(corr_estradiol_CU_mat$Target, " (", corr_estradiol_CU_mat$AptName, ")")

corr_estradiol_CU_mat <- corr_estradiol_CU_mat %>%
  column_to_rownames("Target_apt") 

corr_estradiol_CU_mat$Target_apt <- paste0(corr_estradiol_CU_mat$Target, " (", corr_estradiol_CU_mat$AptName, ")")

corr_estradiol_CU_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_estradiol_CU_mat_save_r <- data.frame(spearman_delta_estradiol = (corr_estradiol_CU_mat_save$r %>% t() ))
corr_estradiol_CU_mat_save_p <- data.frame(p.value = (corr_estradiol_CU_mat_save$p.adj %>% t() ))
corr_estradiol_CU_mat_save <- cbind(corr_estradiol_CU_mat_save_r, corr_estradiol_CU_mat_save_p)
colnames(corr_estradiol_CU_mat_save) <- c("spearman_delta_estradiol", "q.value")
corr_estradiol_CU_mat_save <- corr_estradiol_CU_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_estradiol_CU_mat, 
            FC = spearman_delta_estradiol, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in estradiol",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
  
png(height = 1500, width = 2000, file = "//Users/pylell/Dropbox/KNIGHT/estrogen_corr_volcano_plot.png", res = 300)
  plotVolcano_mod_new(data = corr_estradiol_CU_mat, 
            FC = spearman_delta_estradiol, 
            p.value = q.value, 
            labels = Target, 
            label_apt = T, 
            identify = F,
            identify_manual = c("R4RL1", "PSA", "BPSA", "MEIG1",
                                "PADI2", "SIGIRR", "Glycoprotein hormones a-chain",
                                "BCAT2", "SPLC2"),
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_pos_lab = "q < 0.05 (Positive correlation)",
            sig_fc_neg_lab = "q < 0.05 (Negative correlation)") 
dev.off()    
```

### Change in protein vs. change in M-value

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_M_value_corrected)
corr_M_value_corrected <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_M_value_corrected_r <- data.frame(spearman_delta_M_value_corrected = (corr_M_value_corrected$r %>% t() ))
corr_M_value_corrected_p <- data.frame(p.value = (corr_M_value_corrected$p.adj %>% t() ))
corr_M_value_corrected_mat <- cbind(corr_M_value_corrected_r, corr_M_value_corrected_p)
colnames(corr_M_value_corrected_mat) <- c("spearman_delta_M_value_corrected", "q.value")

corr_M_value_corrected_mat <- corr_M_value_corrected_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") %>%
  # column_to_rownames("Target") %>%
  dplyr::select(spearman_delta_M_value_corrected, q.value, Target)

corr_M_value_corrected_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_M_value_corrected_mat_save_r <- data.frame(spearman_delta_M_value_corrected = (corr_M_value_corrected_mat_save$r %>% t() ))
corr_M_value_corrected_mat_save_p <- data.frame(p.value = (corr_M_value_corrected_mat_save$p.adj %>% t() ))
corr_M_value_corrected_mat_save <- cbind(corr_M_value_corrected_mat_save_r, corr_M_value_corrected_mat_save_p)
colnames(corr_M_value_corrected_mat_save) <- c("spearman_delta_M_value_corrected", "q.value")
corr_M_value_corrected_mat_save <- corr_M_value_corrected_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_M_value_corrected_mat, 
            FC = spearman_delta_M_value_corrected, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in M-value corrected",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
```

### Change in protein vs. change in plasma uric acid

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_Plasma_uric_acid)
corr_Plasma_uric_acid <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_Plasma_uric_acid_r <- data.frame(spearman_delta_Plasma_uric_acid = (corr_Plasma_uric_acid$r %>% t() ))
corr_Plasma_uric_acid_p <- data.frame(p.value = (corr_Plasma_uric_acid$p.adj %>% t() ))
corr_Plasma_uric_acid_mat <- cbind(corr_Plasma_uric_acid_r, corr_Plasma_uric_acid_p)
colnames(corr_Plasma_uric_acid_mat) <- c("spearman_delta_Plasma_uric_acid", "q.value")

corr_Plasma_uric_acid_mat <- corr_Plasma_uric_acid_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") %>%
  # column_to_rownames("Target") %>%
  dplyr::select(spearman_delta_Plasma_uric_acid, q.value, Target)

corr_Plasma_uric_acid_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_Plasma_uric_acid_mat_save_r <- data.frame(spearman_delta_Plasma_uric_acid = (corr_Plasma_uric_acid_mat_save$r %>% t() ))
corr_Plasma_uric_acid_mat_save_p <- data.frame(p.value = (corr_Plasma_uric_acid_mat_save$p.adj %>% t() ))
corr_Plasma_uric_acid_mat_save <- cbind(corr_Plasma_uric_acid_mat_save_r, corr_Plasma_uric_acid_mat_save_p)
colnames(corr_Plasma_uric_acid_mat_save) <- c("spearman_delta_Plasma_uric_acid", "q.value")
corr_Plasma_uric_acid_mat_save <- corr_Plasma_uric_acid_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_Plasma_uric_acid_mat, 
            FC = spearman_delta_Plasma_uric_acid, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in plasma uric acid",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
```

### Change in protein vs. change in URklaring

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_URklaring)
corr_URklaring <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_URklaring_r <- data.frame(spearman_delta_URklaring = (corr_URklaring$r %>% t() ))
corr_URklaring_p <- data.frame(p.value = (corr_URklaring$p.adj %>% t() ))
corr_URklaring_mat <- cbind(corr_URklaring_r, corr_URklaring_p)
colnames(corr_URklaring_mat) <- c("spearman_delta_URklaring", "q.value")

corr_URklaring_mat <- corr_URklaring_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") %>%
  # column_to_rownames("Target") %>%
  dplyr::select(spearman_delta_URklaring, q.value, Target)

corr_URklaring_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_URklaring_mat_save_r <- data.frame(spearman_delta_URklaring = (corr_URklaring_mat_save$r %>% t() ))
corr_URklaring_mat_save_p <- data.frame(p.value = (corr_URklaring_mat_save$p.adj %>% t() ))
corr_URklaring_mat_save <- cbind(corr_URklaring_mat_save_r, corr_URklaring_mat_save_p)
colnames(corr_URklaring_mat_save) <- c("spearman_delta_URklaring", "q.value")
corr_URklaring_mat_save <- corr_URklaring_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_URklaring_mat, 
            FC = spearman_delta_URklaring, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in URklaring",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
```

### Change in protein vs. change in FEUA

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_FEUA)
corr_FEUA <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_FEUA_r <- data.frame(spearman_delta_FEUA = (corr_FEUA$r %>% t() ))
corr_FEUA_p <- data.frame(p.value = (corr_FEUA$p.adj %>% t() ))
corr_FEUA_mat <- cbind(corr_FEUA_r, corr_FEUA_p)
colnames(corr_FEUA_mat) <- c("spearman_delta_FEUA", "q.value")

corr_FEUA_mat <- corr_FEUA_mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") %>%
  # column_to_rownames("Target") %>%
  dplyr::select(spearman_delta_FEUA, q.value, Target)

corr_FEUA_mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_FEUA_mat_save_r <- data.frame(spearman_delta_FEUA = (corr_FEUA_mat_save$r %>% t() ))
corr_FEUA_mat_save_p <- data.frame(p.value = (corr_FEUA_mat_save$p.adj %>% t() ))
corr_FEUA_mat_save <- cbind(corr_FEUA_mat_save_r, corr_FEUA_mat_save_p)
colnames(corr_FEUA_mat_save) <- c("spearman_delta_FEUA", "q.value")
corr_FEUA_mat_save <- corr_FEUA_mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_FEUA_mat, 
            FC = spearman_delta_FEUA, 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in FEUA",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
```

### Change in protein vs. change in GFR

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_GFR..mL.min.)
corr_GFR..mL.min. <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_GFR..mL.min._r <- data.frame(spearman_delta_GFR..mL.min. = (corr_GFR..mL.min.$r %>% t() ))
corr_GFR..mL.min._p <- data.frame(p.value = (corr_GFR..mL.min.$p.adj %>% t() ))
corr_GFR..mL.min._mat <- cbind(corr_GFR..mL.min._r, corr_GFR..mL.min._p)
colnames(corr_GFR..mL.min._mat) <- c("spearman_delta_GFR..mL.min.", "q.value")

corr_GFR..mL.min._mat <- corr_GFR..mL.min._mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") %>%
  mutate(fullname = paste0(Target, ".", AptName)) 
  
corr_GFR..mL.min._mat$Target_apt <- paste0(corr_GFR..mL.min._mat$Target, " (", corr_GFR..mL.min._mat$AptName, ")")
  
corr_GFR..mL.min._mat <- corr_GFR..mL.min._mat %>%
  column_to_rownames("Target_apt") 
  
corr_GFR..mL.min._mat$Target_apt <- paste0(corr_GFR..mL.min._mat$Target, " (", corr_GFR..mL.min._mat$AptName, ")")
  
  #%>%
  #dplyr::select(spearman_delta_GFR..mL.min., p.value, Target, Target_apt)

corr_GFR..mL.min._mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_GFR..mL.min._mat_save_r <- data.frame(spearman_delta_GFR..mL.min. = (corr_GFR..mL.min._mat_save$r %>% t() ))
corr_GFR..mL.min._mat_save_p <- data.frame(p.value = (corr_GFR..mL.min._mat_save$p.adj %>% t() ))
corr_GFR..mL.min._mat_save <- cbind(corr_GFR..mL.min._mat_save_r, corr_GFR..mL.min._mat_save_p)
colnames(corr_GFR..mL.min._mat_save) <- c("spearman_delta_GFR..mL.min.", "q.value")
corr_GFR..mL.min._mat_save <- corr_GFR..mL.min._mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_GFR..mL.min._mat, 
            FC = spearman_delta_GFR..mL.min., 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in GFR..mL.min.",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
 
png(height = 1500, width = 2000, file = "//Users/pylell/Dropbox/KNIGHT/GFR_corr_volcano_plot.png", res = 300)
  plotVolcano_mod_new(data = corr_GFR..mL.min._mat, 
            FC = spearman_delta_GFR..mL.min., 
            p.value = q.value, 
            labels = Target, 
            label_apt = T, 
            identify = F,
            identify_manual = c("SFRP4", "MMP-2", "SCGF-beta", "PDGFRA", "FSTL1", "RSPO1", "TIMP-2",
                                "C1QT4", "Cadherin-11:ECD", "DKK3"),
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_pos_lab = "q < 0.05 (Positive correlation)",
            sig_fc_neg_lab = "q < 0.05 (Negative correlation)") 
dev.off()  
```

### Change in protein vs. change in ERPF

```{r, include=FALSE}
y <- df_diff %>%
  dplyr::select(contains("seq")) 
x <- df_diff %>% 
  dplyr::select(delta_ERPF..mL.min.)
corr_ERPF..mL.min. <- corr.test(x = x, y = y, method = "spearman", adjust = "BH")
corr_ERPF..mL.min._r <- data.frame(spearman_delta_ERPF..mL.min. = (corr_ERPF..mL.min.$r %>% t() ))
corr_ERPF..mL.min._p <- data.frame(p.value = (corr_ERPF..mL.min.$p.adj %>% t() ))
corr_ERPF..mL.min._mat <- cbind(corr_ERPF..mL.min._r, corr_ERPF..mL.min._p)
colnames(corr_ERPF..mL.min._mat) <- c("spearman_delta_ERPF..mL.min.", "q.value")

corr_ERPF..mL.min._mat <- corr_ERPF..mL.min._mat %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName") 
  
corr_ERPF..mL.min._mat$Target_apt <- paste0(corr_ERPF..mL.min._mat$Target, " (", corr_ERPF..mL.min._mat$AptName, ")")

corr_ERPF..mL.min._mat <- corr_ERPF..mL.min._mat %>%
  column_to_rownames("Target_apt") 

corr_ERPF..mL.min._mat$Target_apt <- paste0(corr_ERPF..mL.min._mat$Target, " (", corr_ERPF..mL.min._mat$AptName, ")")

corr_ERPF..mL.min._mat_save <- corr.test(x = x, y = y, method="spearman", adjust="BH")
corr_ERPF..mL.min._mat_save_r <- data.frame(spearman_delta_ERPF..mL.min. = (corr_ERPF..mL.min._mat_save$r %>% t() ))
corr_ERPF..mL.min._mat_save_p <- data.frame(p.value = (corr_ERPF..mL.min._mat_save$p.adj %>% t() ))
corr_ERPF..mL.min._mat_save <- cbind(corr_ERPF..mL.min._mat_save_r, corr_ERPF..mL.min._mat_save_p)
colnames(corr_ERPF..mL.min._mat_save) <- c("spearman_delta_ERPF..mL.min.", "q.value")
corr_ERPF..mL.min._mat_save <- corr_ERPF..mL.min._mat_save %>%
  rownames_to_column(var = "AptName") %>%
  left_join(analytes, by = "AptName")

```

```{r, echo = F}
plotVolcano_mod(corr_ERPF..mL.min._mat, 
            FC = spearman_delta_ERPF..mL.min., 
            p.value = q.value, 
            label = Target, 
            identify = T,
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "Change in protein vs. change in ERPF..mL.min.",
            pt.size = 1,
            fc_lab = "q > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_lab = "q < 0.05") 
  
png(height = 1500, width = 2000, file = "//Users/pylell/Dropbox/KNIGHT/ERPF_corr_volcano_plot.png", res = 300)
  plotVolcano_mod_new(data = corr_ERPF..mL.min._mat, 
            FC = spearman_delta_ERPF..mL.min., 
            p.value = q.value, 
            labels = Target, 
            label_apt = T, 
            identify = F,
            identify_manual = c("GFRAL", "MLRS", "A1CF", "VEGF-B", "Apo L1", "UR2R", "FLRT3:CD",
                                "PSA", "DCA12", "REG3G"),
            fc.cutoff = 0,
            cutoff = 0.05,
            x.lab = "Correlation",
            main = "",
            pt.size = 1,
            fc_lab = "p > 0.05",
            fc_lab_col = "#dad7cd",
            sig_fc_pos_lab = "q < 0.05 (Positive correlation)",
            sig_fc_neg_lab = "q < 0.05 (Negative correlation)") 
dev.off()  
```

```{r, echo = F}
# write correlation results to file
wb <- createWorkbook()
addWorksheet(wb,"Change in testosterone")
writeData(wb,"Change in testosterone",corr_testosterone_CU_mat_save,rowNames = F)
addWorksheet(wb,"Change in estradiol")
writeData(wb,"Change in estradiol",corr_estradiol_CU_mat_save,rowNames = F)
addWorksheet(wb,"Change in M-value corrected")
writeData(wb,"Change in M-value corrected",corr_M_value_corrected_mat_save,rowNames = F)
addWorksheet(wb,"Change in plasma uric acid")
writeData(wb,"Change in plasma uric acid",corr_Plasma_uric_acid_mat_save,rowNames = F)
addWorksheet(wb,"Change in URklaring")
writeData(wb,"Change in URklaring",corr_URklaring_mat_save,rowNames = F)
addWorksheet(wb,"Change in FEUA")
writeData(wb,"Change in FEUA",corr_FEUA_mat_save,rowNames = F)
addWorksheet(wb,"Change in GFR")
writeData(wb,"Change in GFR",corr_GFR..mL.min._mat_save,rowNames = F)
addWorksheet(wb,"Change in ERPF")
writeData(wb,"Change in ERPF",corr_ERPF..mL.min._mat_save,rowNames = F)
saveWorkbook(wb,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/KNIGHT_correlations.xlsx",overwrite = TRUE)
saveWorkbook(wb,"/Users/pylell/Dropbox/KNIGHT/KNIGHT_correlations.xlsx",overwrite = TRUE)
```

```{r, echo = F}
# write separate files for IPA
ipa <- createWorkbook()
addWorksheet(ipa,"Change in testosterone")
writeData(ipa,"Change in testosterone",corr_testosterone_CU_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_testosterone.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in estradiol")
writeData(ipa,"Change in estradiol",corr_estradiol_CU_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_estradiol.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in M-value corrected")
writeData(ipa,"Change in M-value corrected",corr_M_value_corrected_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_M-value.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in plasma uric acid")
writeData(ipa,"Change in plasma uric acid",corr_Plasma_uric_acid_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_plasma_uric_acid.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in URklaring")
writeData(ipa,"Change in URklaring",corr_URklaring_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_URklaring.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in FEUA")
writeData(ipa,"Change in FEUA",corr_FEUA_mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_FEUA.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in GFR")
writeData(ipa,"Change in GFR",corr_GFR..mL.min._mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_GFR.xlsx",overwrite = TRUE)

ipa <- createWorkbook()
addWorksheet(ipa,"Change in ERPF")
writeData(ipa,"Change in ERPF",corr_ERPF..mL.min._mat_save,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/KNIGHT_correlations_ERPF.xlsx",overwrite = TRUE)
```

## Comparison to CROCODILE

### Baseline KNIGHT MTF vs. CROCODILE M

```{r, include=FALSE}
kMTF_CRCM <- knight_crc %>% filter(
  (is.na(time) | time == 1), group %in% c("MTF", "CRC_M")
)  
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(kMTF_CRCM))
  
kMTF_CRCM_contrast <- ifelse(kMTF_CRCM$group=="MTF",1,0)
kMTF_CRCM_contrast <- cbind(rep(1,nrow(kMTF_CRCM)),kMTF_CRCM_contrast)
# moderated t-tests with and without FDR adjustment
ymat <- t(kMTF_CRCM[,seq])
fit <- lmFit(ymat,kMTF_CRCM_contrast)
fit <- eBayes(fit)
results_kMTF_CRCM <- topTable(fit,coef = 2,number = nrow(ymat))
results_kMTF_CRCM$AptName <- row.names(results_kMTF_CRCM)
results_kMTF_CRCM <- merge(results_kMTF_CRCM,analytes,by="AptName",all.x = T, all.y = F)
results_kMTF_CRCM <- results_kMTF_CRCM[order(results_kMTF_CRCM$P.Value),] 
ymat <- NULL
fit <- NULL
```

### Baseline KNIGHT FTM vs. CROCODILE F

```{r, include=FALSE}
kFTM_CRCF <- knight_crc %>% filter(
  (is.na(time) | time == 1), group %in% c("FTM", "CRC_F")
)  
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(kFTM_CRCF))
  
kFTM_CRCF_contrast <- ifelse(kFTM_CRCF$group=="FTM",1,0)
kFTM_CRCF_contrast <- cbind(rep(1,nrow(kFTM_CRCF)),kFTM_CRCF_contrast)
# moderated t-tests with and without FDR adjustment
ymat <- t(kFTM_CRCF[,seq])
fit <- lmFit(ymat,kFTM_CRCF_contrast)
fit <- eBayes(fit)
results_kFTM_CRCF <- topTable(fit,coef = 2,number = nrow(ymat))
results_kFTM_CRCF$AptName <- row.names(results_kFTM_CRCF)
results_kFTM_CRCF <- merge(results_kFTM_CRCF,analytes,by="AptName",all.x = T, all.y = F)
results_kFTM_CRCF <- results_kFTM_CRCF[order(results_kFTM_CRCF$P.Value),] 
ymat <- NULL
fit <- NULL
```

### Follow-up KNIGHT MTF vs. CROCODILE F

```{r, include=FALSE}
kMTF_CRCF <- knight_crc %>% filter(
  (is.na(time) | time == 2), group %in% c("MTF", "CRC_F")
)  
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(kMTF_CRCF))
  
kMTF_CRCF_contrast <- ifelse(kMTF_CRCF$group=="MTF",1,0)
kMTF_CRCF_contrast <- cbind(rep(1,nrow(kMTF_CRCF)),kMTF_CRCF_contrast)
# moderated t-tests with and without FDR adjustment
ymat <- t(kMTF_CRCF[,seq])
fit <- lmFit(ymat,kMTF_CRCF_contrast)
fit <- eBayes(fit)
results_kMTF_CRCF <- topTable(fit,coef = 2,number = nrow(ymat))
results_kMTF_CRCF$AptName <- row.names(results_kMTF_CRCF)
results_kMTF_CRCF <- merge(results_kMTF_CRCF,analytes,by="AptName",all.x = T, all.y = F)
results_kMTF_CRCF <- results_kMTF_CRCF[order(results_kMTF_CRCF$P.Value),] 
ymat <- NULL
fit <- NULL
```

### Follow-up KNIGHT FTM vs. CROCODILE M

```{r, include=FALSE}
kFTM_CRCM <- knight_crc %>% filter(
  (is.na(time) | time == 2), group %in% c("FTM", "CRC_M")
)  
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(kFTM_CRCM))
  
kFTM_CRCM_contrast <- ifelse(kFTM_CRCM$group=="FTM",1,0)
kFTM_CRCM_contrast <- cbind(rep(1,nrow(kFTM_CRCM)),kFTM_CRCM_contrast)
# moderated t-tests with and without FDR adjustment
ymat <- t(kFTM_CRCM[,seq])
fit <- lmFit(ymat,kFTM_CRCM_contrast)
fit <- eBayes(fit)
results_kFTM_CRCM <- topTable(fit,coef = 2,number = nrow(ymat))
results_kFTM_CRCM$AptName <- row.names(results_kFTM_CRCM)
results_kFTM_CRCM <- merge(results_kFTM_CRCM,analytes,by="AptName",all.x = T, all.y = F)
results_kFTM_CRCM <- results_kFTM_CRCM[order(results_kFTM_CRCM$P.Value),] 
ymat <- NULL
fit <- NULL
```

```{r, echo = F}
# write CRC comparisons results to file
wb <- createWorkbook()
addWorksheet(wb,"Baseline MTF v CRC M")
writeData(wb,"Baseline MTF v CRC M",results_kMTF_CRCM,rowNames = F)
addWorksheet(wb,"Baseline FTM v CRC F")
writeData(wb,"Baseline FTM v CRC F",results_kFTM_CRCF,rowNames = F)
addWorksheet(wb,"FUP MTF v CRC F")
writeData(wb,"FUP MTF v CRC F",results_kMTF_CRCF,rowNames = F)
addWorksheet(wb,"FUP FTM v CRC M")
writeData(wb,"FUP FTM v CRC M",results_kFTM_CRCM,rowNames = F)
saveWorkbook(wb,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/KNIGHT_vs_CRC_comparisons.xlsx",overwrite = TRUE)
saveWorkbook(wb,"/Users/pylell/Dropbox/KNIGHT/KNIGHT_vs_CRC_comparisons.xlsx",overwrite = TRUE)
```

```{r, echo = F}
# write separate files for IPA
ipa <- createWorkbook()
addWorksheet(ipa,"results_kMTF_CRCM")
writeData(ipa,"results_kMTF_CRCM",results_kMTF_CRCM,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/results_kMTF_CRCM.xlsx",overwrite = TRUE)
  
ipa <- createWorkbook()
addWorksheet(ipa,"results_kFTM_CRCF")
writeData(ipa,"results_kFTM_CRCF",results_kFTM_CRCF,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/results_kFTM_CRCF.xlsx",overwrite = TRUE)
  
ipa <- createWorkbook()
addWorksheet(ipa,"results_kMTF_CRCF")
writeData(ipa,"results_kMTF_CRCF",results_kMTF_CRCF,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/results_kMTF_CRCF.xlsx",overwrite = TRUE)  

ipa <- createWorkbook()
addWorksheet(ipa,"results_kFTM_CRCM")
writeData(ipa,"results_kFTM_CRCM",results_kFTM_CRCM,rowNames = F)
saveWorkbook(ipa,"/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/IPA/results_kFTM_CRCM.xlsx",overwrite = TRUE) 


```

# Elastic net analysis

## MTF vs. FTM

### Selected proteins

```{r, echo = F, warning = F, message=FALSE}
# First find top 100 proteins that distinguish MTF and FTM
# Limma setup
# Y needs "genes" in rows
y <- df_diff %>%
  dplyr::select(contains("seq")) %>%
  t()
# Design matrix
design_mat <- ifelse(df_diff$group == "MTF", 1, 0)
design_mat <- cbind(rep(1,nrow(df_diff)),design_mat)
# Fit
fit <- lmFit(y, design_mat)
fit <- eBayes(fit)
res <- topTable(fit, coef = 1, number = dim(y)[1], sort.by = "p")
res$AptName <- row.names(res)
res$Target <- analytes$Target[match(rownames(res), analytes$AptName)]
res$TargetFullName <- analytes$TargetFullName[match(rownames(res), analytes$AptName)]
res$UniProt <- analytes$UniProt[match(rownames(res), analytes$AptName)]
write.csv(res, file = "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/KNIGHT/Results/limma_MTF_vs_FTM_results.csv", row.names = F)
write.csv(res, file = "/Users/pylell/Dropbox/KNIGHT/limma_MTF_vs_FTM__results.csv", row.names = F)
MTF_vs_FTM_keep = res
MTF_vs_FTM_keep <- arrange(MTF_vs_FTM_keep,adj.P.Val)
MTF_vs_FTM_drop <- MTF_vs_FTM_keep[101:nrow(MTF_vs_FTM_keep),"AptName"]
MTF_vs_FTM_drop <- as.data.frame(MTF_vs_FTM_drop)
rownames(MTF_vs_FTM_drop) <- MTF_vs_FTM_drop$MTF_vs_FTM_drop
MTF_vs_FTM_drop <- as.data.frame(t(MTF_vs_FTM_drop))
MTF_vs_FTM <- df_diff %>% dplyr::select(-colnames(MTF_vs_FTM_drop))  
  
MTF_vs_FTM$group01 <- ifelse(MTF_vs_FTM$group == "MTF", 1, 0)
seq <- is_seq(names(MTF_vs_FTM))
elasticnet1 <- easy_elasticnet(data = MTF_vs_FTM,outcome = "group01",
                           predictors = colnames(MTF_vs_FTM[,seq]), out = "1se.error",
                           model_type = "binomial", cv_method="loo")
retained_vars = analytes[analytes$AptName %in% elasticnet1, c("AptName","Target","TargetFullName")]
kable(retained_vars)
```

### Refit final model

Model would not converge

```{r, echo = F, warning = F, message=FALSE}
# logistic regression model will not converge   
#form = as.formula(paste0("group01~",paste0(elasticnet1,collapse = "+")))
#mod = glm(formula = form, data = MTF_vs_FTM, family = "binomial")
#kable(tidy(mod, exponentiate = TRUE, conf.int = TRUE),digits = 3)    
    
```

## GFR - MTF and FTM combined

### Selected proteins

```{r, echo = F, warning = F, message=FALSE}
# Similar procedure for change in GFR with groups combined
seq <- is_seq(names(df_diff))
elasticnet2 <- easy_elasticnet(data = df_diff,outcome = "delta_GFR..mL.min.",
                           predictors = colnames(df_diff[,seq]), out = "1se.error",
                           model_type = "gaussian", cv_method="loo")
retained_vars = analytes[analytes$AptName %in% elasticnet2, c("AptName","Target","TargetFullName")]
kable(retained_vars)
```

### Refit final model - with interaction

Note: 95% CIs on parameter estimates are quite wide, indicating insufficient power to estimate interaction terms.

```{r, echo = F, warning = F, message=FALSE}
# Try adding interaction term
seq <- is_seq(names(df_diff))
elasticnet2 <- easy_elasticnet(data = df_diff,outcome = "delta_GFR..mL.min.",
                           predictors = colnames(df_diff[,seq]), out = "1se.error",
                           model_type = "gaussian", cv_method="loo")
retained_vars = analytes[analytes$AptName %in% elasticnet2, c("AptName","Target","TargetFullName")]
 
form = as.formula(paste0("delta_GFR..mL.min.~",paste0(elasticnet2,collapse = "+"), paste0("+ group*"),
  paste0(elasticnet2, collapse = "+ group*")))
mod = lm(formula = form, data = df_diff)
kable(tidy(mod, exponentiate = TRUE, conf.int = TRUE),digits = 3)    
```

### Refit final model - no interaction

```{r, echo = F, warning = F, message=FALSE}
form = as.formula(paste0("delta_GFR..mL.min.~",paste0(elasticnet2,collapse = "+")))
mod = lm(formula = form, data = df_diff)
kable(tidy(mod, exponentiate = TRUE, conf.int = TRUE),digits = 3)   
```
