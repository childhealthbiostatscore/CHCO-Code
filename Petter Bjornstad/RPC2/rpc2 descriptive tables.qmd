---
title: "RPC2 Descriptive analysis"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r libraries, echo=F, include = F}
library(tidyverse)
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(readxl)
library(aws.s3)
library(jsonlite)
source("/Users/choiyej/GitHub/YC_CHCO/R Functions/label_harmonized_function.R")
```


```{r}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}

## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```


```{r}
harm_dat <- read.csv(file.path(root_path, "Data Harmonization/Data Clean/harmonized_dataset.csv"), na.strings = "")

rpc2_dat <- harm_dat %>%
  filter(study %in% c("RPC2")) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit))
```



```{r echo = F}
# REDCap token for RPC2
api_tok <- read.csv("/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/api_tokens.csv")

rpc2_tok <- api_tok[api_tok$Study == "RPC2",]$Token
# uri for REDCap
uri <- "https://redcap.ucdenver.edu/api/"
# read from REDCap
rpc2 <- redcap_read(redcap_uri = uri, token = rpc2_tok)$data
rpc2_meta <- redcap_metadata_read(redcap_uri = uri, token = rpc2_tok)$data
rpc2_lab <- rpc2_meta %>%
  filter(form_name == "labs") %>%
  filter(is.na(select_choices_or_calculations))
rpc2_lab_names <- rpc2_lab$field_name

rpc2_subset_epic <- read.csv("/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Exports/rpc2_biopsy_meds.csv") %>%
  dplyr::summarise(across(everything(), ~ ifelse(all(is.na(.x)), NA, first(na.omit(.x)))),
                   .by = subject_id) 

rpc2_dat <- rpc2 %>%
  rowwise() %>%
  dplyr::mutate(gender = case_when(gender == 0 ~ "Female", 
                            gender == 1 ~ "Male", 
                            gender == 2 ~ "Other"),
         race = case_when(sum(c_across(all_of(race_vars))) > 1 ~ "More than one",
                          race___1 == 1 ~ "American Indian or Alaskan Native",
                          race___2 == 1 ~ "Asian",
                          race___3 == 1 ~ "Hawaiian or Pacific Islander",
                          race___4 == 1 ~ "Black or African American",
                          race___5 == 1 ~ "White",
                          race___6 == 1 ~ "Unknown",
                          race___7 == 1 ~ "Other"),
         ethnicity = case_when(ethnicity___1 == 1 ~ "Hispanic",
                               ethnicity___2 == 1 ~ "Non-Hispanic",
                               ethnicity___3 == 1 ~ "Unknown/Not Reported"),
         group = case_when(diabetes_hx_type == 1 ~ "Type 1 Diabetes",
                           diabetes_hx_type == 2 ~ "Type 2 Diabetes"),
         across(contains("date"), as.character),
         diagnosis = as.character(diagnosis),
         surgery_hx_end = as.character(surgery_hx_end),
         medstart = as.character(medstart),
         medstop = as.character(medstop),
         dob = as.character(dob),
         avg_asl = mean(asl_right, asl_left, na.rm = T),
         avg_adc = mean(adc_right, adc_left, na.rm = T),
         tkv = sum(c(volume_right, volume_left), na.rm = F),
         avg_bl_c = mean(c(bold_r_bl_cortex, bold_l_bl_cortex), na.rm = T),
         avg_bl_k = mean(c(bold_r_bl_kidney, bold_l_bl_kidney), na.rm = T)) %>%
  ungroup() %>%
  dplyr::summarise(across(everything(), ~ ifelse(all(is.na(.x)), NA, first(na.omit(.x)))),
                   .by = subject_id) 

```

```{r echo = F}
summary(arsenal::tableby(~age + sex + race + ethnicity + group + weight + height + bmi + 
                           sbp + dbp + map + chol_base + hba1c + eGFR_CKD_epi + kwt(acr_u, "Nmiss", "median", "q1q3"), data = rpc2_dat))
```

```{r echo = F}
# BOLD MRI
summary(arsenal::tableby(~avg_asl + avg_adc + tkv + avg_bl_c + avg_bl_k, data = rpc2_dat))
```

As of 1/28/25:
11 unique participants with biopsy, 3 with repeat biopsy? (redcap)
12 unique participants with biopsy, 9 with repeat biopsy? (spreadsheet)

```{r echo = F}
# Baseline meds for those with biopsies
med_vars <- rpc2_subset_epic %>%
  select(ends_with("_1"), -kidneybx_1) %>%
  names()

# Construct the formula
formula <- reformulate(med_vars)

summary(arsenal::tableby(formula, data = rpc2_subset_epic))
```

