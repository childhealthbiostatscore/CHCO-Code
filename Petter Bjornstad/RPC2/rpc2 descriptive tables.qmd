---
title: "RPC2 Descriptive analysis"
author: "Ye Ji Choi"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    embed-resources: true
---

```{r libraries, echo=F, include = F}
library(tidyverse)
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(readxl)
library(aws.s3)
library(jsonlite)
source("/Users/choiyej/GitHub/YC_CHCO/R Functions/label_harmonized_function.R")
```


```{r}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}

## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```


```{r}
harm_dat <- read.csv(file.path(root_path, "Data Harmonization/Data Clean/harmonized_dataset.csv"), na.strings = "")

rpc2_dat <- harm_dat %>%
  filter(study %in% c("RPC2")) %>%
  mutate(visit = case_when(visit == "screening" ~ "baseline", T ~ visit)) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit))

hc_dat <- harm_dat %>%
  filter(study == "CROCODILE" & group == "Lean Control") %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit))

# read in biopsy master spreadsheet (updated real time)
biopsy_master <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/Biopsy master tracker.xlsx", skip = 2) 
colnames(biopsy_master) <- gsub(" ", "_", colnames(biopsy_master))  # Replace spaces with underscores
colnames(biopsy_master) <- gsub("/", "_", colnames(biopsy_master))  # Replace slashes with underscores
colnames(biopsy_master) <- gsub("\\(", "_", colnames(biopsy_master))  # Replace opening parentheses with underscores
colnames(biopsy_master) <- gsub("\\)", "", colnames(biopsy_master))  # Remove closing parentheses
biopsy_master <- biopsy_master %>%
  dplyr::rename(record_id = Study_ID,
                visit = Visit_ID) %>%
  mutate(visit = case_when(Study == "ATTEMPT" ~ visit,
                           Study == "REMODEL" ~ visit, 
                           Study == "IMPROVE" & visit == "4M" ~ "3_months_post_surgery",
                           visit == "12M" ~ "12_months_post_surgery",
                           visit == "Follow-up" ~ "follow-up",
                           T ~ "baseline"),
         record_id = case_when(startsWith(Coenroll_ID__Same_visit_only, "RPC") & !is.na(Coenroll_ID__Same_visit_only) ~ Coenroll_ID__Same_visit_only,
                               T ~ record_id),
         Study = case_when(startsWith(Coenroll_ID__Same_visit_only, "RPC") & !is.na(Coenroll_ID__Same_visit_only) ~ "RPC2",
                            T ~ Study))

biopsy_master_rpc2 <- biopsy_master %>%
  filter(Study == "RPC2")
```


```{r echo = F}
# biopsy in at least baseline
rpc_bx_dat <- subset(rpc2_dat, visit %in% c("baseline", "post_treatment") & record_id %in% biopsy_master_rpc2$record_id)

summary(arsenal::tableby(visit ~ age + sex + race + ethnicity + group + weight + height + bmi + 
                           sbp + dbp + map + chol_base + ldl + hdl + hba1c + kwt(triglycerides, "Nmiss", "medianq1q3") + 
                           eGFR_CKD_epi + kwt(acr_u, "Nmiss", "median", "q1q3") + 
                           gfr_raw_plasma + gfr_bsa_plasma + erpf_raw_plasma + erpf_bsa_plasma +
                           avg_pcascl + avg_c_adc + total_kidney_volume_ml + avg_c_r2 + avg_k_r2, 
                         data = rpc_bx_dat),
        digits = 1)

summary(arsenal::paired(visit ~ age  + weight + height + bmi + 
                           sbp + dbp + map + chol_base + ldl + hdl + hba1c + signed.rank(triglycerides, "Nmiss", "medianq1q3") + 
                           eGFR_CKD_epi + signed.rank(acr_u, "Nmiss", "median", "q1q3") + 
                           gfr_raw_plasma + gfr_bsa_plasma + erpf_raw_plasma + erpf_bsa_plasma +
                           avg_pcascl + avg_c_adc + total_kidney_volume_ml + avg_c_r2 + avg_k_r2, 
                         data = rpc_bx_dat, id = record_id),
        digits = 1)

rpc_bx_dat_hc <- rpc2_dat %>%
  filter(visit %in% c("baseline", "post_treatment")) %>%
  rbind(hc_dat) %>%
  mutate(rpc2_group = case_when(group == "Lean Control" ~ "HC",
                                visit == "baseline" ~ "PRE",
                                visit == "post_treatment" ~ "POST"))
rpc_bx_dat_hc$rpc2_group = factor(rpc_bx_dat_hc$rpc2_group, levels = c("PRE", "POST", "HC"))
```

```{r}
rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = avg_pcascl, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "pCASL") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = avg_c_adc, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "Cortical ADC") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = total_kidney_volume_ml, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "TKV") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = avg_c_r2, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "Cortical R2*") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = avg_k_r2, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "Kidney R2*") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")
```

```{r}
rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = gfr_raw_plasma, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "mGFR") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

View(subset(rpc_bx_dat_hc, !is.na(gfr_raw_plasma)))
rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = gfr_bsa_plasma, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "mGFR (BSA)") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = erpf_raw_plasma, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "ERPF") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = erpf_bsa_plasma, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "ERPF (BSA)") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = glomerular_pressure, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "Pglo") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")

rpc_bx_dat_hc %>%
  ggplot(aes(x = rpc2_group, y = ff, fill = rpc2_group)) +
  geom_boxplot(size = 1.4, outliers = F) + 
  geom_line(aes(group = record_id),  color = "#595758", size = 0.3) +
  geom_jitter(size = 2.5, width = 0, color = "#595758", alpha = 0.5) +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        text = element_text(size = 20)) +
  labs(x = NULL, y = "Filtration fraction") +
  # scale_color_manual(values = c("#b5c99a", "#87986a", "#4b8faa"))+
  scale_fill_manual(values = c("#cfe1b9", "#97a97c", "#89c2d9"))+
  geom_vline(xintercept = 2.5, linetype = "dashed", color = "#595758")
```

```{r echo = F}
# regardless of biopsy
rpc_nonbx_dat <- subset(rpc2_dat, visit %in% c("baseline", "post_treatment"))

summary(arsenal::tableby(visit ~ age  + sex + weight + height + bmi + 
                           sbp + dbp + map + chol_base + ldl + hdl + hba1c + kwt(triglycerides, "Nmiss", "medianq1q3") + 
                           eGFR_CKD_epi + kwt(acr_u, "Nmiss", "median", "q1q3") + 
                           gfr_raw_plasma + gfr_bsa_plasma + erpf_raw_plasma + erpf_bsa_plasma +
                           glomerular_pressure + ff + 
                           avg_pcascl + avg_c_adc + total_kidney_volume_ml + avg_c_r2 + avg_k_r2, 
                         data = rpc_nonbx_dat), digits = 1)

summary(arsenal::paired(visit ~ age  + weight + height + bmi + 
                           sbp + dbp + map + chol_base + ldl + hdl + hba1c + signed.rank(triglycerides, "Nmiss", "medianq1q3") + 
                           eGFR_CKD_epi + signed.rank(acr_u, "Nmiss", "median", "q1q3") + 
                           gfr_raw_plasma + gfr_bsa_plasma + erpf_raw_plasma + erpf_bsa_plasma +
                          glomerular_pressure + ff + 
                           avg_pcascl + avg_c_adc + total_kidney_volume_ml + avg_c_r2 + avg_k_r2, 
                         data = rpc_nonbx_dat, id = record_id), digits = 1)
```

```{r echo = F}
# BOLD MRI
summary(arsenal::tableby(~avg_asl + avg_adc + tkv + avg_bl_c + avg_bl_k, data = rpc2_dat))
```

As of 1/28/25:
11 unique participants with biopsy, 3 with repeat biopsy? (redcap)
12 unique participants with biopsy, 9 with repeat biopsy? (spreadsheet)

```{r echo = F}
# Baseline meds for those with biopsies
med_vars <- rpc2_subset_epic %>%
  select(ends_with("_1"), -kidneybx_1) %>%
  names()

# Construct the formula
formula <- reformulate(med_vars)

summary(arsenal::tableby(formula, data = rpc2_subset_epic))
```

