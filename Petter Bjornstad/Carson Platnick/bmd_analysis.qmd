---
title: "BMD Analysis"
author: "Ye Ji Choi, Carson Platnick"
date: "`r lubridate::today()`"
format: 
  html:
    toc: true
    toc-depth: 5
    toc-location: left
    code-fold: true
    theme: default
    page-layout: full
    embed-resources: true
editor: visual
---

```{r, include = F}
library(dplyr)
library(car)
library(tidyr)
library(table1)
library(Hmisc)
library(rstatix)
library(purrr)
library(kableExtra)
library(knitr)
library(arsenal)
library(data.table)
library(ggpubr)
library(smplot2)
library(corrplot)
library(ggpmisc)
library(jtools)
library(interactions)
library(scales)
library(emmeans)
library(multcomp)
library(childsds)
```

```{r, include = F}
# exclude <- c("PAN-97-C","PAN-107-C", "PAN-105-O","PAN-104-T",
#              "PAN-98-O","PAN-103-O", "PAN-102-O", "PAN-101-O",
#              "PAN-75-O", "PAN-94-O", "PAN-100-T", "PAN-99-O", "PAN-96-O",
#              "PNDA 214","PNDA 213","PNDA 212","PNDA-193","PNDA-194","PNDA 205",
#              "PNDA 204","PNDA 203","PNDA-192","PNDA-191","PNDA-189","PNDA-190",
#              "PNDA-188","PNDA-187","PNDA-186","PNDA-184","PNDA-183","PNDA 211",
#              "PNDA 210","PNDA 206","PNDA 207","PNDA 209","PNDA 208","PNDA-185",
#              "PNDA-181","PNDA-182","PNDA-180","PNDA-179","PNDA-178","PNDA 202",
#              "PNDA-177","PNDA-176","PNDA-163", "PNDA-175", "PNDA-173")
# 
# dat <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/Data Clean/harmonized_dataset.csv", na.strings = c(" ", "", "-9999",-9999))
# coenroll_id <- read.csv("/Users/choiyej/GitHub/YC_CHCO/RH2/coenrolled_ids_LR.csv")
# 
# dat <- dat %>%
#   filter(study != "PENGUIN") %>%
#   filter(record_id %nin% exclude) %>%
#   dplyr::summarise(dplyr::across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
#             dplyr::across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
#             .by = record_id) %>%
#   mutate(race = case_when(grepl("&", race) ~ "More Than One",
#                           T ~ race),
#          ethnicity = case_when(grepl("Unknown", ethnicity) ~ "Unknown",
#                                T~ethnicity),
#          race_ethnicity_condensed = case_when(race == "White" &
#                                                 ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
#                                               race == "Black or African American" &
#                                                 ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
#                                               ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
#                                               T ~ "Not Hispanic or Latino Other")) %>%
#   filter(!is.na(dexa_bone_mineral_density)) %>%
#   mutate(participation_status = case_when(is.na(participation_status) ~ "Unknown", T~participation_status)) %>%
#  # filter(participation_status!="Removed") %>%
#   filter(dexa_lean_mass > 1) %>% # Removing a data entry mistake by UW, didn't get resolved in time
#   mutate(smr = case_when(!is.na(breast_tanner) ~ breast_tanner,
#                          testicular_volume == 20 ~ 5,
#                          !is.na(testicular_volume) ~ ceiling(testicular_volume),
#                          !is.na(tan_tveq) ~ tan_tveq,
#                          !is.na(tan_fgd) ~ tan_fgd,
#                          sex == "Female" & age >= 14 & group == "T2D"|
#                            sex == "Male" & age >= 16  & group == "T2D" ~ 5,
#                          sex == "Female" & age >= 16 ~ 5,
#                          sex == "Male" & age >= 17 ~ 5))
# 
# dat$smr <- as.factor(dat$smr)
# 
# write.csv(dat, "/Volumes/Peds Endo/Petter Bjornstad/Carson Platnick/bmd_analysis_data.csv")

dat <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/Carson Platnick/bmd_analysis_data.csv")
dict <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/data_dictionary_master.csv", na.strings = c(" ", "", "-9999",-9999)) %>%
  dplyr::select(variable_name, label)


dat <- dat %>%
  dplyr::mutate(group = case_when(group == "Lean Control" ~ "HWC",
                                  group == "Obese Control" ~ "OC",
                                  group == "Type 1 Diabetes" ~ "T1D",
                                  group == "Type 2 Diabetes" ~ "T2D"))
dat$bmi_sds <- sds(dat$bmi, 
                   age = dat$age, 
                   sex = tolower(dat$sex), 
                   item = "bmi",
                   ref = cdc.ref)
  
dict <- setNames(data.frame(t(dict[ , - 1])), dict[ , 1])
dict <- dict[intersect(names(dat), names(dict))]
dict[setdiff(names(dat), names(dict))] <- ""
Hmisc::label(dat) = dict[match(names(dat), names(dict))]
```

```{r include = F}
# Distribution check
# dat %>%
#   dplyr::select(age, bmi, weight, height, waistcm, hba1c, sbp, dbp, cholesterol, ldl, hdl, triglycerides ,eGFR_fas_cr, eGFR_fas_cr_cysc, acr_u) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
# 
# dat %>%
#   dplyr::select(dexa_lean_kg, dexa_fat_kg, dexa_body_fat, dexa_fat_kg, dexa_trunk_kg, fasting_ffa, ffa_suppression, fasting_insulin, steady_state_insulin, steady_state_cpeptide, raw_m, di, airg, acprg) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
# 
# dat %>%
#   dplyr::select(gfr_raw_plasma,  gfr_bsa_plasma,  erpf_raw_plasma,  erpf_bsa_plasma,  ff,  glomerular_pressure,  ra,  re,  rvr,  total_kidney_volume_ml, pcasl3d_left, pcasl3d_right, adc_left, adc_right, bold_l_bl_cortex, bold_r_bl_cortex,  bold_l_bl_medulla, bold_r_bl_medulla,   fsoc_l_medulla, fsoc_r_medulla, fsoc_l_medulla, fsoc_r_medulla) %>% 
#   gather() %>% 
#   ggplot(aes(value)) +
#     facet_wrap(~ key, scales = "free") +
#     geom_histogram()
```

# Table 1

## All Participants

```{r, include=F}
table_one <- tableby(group ~ diabetes_duration + study + sex + age + race_ethnicity_condensed + ethnicity + kwt(hba1c, "Nmiss", "median", "q1q3", "range") + height + weight + kwt(bmi, "Nmiss", "median", "q1q3", "range") + dexa_body_fat + dexa_fat_kg + dexa_lean_mass + dexa_lean_kg + dexa_bone_mineral_density + map + smr + bmi_sds, data = dat)
```

```{r results='asis'}
#| echo: false
table_one <- summary(table_one, pfootnote = T, digits=3, digits.pct=0, total = F)
table_one
```

# Interactions

## Sex and group

```{r message = F, warning = F, include = F}
#| echo: false
sex_group <- lm(dexa_bone_mineral_density ~ sex*group + sex + group, data = dat)
summ(sex_group, digits = 5)
```

## HbA1c and group (limited to T1D and T2D only)

```{r message = F, warning = F, include = F}
#| echo: false
hba1c_group <- lm(dexa_bone_mineral_density ~ hba1c*group + hba1c + group, data = subset(dat, group == "T1D"| group =="T2D"))
summ(hba1c_group, digits =5)
# interact_plot(hba1c_group, pred = hba1c, modx = group,
#               plot.points = TRUE, linearity.check = TRUE)

ggplot(subset(dat, grepl("Type", group)), aes(hba1c, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = Hmisc::label(dat$hba1c),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F) 

```

## BMI and group

```{r message = F, warning = F}
#| echo: false
bmi_group <- lm(dexa_bone_mineral_density ~ bmi*group + bmi + group, data = dat)
summ(bmi_group, digits =5)
interact_plot(bmi_group, pred = bmi, modx = group,
               plot.points = TRUE, linearity.check = TRUE)

ggplot(dat, aes(bmi, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = Hmisc::label(dat$bmi),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F)

# HWC
K <- matrix(c(0,1,0,0,0,0,0,0), nrow=1)
summary(glht(bmi_group, linfct = K))
confint(glht(bmi_group, linfct = K))
# OC
K <- matrix(c(0,1,0,0,0,1,0,0), nrow=1)
summary(glht(bmi_group, linfct = K))
confint(glht(bmi_group, linfct = K))
# T1D
K <- matrix(c(0,1,0,0,0,0,1,0), nrow=1)
summary(glht(bmi_group, linfct = K))
confint(glht(bmi_group, linfct = K))
# T2D
K <- matrix(c(0,1,0,0,0,0,0,1), nrow=1)
summary(glht(bmi_group, linfct = K))
confint(glht(bmi_group, linfct = K))

# BMI SDS
ggplot(dat, aes(bmi_sds, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = "BMI-SDS",
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F)
```

## Body fat mass (%) and group

```{r message = F, warning = F}
#| echo: false
dexa_body_fat_group <- lm(dexa_bone_mineral_density ~ dexa_body_fat*group + dexa_body_fat + group, data = dat)
summ(dexa_body_fat_group, digits =5)
# interact_plot(dexa_body_fat_group, pred = dexa_body_fat, modx = group,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_body_fat, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F)

# HWC
K <- matrix(c(0,1,0,0,0,0,0,0), nrow=1)
summary(glht(dexa_body_fat_group, linfct = K))
confint(glht(dexa_body_fat_group, linfct = K))
# OC
K <- matrix(c(0,1,0,0,0,1,0,0), nrow=1)
summary(glht(dexa_body_fat_group, linfct = K))
confint(glht(dexa_body_fat_group, linfct = K))
# T1D
K <- matrix(c(0,1,0,0,0,0,1,0), nrow=1)
summary(glht(dexa_body_fat_group, linfct = K))
confint(glht(dexa_body_fat_group, linfct = K))
# T2D
K <- matrix(c(0,1,0,0,0,0,0,1), nrow=1)
summary(glht(dexa_body_fat_group, linfct = K))
confint(glht(dexa_body_fat_group, linfct = K))
```

## Body fat mass (%) and sex

```{r message = F, warning = F}
#| echo: false
dexa_body_fat_sex <- lm(dexa_bone_mineral_density ~ dexa_body_fat*sex + dexa_body_fat + sex, data = dat)
summ(dexa_body_fat_sex, digits =5)
# interact_plot(dexa_body_fat_sex, pred = dexa_body_fat, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_body_fat, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F)
```

## Absolute body fat mass (kg) and group

```{r message = F, warning = F, include = F}
#| echo: false
dexa_fat_kg_group <- lm(dexa_bone_mineral_density ~ dexa_fat_kg*group + dexa_fat_kg + group, data = dat)
summ(dexa_fat_kg_group, digits =5)
# interact_plot(dexa_fat_kg_group, pred = dexa_fat_kg, modx = group,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_fat_kg, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F)
```

## Absolute body fat mass (kg) and sex

```{r message = F, warning = F,include = F}
#| echo: false
dexa_fat_kg_sex <- lm(dexa_bone_mineral_density ~ dexa_fat_kg*sex + dexa_fat_kg + sex, data = dat)
summ(dexa_fat_kg_sex, digits =5)
# interact_plot(dexa_fat_kg_sex, pred = dexa_fat_kg, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_fat_kg, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F)
```

## Lean mass (%) and group

```{r message = F, warning = F}
#| echo: false
dexa_lean_mass_group <- lm(dexa_bone_mineral_density ~ dexa_lean_mass*group + dexa_lean_mass + group, data = dat)
summ(dexa_lean_mass_group, digits =5)
# interact_plot(dexa_lean_mass_group, pred = dexa_lean_mass, modx = group,
#               plot.points = TRUE, linearity.check = TRUE)

ggplot(dat, aes(dexa_lean_mass, dexa_bone_mineral_density, size = age, color = group)) +
  labs(x = Hmisc::label(dat$dexa_lean_mass),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=group), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=group)) +
  stat_poly_line(se = F)

# HWC
K <- matrix(c(0,1,0,0,0,0,0,0), nrow=1)
summary(glht(dexa_lean_mass_group, linfct = K))
confint(glht(dexa_lean_mass_group, linfct = K))
# OC
K <- matrix(c(0,1,0,0,0,1,0,0), nrow=1)
summary(glht(dexa_lean_mass_group, linfct = K))
confint(glht(dexa_lean_mass_group, linfct = K))
# T1D
K <- matrix(c(0,1,0,0,0,0,1,0), nrow=1)
summary(glht(dexa_lean_mass_group, linfct = K))
confint(glht(dexa_lean_mass_group, linfct = K))
# T2D
K <- matrix(c(0,1,0,0,0,0,0,1), nrow=1)
summary(glht(dexa_lean_mass_group, linfct = K))
confint(glht(dexa_lean_mass_group, linfct = K))
```

## Lean mass (%) and sex

```{r message = F, warning = F}
#| echo: false
dexa_lean_mass_sex <- lm(dexa_bone_mineral_density ~ dexa_lean_mass*sex + dexa_lean_mass + sex, data = dat)
summ(dexa_lean_mass_sex, digits =5)
# interact_plot(dexa_lean_mass_sex, pred = dexa_lean_mass, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)

ggplot(dat, aes(dexa_lean_mass, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_lean_mass),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F)
```

# Box plot

```{r message = F}
#| echo: false
stat.test <- dat %>%
  group_by(group) %>%
  t_test(dexa_bone_mineral_density ~ sex) %>%
  add_xy_position(x = "group", dodge = 0.8)  %>%
  mutate(p_form = p_format(p, trailing.zero=T))

ggboxplot(dat, "group", "dexa_bone_mineral_density",
          add = "jitter", color = "sex",
          order = c("HWC", "OC", "T1D", "T2D")) +
  labs(x = Hmisc::label(dat$group),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex") +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  stat_pvalue_manual(stat.test,  label = "p_form", tip.length = 0)
```

# Simple linear regression

```{r}
#| echo: false
simple_hba1c <- lm(dexa_bone_mineral_density ~ hba1c, dat)
simple_bmi <- lm(dexa_bone_mineral_density ~ bmi, dat)
simple_dexa_body_fat <- lm(dexa_bone_mineral_density ~ dexa_body_fat, dat)
simple_dexa_fat_kg <- lm(dexa_bone_mineral_density ~ dexa_fat_kg, dat)
simple_dexa_lean_mass <- lm(dexa_bone_mineral_density ~ dexa_lean_mass, dat)
simple_dexa_trunk_mass <- lm(dexa_bone_mineral_density ~ dexa_trunk_mass, dat)
```

## HbA1c

```{r, include = F}
#| echo: false
summ(simple_hba1c, digits = 5)
```

## BMI

```{r}
#| echo: false
summ(simple_bmi, digits = 5)
```

## Body fat (%)

```{r}
#| echo: false
summ(simple_dexa_body_fat, digits = 5)
```

## Absolute body fat (kg)

```{r,include = F}
#| echo: false
summ(simple_dexa_fat_kg, digits = 5)
```

## Lean mass (%)

```{r}
#| echo: false
summ(simple_dexa_lean_mass, digits = 5)
```

## Trunk mass (%)

```{r,include = F}
#| echo: false
summ(simple_dexa_trunk_mass, digits = 5)
```

# Correlation

```{r,include = F}
#| echo: false
corrplot(cor(subset(dat, 
                    select = c("age", "bmi", "hba1c", "dexa_body_fat", "dexa_fat_kg", "dexa_lean_mass", "dexa_trunk_mass")),
             use = "complete.obs"), method = "number")
```

# Multiple linear regression

```{r, include = F}
#| echo: false
adj_hba1c <- lm(dexa_bone_mineral_density ~ hba1c + age + sex + bmi, dat)
adj_bmi <- lm(dexa_bone_mineral_density ~ bmi + age + sex, dat)
adj_dexa_body_fat <- lm(dexa_bone_mineral_density ~ dexa_body_fat + age + sex, dat)
adj_dexa_fat_kg <- lm(dexa_bone_mineral_density ~ dexa_fat_kg + age + sex, dat)
adj_dexa_lean_mass <- lm(dexa_bone_mineral_density ~ dexa_lean_mass + age + sex, dat)
adj_dexa_trunk_mass <- lm(dexa_bone_mineral_density ~ dexa_trunk_mass + age + sex, dat)

# Adjust by diabetes duration in diabetes groups
adj_hba1c_duration <- lm(dexa_bone_mineral_density ~ hba1c + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
adj_bmi_duration <- lm(dexa_bone_mineral_density ~ bmi + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
adj_dexa_body_fat_duration <- lm(dexa_bone_mineral_density ~ dexa_body_fat + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
adj_dexa_fat_kg_duration <- lm(dexa_bone_mineral_density ~ dexa_fat_kg + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
adj_dexa_lean_mass_duration <- lm(dexa_bone_mineral_density ~ dexa_lean_mass + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
adj_dexa_trunk_mass_duration <- lm(dexa_bone_mineral_density ~ dexa_trunk_mass + age + sex + diabetes_duration, 
                                   subset(dat, group == "T1D"|group == "T2D"))
```

## Adjusted HbA1c (adjusting for age, sex, and bmi) {#adjusted-hba1c-adjusting-for-age-sex-and-bmi}

```{r,include = F}
#| echo: false
summ(adj_hba1c, digits = 5)
summ(adj_hba1c_diab, digits = 5)
```

## Adjusted BMI (adjusting for age and sex)

```{r}
#| echo: false
summ(adj_bmi, digits = 5)
summ(adj_bmi_duration, digits = 5)
```

## Adjusted Body fat (%) (adjusting for age and sex)

```{r}
#| echo: false
summ(adj_dexa_body_fat, digits = 5)
summ(adj_dexa_body_fat_duration, digits = 5)
```

## Adjusted Body fat (kg) (adjusting for age and sex)

```{r}
#| echo: false
summ(adj_dexa_fat_kg, digits = 5)
summ(adj_dexa_fat_kg_duration, digits = 5)
```

## Adjusted Lean mass (%) (adjusting for age and sex)

```{r}
#| echo: false
summ(adj_dexa_lean_mass, digits = 5)
summ(adj_dexa_lean_mass_duration, digits = 5)
```

## Adjusted Trunk mass (%) (adjusting for age and sex)

```{r}
#| echo: false
summ(adj_dexa_trunk_mass, digits = 5)
summ(adj_dexa_trunk_mass_duration, digits = 5)
```


# Updated output from 10/9/23

## HbA1c adjusting for age, sex, and BMI (limited to T1D and T2D only)

This is the same as the [Adjusted HbA1c (adjusting for age, sex, and bmi)](#adjusted-hba1c-adjusting-for-age-sex-and-bmi) but is limited to participants with diabetes only.

```{r,include = F}
#| echo: false
summ(adj_dexa_body_fat_duration, digits = 5)
summ(adj_dexa_fat_kg_duration, digits = 5)
summ(adj_dexa_lean_mass_duration, digits = 5)
summ(adj_dexa_trunk_mass_duration, digits = 5)
```

## Sex adjusting for age and BMI

This model is observing the association between sex and BMD while adjusting for age and BMI. The BMD is estimated to be 0.05169 g/cm\^2 higher for males than females after adjusting for age and BMI.

```{r,include = F}
#| echo: false
adj_sex_diab <- lm(dexa_bone_mineral_density ~ sex + age + bmi, dat)
summ(adj_sex_diab, digits = 5)
```

## Group adjusted means (adjusting for sex and age)

This plot is showing the ls means and its 95% CI per group by sex. This may be used in place of the box plot shown initially that was not adjusting for age and sex here: [Box plot].

```{r message = F, warning=F}
#| echo: false
adj_group <- lm(dexa_bone_mineral_density ~ group + sex + age, dat)
adj_group_means <- as.data.frame(lsmeans(adj_group, c("group", "sex")))
adj_group_int <- lm(dexa_bone_mineral_density ~ group * sex + age, dat)
adj_group_int_df <- as.data.frame(pairs(emmeans(adj_group_int, ~ sex | group))) %>%
  mutate(#p_form = p_format(p.value, trailing.zero=F, accuracy = 0.001), 
         p_form = c("0.021","0.438","<0.001","0.143"),
         group1 = sub("-.*", "", contrast),
         group2 = sub(".*- ", "", contrast),
         x = c(1,2,3,4),
         xmin = c(0.8, 1.8, 2.8, 3.8),
         xmax = c(1.2, 2.2, 3.2, 4.2),
         y.position = c(1.115513+0.02, 1.153978+0.02, 1.119764+0.02, 1.198109+0.02))

adj_group_means %>%
  ggplot(aes(x = group, y = lsmean)) +
  geom_errorbar(
    aes(ymin = lower.CL, ymax = upper.CL, color = sex),
     position = position_dodge(0.3), width = 0.2
    )  +
  geom_point(aes(color = sex), position = position_dodge(0.3)) +
  labs(x = Hmisc::label(subset(dat, smr == 5)$group),
       y = Hmisc::label(subset(dat, smr == 5)$dexa_bone_mineral_density),
       color  = "Sex") +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  stat_pvalue_manual(adj_group_int_df,  label = "p_form", 
                     tip.length = 0)

kable(adj_group_means)
```

## Sensitivity analysis (SMR = 5)

## Tanner = 5 only

```{r, include=F}
table_one <- tableby(group ~ study + sex + age + race + ethnicity + kwt(hba1c, "Nmiss", "median", "q1q3", "range") + kwt(bmi, "Nmiss", "median", "q1q3", "range") + dexa_body_fat + dexa_fat_kg + dexa_lean_mass + dexa_bone_mineral_density + map + smr, data = subset(dat, smr == 5))
```

```{r results='asis',include = F}
#| echo: false
table_one <- summary(table_one, pfootnote = T, digits=3, digits.pct=0)
table_one
```

This is restricted to participants with sexual maturity rating (tanner stage) of 5.

```{r message = F,include = F}
#| echo: false
stat.test <- subset(dat, smr == 5) %>%
  group_by(group) %>%
  t_test(dexa_bone_mineral_density ~ sex) %>%
  add_xy_position(x = "group", dodge = 0.8) %>%
  mutate(p_form = p_format(p, trailing.zero=T, accuracy = 0.001))

ggboxplot(subset(dat, smr == 5), "group", "dexa_bone_mineral_density",
          add = "jitter", color = "sex",
          order = c("HWC", "OC", "T1D", "T2D")) +
  labs(x = Hmisc::label(subset(dat, smr == 5)$group),
       y = Hmisc::label(subset(dat, smr == 5)$dexa_bone_mineral_density),
       color  = "Sex") +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  stat_pvalue_manual(stat.test,  label = "p_form", tip.length = 0)
```

## Interactions by group

### Body fat mass (%) and sex

```{r message = F, warning = F}
#| echo: false
# interact_plot(dexa_body_fat_sex, pred = dexa_body_fat, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_body_fat, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_body_fat),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F) + 
  facet_grid(cols = vars(group))

# HWC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))

# OC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))

# T1D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))

# T2D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_body_fat*sex + dexa_body_fat + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))

```

### Absolute body fat mass (kg) and sex

```{r message = F, warning = F,include = F}
#| echo: false
# interact_plot(dexa_fat_kg_sex, pred = dexa_fat_kg, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)
ggplot(dat, aes(dexa_fat_kg, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_fat_kg),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F) + 
  facet_grid(cols = vars(group))
```

### Lean mass (%) and sex

```{r message = F, warning = F}
#| echo: false
dexa_lean_mass_sex <- lm(dexa_bone_mineral_density ~ dexa_lean_mass*sex + dexa_lean_mass + sex, data = dat)
summ(dexa_lean_mass_sex, digits = 5)
# interact_plot(dexa_lean_mass_sex, pred = dexa_lean_mass, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)

ggplot(dat, aes(dexa_lean_mass, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$dexa_lean_mass),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Sex",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F) + 
  facet_grid(cols = vars(group))

# HWC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))

# OC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))

# T1D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))

# T2D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  dexa_lean_mass*sex + dexa_lean_mass + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
```

### BMI and sex

```{r message = F, warning = F}
#| echo: false
bmi_sex <- lm(dexa_bone_mineral_density ~ bmi*sex + bmi + sex, data = dat)
summ(bmi_sex, digits =5)
# interact_plot(bmi_group, pred = bmi, modx = sex,
#               plot.points = TRUE, linearity.check = TRUE)

ggplot(dat, aes(bmi, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = Hmisc::label(dat$bmi),
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F) + 
  facet_grid(cols = vars(group))

# HWC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))

## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "HWC")), 
             linfct = K))


# OC
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "OC")), 
             linfct = K))

# T1D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T1D")), 
             linfct = K))

# T2D
## Female
K <- matrix(c(0,1,0,0), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Male
K <- matrix(c(0,1,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
## Female vs. Male
K <- matrix(c(0,0,0,1), nrow=1)
summary(glht(lm(dexa_bone_mineral_density ~ 
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))
confint(glht(lm(dexa_bone_mineral_density ~
                  bmi*sex + bmi + sex, 
                data = subset(dat, group == "T2D")), 
             linfct = K))

ggplot(dat, aes(bmi_sds, dexa_bone_mineral_density, size = age, color = sex)) +
  labs(x = "BMI-SDS",
       y = Hmisc::label(dat$dexa_bone_mineral_density),
       color  = "Group",
       size = "Age") +
  geom_point(aes(color=sex), alpha = 0.4) +
  scale_color_brewer(palette = "Set1") +
  sm_hvgrid() + 
  geom_smooth(method=lm, se=F, fullrange=F, aes(color=sex)) +
  stat_poly_line(se = F) + 
  facet_grid(cols = vars(group))
```
