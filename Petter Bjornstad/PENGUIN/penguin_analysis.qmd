---
title: "PENGUIN Analysis"
author: "Tim Vigers"
date: "`r format(Sys.time(), '%d %B %Y')`"
format:
  html:
    page-layout: full
    toc: true
    toc-depth: 5
    toc-float: true
    self-contained: true
    code-fold: true
editor: visual
---

```{python}
import pandas as pd
import numpy as np
# Import
df = pd.read_csv("/Volumes/Work/CHCO/Petter Bjornstad/Data Harmonization/Data Clean/harmonized_dataset.csv",low_memory=False)
# Subset to CROCODILE and PENGUIN
df = df.loc[df["study"].isin(["CROCODILE","PENGUIN"])]
df = df.loc[df["group"] != "Type 1 Diabetes"]
# Get last values for each visit
df = df.groupby(by=["record_id", "visit"]).agg("last").reset_index()
# Get variables of interest
var_names = {"record_id":"ID","visit":"Visit","group":"Group","sex":"Gender","race":"Race","age":"Age","height":"Height","weight":"Weight","bmi":"BMI","sbp":"SBP","dbp":"DBP","pulse":"Pulse","creatinine_s":"Serum Creatinine","eGFR_CKD_epi":"eGFR","acr_u":"UACR","ace_inhibitor":"ACEi","angiotensin_receptor_blocker":"Angiotensin Receptor Blocker","beta_blocker":"Beta Blocker","ca_channel_blocker":"Ca Channel Blocker","diuretic":"Diuretic","statin":"Statin"}
```

```{python}
#| label: t1-histograms
import seaborn as sns
import matplotlib.pyplot as plt
hist_vars = df[list(var_names.keys())[3:]].select_dtypes(include=np.number).columns.tolist()
for v in hist_vars:
  ax = sns.displot(df, x=v, hue="group", element="step")
  ax.set(xlabel=var_names[v])
  plt.show()
```

```{python}
#| label: tbl-1
#| tbl-cap: Participant Characteristics
from tableone import TableOne
cat = ["sex","race","ace_inhibitor","angiotensin_receptor_blocker","beta_blocker","ca_channel_blocker","diuretic","statin"]
groupby = "group"
nn = ["acr_u", "creatinine_s", "dbp"]
t1 = TableOne(df,list(var_names.keys())[3:], cat, groupby=groupby,nonnormal=nn,
pval=True,dip_test=True, normal_test=True, tukey_test=True)
t1
```

```{python}
mri_vars = {"record_id":"ID","visit":"Visit","group":"Group","total_kidney_volume_ml":"Total Kidney Volume","right_kidney_volume_ml":"Right Kidney Volume","left_kidney_volume_ml":"Left Kidney Volume","height_adj_total_kidney_volume":"Height-Adjusted Total Kidney Volume","height_adj_right_kidney_volume":"Height-Adjusted Right Kidney Volume","height_adj_left_kidney_volume":"Height-Adjusted Left Kidney Volume","total_liver_volume_ml":"Total Liver Volume","total_cyst_volume_ml":"Total Cyst Volume","total_number_of_cysts":"Total Num. Cyst","lc_f":"Left Cortex Perfusion [F]","lc_k1":"Left Cortex Tracer Uptake Rate [K1]","lc_k2":"Left Cortex Oxidation Rate [k2]","lc_vb":"Left Cortex Blood Volume Fraction [vB]","rc_f":"Right Cortex Perfusion [F]","rc_k1":"Right Cortex Tracer Uptake Rate [K1]","rc_k2":"Right Cortex Oxidation Rate [k2]","rc_vb":"Right Cortex Blood Volume Fraction [vB]","lm_f":"Left Medulla Perfusion [F]","lm_k1":"Left Medulla Tracer Uptake Rate [K1]","lm_k2":"Left Medulla Oxidation Rate [k2]","lm_vb":"Left Medulla Blood Volume Fraction [vB]","rm_f":"Right Medulla Perfusion [F]","rm_k1":"Right Medulla Tracer Uptake Rate [K1]","rm_k2":"Right Medulla Oxidation Rate [k2]","rm_vb":"Right Medulla Blood Volume Fraction [vB]"}
# Height-adjusted
df["height_adj_total_kidney_volume"] = df["total_kidney_volume_ml"] / (df["height"] / 100)
df["height_adj_right_kidney_volume"] = df["right_kidney_volume_ml"] / (df["height"] / 100)
df["height_adj_left_kidney_volume"] = df["left_kidney_volume_ml"] / (df["height"] / 100)
```

```{python}
#| label: t2-histograms
hist_vars = list(mri_vars.keys())[3:]
for v in hist_vars:
  ax = sns.displot(df, x=v, hue="group", element="step")
  ax.set(xlabel=mri_vars[v])
  plt.show()
```

```{python}
#| label: tbl-2
#| tbl-cap: PET and MRI
#| warning: false
# Table
t2 = TableOne(df,list(mri_vars.keys())[3:],groupby=groupby,
pval=True,dip_test=True, normal_test=True, tukey_test=True);
t2
```

# Questions for Petter
1. Should we exclude some of the PET variables that are missing large amounts of data? I would not trust the results in @tbl-2 right now, and decided to hold off on the correlation matrix for now
2. I can see why PKD kidneys might be bigger but they seem SO much bigger than controls. Is that correct (@tbl-2)?
3. 