---
title: "Spatial transcriptomics priority list"
---

```{r}
mrn_map <- read.csv("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data clean/mrn_uuid_map.csv")
biopsy_master <- read_excel("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/Biopsy master tracker.xlsx", skip = 2) 
colnames(biopsy_master) <- gsub(" ", "_", colnames(biopsy_master))  # Replace spaces with underscores
colnames(biopsy_master) <- gsub("/", "_", colnames(biopsy_master))  # Replace slashes with underscores
colnames(biopsy_master) <- gsub("\\(", "_", colnames(biopsy_master))  # Replace opening parentheses with underscores
colnames(biopsy_master) <- gsub("\\)", "", colnames(biopsy_master))  # Remove closing parentheses

biopsy_master <- biopsy_master %>%
  dplyr::rename(record_id=Study_ID,
                visit=Visit_ID) %>%
  mutate(visit = case_when(Study == "ATTEMPT" ~ visit,
                           Study == "REMODEL" ~ visit, 
                           Study == "IMPROVE" & visit == "4M" ~ "3_months_post_surgery",
                           visit == "12M" ~ "12_months_post_surgery",
                           visit == "Follow-up" ~ "follow-up",
                           T ~ "baseline"),
         record_id = case_when(startsWith(record_id, "RPC") & !is.na(Coenroll_ID__Same_visit_only) ~ Coenroll_ID__Same_visit_only,
                               T ~ record_id)) # RH2-60-T and RH2-48-T coenrolled into RPC2 as of 02/03/25 data pull

harm_dat <- read.csv("/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/Data Harmonization/Data Clean/soma_harmonized_dataset.csv", na.strings = "") %>%
  dplyr::select(
    -starts_with("seq."),
    any_of(c("seq.10000.28_urine_cradj", "seq.10000.28"))
  )

harm_dat <- harm_dat %>% 
  mutate(bx_date = case_when(procedure == "kidney_biopsy" ~ date),
         visit = case_when(kit_id == "KL-0024005" ~ "12_months_post_surgery", T ~ visit)) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit)) %>%
  mutate(urine_soma = case_when(!is.na(seq.10000.28_urine_cradj) ~ 1, T ~ 0),
         blood_soma = case_when(!is.na(seq.10000.28) ~ 1, T ~ 0),
         clamp = case_when(!is.na(p2_raw_m) ~ 1, T ~ 0),
         pet = case_when((!is.na(avg_c_f) | !is.na(avg_m_f)) ~ 1, T ~ 0),
         mri = case_when((!is.na(avg_c_r2) | !is.na(avg_k_r2) | !is.na(avg_m_r2)) ~ 1, T ~ 0),
         mgfr = case_when(!is.na(gfr_bsa_plasma) ~ 1, T ~ 0),
         erpf = case_when(!is.na(erpf_bsa_plasma) ~ 1, T ~ 0),
         egfr = case_when(!is.na(eGFR_CKD_epi) ~ 1, T ~ 0)) %>%
  arrange(mrn)

harm_biopsy <- harm_dat %>% left_join(biopsy_master)
```

```{r}
bx_dat <- harm_biopsy %>%
  filter(!is.na(Biopsy_date)|!is.na(kit_id)) %>%
  arrange(mrn) %>%
  filter(study %in% c("ATTEMPT", "CROCODILE", "RENAL-HEIRitage", "RENAL-HEIR", "IMPROVE")) %>%
  filter(record_id %nin% c("CRC-55", "RH-87-T", "RH-88-T",
                           "RH2-48-T", "RH2-60-T")) %>%
  filter(is.na(rpc2_id)) %>%
  mutate(kit_id = coalesce(kit_id, Kit_ID),
         kit_id = gsub("Kl", "KL", kit_id)) %>%
  distinct(kit_id, .keep_all = T) %>%
  add_count(mrn, name = "mrn_count") %>%
  rowwise() %>%
  mutate(n_vars = sum(pet, mri, urine_soma, blood_soma, 
                      clamp, mgfr, erpf, egfr,
                      na.rm = T)) %>%
  ungroup() %>%
  mutate(acr_u_cat = case_when(acr_u > 30 ~ ">30", acr_u <=30 ~ "<=30"),
    priority = case_when(study %in% c("ATTEMPT")  ~ 1,
                         study == "CROCODILE" & group == "Lean Control" ~ 1.2,
                         mrn_count >1 ~ 2,
                         n_vars == 8 ~ 3,
                         n_vars == 7 ~ 4,
                         n_vars == 6 ~ 5,
                         n_vars == 5 ~ 6,
                         n_vars == 4 ~ 7,
                         n_vars == 3 ~ 8,
                         n_vars == 2 ~ 9,
                         n_vars == 1 ~ 10,
                         n_vars == 0 ~ 11,
                         study =="CROCODILE" & group == "Type 1 Diabetes" ~ 9)) %>%
  group_by(mrn) %>%
  mutate(mrn_n = row_number()) %>%
  fill(c(epic_glp1ra_1, epic_glp1ra_2)) %>%
  ungroup() %>%
  mutate(visit = case_when(visit == "baseline" & mrn_n == 2 ~ "follow_up_from_rh",
                           T ~ visit),
         glp1ra = case_when(mrn_n == 1 ~ epic_glp1ra_1,
                            mrn_n == 2 ~ epic_glp1ra_2)) %>%
  dplyr::select(mrn,mrn_count,mrn_n,rh_id, rh2_id, record_id, visit, kit_id,
                study, group, bx_date, age,
                glp1ra, acr_u_cat, pet, urine_soma, blood_soma, 
                      clamp, mri, mgfr, erpf, egfr, n_vars, priority) %>%
  arrange(priority)

# Build a block id so duplicate MRNs stay together (pairs treated as a single unit)
bx_dat <- bx_dat %>%
  group_by(priority) %>%
  mutate(
    # if an MRN appears >1 time, use MRN as the block id; otherwise make a unique id for the row
    block_id = if_else(mrn_count > 1, as.character(mrn),
                       paste0(mrn, "__", row_number()))
  ) %>%
  ungroup() %>%
  left_join(mrn_map)

# Create one row per block to compute an alternating block order
block_tbl <- bx_dat %>%
  distinct(priority, block_id, .keep_all = TRUE) %>%
  transmute(
    priority,
    block_id,
    epic_block = glp1ra
  )

# Within each priority:
#  - alternate by glp1ra inside those ties
block_order <- block_tbl %>%
  group_by(priority, epic_block) %>%
  mutate(epic_rank = row_number()) %>%
  ungroup() %>%
  group_by(priority) %>%
  arrange(epic_rank, epic_block, .by_group = TRUE) %>%
  mutate(block_order = row_number()) %>%
  ungroup() %>%
  select(priority, block_id, block_order)

# Join the block order back and do the final arrange
bx_dat <- bx_dat %>%
  left_join(block_order, by = c("priority", "block_id")) %>%
  group_by(block_id) %>%
  # keep paired rows adjacent; choose your intra-block order (e.g., by mrn or date)
  arrange(bx_date, .by_group = TRUE) %>%
  ungroup() %>%
  arrange(priority, block_order) %>% 
  # move Crocodile T1D blocks to the end
  arrange(study == "CROCODILE" & group == "Type 1 Diabetes") %>%
  dplyr::select(-c(priority, block_order,
                   mrn, mrn_count, mrn_n, block_id, rh_id, rh2_id)) %>%
  select(uuid, everything())

write.csv(bx_dat, "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive/Spatial transcriptomics/spatial_transcriptomics_priority_list.csv", na = "")

```
