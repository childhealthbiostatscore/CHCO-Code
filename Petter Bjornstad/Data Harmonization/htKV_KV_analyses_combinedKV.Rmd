---
title: "Harmonized Data and PANTHER Combined Non-Manual and Manual Kidney Volume Analyses"
author: "Callie Rountree-Jablin"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_loc: left
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(Hmisc)
library(gtsummary)
library(magrittr)
pacman::p_load(naniar)

if(Sys.info()["sysname"] == "Windows"){
  home_dir = "B:/Petter Bjornstad"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/Peds Endo/Petter Bjornstad/"
} 
knitr::opts_knit$set(echo=FALSE, root.dir = home_dir)
```
# Overview

The aim of this report is to:

 1. Separately describe combined non-manual and manual left and right kidney volume across all studies by age and disease type, using the harmonized dataset. 
 2. Separately describe left and right kidney volume by Tanner stage, IGF-1 concentrations, and IGF-1 Z-scores in the PANTHER study.
 
```{r read, include=FALSE}
## read raw data and data dictionary
raw_dat <- read.csv("./Data Harmonization/Data Clean/harmonized_dataset.csv", na.strings = c(" ", "", "-9999",-9999))
dict <- read.csv("./Data Harmonization/data_dictionary_master.csv", na.strings = c(" ", "", "-9999",-9999)) %>% 
  select(variable_name, label)

## import co-enrolled IDs for IMPROVE, RH, and RH2; transpose to long format
coenroll_id <- read.csv("./Renal HERITAGE/Data_Cleaned/coenrolled_ids.csv") %>%
  pivot_longer(cols = 'improve_id':'crc_id',
               values_to = "record_id") %>% 
  select(merged_id, record_id) %>%
  filter(record_id != "")
```


```{r combined analysis data cleaning, include=FALSE}
### data cleaning for combined/merged non-manual and manual analyses

## clean main df
# add in merged IDs to data, filter down to studies and procedures where kv data was collected
# exclude PKD subjects, merge non-manual and manual variables, define height in meters for later calculation of ht. adj. vars
clean_dat <- left_join(raw_dat, coenroll_id, by = 'record_id') %>% 
  relocate(merged_id, .after = co_enroll_id) %>%
  filter(((study == 'CROCODILE'| study == 'PANDA') & procedure == 'bold_mri') | 
           ((study == 'PANTHER'| study == 'RENAL-HEIR'| study =='RENAL-HEIRitage') & procedure == 'clamp') | 
           (study == 'PENGUIN' & procedure == 'mri')) %>% 
  filter(participation_status != 'Removed'|is.na(participation_status)) %>% 
  filter(group != 'PKD') %>% 
  mutate(date = as.Date(date, format = '%Y-%m-%d'), # formatted date to use arrange function later on
         merged_left_kv = ifelse(!is.na(left_kidney_volume_ml), left_kidney_volume_ml, volume_left_manual),
         merged_right_kv = ifelse(!is.na(right_kidney_volume_ml), right_kidney_volume_ml, volume_right_manual),
         merged_lkv_metric_type = case_when(!is.na(left_kidney_volume_ml) ~ 'Non-Manual',
                                      is.na(left_kidney_volume_ml) & !is.na(volume_left_manual) ~ 'Manual'),
         merged_rkv_metric_type = case_when(!is.na(right_kidney_volume_ml) ~ 'Non-Manual',
                                      is.na(right_kidney_volume_ml) & !is.na(volume_right_manual) ~ 'Manual'),
          height_meters = height*0.01) %>% 
  select(-c(igf_1, igf1_z_score, tan_fgd, tan_tveq)) # no data for these vars with procedure = bold_mri/clamp; manually added it in later


## create separate dfs for stratifying analyses by left and right kidney
left_clean_dat <- clean_dat
right_clean_dat <- clean_dat

rm(clean_dat)

## define function for collapsing subjects who are represented more than once to 1 row
# function cleans RH, RH2, CROCODILE, and PANDA co-enrolled subjects as well as PANTHER subjects w/multiple visits by
# first dropping rows with no left/right kv data at all, then keeping subject's earliest measurements for all variables 
coenroll_multivisit_cleaning <- function(dat, merged_kv_varname){
  dat %>%
    filter(study == 'RENAL-HEIRitage' | study == 'RENAL-HEIR' | study == 'CROCODILE' | study == 'PANDA' | study == 'PANTHER') %>%
    filter(!is.na({{merged_kv_varname}})) %>% 
    arrange(merged_id, visit, date) %>%
    mutate(date = as.character(date)) %>% 
    summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, first(na.omit(.x)))),
              across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, first(na.omit(.x)))), .by = c(merged_id)) %>% 
    mutate(date = as.Date(date, format = '%Y-%m-%d'))
}

## separately clean left and right data

# collapse to one row per subject (no need to merge back into main left/right dfs since PENGUIN subjects are dropped with PKD exclusion)
left_combined_clean <- coenroll_multivisit_cleaning(dat = left_clean_dat, merged_kv_varname = merged_left_kv)

right_combined_clean <- coenroll_multivisit_cleaning(dat = right_clean_dat, merged_kv_varname = merged_right_kv)

# save a copy for later check
og_left_combined_clean <- left_combined_clean %>% 
  rename('lkv_date' = 'date')

og_right_combined_clean <- right_combined_clean %>% 
  rename('rkv_date' = 'date')

# add in igf1 data for PANTHER analyses (note: no other studies have igf1 data); add in risk status
PAN_igf1_dat <- left_join(raw_dat, coenroll_id, by = 'record_id') %>% 
  relocate(merged_id, .after = co_enroll_id) %>%
  filter(study == 'PANTHER' & procedure == 'ivgtt') %>% 
  filter(participation_status != 'Removed'|is.na(participation_status)) %>% 
  filter(group != 'PKD') %>% 
  select(record_id, merged_id, study, visit, date, igf_1, igf1_z_score) %>% 
  rename('igf1_date' = 'date') %>% 
  mutate(PAN_risk_status = ifelse(str_detect(record_id, 'C'), 'Low', 'High')) %>% 
  select(-record_id)

left_combined_clean <- left_join(left_combined_clean, PAN_igf1_dat, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(lkv_igf1_date_diff = as.numeric(difftime(as.Date(date), as.Date(igf1_date), units = 'days'))) %>% 
  rename('lkv_date' = 'date')

right_combined_clean <- left_join(right_combined_clean, PAN_igf1_dat, by = c('merged_id', 'study', 'visit')) %>%
  mutate(rkv_igf1_date_diff = as.numeric(difftime(as.Date(date), as.Date(igf1_date), units = 'days'))) %>% 
  rename('rkv_date' = 'date')

# add in tanner stage data for PANTHER analyses
PAN_tan_dat <- left_join(raw_dat, coenroll_id, by = 'record_id') %>% 
  relocate(merged_id, .after = co_enroll_id) %>%
  filter(study == 'PANTHER' & procedure == 'physical_exam') %>% 
  filter(participation_status != 'Removed'|is.na(participation_status)) %>% 
  filter(group != 'PKD') %>%
  filter(!is.na(tan_fgd) | !is.na(tan_tveq)) %>% 
  select(merged_id, study, visit, date, tan_fgd, tan_tveq) %>% 
  mutate(tan_fgd = factor(tan_fgd, levels=c(1,2,3,4,5), labels=c('I', 'II', 'III', 'IV', 'V')),
         tan_tveq = factor(tan_tveq, levels=c(1,2,3,4,5), labels=c('I', 'II', 'III', 'IV', 'V'))) %>% 
  rename('tan_stage_date' = 'date') %>% 
  distinct()

left_combined_clean <- left_join(left_combined_clean, PAN_tan_dat, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(lkv_tan_date_diff = as.numeric(difftime(as.Date(lkv_date), as.Date(tan_stage_date), units = 'days'))) %>% 
  group_by(merged_id) %>%
  # for subjects with multiple tanner stage entries for a visit, take the stage that's closest in time to the kv measurement
  slice_min(lkv_tan_date_diff, n = 1) %>%  
  ungroup()
left_combined_clean <- as.data.frame(left_combined_clean)

right_combined_clean <- left_join(right_combined_clean, PAN_tan_dat, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(rkv_tan_date_diff = as.numeric(difftime(as.Date(rkv_date), as.Date(tan_stage_date), units = 'days'))) %>% 
  group_by(merged_id) %>%
  slice_min(rkv_tan_date_diff, n = 1) %>%  
  ungroup()
right_combined_clean <- as.data.frame(right_combined_clean)

# add in missing height data for PANTHER subjects, calculate ht. adj. kv
PAN_height_dat <- left_join(raw_dat, coenroll_id, by = 'record_id') %>% 
  relocate(merged_id, .after = co_enroll_id) %>%
  filter(study == 'PANTHER') %>% 
  filter(participation_status != 'Removed'|is.na(participation_status)) %>%
  filter(!is.na(height)) %>% 
  select(merged_id, study, visit, procedure, date, height) %>% 
  group_by(merged_id, visit, date) %>% 
  mutate(PAN_height_meters = 0.01*mean(height)) %>% # take mean height if dates are exact same
  slice(1) %>% 
  ungroup() %>% 
  as.data.frame() %>% 
  select(-c(procedure, height)) %>% 
  rename('PAN_height_date' = 'date')


lkv_PAN_heights <- left_join(left_combined_clean, PAN_height_dat, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(lkv_PANheight_date_diff = as.numeric(difftime(as.Date(lkv_date), as.Date(PAN_height_date), units = 'days'))) %>% 
  select(merged_id, study, visit, PAN_height_date, lkv_PANheight_date_diff, PAN_height_meters) %>%
  filter(study == 'PANTHER') %>% 
  filter(lkv_PANheight_date_diff >= 0) %>%  # only use heights taken on or before date of kv measurement
  group_by(merged_id) %>%
  slice_min(lkv_PANheight_date_diff, n = 1) %>%  
  ungroup()

left_combined_clean <- left_join(left_combined_clean, lkv_PAN_heights, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(height_meters = 
           case_when(!is.na(height_meters) | !is.na(PAN_height_meters) ~ rowSums(select(., height_meters, PAN_height_meters),
                                                                                             na.rm = TRUE))) %>%
  mutate(ht_adj_merged_left_kv = merged_left_kv/height_meters)


rkv_PAN_heights <- left_join(right_combined_clean, PAN_height_dat, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(rkv_PANheight_date_diff = as.numeric(difftime(as.Date(rkv_date), as.Date(PAN_height_date), units = 'days'))) %>% 
  select(merged_id, study, visit, PAN_height_date, rkv_PANheight_date_diff, PAN_height_meters) %>%
  filter(study == 'PANTHER') %>% 
  filter(rkv_PANheight_date_diff >= 0) %>%  # only use heights taken on or before date of kv measurement
  group_by(merged_id) %>%
  slice_min(rkv_PANheight_date_diff, n = 1) %>%  
  ungroup()

right_combined_clean <- left_join(right_combined_clean, rkv_PAN_heights, by = c('merged_id', 'study', 'visit')) %>% 
  mutate(height_meters = 
           case_when(!is.na(height_meters) | !is.na(PAN_height_meters) ~ rowSums(select(., height_meters, PAN_height_meters),
                                                                                             na.rm = TRUE))) %>%
  mutate(ht_adj_merged_right_kv = merged_right_kv/height_meters)

rm(rkv_PAN_heights, lkv_PAN_heights)

## check - everything working as intended
og_left_combined_clean <- og_left_combined_clean %>% select(-height_meters)
check_left_combined <- left_combined_clean %>% select(-height_meters)
identical(og_left_combined_clean, check_left_combined[, -c(1009:1021)])

og_right_combined_clean <- og_right_combined_clean %>% select(-height_meters)
check_right_combined <- right_combined_clean %>% select(-height_meters)
identical(og_right_combined_clean, check_right_combined[, -c(1009:1021)])

rm(og_left_combined_clean, check_left_combined, og_right_combined_clean, check_right_combined)

## labels
rownames(dict) <- dict$variable_name
dict %<>% select("label")
dict <- t(dict) %>% as.data.frame(dict)
rownames(dict) <- "label"

data_labeling <- function(dat, dictionary){
  dictionary <- dictionary[intersect(names(dat), names(dictionary))]
  dictionary[setdiff(names(dat), names(dictionary))] <- " "
  label(dat) = as.list(dictionary[match(names(dat), names(dictionary))])
  label(dat$merged_left_kv) <- "Left Kidney Volume (mL)"
  label(dat$merged_right_kv) <- "Right Kidney Volume (mL)"
  label(dat$merged_lkv_metric_type) <- "Left Kidney Volume Measure Type"
  label(dat$merged_rkv_metric_type) <- "Right Kidney Volume Measure Type"
  label(dat$height_meters) <- "Height (m)"
  label(dat$tan_tveq) <- "Tanner Stage by Testicular Volume"
  label(dat$tan_fgd) <- "Tanner Stage by Breast Development"
  label(dat$igf_1) <- "IGF-1 Concentration"
  label(dat$igf1_z_score) <- "IGF-1 Z-score"
  label(dat$PAN_risk_status) <- "Risk Status"

  return(dat)
}

left_combined_clean <- data_labeling(dat = left_combined_clean, dictionary = dict)
right_combined_clean <- data_labeling(dat = right_combined_clean, dictionary = dict)

label(left_combined_clean$lkv_igf1_date_diff) <- "Days Between LKV and IGF-1 Measures"
label(right_combined_clean$rkv_igf1_date_diff) <- "Days Between RKV and IGF-1 Measures"
label(left_combined_clean$lkv_tan_date_diff) <- "Days Between LKV and Tanner Stage Measures"
label(right_combined_clean$rkv_tan_date_diff) <- "Days Between RKV and Tanner Stage Measures"
label(left_combined_clean$ht_adj_merged_left_kv) <- "Height Adjusted Left Kidney Volume (mL/m)"
label(right_combined_clean$ht_adj_merged_right_kv) <- "Height Adjusted Right Kidney Volume (mL/m)"
label(left_combined_clean$lkv_PANheight_date_diff) <- "Days Between LKV and PANTHER Height Measures"
label(right_combined_clean$rkv_PANheight_date_diff) <- "Days Between RKV and PANTHER Height Measures"

rm(right_clean_dat, left_clean_dat)

## create PANTHER subsets for PANTHER-only analyses
PAN_left_combined_clean <- left_combined_clean %>% filter(study == 'PANTHER')
PAN_right_combined_clean <- right_combined_clean %>% filter(study == 'PANTHER')

## workspace cleanup
rm(PAN_height_dat, PAN_tan_dat, PAN_igf1_dat)
```


# Methods

## Data Cleaning

The primary outcome of interest for this report was left or right kidney volume (KV), which was described by two different variables in the provided dataset. One of these variables summarized non-manual KV calculations whereas the other variable described manual KV measurements. For both left and right kidney analyses, these variables were merged into one variable, where the non-manual measurement was used unless missing in which case the manual measurement was instead used. Results were reported for this merged KV variable and additionally for a height-adjusted version of this variable $\bigl(\frac{\text{merged KV}}{\text{height (m)}}\bigr)$. In instances where subjects had multiple KV measurements or were enrolled on multiple studies, their earliest KV measurements were used for analyses; data from the same visit the KV measurement was taken was referenced for the covariates of interest (age, disease type, IGF-1 concentration, etc.) unless missing in which case covariate data from the closest visit in time was used.

## Data Analysis

**All Studies (CROCODILE, PANDA, RENAL-HEIR, PANTHER, RENAL-HEIRitage):**

Merged and height-adjusted merged KV were modeled using simple linear regression for describing associations with age and Kruskal-Wallis testing for describing differences by disease type. All analyses were stratified by left and right kidney; separate descriptive statistics were reported for left versus right analyses to account for subjects with only one kidney.

**PANTHER:**

Kruskal-Wallis testing was used for modeling differences in merged and height-adjusted merged KV by Tanner stage; results were reported separately for males and females. Tanner stage by testicular volume was used for male analyses and Tanner stage by breast development was used for female analyses. Associations between merged or height-adjusted merged KV and IGF-1 concentrations were modeled using simple linear regression; associations between these two KV outcomes and IGF-1 Z-scores were modeled in the same manner. All analyses were stratified by low versus high risk status, where subjects in the control group were considered to be at low risk and those with T2D or obesity were at high risk.

# Left Kidney Analyses

## Results: All Studies

### Descriptive Statistics
```{r lkv tab1, echo=FALSE}
table1::table1(~ sex + age + group + diabetes_duration + height_meters + merged_left_kv + ht_adj_merged_left_kv + 
                 merged_lkv_metric_type, 
               data = left_combined_clean, caption = 'Descriptive Statistics of all Participants for Left Kidney Analyses')
```

### LKV by Age

The below results describe the association between left KV and age for subjects across all studies. Diagnostic plots for checking linear regression assumptions are also included. `merged_left_kv` is the new combined variable of non-manual and manual KV measurements, as described in the Methods section. `ht_adj_merged_left_kv` is the height-adjusted version of `merged_left_kv`.

```{r lkv by age, echo=FALSE}
outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ age'))
  mod <- lm(form, data = left_combined_clean)
  print(noquote(c("Association between age and", noquote(v))))
  print(summary(mod))
  plot(x=left_combined_clean$age, y=left_combined_clean[[v]], 
       xlab='age', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative Probability',
       main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

### LKV by Disease Type

The below table reports the mean and standard deviation (SD) of the combined non-manual and manual KV outcomes of interest by disease type across all subjects in the harmonized dataset. Kruskal-Wallis testing was used to evaluate whether there was a significant difference in the mean ranks between groups.

```{r lkv disease type assumptions, eval=FALSE, include=FALSE}
## assumptions check
outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ group'))
  mod <- aov(form, data = left_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = left_combined_clean)
  print(bartlett_result)
}
```


```{r lkv by disease type, echo=FALSE}
## summary table with Kruskal-Wallis for testing
left_combined_clean %>% 
  select(merged_id, group, merged_left_kv, ht_adj_merged_left_kv) %>% 
   tbl_summary(by = group, include = -merged_id,
              type = list(c(merged_left_kv, ht_adj_merged_left_kv) ~ 'continuous', 
                        group ~ 'categorical'),
    statistic=list(all_continuous() ~ '{mean} ({sd})'),
    digits=everything()~c(2,2),
    missing_text='N Missing') %>% 
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun=~style_pvalue(.x, digits=3)) %>% 
  modify_header(label='**Measurement**')
```


## Results: PANTHER

### Descriptive Statistics
```{r PANTHER lkv tab1, echo=FALSE}
table1::table1(~ sex + age + group + PAN_risk_status + diabetes_duration + height_meters + merged_left_kv + 
                 ht_adj_merged_left_kv + merged_lkv_metric_type + igf_1 + igf1_z_score + lkv_igf1_date_diff + lkv_tan_date_diff +
                 lkv_PANheight_date_diff, 
               data = PAN_left_combined_clean, caption = 'Descriptive Statistics of Participants for Left Kidney PANTHER Analyses')
```

### LKV by Tanner Stage

The below tables report the mean and standard deviation (SD) of left KV by Tanner Stage for PANTHER subjects. Results are reported separately for males and females and stratified by risk status (High = T2D or obese; Low = control).
<!-- tanner stage for boys measured as tan_tveq -->
<!-- tanner stage for girls measured as tan_fgd -->

```{r PANTHER lkv tanner assumptions, eval=FALSE, include=FALSE}
## assumptions check
outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ tan_tveq'))
  mod <- aov(form, data = PAN_left_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = PAN_left_combined_clean)
  print(bartlett_result)
}

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ tan_fgd'))
  mod <- aov(form, data = PAN_left_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = PAN_left_combined_clean)
  print(bartlett_result)
}

check1 <- PAN_left_combined_clean %>% 
  filter(!is.na(tan_tveq)) %>% 
  mutate(kv_data_indicator = ifelse(!is.na(merged_left_kv), 'Y', 'N')) %>% 
  select(merged_id, study, group, tan_tveq, merged_left_kv, ht_adj_merged_left_kv, kv_data_indicator)

table(check1$tan_tveq) # I:3, II:8, III:4, IV:9, V:0
table(check1$tan_tveq, check1$kv_data_indicator) # less than 5 kv obs for stage I, III, V

check2 <- PAN_left_combined_clean %>% 
  filter(!is.na(tan_fgd)) %>%
  mutate(kv_data_indicator = ifelse(!is.na(merged_left_kv), 'Y', 'N')) %>% 
  select(merged_id, study, group, tan_fgd, merged_left_kv, ht_adj_merged_left_kv, kv_data_indicator)

table(check2$tan_fgd) # I:7, II:10, III:11, IV:7, V:1
table(check2$tan_fgd, check2$kv_data_indicator) # less than 5 kv obs for stage V 
```


```{r PANTHER lkv by tanner stage, echo=FALSE, message=FALSE, warning=FALSE}
## summary table with Kruskal-Wallis for testing

# males
PAN_left_combined_clean %>% 
  select(merged_id, merged_left_kv, ht_adj_merged_left_kv, PAN_risk_status, tan_tveq) %>%
  tbl_strata(strata = PAN_risk_status, ~ .x %>% 
  tbl_summary(by = tan_tveq, include = -merged_id,
              type = list(c(merged_left_kv, ht_adj_merged_left_kv) ~ 'continuous', 
                        tan_tveq~'categorical'),
    statistic = list(all_continuous() ~ '{mean} ({sd})'),
    digits = everything()~c(2,2),
    missing_text = 'N Missing') %>% 
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun = ~style_pvalue(.x, digits=3)) %>% 
  modify_header(label = '**Measurement**') %>% 
  modify_caption("**Male Tanner Stage Summary by Risk Status**"))

# females
PAN_left_combined_clean %>% 
  select(merged_id, merged_left_kv, ht_adj_merged_left_kv, PAN_risk_status, tan_fgd) %>%
  tbl_strata(strata = PAN_risk_status, ~ .x %>% 
  tbl_summary(by = tan_fgd, include = -merged_id,
              type = list(c(merged_left_kv, ht_adj_merged_left_kv) ~ 'continuous', 
                        tan_fgd~'categorical'),
    statistic = list(all_continuous() ~ '{mean} ({sd})'),
    digits = everything()~c(2,2),
    missing_text = 'N Missing') %>% 
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun = ~style_pvalue(.x, digits=3)) %>% 
  modify_header(label = '**Measurement**') %>% 
  modify_caption("**Female Tanner Stage Summary by Risk Status**"))
```


### LKV by IGF-1 Concentrations

The below results describe the association between left KV and IGF-1 concentration for PANTHER subjects. Analyses are stratified by risk status (High = T2D or obese; Low = control). Diagnostic plots for checking linear regression assumptions are also included. `merged_left_kv` is the new combined variable of non-manual and manual KV measurements, as described in the Methods section. `ht_adj_merged_left_kv` is the height-adjusted version of `merged_left_kv`.

**High Risk:**
```{r PANTHER lkv by IGF-1 concentrations high risk, echo=FALSE}
HR_left_panther_dat <- PAN_left_combined_clean %>%
  filter(PAN_risk_status == 'High')

outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf_1'))
  mod <- lm(form, data = HR_left_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Concentration")))
  print(summary(mod))
  plot(x=HR_left_panther_dat$igf_1, y=HR_left_panther_dat[[v]], xlab='IGF-1 Concentration', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

$$\\[0.4in]$$

**Low Risk:**
```{r PANTHER lkv by IGF-1 concentrations low risk, echo=FALSE}
LR_left_panther_dat <- PAN_left_combined_clean %>%
  filter(PAN_risk_status == 'Low')

outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf_1'))
  mod <- lm(form, data = LR_left_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Concentration")))
  print(summary(mod))
  plot(x=LR_left_panther_dat$igf_1, y=LR_left_panther_dat[[v]], xlab='IGF-1 Concentration', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

### LKV by IGF-1 Z-Scores

This section reports the association between left KV and IGF-1 Z-scores for PANTHER subjects. Analyses are stratified by risk status (High = T2D or obese; Low = control). Diagnostic plots for checking linear regression assumptions are also included.

**High Risk:**
```{r PANTHER lkv by IGF-1 Z-scores high risk, echo=FALSE}
outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf1_z_score'))
  mod <- lm(form, data = HR_left_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Z-score")))
  print(summary(mod))
  plot(x=HR_left_panther_dat$igf1_z_score, y=HR_left_panther_dat[[v]], xlab='IGF-1 Z-score', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```
$$\\[0.4in]$$
**Low Risk:**
```{r PANTHER lkv by IGF-1 Z-scores low risk, echo=FALSE}
outcome_vars <- c('merged_left_kv','ht_adj_merged_left_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf1_z_score'))
  mod <- lm(form, data = LR_left_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Z-score")))
  print(summary(mod))
  plot(x=LR_left_panther_dat$igf1_z_score, y=LR_left_panther_dat[[v]], xlab='IGF-1 Z-score', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```


# Right Kidney Analyses

## Results: All Studies

### Descriptive Statistics
```{r rkv tab1, echo=FALSE}
table1::table1(~ sex + age + group + diabetes_duration + height_meters + merged_right_kv + 
                 ht_adj_merged_right_kv + merged_rkv_metric_type, 
               data = right_combined_clean, caption = 'Descriptive Statistics of all Participants for Right Kidney Analyses')
```

### RKV by Age

The below results describe the association between right KV and age for subjects across all studies. Diagnostic plots for checking linear regression assumptions are also included. `merged_right_kv` is the new combined variable of non-manual and manual KV measurements, as described in the Methods section. `ht_adj_merged_right_kv` is the height-adjusted version of `merged_right_kv`.

```{r rkv by age, echo=FALSE}
outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ age'))
  mod <- lm(form, data = right_combined_clean)
  print(noquote(c("Association between age and", noquote(v))))
  print(summary(mod))
  plot(x=right_combined_clean$age, y=right_combined_clean[[v]], xlab='age', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative Probability',
       main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

### RKV by Disease Type

The below table reports the mean and standard deviation (SD) of the combined non-manual and manual KV outcomes of interest by disease type across all subjects in the harmonized dataset. Kruskal-Wallis testing was used to evaluate whether there was a significant difference in the mean ranks between groups.

```{r rkv disease type assumptions, eval=FALSE, include=FALSE}
## assumptions check
outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ group'))
  mod <- aov(form, data = right_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = right_combined_clean)
  print(bartlett_result)
}
```


```{r rkv by disease type, echo=FALSE}
## summary table with Kruskal-Wallis for testing
right_combined_clean %>%
  select(record_id, group, merged_right_kv, ht_adj_merged_right_kv) %>%
   tbl_summary(by = group, include = -record_id,
              type = list(c(merged_right_kv, ht_adj_merged_right_kv) ~ 'continuous',
                        group ~ 'categorical'),
    statistic=list(all_continuous() ~ '{mean} ({sd})'),
    digits=everything()~c(2,2),
    missing_text='N Missing') %>%
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun=~style_pvalue(.x, digits=3)) %>%
  modify_header(label='**Measurement**')
```

## Results: PANTHER

### Descriptive Statistics
```{r PANTHER rkv tab1, echo=FALSE}
table1::table1(~ sex + age + group + PAN_risk_status + diabetes_duration + height_meters + merged_right_kv + 
                 ht_adj_merged_right_kv + merged_rkv_metric_type + igf_1 + igf1_z_score + rkv_igf1_date_diff + rkv_tan_date_diff +
                 rkv_PANheight_date_diff, 
               data = PAN_right_combined_clean, caption = 'Descriptive Statistics of Participants for Right Kidney PANTHER Analyses')
```

### RKV by Tanner Stage

The below tables report the mean and standard deviation (SD) of right KV by Tanner Stage for PANTHER subjects. Results are reported separately for males and females and stratified by risk status (High = T2D or obese; Low = control).

```{r rkv tanner assumptions, eval=FALSE, include=FALSE}
## assumptions check
outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ tan_tveq'))
  mod <- aov(form, data = PAN_right_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = PAN_right_combined_clean)
  print(bartlett_result)
}

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ tan_fgd'))
  mod <- aov(form, data = PAN_right_combined_clean)

  qqnorm(mod$residuals)
  qqline(mod$residuals)

  bartlett_result <- bartlett.test(form, data = PAN_right_combined_clean)
  print(bartlett_result)
}

check1 <- PAN_right_combined_clean %>%
  filter(!is.na(tan_tveq)) %>%
  mutate(kv_data_indicator = ifelse(!is.na(merged_right_kv), 'Y', 'N')) %>%
  select(record_id, study, group, tan_tveq, merged_right_kv, ht_adj_merged_right_kv, kv_data_indicator)

table(check1$tan_tveq) # I:3, II:8, III:4, IV:9, V:0
table(check1$tan_tveq, check1$kv_data_indicator) # less than 5 kv obs for stage I, III, V

check2 <- PAN_right_combined_clean %>%
  filter(!is.na(tan_fgd)) %>%
  mutate(kv_data_indicator = ifelse(!is.na(merged_right_kv), 'Y', 'N')) %>%
  select(record_id, study, group, tan_fgd, merged_right_kv, ht_adj_merged_right_kv, kv_data_indicator)

table(check2$tan_fgd) # I:6, II:10, III:11, IV:7, V:1
table(check2$tan_fgd, check2$kv_data_indicator) # less than 5 kv obs for stage V
```


```{r rkv by tanner stage, echo=FALSE, message=FALSE, warning=FALSE}
## summary table with Kruskal-Wallis for testing

# males
PAN_right_combined_clean %>%
  select(record_id, merged_right_kv, ht_adj_merged_right_kv, PAN_risk_status, tan_tveq) %>%
  tbl_strata(strata = PAN_risk_status, ~ .x %>%
  tbl_summary(by = tan_tveq, include = -record_id,
              type = list(c(merged_right_kv, ht_adj_merged_right_kv) ~ 'continuous',
                        tan_tveq~'categorical'),
    statistic = list(all_continuous() ~ '{mean} ({sd})'),
    digits = everything()~c(2,2),
    missing_text = 'N Missing') %>%
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun = ~style_pvalue(.x, digits=3)) %>%
  modify_header(label = '**Measurement**') %>%
  modify_caption("**Male Tanner Stage Summary by Risk Status**"))

# females
PAN_right_combined_clean %>%
  select(record_id, merged_right_kv, ht_adj_merged_right_kv, PAN_risk_status, tan_fgd) %>%
  tbl_strata(strata = PAN_risk_status, ~ .x %>%
  tbl_summary(by = tan_fgd, include = -record_id,
              type = list(c(merged_right_kv, ht_adj_merged_right_kv) ~ 'continuous',
                        tan_fgd~'categorical'),
    statistic = list(all_continuous() ~ '{mean} ({sd})'),
    digits = everything()~c(2,2),
    missing_text = 'N Missing') %>%
  add_p(test = all_continuous() ~ 'kruskal.test',
        pvalue_fun = ~style_pvalue(.x, digits=3)) %>%
  modify_header(label = '**Measurement**') %>%
  modify_caption("**Female Tanner Stage Summary by Risk Status**"))
```

### RKV by IGF-1 Concentrations

The below results describe the association between right KV and IGF-1 concentration for PANTHER subjects. Analyses are stratified by risk status (High = T2D or obese; Low = control). Diagnostic plots for checking linear regression assumptions are also included. `merged_right_kv` is the new combined variable of non-manual and manual KV measurements, as described in the Methods section. `ht_adj_merged_right_kv` is the height-adjusted version of `merged_right_kv`.

**High Risk:**
```{r PANTHER rkv by IGF-1 concentrations high risk, echo=FALSE}
HR_right_panther_dat <- PAN_right_combined_clean %>%
  filter(PAN_risk_status == 'High')

outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf_1'))
  mod <- lm(form, data = HR_right_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Concentration")))
  print(summary(mod))
  plot(x=HR_right_panther_dat$igf_1, y=HR_right_panther_dat[[v]], xlab='IGF-1 Concentration', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

$$\\[0.4in]$$
**Low Risk:**
```{r PANTHER rkv by IGF-1 concentrations low risk, echo=FALSE}
LR_right_panther_dat <- PAN_right_combined_clean %>%
  filter(PAN_risk_status == 'Low')

outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf_1'))
  mod <- lm(form, data = LR_right_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Concentration")))
  print(summary(mod))
  plot(x=LR_right_panther_dat$igf_1, y=LR_right_panther_dat[[v]], xlab='IGF-1 Concentration', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

### RKV by IGF-1 Z-Scores

This section reports the association between right KV and IGF-1 Z-scores for PANTHER subjects. Analyses are stratified by risk status (High = T2D or obese; Low = control). Diagnostic plots for checking linear regression assumptions are also included.

**High Risk:**
```{r PANTHER rkv by IGF-1 Z-scores high risk, echo=FALSE}
outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf1_z_score'))
  mod <- lm(form, data = HR_right_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Z-score")))
  print(summary(mod))
  plot(x=HR_right_panther_dat$igf1_z_score, y=HR_right_panther_dat[[v]], xlab='IGF-1 Z-score', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```
$$\\[0.4in]$$

**Low Risk:**
```{r PANTHER rkv by IGF-1 Z-scores low risk, echo=FALSE}
outcome_vars <- c('merged_right_kv','ht_adj_merged_right_kv')

for (v in outcome_vars) {
  form = as.formula(paste0(v,'~ igf1_z_score'))
  mod <- lm(form, data = LR_right_panther_dat)
  print(noquote(c("Association between", noquote(v), "and IGF-1 Z-score")))
  print(summary(mod))
  plot(x=LR_right_panther_dat$igf1_z_score, y=LR_right_panther_dat[[v]], xlab='IGF-1 Z-score', ylab=noquote(v), main='Y-X Scatterplot'); abline(mod, col='gray', lty=2)
  plot(mod, which=1)
  plot(ppoints(length(rstudent(mod))), sort(pnorm(rstudent(mod))), xlab='Observed Cumulative Probability', ylab='Expected Cumulative
       Probability', main='Normal Probability Plot', cex=1); abline(a=0,b=1, col='gray65', lwd=1)
  hist(rstudent(mod), xlab='Jackknife Residual', main='Histogram of Residuals', freq=F)
  cat('\n\n')
}
```

