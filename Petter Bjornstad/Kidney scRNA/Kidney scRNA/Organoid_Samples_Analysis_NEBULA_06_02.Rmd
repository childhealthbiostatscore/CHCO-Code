---
title: "Organoid Samples Analysis"
author: "Hailey Hampson"
date: "2025-04-16"
output: html_document
---

#1.Set Up 
```{r,include=FALSE}
library(reprex)
library(tidyverse)
library(BiocManager)        
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(future)
library(colorspace)
library(patchwork)
library(ggdendro)
library(cowplot)
library(ggpubr)
library(venn)
library(rstatix)
library(table1)
library(Biobase)
library(ReactomeGSA)
library(GSEABase)
library(msigdbr)
library(kableExtra)
library(knitr)
library(SingleCellExperiment)
library(fgsea)
library(EnhancedVolcano)
library(openxlsx)
library(BiocManager)
library(MAST)
library(ggrepel)
# library(qpcR)
library(ggpubr)
library(openxlsx)
library(ggplot2)
library(GGally)
library(GSEABase)
library(limma)
library(reshape2)
library(data.table)
library(knitr)
# library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(stringr)
#library(NMF)
library(rsvd)
library(RColorBrewer)
library(MAST)
library(devtools)
# install_github("Sun-lab/ideas",force=T)
#library(ideas)
library(foreach)
library(parallel)
library(doRNG)
library(doParallel)
library(fs)
# registerDoParallel(cores = 6)
library(VennDiagram)
library(janitor)
# devtools::install_github('immunogenomics/presto')
library(presto)
library(knitr)
library(lme4)
library(lmerTest)
#install.packages("glmmTMB")
# Reinstall glmmTMB from source
# install.packages("glmmTMB", type = "source")
library(glmmTMB)
# Install DoubletFinder (if not already installed)
# devtools::install_github("chris-mcginnis-ucsf/DoubletFinder",force=T)
# Load the package
# Install DoubletFinder from GitHub (use devtools to install)
# if (!requireNamespace("devtools", quietly = TRUE)) install.packages("devtools")
# devtools::install_github("chris-mcginnis-ucsf/DoubletFinder",force=T)
# library(DoubletFinder)
# install.packages("emmeans")
library(emmeans)
library(pheatmap)
library(enrichplot)
library(enrichR)
dbs <- c("GO_Biological_Process_2023", 
         "KEGG_2021_Human",
         # "Reactome_2022", 
         "Reactome_Pathways_2024",
         # "MSigDB_Oncogenic_Signatures",
         # "MSigDB_Computational",
         "MSigDB_Hallmark_2020")
# BiocManager::install("edgeR",force=T)
library(edgeR)
library(devtools)
# install_github("lhe17/nebula")
# library(nebula)

# remove.packages("boot")  # Remove broken version
# install.packages("boot", type = "source")  # Reinstall from source
library(boot)
library(furrr)
library(future)
# BiocManager::install("scran")
library(scran)
library(BiocParallel)
library(DESeq2)

# #Mac laptop
# dir.dat <- c("//Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive")
# dir.dat2 <- c("/Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive/scRNA")
# dir.code <- c("/Users/hhampson/Documents/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
# dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive/Kidney scRNAseq Project/Organoid Results/NEBULA")

#Mac Studio File Path
dir.dat <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive")
dir.dat2 <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/scRNA")
dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Kidney scRNAseq Project/Organoid Results/NEBULA")

##c. Load functions ----
source("Kidney_functions_sc.R")
source("Rename_Seurat_Function.R")
source("Celltype_Annotation_Function.R")
```

## a. Hyak Data Load
```{r, Cyberduck setup}
# knitr::opts_knit$set(root.dir = dir.results)
# install.packages("reticulate")
# Sys.setenv(RETICULATE_PYTHON = "/home/hailey/miniconda3/envs/py310_env/bin/python")
library(reticulate)
reticulate::py_config()
# library(reticulate)
# reticulate::use_condaenv("py310_env", required = TRUE)
# reticulate::py_config()
# Sys.setenv(LD_LIBRARY_PATH = "/usr/lib/x86_64-linux-gnu")
# reticulate::use_python("/home/hailey/miniconda3/bin/python")
# reticulate::use_condaenv("base", required = TRUE)

## Load boto3 and pandas
boto3 <- reticulate::import("boto3")
pd <- reticulate::import("pandas")

## Create an S3 client
# install.packages("jsonlite")  # Install if not already installed
library(jsonlite)  # Load the package

keys <- fromJSON("/mmfs1/home/hhampson/keys.json") # replace with your Lambda username
session <- boto3$session$Session(
  aws_access_key_id = keys$MY_ACCESS_KEY,
  aws_secret_access_key = keys$MY_SECRET_KEY
)

## Create an S3 client with the session
s3 <- session$client("s3", endpoint_url = "https://s3.kopah.uw.edu")

gc()
bucket <- "scrna" # bucket name in Kopah
temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
s3$download_file(bucket, "Kidney transcriptomics/Single cell RNA seq/PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds", temp_file)
so_kpmp_sc <- readRDS(temp_file)
```

##b. Local Data Load
```{r}
so_kpmp_sc <- readRDS(fs::path(dir.dat2,"data_raw","PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds"))

```

# 2. Pre-Processing & Qualtiy Control
## a. Load Data
### i. Biopsy Data
```{r}
#Set ids for organoid samples
ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")

# ##d. Load Data ----
# so_kpmp_sc <- readRDS(fs::path(dir.dat2,"data_raw","PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds"))
so_kpmp_sc <- subset(so_kpmp_sc,record_id %in% ids)

#Load harmonized data that has been filtered from 90 to the 83 participants that have baseline single cell data
harm_meta_data <- read.csv(fs::path(dir.dat,"Data Harmonization","Data Clean/harmonized_dataset.csv",na=""))

#Hyak load
# gc()
# bucket <- "harmonized.dataset" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
# s3$download_file(bucket, "harmonized_dataset.csv", temp_file)
# harm_meta_data <- read.csv(temp_file)
# harm_meta_data <- read.csv(fs::path(dir.dat,"Data Harmonization","Data Clean/harmonized_dataset.csv",na=""))

harm_meta_data <- harm_meta_data %>%   
  arrange(screen_date) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, first(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, first(na.omit(.x)))),
                   .by = c(record_id, visit))

##e. Filter to 7 organoid samples ----
meta <- harm_meta_data %>% 
  # dplyr::select(-X) %>% 
  filter(visit=="baseline") %>% 
  filter(record_id %in% ids)
rm(harm_meta_data)
#Select metadata from seurat object to facilitate merge of new metadata into seurat object
meta_kidney_sc <-  so_kpmp_sc@meta.data
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)

#Merge metadata from 83 participants at baseline into seurat object metadata
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(meta,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)

#Pull ids from 83 participants at baseline to filter seurat object to these participants only 
ids <- meta$kit_id

#Merge metadata back into seurat object
so_kpmp_sc <- AddMetaData(so_kpmp_sc, meta_kidney_sc)

#Check number of unique ids
length(unique(so_kpmp_sc$kit_id)) #should be 7

#Remove metadatasets
rm(meta_kidney_sc,meta)

# ##f. Merge metadata into filtered seurat object ----
# #Load in most up to date medication data to update medication information
# med <- read.xlsx(fs::path(dir.dat,"Kidney scRNAseq Project/Data/Biopsies_w_mrn_Oct3.xlsx"))
# #Select Metformin, RASSI, Insulin data
# med <- med %>%
#   dplyr::select(all_of(c("record_id","mrn","raasi_1","insulin_1","mfm_1")))
# #Pull seurat object metadata to help harmoinize in new metadata
# meta_kidney_sc <-  so_kpmp_sc@meta.data
# #Filter to only those with a unique identifier id in the seurat object metadata
# med <- med %>%
#   filter(mrn %in% as.character(meta_kidney_sc$mrn)) 
# length(unique(med$mrn)) #6 participants
# #Filter to only those that have a unique record id in the seurat object
# med <- med %>%
#   filter(record_id %in% meta_kidney_sc$record_id) 
# length(unique(med$mrn)) #6 remain
# length(unique(med$record_id)) #6
# rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
# med$mrn <- as.numeric(med$mrn) #Make numeric to merge
# #Merge med data with seurat metadata
# meta_kidney_sc <- meta_kidney_sc %>%
#   left_join(med,by=c("mrn","record_id"))
# rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
# length(unique(meta_kidney_sc$mrn)) #6 remain
# length(unique(meta_kidney_sc$record_id)) #6
# 
# #Add Med Meta Data to Seurat object
# so_kpmp_sc <- AddMetaData(so_kpmp_sc, meta_kidney_sc)
# #Remove med metadatset
# rm(med,meta_kidney_sc)

#Create medication & disease status groups of interest
so_kpmp_sc@meta.data <- so_kpmp_sc@meta.data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>%
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>%
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>%
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups:
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
invisible(gc())
so_kpmp_sc@meta.data <- so_kpmp_sc@meta.data %>%
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
# so_kpmp_sc@meta.data$medication <- factor(so_kpmp_sc@meta.data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Ensure default assay in seurat object to RNA
DefaultAssay(so_kpmp_sc) <- "RNA"
invisible(gc())

# #Calculate cell library size for offset
# counts_layer <- round(GetAssayData(so_kpmp_sc, layer = "counts")) # load counts and round
# library_size <- Matrix::colSums(counts_layer) #calculate the column sums aka the sum of all genes in each cell
# so_kpmp_sc$library_size <- library_size #Put into the seurat object
# #Check that it is accessible in the metadata
# meta <- so_kpmp_sc@meta.data #It should be in the dataframe, delete meta data check df
# rm(meta,counts_layer)
# hist(so_kpmp_sc$library_size)

# #Perform Quality Control & Preprocessing Steps
ncol(so_kpmp_sc) #11386 cells
nrow(so_kpmp_sc) #31332 genes
#YE JI's filtering code for percent expression
#Filter out rare genes expressed in less than "gene_pct" of cells
# expr_matrix <- as.matrix(GetAssayData(so_kpmp_sc, layer = "counts"))
expr_matrix <- as.matrix(GetAssayData(so_kpmp_sc, assay = "RNA", layer = "counts"))
# expr_matrix <- as.matrix(so_kpmp_sc@assays$RNA@layers$counts)
# Calculate the proportion of cells expressing each gene
num_cells_per_gene <- rowSums(expr_matrix > 0)  # Count nonzero cells per gene
total_cells <- ncol(expr_matrix)  # Total number of cells
gene_proportion <- num_cells_per_gene / total_cells  # Fraction of cells expressing each gene
remove(expr_matrix)
# Keep genes expressed in at least "gene_pct" of cells
genes_to_keep <- names(gene_proportion[gene_proportion >= 0.05])
so_kpmp_sc <- subset(so_kpmp_sc, features = genes_to_keep)
ncol(so_kpmp_sc) #11386 Cells
nrow(so_kpmp_sc) # 9209 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_kpmp_sc), value = TRUE)
#keep_ids <- unique(rownames(so_kpmp_sc)[which(!rownames(so_kpmp_sc) %in% mito_genes)])
# so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), mito_genes))
# so_kpmp_sc <- subset(so_kpmp_sc,kit_id!="KL-0029535")
#so_kpmp_sc$Gene <- rownames(so_kpmp_sc)
#so_kpmp_sc <- subset(so_kpmp_sc, Gene %in% keep_ids)
so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), mito_genes))
#so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc@assays$RNA@counts), mito_genes))
# so_kpmp_sc <- subset(so_kpmp_sc, !rownames(so_kpmp_sc) %in% mito_genes)
# grep("^MT-", rownames(so_kpmp_sc@assays$RNA@counts), value = TRUE)
# dim(so_kpmp_sc@assays$RNA@counts) #9276 186125
# dim(so_kpmp_sc@assays$RNA@data) #9276 186125
# dim(so_kpmp_sc@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(so_kpmp_sc))) #0
ncol(so_kpmp_sc) #11386 cells
nrow(so_kpmp_sc) #9196 genes

#Step 3: Remove ribosomal Genes
# Identify ribosomal genes
ribo_genes <- c(
  "RPL22", "RPL11", "RPS8", "RPL5", "RPS27", "RPS7", "RPS27A", "RPL31", "RPL37A", "RPL32", "RPL15", "RPL14", "RPL29",
  "RPL24", "RPL22L1", "RPL35A", "RPL9", "RPL34", "RPS3A", "RPL37", "RPS23", "RPS14", "RPS18", "RPS10", "RPL10A", 
  "RPS20", "RPL7", "RPL30", "RPL8", "RPS6", "RPL35", "RPL12", "RPL7A", "RPS24", "RPLP2", "RPL27A", "RPS13", "RPS3",
  "RPS25", "RPS26", "RPL41", "RPL6", "RPLP0", "RPL21", "RPS29", "RPL4", "RPLP1", "RPS17", "RPS2", "RPS15A", "RPL13",
  "RPL26", "RPL23A", "RPL23", "RPL19", "RPL27", "RPL38", "RPL17", "RPS15", "RPL36", "RPS28", "RPL18A", "RPS16", 
  "RPS19", "RPL18", "RPL13A", "RPS11", "RPS9", "RPL28", "RPS5", "RPS21", "RPL3", "RPS4X", "RPL36A", "RPL39", 
  "RPL10", "RPS4Y1"
)
so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), ribo_genes))
# sum(grepl("^MT-", rownames(so_kpmp_sc))) #0
length(which(rownames(so_kpmp_sc) %in% ribo_genes)) #0
ncol(so_kpmp_sc) #65,062 cells
nrow(so_kpmp_sc) #15103 genes

#Renormalize & Scale after filtering
so_kpmp_sc <- NormalizeData(so_kpmp_sc)
so_kpmp_sc <- ScaleData(so_kpmp_sc, features = VariableFeatures(so_kpmp_sc))

# Calculate cell library size for offset in NEBULA --------------------------------------
counts_layer <- round(GetAssayData(so_kpmp_sc, layer = "counts"))
library_size <- Matrix::colSums(counts_layer)
so_kpmp_sc$library_size <- library_size
# View(so_kpmp_sc@meta.data)
hist(so_kpmp_sc$library_size)

# # TMM offset
# dge <- DGEList(counts = counts_layer)
# dge <- calcNormFactors(dge, method = "TMM")
# tmm_offset <- log(dge$samples$lib.size) + log(dge$samples$norm.factors)
# so_kpmp_sc$tmm_offset <- tmm_offset

# Pooled offset
# bp <- MulticoreParam(workers = 63)
bp <- MulticoreParam(workers = 9)
sce <- SingleCellExperiment(assays = list(counts = counts_layer))
# sce <- computeSumFactors(sce)
sce <- computeSumFactors(sce, BPPARAM = bp)
# View size factors
# sizeFactors(sce)
# STEP 3: Calculate offset → log(size factors)
pooled_offset <- sizeFactors(sce)
so_kpmp_sc$pooled_offset <- pooled_offset
hist(so_kpmp_sc$pooled_offset)

# saveRDS(so_kpmp_sc,fs::path(dir.dat,"scRNA","data_clean","organoid_scRNA_cleaned.RDS"))
# so_kpmp_sc <- readRDS(fs::path(dir.dat,"scRNA","data_clean","organoid_scRNA_cleaned.RDS"))
#Create general hepatocyte cell type variable
#Create PT and TAL pseudobulk cell type variable
so_kpmp_sc$celltype1 <- case_when(grepl("PT-",so_kpmp_sc$celltype_rpca)~"PT",
                                  grepl("TAL-",so_kpmp_sc$celltype_rpca)~"TAL",
                                  grepl("EC-",so_kpmp_sc$celltype_rpca)~"EC",
                                  grepl("POD",so_kpmp_sc$celltype_rpca)~"POD",
                                  grepl("MAC",so_kpmp_sc$celltype_rpca)~"MAC",
                                  grepl("MON",so_kpmp_sc$celltype_rpca)~"MON",
                                  grepl("PC-",so_kpmp_sc$celltype_rpca)~"PC",
                                  grepl("FIB",so_kpmp_sc$celltype_rpca)~"FIB_MC_VSMC",
                                  grepl("DTL",so_kpmp_sc$celltype_rpca)~"DTL",
                                  so_kpmp_sc$celltype_rpca=="DCT"~"DCT",
                                  so_kpmp_sc$celltype_rpca=="ATL"~"ATL",
                                  so_kpmp_sc$celltype_rpca=="B"~"B",
                                  so_kpmp_sc$celltype_rpca=="T"~"T")
so_kpmp_sc$celltype1 <- as.character(so_kpmp_sc$celltype1)

so_kpmp_sc$KPMP_celltype2 <- as.character(so_kpmp_sc$KPMP_celltype)
so_kpmp_sc$celltype2 <- ifelse(so_kpmp_sc$KPMP_celltype=="aPT" | 
                                 so_kpmp_sc$KPMP_celltype=="PT-S1/S2" | 
                                 so_kpmp_sc$KPMP_celltype == "PT-S3","PT",
                               ifelse(grepl("TAL",so_kpmp_sc$KPMP_celltype),"TAL",
                                      ifelse(grepl("EC-",so_kpmp_sc$KPMP_celltype),"EC",so_kpmp_sc$KPMP_celltype2)))

#High level celltypes
# Comprehensive cell type annotation for kidney single-cell data
so_kpmp_sc$celltype_LR <- case_when(
  
  # PROXIMAL TUBULE (PT) - All proximal tubule segments
  so_kpmp_sc$KPMP_celltype %in% c("aPT", "PT-S1/S2", "PT-S3") ~ "PT",
  
  # THICK ASCENDING LIMB (TAL) - All TAL variants
  grepl("TAL", so_kpmp_sc$KPMP_celltype) ~ "TAL",
  
  # THIN LIMBS - Descending and ascending thin limbs
  so_kpmp_sc$KPMP_celltype %in% c("DTL", "aDTL", "ATL") ~ "Thin_Limbs",
  
  # DISTAL CONVOLUTED TUBULE (DCT)
  grepl("DCT", so_kpmp_sc$KPMP_celltype) ~ "DCT",
  
  # CONNECTING TUBULE (CNT) - Including CNT and principal cells
  so_kpmp_sc$KPMP_celltype %in% c("CNT", "CNT-PC") ~ "CNT",
  
  # COLLECTING DUCT PRINCIPAL CELLS (PC)
  so_kpmp_sc$KPMP_celltype %in% c("CCD-PC", "dCCD-PC", "M-PC") ~ "PC",
  
  # INTERCALATED CELLS (IC) - All IC subtypes
  grepl("IC", so_kpmp_sc$KPMP_celltype) | so_kpmp_sc$KPMP_celltype == "aIC" ~ "IC",
  
  # ENDOTHELIAL CELLS (EC) - All endothelial subtypes
  grepl("EC-", so_kpmp_sc$KPMP_celltype) | so_kpmp_sc$KPMP_celltype == "EC/VSMC" ~ "EC",
  
  # PODOCYTES
  so_kpmp_sc$KPMP_celltype == "POD" ~ "POD",
  
  # PARIETAL EPITHELIAL CELLS
  so_kpmp_sc$KPMP_celltype == "PEC" ~ "PEC",
  
  # IMMUNE CELLS - All immune cell types
  so_kpmp_sc$KPMP_celltype %in% c("MON", "cDC", "pDC", "MAC", "CD4+ T", "CD8+ T", 
                                  "cycT", "B", "NK", "MC") ~ "Immune",
  
  # FIBROBLASTS
  so_kpmp_sc$KPMP_celltype == "FIB" ~ "Fibroblast",
  
  # VASCULAR SMOOTH MUSCLE CELLS/PERICYTES
  so_kpmp_sc$KPMP_celltype == "VSMC/P" ~ "VSMC_Pericyte",
  
  # SCHWANN CELLS
  so_kpmp_sc$KPMP_celltype == "SchwannCells" ~ "Schwann",
  
  # NON-SPECIFIC/UNKNOWN
  so_kpmp_sc$KPMP_celltype == "non-specific" ~ "Nonspecific",
  
  # DEFAULT - anything not captured above
  TRUE ~ "Other"
)

final_counts <- table(so_kpmp_sc$celltype_LR)
print(final_counts)
print(prop.table(final_counts) * 100)

```

### ii. Organoid Data
```{r}
ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")
# unique(sc_org$samples) #"sample_50_15"   "sample_42_15"   "sample_50_30"   "sample_41_1_15" "sample_11_30"   "ITD19_30" #"sample_10_15"   "sample_72_15"   "sample_10_30"   "ITD19_15"       "sample_41_1_30" "sample_72_30"  
#  "41_G_15"        "sample_42_30"   "41_G_30"        "sample_11_15"  
# DKD ids were 42, 50 and 72 and the controls were 10, 11 and 41 

# The 10 and 11 have iCRC, the 50 and 72 have RH, and the remaining ones _ 41, 42, and ITD19 _ don’t have any letters.
#CRC10 -sample_10_15, "sample_10_30
# CRC11 - sample_11_15, sample_11_30
# CRC03 (aka ‘line 41) - "41_G_15", "41_G_30" , sample_41_1_15, sample_41_1_30

# RH50T -  "sample_50_30", sample_50_15
# RH72T -  "sample_72_15" ,sample_72_30
# RH62T (aka ‘line 42’) - "sample_42_15",  "sample_42_30"
# IT2D19 - ITD19_30, ITD19_15

#41 iPS clone I
# 41 iPS clone G

# gc()
# bucket <- "scrna" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
# s3$download_file(bucket, "data_raw/organoids_processed_matrix.rds", temp_file)
# sc_org <- readRDS(temp_file)


sc_org <- readRDS(fs::path(dir.dat,"scRNA","data_raw","organoids_processed_matrix.rds"))

#Rename rwonames of sc_org with gene names
# Make sure the gene names are aligned in the same order
# gene_ids <- rownames(sc_org)
# new_gene_names <- sc_org@misc$gene_annotations$name
# 
# gene_map <- data.frame(
#   feature_id = gene_ids,
#   gene_name = new_gene_names,
#   row.names = gene_ids,  # Keep feature_id as rownames so we can cbind
#   stringsAsFactors = FALSE
# )

# source(fs::path(here::here(),"Petter Bjornstad","Liver analysis","Liver scRNAseq","Rename_Seurat_Function.R"))
# Extract the components as you mentioned
gene_ids <- rownames(sc_org)
new_gene_names <- sc_org@misc$gene_annotations$name

# Rename the Seurat object
sc_org_renamed <- rename_seurat_genes(sc_org, new_gene_names)

# Verify the rename worked
print(paste("Original rownames (first 10):", paste(head(gene_ids, 10), collapse = ", ")))
print(paste("New rownames (first 10):", paste(head(rownames(sc_org_renamed), 10), collapse = ", ")))

# Check that dimensions are preserved
print(paste("Original dimensions:", paste(dim(sc_org), collapse = " x ")))
print(paste("New dimensions:", paste(dim(sc_org_renamed), collapse = " x ")))

#Save old seurat to sc_or_old
sc_org_old <- sc_org
sc_org <- sc_org_renamed

meta <- sc_org@meta.data

diab_ids <- c("sample_50_15","sample_50_30","sample_72_15","sample_72_30","sample_42_15","sample_42_30","ITD19_15","ITD19_30")
control_ids <- c("sample_10_15","sample_10_30","sample_11_15","sample_11_30","41_G_15","41_G_30","sample_41_1_15","sample_41_1_30")

sc_org$diabetes <- ifelse(sc_org$samples %in% diab_ids,"Diabetes","Control")
sc_org$diabetes <- factor(sc_org$diabetes)

# biopsy_ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")
sc_org@meta.data <- sc_org@meta.data %>% 
  mutate(record_id = case_when(sc_org$samples=="sample_10_15" | sc_org$samples=="sample_10_30" ~ "CRC-10",
                               sc_org$samples=="sample_11_15" | sc_org$samples=="sample_11_30" ~ "CRC-11",
                               sc_org$samples=="41_G_15" | sc_org$samples=="41_G_30" | 
                                 sc_org$samples=="sample_41_1_15" | sc_org$samples=="sample_41_1_30" ~"CRC-03",
                               sc_org$samples=="sample_50_15" | sc_org$samples=="sample_50_30" ~ "RH-50-T",
                               sc_org$samples=="sample_72_15" | sc_org$samples=="sample_72_30" ~ "RH-72-T",
                               sc_org$samples=="sample_42_15" | sc_org$samples=="sample_42_30" ~ "RH-62-T",
                               sc_org$samples=="ITD19_15" | sc_org$samples=="ITD19_30" ~ "IT_19"))
# meta <- sc_org@meta.data

#Get gene annotations & rename rows
# gene_annotations <- data.frame(sc_org@misc$gene_annotations)
nrow(sc_org) #62,754 genes
ncol(sc_org) #194,063 cells
rownames(sc_org)
colnames(sc_org)


# # #Load harmonized data that has been filtered from 90 to the 83 participants that have baseline single cell data
# harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney scRNAseq Project","Data","harmonized_data_kidney_sc_all_metadata2.csv"))
# gc()
# bucket <- "harmonized.dataset" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
# s3$download_file(bucket, "harmonized_dataset.csv", temp_file)
# harm_meta_data <- read.csv(temp_file)

# harm_meta_data <- read.csv("/Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive/Data Harmonization/Data Clean/harmonized_dataset.csv",na="")
harm_meta_data <- read.csv(fs::path(dir.dat,"Data Harmonization","Data Clean/harmonized_dataset.csv",na=""))
harm_meta_data <- harm_meta_data %>%   
  arrange(screen_date) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, first(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, first(na.omit(.x)))),
                   .by = c(record_id, visit))

##e. Filter to 6 organoid samples ----
meta <- harm_meta_data %>% 
  # dplyr::select(-X) %>% 
  filter(visit=="baseline") %>% 
  filter(record_id %in% ids)
rm(harm_meta_data)
#Select metadata from seurat object to facilitate merge of new metadata into seurat object
meta_kidney_sc <-  sc_org@meta.data
rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)

#Merge metadata from 83 participants at baseline into seurat object metadata
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(meta,by="record_id")
rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)

#Pull ids from 83 participants at baseline to filter seurat object to these participants only 
ids <- meta$kit_id

#Merge metadata back into seurat object
sc_org <- AddMetaData(sc_org, meta_kidney_sc)

#Check number of unique ids
length(unique(sc_org$kit_id)) #should be 7

#Remove metadatasets
rm(meta_kidney_sc,meta)

# ##e. Filter to 6 organoid samples ----
# meta <- harm_meta_data %>%
#   dplyr::select(-X) %>%
#   filter(record_id %in% ids)
# rm(harm_meta_data)
# #Select metadata from seurat object to facilitate merge of new metadata into seurat object
# meta_kidney_sc <-  sc_org@meta.data
# rownames(meta_kidney_sc) <-NULL
# rownames(meta) <- NULL
# 
# #Merge metadata from 83 participants at baseline into seurat object metadata
# meta_kidney_sc <- meta_kidney_sc %>%
#   left_join(meta,by="record_id")
# rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)
# 
# #Pull ids from 83 participants at baseline to filter seurat object to these participants only
# ids <- meta$record_id

# #Merge metadata back into seurat object
# sc_org <- AddMetaData(sc_org, meta_kidney_sc)
# 
# #Check number of unique ids
# length(unique(sc_org$kit_id)) #should be 7
# 
# #Remove metadatasets
# rm(meta_kidney_sc,meta)

# ##f. Merge metadata into filtered seurat object ----
# #Load in most up to date medication data to update medication information
# med <- read.xlsx(fs::path(dir.dat,"Kidney scRNAseq Project/Data/Biopsies_w_mrn_Oct3.xlsx"))
# #Select Metformin, RASSI, Insulin data
# med <- med %>%
#   dplyr::select(all_of(c("record_id","mrn","raasi_1","insulin_1","mfm_1")))
# #Pull seurat object metadata to help harmoinize in new metadata
# meta_kidney_sc <-  sc_org@meta.data
# #Filter to only those with a unique identifier id in the seurat object metadata
# med <- med %>%
#   filter(mrn %in% as.character(meta_kidney_sc$mrn))
# length(unique(med$mrn)) #6 participants
# #Filter to only those that have a unique record id in the seurat object
# med <- med %>%
#   filter(record_id %in% meta_kidney_sc$record_id)
# length(unique(med$mrn)) #7 remain
# length(unique(med$record_id)) #7
# rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)
# med$mrn <- as.numeric(med$mrn) #Make numeric to merge
# #Merge med data with seurat metadata
# meta_kidney_sc <- meta_kidney_sc %>%
#   left_join(med,by=c("mrn","record_id"))
# rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)
# length(unique(meta_kidney_sc$mrn)) #7 remain
# length(unique(meta_kidney_sc$record_id)) #7
# 
# #Add Med Meta Data to Seurat object
# sc_org <- AddMetaData(sc_org, meta_kidney_sc)
# #Remove med metadatset
# rm(med,meta_kidney_sc)

#Create medication & disease status groups of interest
sc_org@meta.data <- sc_org@meta.data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>%
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>%
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>%
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups:
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
invisible(gc())
sc_org@meta.data <- sc_org@meta.data %>%
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
sc_org@meta.data$medication <- factor(sc_org@meta.data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

# #Ensure default assay in seurat object to RNA
DefaultAssay(sc_org) <- "RNA"
# invisible(gc())

# #Calculate cell library size for offset
# counts_layer <- round(GetAssayData(sc_org, layer = "counts")) # load counts and round
# library_size <- Matrix::colSums(counts_layer) #calculate the column sums aka the sum of all genes in each cell
# sc_org$library_size <- library_size #Put into the seurat object
# #Check that it is accessible in the metadata
# meta <- sc_org@meta.data #It should be in the dataframe, delete meta data check df
# rm(meta,counts_layer)
# hist(sc_org$library_size)

# #Perform Quality Control & Preprocessing Steps
# ncol(sc_org) #11386 cells
# nrow(sc_org) #31332 genes
nrow(sc_org) #62,754 genes before filtering
ncol(sc_org) #194,063 cells before filtering
#YE JI's filtering code for percent expression
#Filter out rare genes expressed in less than "gene_pct" of cells
# expr_matrix <- as.matrix(GetAssayData(sc_org, layer = "counts"))
# expr_matrix <- as.matrix(GetAssayData(sc_org, assay = "RNA", layer = "counts"))


#Filter out cells that express less than 500 genes or more than 5000 genes and cells that have more than 50% of gene expression coming from mitochondrial genes
sc_org <- subset(sc_org,
                 subset = nFeature_RNA > 500 &
                   nFeature_RNA < 5000 &
                   percent.mt < 50)

nrow(sc_org) #62,754 genes before filtering
ncol(sc_org) #156387 cells after filltering

expr_matrix <- GetAssayData(sc_org, assay = "RNA", layer = "counts")

# expr_matrix <- as.matrix(sc_org@assays$RNA@layers$counts)
# Calculate the proportion of cells expressing each gene
num_cells_per_gene <- rowSums(expr_matrix > 0)  # Count nonzero cells per gene
total_cells <- ncol(expr_matrix)  # Total number of cells
gene_proportion <- num_cells_per_gene / total_cells  # Fraction of cells expressing each gene
remove(expr_matrix)
# Keep genes expressed in at least "gene_pct" of cells
genes_to_keep <- names(gene_proportion[gene_proportion >= 0.05])
sc_org <- subset(sc_org, features = genes_to_keep)
ncol(sc_org) #156387 Cells
nrow(sc_org) # 7472 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(sc_org), value = TRUE)
#keep_ids <- unique(rownames(sc_org)[which(!rownames(sc_org) %in% mito_genes)])
# sc_org <- subset(sc_org, features = setdiff(rownames(sc_org), mito_genes))
# sc_org <- subset(sc_org,kit_id!="KL-0029535")
#sc_org$Gene <- rownames(sc_org)
#sc_org <- subset(sc_org, Gene %in% keep_ids)
sc_org <- subset(sc_org, features = setdiff(rownames(sc_org), mito_genes))
#sc_org <- subset(sc_org, features = setdiff(rownames(sc_org@assays$RNA@counts), mito_genes))
# sc_org <- subset(sc_org, !rownames(sc_org) %in% mito_genes)
# grep("^MT-", rownames(sc_org@assays$RNA@counts), value = TRUE)
# dim(sc_org@assays$RNA@counts) #9276 186125
# dim(sc_org@assays$RNA@data) #9276 186125
# dim(sc_org@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(sc_org))) #0
ncol(sc_org) #156387 cells
nrow(sc_org) #7472 genes

#Step 3: Remove ribosomal Genes
# Identify ribosomal genes
ribo_genes <- c(
  "RPL22", "RPL11", "RPS8", "RPL5", "RPS27", "RPS7", "RPS27A", "RPL31", "RPL37A", "RPL32", "RPL15", "RPL14", "RPL29",
  "RPL24", "RPL22L1", "RPL35A", "RPL9", "RPL34", "RPS3A", "RPL37", "RPS23", "RPS14", "RPS18", "RPS10", "RPL10A", 
  "RPS20", "RPL7", "RPL30", "RPL8", "RPS6", "RPL35", "RPL12", "RPL7A", "RPS24", "RPLP2", "RPL27A", "RPS13", "RPS3",
  "RPS25", "RPS26", "RPL41", "RPL6", "RPLP0", "RPL21", "RPS29", "RPL4", "RPLP1", "RPS17", "RPS2", "RPS15A", "RPL13",
  "RPL26", "RPL23A", "RPL23", "RPL19", "RPL27", "RPL38", "RPL17", "RPS15", "RPL36", "RPS28", "RPL18A", "RPS16", 
  "RPS19", "RPL18", "RPL13A", "RPS11", "RPS9", "RPL28", "RPS5", "RPS21", "RPL3", "RPS4X", "RPL36A", "RPL39", 
  "RPL10", "RPS4Y1"
)
sc_org <- subset(sc_org, features = setdiff(rownames(sc_org), ribo_genes))
# sum(grepl("^MT-", rownames(sc_org))) #0
length(which(rownames(sc_org) %in% ribo_genes)) #0
ncol(sc_org) #156387 cells
nrow(sc_org) #7472 genes

#Renormalize & Scale after filtering
sc_org <- NormalizeData(sc_org)
sc_org <- ScaleData(sc_org, features = VariableFeatures(sc_org))

# Calculate cell library size for offset in NEBULA --------------------------------------
counts_layer <- round(GetAssayData(sc_org, layer = "counts"))
library_size <- Matrix::colSums(counts_layer)
sc_org$library_size <- library_size
# View(sc_org@meta.data)
# hist(sc_org$library_size)

# # TMM offset
# dge <- DGEList(counts = counts_layer)
# dge <- calcNormFactors(dge, method = "TMM")
# tmm_offset <- log(dge$samples$lib.size) + log(dge$samples$norm.factors)
# sc_org$tmm_offset <- tmm_offset

# # Pooled offset
# # bp <- MulticoreParam(workers = 63) 
# sce <- SingleCellExperiment(assays = list(counts = counts_layer))
# sce <- computeSumFactors(sce)
# # sce <- computeSumFactors(sce, BPPARAM = bp)
# # View size factors
# # sizeFactors(sce)
# # STEP 3: Calculate offset → log(size factors)
# pooled_offset <- sizeFactors(sce)
# sc_org$pooled_offset <- pooled_offset
# hist(sc_org$pooled_offset)

# saveRDS(sc_org,fs::path(dir.dat,"scRNA","data_clean","organoid_scRNA_cleaned.RDS"))
# sc_org <- readRDS(fs::path(dir.dat,"scRNA","data_clean","organoid_scRNA_cleaned.RDS"))
#Create general hepatocyte cell type variable
#Create PT and TAL pseudobulk cell type variable
# sc_org$celltype1 <- case_when(grepl("PT-",sc_org$`ScType-Kidney-human`)~"PT",
#                                   grepl("TAL-",sc_org$`ScType-Kidney-human`)~"TAL",
#                                   grepl("EC-",sc_org$`ScType-Kidney-human`)~"EC",
#                                   grepl("POD",sc_org$`ScType-Kidney-human`)~"POD",
#                                   grepl("MAC",sc_org$`ScType-Kidney-human`)~"MAC",
#                                   grepl("MON",sc_org$`ScType-Kidney-human`)~"MON",
#                                   grepl("PC-",sc_org$`ScType-Kidney-human`)~"PC",
#                                   grepl("FIB",sc_org$`ScType-Kidney-human`)~"FIB_MC_VSMC",
#                                   grepl("DTL",sc_org$`ScType-Kidney-human`)~"DTL",
#                                   sc_org$`ScType-Kidney-human`=="DCT"~"DCT",
#                                   sc_org$`ScType-Kidney-human`=="ATL"~"ATL",
#                                   sc_org$`ScType-Kidney-human`=="B"~"B",
#                                   sc_org$`ScType-Kidney-human`=="T"~"T")
# sc_org$celltype1 <- as.character(sc_org$celltype1)

# # sc_org$KPMP_celltype2 <- as.character(sc_org$KPMP_celltype)
# sc_org$celltype2 <- ifelse(sc_org$KPMP_celltype=="Proximal tubule cells","PT",sc_org$KPMP_celltype2)))

#Create treatment variable
sc_org$treatment <- ifelse(grepl("15$",sc_org$samples),"15","30")

# #Format gene names for results
# gene_annotations <- gene_annotations %>% 
#   dplyr::rename(Gene = `NA.`) %>%
#   dplyr::select(c("Gene","input"))
# rownames(gene_annotations) <- NULL
rm(sce,counts_layer)

#Merge gene names
sc_org <- NormalizeData(sc_org)
sc_org <- ScaleData(sc_org, features = VariableFeatures(sc_org))
```

## b. Annotate Biopsy Data
```{r}
so_biopsy <- so_kpmp_sc

#Define marker genes for each kidney cell type
#1. Low res from Raji
marker_genes <- list(
  "PT" = c("CUBN", "LRP2"),                    # Proximal Tubule
  "DTL" = c("AQP1", "ID1"),                    # Descending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA"),               # Ascending Thin Limb
  "TAL" = c("UMOD", "SLC12A1"),               # Thick Ascending Limb
  "DCT" = c("SLC12A3"),                       # Distal Convoluted Tubule
  "CNT" = c("SLC8A1"),                        # Connecting Tubule
  "PC" = c("FXYD4"),                          # Principal Cells
  "IC" = c("ATP6V0D2"),                       # Intercalated Cells
  "EC" = c("EMCN"),                           # Endothelial Cells
  "Immune" = c("PTPRC"),                      # Immune cells
  "Interstitial" = c("ACTA2", "RGS5")        # Interstitial cells
)

# Annotate cell types (adjust min_score_diff as needed)
so_biopsy_annotated <- annotate_celltypes(so_biopsy, marker_genes, min_score_diff = 0.05)
so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_biopsy_annotated <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = T)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
# DimPlot(so_biopsy_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# # Generate plots
# plots <- plot_celltype_results(so_biopsy, reduction = "umap")
# 
# # Display plots
# print(plots$annotation_plot)
# if (!is.null(plots$score_plot)) {
#   print(plots$score_plot)
# }
# print(plots$confidence_plot)


###############################################################################################################
#2. Low resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_Low_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_biopsy, marker_df)

# Step 2: Annotate your Seurat object
annotation_results <- annotate_from_dataframe(
  seurat_obj = so_biopsy,
  marker_df = marker_df,
  celltype_col = "Celltype",
  marker_col = "Pos_Marker_Genes",
  min_score_diff = 0.1
)

# Step 3: Extract results
so_biopsy_annotated <- annotation_results$seurat_object
marker_genes_used <- annotation_results$marker_genes
annotation_summary <- annotation_results$annotation_summary

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = F)

DimPlot(so_biopsy_annotated, reduction = "umap.harmony", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (Human Biopsy)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (Human Biopsy)")
# DimPlot(so_biopsy_annotated, reduction = "harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")

###############################################################################
#3. High resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_High_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
# marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_biopsy, marker_df)

# Annotate using dual markers
dual_results <- annotate_from_dataframe_dual(
  seurat_obj = so_biopsy,
  marker_df = marker_df,
  celltype_col = "Celltype",
  pos_marker_col = "Pos_Marker_Genes",
  neg_marker_col = "Neg_Marker_Genes",
  min_score_diff = 0.02,
  neg_weight = 0.5  # Weight for negative markers (0.5 = half weight)
)


# Step 3: Extract results
so_biopsy_annotated <- dual_results$seurat_object
# marker_genes_used <- dual_results$marker_genes
# annotation_summary <- dual_results$annotation_summary

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = T)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation_dual", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (15 Glucose Conc.)")
# DimPlot(so_biopsy_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_biopsy_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
###############################################################################
#4. Low Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers_simple <- list(
  # MAJOR EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2"),  # Proximal Tubule (all segments)
  "TAL" = c("SLC12A1", "UMOD", "CASR"),  # Thick Ascending Limb
  "DT" = c("SLC12A3", "GATA3", "TRPM6"),  # Distal Tubule
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Principal Cells
  "IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2"),  # Intercalated Cells
  # PROGENITOR
  "NPC" = c("SIX2", "CITED1", "MEOX1"),  # Nephron Progenitor Cells
  # MESENCHYMAL/STROMAL
  "Mesenchymal" = c("ACTA2", "COL3A1", "COL1A1", "RGS5", "PDGFRB"),
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34"),
  # IMMUNE
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  # ORGANOID-SPECIFIC
  "Proliferating" = c("MKI67", "TOP2A", "PCNA"),
  "Off_target" = c("MAP2", "TUBB3", "MITF", "TYR")  # Neuronal + Melanoma-like
)
# Annotate cell types (adjust min_score_diff as needed)
so_biopsy_annotated <- annotate_celltypes(so_biopsy, organoid_markers_simple, min_score_diff = 0.1)

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_biopsy_annotated <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = F)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (15 Glucose Conc.)")

###############################################################################
#5. High Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers <- list(
  # EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "PTPRQ", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),  # Proximal Tubule
  "PST" = c("LRP2", "CUBN", "SLC13A1"),  # Proximal Straight Tubule
  "tDL" = c("SLC4A11", "CLDN16"),  # thin Descending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16"),  # Thick Ascending Limb
  "TAL_DCT" = c("SLC12A1", "SLC12A3", "GATA3"),  # TAL/DCT transition
  "GATA3_DT" = c("GATA3", "SLC12A3", "TRPM6", "KLHL3"),  # GATA3+ Distal Tubule
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Collecting Duct Principal Cells
  "CD_IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2", "ATP6V0D2"),  # Collecting Duct Intercalated Cells
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3"),  # Mixed PC/IC
  # PROGENITOR CELLS
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX"),  # Nephron Progenitor Cells
  # MESENCHYMAL CELL TYPES  
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM"),
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2"),
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3"),
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),  # vascular Smooth Muscle Cells
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN"),
  # IMMUNE CELLS
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1"),
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2"),
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1"),
  # ADDITIONAL ORGANOID-SPECIFIC TYPES
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN"),
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1"),
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1"),
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6"),
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1"),
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT"),
  # BASED ON VIOLIN PLOT GENES
  "MAL_positive" = c("MAL", "WFDC2"),  # Specific population from violin plots
  "APOE_positive" = c("APOE", "CLU", "ABCA1"),  # Another specific population
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3")  # SPP1+ population
)

so_biopsy_annotated <- annotate_celltypes(so_biopsy, organoid_markers, min_score_diff = 0.1)

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_biopsy_annotated <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = F)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
###############################################################################
#make a union gene marker set
#6. Union marker genes for low-resolution kidney cell annotation
union_marker_genes <- list(
  # Connecting Tubule
  "CNT" = c("CALB1", "HSD11B2", "SCN2A", "SLC8A1"),
  
  # Distal Convoluted Tubule
  "DCT" = c("CNNM2", "FGF13", "GATA3", "KLHL3", "LHX1", "SLC12A3", "TRPM6"),
  
  # Endothelial Cells
  "EC" = c("CD34", "COX4I2", "EMCN", "FLT1", "MEIS2", "PECAM1", "PTPRB", "VWF"),
  
  # Intercalated Cells
  "IC" = c("ATP6V0D2", "ATP6V1C2", "CLNK", "SLC26A4", "SLC4A1", "TMEM213"),
  
  # Immune Cells
  "Immune" = c("CD3D", "CD68", "NKG7", "PTPRC"),
  
  # Mesenchymal/Interstitial/Fibroblast/Vascular Smooth Muscle/Pericytes
  "Mesenchymal" = c("ACTA2", "C7", "CDH11", "COL1A1", "COL1A2", "COL3A1", 
                    "DCN", "FBLN5", "ITGA8", "NEGR1", "NOTCH3", "PDGFRB", "RGS5"),
  
  # Nephron Progenitor Cells
  "NPC" = c("CITED1", "MEOX1", "SIX2"),
  
  # Off-target/Neuronal cells
  "Off_target" = c("CDH19", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR"),
  
  # Principal Cells
  "PC" = c("AQP2", "AQP3", "FXYD4", "GATA3"),
  
  # Parietal Epithelial Cells
  "PEC" = c("ALDH1A2", "CFH", "CLDN1", "RBFOX1", "VCAM1"),
  
  # Proximal Tubule
  "PT" = c("CUBN", "LRP2", "SLC13A1", "SLC5A2"),
  
  # Podocyte
  "Podocyte" = c("CLIC5", "NPHS1", "NPHS2", "NTNG1", "PODXL", "PTPRQ", "WT1"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "PCNA", "TOP2A"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "KCNJ1", "CLDN16", "CLDN19", "CLCNKB"),
  
  # Thin Limb (combines Descending and Ascending Thin Limb)
  "TL" = c("AQP1", "BOC", "CLCNKA", "CLDN3", "COL26A1", "CRYAB", 
           "ID1", "KLRG2", "SLC44A5", "TACSTD2")
)
so_biopsy_annotated <- annotate_celltypes(so_biopsy, union_marker_genes, min_score_diff = 0.1)

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_biopsy_annotated <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = F)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (15 Glucose Conc.)")
####################################
#7. High-resolution union marker genes for detailed kidney cell annotation
high_res_union_marker_genes <- list(
  
  # ==== GLOMERULAR CELL TYPES ====
  # Podocytes
  "Podocyte" = c("NPHS1", "NPHS2", "PTPRQ", "WT1", "PODXL", "CLIC5", "NTNG1"),
  
  # Parietal Epithelial Cells
  "PEC" = c("CLDN1", "VCAM1", "CFH", "RBFOX1", "ALDH1A2"),
  
  # Mesangial Cells
  "Mesangial" = c("ACTA2", "COL4A1", "PDGFRB", "RGS5", "ITGB1", "TIMP1"),
  
  # ==== PROXIMAL TUBULE SUBTYPES ====
  # Proximal Tubule S1
  "PT_S1" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8", "HAVCR1"),
  
  # Proximal Tubule S2
  "PT_S2" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "MIOX"),
  
  # Proximal Tubule S3/Proximal Straight Tubule
  "PT_S3" = c("LRP2", "CUBN", "SLC13A1", "UMOD", "SLC22A12"),
  
  # General Proximal Tubule (for broader classification)
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),
  
  # ==== LOOP OF HENLE ====
  # Descending Thin Limb
  "DTL" = c("AQP1", "SLC4A11", "CLDN16", "ID1"),
  
  # Ascending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA", "CLDN16", "SLC26A7"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16", "KCNJ1"),
  
  # TAL Macula Densa
  "TAL_MD" = c("SLC12A1", "UMOD", "CASR", "NOS1", "COX2"),
  
  # ==== DISTAL CONVOLUTED TUBULE ====
  # Distal Convoluted Tubule 1
  "DCT1" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "NCX1"),
  
  # Distal Convoluted Tubule 2
  "DCT2" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "SCNN1A"),
  
  # General DCT
  "DCT" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "LHX1", "CNNM2", "FGF13"),
  
  # ==== CONNECTING TUBULE ====
  "CNT" = c("SLC8A1", "SCN2A", "HSD11B2", "CALB1", "SCNN1A", "SCNN1B"),
  
  # ==== COLLECTING DUCT ====
  # Collecting Duct Principal Cells
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4", "SCNN1A", "SCNN1B", "SCNN1G"),
  
  # Collecting Duct Intercalated Cells Type A
  "CD_IC_A" = c("SLC4A1", "ATP6V1C2", "ATP6V0D2", "CA2", "RHCG"),
  
  # Collecting Duct Intercalated Cells Type B
  "CD_IC_B" = c("SLC26A4", "ATP6V1C2", "ATP6V0D2", "CA2", "SLC4A9"),
  
  # Mixed PC/IC (transition cells)
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3", "ATP6V1C2"),
  
  # General IC
  "IC" = c("ATP6V0D2", "ATP6V1C2", "TMEM213", "CLNK", "SLC4A1", "SLC26A4"),
  
  # General PC
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),
  
  # ==== PROGENITOR CELLS ====
  # Nephron Progenitor Cells
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX", "OSR1", "EYA1"),
  
  # Stromal Progenitor Cells
  "SPC" = c("FOXD1", "MEIS1", "MEIS2", "HOXD11"),
  
  # ==== MESENCHYMAL/STROMAL SUBTYPES ====
  # Mesangial and Fibroblasts
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM", "PDGFRB"),
  
  # Pericytes Type 1
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2", "CSPG4", "MCAM"),
  
  # Pericytes Type 2
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3", "CSPG4", "ITGA8"),
  
  # Vascular Smooth Muscle Cells
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1", "MYLK", "MYOCD"),
  
  # Interstitial Fibroblasts
  "Fibroblast" = c("COL1A1", "COL1A2", "C7", "NEGR1", "FBLN5", "DCN", "CDH11"),
  
  # ==== VASCULAR CELL TYPES ====
  # Glomerular Endothelial Cells
  "GEC" = c("PECAM1", "EMCN", "EHHADH", "PLVAP", "PODXL2", "FLT1"),
  
  # Peritubular Capillary Endothelial Cells
  "PTC" = c("PECAM1", "VWF", "CD34", "FLT1", "PLVAP", "CA4"),
  
  # Arterial Endothelial Cells
  "AEC" = c("PECAM1", "VWF", "CD34", "FLT1", "GJA5", "BMX"),
  
  # Venous Endothelial Cells
  "VEC" = c("PECAM1", "VWF", "CD34", "FLT1", "ACKR1", "SELP"),
  
  # General Endothelial
  "EC" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN", "PTPRB", "MEIS2"),
  
  # ==== IMMUNE CELL SUBTYPES ====
  # Macrophages
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1", "CD163", "MRC1"),
  
  # Dendritic Cells
  "Dendritic" = c("CD68", "PTPRC", "ITGAX", "FCER1A", "CD1C"),
  
  # T Cells
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2", "CD3G", "TRAC"),
  
  # B Cells
  "B_Cells" = c("CD79A", "CD79B", "PTPRC", "MS4A1", "PAX5"),
  
  # Natural Killer T Cells
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1", "GZMB", "PRF1"),
  
  # Neutrophils
  "Neutrophils" = c("ELANE", "MPO", "DEFA4", "PTPRC", "CSF3R"),
  
  # General Immune
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  
  # ==== ORGANOID-SPECIFIC TYPES ====
  # Muscle-like cells Type 1
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),
  
  # Muscle-like cells Type 2
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1", "MYLK"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1", "CENPF"),
  
  # Neuronal precursors
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6", "NEUROD1"),
  
  # Neuron-like cells
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1", "NEFL"),
  
  # Melanoma-like cells
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT", "PMEL"),
  
  # ==== SPECIAL POPULATIONS ====
  # MAL-positive cells
  "MAL_positive" = c("MAL", "WFDC2", "SCGB1A1"),
  
  # APOE-positive cells
  "APOE_positive" = c("APOE", "CLU", "ABCA1", "LDLR"),
  
  # SPP1-positive cells
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3", "HAVCR1"),
  
  # ==== OFF-TARGET POPULATIONS ====
  "Off_target" = c("CDH19", "NRXN1", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR")
)

so_biopsy_annotated <- annotate_celltypes(so_biopsy, high_res_union_marker_genes, min_score_diff = 0.1)

so_biopsy_annotated <- NormalizeData(so_biopsy_annotated)
so_biopsy_annotated <- ScaleData(so_biopsy_annotated, features = VariableFeatures(so_biopsy_annotated))
so_biopsy_annotated <- FindVariableFeatures(object = so_biopsy_annotated)
so_biopsy_annotated <- RunPCA(so_biopsy_annotated, features = VariableFeatures(object = so_biopsy_annotated),assay="RNA")
# ElbowPlot(so_biopsy_annotated)

# # Find neighbors and clusters (again using integrated data)
so_biopsy_annotated <- FindNeighbors(so_biopsy_annotated, assay = "RNA", dims = 1:20)
so_biopsy_annotated <- FindClusters(so_biopsy_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_biopsy_annotated <- RunTSNE(so_biopsy_annotated, dims = 1:20)
so_biopsy_annotated@reductions
DimPlot(so_biopsy_annotated, reduction = "umap", raster = F)

DimPlot(so_biopsy_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (15 Glucose Conc.)")
DimPlot(so_biopsy_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (15 Glucose Conc.)")

####################################
# Create all visualizations
all_viz <- create_all_visualizations(
  seurat_obj = so_biopsy,
  marker_genes = marker_genes,  # from previous extraction or manual list
  celltype_column = "celltype_annotation",
  reduction = "umap",
  sample_column = "orig.ident",  # if you have sample information
  save_plots = TRUE,
  output_prefix = "kidney_celltypes"
)

# Access individual plot types:
all_viz$basic_plots$main_umap
all_viz$marker_plots$heatmap
all_viz$summary_stats
```

## c. Annotate Organoid Data - Top Down
###i. Separate 15 and 30 glucose conc.
```{r}
so_15 <- subset(sc_org,treatment=="15")
so_30 <- subset(sc_org,treatment=="30")
so_combined <- sc_org
```
###ii. 15 Gluc Conc.
```{r}
#Define marker genes for each kidney cell type
#Beno Paper Markers
#Left Half: 
marker_genes <- list(
  "Podocytes" = c("SYNPO", "WT1", "NPHS1", "PODXL"),     # Podocytes
  "PEC" = c("CLDN1", "PAX8"),                             # Parietal Epithelial Cells
  "PT" = c("CUBN", "SLC22A6"),                            # Proximal Tubule (SLC22A6 = OAT1)
  "CD" = c("AQP2"),                                       # Collecting Duct
  "EC" = c("EMCN"),                                       # Endothelial Cells (if shown)
  "Interstitial" = c("ACTA2", "RGS5")                     # Interstitial cells (if shown)
)

# Annotate cell types (adjust min_score_diff as needed)
so_15_annotated <- annotate_celltypes(so_15, marker_genes, min_score_diff = 0.05)
so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = T)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")

#Right Half: 
marker_genes <- list(
  "Podocytes" = c("SYNPO", "WT1", "NPHS1", "PODXL"),     # Podocytes
  "PEC" = c("CLDN1", "PAX8"),                             # Parietal Epithelial Cells
  "PT" = c("CUBN", "SLC22A6"),                            # Proximal Tubule (SLC22A6 = OAT1)
  "CD" = c("AQP2"),                                       # Collecting Duct
  "EC" = c("EMCN"),                                       # Endothelial Cells (if shown)
  "Interstitial" = c("ACTA2", "RGS5")                     # Interstitial cells (if shown)
)

# Annotate cell types (adjust min_score_diff as needed)
so_15_annotated <- annotate_celltypes(so_15, marker_genes, min_score_diff = 0.05)
so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = T)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")

#1. Low res from Raji
marker_genes <- list(
  "PT" = c("CUBN", "LRP2"),                    # Proximal Tubule
  "DTL" = c("AQP1", "ID1"),                    # Descending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA"),               # Ascending Thin Limb
  "TAL" = c("UMOD", "SLC12A1"),               # Thick Ascending Limb
  "DCT" = c("SLC12A3"),                       # Distal Convoluted Tubule
  "CNT" = c("SLC8A1"),                        # Connecting Tubule
  "PC" = c("FXYD4"),                          # Principal Cells
  "IC" = c("ATP6V0D2"),                       # Intercalated Cells
  "EC" = c("EMCN"),                           # Endothelial Cells
  "Immune" = c("PTPRC"),                      # Immune cells
  "Interstitial" = c("ACTA2", "RGS5")        # Interstitial cells
)

# Annotate cell types (adjust min_score_diff as needed)
so_15_annotated <- annotate_celltypes(so_15, marker_genes, min_score_diff = 0.05)
so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = T)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (15 Glucose Conc.)")
# DimPlot(so_15_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# # Generate plots
# plots <- plot_celltype_results(so_15, reduction = "umap")
# 
# # Display plots
# print(plots$annotation_plot)
# if (!is.null(plots$score_plot)) {
#   print(plots$score_plot)
# }
# print(plots$confidence_plot)


###############################################################################################################
#2. Low resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_Low_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_15, marker_df)

# Step 2: Annotate your Seurat object
annotation_results <- annotate_from_dataframe(
  seurat_obj = so_15,
  marker_df = marker_df,
  celltype_col = "Celltype",
  marker_col = "Pos_Marker_Genes",
  min_score_diff = 0.1
)

# Step 3: Extract results
so_15_annotated <- annotation_results$seurat_object
marker_genes_used <- annotation_results$marker_genes
annotation_summary <- annotation_results$annotation_summary

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = F)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (15 Glucose Conc.)")
# DimPlot(so_15_annotated, reduction = "harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")

###############################################################################
#3. High resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_High_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
# marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_15, marker_df)

# Annotate using dual markers
dual_results <- annotate_from_dataframe_dual(
  seurat_obj = so_15,
  marker_df = marker_df,
  celltype_col = "Celltype",
  pos_marker_col = "Pos_Marker_Genes",
  neg_marker_col = "Neg_Marker_Genes",
  min_score_diff = 0.02,
  neg_weight = 0.5  # Weight for negative markers (0.5 = half weight)
)


# Step 3: Extract results
so_15_annotated <- dual_results$seurat_object
# marker_genes_used <- dual_results$marker_genes
# annotation_summary <- dual_results$annotation_summary

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = T)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation_dual", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (15 Glucose Conc.)")
# DimPlot(so_15_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_15_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
###############################################################################
#4. Low Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers_simple <- list(
  # MAJOR EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2"),  # Proximal Tubule (all segments)
  "TAL" = c("SLC12A1", "UMOD", "CASR"),  # Thick Ascending Limb
  "DT" = c("SLC12A3", "GATA3", "TRPM6"),  # Distal Tubule
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Principal Cells
  "IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2"),  # Intercalated Cells
  # PROGENITOR
  "NPC" = c("SIX2", "CITED1", "MEOX1"),  # Nephron Progenitor Cells
  # MESENCHYMAL/STROMAL
  "Mesenchymal" = c("ACTA2", "COL3A1", "COL1A1", "RGS5", "PDGFRB"),
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34"),
  # IMMUNE
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  # ORGANOID-SPECIFIC
  "Proliferating" = c("MKI67", "TOP2A", "PCNA"),
  "Off_target" = c("MAP2", "TUBB3", "MITF", "TYR")  # Neuronal + Melanoma-like
)
# Annotate cell types (adjust min_score_diff as needed)
so_15_annotated <- annotate_celltypes(so_15, organoid_markers_simple, min_score_diff = 0.1)

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = F)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (15 Glucose Conc.)")

###############################################################################
#5. High Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers <- list(
  # EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "PTPRQ", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),  # Proximal Tubule
  "PST" = c("LRP2", "CUBN", "SLC13A1"),  # Proximal Straight Tubule
  "tDL" = c("SLC4A11", "CLDN16"),  # thin Descending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16"),  # Thick Ascending Limb
  "TAL_DCT" = c("SLC12A1", "SLC12A3", "GATA3"),  # TAL/DCT transition
  "GATA3_DT" = c("GATA3", "SLC12A3", "TRPM6", "KLHL3"),  # GATA3+ Distal Tubule
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Collecting Duct Principal Cells
  "CD_IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2", "ATP6V0D2"),  # Collecting Duct Intercalated Cells
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3"),  # Mixed PC/IC
  # PROGENITOR CELLS
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX"),  # Nephron Progenitor Cells
  # MESENCHYMAL CELL TYPES  
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM"),
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2"),
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3"),
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),  # vascular Smooth Muscle Cells
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN"),
  # IMMUNE CELLS
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1"),
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2"),
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1"),
  # ADDITIONAL ORGANOID-SPECIFIC TYPES
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN"),
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1"),
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1"),
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6"),
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1"),
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT"),
  # BASED ON VIOLIN PLOT GENES
  "MAL_positive" = c("MAL", "WFDC2"),  # Specific population from violin plots
  "APOE_positive" = c("APOE", "CLU", "ABCA1"),  # Another specific population
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3")  # SPP1+ population
)

so_15_annotated <- annotate_celltypes(so_15, organoid_markers, min_score_diff = 0.1)

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = F)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (15 Glucose Conc.)")
###############################################################################
#make a union gene marker set
#6. Union marker genes for low-resolution kidney cell annotation
union_marker_genes <- list(
  # Connecting Tubule
  "CNT" = c("CALB1", "HSD11B2", "SCN2A", "SLC8A1"),
  
  # Distal Convoluted Tubule
  "DCT" = c("CNNM2", "FGF13", "GATA3", "KLHL3", "LHX1", "SLC12A3", "TRPM6"),
  
  # Endothelial Cells
  "EC" = c("CD34", "COX4I2", "EMCN", "FLT1", "MEIS2", "PECAM1", "PTPRB", "VWF"),
  
  # Intercalated Cells
  "IC" = c("ATP6V0D2", "ATP6V1C2", "CLNK", "SLC26A4", "SLC4A1", "TMEM213"),
  
  # Immune Cells
  "Immune" = c("CD3D", "CD68", "NKG7", "PTPRC"),
  
  # Mesenchymal/Interstitial/Fibroblast/Vascular Smooth Muscle/Pericytes
  "Mesenchymal" = c("ACTA2", "C7", "CDH11", "COL1A1", "COL1A2", "COL3A1", 
                    "DCN", "FBLN5", "ITGA8", "NEGR1", "NOTCH3", "PDGFRB", "RGS5"),
  
  # Nephron Progenitor Cells
  "NPC" = c("CITED1", "MEOX1", "SIX2"),
  
  # Off-target/Neuronal cells
  "Off_target" = c("CDH19", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR"),
  
  # Principal Cells
  "PC" = c("AQP2", "AQP3", "FXYD4", "GATA3"),
  
  # Parietal Epithelial Cells
  "PEC" = c("ALDH1A2", "CFH", "CLDN1", "RBFOX1", "VCAM1"),
  
  # Proximal Tubule
  "PT" = c("CUBN", "LRP2", "SLC13A1", "SLC5A2"),
  
  # Podocyte
  "Podocyte" = c("CLIC5", "NPHS1", "NPHS2", "NTNG1", "PODXL", "PTPRQ", "WT1"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "PCNA", "TOP2A"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "KCNJ1", "CLDN16", "CLDN19", "CLCNKB"),
  
  # Thin Limb (combines Descending and Ascending Thin Limb)
  "TL" = c("AQP1", "BOC", "CLCNKA", "CLDN3", "COL26A1", "CRYAB", 
           "ID1", "KLRG2", "SLC44A5", "TACSTD2")
)
so_15_annotated <- annotate_celltypes(so_15, union_marker_genes, min_score_diff = 0.1)

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = F)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (15 Glucose Conc.)")
####################################
#7. High-resolution union marker genes for detailed kidney cell annotation
high_res_union_marker_genes <- list(
  
  # ==== GLOMERULAR CELL TYPES ====
  # Podocytes
  "Podocyte" = c("NPHS1", "NPHS2", "PTPRQ", "WT1", "PODXL", "CLIC5", "NTNG1"),
  
  # Parietal Epithelial Cells
  "PEC" = c("CLDN1", "VCAM1", "CFH", "RBFOX1", "ALDH1A2"),
  
  # Mesangial Cells
  "Mesangial" = c("ACTA2", "COL4A1", "PDGFRB", "RGS5", "ITGB1", "TIMP1"),
  
  # ==== PROXIMAL TUBULE SUBTYPES ====
  # Proximal Tubule S1
  "PT_S1" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8", "HAVCR1"),
  
  # Proximal Tubule S2
  "PT_S2" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "MIOX"),
  
  # Proximal Tubule S3/Proximal Straight Tubule
  "PT_S3" = c("LRP2", "CUBN", "SLC13A1", "UMOD", "SLC22A12"),
  
  # General Proximal Tubule (for broader classification)
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),
  
  # ==== LOOP OF HENLE ====
  # Descending Thin Limb
  "DTL" = c("AQP1", "SLC4A11", "CLDN16", "ID1"),
  
  # Ascending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA", "CLDN16", "SLC26A7"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16", "KCNJ1"),
  
  # TAL Macula Densa
  "TAL_MD" = c("SLC12A1", "UMOD", "CASR", "NOS1", "COX2"),
  
  # ==== DISTAL CONVOLUTED TUBULE ====
  # Distal Convoluted Tubule 1
  "DCT1" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "NCX1"),
  
  # Distal Convoluted Tubule 2
  "DCT2" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "SCNN1A"),
  
  # General DCT
  "DCT" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "LHX1", "CNNM2", "FGF13"),
  
  # ==== CONNECTING TUBULE ====
  "CNT" = c("SLC8A1", "SCN2A", "HSD11B2", "CALB1", "SCNN1A", "SCNN1B"),
  
  # ==== COLLECTING DUCT ====
  # Collecting Duct Principal Cells
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4", "SCNN1A", "SCNN1B", "SCNN1G"),
  
  # Collecting Duct Intercalated Cells Type A
  "CD_IC_A" = c("SLC4A1", "ATP6V1C2", "ATP6V0D2", "CA2", "RHCG"),
  
  # Collecting Duct Intercalated Cells Type B
  "CD_IC_B" = c("SLC26A4", "ATP6V1C2", "ATP6V0D2", "CA2", "SLC4A9"),
  
  # Mixed PC/IC (transition cells)
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3", "ATP6V1C2"),
  
  # General IC
  "IC" = c("ATP6V0D2", "ATP6V1C2", "TMEM213", "CLNK", "SLC4A1", "SLC26A4"),
  
  # General PC
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),
  
  # ==== PROGENITOR CELLS ====
  # Nephron Progenitor Cells
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX", "OSR1", "EYA1"),
  
  # Stromal Progenitor Cells
  "SPC" = c("FOXD1", "MEIS1", "MEIS2", "HOXD11"),
  
  # ==== MESENCHYMAL/STROMAL SUBTYPES ====
  # Mesangial and Fibroblasts
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM", "PDGFRB"),
  
  # Pericytes Type 1
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2", "CSPG4", "MCAM"),
  
  # Pericytes Type 2
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3", "CSPG4", "ITGA8"),
  
  # Vascular Smooth Muscle Cells
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1", "MYLK", "MYOCD"),
  
  # Interstitial Fibroblasts
  "Fibroblast" = c("COL1A1", "COL1A2", "C7", "NEGR1", "FBLN5", "DCN", "CDH11"),
  
  # ==== VASCULAR CELL TYPES ====
  # Glomerular Endothelial Cells
  "GEC" = c("PECAM1", "EMCN", "EHHADH", "PLVAP", "PODXL2", "FLT1"),
  
  # Peritubular Capillary Endothelial Cells
  "PTC" = c("PECAM1", "VWF", "CD34", "FLT1", "PLVAP", "CA4"),
  
  # Arterial Endothelial Cells
  "AEC" = c("PECAM1", "VWF", "CD34", "FLT1", "GJA5", "BMX"),
  
  # Venous Endothelial Cells
  "VEC" = c("PECAM1", "VWF", "CD34", "FLT1", "ACKR1", "SELP"),
  
  # General Endothelial
  "EC" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN", "PTPRB", "MEIS2"),
  
  # ==== IMMUNE CELL SUBTYPES ====
  # Macrophages
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1", "CD163", "MRC1"),
  
  # Dendritic Cells
  "Dendritic" = c("CD68", "PTPRC", "ITGAX", "FCER1A", "CD1C"),
  
  # T Cells
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2", "CD3G", "TRAC"),
  
  # B Cells
  "B_Cells" = c("CD79A", "CD79B", "PTPRC", "MS4A1", "PAX5"),
  
  # Natural Killer T Cells
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1", "GZMB", "PRF1"),
  
  # Neutrophils
  "Neutrophils" = c("ELANE", "MPO", "DEFA4", "PTPRC", "CSF3R"),
  
  # General Immune
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  
  # ==== ORGANOID-SPECIFIC TYPES ====
  # Muscle-like cells Type 1
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),
  
  # Muscle-like cells Type 2
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1", "MYLK"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1", "CENPF"),
  
  # Neuronal precursors
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6", "NEUROD1"),
  
  # Neuron-like cells
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1", "NEFL"),
  
  # Melanoma-like cells
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT", "PMEL"),
  
  # ==== SPECIAL POPULATIONS ====
  # MAL-positive cells
  "MAL_positive" = c("MAL", "WFDC2", "SCGB1A1"),
  
  # APOE-positive cells
  "APOE_positive" = c("APOE", "CLU", "ABCA1", "LDLR"),
  
  # SPP1-positive cells
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3", "HAVCR1"),
  
  # ==== OFF-TARGET POPULATIONS ====
  "Off_target" = c("CDH19", "NRXN1", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR")
)

so_15_annotated <- annotate_celltypes(so_15, high_res_union_marker_genes, min_score_diff = 0.1)

so_15_annotated <- NormalizeData(so_15_annotated)
so_15_annotated <- ScaleData(so_15_annotated, features = VariableFeatures(so_15_annotated))
so_15_annotated <- FindVariableFeatures(object = so_15_annotated)
so_15_annotated <- RunPCA(so_15_annotated, features = VariableFeatures(object = so_15_annotated),assay="RNA")
# ElbowPlot(so_15_annotated)

# # Find neighbors and clusters (again using integrated data)
so_15_annotated <- FindNeighbors(so_15_annotated, assay = "RNA", dims = 1:20)
so_15_annotated <- FindClusters(so_15_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_15_annotated <- RunTSNE(so_15_annotated, dims = 1:20)
so_15_annotated@reductions
DimPlot(so_15_annotated, reduction = "umap", raster = F)

DimPlot(so_15_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (15 Glucose Conc.)")
DimPlot(so_15_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (15 Glucose Conc.)")

####################################
# Create all visualizations
all_viz <- create_all_visualizations(
  seurat_obj = so_15,
  marker_genes = marker_genes,  # from previous extraction or manual list
  celltype_column = "celltype_annotation",
  reduction = "umap",
  sample_column = "orig.ident",  # if you have sample information
  save_plots = TRUE,
  output_prefix = "kidney_celltypes"
)

# Access individual plot types:
all_viz$basic_plots$main_umap
all_viz$marker_plots$heatmap
all_viz$summary_stats
```
###iii. 30 Gluc Conc.
```{r}
#Define marker genes for each kidney cell type
#1. Low res from Raji
marker_genes <- list(
  "PT" = c("CUBN", "LRP2"),                    # Proximal Tubule
  "DTL" = c("AQP1", "ID1"),                    # Descending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA"),               # Ascending Thin Limb
  "TAL" = c("UMOD", "SLC12A1"),               # Thick Ascending Limb
  "DCT" = c("SLC12A3"),                       # Distal Convoluted Tubule
  "CNT" = c("SLC8A1"),                        # Connecting Tubule
  "PC" = c("FXYD4"),                          # Principal Cells
  "IC" = c("ATP6V0D2"),                       # Intercalated Cells
  "EC" = c("EMCN"),                           # Endothelial Cells
  "Immune" = c("PTPRC"),                      # Immune cells
  "Interstitial" = c("ACTA2", "RGS5")        # Interstitial cells
)

# Annotate cell types (adjust min_score_diff as needed)
so_30_annotated <- annotate_celltypes(so_30, marker_genes, min_score_diff = 0.1)
so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_30_annotated <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = T)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (30 Glucose Conc.)")
# DimPlot(so_30_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# # Generate plots
# plots <- plot_celltype_results(so_30, reduction = "umap")
# 
# # Display plots
# print(plots$annotation_plot)
# if (!is.null(plots$score_plot)) {
#   print(plots$score_plot)
# }
# print(plots$confidence_plot)


###############################################################################################################
#2. Low resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_Low_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_30, marker_df)

# Step 2: Annotate your Seurat object
annotation_results <- annotate_from_dataframe(
  seurat_obj = so_30,
  marker_df = marker_df,
  celltype_col = "Celltype",
  marker_col = "Pos_Marker_Genes",
  min_score_diff = 0.1
)

# Step 3: Extract results
so_30_annotated <- annotation_results$seurat_object
marker_genes_used <- annotation_results$marker_genes
annotation_summary <- annotation_results$annotation_summary

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = F)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (30 Glucose Conc.)")
# DimPlot(so_30_annotated, reduction = "harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")

###############################################################################
#3. High resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_High_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
# marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_30, marker_df)

# Annotate using dual markers
dual_results <- annotate_from_dataframe_dual(
  seurat_obj = so_30,
  marker_df = marker_df,
  celltype_col = "Celltype",
  pos_marker_col = "Pos_Marker_Genes",
  neg_marker_col = "Neg_Marker_Genes",
  min_score_diff = 0.1,
  neg_weight = 0.5  # Weight for negative markers (0.5 = half weight)
)


# Step 3: Extract results
so_30_annotated <- dual_results$seurat_object
# marker_genes_used <- dual_results$marker_genes
# annotation_summary <- dual_results$annotation_summary

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
# ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = T)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation_dual", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (30 Glucose Conc.)")
# DimPlot(so_30_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_30_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
###############################################################################
#4. Low Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers_simple <- list(
  # MAJOR EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2"),  # Proximal Tubule (all segments)
  "TAL" = c("SLC12A1", "UMOD", "CASR"),  # Thick Ascending Limb
  "DT" = c("SLC12A3", "GATA3", "TRPM6"),  # Distal Tubule
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Principal Cells
  "IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2"),  # Intercalated Cells
  # PROGENITOR
  "NPC" = c("SIX2", "CITED1", "MEOX1"),  # Nephron Progenitor Cells
  # MESENCHYMAL/STROMAL
  "Mesenchymal" = c("ACTA2", "COL3A1", "COL1A1", "RGS5", "PDGFRB"),
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34"),
  # IMMUNE
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  # ORGANOID-SPECIFIC
  "Proliferating" = c("MKI67", "TOP2A", "PCNA"),
  "Off_target" = c("MAP2", "TUBB3", "MITF", "TYR")  # Neuronal + Melanoma-like
)
# Annotate cell types (adjust min_score_diff as needed)
so_30_annotated <- annotate_celltypes(so_30, organoid_markers_simple, min_score_diff = 0.1)

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
# ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_30_annotated <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = F)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (30 Glucose Conc.)")

###############################################################################
#5. High Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers <- list(
  # EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "PTPRQ", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),  # Proximal Tubule
  "PST" = c("LRP2", "CUBN", "SLC13A1"),  # Proximal Straight Tubule
  "tDL" = c("SLC4A11", "CLDN16"),  # thin Descending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16"),  # Thick Ascending Limb
  "TAL_DCT" = c("SLC12A1", "SLC12A3", "GATA3"),  # TAL/DCT transition
  "GATA3_DT" = c("GATA3", "SLC12A3", "TRPM6", "KLHL3"),  # GATA3+ Distal Tubule
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Collecting Duct Principal Cells
  "CD_IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2", "ATP6V0D2"),  # Collecting Duct Intercalated Cells
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3"),  # Mixed PC/IC
  # PROGENITOR CELLS
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX"),  # Nephron Progenitor Cells
  # MESENCHYMAL CELL TYPES  
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM"),
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2"),
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3"),
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),  # vascular Smooth Muscle Cells
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN"),
  # IMMUNE CELLS
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1"),
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2"),
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1"),
  # ADDITIONAL ORGANOID-SPECIFIC TYPES
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN"),
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1"),
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1"),
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6"),
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1"),
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT"),
  # BASED ON VIOLIN PLOT GENES
  "MAL_positive" = c("MAL", "WFDC2"),  # Specific population from violin plots
  "APOE_positive" = c("APOE", "CLU", "ABCA1"),  # Another specific population
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3")  # SPP1+ population
)

so_30_annotated <- annotate_celltypes(so_30, organoid_markers, min_score_diff = 0.1)

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
# ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_30_annotated <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = F)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (30 Glucose Conc.)")
###############################################################################
#make a union gene marker set
#6. Union marker genes for low-resolution kidney cell annotation
union_marker_genes <- list(
  # Connecting Tubule
  "CNT" = c("CALB1", "HSD11B2", "SCN2A", "SLC8A1"),
  
  # Distal Convoluted Tubule
  "DCT" = c("CNNM2", "FGF13", "GATA3", "KLHL3", "LHX1", "SLC12A3", "TRPM6"),
  
  # Endothelial Cells
  "EC" = c("CD34", "COX4I2", "EMCN", "FLT1", "MEIS2", "PECAM1", "PTPRB", "VWF"),
  
  # Intercalated Cells
  "IC" = c("ATP6V0D2", "ATP6V1C2", "CLNK", "SLC26A4", "SLC4A1", "TMEM213"),
  
  # Immune Cells
  "Immune" = c("CD3D", "CD68", "NKG7", "PTPRC"),
  
  # Mesenchymal/Interstitial/Fibroblast/Vascular Smooth Muscle/Pericytes
  "Mesenchymal" = c("ACTA2", "C7", "CDH11", "COL1A1", "COL1A2", "COL3A1", 
                    "DCN", "FBLN5", "ITGA8", "NEGR1", "NOTCH3", "PDGFRB", "RGS5"),
  
  # Nephron Progenitor Cells
  "NPC" = c("CITED1", "MEOX1", "SIX2"),
  
  # Off-target/Neuronal cells
  "Off_target" = c("CDH19", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR"),
  
  # Principal Cells
  "PC" = c("AQP2", "AQP3", "FXYD4", "GATA3"),
  
  # Parietal Epithelial Cells
  "PEC" = c("ALDH1A2", "CFH", "CLDN1", "RBFOX1", "VCAM1"),
  
  # Proximal Tubule
  "PT" = c("CUBN", "LRP2", "SLC13A1", "SLC5A2"),
  
  # Podocyte
  "Podocyte" = c("CLIC5", "NPHS1", "NPHS2", "NTNG1", "PODXL", "PTPRQ", "WT1"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "PCNA", "TOP2A"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "KCNJ1", "CLDN16", "CLDN19", "CLCNKB"),
  
  # Thin Limb (combines Descending and Ascending Thin Limb)
  "TL" = c("AQP1", "BOC", "CLCNKA", "CLDN3", "COL26A1", "CRYAB", 
           "ID1", "KLRG2", "SLC44A5", "TACSTD2")
)
so_30_annotated <- annotate_celltypes(so_30, union_marker_genes, min_score_diff = 0.1)

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
# ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_30_annotated <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = F)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (30 Glucose Conc.)")
####################################
#7. High-resolution union marker genes for detailed kidney cell annotation
high_res_union_marker_genes <- list(
  
  # ==== GLOMERULAR CELL TYPES ====
  # Podocytes
  "Podocyte" = c("NPHS1", "NPHS2", "PTPRQ", "WT1", "PODXL", "CLIC5", "NTNG1"),
  
  # Parietal Epithelial Cells
  "PEC" = c("CLDN1", "VCAM1", "CFH", "RBFOX1", "ALDH1A2"),
  
  # Mesangial Cells
  "Mesangial" = c("ACTA2", "COL4A1", "PDGFRB", "RGS5", "ITGB1", "TIMP1"),
  
  # ==== PROXIMAL TUBULE SUBTYPES ====
  # Proximal Tubule S1
  "PT_S1" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8", "HAVCR1"),
  
  # Proximal Tubule S2
  "PT_S2" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "MIOX"),
  
  # Proximal Tubule S3/Proximal Straight Tubule
  "PT_S3" = c("LRP2", "CUBN", "SLC13A1", "UMOD", "SLC22A12"),
  
  # General Proximal Tubule (for broader classification)
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),
  
  # ==== LOOP OF HENLE ====
  # Descending Thin Limb
  "DTL" = c("AQP1", "SLC4A11", "CLDN16", "ID1"),
  
  # Ascending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA", "CLDN16", "SLC26A7"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16", "KCNJ1"),
  
  # TAL Macula Densa
  "TAL_MD" = c("SLC12A1", "UMOD", "CASR", "NOS1", "COX2"),
  
  # ==== DISTAL CONVOLUTED TUBULE ====
  # Distal Convoluted Tubule 1
  "DCT1" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "NCX1"),
  
  # Distal Convoluted Tubule 2
  "DCT2" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "SCNN1A"),
  
  # General DCT
  "DCT" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "LHX1", "CNNM2", "FGF13"),
  
  # ==== CONNECTING TUBULE ====
  "CNT" = c("SLC8A1", "SCN2A", "HSD11B2", "CALB1", "SCNN1A", "SCNN1B"),
  
  # ==== COLLECTING DUCT ====
  # Collecting Duct Principal Cells
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4", "SCNN1A", "SCNN1B", "SCNN1G"),
  
  # Collecting Duct Intercalated Cells Type A
  "CD_IC_A" = c("SLC4A1", "ATP6V1C2", "ATP6V0D2", "CA2", "RHCG"),
  
  # Collecting Duct Intercalated Cells Type B
  "CD_IC_B" = c("SLC26A4", "ATP6V1C2", "ATP6V0D2", "CA2", "SLC4A9"),
  
  # Mixed PC/IC (transition cells)
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3", "ATP6V1C2"),
  
  # General IC
  "IC" = c("ATP6V0D2", "ATP6V1C2", "TMEM213", "CLNK", "SLC4A1", "SLC26A4"),
  
  # General PC
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),
  
  # ==== PROGENITOR CELLS ====
  # Nephron Progenitor Cells
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX", "OSR1", "EYA1"),
  
  # Stromal Progenitor Cells
  "SPC" = c("FOXD1", "MEIS1", "MEIS2", "HOXD11"),
  
  # ==== MESENCHYMAL/STROMAL SUBTYPES ====
  # Mesangial and Fibroblasts
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM", "PDGFRB"),
  
  # Pericytes Type 1
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2", "CSPG4", "MCAM"),
  
  # Pericytes Type 2
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3", "CSPG4", "ITGA8"),
  
  # Vascular Smooth Muscle Cells
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1", "MYLK", "MYOCD"),
  
  # Interstitial Fibroblasts
  "Fibroblast" = c("COL1A1", "COL1A2", "C7", "NEGR1", "FBLN5", "DCN", "CDH11"),
  
  # ==== VASCULAR CELL TYPES ====
  # Glomerular Endothelial Cells
  "GEC" = c("PECAM1", "EMCN", "EHHADH", "PLVAP", "PODXL2", "FLT1"),
  
  # Peritubular Capillary Endothelial Cells
  "PTC" = c("PECAM1", "VWF", "CD34", "FLT1", "PLVAP", "CA4"),
  
  # Arterial Endothelial Cells
  "AEC" = c("PECAM1", "VWF", "CD34", "FLT1", "GJA5", "BMX"),
  
  # Venous Endothelial Cells
  "VEC" = c("PECAM1", "VWF", "CD34", "FLT1", "ACKR1", "SELP"),
  
  # General Endothelial
  "EC" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN", "PTPRB", "MEIS2"),
  
  # ==== IMMUNE CELL SUBTYPES ====
  # Macrophages
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1", "CD163", "MRC1"),
  
  # Dendritic Cells
  "Dendritic" = c("CD68", "PTPRC", "ITGAX", "FCER1A", "CD1C"),
  
  # T Cells
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2", "CD3G", "TRAC"),
  
  # B Cells
  "B_Cells" = c("CD79A", "CD79B", "PTPRC", "MS4A1", "PAX5"),
  
  # Natural Killer T Cells
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1", "GZMB", "PRF1"),
  
  # Neutrophils
  "Neutrophils" = c("ELANE", "MPO", "DEFA4", "PTPRC", "CSF3R"),
  
  # General Immune
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  
  # ==== ORGANOID-SPECIFIC TYPES ====
  # Muscle-like cells Type 1
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),
  
  # Muscle-like cells Type 2
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1", "MYLK"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1", "CENPF"),
  
  # Neuronal precursors
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6", "NEUROD1"),
  
  # Neuron-like cells
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1", "NEFL"),
  
  # Melanoma-like cells
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT", "PMEL"),
  
  # ==== SPECIAL POPULATIONS ====
  # MAL-positive cells
  "MAL_positive" = c("MAL", "WFDC2", "SCGB1A1"),
  
  # APOE-positive cells
  "APOE_positive" = c("APOE", "CLU", "ABCA1", "LDLR"),
  
  # SPP1-positive cells
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3", "HAVCR1"),
  
  # ==== OFF-TARGET POPULATIONS ====
  "Off_target" = c("CDH19", "NRXN1", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR")
)

so_30_annotated <- annotate_celltypes(so_30, high_res_union_marker_genes, min_score_diff = 0.1)

so_30_annotated <- NormalizeData(so_30_annotated)
so_30_annotated <- ScaleData(so_30_annotated, features = VariableFeatures(so_30_annotated))
so_30_annotated <- FindVariableFeatures(object = so_30_annotated)
so_30_annotated <- RunPCA(so_30_annotated, features = VariableFeatures(object = so_30_annotated),assay="RNA")
# ElbowPlot(so_30_annotated)

# # Find neighbors and clusters (again using integrated data)
so_30_annotated <- FindNeighbors(so_30_annotated, assay = "RNA", dims = 1:20)
so_30_annotated <- FindClusters(so_30_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_30_annotated <- RunTSNE(so_30_annotated, dims = 1:20)
so_30_annotated@reductions
DimPlot(so_30_annotated, reduction = "umap", raster = F)

DimPlot(so_30_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (30 Glucose Conc.)")
DimPlot(so_30_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (30 Glucose Conc.)")

####################################
# Create all visualizations
all_viz <- create_all_visualizations(
  seurat_obj = so_30,
  marker_genes = marker_genes,  # from previous extraction or manual list
  celltype_column = "celltype_annotation",
  reduction = "umap",
  sample_column = "orig.ident",  # if you have sample information
  save_plots = TRUE,
  output_prefix = "kidney_celltypes"
)

# Access individual plot types:
all_viz$basic_plots$main_umap
all_viz$marker_plots$heatmap
all_viz$summary_stats
```
###iv. Combined Conc.
```{r}
#Define marker genes for each kidney cell type
#1. Low res from Raji
marker_genes <- list(
  "PT" = c("CUBN", "LRP2"),                    # Proximal Tubule
  "DTL" = c("AQP1", "ID1"),                    # Descending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA"),               # Ascending Thin Limb
  "TAL" = c("UMOD", "SLC12A1"),               # Thick Ascending Limb
  "DCT" = c("SLC12A3"),                       # Distal Convoluted Tubule
  "CNT" = c("SLC8A1"),                        # Connecting Tubule
  "PC" = c("FXYD4"),                          # Principal Cells
  "IC" = c("ATP6V0D2"),                       # Intercalated Cells
  "EC" = c("EMCN"),                           # Endothelial Cells
  "Immune" = c("PTPRC"),                      # Immune cells
  "Interstitial" = c("ACTA2", "RGS5")        # Interstitial cells
)

# Annotate cell types (adjust min_score_diff as needed)
so_combined_annotated <- annotate_celltypes(so_combined, marker_genes, min_score_diff = 0.1)
so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
#so_combined_annotated <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = T)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label = T,raster = T)+
  ggtitle(label="Low-Resolution KPMP Celltypes (Combined Treatment Conc.)")
# DimPlot(so_combined_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="Low-Resolution KPMP Celltypes")
# # Generate plots
# plots <- plot_celltype_results(so_combined, reduction = "umap")
# 
# # Display plots
# print(plots$annotation_plot)
# if (!is.null(plots$score_plot)) {
#   print(plots$score_plot)
# }
# print(plots$confidence_plot)


###############################################################################################################
#2. Low resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_Low_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_combined, marker_df)

# Step 2: Annotate your Seurat object
annotation_results <- annotate_from_dataframe(
  seurat_obj = so_combined,
  marker_df = marker_df,
  celltype_col = "Celltype",
  marker_col = "Pos_Marker_Genes",
  min_score_diff = 0.1
)

# Step 3: Extract results
so_combined_annotated <- annotation_results$seurat_object
marker_genes_used <- annotation_results$marker_genes
annotation_summary <- annotation_results$annotation_summary

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = F)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster=T)+
  ggtitle(label="Low Resolution KPMP Celltypes (Combined Treatment Conc.)")
# DimPlot(so_combined_annotated, reduction = "harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation", raster = FALSE)+
#   ggtitle(label="Low Resolution KPMP Celltypes")

###############################################################################
#3. High resolution from KPMP Atlas - https://www.nature.com/articles/s41586-023-05769-3
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "KPMP_Celltype_Markers_High_Res.csv", temp_file)
marker_df <- read.csv(temp_file)
# marker_df <- marker_df[-15,]

# Step 1: Validate markers (optional but recommended)
validation_results <- validate_markers(so_combined, marker_df)

# Annotate using dual markers
dual_results <- annotate_from_dataframe_dual(
  seurat_obj = so_combined,
  marker_df = marker_df,
  celltype_col = "Celltype",
  pos_marker_col = "Pos_Marker_Genes",
  neg_marker_col = "Neg_Marker_Genes",
  min_score_diff = 0.1,
  neg_weight = 0.5  # Weight for negative markers (0.5 = half weight)
)


# Step 3: Extract results
so_combined_annotated <- dual_results$seurat_object
# marker_genes_used <- dual_results$marker_genes
# annotation_summary <- dual_results$annotation_summary

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
# ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = T)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation_dual", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution KPMP Celltypes (Combined Treatment Conc.)")
# DimPlot(so_combined_annotated, reduction = "harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
# DimPlot(so_combined_annotated, reduction = "pca_for_harmony", group.by = "celltype_annotation_dual", raster = T)+
#   ggtitle(label="High-Resolution KPMP Celltypes")
###############################################################################
#4. Low Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers_simple <- list(
  # MAJOR EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2"),  # Proximal Tubule (all segments)
  "TAL" = c("SLC12A1", "UMOD", "CASR"),  # Thick Ascending Limb
  "DT" = c("SLC12A3", "GATA3", "TRPM6"),  # Distal Tubule
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Principal Cells
  "IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2"),  # Intercalated Cells
  # PROGENITOR
  "NPC" = c("SIX2", "CITED1", "MEOX1"),  # Nephron Progenitor Cells
  # MESENCHYMAL/STROMAL
  "Mesenchymal" = c("ACTA2", "COL3A1", "COL1A1", "RGS5", "PDGFRB"),
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34"),
  # IMMUNE
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  # ORGANOID-SPECIFIC
  "Proliferating" = c("MKI67", "TOP2A", "PCNA"),
  "Off_target" = c("MAP2", "TUBB3", "MITF", "TYR")  # Neuronal + Melanoma-like
)
# Annotate cell types (adjust min_score_diff as needed)
so_combined_annotated <- annotate_celltypes(so_combined, organoid_markers_simple, min_score_diff = 0.1)

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
# ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_combined_annotated <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = F)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low Resolution Organoid Markers Celltypes (Combined Treatment Conc.)")

###############################################################################
#5. High Resolution D29 Kidney Organoid Markers: https://www.nature.com/articles/s41467-019-13382-0#MOESM1
organoid_markers <- list(
  # EPITHELIAL CELL TYPES
  "Podocyte" = c("NPHS2", "NPHS1", "PTPRQ", "WT1", "PODXL"),
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),  # Proximal Tubule
  "PST" = c("LRP2", "CUBN", "SLC13A1"),  # Proximal Straight Tubule
  "tDL" = c("SLC4A11", "CLDN16"),  # thin Descending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16"),  # Thick Ascending Limb
  "TAL_DCT" = c("SLC12A1", "SLC12A3", "GATA3"),  # TAL/DCT transition
  "GATA3_DT" = c("GATA3", "SLC12A3", "TRPM6", "KLHL3"),  # GATA3+ Distal Tubule
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),  # Collecting Duct Principal Cells
  "CD_IC" = c("SLC4A1", "SLC26A4", "ATP6V1C2", "ATP6V0D2"),  # Collecting Duct Intercalated Cells
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3"),  # Mixed PC/IC
  # PROGENITOR CELLS
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX"),  # Nephron Progenitor Cells
  # MESENCHYMAL CELL TYPES  
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM"),
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2"),
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3"),
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),  # vascular Smooth Muscle Cells
  # VASCULAR
  "Endothelial" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN"),
  # IMMUNE CELLS
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1"),
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2"),
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1"),
  # ADDITIONAL ORGANOID-SPECIFIC TYPES
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN"),
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1"),
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1"),
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6"),
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1"),
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT"),
  # BASED ON VIOLIN PLOT GENES
  "MAL_positive" = c("MAL", "WFDC2"),  # Specific population from violin plots
  "APOE_positive" = c("APOE", "CLU", "ABCA1"),  # Another specific population
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3")  # SPP1+ population
)

so_combined_annotated <- annotate_celltypes(so_combined, organoid_markers, min_score_diff = 0.1)

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
# ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_combined_annotated <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = F)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Organoid Markers Celltypes (Combined Treatment Conc.)")
###############################################################################
#make a union gene marker set
#6. Union marker genes for low-resolution kidney cell annotation
union_marker_genes <- list(
  # Connecting Tubule
  "CNT" = c("CALB1", "HSD11B2", "SCN2A", "SLC8A1"),
  
  # Distal Convoluted Tubule
  "DCT" = c("CNNM2", "FGF13", "GATA3", "KLHL3", "LHX1", "SLC12A3", "TRPM6"),
  
  # Endothelial Cells
  "EC" = c("CD34", "COX4I2", "EMCN", "FLT1", "MEIS2", "PECAM1", "PTPRB", "VWF"),
  
  # Intercalated Cells
  "IC" = c("ATP6V0D2", "ATP6V1C2", "CLNK", "SLC26A4", "SLC4A1", "TMEM213"),
  
  # Immune Cells
  "Immune" = c("CD3D", "CD68", "NKG7", "PTPRC"),
  
  # Mesenchymal/Interstitial/Fibroblast/Vascular Smooth Muscle/Pericytes
  "Mesenchymal" = c("ACTA2", "C7", "CDH11", "COL1A1", "COL1A2", "COL3A1", 
                    "DCN", "FBLN5", "ITGA8", "NEGR1", "NOTCH3", "PDGFRB", "RGS5"),
  
  # Nephron Progenitor Cells
  "NPC" = c("CITED1", "MEOX1", "SIX2"),
  
  # Off-target/Neuronal cells
  "Off_target" = c("CDH19", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR"),
  
  # Principal Cells
  "PC" = c("AQP2", "AQP3", "FXYD4", "GATA3"),
  
  # Parietal Epithelial Cells
  "PEC" = c("ALDH1A2", "CFH", "CLDN1", "RBFOX1", "VCAM1"),
  
  # Proximal Tubule
  "PT" = c("CUBN", "LRP2", "SLC13A1", "SLC5A2"),
  
  # Podocyte
  "Podocyte" = c("CLIC5", "NPHS1", "NPHS2", "NTNG1", "PODXL", "PTPRQ", "WT1"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "PCNA", "TOP2A"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "KCNJ1", "CLDN16", "CLDN19", "CLCNKB"),
  
  # Thin Limb (combines Descending and Ascending Thin Limb)
  "TL" = c("AQP1", "BOC", "CLCNKA", "CLDN3", "COL26A1", "CRYAB", 
           "ID1", "KLRG2", "SLC44A5", "TACSTD2")
)
so_combined_annotated <- annotate_celltypes(so_combined, union_marker_genes, min_score_diff = 0.1)

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
# ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_combined_annotated <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = F)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="Low-Resolution Union Organoid Markers (Combined Treatment Conc.)")
####################################
#7. High-resolution union marker genes for detailed kidney cell annotation
high_res_union_marker_genes <- list(
  
  # ==== GLOMERULAR CELL TYPES ====
  # Podocytes
  "Podocyte" = c("NPHS1", "NPHS2", "PTPRQ", "WT1", "PODXL", "CLIC5", "NTNG1"),
  
  # Parietal Epithelial Cells
  "PEC" = c("CLDN1", "VCAM1", "CFH", "RBFOX1", "ALDH1A2"),
  
  # Mesangial Cells
  "Mesangial" = c("ACTA2", "COL4A1", "PDGFRB", "RGS5", "ITGB1", "TIMP1"),
  
  # ==== PROXIMAL TUBULE SUBTYPES ====
  # Proximal Tubule S1
  "PT_S1" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8", "HAVCR1"),
  
  # Proximal Tubule S2
  "PT_S2" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "MIOX"),
  
  # Proximal Tubule S3/Proximal Straight Tubule
  "PT_S3" = c("LRP2", "CUBN", "SLC13A1", "UMOD", "SLC22A12"),
  
  # General Proximal Tubule (for broader classification)
  "PT" = c("LRP2", "CUBN", "SLC13A1", "SLC5A2", "SLC22A6", "SLC22A8"),
  
  # ==== LOOP OF HENLE ====
  # Descending Thin Limb
  "DTL" = c("AQP1", "SLC4A11", "CLDN16", "ID1"),
  
  # Ascending Thin Limb
  "ATL" = c("CLDN3", "CLCNKA", "CLDN16", "SLC26A7"),
  
  # Thick Ascending Limb
  "TAL" = c("SLC12A1", "UMOD", "CASR", "CLDN16", "KCNJ1"),
  
  # TAL Macula Densa
  "TAL_MD" = c("SLC12A1", "UMOD", "CASR", "NOS1", "COX2"),
  
  # ==== DISTAL CONVOLUTED TUBULE ====
  # Distal Convoluted Tubule 1
  "DCT1" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "NCX1"),
  
  # Distal Convoluted Tubule 2
  "DCT2" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "SCNN1A"),
  
  # General DCT
  "DCT" = c("SLC12A3", "GATA3", "TRPM6", "KLHL3", "LHX1", "CNNM2", "FGF13"),
  
  # ==== CONNECTING TUBULE ====
  "CNT" = c("SLC8A1", "SCN2A", "HSD11B2", "CALB1", "SCNN1A", "SCNN1B"),
  
  # ==== COLLECTING DUCT ====
  # Collecting Duct Principal Cells
  "CD_PC" = c("AQP2", "AQP3", "GATA3", "FXYD4", "SCNN1A", "SCNN1B", "SCNN1G"),
  
  # Collecting Duct Intercalated Cells Type A
  "CD_IC_A" = c("SLC4A1", "ATP6V1C2", "ATP6V0D2", "CA2", "RHCG"),
  
  # Collecting Duct Intercalated Cells Type B
  "CD_IC_B" = c("SLC26A4", "ATP6V1C2", "ATP6V0D2", "CA2", "SLC4A9"),
  
  # Mixed PC/IC (transition cells)
  "CD_PC_IC" = c("AQP2", "SLC4A1", "GATA3", "ATP6V1C2"),
  
  # General IC
  "IC" = c("ATP6V0D2", "ATP6V1C2", "TMEM213", "CLNK", "SLC4A1", "SLC26A4"),
  
  # General PC
  "PC" = c("AQP2", "AQP3", "GATA3", "FXYD4"),
  
  # ==== PROGENITOR CELLS ====
  # Nephron Progenitor Cells
  "NPC" = c("SIX2", "CITED1", "MEOX1", "UNCX", "OSR1", "EYA1"),
  
  # Stromal Progenitor Cells
  "SPC" = c("FOXD1", "MEIS1", "MEIS2", "HOXD11"),
  
  # ==== MESENCHYMAL/STROMAL SUBTYPES ====
  # Mesangial and Fibroblasts
  "Mesangial_Fibroblasts" = c("ACTA2", "COL3A1", "COL1A1", "DCN", "LUM", "PDGFRB"),
  
  # Pericytes Type 1
  "Pericyte_1" = c("RGS5", "PDGFRB", "NOTCH3", "ACTA2", "CSPG4", "MCAM"),
  
  # Pericytes Type 2
  "Pericyte_2" = c("RGS5", "PDGFRB", "NOTCH3", "CSPG4", "ITGA8"),
  
  # Vascular Smooth Muscle Cells
  "vSMC" = c("ACTA2", "MYH11", "TAGLN", "CNN1", "MYLK", "MYOCD"),
  
  # Interstitial Fibroblasts
  "Fibroblast" = c("COL1A1", "COL1A2", "C7", "NEGR1", "FBLN5", "DCN", "CDH11"),
  
  # ==== VASCULAR CELL TYPES ====
  # Glomerular Endothelial Cells
  "GEC" = c("PECAM1", "EMCN", "EHHADH", "PLVAP", "PODXL2", "FLT1"),
  
  # Peritubular Capillary Endothelial Cells
  "PTC" = c("PECAM1", "VWF", "CD34", "FLT1", "PLVAP", "CA4"),
  
  # Arterial Endothelial Cells
  "AEC" = c("PECAM1", "VWF", "CD34", "FLT1", "GJA5", "BMX"),
  
  # Venous Endothelial Cells
  "VEC" = c("PECAM1", "VWF", "CD34", "FLT1", "ACKR1", "SELP"),
  
  # General Endothelial
  "EC" = c("PECAM1", "COX4I2", "VWF", "CD34", "FLT1", "EMCN", "PTPRB", "MEIS2"),
  
  # ==== IMMUNE CELL SUBTYPES ====
  # Macrophages
  "Macrophages" = c("CD68", "PTPRC", "CSF1R", "AIF1", "CD163", "MRC1"),
  
  # Dendritic Cells
  "Dendritic" = c("CD68", "PTPRC", "ITGAX", "FCER1A", "CD1C"),
  
  # T Cells
  "T_Cells" = c("CD3D", "CD3E", "PTPRC", "CD2", "CD3G", "TRAC"),
  
  # B Cells
  "B_Cells" = c("CD79A", "CD79B", "PTPRC", "MS4A1", "PAX5"),
  
  # Natural Killer T Cells
  "NKT" = c("NKG7", "GNLY", "CD3D", "KLRD1", "GZMB", "PRF1"),
  
  # Neutrophils
  "Neutrophils" = c("ELANE", "MPO", "DEFA4", "PTPRC", "CSF3R"),
  
  # General Immune
  "Immune" = c("PTPRC", "CD68", "CD3D", "NKG7"),
  
  # ==== ORGANOID-SPECIFIC TYPES ====
  # Muscle-like cells Type 1
  "Muscle_like_1" = c("ACTA2", "MYH11", "TAGLN", "CNN1"),
  
  # Muscle-like cells Type 2
  "Muscle_like_2" = c("ACTA2", "MYL9", "CNN1", "MYLK"),
  
  # Proliferating cells
  "Proliferating" = c("MKI67", "TOP2A", "PCNA", "CDK1", "CENPF"),
  
  # Neuronal precursors
  "Neuronal_precursor" = c("SOX2", "NES", "PAX6", "NEUROD1"),
  
  # Neuron-like cells
  "Neuron_like" = c("MAP2", "TUBB3", "SYP", "NCAM1", "NEFL"),
  
  # Melanoma-like cells
  "Melanoma_like" = c("MITF", "TYR", "TYRP1", "DCT", "PMEL"),
  
  # ==== SPECIAL POPULATIONS ====
  # MAL-positive cells
  "MAL_positive" = c("MAL", "WFDC2", "SCGB1A1"),
  
  # APOE-positive cells
  "APOE_positive" = c("APOE", "CLU", "ABCA1", "LDLR"),
  
  # SPP1-positive cells
  "SPP1_positive" = c("SPP1", "CD44", "LGALS3", "HAVCR1"),
  
  # ==== OFF-TARGET POPULATIONS ====
  "Off_target" = c("CDH19", "NRXN1", "GINS3", "MAP2", "MITF", "NRXN1", "TUBB3", "TYR")
)

so_combined_annotated <- annotate_celltypes(so_combined, high_res_union_marker_genes, min_score_diff = 0.1)

so_combined_annotated <- NormalizeData(so_combined_annotated)
so_combined_annotated <- ScaleData(so_combined_annotated, features = VariableFeatures(so_combined_annotated))
so_combined_annotated <- FindVariableFeatures(object = so_combined_annotated)
so_combined_annotated <- RunPCA(so_combined_annotated, features = VariableFeatures(object = so_combined_annotated),assay="RNA")
# ElbowPlot(so_combined_annotated)

# # Find neighbors and clusters (again using integrated data)
so_combined_annotated <- FindNeighbors(so_combined_annotated, assay = "RNA", dims = 1:20)
so_combined_annotated <- FindClusters(so_combined_annotated, resolution = 0.5)

# Perform UMAP and tSNE
# so_combined_annotated <- RunTSNE(so_combined_annotated, dims = 1:20)
so_combined_annotated@reductions
DimPlot(so_combined_annotated, reduction = "umap", raster = F)

DimPlot(so_combined_annotated, reduction = "umap", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (Combined Treatment Conc.)")
DimPlot(so_combined_annotated, reduction = "pca", group.by = "celltype_annotation", label=T,raster = T)+
  ggtitle(label="High-Resolution Union Organoid Markers (Combined Treatment Conc.)")

####################################
# Create all visualizations
all_viz <- create_all_visualizations(
  seurat_obj = so_combined,
  marker_genes = marker_genes,  # from previous extraction or manual list
  celltype_column = "celltype_annotation",
  reduction = "umap",
  sample_column = "orig.ident",  # if you have sample information
  save_plots = TRUE,
  output_prefix = "kidney_celltypes"
)

# Access individual plot types:
all_viz$basic_plots$main_umap
all_viz$marker_plots$heatmap
all_viz$summary_stats
```

##d. Annotate Organoid Data - Bottom Up
###i. 15 Glucose
```{r}
#Select 15 conc. only
so_15 <- subset(sc_org,treatment=="15")

# PCA
so_15 <- NormalizeData(so_15)
so_15 <- ScaleData(so_15, features = VariableFeatures(so_15))
so_15 <- FindVariableFeatures(object = so_15)
so_15 <- RunPCA(so_15, features = VariableFeatures(object = so_15),assay="RNA")
# ElbowPlot(so_15)

# # Find neighbors and clusters (again using integrated data)
so_15 <- FindNeighbors(so_15, assay = "RNA", dims = 1:20)
so_15 <- FindClusters(so_15, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunUMAP(so_liver_sc, dims = 1:15)
so_15@reductions
DimPlot(so_15, reduction = "umap", raster = F)


# Find markers for all clusters
all_markers <- FindAllMarkers(so_15, 
                              only.pos = TRUE,     # Only positive markers
                              min.pct = 0.25,      # Must be expressed in at least 25% of cells
                              logfc.threshold = 0.25,  # Minimum log fold change
                              test.use = "wilcox")  # Wilcoxon test
marker_summary <- all_markers %>%
  group_by(cluster) %>%
  summarise(
    n_markers = n(),
    avg_logfc = mean(avg_log2FC),
    top_marker = gene[which.max(avg_log2FC)],
    .groups = 'drop'
  )
print(marker_summary)

# Get top 10 markers per cluster
top_10_markers <- get_top_markers(all_markers, top_n = 10)

# Get top 5 markers per cluster for cleaner visualization
top_5_markers <- get_top_markers(all_markers, top_n = 5)

# Print top 5 markers for each cluster
for (cluster_id in unique(top_5_markers$cluster)) {
  cluster_markers <- top_5_markers %>% filter(cluster == cluster_id)
  cat(paste("Cluster", cluster_id, ":", paste(cluster_markers$gene, collapse = ", "), "\n"))
}


# Create dot plot with top 5 markers
dotplot_5 <- create_marker_dotplot(so_15, all_markers, top_n = 5, 
                                   title = "Top 5 Marker Genes by Cluster")
print(dotplot_5)

# Create dot plot with top 10 markers (might be crowded)
dotplot_10 <- create_marker_dotplot(so_15, all_markers, top_n = 10, 
                                    title = "Top 10 Marker Genes by Cluster")
print(dotplot_10)
png(fs::path(dir.results,"dotplot_avg_expression.png"), 
    width = 10, 
    height = 10, 
    units = "in",
    res = 300,
    bg = "white")
print(dotplot_10)
dev.off()

# Create heatmap
# This scales all genes to ensure marker genes are included
heatmap_result <- fix_scaling_and_create_heatmap(so_15, all_markers, top_n = 5)
# so_15 <- heatmap_result$so_15  # Update with properly scaled data
heatmap_plot_fixed <- heatmap_result$heatmap
print(heatmap_plot_fixed)
png(fs::path(dir.results,"heatmap_avg_expression.png"), 
    width = 15, 
    height = 10, 
    units = "in",
    res = 300,
    bg = "white")
print(heatmap_plot_fixed)
dev.off()

literature_annotations <- data.frame(
  cluster = 0:16,
  celltype = c(
    "Podocyte",              # Cluster 0 - PODXL, NPHS markers
    "Podocyte",              # Cluster 1 - PODXL, NPHS markers  
    "Proximal_Tubule",       # Cluster 2 - LRP2-like, tubular markers
    "Thin_Limb",             # Cluster 3 - thin limb/loop markers
    "Mature_Podocyte",       # Cluster 4 - PODXL, ACTN1
    "Mesenchymal",           # Cluster 5 - SFRP2, stromal markers
    "Proliferating",         # Cluster 6 - MKI67, cell cycle
    "Stromal",               # Cluster 7 - FREM1, COL1A1
    "Fibroblast",            # Cluster 8 - COL1A1, stromal
    "Endothelial",           # Cluster 9 - endothelial markers
    "Early_Tubule",          # Cluster 10 - early tubular epithelial
    "Distal_Tubule",         # Cluster 11 - distal tubular markers
    "Collecting_Duct",       # Cluster 12 - collecting duct
    "Off_Target_Neural",     # Cluster 13 - neuronal markers
    "Off_Target_Muscle",     # Cluster 14 - muscle-like
    "Nephron_Progenitor",    # Cluster 15 - progenitor cells
    "Unknown"                # Cluster 16 - unclear identity
  ),
  stringsAsFactors = FALSE
)

# Add simplified categories for easier visualization
literature_annotations$broad_category <- case_when(
  literature_annotations$celltype %in% c("Podocyte", "Mature_Podocyte") ~ "Podocyte",
  literature_annotations$celltype %in% c("Proximal_Tubule", "Thin_Limb", "Early_Tubule", "Distal_Tubule") ~ "Tubular_Epithelial",
  literature_annotations$celltype == "Collecting_Duct" ~ "Collecting_Duct",
  literature_annotations$celltype == "Nephron_Progenitor" ~ "Nephron_Progenitor", 
  literature_annotations$celltype %in% c("Mesenchymal", "Stromal", "Fibroblast") ~ "Mesenchymal_Stromal",
  literature_annotations$celltype == "Proliferating" ~ "Proliferating",
  literature_annotations$celltype == "Endothelial" ~ "Endothelial",
  grepl("Off_Target", literature_annotations$celltype) ~ "Off_Target",
  TRUE ~ "Unknown"
)

# Display the annotations
cat("REVISED Literature-based cell type annotations (includes tubular cells!):\n")
print(literature_annotations)

cat("\n=== REVISION NOTES ===\n")
cat("Updated annotations to properly identify TUBULAR CELLS:\n")
cat("- Cluster 2: Proximal_Tubule (likely PT-like cells)\n")
cat("- Cluster 3: Thin_Limb (thin limb of Henle)\n") 
cat("- Cluster 10: Early_Tubule (early tubular epithelial)\n")
cat("- Cluster 11: Distal_Tubule (distal tubular cells)\n")
cat("- Cluster 12: Collecting_Duct (collecting duct)\n")
cat("This creates a 'Tubular_Epithelial' category with multiple tubular cell types!\n")

# Add annotations to Seurat object
so_15@meta.data$literature_celltype <- literature_annotations$celltype[match(so_15@meta.data$seurat_clusters, literature_annotations$cluster)]
so_15@meta.data$broad_category <- literature_annotations$broad_category[match(so_15@meta.data$seurat_clusters, literature_annotations$broad_category)]

# Create UMAP visualizations
create_literature_umap_plots <- function(seurat_obj) {
  
  plots <- list()
  
  # 1. Original clusters
  plots$original <- DimPlot(seurat_obj, 
                            group.by = "seurat_clusters",
                            label = TRUE,
                            label.size = 4,
                            reduction = "umap") +
    ggtitle("Original Seurat Clusters") +
    theme_minimal()
  
  # 2. Literature-based detailed cell types
  plots$detailed <- DimPlot(seurat_obj, 
                            group.by = "literature_celltype",
                            label = TRUE,
                            label.size = 2.5,
                            reduction = "umap") +
    ggtitle("Literature-Based Cell Types (Detailed)") +
    theme_minimal() +
    theme(legend.position = "bottom",
          legend.text = element_text(size = 8))
  
  # 3. Broad categories (cleaner view)
  plots$broad <- DimPlot(seurat_obj, 
                         group.by = "broad_category",
                         label = TRUE,
                         label.size = 3,
                         reduction = "umap") +
    ggtitle("Literature-Based Cell Types (Broad Categories)") +
    theme_minimal() +
    theme(legend.position = "bottom")
  
  # 4. Split by broad category
  plots$split <- DimPlot(seurat_obj, 
                         group.by = "broad_category",
                         split.by = "broad_category",
                         ncol = 3,
                         reduction = "umap") +
    ggtitle("Cell Types (Split View)") +
    theme_minimal() +
    theme(legend.position = "none")
  
  return(plots)
}

# Create the plots
umap_plots <- create_literature_umap_plots(so_15)

# Display the plots
cat("\n=== LITERATURE-BASED CELL TYPE MAPPING ===\n")

print(umap_plots$original)
print(umap_plots$detailed) 
print(umap_plots$broad)
print(umap_plots$split)

print(umap_plots$original)
print(umap_plots$detailed) 
png(fs::path(dir.results,"Annotated_UMAP.png"), 
    width = 10, 
    height = 10, 
    units = "in",
    res = 300,
    bg = "white")
print(umap_plots$detailed) 
dev.off()

print(umap_plots$broad)
print(umap_plots$split)

# Create summary statistics
cat("\n=== CELL TYPE SUMMARY ===\n")

# Detailed cell types
detailed_summary <- so_15@meta.data %>%
  group_by(literature_celltype) %>%
  summarise(n_cells = n(), .groups = 'drop') %>%
  mutate(percentage = round(n_cells / sum(n_cells) * 100, 1)) %>%
  arrange(desc(n_cells))

cat("Detailed cell types:\n")
print(detailed_summary)

# Broad categories
broad_summary <- so_15@meta.data %>%
  group_by(broad_category) %>%
  summarise(n_cells = n(), .groups = 'drop') %>%
  mutate(percentage = round(n_cells / sum(n_cells) * 100, 1)) %>%
  arrange(desc(n_cells))

cat("\nBroad categories:\n")
print(broad_summary)

# Create a mapping reference table
mapping_reference <- literature_annotations %>%
  left_join(
    so_15@meta.data %>% 
      group_by(seurat_clusters) %>% 
      summarise(n_cells = n(), .groups = 'drop') %>%
      rename(cluster = seurat_clusters),
    by = "cluster"
  ) %>%
  mutate(percentage = round(n_cells / sum(n_cells) * 100, 1)) %>%
  arrange(cluster)

cat("\n=== CLUSTER TO CELL TYPE MAPPING ===\n")
print(mapping_reference)

# Create a publication-ready combined plot
combined_plot <- umap_plots$original + umap_plots$broad + 
  plot_layout(ncol = 2) +
  plot_annotation(title = "Cluster Identification: Original vs Literature-Based Cell Types")

print(combined_plot)

# Save the plots
ggsave("literature_celltype_umap_detailed.png", umap_plots$detailed, width = 12, height = 8, dpi = 300)
ggsave("literature_celltype_umap_broad.png", umap_plots$broad, width = 10, height = 8, dpi = 300)
ggsave("literature_celltype_combined.png", combined_plot, width = 16, height = 8, dpi = 300)

# Save the mapping table
write.csv(mapping_reference, "literature_celltype_mapping.csv", row.names = FALSE)

cat("\n=== RESULTS SAVED ===\n")
cat("- UMAP plots saved as PNG files\n")
cat("- Mapping table saved as CSV\n")
cat("- Cell type annotations stored in so_15@meta.data$literature_celltype\n")
cat("- Broad categories stored in so_15@meta.data$broad_category\n")

# Show key findings
cat("\n=== KEY FINDINGS ===\n")
cat("Major cell types identified in organoid:\n")
for(i in 1:nrow(broad_summary)) {
  cat(paste0("- ", broad_summary$broad_category[i], ": ", 
             broad_summary$n_cells[i], " cells (", 
             broad_summary$percentage[i], "%)\n"))
}

cat("\nThis organoid contains:\n")
if("Podocyte" %in% broad_summary$broad_category) cat("✓ Glomerular development (Podocytes)\n")
if("Nephron_Progenitor" %in% broad_summary$broad_category) cat("✓ Nephron progenitor cells\n")
if("Mesenchymal_Stromal" %in% broad_summary$broad_category) cat("✓ Stromal/mesenchymal support cells\n")
if("Epithelial" %in% broad_summary$broad_category) cat("✓ Epithelial differentiation\n")
if("Off_Target" %in% broad_summary$broad_category) cat("! Off-target cell types (common in organoids)\n")
if("Proliferating" %in% broad_summary$broad_category) cat("✓ Actively dividing cells\n")
```


## d. Explore Distribution & Zero-Inflation
### i. Biopsy Data
```{r}
#Check if data have been normalized 
so_kpmp_sc@assays  # Should show e.g., "RNA" with "counts" and "data"
head(GetAssayData(so_kpmp_sc, layer = "counts")[, 1:5])  # Raw counts
head(GetAssayData(so_kpmp_sc, layer = "data")[, 1:5])    # Normalized data

#Check for normality
# Open a PDF device (all plots go here)
pdf(fs::path(dir.results,"Raw_count_gene_expression_histograms_counts_biopsy.pdf"), width = 8, height = 6)

# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_kpmp_sc), 100)

# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))

# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_kpmp_sc, layer = "counts")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Raw Counts Expression")     # Label for x-axis
}

# Close the PDF device — this writes the file to disk
dev.off()

pdf(fs::path(dir.results,"Normalized_gene_expression_histograms_counts_biopsy.pdf"), width = 8, height = 6)

# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_kpmp_sc), 100)

# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))

# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_kpmp_sc, layer = "data")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Normalized Expression")     # Label for x-axis
}

# Close the PDF device — this writes the file to disk
dev.off()

#Check for zero inflation
pdf(fs::path(dir.results,"Zero_Inflation_Visualization.pdf"), width = 8, height = 6)
counts <- GetAssayData(so_kpmp_sc, layer = "counts")
zero_prop <- rowMeans(counts == 0)
hist(zero_prop, main = "Proportion of Zeros for Genes", xlab = "Zero Proportion")
# Add a vertical line at 50%
abline(v = 0.5, col = "red", lwd = 2, lty = 2)
dev.off()

#Check for overdispersion
# Use raw counts
counts <- GetAssayData(so_kpmp_sc, layer = "counts")

# Pick a few genes or do this genome-wide
gene_means <- rowMeans(counts)
gene_vars <- apply(counts, 1, var)

# Dispersion estimate (Var / Mean)
dispersion <- gene_vars / gene_means

# Filter to only genes where mean > 0 (to avoid divide-by-zero)
valid_genes <- gene_means > 0
dispersion <- dispersion[valid_genes]

# View distribution
pdf(fs::path(dir.results,"Overdispersion_Visualization.pdf"), width = 8, height = 6)
hist(dispersion, breaks=300, main="Dispersion across genes", xlab="Dispersion (Var / Mean)",xlim = c(0, 10))
abline(v = 1, col="red")  # Poisson expectation
dev.off()

# Check how many genes have dispersion > 1
overdispersed_genes <- sum(dispersion > 1)
total_genes <- length(dispersion)
percent_overdispersed <- (overdispersed_genes / total_genes) * 100

# Print summary and recommendation
print(paste0("Overdispersed genes: ", 
             overdispersed_genes, 
             " out of ", 
             total_genes, 
             " (", 
             round(percent_overdispersed, 3), 
             "%)"))

if (percent_overdispersed > 10) {
  print("✅ Overdispersion detected. Consider using a Negative Binomial model.")
} else {
  print("ℹ️ Little evidence of overdispersion. Poisson model may be sufficient.")
}
rm(counts)

```

### ii. Organoid Data
####a. 15 Gluc. Conc
```{r}
#Select 15 conc. only
so_15 <- subset(sc_org,treatment=="15")

#Check if data have been normalized 
so_15@assays  # Should show e.g., "RNA" with "counts" and "data"
head(GetAssayData(so_15, layer = "counts")[, 1:5])  # Raw counts
head(GetAssayData(so_15, layer = "data")[, 1:5])    # Normalized data

#Check for normality
# Open a PDF device (all plots go here)
pdf(fs::path(dir.results,"Organoid_Raw_gene_expression_histograms_counts_15.pdf"), width = 8, height = 6)
# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_15), 100)
# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))
# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_15, layer = "counts")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Raw Counts Expression")     # Label for x-axis
}
# Close the PDF device — this writes the file to disk
dev.off()

pdf(fs::path(dir.results,"Organoid_Normalized_gene_expression_histograms_counts_15.pdf"), width = 8, height = 6)
# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_15), 100)
# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))
# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_15, layer = "data")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Expression")     # Label for x-axis
}
# Close the PDF device — this writes the file to disk
dev.off()

#Check for zero inflation
pdf(fs::path(dir.results,"Organoid_Zero_Inflation_Visualization.pdf_15"), width = 8, height = 6)
counts <- GetAssayData(so_15, layer = "counts")
zero_prop <- rowMeans(counts == 0)
hist(zero_prop, main = "Proportion of Zeros for Genes", xlab = "Zero Proportion")
# Add a vertical line at 50%
abline(v = 0.5, col = "red", lwd = 2, lty = 2)
dev.off()

#Check for overdispersion
# Use raw counts
counts <- GetAssayData(so_15, layer = "counts")

# Pick a few genes or do this genome-wide
gene_means <- rowMeans(counts)
gene_vars <- apply(counts, 1, var)

# Dispersion estimate (Var / Mean)
dispersion <- gene_vars / gene_means

# Filter to only genes where mean > 0 (to avoid divide-by-zero)
valid_genes <- gene_means > 0
dispersion <- dispersion[valid_genes]

# View distribution
pdf(fs::path(dir.results,"Organoid_Overdispersion_Visualization_15.pdf"), width = 8, height = 6)
hist(dispersion, breaks=300, main="Dispersion across genes", xlab="Dispersion (Var / Mean)",xlim = c(0, 10))
abline(v = 1, col="red")  # Poisson expectation
dev.off()

# Check how many genes have dispersion > 1
overdispersed_genes <- sum(dispersion > 1)
total_genes <- length(dispersion)
percent_overdispersed <- (overdispersed_genes / total_genes) * 100

# Print summary and recommendation
print(paste0("Overdispersed genes: ", 
             overdispersed_genes, 
             " out of ", 
             total_genes, 
             " (", 
             round(percent_overdispersed, 3), 
             "%)"))

if (percent_overdispersed > 10) {
  print("✅ Overdispersion detected. Consider using a Negative Binomial model.")
} else {
  print("ℹ️ Little evidence of overdispersion. Poisson model may be sufficient.")
}
rm(counts)


```
####b. 30 Gluc.Conc
```{r}
#Select 15 conc. only
so_30 <- subset(sc_org,treatment=="15")

#Check if data have been normalized 
so_30@assays  # Should show e.g., "RNA" with "counts" and "data"
head(GetAssayData(so_30, layer = "counts")[, 1:5])  # Raw counts
head(GetAssayData(so_30, layer = "data")[, 1:5])    # Normalized data

#Check for normality
# Open a PDF device (all plots go here)
pdf(fs::path(dir.results,"Organoid_Raw_gene_expression_histograms_counts_30.pdf"), width = 8, height = 6)
# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_30), 100)
# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))
# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_30, layer = "counts")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Raw Counts Expression")     # Label for x-axis
}
# Close the PDF device — this writes the file to disk
dev.off()

pdf(fs::path(dir.results,"Organoid_Normalized_gene_expression_histograms_counts_30.pdf"), width = 8, height = 6)
# Randomly select 100 genes from the Seurat object
genes <- sample(rownames(so_30), 100)
# Set up a 2x3 plotting layout so you can plot multiple histograms in one figure
par(mfrow = c(2, 3))
# Loop over each randomly selected gene
for (g in genes) {
  
  # Plot a histogram of the expression values for gene 'g'
  # using normalized expression values from the "data" slot
  hist(GetAssayData(so_30, layer = "data")[g, ],
       main = g,                # Title of the plot = gene name
       xlab = "Expression")     # Label for x-axis
}
# Close the PDF device — this writes the file to disk
dev.off()

#Check for zero inflation
pdf(fs::path(dir.results,"Organoid_Zero_Inflation_Visualization.pdf_30"), width = 8, height = 6)
counts <- GetAssayData(so_30, layer = "counts")
zero_prop <- rowMeans(counts == 0)
hist(zero_prop, main = "Proportion of Zeros for Genes", xlab = "Zero Proportion")
# Add a vertical line at 50%
abline(v = 0.5, col = "red", lwd = 2, lty = 2)
dev.off()

#Check for overdispersion
# Use raw counts
counts <- GetAssayData(so_30, layer = "counts")

# Pick a few genes or do this genome-wide
gene_means <- rowMeans(counts)
gene_vars <- apply(counts, 1, var)

# Dispersion estimate (Var / Mean)
dispersion <- gene_vars / gene_means

# Filter to only genes where mean > 0 (to avoid divide-by-zero)
valid_genes <- gene_means > 0
dispersion <- dispersion[valid_genes]

# View distribution
pdf(fs::path(dir.results,"Organoid_Overdispersion_Visualization_30.pdf"), width = 8, height = 6)
hist(dispersion, breaks=300, main="Dispersion across genes", xlab="Dispersion (Var / Mean)",xlim = c(0, 10))
abline(v = 1, col="red")  # Poisson expectation
dev.off()

# Check how many genes have dispersion > 1
overdispersed_genes <- sum(dispersion > 1)
total_genes <- length(dispersion)
percent_overdispersed <- (overdispersed_genes / total_genes) * 100

# Print summary and recommendation
print(paste0("Overdispersed genes: ", 
             overdispersed_genes, 
             " out of ", 
             total_genes, 
             " (", 
             round(percent_overdispersed, 3), 
             "%)"))

if (percent_overdispersed > 10) {
  print("✅ Overdispersion detected. Consider using a Negative Binomial model.")
} else {
  print("ℹ️ Little evidence of overdispersion. Poisson model may be sufficient.")
}
rm(counts)


```

## d. Select Highly Variable Genes (HVGs)
```{r}
# so_kpmp_sc <- FindVariableFeatures(so_kpmp_sc, selection.method = "vst", nfeatures = 2000)
# hvgs <- VariableFeatures(so_kpmp_sc)
# 
# # Subset Seurat object to only HVGs
# so_kpmp_sc_hvg <- subset(so_kpmp_sc, features = hvgs)
```

# 3. Visualize & Descriptive Stats
## a. UMAPS & Barcharts 
###i. Biopsy
```{r}
# PCA
so_kpmp_sc <- FindVariableFeatures(object = so_kpmp_sc)
so_kpmp_sc <- RunPCA(so_kpmp_sc, features = VariableFeatures(object = so_kpmp_sc),assay="RNA")
ElbowPlot(so_kpmp_sc)

# # Find neighbors and clusters (again using integrated data)
so_kpmp_sc <- FindNeighbors(so_kpmp_sc, assay = "RNA", dims = 1:20)
so_kpmp_sc <- FindClusters(so_kpmp_sc, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunUMAP(so_liver_sc, dims = 1:15)
so_kpmp_sc@reductions
DimPlot(so_kpmp_sc, reduction = "umap.harmony", raster = F)

DimPlot(so_kpmp_sc, reduction = "umap.harmony", group.by = "KPMP_celltype", raster = FALSE)


plot1 <- DimPlot(so_kpmp_sc, reduction = "umap.harmony", group.by = "KPMP_celltype",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("Harmony UMAP Plot with Cell Type Labels")

png(fs::path(dir.results,"UMAP_Celltypes_Biopsy.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot1)
dev.off()

so_kpmp_sc$group <- factor(so_kpmp_sc$group)
plot2 <- DimPlot(so_kpmp_sc, reduction = "umap.harmony",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("UMAP by Disease Category"))

png(fs::path(dir.results,"UMAP_Celltypes_Biopsy_by_DiseaseStatus.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot2)
dev.off()

DimPlot(so_kpmp_sc, reduction = "umap.rpca", raster = F)
DimPlot(so_kpmp_sc, reduction = "umap.rpca", group.by = "KPMP_celltype", raster = FALSE)
DimPlot(so_kpmp_sc, reduction = "umap.rpca", group.by = "KPMP_celltype",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("rpca UMAP Plot with Cell Type Labels")

so_kpmp_sc$group <- factor(so_kpmp_sc$group)
DimPlot(so_kpmp_sc, reduction = "umap.rpca",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("rpca UMAP by Disease Category"))

#Barcharts of proportions
# By PT subtypes
cellcount <- so_kpmp_sc@meta.data %>% 
  filter(celltype2 == "PT")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>% 
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_PT_Cells_by_Group.png"),width = 2500, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1 )
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Biopsy")+
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_PT_Cells_by_Individual.png"),width = 3500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

prop_plot2 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Individual") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot2 

#Barcharts of proportions
# By PT subtypes
cellcount <- so_kpmp_sc@meta.data %>% 
  filter(celltype2 == "TAL")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>%
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Group.png"),width = 2500, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Biopsy") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Individual.png"),width = 3500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Barcharts of proportions
# By PT subtypes
cellcount <- so_kpmp_sc@meta.data %>% 
  filter(grepl("EC-",KPMP_celltype) | grepl("EC/VSMC",KPMP_celltype))

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
cellcount <- cellcount %>%
  filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1
rm(cellcount,plot1,prop_plot1)

```

###ii. Organoid
####a. 15 Glucose
```{r}
# PCA
so_15 <- NormalizeData(so_15)
so_15 <- ScaleData(so_15, features = VariableFeatures(so_15))
so_15 <- FindVariableFeatures(object = so_15)
so_15 <- RunPCA(so_15, features = VariableFeatures(object = so_15),assay="RNA")
# ElbowPlot(so_15)

# # Find neighbors and clusters (again using integrated data)
so_15 <- FindNeighbors(so_15, assay = "RNA", dims = 1:20)
so_15 <- FindClusters(so_15, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunUMAP(so_liver_sc, dims = 1:15)
so_15@reductions
DimPlot(so_15, reduction = "umap", raster = F)

so_15$ScType_Kidney_human <- so_15$`ScType-Kidney-human`

DimPlot(so_15, reduction = "umap", group.by = "ScType_Kidney_human", raster = T)
DimPlot(so_15, reduction = "umap", group.by = "ScType_Kidney_human", raster = T,label=T)

# png(fs::path(dir.results,"UMAP_Celltypes_Organoid.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(DimPlot(so_15, reduction = "umap", group.by = "ScType-Kidney-human", raster = FALSE))
# dev.off()

plot1 <- DimPlot(so_15, reduction = "umap", group.by = "ScType-Kidney-human",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("UMAP Plot with Cell Type Labels")

png(fs::path(dir.results,"UMAP_Celltypes_Biopsy.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot1)
dev.off()

so_15$group <- factor(so_15$group)
plot2 <- DimPlot(so_15, reduction = "umap",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("UMAP by Disease Category"))

png(fs::path(dir.results,"UMAP_Celltypes_Organoid_by_DiseaseStatus.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot2)
dev.off()

DimPlot(so_15, reduction = "umap.rpca", raster = F)
DimPlot(so_15, reduction = "umap.rpca", group.by = "KPMP_celltype", raster = FALSE)
DimPlot(so_15, reduction = "umap.rpca", group.by = "KPMP_celltype",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("rpca UMAP Plot with Cell Type Labels")

so_15$group <- factor(so_15$group)
DimPlot(so_15, reduction = "umap",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("rpca UMAP by Disease Category"))

#Barcharts of proportions
# By PT subtypes
cellcount <- so_15@meta.data 
# filter(`ScType-Kidney-human` == "Proximal tubule cells")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>% 
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = `ScType-Kidney-human`)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") 
# scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_Cells_by_Group.png"),width = 3000, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1 )
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(samples, fill = `ScType-Kidney-human`)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Organoids")
# scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_PT_Cells_by_Individual.png"),width = 4500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

prop_plot2 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Individual") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot2 

#Barcharts of proportions
# By PT subtypes
cellcount <- so_15@meta.data %>% 
  filter(celltype2 == "TAL")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>%
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Group.png"),width = 2500, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Biopsy") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Individual.png"),width = 3500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Barcharts of proportions
# By PT subtypes
cellcount <- so_15@meta.data %>% 
  filter(grepl("EC-",KPMP_celltype) | grepl("EC/VSMC",KPMP_celltype))

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
cellcount <- cellcount %>%
  filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1
rm(cellcount,plot1,prop_plot1)

```
####b. 30 Glucose
```{r}
# PCA
so_30 <- NormalizeData(so_30)
so_30 <- ScaleData(so_30, features = VariableFeatures(so_30))
so_30 <- FindVariableFeatures(object = so_30)
so_30 <- RunPCA(so_30, features = VariableFeatures(object = so_30),assay="RNA")
# ElbowPlot(so_30)

# # Find neighbors and clusters (again using integrated data)
so_30 <- FindNeighbors(so_30, assay = "RNA", dims = 1:20)
so_30 <- FindClusters(so_30, resolution = 0.5)

# Perform UMAP and tSNE
# so_liver_sc <- RunUMAP(so_liver_sc, dims = 1:15)
so_30@reductions
DimPlot(so_30, reduction = "umap", raster = F)

so_30$ScType_Kidney_human <- so_30$`ScType-Kidney-human`

DimPlot(so_30, reduction = "umap", group.by = "ScType_Kidney_human", raster = T)
DimPlot(so_30, reduction = "umap", group.by = "ScType_Kidney_human", raster = T,label=T)

# png(fs::path(dir.results,"UMAP_Celltypes_Organoid.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(DimPlot(so_30, reduction = "umap", group.by = "ScType-Kidney-human", raster = FALSE))
# dev.off()

plot1 <- DimPlot(so_30, reduction = "umap", group.by = "ScType-Kidney-human",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("UMAP Plot with Cell Type Labels")

png(fs::path(dir.results,"UMAP_Celltypes_Biopsy.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot1)
dev.off()

so_30$group <- factor(so_30$group)
plot2 <- DimPlot(so_30, reduction = "umap",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("UMAP by Disease Category"))

png(fs::path(dir.results,"UMAP_Celltypes_Organoid_by_DiseaseStatus.png"),width = 5000, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(plot2)
dev.off()

DimPlot(so_30, reduction = "umap.rpca", raster = F)
DimPlot(so_30, reduction = "umap.rpca", group.by = "KPMP_celltype", raster = FALSE)
DimPlot(so_30, reduction = "umap.rpca", group.by = "KPMP_celltype",raster = FALSE, label = TRUE, label.size = 4)+
  ggtitle("rpca UMAP Plot with Cell Type Labels")

so_30$group <- factor(so_30$group)
DimPlot(so_30, reduction = "umap",group.by = "group",label=F,raster=F) +
  ggtitle(paste0("rpca UMAP by Disease Category"))

#Barcharts of proportions
# By PT subtypes
cellcount <- so_30@meta.data 
# filter(`ScType-Kidney-human` == "Proximal tubule cells")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>% 
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = `ScType-Kidney-human`)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") 
# scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_Cells_by_Group.png"),width = 3000, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1 )
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(samples, fill = `ScType-Kidney-human`)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Organoids")
# scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_PT_Cells_by_Individual.png"),width = 4500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

prop_plot2 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Individual") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot2 

#Barcharts of proportions
# By PT subtypes
cellcount <- so_30@meta.data %>% 
  filter(celltype2 == "TAL")

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
# cellcount <- cellcount %>%
#   filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Group.png"),width = 2500, height = 2500, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Individual
prop_plot1 <- ggplot(data=cellcount,aes(record_id, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Kidney Biopsy") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1 
png(fs::path(dir.results,"Barchart_TAL_Cells_by_Individual.png"),width = 3500, height = 3000, res=300)
# pdf(plot1,fs::path(dir.results,"UMAP_Celltypes_Organoid_Samples.pdf"),width=10,height=10)
plot(prop_plot1)
dev.off()

#Barcharts of proportions
# By PT subtypes
cellcount <- so_30@meta.data %>% 
  filter(grepl("EC-",KPMP_celltype) | grepl("EC/VSMC",KPMP_celltype))

label(cellcount$group) <- "Disease Status"
# label(cellcount$steatosis_cat) <- "Steatosis Category"
# cellcount$group <- ifelse(cellcount$group=="0+1", "Low Steatosis (0+1)","High Steatosis (2+3)")
# cellcount$group <- factor(cellcount$group,levels=c("Lean_Control","Obese_Control","Type_1_Diabetes","Type_2_Diabetes"),labels=c("Lean Controls","Obese Controls","Type 1 Diabetes","Type 2 Diabetes"))
# cellcount$KPMP_celltype2 <- factor(cellcount$KPMP_celltype2,levels=c("PT-S1/S2","PT-S3","aPT"),labels=c("PT-S1/S2","PT-S3","aPT"))
cellcount <- cellcount %>%
  filter(group!="Obese Controls")

prop_plot1 <- ggplot(data=cellcount,aes(group, fill = KPMP_celltype)) + 
  geom_bar(stat = "count", position = "fill") +
  theme_classic() +
  labs(x = NULL,
       y = "Proportion of Cells",
       fill = "Cell type") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  theme(plot.title = element_text(hjust=0.5, face="bold"),
        text = element_text(size = 20)) +
  ggtitle("Disease Status") +
  scale_fill_manual(values = c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51","darkred"))

prop_plot1
rm(cellcount,plot1,prop_plot1)

```

## b. Descriptive Statistics 
```{r}
#Get metadata for everyone
dat <- so_kpmp_sc@meta.data %>%
  mutate(group=as.character(group)) %>% 
  arrange(screen_date) %>%
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, first(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, first(na.omit(.x)))),
                   .by = c(record_id, visit))

dat$hba1c <- as.numeric(dat$hba1c)
dat$eGFR_CKD_epi <- as.numeric(dat$eGFR_CKD_epi)
# dat$group 

#Table 1. 
table1(~ age + sex + race_ethnicity  + bmi + triglycerides + hba1c + medication + eGFR_CKD_epi +acr_u +epic_mfm_1+epic_insulin_1| group, data=dat)


table1(~ age + sex + race_ethnicity  + bmi + triglycerides + hba1c + medication| record_id, data=dat)
table1(~pah_clear_bsa + eGFR_CKD_epi +acr_u +mfm_1+insulin_1| record_id, data=dat)

#Covariates to adjust for: 
#Acru, metformin/insulin,bmi,age,tg
#Although check on metformin/insulin variables...
```

## c. Evaluate Covariates before Adjustment
```{r}
#Categorical Covariates
#Get metadata for everyone
dat <- so_kpmp_sc@meta.data %>%
  group_by(record_id) %>%
  summarise(across(everything(), first)) %>%
  ungroup() 

dat$hba1c <- as.numeric(dat$hba1c)
dat$eGFR_CKD_epi <- as.numeric(dat$eGFR_CKD_epi)
dat$hba1c <- as.numeric(dat$hba1c)
dat$eGFR_CKD_epi <- as.numeric(dat$eGFR_CKD_epi)
label(dat$hba1c) <- "HbA1c (%)"
label(dat$age) <- "Age (Years)"
label(dat$sex) <- "Sex"
label(dat$race_ethnicity) <- "Race/Ethnicity"
label(dat$bmi) <- "BMI (kg/m2)"
label(dat$triglycerides) <- "Triglycerides (mg/dL)"
label(dat$medication) <- "GLP-1/SGLT2i Status"
label(dat$epic_mfm_1) <- "Metformin"
label(dat$epic_insulin_1) <- "Insulin"
label(dat$pah_clear_bsa) <- "PAH Clearance (BSA)"
label(dat$eGFR_CKD_epi) <- "Estimated Glomerular Filtration Rate (eGFR)"
label(dat$acr_u) <- "ACRu"
# label(dat$SGLT2) <- "SGLT2i"
label(dat$group) <- "Type 2 Diabetes Status"


cat_covariates <- c("sex", "race_ethnicity","epic_mfm_1","epic_insulin_1")
plot_list <- list()

custom_colors <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51", "darkred")

png(fs::path(dir.results, "Plot_Categorical_Covariates_NoMed.png"),
    width = 3000, height = 3000, res = 300)
for (covariate in cat_covariates) {
  p <- ggplot(dat, aes_string(x = "group", fill = covariate)) +
    geom_bar(position = "fill") +  # use "dodge" for absolute counts
    labs(y = "Proportion", x = NULL) +
    # title = paste0("Distribution of ", covariate, " by Diabetes Status")
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = custom_colors) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  plot_list[[covariate]] <- p
}

# Display all plots together (adjust depending on how many you have)
wrap_plots(plot_list, ncol = 2)
dev.off()

#Continuous Covariates
con_covariates <- c("age", "bmi", "triglycerides", "hba1c","pah_clear_bsa","eGFR_CKD_epi","gfr_bsa_plasma","acr_u")
# "avg_c_k2","avg_c_f","avg_m_k2","avg_m_f","avg_c_k2_f","avg_m_k2_f")
plot_list <- list()
custom_colors <- c("#f4a261", "darkred")

# Display all plots together (adjust ncol/nrow as needed)
png(fs::path(dir.results, "Plot_Continuous_Covariates_NoMed.png"),
    width = 3000, height = 3000, res = 300)
for (covariate in con_covariates) {
  p <- ggplot(dat, aes_string(x = "group", y = covariate, fill = "group")) +
    geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(width = 0.2, alpha = 0.4, color = "black") +
    scale_fill_manual(values = custom_colors) +
    theme_minimal() +
    theme(legend.position = "none")
  
  plot_list[[covariate]] <- p
}
wrap_plots(plot_list, ncol = 2 )
dev.off()

# cat_covariates <- c("sex", "race_ethnicity", "medication", "epic_mfm_1", "epic_insulin_1")
# plot_list <- list()
# 
# for (covariate in cat_covariates) {
#   p <- ggplot(dat, aes_string(x = "group", fill = covariate)) +
#     geom_bar(position = "fill") +  # use "dodge" for absolute counts
#     labs(title = paste0("Distribution of ", covariate),
#          y = "Proportion", x = NULL) +
#     scale_y_continuous(labels = scales::percent_format()) +
#     theme_minimal() +
#     theme(axis.text.x = element_text(angle = 45, hjust = 1))
#   
#   plot_list[[covariate]] <- p
# }
# 
# # Display all plots together (adjust depending on how many you have)
# wrap_plots(plot_list, ncol = 2)
# 
# 
# #Continuous Covariates
# con_covariates <- c("age", "bmi", "triglycerides", "hba1c", "pah_clear_bsa", "eGFR_CKD_epi", "acr_u")
# plot_list <- list()
# 
# for (covariate in con_covariates) {
#   p <- ggplot(dat, aes_string(x = "group", y = covariate, fill = "group")) +
#     geom_boxplot(outlier.shape = NA, alpha = 0.7) +
#     geom_jitter(width = 0.2, alpha = 0.4, color = "black") +  # optional: show points
#     labs(title = paste0("Distribution of ", covariate),
#          x = "Group", y = covariate) +
#     theme_minimal() +
#     theme(legend.position = "none")
#   
#   plot_list[[covariate]] <- p
# }
# 
# # Display all plots together (adjust ncol/nrow as needed)
# wrap_plots(plot_list, ncol = 3)
```

#4. Analysis 
##I. Biopsy
## PT Cells 
##a. PT Cells all
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,celltype2=="PT")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_PT_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "PT, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-3,3)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_PT_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_PT_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
# kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
# reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
# go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)
# 
# # rank genes by t-stats in DiD
# rankings_PT <- full_results$LogFC
# names(rankings_PT) <- full_results$Gene
# rankings_PT <- sort(rankings_PT, decreasing = TRUE)
# plot(rankings_PT)
# min(rankings_PT)
# max(rankings_PT)
# 
# 
# set.seed(1234)
# 
# kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
#                             stats = rankings_PT,
#                             scoreType = 'std', 
#                             minSize = 3,
#                             maxSize = 500,
#                             nproc = 1)
# 
# reactome_res_PT <- fgsea(pathways = reactome,
#                          stats = rankings_PT,
#                          scoreType = 'std', 
#                          minSize = 3,
#                          maxSize = 500,
#                          nproc = 1)
# go_res_PT <- fgsea(pathways = go,
#                    stats = rankings_PT,
#                    scoreType = 'std', 
#                    minSize = 5,
#                    maxSize = 500,
#                    nproc = 1)
# 
# PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
#                        "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
#                        "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
# rownames(PT_fgsea) <- c("adj.pval", "p.val")
# 
# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)",xlimit = 4, xnudge = 0.03)+ theme(legend.position.inside = c(0.2, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
# #        width = 13, height = 10, scale = 1)
# 
# ##### REACTOME
# b <- plot_fgsea_transpose(reactome_res_PT, title = "PT Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position.inside = c(0.15, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
# #        width = 13, height = 10, scale = 1)
# ##### GO
# c <- plot_fgsea_transpose(go_res_PT, title = "PT Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position.inside = c(0.1, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
# #        width = 13, height = 10, scale = 1)
# 
# combined_plot <- b + c + plot_layout(ncol = 1)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 15, height = 20, scale = 1)
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "PT Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "PT Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Biopsy_PT_top30_pathways_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

### iii. Targeted Gene
```{r}
#GENES: ROBO4 and FN1
target_genes <- c("ROBO4","FN1")
so_celltype <- subset(so_kpmp_sc,celltype2=="PT")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

# ## Select Highly Variable Genes (HVGs)
# so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
# hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- target_genes

cl <- makeCluster(2)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)




```

##b. aPT 
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="aPT")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_aPT_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "aPT, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_aPT_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aPT_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "aPT Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "aPT Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_aPT_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

## c. PT-S1/S2 
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="PT-S1/S2")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_PT_S1_S2_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "PT-S1/S2, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_PT_S1_S2_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```

### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_PT_S1_S2_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "PT-1/2 Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "PT-1/2 Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_PT_S1_S2_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

## d. PT-S3 
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="PT-S3")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_PT_S3_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "PT-S3, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")

volcano_plot

png(fs::path(dir.results, "Plot_Biopsy_NEBULA_PT_S3_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_PT_S3_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "PT-S3 Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "PT-S3 Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_PT_S3_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```


## TAL
## a. TAL Cells all
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,celltype2=="TAL")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_TAL_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "TAL, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_TAL_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_TAL_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "TAL Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "TAL Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_TAL_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

## b. C-TAL-1 
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="C-TAL-1")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_C_TAL_1_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "C-TAL-1, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_C_TAL_1_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_C_TAL_1_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "TAL-1 Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "TAL-1 Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_C_TAL_1_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```
### iii. Targeted Genes
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="C-TAL-1")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

# ## Select Highly Variable Genes (HVGs)
# so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
# hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
rownames(so_celltype)[which(grepl("ROB",rownames(so_celltype)))]
rownames(so_celltype)[which(grepl("FN1",rownames(so_celltype)))]

genes_list <- c("FN1")

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Targeted_Biopsy_NEBULA_C_TAL_1_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "C-TAL-1, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Targeted_Plot_Biopsy_NEBULA_C_TAL_1_Diabetes.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```

## c. C-TAL-2
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="C-TAL-2")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_C_TAL_2_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "C-TAL-2, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_C_TAL_2_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_C_TAL_2_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "TAL-2 Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "TAL-2 Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_C_TAL_2_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```
### iii. Targeted Genes
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="C-TAL-2")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

# ## Select Highly Variable Genes (HVGs)
# so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
# hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- c("FN1")

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Targeted_Biopsy_NEBULA_C_TAL_2_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "C-TAL-2, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Targeted_Plot_Biopsy_NEBULA_C_TAL_2_Diabetes.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```

## d. dTAL
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="dTAL")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_dTAL_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "dTAL, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_dTAL_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_dTAL_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "dTAL Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "dTAL Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_dTAL_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

## e. aTAL
### i. NEBULA
```{r}
#Filter to PT Cells
so_celltype <- subset(so_kpmp_sc,KPMP_celltype=="aTAL")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

## Select Highly Variable Genes (HVGs)
so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- hvgs

cl <- makeCluster(20)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType_2_Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))  # Avoid log(0)

write.csv(full_results,fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv"))

full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                             ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))

# Identify significant points (fdr < 0.05)
significant_df <- full_results[full_results$fdr < 0.05, ]

Genes <- length(unique(full_results$gene))
Cells <- ncol(so_celltype)
Nonconvergence_Rate <- nebula_nonconverged_percent
# full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 > 0, "lightcoral",
#                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType_2_Diabetes`3 < 0, "lightblue", "gray"))
# 
# # Identify significant points (fdr < 0.05)
# significant_df3 <- full_results[full_results$fdr3 < 0.2, ]

max <- max(full_results$`logFC_groupType_2_Diabetes`)
# max <- 3.1
min <- min(full_results$`logFC_groupType_2_Diabetes`)
# Create the volcano plot using ggplot
volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +  # Plot points with transparency
  scale_color_identity() +  # Use the color column directly
  theme_minimal() +  # Minimal theme
  labs(
    title = "Type 2 Diabetes vs. Lean Controls",
    subtitle = "aTAL, Unadjusted (REML, Log Normal, Offset)",
    x = "FC",
    y = "-log10(P-Value)",
    color = "FC Direction Direction",
    caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  ) +
  theme(
    plot.title = element_text(hjust = 0),
    axis.text.x = element_text(angle = 0, hjust = 1)
  )+
  # xlim(min,max)+
  xlim(-5,5)+
  # # Add labels for significant points
  geom_text(data = significant_df, aes(label = gene),
            vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
# Add labels for significant points with ggrepel
# geom_text_repel(data = significant_df, aes(label = Gene),
#                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)

volcano_plot

# pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
# print(volcano_plot)
# dev.off()
png(fs::path(dir.results, "Plot_Biopsy_NEBULA_aTAL_Diabetes_unadjusted_2000_offset.png"), 
    width = 3000, height = 2100, res = 300)
print(volcano_plot)
dev.off()

```
### ii. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "aTAL Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "aTAL Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Pathways_Biopsy_aTAL_top30_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

## II. Organoid
### i. NEBULA
#### a. 15
```{r}
#15 glucose
so_subset <- subset(sc_org,treatment=="15")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  # so_celltype_hvg <- subset(so_celltype, features = hvgs)
  # DefaultAssay(so_celltype_hvg) <- "RNA" 
  
  ###
  # meta_hvg <- so_celltype@meta.data
  # pred = model.matrix(~group, data = meta_hvg)
  # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  
  #Make sure exposure/independent/x variable or group variable is a factor variable
  so_celltype$group <- factor(so_celltype$group)
  #Make sure to set reference level
  so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  
  # so_celltype$treatment <- factor(so_celltype$treatment)
  
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  
  # #Center gene expression variables
  # counts_dense <- as.matrix(counts_hvg)
  # counts_centered <- sweep(counts_dense, 1, rowMeans(counts_dense), "-")
  # counts_hvg <- counts_centered
  # offset_hvg = Matrix::colSums(data_g_hvg$count) 
  
  # With parallelization
  # List of genes
  # genes_list <- rownames(counts_hvg)
  genes_list <- hvgs
  
  cl <- makeCluster(60)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
    tryCatch({
      count_gene <- counts_hvg[g, , drop = FALSE]
      meta_gene <- subset(so_celltype,features=g)@meta.data
      pred_gene <- model.matrix(~group, data = meta_gene)
      # library <- meta_gene$library_size
      library <- meta_gene$pooled_offset
      data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
      
      if (is.null(data_g_gene)) {
        data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
      }
      
      #With offset
      result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset,verbose=TRUE)
      
      list(gene = g, result = result)  # return both gene name and result
      
    }, error = function(e) {
      NULL
    })
  }
  
  stopCluster(cl)
  end_time <- Sys.time()
  print(end_time - start_time)
  
  # set the names of results based on gene names
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results
  
  PT_nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      df <- data.frame(Gene = gene_name,
                       Convergence_Code = converged)
      return(df)
    }
  )
  
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40|PT_nebula_converged$Convergence_Code==-50|PT_nebula_converged$Convergence_Code==-60)]) 
  
  #Make dataframe of final results
  full_results <- as.data.frame(nebula_summaries) %>% 
    dplyr::select(-Gene) %>% 
    dplyr::rename(input=gene)
  
  #Change gene names
  full_results <- tidylog::left_join(full_results,gene_annotations,by="input")
  
  #Calculate number of genes filtered out for low expression 
  low_exp <- length(genes_list)-length(full_results$gene)
  #Filter out non-converging genes
  full_results <- full_results %>% 
    filter(!input %in%  nonconverge_genes)
  #Calculate nonconvergence rate
  nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
  # nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
  # print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
  full_results <- full_results %>%
    mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment15`,method="fdr"))
  # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  full_results$PValue10 <- -log10(pmax(full_results$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # full_results$PValue10_int <- -log10(pmax(full_results$`p_groupType 2 Diabetes:treatment15`, 1e-10))  # Avoid log(0)
  
  write.csv(full_results,fs::path(dir.results,paste0("Organoid_NEBULA_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType 2 Diabetes` > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType 2 Diabetes` < 0, "#003366", "gray"))
  # full_results$color_int <- ifelse(full_results$fdr_int < 0.05 & full_results$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(full_results$fdr_int < 0.05 & full_results$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- full_results[full_results$fdr < 0.05, ]
  # significant_df_int <- full_results[full_results$fdr_int < 0.05, ]
  
  Genes <- length(unique(full_results$Gene))
  Cells <- ncol(so_celltype)
  Nonconvergence_Rate <- nebula_nonconverged_percent
  # full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- full_results[full_results$fdr3 < 0.2, ]
  
  max <- max(full_results$`logFC_groupType 2 Diabetes`)
  # max <- 3.1
  min <- min(full_results$`logFC_groupType 2 Diabetes`)
  
  # max_int <- max(full_results$`logFC_groupType 2 Diabetes:treatment15`)
  # max <- 3.1
  # min_int <- min(full_results$`logFC_groupType 2 Diabetes:treatment15`)
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType 2 Diabetes`, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 15 (REML, Log Normal, Pooled Offset)"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    ylim(0,11)+
    # # Add labels for significant points
    geom_text(data = significant_df, aes(label = Gene),
              vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # Add labels for significant points with ggrepel
  # geom_text_repel(data = significant_df, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  
  volcano_plot
  # 
  # volcano_plot_int <- ggplot(full_results, aes(x = `logFC_groupType 2 Diabetes:treatment15`, y = PValue10_int, color = color_int)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls Interaction with Treatment",
  #     subtitle = paste0(celltype,", Unadjusted (REML, Log Normal, Pooled Offset)"),
  #     x = "Treatment Interaction FC",
  #     y = "-log10(P-Value)",
  #     color = "Treatment Interaction FC Direction Direction",
  #     caption = paste0("FDR Interaction < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   # xlim(min_int,max_int)+
  #   xlim(-3,3)+
  #   # # Add labels for significant points
  #   geom_text(data = significant_df_int, aes(label = Gene),
  #             vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # Add labels for significant points with ggrepel
  # geom_text_repel(data = significant_df, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  
  # volcano_plot_int
  
  # combined_plot <- volcano_plot + volcano_plot_int + plot_layout(ncol = 2)
  
  # pdf(fs::path(dir.results,"Plot_NEBULA_PT_Diabetes_unadjusted_2000_hvg.pdf"),width=10,height=7)
  # print(volcano_plot)
  # dev.off()
  png(fs::path(dir.results, paste0("Plot_Organoid_NEBULA_",celltype,"_Diabetes_lc_2000_offset_15.png")), 
      width = 1500, height = 2100, res = 150)
  print(volcano_plot)
  dev.off()
}
```

#### b. 30
```{r}
#30 glucose
so_subset <- subset(sc_org,treatment=="30")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  # so_celltype_hvg <- subset(so_celltype, features = hvgs)
  # DefaultAssay(so_celltype_hvg) <- "RNA" 
  
  ###
  # meta_hvg <- so_celltype@meta.data
  # pred = model.matrix(~group, data = meta_hvg)
  # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  
  #Make sure exposure/independent/x variable or group variable is a factor variable
  so_celltype$group <- factor(so_celltype$group)
  #Make sure to set reference level
  so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  
  # so_celltype$treatment <- factor(so_celltype$treatment)
  
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  
  
  
  # offset_hvg = Matrix::colSums(data_g_hvg$count) 
  
  # With parallelization
  # List of genes
  # genes_list <- rownames(counts_hvg)
  genes_list <- hvgs
  
  cl <- makeCluster(60)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
    tryCatch({
      count_gene <- counts_hvg[g, , drop = FALSE]
      meta_gene <- subset(so_celltype,features=g)@meta.data
      pred_gene <- model.matrix(~group, data = meta_gene)
      # library <- meta_gene$library_size
      library <- meta_gene$pooled_offset
      data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
      
      if (is.null(data_g_gene)) {
        data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
      }
      
      #With offset
      result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1,model="NBLMM",reml=1,output_re = T,covariance=T,offset=data_g_gene$offset)
      #model="NBLMM",reml=T
      
      list(gene = g, result = result)  # return both gene name and result
      
    }, error = function(e) {
      NULL
    })
  }
  
  stopCluster(cl)
  end_time <- Sys.time()
  print(end_time - start_time)
  
  # set the names of results based on gene names
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results
  
  PT_nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      df <- data.frame(Gene = gene_name,
                       Convergence_Code = converged)
      return(df)
    }
  )
  
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40|PT_nebula_converged$Convergence_Code==-50|PT_nebula_converged$Convergence_Code==-60)]) 
  
  #Make dataframe of final results
  full_results <- as.data.frame(nebula_summaries) %>% 
    dplyr::select(-Gene) %>% 
    dplyr::rename(input=gene)
  
  #Change gene names
  full_results <- tidylog::left_join(full_results,gene_annotations,by="input")
  
  #Calculate number of genes filtered out for low expression 
  low_exp <- length(genes_list)-length(full_results$gene)
  #Filter out non-converging genes
  full_results <- full_results %>% 
    filter(!input %in%  nonconverge_genes)
  #Calculate nonconvergence rate
  nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
  # nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
  # print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
  full_results <- full_results %>%
    mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment30`,method="fdr"))
  # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  full_results$PValue10 <- -log10(pmax(full_results$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # full_results$PValue10_int <- -log10(pmax(full_results$`p_groupType 2 Diabetes:treatment30`, 1e-10))  # Avoid log(0)
  
  write.csv(full_results,fs::path(dir.results,paste0("Organoid_NEBULA_",celltype,"_diabetes_lc_treatment30_adj_2000_LME.csv")))
  
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType 2 Diabetes` > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType 2 Diabetes` < 0, "#003366", "gray"))
  # full_results$color_int <- ifelse(full_results$fdr_int < 0.05 & full_results$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(full_results$fdr_int < 0.05 & full_results$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- full_results[full_results$fdr < 0.05, ]
  # significant_df_int <- full_results[full_results$fdr_int < 0.05, ]
  
  Genes <- length(unique(full_results$Gene))
  Cells <- ncol(so_celltype)
  Nonconvergence_Rate <- nebula_nonconverged_percent
  # full_results$color3 <- ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(full_results$fdr3 < 0.2 & full_results$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- full_results[full_results$fdr3 < 0.2, ]
  
  max <- max(full_results$`logFC_groupType 2 Diabetes`)
  # max <- 3.1
  min <- min(full_results$`logFC_groupType 2 Diabetes`)
  
  # max_int <- max(full_results$`logFC_groupType 2 Diabetes:treatment30`)
  # max <- 3.1
  # min_int <- min(full_results$`logFC_groupType 2 Diabetes:treatment30`)
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType 2 Diabetes`, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 30 (NBLMM, REML, Pooled Offset)"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells,", Non-Convergence Rate: ",Nonconvergence_Rate,", Genes Filtered out for Low Expression: ",low_exp)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    ylim(0,11)+
    # # Add labels for significant points
    geom_text(data = significant_df, aes(label = Gene),
              vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # Add labels for significant points with ggrepel
  # geom_text_repel(data = significant_df, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  
  volcano_plot
  
  png(fs::path(dir.results, paste0("Plot_Organoid_NEBULA_",celltype,"_Diabetes_lc_2000_offset_30_NBLMM_REML.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
}
```

### ii. Find Markers
#### a. 15 Glucose
```{r}
#15 glucose
so_subset <- subset(sc_org,treatment=="15")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  ###
  # meta_hvg <- so_celltype@meta.data
  # pred = model.matrix(~group, data = meta_hvg)
  # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  
  #Make sure exposure/independent/x variable or group variable is a factor variable
  so_celltype$group <- factor(so_celltype$group)
  #Make sure to set reference level
  so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  
  # so_celltype$treatment <- factor(so_celltype$treatment)
  
  # counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  
  #Find markers
  # Set identities to the 'group' column
  Idents(so_celltype) <- "group"
  markers <- FindMarkers(
    object = so_celltype,
    ident.1 = "Type 2 Diabetes",
    ident.2 = "Lean Control",  # optional: if omitted, compared to all other cells
    # group.by = "group",  # optional
    min.pct = 0,      # only test genes expressed in >10% of cells
    logfc.threshold = 0  # only return genes with log2FC > 0.25
  )
  
  markers$input <- rownames(markers)
  markers <- tidylog::left_join(markers,gene_annotations,by="input")
  
  # ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj))) +
  #   geom_point(aes(color = p_val_adj < 0.05 & abs(avg_log2FC) > 0.25), alpha = 0.6) +
  #   scale_color_manual(values = c("grey", "red")) +
  #   theme_minimal() +
  #   labs(
  #     title = "Volcano Plot: T2D vs Lean Control",
  #     x = "Log2 Fold Change",
  #     y = "-log10 Adjusted p-value"
  #   ) +
  #   theme(legend.position = "none")
  
  
  # markers <- markers %>%
  #   mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment30`,method="fdr"))
  # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  # markers$PValue10 <- -log10(pmax(markers$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # markers$PValue10_int <- -log10(pmax(markers$`p_groupType 2 Diabetes:treatment30`, 1e-10))  # Avoid log(0)
  
  write.csv(markers,fs::path(dir.results,paste0("Organoid_FindMarkers_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  markers$color <- ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC > 0, "#990000",
                          ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC < 0, "#003366", "gray"))
  # markers$color_int <- ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- markers[markers$p_val_adj < 0.05, ]
  # significant_df_int <- markers[markers$fdr_int < 0.05, ]
  
  Genes <- length(unique(markers$Gene))
  Cells <- ncol(so_celltype)
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # markers$color3 <- ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- markers[markers$fdr3 < 0.2, ]
  
  top_up <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC > 0) %>%
    arrange(p_val_adj, desc(avg_log2FC)) %>%
    head(10)
  
  top_down <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC < 0) %>%
    arrange(p_val_adj, avg_log2FC) %>%
    head(10)
  
  top_markers <- bind_rows(top_up, top_down)
  
  max <- max(markers$avg_log2FC)
  # max <- 3.1
  min <- min(markers$avg_log2FC)
  
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 15"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    # ylim(0,11)+
    # # Add labels for significant points
    # geom_text(data = significant_df, aes(label = Gene),
    #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    # Add labels for significant points with ggrepel
    geom_text_repel(data = top_markers, aes(label = Gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  # geom_text_repel(data = top_markers, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  
  
  
  png(fs::path(dir.results, paste0("Plot_Organoid_FindMarkers_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
}
```

#### b. 30 Glucose
```{r}
#15 glucose
so_subset <- subset(sc_org,treatment=="30")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  ###
  # meta_hvg <- so_celltype@meta.data
  # pred = model.matrix(~group, data = meta_hvg)
  # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  
  #Make sure exposure/independent/x variable or group variable is a factor variable
  so_celltype$group <- factor(so_celltype$group)
  #Make sure to set reference level
  so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  
  # so_celltype$treatment <- factor(so_celltype$treatment)
  
  # counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  
  #Find markers
  # Set identities to the 'group' column
  Idents(so_celltype) <- "group"
  markers <- FindMarkers(
    object = so_celltype,
    ident.1 = "Type 2 Diabetes",
    ident.2 = "Lean Control",  # optional: if omitted, compared to all other cells
    # group.by = "group",  # optional
    min.pct = 0,      # only test genes expressed in >10% of cells
    logfc.threshold = 0  # only return genes with log2FC > 0.25
  )
  
  markers$input <- rownames(markers)
  markers <- tidylog::left_join(markers,gene_annotations,by="input")
  
  # ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj))) +
  #   geom_point(aes(color = p_val_adj < 0.05 & abs(avg_log2FC) > 0.25), alpha = 0.6) +
  #   scale_color_manual(values = c("grey", "red")) +
  #   theme_minimal() +
  #   labs(
  #     title = "Volcano Plot: T2D vs Lean Control",
  #     x = "Log2 Fold Change",
  #     y = "-log10 Adjusted p-value"
  #   ) +
  #   theme(legend.position = "none")
  
  
  # markers <- markers %>%
  #   mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment30`,method="fdr"))
  # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  # markers$PValue10 <- -log10(pmax(markers$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # markers$PValue10_int <- -log10(pmax(markers$`p_groupType 2 Diabetes:treatment30`, 1e-10))  # Avoid log(0)
  
  write.csv(markers,fs::path(dir.results,paste0("Organoid_FindMarkers_",celltype,"_diabetes_lc_treatment30_adj_2000.csv")))
  
  markers$color <- ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC > 0, "#990000",
                          ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC < 0, "#003366", "gray"))
  # markers$color_int <- ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- markers[markers$p_val_adj < 0.05, ]
  # significant_df_int <- markers[markers$fdr_int < 0.05, ]
  
  Genes <- length(unique(markers$Gene))
  Cells <- ncol(so_celltype)
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # markers$color3 <- ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- markers[markers$fdr3 < 0.2, ]
  
  top_up <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC > 0) %>%
    arrange(p_val_adj, desc(avg_log2FC)) %>%
    head(10)
  
  top_down <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC < 0) %>%
    arrange(p_val_adj, avg_log2FC) %>%
    head(10)
  
  top_markers <- bind_rows(top_up, top_down)
  
  max <- max(markers$avg_log2FC)
  # max <- 3.1
  min <- min(markers$avg_log2FC)
  
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 30"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    # ylim(0,11)+
    # # Add labels for significant points
    # geom_text(data = significant_df, aes(label = Gene),
    #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    # Add labels for significant points with ggrepel
    geom_text_repel(data = top_markers, aes(label = Gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  # geom_text_repel(data = top_markers, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  
  
  
  png(fs::path(dir.results, paste0("Plot_Organoid_FindMarkers_",celltype,"_Diabetes_lc_2000_30.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
}
```

### iii. Pseudobulk FindMarkers & DESeq2
#### a. 15 Glucose
#####A. Trailmaker Annotations
```{r}
#15 glucose
so_subset <- subset(sc_org,treatment=="15")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
# rm(so_subset)
gene_annotations2 <- gene_annotations %>% 
  dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  
  counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  counts_annotated <- counts_annotated %>% 
    dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", Treatment 15"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 15"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  
  # full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
  res_df <- res_df %>% 
    # clean_names() %>% 
    # dplyr::select(-x) %>% 
    dplyr::rename(Gene=gene,LogFC=log2FoldChange)
  
  # Filter out the gmt files for KEGG, Reactome and GOBP
  list.files(bg_path)
  gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
  gmt_files
  kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
  reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
  go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)
  
  # rank genes by t-stats in DiD
  rankings_PT <- res_df$LogFC
  names(rankings_PT) <- res_df$Gene
  rankings_PT <- sort(rankings_PT, decreasing = TRUE)
  plot(rankings_PT)
  min(rankings_PT)
  max(rankings_PT)
  
  set.seed(1234)
  
  kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                              stats = rankings_PT,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
  
  reactome_res_PT <- fgsea(pathways = reactome,
                           stats = rankings_PT,
                           scoreType = 'std', 
                           minSize = 3,
                           maxSize = 500,
                           nproc = 1)
  go_res_PT <- fgsea(pathways = go,
                     stats = rankings_PT,
                     scoreType = 'std', 
                     minSize = 5,
                     maxSize = 500,
                     nproc = 1)
  
  PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                         "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
  rownames(PT_fgsea) <- c("adj.pval", "p.val")
  PT_fgsea
  
  # ##### KEGG Legacy
  # a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))
  
  # ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
  #        width = 13, height = 10, scale = 1)
  
  ##### REACTOME
  b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 15"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))
  
  # ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
  #        width = 13, height = 10, scale = 1)
  ##### GO
  c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 15"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))
  
  combined_plot <- b + c + plot_layout(ncol = 1)
  print(combined_plot)
  ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment15.jpeg")),
         width = 15, height = 20, scale = 1)
  
}
```
#####B. Low Res KPMP Annotations
```{r}
#15 glucose
so_subset <- so_15_annotated
#Filter to celltype of interest
celltypes <- unique(so_subset$celltype_annotation)
# rm(so_subset)
# gene_annotations2 <- gene_annotations %>% 
#   dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,celltype_annotation==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  counts_annotated <- counts_annotated %>% 
    dplyr::rename(Gene=gene)
  # counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  # counts_annotated <- counts_annotated %>% 
  #   dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  # write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", Treatment 15"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 15"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  # png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
  #     width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  # dev.off()
}
# full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
res_df <- res_df %>% 
  # clean_names() %>% 
  # dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log2FoldChange)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- res_df$LogFC
names(rankings_PT) <- res_df$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 15"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 15"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment15.jpeg")),
       width = 15, height = 20, scale = 1)

# }
```

#####C. Biopsy Low Res KPMP Annotations
```{r}
#15 glucose
so_subset <- so_biopsy_annotated
#Filter to celltype of interest
celltypes <- unique(so_subset$celltype_annotation)
# rm(so_subset)
# gene_annotations2 <- gene_annotations %>% 
#   dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,celltype_annotation==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  counts_annotated <- counts_annotated %>% 
    dplyr::rename(Gene=gene)
  # counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  # counts_annotated <- counts_annotated %>% 
  #   dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  # write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", KPMP LR Annotations"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 15"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  # png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
  #     width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  # dev.off()
}
# full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
res_df <- res_df %>% 
  # clean_names() %>% 
  # dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log2FoldChange)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- res_df$LogFC
names(rankings_PT) <- res_df$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 15"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 15"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment15.jpeg")),
       width = 15, height = 20, scale = 1)

# }
```

#####D. Biopsy PB90 Annotations
```{r}
so_subset <- so_kpmp_sc
#Filter to celltype of interest
celltypes <- unique(so_subset$celltype_LR)
# rm(so_subset)
# gene_annotations2 <- gene_annotations %>% 
#   dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,celltype_LR==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  counts_annotated <- counts_annotated %>% 
    dplyr::rename(Gene=gene)
  # counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  # counts_annotated <- counts_annotated %>% 
  #   dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  # write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", PB90 Annotations"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 15"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  # png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
  #     width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  # dev.off()
}
# full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
res_df <- res_df %>% 
  # clean_names() %>% 
  # dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log2FoldChange)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- res_df$LogFC
names(rankings_PT) <- res_df$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 15"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 15"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment15.jpeg")),
       width = 15, height = 20, scale = 1)

# }
```

#### b. 30 Glucose
#####A. Trailmaker Annotations
```{r}
#30 glucose
so_subset <- subset(sc_org,treatment=="30")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
# rm(so_subset)
gene_annotations2 <- gene_annotations %>% 
  dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  
  counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  counts_annotated <- counts_annotated %>% 
    dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment30_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", Treatment 30"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 30"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_30.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  ############
  
  # full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
  res_df <- res_df %>% 
    # clean_names() %>% 
    # dplyr::select(-x) %>% 
    dplyr::rename(Gene=gene,LogFC=log2FoldChange)
  
  # Filter out the gmt files for KEGG, Reactome and GOBP
  list.files(bg_path)
  gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
  gmt_files
  kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
  reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
  go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)
  
  # rank genes by t-stats in DiD
  rankings_PT <- res_df$LogFC
  names(rankings_PT) <- res_df$Gene
  rankings_PT <- sort(rankings_PT, decreasing = TRUE)
  plot(rankings_PT)
  min(rankings_PT)
  max(rankings_PT)
  
  set.seed(1234)
  
  kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                              stats = rankings_PT,
                              scoreType = 'std', 
                              minSize = 3,
                              maxSize = 500,
                              nproc = 1)
  
  reactome_res_PT <- fgsea(pathways = reactome,
                           stats = rankings_PT,
                           scoreType = 'std', 
                           minSize = 3,
                           maxSize = 500,
                           nproc = 1)
  go_res_PT <- fgsea(pathways = go,
                     stats = rankings_PT,
                     scoreType = 'std', 
                     minSize = 5,
                     maxSize = 500,
                     nproc = 1)
  
  PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                         "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                         "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
  rownames(PT_fgsea) <- c("adj.pval", "p.val")
  PT_fgsea
  
  # ##### KEGG Legacy
  # a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))
  
  # ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
  #        width = 13, height = 10, scale = 1)
  
  ##### REACTOME
  b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 30"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))
  
  # ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
  #        width = 13, height = 10, scale = 1)
  ##### GO
  c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 30"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))
  
  combined_plot <- b + c + plot_layout(ncol = 1)
  print(combined_plot)
  ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment30.jpeg")),
         width = 15, height = 20, scale = 1)
}
```

#####B. Low Res KPMP Annotations
```{r}
#15 glucose
so_subset <- so_30_annotated
#Filter to celltype of interest
celltypes <- unique(so_subset$celltype_annotation)
# rm(so_subset)
# gene_annotations2 <- gene_annotations %>% 
#   dplyr::rename(gene = input)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,celltype_annotation==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # Optional sanity check
  # table(so_celltype$record_id, so_celltype$group)
  # Lean Control Type 2 Diabetes
  # CRC-03          1681               0
  # CRC-10           436               0
  # CRC-11            24               0
  # IT_19              0              13
  # RH-50-T            0              24
  # RH-62-T            0             340
  # RH-72-T            0             117
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  #Pseudobulk data for Pseudobulk analyses
  # Get the raw counts matrix (genes x cells)
  counts <- as.data.frame(round(GetAssayData(so_celltype, layer = "counts")))
  # counts <- as.data.frame(as.matrix(so_celltype[["RNA"]]@counts))
  counts$gene <- rownames(counts)
  
  # Pivot to long format (gene, cell, count)
  counts_long <- counts %>%
    pivot_longer(-gene, names_to = "cell", values_to = "count")
  
  # Add metadata (celltype and individual)
  meta <- so_celltype@meta.data %>%
    mutate(cell = rownames(so_celltype@meta.data)) %>% 
    dplyr::select(c("cell","record_id"))
  # dplyr::select(cell = rownames(so_celltype@meta.data), record_id, `ScType-Kidney-human`)
  
  # Join counts and metadata
  counts_annotated <- counts_long %>%
    inner_join(meta, by = "cell")
  counts_annotated <- counts_annotated %>% 
    dplyr::rename(Gene=gene)
  # counts_annotated <- tidylog::left_join(counts_annotated,gene_annotations2,by="gene")
  # counts_annotated <- counts_annotated %>% 
  #   dplyr::select(-c("gene")) 
  
  # Group by gene, individual, and celltype and sum counts
  pseudobulk_df <- counts_annotated %>%
    group_by(Gene, record_id) %>%
    summarise(pseudobulk_count = sum(count), .groups = "drop")
  
  # Optional: Pivot back to wide format (genes as rows)
  pseudobulk_matrix <- pseudobulk_df %>%
    # mutate(sample = paste(individual, celltype, sep = "_")) %>%
    # select(Gene, record_id, pseudobulk_count) %>%
    pivot_wider(names_from = record_id, values_from = pseudobulk_count) %>%
    as.data.frame()
  
  # Set gene names as rownames
  rownames(pseudobulk_matrix) <- pseudobulk_matrix$Gene
  pseudobulk_matrix$Gene <- NULL
  
  # Reconstruct sample metadata from Seurat object
  sample_info <- so_celltype@meta.data %>%
    mutate(cell=rownames(so_celltype@meta.data)) %>% 
    dplyr::select(cell,record_id, group) %>%  # add other covariates if needed
    distinct(record_id, .keep_all = TRUE) 
  rownames(sample_info) <- NULL
  sample_info <- sample_info %>%
    column_to_rownames("record_id")
  
  # Ensure column order matches pseudobulk matrix
  sample_info <- sample_info[colnames(pseudobulk_matrix), ]
  
  sample_info$group <- str_replace_all(sample_info$group," ","_")
  sample_info$group <- factor(sample_info$group)
  
  dds <- DESeqDataSetFromMatrix(
    countData = pseudobulk_matrix,
    colData = sample_info,
    design = ~ group  # or ~ batch + condition, etc.
  )
  
  dds <- DESeq(dds)
  
  # Example: condition A vs B
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Assume DESeq2 results are in `res`
  res_df <- as.data.frame(res)
  
  # Add gene names (if not already)
  res_df$gene <- rownames(res_df)
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment15` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$gene))
  Cells <- ncol(so_celltype)
  
  # write.csv(res_df,fs::path(dir.results,paste0("Organoid_Pseudobulk_DESeq2_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  # Pull specific genes of interest if significant
  roi_genes <- c("ROBO1", "ROBO2", "FN1")
  roi_significant <- res_df %>%
    filter(gene %in% roi_genes, padj < 0.05)
  
  # Combine with top DE genes
  top_res_df <- bind_rows(top_up, top_down, roi_significant) %>%
    distinct(gene, .keep_all = TRUE)  # avoid duplicates
  
  # Set axis limits
  max <- max(res_df$log2FoldChange, na.rm = TRUE)
  min <- min(res_df$log2FoldChange, na.rm = TRUE)
  
  # Volcano plot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype, ", Treatment 30"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, ", Cells = ", Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(min, max) +
    geom_text_repel(data = top_res_df, aes(label = gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  # top_res_df <- bind_rows(top_up, top_down)
  # 
  # max <- max(res_df$log2FoldChange)
  # # max <- 3.1
  # min <- min(res_df$log2FoldChange)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 15"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_res_df, aes(label = gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_res_df, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  
  # png(fs::path(dir.results, paste0("Plot_Pseudobulk_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
  #     width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  # dev.off()
}
# full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_aTAL_cells_diabetes_unadjusted_2000.csv")) %>%
res_df <- res_df %>% 
  # clean_names() %>% 
  # dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log2FoldChange)

# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(res_df$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(res_df$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(res_df$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- res_df$LogFC
names(rankings_PT) <- res_df$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = paste0(celltype," Top 30 REACTOME, Treatment 15"), xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = paste0(celltype," Top 30 GO, Treatment 15"), xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,paste0("Pathways_Organoid_",celltype,"_top30_treatment15.jpeg")),
       width = 15, height = 20, scale = 1)

# }
```

###iv. DESeq2
#### a. 15 Glucose
```{r}
#15 glucose
so_subset <- subset(sc_org,treatment=="15")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  # nrow(so_celltype) #9196 genes
  # ncol(so_celltype) #2127 cells
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  ###
  # meta_hvg <- so_celltype@meta.data
  # pred = model.matrix(~group, data = meta_hvg)
  # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  
  #Make sure exposure/independent/x variable or group variable is a factor variable
  so_celltype$group <- factor(so_celltype$group)
  #Make sure to set reference level
  so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  
  # so_celltype$treatment <- factor(so_celltype$treatment)
  
  # counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  
  #Find markers
  # Set identities to the 'group' column
  Idents(so_celltype) <- "group"
  markers <- FindMarkers(
    object = so_celltype,
    ident.1 = "Type 2 Diabetes",
    ident.2 = "Lean Control",  # optional: if omitted, compared to all other cells
    # group.by = "group",  # optional
    min.pct = 0,      # only test genes expressed in >10% of cells
    logfc.threshold = 0  # only return genes with log2FC > 0.25
  )
  
  markers$input <- rownames(markers)
  markers <- tidylog::left_join(markers,gene_annotations,by="input")
  
  # ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj))) +
  #   geom_point(aes(color = p_val_adj < 0.05 & abs(avg_log2FC) > 0.25), alpha = 0.6) +
  #   scale_color_manual(values = c("grey", "red")) +
  #   theme_minimal() +
  #   labs(
  #     title = "Volcano Plot: T2D vs Lean Control",
  #     x = "Log2 Fold Change",
  #     y = "-log10 Adjusted p-value"
  #   ) +
  #   theme(legend.position = "none")
  
  
  # markers <- markers %>%
  #   mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment30`,method="fdr"))
  # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  # markers$PValue10 <- -log10(pmax(markers$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # markers$PValue10_int <- -log10(pmax(markers$`p_groupType 2 Diabetes:treatment30`, 1e-10))  # Avoid log(0)
  
  write.csv(markers,fs::path(dir.results,paste0("Organoid_FindMarkers_",celltype,"_diabetes_lc_treatment15_adj_2000.csv")))
  
  markers$color <- ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC > 0, "#990000",
                          ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC < 0, "#003366", "gray"))
  # markers$color_int <- ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- markers[markers$p_val_adj < 0.05, ]
  # significant_df_int <- markers[markers$fdr_int < 0.05, ]
  
  Genes <- length(unique(markers$Gene))
  Cells <- ncol(so_celltype)
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # markers$color3 <- ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- markers[markers$fdr3 < 0.2, ]
  
  top_up <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC > 0) %>%
    arrange(p_val_adj, desc(avg_log2FC)) %>%
    head(10)
  
  top_down <- markers %>%
    filter(p_val_adj < 0.05, avg_log2FC < 0) %>%
    arrange(p_val_adj, avg_log2FC) %>%
    head(10)
  
  top_markers <- bind_rows(top_up, top_down)
  
  max <- max(markers$avg_log2FC)
  # max <- 3.1
  min <- min(markers$avg_log2FC)
  
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 15"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    # ylim(0,11)+
    # # Add labels for significant points
    # geom_text(data = significant_df, aes(label = Gene),
    #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    # Add labels for significant points with ggrepel
    geom_text_repel(data = top_markers, aes(label = Gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  # geom_text_repel(data = top_markers, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  
  
  
  png(fs::path(dir.results, paste0("Plot_Organoid_FindMarkers_",celltype,"_Diabetes_lc_2000_treatment_15.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
}
```

#### b. 30 Glucose
```{r}
#30 glucose
so_subset <- subset(sc_org,treatment=="30")
#Filter to celltype of interest
celltypes <- unique(so_subset$`ScType-Kidney-human`)
for (celltype in celltypes) {
  so_celltype <- subset(so_subset,`ScType-Kidney-human`==celltype)
  DefaultAssay(so_celltype) <- "RNA" 
  
  ## Select Highly Variable Genes (HVGs)
  so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  # # Subset Seurat object to only HVGs
  so_celltype <- subset(so_celltype, features = hvgs)
  DefaultAssay(so_celltype) <- "RNA"
  
  
  # library(Matrix)
  # library(dplyr)
  
  # Add a unique pseudobulk ID: e.g. donor_group or sample_type_group
  so_celltype$sample_id <- paste0(so_celltype$record_id, "_", so_celltype$group)
  
  # Get raw counts
  # counts <- GetAssayData(so_celltype, slot = "counts")
  counts <- round(GetAssayData(so_celltype, layer = "counts")) 
  
  # Create named list of cells by sample
  cell_groups <- split(colnames(so_celltype), so_celltype$sample_id)
  
  # Pseudobulk: sum counts for each gene across cells in each sample_id
  pseudobulk_counts <- sapply(cell_groups, function(cells) {
    Matrix::rowSums(counts[, cells, drop = FALSE])
  })
  
  # Convert to matrix (genes x pseudobulk samples)
  pseudobulk_counts <- as.matrix(pseudobulk_counts)
  
  
  
  # Get raw counts (RNA assay assumed)
  # counts <- GetAssayData(so_celltype, slot = "counts")
  # counts <- round(GetAssayData(so_celltype, layer = "counts")) 
  
  # Set identities if not already set
  so_celltype$group <- str_replace_all(so_celltype$group," ","_")
  so_celltype$group <- factor(so_celltype$group)
  Idents(so_celltype) <- "group"
  
  # Metadata must match column names of count matrix
  metadata <- so_celltype@meta.data
  
  dds <- DESeqDataSetFromMatrix(
    countData = counts,
    colData = metadata,
    design = ~ group  # or ~ your_variable
  )
  
  dds <- DESeq(dds)
  # dds <- DESeq(dds, fitType = "mean")
  # dds <- DESeq(dds, fitType = "local")
  
  
  # Compare B vs A (reference level is A)
  res <- results(dds, contrast = c("group", "Type_2_Diabetes", "Lean_Control"))
  
  # Order by adjusted p-value
  res <- res[order(res$padj), ]
  
  resLFC <- lfcShrink(dds, coef = "group_Type_2_Diabetes_vs_Lean_Control", type = "apeglm")
  # Assume 'res' is your DESeq2 results object (e.g., from results(dds))
  res_df <- as.data.frame(res)
  
  # # Add gene names (row names into column)
  # res_df$gene <- rownames(res_df)
  res_df$input <- rownames(res_df)
  res_df <- tidylog::left_join(res_df,gene_annotations,by="input")
  
  write.csv(res_df,fs::path(dir.results,paste0("Organoid_DESeq2_",celltype,"_diabetes_lc_treatment30.csv")))
  
  res_df$color <- ifelse(res_df$padj < 0.05 & res_df$log2FoldChange > 0, "#990000",
                         ifelse(res_df$padj < 0.05 & res_df$log2FoldChange < 0, "#003366", "gray"))
  # res_df$color_int <- ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  #                              ifelse(res_df$fdr_int < 0.05 & res_df$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- res_df[res_df$padj < 0.05, ]
  # significant_df_int <- res_df[res_df$fdr_int < 0.05, ]
  
  Genes <- length(unique(res_df$Gene))
  Cells <- ncol(so_celltype)
  # Nonconvergence_Rate <- nebula_nonconverged_percent
  # res_df$color3 <- ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  #                               ifelse(res_df$fdr3 < 0.2 & res_df$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df3 <- res_df[res_df$fdr3 < 0.2, ]
  
  top_up <- res_df %>%
    filter(padj < 0.05, log2FoldChange > 0) %>%
    arrange(padj, desc(log2FoldChange)) %>%
    head(10)
  
  top_down <- res_df %>%
    filter(padj < 0.05, log2FoldChange < 0) %>%
    arrange(padj, log2FoldChange) %>%
    head(10)
  
  top_res_df <- bind_rows(top_up, top_down)
  
  max <- max(res_df$log2FoldChange)
  # max <- 3.1
  min <- min(res_df$log2FoldChange)
  
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = color)) +
    geom_point(alpha = 0.7) +  # Plot points with transparency
    scale_color_identity() +  # Use the color column directly
    theme_minimal() +  # Minimal theme
    labs(
      title = "Type 2 Diabetes vs. Lean Controls",
      subtitle = paste0(celltype,", Treatment 30 (DESeq2)"),
      x = "FC",
      y = "-log10(P-Value)",
      color = "Log2FC Direction Direction",
      caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    )+
    xlim(min,max)+
    # xlim(-3,3)+
    # ylim(0,11)+
    # # Add labels for significant points
    # geom_text(data = significant_df, aes(label = Gene),
    #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    # Add labels for significant points with ggrepel
    geom_text_repel(data = top_res_df, aes(label = Gene),
                    size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  # geom_text_repel(data = top_res_df, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  
  volcano_plot
  
  
  
  png(fs::path(dir.results, paste0("Plot_Organoid_DESeq2_",celltype,"_Diabetes_lc_2000_30.png")), 
      width = 2500, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  
  
  # # # Add significance label
  # # res_df <- res_df %>%
  # #   mutate(
  # #     sig = case_when(
  # #       padj < 0.05 & abs(log2FoldChange) > 1 ~ "Significant",
  # #       TRUE ~ "Not Significant"
  # #     )
  # #   )
  # 
  # # write.csv(as.data.frame(res), "deseq2_results.csv")
  # 
  # 
  # 
  # # dds <- DESeqDataSetFromMatrix(countData = cts,
  # #                               colData = coldata,
  # #                               design= ~ batch + condition)
  # # dds <- DESeq(dds)
  # # resultsNames(dds) # lists the coefficients
  # # res <- results(dds, name="condition_trt_vs_untrt")
  # # # or to shrink log fold changes association with condition:
  # # res <- lfcShrink(dds, coef="condition_trt_vs_untrt", type="apeglm")
  # # 
  # 
  # 
  # # nrow(so_celltype) #9196 genes
  # # ncol(so_celltype) #2127 cells
  # 
  # ## Select Highly Variable Genes (HVGs)
  # so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
  # hvgs <- VariableFeatures(so_celltype)
  # 
  # # # Subset Seurat object to only HVGs
  # so_celltype <- subset(so_celltype, features = hvgs)
  # DefaultAssay(so_celltype) <- "RNA"
  # 
  # ###
  # # meta_hvg <- so_celltype@meta.data
  # # pred = model.matrix(~group, data = meta_hvg)
  # # data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)
  # 
  # #Make sure exposure/independent/x variable or group variable is a factor variable
  # so_celltype$group <- factor(so_celltype$group)
  # #Make sure to set reference level
  # so_celltype$group <- relevel(so_celltype$group,ref="Lean Control")
  # 
  # # so_celltype$treatment <- factor(so_celltype$treatment)
  # 
  # # counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round
  # 
  # #Find markers
  # # Set identities to the 'group' column
  # Idents(so_celltype) <- "group"
  # markers <- FindMarkers(
  #   object = so_celltype,
  #   ident.1 = "Type 2 Diabetes",
  #   ident.2 = "Lean Control",  # optional: if omitted, compared to all other cells
  #   # group.by = "group",  # optional
  #   min.pct = 0,      # only test genes expressed in >10% of cells
  #   logfc.threshold = 0  # only return genes with log2FC > 0.25
  # )
  # 
  # markers$input <- rownames(markers)
  # markers <- tidylog::left_join(markers,gene_annotations,by="input")
  # 
  # # ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj))) +
  # #   geom_point(aes(color = p_val_adj < 0.05 & abs(avg_log2FC) > 0.25), alpha = 0.6) +
  # #   scale_color_manual(values = c("grey", "red")) +
  # #   theme_minimal() +
  # #   labs(
  # #     title = "Volcano Plot: T2D vs Lean Control",
  # #     x = "Log2 Fold Change",
  # #     y = "-log10 Adjusted p-value"
  # #   ) +
  # #   theme(legend.position = "none")
  # 
  # 
  # # markers <- markers %>%
  # #   mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
  #   # mutate(fdr_int=p.adjust(`p_groupType 2 Diabetes:treatment30`,method="fdr"))
  # # mutate(fdr3=p.adjust(PValue3,method="fdr"))
  # # markers$PValue10 <- -log10(pmax(markers$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)
  # # markers$PValue10_int <- -log10(pmax(markers$`p_groupType 2 Diabetes:treatment30`, 1e-10))  # Avoid log(0)
  # 
  # write.csv(markers,fs::path(dir.results,paste0("Organoid_FindMarkers_",celltype,"_diabetes_lc_treatment30_adj_2000.csv")))
  # 
  # markers$color <- ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC > 0, "#990000",
  #                              ifelse(markers$p_val_adj < 0.05 & markers$avg_log2FC < 0, "#003366", "gray"))
  # # markers$color_int <- ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` > 0, "#990000",
  # #                              ifelse(markers$fdr_int < 0.05 & markers$`logFC_groupType 2 Diabetes:treatment30` < 0, "#003366", "gray"))
  # 
  # # Identify significant points (fdr < 0.05)
  # significant_df <- markers[markers$p_val_adj < 0.05, ]
  # # significant_df_int <- markers[markers$fdr_int < 0.05, ]
  # 
  # Genes <- length(unique(markers$Gene))
  # Cells <- ncol(so_celltype)
  # # Nonconvergence_Rate <- nebula_nonconverged_percent
  # # markers$color3 <- ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 > 0, "lightcoral",
  # #                               ifelse(markers$fdr3 < 0.2 & markers$`logFC_groupType 2 Diabetes`3 < 0, "lightblue", "gray"))
  # # 
  # # # Identify significant points (fdr < 0.05)
  # # significant_df3 <- markers[markers$fdr3 < 0.2, ]
  # 
  # top_up <- markers %>%
  #   filter(p_val_adj < 0.05, avg_log2FC > 0) %>%
  #   arrange(p_val_adj, desc(avg_log2FC)) %>%
  #   head(10)
  # 
  # top_down <- markers %>%
  #   filter(p_val_adj < 0.05, avg_log2FC < 0) %>%
  #   arrange(p_val_adj, avg_log2FC) %>%
  #   head(10)
  # 
  # top_markers <- bind_rows(top_up, top_down)
  # 
  # max <- max(markers$avg_log2FC)
  # # max <- 3.1
  # min <- min(markers$avg_log2FC)
  # 
  # 
  # # Create the volcano plot using ggplot
  # volcano_plot <- ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
  #   geom_point(alpha = 0.7) +  # Plot points with transparency
  #   scale_color_identity() +  # Use the color column directly
  #   theme_minimal() +  # Minimal theme
  #   labs(
  #     title = "Type 2 Diabetes vs. Lean Controls",
  #     subtitle = paste0(celltype,", Treatment 30"),
  #     x = "FC",
  #     y = "-log10(P-Value)",
  #     color = "Log2FC Direction Direction",
  #     caption = paste0("FDR < 0.05, Genes = ",Genes,", Cells = ",Cells)
  #   ) +
  #   theme(
  #     plot.title = element_text(hjust = 0),
  #     axis.text.x = element_text(angle = 0, hjust = 1)
  #   )+
  #   xlim(min,max)+
  #   # xlim(-3,3)+
  #   # ylim(0,11)+
  #   # # Add labels for significant points
  #   # geom_text(data = significant_df, aes(label = Gene),
  #   #           vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  # # Add labels for significant points with ggrepel
  # geom_text_repel(data = top_markers, aes(label = Gene),
  #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = 20)
  #   # geom_text_repel(data = top_markers, aes(label = Gene),
  #   #                 size = 3, color = "black", box.padding = 0.5, max.overlaps = Inf)
  # 
  # volcano_plot
  # 
  # 
  # 
  # png(fs::path(dir.results, paste0("Plot_Organoid_FindMarkers_",celltype,"_Diabetes_lc_2000_30.png")), 
  #     width = 2500, height = 2100, res = 300)
  # print(volcano_plot)
  # dev.off()
}
```

### v. GSEA
```{r echo = F}
full_results <- read.csv(fs::path(dir.results,"Biopsy_NEBULA_PT_cells_diabetes_unadjusted_2000.csv")) %>%
  clean_names() %>% 
  dplyr::select(-x) %>% 
  dplyr::rename(Gene=gene,LogFC=log_fc_group_type_2_diabetes)

# Filter out the gmt files for KEGG, Reactome and GOBP
# list.files(bg_path)
# gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
# gmt_files
# kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
# reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
# go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)
# 
# # rank genes by t-stats in DiD
# rankings_PT <- full_results$LogFC
# names(rankings_PT) <- full_results$Gene
# rankings_PT <- sort(rankings_PT, decreasing = TRUE)
# plot(rankings_PT)
# min(rankings_PT)
# max(rankings_PT)
# 
# 
# set.seed(1234)
# 
# kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
#                             stats = rankings_PT,
#                             scoreType = 'std', 
#                             minSize = 3,
#                             maxSize = 500,
#                             nproc = 1)
# 
# reactome_res_PT <- fgsea(pathways = reactome,
#                          stats = rankings_PT,
#                          scoreType = 'std', 
#                          minSize = 3,
#                          maxSize = 500,
#                          nproc = 1)
# go_res_PT <- fgsea(pathways = go,
#                    stats = rankings_PT,
#                    scoreType = 'std', 
#                    minSize = 5,
#                    maxSize = 500,
#                    nproc = 1)
# 
# PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
#                        "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
#                        "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
# rownames(PT_fgsea) <- c("adj.pval", "p.val")
# 
# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)",xlimit = 4, xnudge = 0.03)+ theme(legend.position.inside = c(0.2, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
# #        width = 13, height = 10, scale = 1)
# 
# ##### REACTOME
# b <- plot_fgsea_transpose(reactome_res_PT, title = "PT Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position.inside = c(0.15, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
# #        width = 13, height = 10, scale = 1)
# ##### GO
# c <- plot_fgsea_transpose(go_res_PT, title = "PT Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position.inside = c(0.1, 0.5))
# 
# # ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
# #        width = 13, height = 10, scale = 1)
# 
# combined_plot <- b + c + plot_layout(ncol = 1)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 15, height = 20, scale = 1)
# Filter out the gmt files for KEGG, Reactome and GOBP
list.files(bg_path)
gmt_files <- list.files(path = bg_path, pattern = '.gmt', full.names = TRUE)
gmt_files
kegg_legacy <- prepare_gmt(gmt_files[1], unique(full_results$Gene), savefile = FALSE)
reactome <- prepare_gmt(gmt_files[3], unique(full_results$Gene), savefile = FALSE)
go <- prepare_gmt(gmt_files[4], unique(full_results$Gene), savefile = FALSE)

# rank genes by t-stats in DiD
rankings_PT <- full_results$LogFC
names(rankings_PT) <- full_results$Gene
rankings_PT <- sort(rankings_PT, decreasing = TRUE)
plot(rankings_PT)
min(rankings_PT)
max(rankings_PT)

set.seed(1234)

kegg_legacy_res_PT <- fgsea(pathways = kegg_legacy,
                            stats = rankings_PT,
                            scoreType = 'std', 
                            minSize = 3,
                            maxSize = 500,
                            nproc = 1)

reactome_res_PT <- fgsea(pathways = reactome,
                         stats = rankings_PT,
                         scoreType = 'std', 
                         minSize = 3,
                         maxSize = 500,
                         nproc = 1)
go_res_PT <- fgsea(pathways = go,
                   stats = rankings_PT,
                   scoreType = 'std', 
                   minSize = 5,
                   maxSize = 500,
                   nproc = 1)

PT_fgsea <- data.frame("KEGG Legacy"=c(sum(kegg_legacy_res_PT[, padj < 0.05]), sum(kegg_legacy_res_PT[, pval < 0.05])),
                       "REACTOME"=c(sum(reactome_res_PT[, padj < 0.05]), sum(reactome_res_PT[, pval < 0.05])),
                       "GO"=c(sum(go_res_PT[, padj < 0.05]), sum(go_res_PT[, pval < 0.05])))
rownames(PT_fgsea) <- c("adj.pval", "p.val")
PT_fgsea

# ##### KEGG Legacy
# a <- plot_fgsea_transpose(kegg_legacy_res_PT, title = "PT Unadjusted Top 30 KEGG (REML, Log Normal, Offset)", xnudge = 0.03)+ theme(legend.position = c(0.2, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_kegg_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)

##### REACTOME
b <- plot_fgsea_transpose(reactome_res_PT, title = "PT Unadjusted Top 30 REACTOME (REML, Log Normal, Offset)", xlimit = 5) + theme(legend.position = c(0.15, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_reactome_pathways_unadjusted.jpeg"),
#        width = 13, height = 10, scale = 1)
##### GO
c <- plot_fgsea_transpose(go_res_PT, title = "PT Unadjusted Top 30 GO (REML, Log Normal, Offset)", xlimit = 8)+ theme(legend.position = c(0.1, 0.5))

# ggsave(fs::path(dir.results,"PT_top30_go_pathways_unadjusted_reml_offset.jpeg"),
#        width = 13, height = 10, scale = 1)

# combined_plot <- b + c + plot_layout(ncol = 3)
# print(combined_plot)
# ggsave(fs::path(dir.results,"PT_top30_pathways_unadjusted.jpeg"),
#        width = 40, height = 10, scale = 1)
combined_plot <- b + c + plot_layout(ncol = 1)
print(combined_plot)
ggsave(fs::path(dir.results,"Biopsy_PT_top30_pathways_unadjusted.jpeg"),
       width = 15, height = 20, scale = 1)
```

### iii. Targeted Gene
```{r}
#GENES: ROBO4 and FN1
target_genes <- c("ROBO4","FN1")
so_celltype <- subset(sc_org,celltype2=="PT")
DefaultAssay(so_celltype) <- "RNA" 

nrow(so_celltype) #9196 genes
ncol(so_celltype) #2127 cells

# ## Select Highly Variable Genes (HVGs)
# so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
# hvgs <- VariableFeatures(so_celltype)

# # Subset Seurat object to only HVGs
# so_celltype_hvg <- subset(so_celltype, features = hvgs)
# DefaultAssay(so_celltype_hvg) <- "RNA" 

###
# meta_hvg <- so_celltype@meta.data
# pred = model.matrix(~group, data = meta_hvg)
# data_g_hvg = list(count=counts_hvg, id=meta_hvg$kit_id, pred=pred)

#Make sure exposure/independent/x variable or group variable is a factor variable
so_celltype$group <- factor(so_celltype$group)
#Make sure to set reference level
so_celltype$group <- relevel(so_celltype$group,ref="Lean_Control")

counts_hvg <- round(GetAssayData(so_celltype, layer = "counts")) # load counts and round

# offset_hvg = Matrix::colSums(data_g_hvg$count) 

# With parallelization
# List of genes
# genes_list <- rownames(counts_hvg)
genes_list <- target_genes

cl <- makeCluster(2)
registerDoParallel(cl)

start_time <- Sys.time()
nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype,features=g)@meta.data
    pred_gene <- model.matrix(~group, data = meta_gene)
    # library <- meta_gene$library_size
    library <- meta_gene$pooled_offset
    data_g_gene <- group_cell(count = count_gene, id = meta_gene$kit_id, pred = pred_gene,offset=library)
    
    if (is.null(data_g_gene)) {
      data_g_gene <- list(count = count_gene, id = meta_gene$kit_id, pred = pred_gene, offset = library)
    }
    
    #With offset
    result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset=data_g_gene$offset)
    
    list(gene = g, result = result)  # return both gene name and result
    
  }, error = function(e) {
    NULL
  })
}

stopCluster(cl)
end_time <- Sys.time()
print(end_time - start_time)

# set the names of results based on gene names
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results

PT_nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name,
                     Convergence_Code = converged)
    return(df)
  }
)

nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)
nonconverge_genes <- unique(PT_nebula_converged$Gene[which(PT_nebula_converged$Convergence_Code==-40)]) 

#Make dataframe of final results
full_results <- as.data.frame(nebula_summaries)
#Calculate number of genes filtered out for low expression 
low_exp <- length(genes_list)-length(full_results$gene)
#Filter out non-converging genes
full_results <- full_results %>% 
  filter(!gene %in%  nonconverge_genes)
#Calculate nonconvergence rate
nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
# nebula_nonconverged_percent <- (length(rownames(counts_hvg))-length(unique(full_results$gene)))/length(rownames(counts_hvg))
# print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
full_results <- full_results %>%
  mutate(fdr=p.adjust(`p_groupType 2 Diabetes`,method="fdr"))  
# mutate(fdr3=p.adjust(PValue3,method="fdr"))
full_results$PValue10 <- -log10(pmax(full_results$`p_groupType 2 Diabetes`, 1e-10))  # Avoid log(0)




```
