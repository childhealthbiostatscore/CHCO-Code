---
title: "Kidney scRNAseq"
author: Hailey Hampson
output: html_document
date: "2025-01-25"
---
# 1. Set up Libraries & Directores
```{r, include=F}
library(reprex)
library(tidyverse)
library(BiocManager)        
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(future)
library(colorspace)
library(patchwork)
library(ggdendro)
library(cowplot)
library(ggpubr)
library(venn)
library(rstatix)
library(table1)
library(Biobase)
library(ReactomeGSA)
library(GSEABase)
library(msigdbr)
library(kableExtra)
library(knitr)
library(SingleCellExperiment)
library(fgsea)
library(EnhancedVolcano)
library(openxlsx)
library(BiocManager)
library(MAST)
library(ggrepel)
# library(qpcR)
library(ggpubr)
library(openxlsx)
library(ggplot2)
library(GGally)
library(GSEABase)
library(limma)
library(reshape2)
library(data.table)
library(knitr)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(stringr)
library(NMF)
library(rsvd)
library(RColorBrewer)
library(MAST)
library(devtools)
# install_github("Sun-lab/ideas",force=T)
#library(ideas)
library(foreach)
library(doRNG)
library(doParallel)
library(fs)
registerDoParallel(cores = 6)
library(VennDiagram)
library(janitor)


#Local file path
#dir.dat <- c("/Volumes/Peds Endo/Petter Bjornstad")
#dir.dat2 <- c("/Volumes/Peds Endo/Petter Bjornstad/scRNA/data_clean")
#dir.code <- c("/Users/hhampson/Documents/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
#dir.results <- c("/Volumes/Peds Endo/Petter Bjornstad/Kidney Project/Results")

#Lambda file path
dir.dat <- c("/run/user/1026/gvfs/smb-share:server=ucdenver.pvt,share=som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad")
dir.code <- c("/home/Github_Repo/CHCO-Code/Petter Bjornstad/Kidney scRNA/Kidney scRNA")
dir.results <- c(fs::path(dir.dat,"Kidney Project/Results"))

#Load functions
source("Kidney_functions_sc.R")

```

# 2. Load Full Data & Clean: scRNA & MetaData
## a. Format Data
```{r, include=F}
#Local
# dir.dat <- c("/Users/hhampson/Dropbox/Bjornstad data")
# so_kidney_sc <- readRDS(fs::path(dir.dat,"Kidney scRNA","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
# load("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/Data Exports/PB90_clinical_metadata.RData")
# so_kidney_sc <- AddMetaData(so_kidney_sc, so_meta_combined)
# rm(so_meta_combined)
# gc()

#Lambda
so_kidney_sc <- readRDS(fs::path(dir.dat,"scRNA","data_raw","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="KI-0014643")] <- "KL-0014643"
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="kl-0023998")] <- "KL-0023998"
#check2 <- so_kidney_sc@meta.data

#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv")) #small meta set
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata.csv")) #all metadata vars
#"KL-0014634" "KL-0014629" "KL-0014628" coenrolled IDs
#"KL-0014634" "KL-0014629" "KL-0014628" having missing meta data 

#KL-0014628: IT_10/RH-66-T KL-0014628 KL-0019101
#KL-0014629: IT_09/RH-65-T
#KL-0014634: IT_07/RH-59-T
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group")))

#Partipant 30051 (kit id KL-0027474 at 4m has sc, but at baseline no sc has kit id KL-0027474 metadata)
#missing <- c("KL-0014628", "KL-0014629", "KL-0014634", "KL-0019059", "KL-0019092", "KL-0019101", "KL-0022159", "KL-0024005", "KL-0027470", #"KL-0027478")
#Check these ids in metadat
#check <- harm_meta_data %>%
  #filter(kit_id %in% missing)

#IDs missing group information  
#Filter out attempt participants
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)
#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
  #mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                            sglt2 == "Yes" ~ "sglt2",
                            glp1 == "Yes" ~ "glp1",
                            no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
gc()
meta_kidney_sc <-  so_kidney_sc@meta.data 
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
meta_kidney_sc <- meta_kidney_sc %>%
  #dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(harm_meta_data,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
#Check to see if all ids still have metadata
#check4 <- meta_kidney_sc %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check4 <- check4 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))

#rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
ids <- harm_meta_data$kit_id
#Filter seurat object to only IDs that have the metadata (83 individuals of interest)
so_kidney_sc <- AddMetaData(so_kidney_sc, meta_kidney_sc)
#check5 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check5 <- check5 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))
so_kidney_sc <- subset(so_kidney_sc, kit_id %in% ids)
#check6 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check6 <- check6 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))
#unique(so_kidney_sc$group)
#unique(so_kidney_sc$group2)
rm(meta_kidney_sc,harm_meta_data)

#Switch default assay in seurat object to RNA
DefaultAssay(so_kidney_sc) <- "RNA"
gc()

check3 <- so_kidney_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","group2","medication")))
#saveRDS(so_kidney_sc,fs::path(dir.dat,"scRNA","data_clean","Formatted_so_kidney_sc_01_26_25.rds"))
#Create senesence so in all cell types
#sens_genes <- c(sens_genes,"CDKN1A")
#sens_gene_in_data <- intersect(sens_genes, rownames(so_kidney_sc))
# Subset the Seurat object to include only genes in sens_gene_in_data
#so_sens_all <- subset(so_kidney_sc, features = sens_gene_in_data)
#rm(so_kidney_sc)
# # saveRDS(so_sens_all,fs::path(dir.dat,"so_sens_genes_all_cells_KIDNEY.RDS"))
# # rm(so_sens_all)
# # 
# # #Load sens all cells
# # so_sens <- readRDS(fs::path(dir.dat,"so_sens_genes_all_cells_KIDNEY.RDS"))
# # dat <- so_sens@meta.data
# # so_diab <- subset(so_sens, diagnosis_of_diabetes == "Yes")
# # 
# #PT Cells
# so_sens_all@meta.data$PT <- ifelse(grepl("PT-",so_sens_all@meta.data$celltype_rpca),"PT","Non-PT")
# Idents(so_sens_all) <- so_sens_all$PT
# so_sens <- subset(so_sens_all, PT=="PT")
# # saveRDS(so_sens,fs::path(dir.dat,"so_sens_genes_PT_Cells_KIDNEY.RDS"))
# rm(so_sens_all,so_sens)
# so_sens_PT <- readRDS(fs::path(dir.dat,"Liver Project","so_sens_genes_PT_Cells_KIDNEY.RDS"))
# so_sens_PT@meta.data$group1 <- ifelse(so_sens_PT@meta.data$group=="Type 2 Diabetes" | so_sens_PT@meta.data$group=="Lean Control" ,"Yes","No")
# so_sens_PT1 <- subset(so_sens_PT, group1=="Yes")
# so_sens_PT@meta.data$group2 <- ifelse(so_sens_PT@meta.data$group=="Type 2 Diabetes","Yes","No")
# so_sens_PT2 <- subset(so_sens_PT, group2=="Yes")
# so_sens_PT3 <- subset(so_sens_PT, group=="Type 2 Diabetes")
# 
# 
# 
# #TAL Cells
# so_sens_all@meta.data$TAL <- ifelse(grepl("TAL",so_sens_all@meta.data$celltype_rpca),"TAL","Non-TAL")
# Idents(so_sens_all) <- so_sens_all$TAL
# so_sens <- subset(so_sens_all, TAL=="TAL")
# # saveRDS(so_sens,fs::path(dir.dat,"so_sens_genes_TAL_Cells_KIDNEY.RDS"))
# rm(so_sens_all,so_sens,so_sens_TAL,so_sens_TAL1)
# so_sens_TAL <- readRDS(fs::path(dir.dat,"Liver Project","so_sens_genes_TAL_Cells_KIDNEY.RDS"))
# so_sens_TAL@meta.data$group1 <- ifelse(so_sens_TAL@meta.data$group=="Type 2 Diabetes"| so_sens_TAL@meta.data$group=="Lean Control","Yes","No")
# so_sens_TAL1 <- subset(so_sens_TAL, group1=="Yes")
# so_sens_TAL@meta.data$group2 <- ifelse(so_sens_TAL@meta.data$group=="Type 2 Diabetes","Yes","No")
# so_sens_TAL2 <- subset(so_sens_TAL, group2=="Yes")
# so_sens_TAL3 <- subset(so_sens_TAL, group=="Type 2 Diabetes")
```
## b. Load Formatted Data
```{r}
#Load formatted So
so_kidney_sc <- readRDS(fs::path(dir.dat,"scRNA","data_clean","Formatted_so_kidney_sc_01_26_25.rds"))

#Ensure default assay in seurat object is RNA
DefaultAssay(so_kidney_sc) <- "RNA"
gc()
```

# 3. Outline 
### a. Comparison Groups of Interest
1. T2D vs. OB
2. T2D vs. T1D
3. T2D vs. LC
4. T2D/OB vs. LC
5. T2D/OB vs. T1D

### b. Disease Categories of Interest
1. Albuminuria (Y/N) - UACR >= 30 mg/g
  a. T2D
  b. T2D/OB
2. UACR >= 100mg/g
3. UACR >= 300mg/g

### c. Medication Groups of Interest 
1. SLGT2i+/GLP-1ra+
2. SGLT2i-/GLP-1ra+
3. SGLT2i+/GLP-1ra-
4. SGLT2i-/GLP-1ra-

### d. Additional Medications of Interest  
Metformin, Insulin, ACEi/ARB

### e. Characteristics of Interest
UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV

### f. Gene Sets of Interest
1. All Genes 
2. Senescence 
3. Metabolism
4. Inflammation

### g. Analysis Plan
1. All Genes
  a. DEGS + GSEA + IPA
  b. MAST + GSEA + IPA
  c. Pseuodbulk all cell types
  d. Cell Specific (PT, TAL, EC, etc.)
2. Pathway Gene Sets
  a. DEGS
  b. MAST
  c. Pseudobulk all cell types
  d. Cell Specific (PT, TAL, EC, etc. )

# 3. Descriptive Statistics
```{r, echo = F,warning=F}
#Load metadata for descriptive stats
#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv"))
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata.csv")) #all metadata vars
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)

#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
  #mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                            sglt2 == "Yes" ~ "sglt2",
                            glp1 == "Yes" ~ "glp1",
                            no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","group","group2")))

#Number of Individuals Per Study 
harm_summary1 <- harm_meta_data %>%
  group_by(study) %>%
  summarize(n=n())

#Number of Individuals Per Disease Group
harm_summary2 <- harm_meta_data %>%
  group_by(group) %>%
  summarize(n=n())

#Number of Individuals Per Medication Group
harm_summary3 <- harm_meta_data %>%
  group_by(medication) %>%
  summarize(n=n())

#Number of Individuals per med group & disease group
harm_summary4 <- harm_meta_data %>%
  group_by(group,medication) %>%
  summarize(n=n())

#Note: 83 participants have sc and metadata
#Covars of interest: 
#UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
dat <- harm_meta_data
label(dat$age)      <- "Age (y)"
label(dat$sex)      <- "Sex"
label(dat$hba1c) <- "HbA1c (%)"
dat$medication <- case_when(dat$medication=="no_med"~"No Medication",
                            dat$medication=="sglt2"~"Exclusive SLGT2i",
                            dat$medication=="glp1"~"Exclusive GLP-1ra",
                            dat$medication=="glp1_sglt2"~"GLP-1ra + SGLT2i")
#dat$medication <- factor(dat$medication)
label(dat$medication) <- "Medication Status"
label(dat$ace_inhibitor) <- "ACE Inhibitor (Yes vs. No)"
label(dat$angiotensin_receptor_blocker) <- "Angiotensin Receptor Blocker (Yes vs. No)"
label(dat$sbp) <- "Systolic Blood Pressure (mmHg)"
label(dat$dbp) <- "Diastolic Blood Pressure (mmHg)"
label(dat$map) <- "Mean Arterial Pressure (mmHg)"
label(dat$erpf_raw_plasma) <- "Estimated Renal Plasma Flow (mL/min)"
label(dat$bmi) <- "Body Mass Index (kg/m²)"
label(dat$dexa_fat_kg) <- "DEXA Fat Mass (kg)" 
label(dat$dexa_lean_kg) <- "DEXA Lean Mass (kg)"
label(dat$total_kidney_volume_ml) <- "Total Kidney Volume (mL)"
label(dat$ht_adj_tkv) <- "Height-Adjusted Total Kidney Volume (mL/m)"
label(dat$gfr_raw_plasma) <- "Glomerular Filtration Rate (mL/min)"
label(dat$eGFR_CKD_epi) <- "Estimated Glomerular Filtration Rate (mL/min/1.73 m²)"
label(dat$race_ethnicity)    <- "Race/Ethnicity"
label(dat$triglycerides) <-  "Triglycerides (mg/dL)"
label(dat$group) <- "Disease Status"
label(dat$group2) <- "Disease Status"
#race_ethnicity
#Table 1. Descriptive Statistics by Disease Status ----
table1(~ age + sex + bmi + map + group + medication | study, data=dat,overall=F)
table1(~ age + sex + bmi + dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides + gfr_raw_plasma + eGFR_CKD_epi + 
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+
         + group + medication | study, data=dat, overall=F)
table1(~ age + sex + bmi + dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides + gfr_raw_plasma + eGFR_CKD_epi + 
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+
         + group + medication | study, data=dat, overall=F)
#Table 1. Descriptive Statistics by Disease Status with T2D and OB Combined ----
table1(~ age + sex + bmi + dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides + gfr_raw_plasma + eGFR_CKD_epi + 
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+
         + medication | group2, data=dat)

#Compare meds and groups
table1(~ medication + insulin_injections_timepoint +insulin_med_timepoint+ ace_inhibitor+angiotensin_receptor_blocker |group,data=dat,overall=F)
table1(~ medication + insulin_injections_timepoint+insulin_med_timepoint+ ace_inhibitor +angiotensin_receptor_blocker  |group2,data=dat,overall=F)
#INSULIN???
```

# 4. Analysis
## A. All Genes
### i. DEGS + GSEA + IPA
#### a. Pseuodbulk all cell types
```{r,echo=F,warning=F}
#Select full gene set
all_genes <- rownames(so_kidney_sc)
#Disease Groups
#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="Yes",top_gsea = 30)

#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="Yes",top_gsea = 30)

#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="Yes",top_gsea = 30)

#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="Yes",top_gsea = 30)

#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="Yes",top_gsea = 30)

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="Yes",top_gsea = 30)
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="Yes",top_gsea = 30)


#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="Yes",top_gsea = 30)

#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="Yes",top_gsea = 30)

#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="Yes",top_gsea = 30)

#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="Yes",top_gsea = 30)


#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="Yes",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="Yes",top_gsea = 30)

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="Yes",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="Yes",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="Yes",top_gsea = 30)


#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="Yes",top_gsea = 30)

#4. SGLT2i-/GLP-1ra-



#Other med groups
#Ace inhibitors - type 2s only
#Insulin injection - type 1s only
#insulin meds - type 1s all on insulin meds, type 2s 
```

#### b. Cell Specific (PT, TAL, EC, etc.)
```{r,echo=F,warning=F}

so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="Yes",top_gsea = 30)
}
#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="Yes",top_gsea = 30)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="Yes",top_gsea = 30)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="Yes",top_gsea = 30)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2 
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="Yes",top_gsea = 30)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="Yes",top_gsea = 30)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="Yes",top_gsea = 30)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
all_cell_types2 <- all_cell_types[-29]
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="Yes",top_gsea = 30)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="Yes",top_gsea = 30)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="Yes",top_gsea = 30)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="Yes",top_gsea = 30)
}

#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
all_cell_types2 <- all_cell_types[-29]

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="Yes",top_gsea = 30)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="Yes",top_gsea = 30)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="Yes",top_gsea = 30)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="Yes",top_gsea = 30)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types2) {
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="Yes",top_gsea = 30)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="Yes",top_gsea = 30)

```

### ii. MAST + GSEA + IPA
```{r}
#1. Albuminuria (Y/N) - UACR >= 30 mg/g
#  a. T2D
#  b. T2D/OB
#2. UACR >= 100mg/g
#3. UACR >= 300mg/g
#UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
```


## B. Pathway Gene Sets
  a. DEGS
  b. MAST
  c. Pseudobulk all cell types
  d. Cell Specific (PT, TAL, EC, etc. )












