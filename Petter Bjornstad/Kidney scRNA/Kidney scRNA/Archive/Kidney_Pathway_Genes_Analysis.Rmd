---
title: "Kidney Pathway Genes Analysis"
author: "Hailey Hampson"
date: "2025-02-06"
output: word_document
---


# Pathway Gene Sets
## 1. Senescence
### i. DEGS + IPA
#### a. Pseuodbulk all cell types
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#Define Gene Set
sens_genes <- c("ACVR1B","ANG","ANGPT1","ANGPTL4","AREG","AXL","BEX3","BMP2","BMP6","C3","CCL1","CCL13",
                "CCL16","CCL2","CCL20","CCL24","CCL26","CCL3","CCL4","CCL5","CCL7","CCL8","CD55",
                "CD9","CSF1","CSF2","CSF2RB","CST4","CTNNB1","CTSB","CXCL1","CXCL10","CXCL12",
                "CXCL16","CXCL2","CXCL3","CXCL8","CXCR2","DKK1","EDN1","EGF","EGFR","EREG","ESM1",
                "ETS2","FAS","FGF1","FGF2","FGF7","GDF15","GEM","GMFG","HGF","HMGB1","ICAM1","ICAM3",
                "IGF1","IGFBP1","IGFBP2","IGFBP3","IGFBP4","IGFBP5","IGFBP6","IGFBP7","IL10","IL13",
                "IL15","IL18","IL1A","IL1B","IL2","IL32","IL6","IL6ST","IL7","INHA","IQGAP2","ITGA2",
                "ITPKA","JUN","KITLG","LCP1","MIF","MMP1","MMP10","MMP12","MMP13","MMP14","MMP2",
                "MMP3","MMP9","NAP1L4","NRG1","PAPPA","PECAM1","PGF","PIGF","PLAT","PLAU","PLAUR",
                "PTBP1","PTGER2","PTGES","RPS6KA5","SCAMP4","SELPLG","SEMA3F","SERPINB4","SERPINE1",
                "SERPINE2","SPP1","SPX","TIMP2","TNF","TNFRSF10C","TNFRSF11B","TNFRSF1A","TNFRSF1B",
                "TUBGCP2","VEGFA","VEGFC","VGF","WNT16","WNT2")
sens_genes <- c(sens_genes,"CDKN1A")

#Select full gene set
all_genes <- sens_genes
#Disease Groups
#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# ncol(so_subgroup) #
# nrow(so_subgroup) #
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)


#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)


#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)

#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)


#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)


#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#4. SGLT2i-/GLP-1ra-

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
#
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Metformin - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)

```

#### b. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#Pseuodbulk Tall and PT cells
so_kidney_sc$cell_type2 <- ifelse(grepl("PT-",so_kidney_sc$celltype_rpca),"PT",
                                  ifelse(grepl("TAL-",so_kidney_sc$celltype_rpca),"TAL",NA))
so_kidney_sc$cell_type2 <- as.character(so_kidney_sc$cell_type2)
all_cell_types <- unique(so_kidney_sc$cell_type2)
all_cell_types <- all_cell_types[-1]
Idents(so_kidney_sc) <- so_kidney_sc$cell_type2

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
all_genes <- rownames(so_subgroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}
#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#T2D + OB
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}


# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### c. KPMP Cell Type 1 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}

so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}

#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
all_cell_types2 <- all_cell_types[-29]
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### d. KPMP Cell Type 2 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#
# so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
# all_cell_types <- unique(so_kidney_sc$celltype_rpca)
# Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
# all_cell_types <- all_cell_types[-29]
# #Select full gene set
# all_genes <- rownames(so_kidney_sc)
#
# #1. T2D vs. OB
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# #Diabetes yes vs. no
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
# }
# #2. T2D vs. T1D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
# #3. T2D vs. LC
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #4. T2D/OB vs. LC
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #5. T2D/OB vs. T1D
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
#
# #1. Albuminuria (Y/N) - UACR >= 30 mg/g
# so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
#
# #2. UACR >= 100mg/g
# so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# all_cell_types2 <- all_cell_types[-29]
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #3. UACR >= 300mg/g
# so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
#
# #Medications (AMong T2D + OB)
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```


### ii. MAST + IPA
####a. All Cells
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
  print(mast)
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#"acr_u"
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
  print(mast)
}
```

####d. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
    mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
   mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
   print(mast)
  }
}
```

####c. KPMP Cells Old
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```

####d. KPMP Cells New
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```
## 2. Metabolism 
### i. DEGS + IPA
#### a. Pseuodbulk all cell types
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#Select full gene set
#Metabolism Pathway Gene Sets
tca <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","tca_cycle_pathway.csv")) %>%
  pull(genesymbol)
gluco <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","gluconeogenesis_pathway.csv"))%>%
  pull(genesymbol)
glyc <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","glycolysis_pathway.csv"))%>%
  pull(genesymbol)
beta_ox <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","beta_oxidation_pathway.csv"))%>%
  pull(genesymbol)
ox_phos <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","ox_phos_pathway.csv"))%>%
  pull(genesymbol)
lipid_met <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","lipid_metabolism.csv"))%>%
  pull(genesymbol)
energy_met <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","energy_metabolism_pathway.csv"))%>%
  pull(genesymbol)
met <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","metabolism_pathway.csv"))%>%
  pull(genesymbol)

all_genes 

#Disease Groups
#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# ncol(so_subgroup) #84,937 cells
# nrow(so_subgroup) #31332 genes
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)


#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)


#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)

#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)


#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)


#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#4. SGLT2i-/GLP-1ra-

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
#
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Metformin - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)

```

#### b. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#Pseuodbulk Tall and PT cells
so_kidney_sc$cell_type2 <- ifelse(grepl("PT-",so_kidney_sc$celltype_rpca),"PT",
                                  ifelse(grepl("TAL-",so_kidney_sc$celltype_rpca),"TAL",NA))
so_kidney_sc$cell_type2 <- as.character(so_kidney_sc$cell_type2)
all_cell_types <- unique(so_kidney_sc$cell_type2)
all_cell_types <- all_cell_types[-1]
Idents(so_kidney_sc) <- so_kidney_sc$cell_type2

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
all_genes <- rownames(so_subgroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}
#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#T2D + OB
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}


# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### c. KPMP Cell Type 1 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}

so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}

#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
all_cell_types2 <- all_cell_types[-29]
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### d. KPMP Cell Type 2 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#
# so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
# all_cell_types <- unique(so_kidney_sc$celltype_rpca)
# Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
# all_cell_types <- all_cell_types[-29]
# #Select full gene set
# all_genes <- rownames(so_kidney_sc)
#
# #1. T2D vs. OB
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# #Diabetes yes vs. no
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
# }
# #2. T2D vs. T1D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
# #3. T2D vs. LC
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #4. T2D/OB vs. LC
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #5. T2D/OB vs. T1D
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
#
# #1. Albuminuria (Y/N) - UACR >= 30 mg/g
# so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
#
# #2. UACR >= 100mg/g
# so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# all_cell_types2 <- all_cell_types[-29]
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #3. UACR >= 300mg/g
# so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
#
# #Medications (AMong T2D + OB)
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```


### ii. MAST + IPA
####a. All Cells
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
  print(mast)
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#"acr_u"
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
  print(mast)
}
```

####d. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
    mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
   mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
   print(mast)
  }
}
```

####c. KPMP Cells Old
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```

####d. KPMP Cells New
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```
## 3. Immune
### i. DEGS + IPA
#### a. Pseuodbulk all cell types
```{r,echo=F,warning=F,fig.width=15, fig.height=9}

#Inflammation Pathway Gene Sets
cytokines <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","cytokines_inflammatory_response_pathway.csv"))%>%
  pull(genesymbol)
inflamatory <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","inflamatory_response_pathway.csv"))%>%
  pull(genesymbol)
chemokines <- read.csv(fs::path(dir.dat,"Liver project","Pathway_Genes","infl_chemokine_cytokine_pathway.csv"))%>%
  pull(genesymbol)

all_genes 
#Disease Groups
#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# ncol(so_subgroup) #84,937 cells
# nrow(so_subgroup) #31332 genes
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)


#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)

#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,additional_group = NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)


#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)

#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)

#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)


#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)


#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#4. SGLT2i-/GLP-1ra-

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)

#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)


#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)


#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
#
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Metformin - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# result <- degs_fxn(so=so_subgroup,cell=NULL,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)

```

#### b. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#Pseuodbulk Tall and PT cells
so_kidney_sc$cell_type2 <- ifelse(grepl("PT-",so_kidney_sc$celltype_rpca),"PT",
                                  ifelse(grepl("TAL-",so_kidney_sc$celltype_rpca),"TAL",NA))
so_kidney_sc$cell_type2 <- as.character(so_kidney_sc$cell_type2)
all_cell_types <- unique(so_kidney_sc$cell_type2)
all_cell_types <- all_cell_types[-1]
Idents(so_kidney_sc) <- so_kidney_sc$cell_type2

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
all_genes <- rownames(so_subgroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}
#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong Type 2s)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="Type 2 Diabetes",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#T2D + OB
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types[-1]) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}


# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### c. KPMP Cell Type 1 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}

so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. T2D vs. OB
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
  print(result)
}

#2. T2D vs. T1D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}
#3. T2D vs. LC
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
}
#4. T2D/OB vs. LC
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
  print(result)
}
#5. T2D/OB vs. T1D
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
so_subgroup$DiseaseGroup <- so_subgroup$group2
so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
  print(result)
}

#1. Albuminuria (Y/N) - UACR >= 30 mg/g
so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
  print(result)
}

#2. UACR >= 100mg/g
so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
all_cell_types2 <- all_cell_types[-29]
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
  print(result)
}
#3. UACR >= 300mg/g
so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
#  a. T2D
so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}
#  b. T2D/OB
so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
for (cell_type in all_cell_types2) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
  print(result)
}

#Medications (AMong T2D + OB)
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Filter to type 2 diabetes only since no other participants are on these main meds
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")

#levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#1. SLGT2i+/GLP-1ra+
#Combo vs. No Med
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}
#Combo vs. GLP1
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
  print(result)
}

#Combo vs. SGLT2
so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#2. SGLT2i-/GLP-1ra+
#GLP-1 exclusive vs. no med
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

#Glp1 vs. sglt2
so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
  print(result)
}

#3. SGLT2i+/GLP-1ra-
#sglt2 vs. no med
so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
so_subgroup$medication <- factor(so_subgroup$medication)
all_genes <- rownames(so_subgroup)
for (cell_type in all_cell_types) {
  result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
  print(result)
}

# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# 
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```

#### d. KPMP Cell Type 2 (PT, TAL, EC, etc.)
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#
# so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
# all_cell_types <- unique(so_kidney_sc$celltype_rpca)
# Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
# all_cell_types <- all_cell_types[-29]
# #Select full gene set
# all_genes <- rownames(so_kidney_sc)
#
# #1. T2D vs. OB
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Obese Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# #Diabetes yes vs. no
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Obese Control",enrichment="No",top_gsea = 30)
# }
# #2. T2D vs. T1D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
# #3. T2D vs. LC
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="Type 2 Diabetes",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #4. T2D/OB vs. LC
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Lean Control")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL, exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Lean Control",enrichment="No",top_gsea = 30)
# }
# #5. T2D/OB vs. T1D
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB" | group=="Type 1 Diabetes")
# so_subgroup$DiseaseGroup <- so_subgroup$group2
# so_subgroup$DiseaseGroup <- factor(so_subgroup$DiseaseGroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,additional_group=NULL,exposure="DiseaseGroup",exp_group="T2D + OB",ref_group="Type 1 Diabetes",enrichment="No",top_gsea = 30)
# }
#
# #1. Albuminuria (Y/N) - UACR >= 30 mg/g
# so_kidney_sc$albuminuria_30 <- ifelse(so_kidney_sc$acr_u>=30,"Above_30","Below_30")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="Type 2 Diabetes",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_30 <- factor(so_subgroup$albuminuria_30)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_30",additional_group="T2D + OB",exp_group="Above_30",ref_group="Below_30",enrichment="No",top_gsea = 30)
# }
#
# #2. UACR >= 100mg/g
# so_kidney_sc$albuminuria_100 <- ifelse(so_kidney_sc$acr_u>=100,"Above_100","Below_100")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# all_cell_types2 <- all_cell_types[-29]
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="Type 2 Diabetes",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #"PT_lowQuality" has fewer than 3 cells in group 1, remove from analyses
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_100 <- factor(so_subgroup$albuminuria_100)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_100",additional_group="T2D + OB",exp_group="Above_100",ref_group="Below_100",enrichment="No",top_gsea = 30)
# }
# #3. UACR >= 300mg/g
# so_kidney_sc$albuminuria_300 <- ifelse(so_kidney_sc$acr_u>=300,"Above_300","Below_300")
# #  a. T2D
# so_subgroup <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="Type 2 Diabetes",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
# #  b. T2D/OB
# so_subgroup <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup$albuminuria_300 <- factor(so_subgroup$albuminuria_300)
# for (cell_type in all_cell_types2) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="albuminuria_300",additional_group="T2D + OB",exp_group="Above_300",ref_group="Below_300",enrichment="No",top_gsea = 30)
# }
#
# #Medications (AMong T2D + OB)
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Filter to type 2 diabetes only since no other participants are on these main meds
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#
# #levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
# #1. SLGT2i+/GLP-1ra+
# #Combo vs. No Med
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
# #Combo vs. GLP1
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="glp1")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="glp1",enrichment="No",top_gsea = 30)
# }
#
# #Combo vs. SGLT2
# so_subgroup <- subset(so_diab,medication=="glp1_sglt2" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1_sglt2",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #2. SGLT2i-/GLP-1ra+
# #GLP-1 exclusive vs. no med
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Glp1 vs. sglt2
# so_subgroup <- subset(so_diab,medication=="glp1" | medication=="sglt2")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="glp1",ref_group="sglt2",enrichment="No",top_gsea = 30)
# }
#
# #3. SGLT2i+/GLP-1ra-
# #sglt2 vs. no med
# so_subgroup <- subset(so_diab,medication=="sglt2" | medication=="no_med")
# so_subgroup$medication <- factor(so_subgroup$medication)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=cell_type,gene_set=all_genes,exposure="medication",additional_group="T2D + OB",exp_group="sglt2",ref_group="no_med",enrichment="No",top_gsea = 30)
# }
#
# #Other med groups
# #Ace inhibitors - type 2s only
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #Ace inhibitors sensitivity - T2D + OB
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,ace_inhibitor=="Yes" | ace_inhibitor=="No")
# so_subgroup$ace_inhibitor <- factor(so_subgroup$ace_inhibitor)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="ace_inhibitor",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Insulin injection - type 1s only
# so_diab <- subset(so_kidney_sc,group=="Type 1 Diabetes")
# so_subgroup <- subset(so_diab,insulin_injections_timepoint=="Yes" | insulin_injections_timepoint=="No")
# so_subgroup$insulin_injections_timepoint <- factor(so_subgroup$insulin_injections_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_injections_timepoint",additional_group="Type 1 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
# #insulin meds - type 2s
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,insulin_med_timepoint=="Yes" | insulin_med_timepoint=="No")
# so_subgroup$insulin_med_timepoint <- factor(so_subgroup$insulin_med_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="insulin_med_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="Type 2 Diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
#
# #Filter out NAs for ace inhibitors
# so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
# so_subgroup <- subset(so_diab,metformin_timepoint=="Yes" | metformin_timepoint=="No")
# so_subgroup$metformin_timepoint <- factor(so_subgroup$metformin_timepoint)
# all_genes <- rownames(so_subgroup)
# for (cell_type in all_cell_types) {
# result <- degs_fxn(so=so_subgroup,cell=all_cell_types,gene_set=all_genes,exposure="metformin_timepoint",additional_group="T2D + OB",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)
# }
```


### ii. MAST + IPA
####a. All Cells
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
  print(mast)
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
#"acr_u"
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml")
for (exp in exposure_vars){
  mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
  print(mast)
}
```

####d. PT & TAL Pseudobulk
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
    mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in cell_type2[-1]) {
   mast <- mast_fxn(so=so_diab,cell=celltype,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
   print(mast)
  }
}
```

####c. KPMP Cells Old
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```

####d. KPMP Cells New
```{r,echo=F,warning=F,fig.width=15, fig.height=9}
so_kidney_sc$celltype_rpca <- as.character(so_kidney_sc$celltype_rpca)
all_cell_types <- unique(so_kidney_sc$celltype_rpca)
Idents(so_kidney_sc) <- so_kidney_sc$celltype_rpca
all_cell_types <- all_cell_types[-29]
#Select full gene set
all_genes <- rownames(so_kidney_sc)

#1. #UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
#  a. T2D
so_diab <- subset(so_kidney_sc,group=="Type 2 Diabetes")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")

for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="Type 2 Diabetes")
    print(mast)
  }
}

#  b. T2D/OB - need to name additional group....
so_diab <- subset(so_kidney_sc,group2=="T2D + OB")
exposure_vars <- c("sbp","dbp","map","erpf_raw_plasma","bmi","dexa_fat_kg","dexa_lean_kg","hba1c","ht_adj_tkv","total_kidney_volume_ml","acr_u")
for (exp in exposure_vars){
  for (celltype in all_cell_types) {
    mast <- mast_fxn(so=so_diab,cell=NULL,exposure=exp,covariate=NULL,gene_set=rownames(so_diab),batch_size=2000,exp_group=NULL,ref_group=NULL,additional_group="T2D_OB")
    print(mast)
  }
}
```
