---
title: "Organoid Samples Analysis"
author: "Hailey Hampson"
date: "2025-04-16"
output: html_document
---

#1.Set Up 
```{r,include=FALSE}
library(reticulate)
use_python("/home/hhampson/miniconda3/bin/python", required = TRUE)
library(reprex)
library(tidyverse)
library(BiocManager)        
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(future)
library(colorspace)
library(patchwork)
library(ggdendro)
library(cowplot)
library(ggpubr)
library(venn)
library(rstatix)
library(table1)
library(Biobase)
library(ReactomeGSA)
library(GSEABase)
library(msigdbr)
library(kableExtra)
library(knitr)
library(SingleCellExperiment)
library(fgsea)
library(EnhancedVolcano)
library(openxlsx)
library(BiocManager)
# library(MAST)
library(ggrepel)
# library(qpcR)
library(ggpubr)
library(openxlsx)
library(ggplot2)
library(GGally)
library(GSEABase)
library(limma)
library(reshape2)
library(data.table)
library(knitr)
# library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(stringr)
#library(NMF)
library(rsvd)
library(RColorBrewer)
# library(MAST)
library(devtools)
# install_github("Sun-lab/ideas",force=T)
#library(ideas)
library(foreach)
library(parallel)
library(doRNG)
library(doParallel)
library(fs)
# registerDoParallel(cores = 6)
library(VennDiagram)
library(janitor)
# devtools::install_github('immunogenomics/presto')
# library(presto)
library(knitr)
library(lme4)
library(lmerTest)
#install.packages("glmmTMB")
# Reinstall glmmTMB from source
# install.packages("glmmTMB", type = "source")
library(glmmTMB)
# Install DoubletFinder (if not already installed)
# devtools::install_github("chris-mcginnis-ucsf/DoubletFinder",force=T)
# Load the package
# Install DoubletFinder from GitHub (use devtools to install)
# if (!requireNamespace("devtools", quietly = TRUE)) install.packages("devtools")
# devtools::install_github("chris-mcginnis-ucsf/DoubletFinder",force=T)
# library(DoubletFinder)
# install.packages("emmeans")
library(emmeans)
library(pheatmap)
library(enrichplot)
library(enrichR)
# BiocManager::install("speckle")
library(speckle)
library(limma)

dbs <- c("GO_Biological_Process_2023", 
         "KEGG_2021_Human",
         # "Reactome_2022", 
         "Reactome_Pathways_2024",
         # "MSigDB_Oncogenic_Signatures",
         # "MSigDB_Computational",
         "MSigDB_Hallmark_2020")
dbs_celltype <- c(
  "GO_Biological_Process_2023",
  "KEGG_2021_Human",
  "Reactome_Pathways_2024",
  "MSigDB_Hallmark_2020",
  # Cell type specific databases
  "CellMarker_2024",  # Cell type marker genes
  "Azimuth_Cell_Types_2021",  # Cell type signatures
  "PanglaoDB_Augmented_2021",  # Single-cell markers
  "Descartes_Cell_Types_and_Tissue_2021",  # Developmental cell types
  "Human_Gene_Atlas",  # Tissue/cell expression
  "ARCHS4_Tissues"  # Tissue expression
)
# BiocManager::install("edgeR",force=T)
library(edgeR)
library(devtools)
# install_github("lhe17/nebula")
# library(nebula)

# remove.packages("boot")  # Remove broken version
# install.packages("boot", type = "source")  # Reinstall from source
library(boot)
library(furrr)
library(future)
# BiocManager::install("scran")
library(scran)
library(BiocParallel)
# library(DESeq2)
if (!require("GSA", quietly = TRUE)) {
  install.packages("GSA")
}
library(GSA)

# #Mac laptop
# dir.dat <- c("//Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive")
# dir.dat2 <- c("/Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive/scRNA")
# dir.code <- c("/Users/hhampson/Documents/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
# dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive/Kidney scRNAseq Project/Organoid Results/NEBULA")

# #Mac Studio File Path
# dir.dat <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive")
# dir.dat2 <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/scRNA")
# dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Kidney scRNAseq Project/Organoid Results/NEBULA")

##c. Load functions ----
source("Kidney_functions_sc.R")
source("Rename_Seurat_Function.R")
source("Celltype_Annotation_Function.R")
```

## a. Lambda Data Load
```{r, Cyberduck setup,include=F,echo=F}
# install.packages("reticulate")
# library(reticulate)
# reticulate::use_python("/home/hhampson/miniconda3/bin/python") # replace with your username

## Load boto3 and pandas
boto3 <- reticulate::import("boto3")
pd <- reticulate::import("pandas")

## Create an S3 client
# install.packages("jsonlite")  # Install if not already installed
library(jsonlite)  # Load the package

keys <- fromJSON("/home/hhampson/keys.json") # replace with your Lambda username
session <- boto3$session$Session(
  aws_access_key_id = keys$MY_ACCESS_KEY,
  aws_secret_access_key = keys$MY_SECRET_KEY
)

## Create an S3 client with the session
s3 <- session$client("s3", endpoint_url = "https://s3.kopah.uw.edu")

# #Load kidney scRNAseq PB90
# gc()
# bucket <- "scrna" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
# s3$download_file(bucket, "Kidney transcriptomics/Single cell RNA seq/PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds", temp_file)
# so_kpmp_sc <- readRDS(temp_file)

#Load cleaned kidney biopsy data
gc()
bucket <- "scrna" # bucket name in Kopah
temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
s3$download_file(bucket, "Kidney organoids/cleaned_biopsy.rds", temp_file)
so_kpmp_sc <- readRDS(temp_file)

#Load harmonized data for biopsy
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
s3$download_file(bucket, "harmonized_dataset.csv", temp_file)
harm_meta_data <- read.csv(temp_file)

#Load celltype annotation database
temp_file <- tempfile(fileext = ".gmt")
s3$download_file("gsea", "gmt_files/c8.all.v2025.1.Hs.symbols.gmt", temp_file)
c8 <- GSA.read.gmt(temp_file)

# #Load formatted organoid data
# gc()
# bucket <- "scrna" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
# s3$download_file(bucket, "Kidney organoids/organoids_processed_matrix.rds", temp_file)
# sc_org <- readRDS(temp_file)

# #Load cleaned organoid data
gc()
bucket <- "scrna" # bucket name in Kopah
temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
s3$download_file(bucket, "Kidney organoids/cleaned_organoid.rds", temp_file)
sc_org <- readRDS(temp_file)

# 
# #Load kidney cell type annotations
# gc()
# bucket <- "scrna" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
# s3$download_file(bucket, "Kidney organoids/top_20_markers_15.csv", temp_file)
# annot_15 <- read.csv(temp_file)
# annot_15 <- annot_15 %>% 
#   dplyr::select(c("cluster","Celltype")) %>% 
#   distinct()
#   
# gc()
# bucket <- "scrna" # bucket name in Kopah
# temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
# s3$download_file(bucket, "Kidney organoids/top_20_markers_30.csv", temp_file)
# annot_30 <- read.csv(temp_file)
# annot_30 <- annot_30 %>% 
#   dplyr::select(c("cluster","Celltype")) %>% 
#   distinct()

#Load metadata for organoids
gc()
bucket <- "harmonized.dataset" # bucket name in Kopah
temp_file <- tempfile(fileext = ".rds") # need to create a temporary file
s3$download_file(bucket, "harmonized_dataset.csv", temp_file)
harm_meta_data2 <- read.csv(temp_file)

#Load SE Annotations
gc()
bucket <- "scrna" # bucket name in Kopah
temp_file <- tempfile(fileext = ".csv") # need to create a temporary file
s3$download_file(bucket, "Kidney organoids/cluster_annotations_SE.csv", temp_file)
se_annotations <- read.csv(temp_file)
se_annotations <- se_annotations %>% 
  janitor::clean_names()
annot_key <- se_annotations %>% 
  dplyr::select(c("cluster_number","putative_assignment")) %>% 
  dplyr::rename(cell_type = putative_assignment) %>% 
  mutate(cell_type=str_to_lower(str_replace_all(cell_type," ","_")))

# Download Reactome GMT
temp_file <- tempfile(fileext = ".gmt")
s3$download_file("gsea", "gmt_files/c2.cp.reactome.v2024.1.Hs.symbols.gmt", temp_file)
reactome_sets <- gmtPathways(temp_file)
cat("Loaded", length(reactome_sets), "Reactome gene sets\n")

# Output directory
# dir.gsea <- "/home/hhampson/Results/GSEA_T2DvsLC_Reactome"
# dir.create(dir.gsea, recursive = TRUE)
```

# 2. Pre-Processing & Qualtiy Control
## a. Load Data
### i. Biopsy Data
```{r,include=T,echo=T}
#Human Biopsy samples in PB90 origional number of cells
cells_all <-  ncol(so_kpmp_sc) #211218 cells before processing
genes_all <- nrow(so_kpmp_sc) # 31332 genes before processing
print(paste0(cells_all," cells and ",genes_all," genes before processing in PB90"))

#Set ids for organoid samples
# ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")
ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T") #Remove IT 19, this organoid didnt work

#Filter to organoid samples only
so_kpmp_sc <- subset(so_kpmp_sc,record_id %in% ids)
cells_org <-  ncol(so_kpmp_sc) #14348 cells before processing
genes_org <- nrow(so_kpmp_sc) #31332 genes before processing
print(paste0(cells_org," cells and ",genes_org," genes after filtering to 6 participants with organoid data"))
#"11386 cells and 31332 genes after filtering to 6 participants with organoid data"

#Format meta data
harm_meta_data <- harm_meta_data %>%   
  dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit)) %>% 
    dplyr::mutate(race_ethnicity_condensed = case_when(race == "White" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
                                                     race == "Black or African American" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
                                                     ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
                                                     T ~ "Not Hispanic or Latino Other"))

#Filter to 7 organoid samples 
meta <- harm_meta_data %>% 
  filter(visit=="baseline") %>%
  filter(record_id %in% ids)
rm(harm_meta_data)

#Select metadata from seurat object to facilitate merge of new metadata into seurat object
meta_kidney_sc <-  so_kpmp_sc@meta.data
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)

#Merge metadata from 7 participants at baseline into seurat object metadata
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(meta,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)

#Merge metadata back into seurat object
so_kpmp_sc <- AddMetaData(so_kpmp_sc, meta_kidney_sc)

#Check number of unique ids
length(unique(so_kpmp_sc$kit_id)) #should be 6, "KL-0014631" "KL-0014639" "KL-0014642" "KL-0019100" "KL-0019103" "KL-0022163" "KL-0027475"
#"KL-0014631" "KL-0014639" "KL-0014642" "KL-0019100" "KL-0019103" "KL-0022163" now, removed IT 19

#Remove metadatasets
rm(meta_kidney_sc,meta)

#Create medication & disease status groups of interest
so_kpmp_sc@meta.data <- so_kpmp_sc@meta.data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>%
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>%
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>%
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups:
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
invisible(gc())
so_kpmp_sc@meta.data <- so_kpmp_sc@meta.data %>%
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
# so_kpmp_sc@meta.data$medication <- factor(so_kpmp_sc@meta.data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Ensure default assay in seurat object to RNA
DefaultAssay(so_kpmp_sc) <- "RNA"
invisible(gc())

#Perform Quality Control & Preprocessing Steps
ncol(so_kpmp_sc) #11386 cells
nrow(so_kpmp_sc) #31332 genes

#YE JI's filtering code for percent expression
expr_matrix <- as.matrix(GetAssayData(so_kpmp_sc, assay = "RNA", layer = "counts"))

# Calculate the proportion of cells expressing each gene
num_cells_per_gene <- rowSums(expr_matrix > 0)  # Count nonzero cells per gene
total_cells <- ncol(expr_matrix)  # Total number of cells
gene_proportion <- num_cells_per_gene / total_cells  # Fraction of cells expressing each gene
remove(expr_matrix)

# Keep genes expressed in at least "5%" of cells
genes_to_keep <- names(gene_proportion[gene_proportion >= 0.05])
so_kpmp_sc <- subset(so_kpmp_sc, features = genes_to_keep)
ncol(so_kpmp_sc) #14348 Cells, 11386 cells now
nrow(so_kpmp_sc) #9249 genes, 9209 genes now

#Remove mitochondrial genes (those starting with "MT-")
mito_genes <- grep("^MT-", rownames(so_kpmp_sc), value = TRUE)
so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), mito_genes))
sum(grepl("^MT-", rownames(so_kpmp_sc))) #should be 0
ncol(so_kpmp_sc) #14348 cells, 11,386
nrow(so_kpmp_sc) #9236 genes, 9196 genes

#Remove ribosomal Genes
# Identify ribosomal genes
ribo_genes <- c(
  "RPL22", "RPL11", "RPS8", "RPL5", "RPS27", "RPS7", "RPS27A", "RPL31", "RPL37A", "RPL32", "RPL15", "RPL14", "RPL29",
  "RPL24", "RPL22L1", "RPL35A", "RPL9", "RPL34", "RPS3A", "RPL37", "RPS23", "RPS14", "RPS18", "RPS10", "RPL10A", 
  "RPS20", "RPL7", "RPL30", "RPL8", "RPS6", "RPL35", "RPL12", "RPL7A", "RPS24", "RPLP2", "RPL27A", "RPS13", "RPS3",
  "RPS25", "RPS26", "RPL41", "RPL6", "RPLP0", "RPL21", "RPS29", "RPL4", "RPLP1", "RPS17", "RPS2", "RPS15A", "RPL13",
  "RPL26", "RPL23A", "RPL23", "RPL19", "RPL27", "RPL38", "RPL17", "RPS15", "RPL36", "RPS28", "RPL18A", "RPS16", 
  "RPS19", "RPL18", "RPL13A", "RPS11", "RPS9", "RPL28", "RPS5", "RPS21", "RPL3", "RPS4X", "RPL36A", "RPL39", 
  "RPL10", "RPS4Y1"
)
so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), ribo_genes))
length(which(rownames(so_kpmp_sc) %in% ribo_genes)) #should be 0
ncol(so_kpmp_sc) #14348 cells, 11386
nrow(so_kpmp_sc) #9160 genes, 9120

#Renormalize & Scale after filtering
so_kpmp_sc <- NormalizeData(so_kpmp_sc)
so_kpmp_sc <- ScaleData(so_kpmp_sc, features = VariableFeatures(so_kpmp_sc))

# Calculate cell library size for offset in NEBULA 
counts_layer <- round(GetAssayData(so_kpmp_sc, layer = "counts"))
library_size <- Matrix::colSums(counts_layer)
so_kpmp_sc$library_size <- library_size
hist(so_kpmp_sc$library_size)

# Pooled offset
bp <- MulticoreParam(workers = 9)
sce <- SingleCellExperiment(assays = list(counts = counts_layer))
sce <- computeSumFactors(sce, BPPARAM = bp)
pooled_offset <- sizeFactors(sce)
so_kpmp_sc$pooled_offset <- pooled_offset
hist(so_kpmp_sc$pooled_offset)

#Create pseudobulk cell type variable
so_kpmp_sc$celltype1 <- case_when(grepl("PT-",so_kpmp_sc$celltype_rpca)~"PT",
                                  grepl("TAL-",so_kpmp_sc$celltype_rpca)~"TAL",
                                  grepl("EC-",so_kpmp_sc$celltype_rpca)~"EC",
                                  grepl("POD",so_kpmp_sc$celltype_rpca)~"POD",
                                  grepl("MAC",so_kpmp_sc$celltype_rpca)~"MAC",
                                  grepl("MON",so_kpmp_sc$celltype_rpca)~"MON",
                                  grepl("PC-",so_kpmp_sc$celltype_rpca)~"PC",
                                  grepl("FIB",so_kpmp_sc$celltype_rpca)~"FIB_MC_VSMC",
                                  grepl("DTL",so_kpmp_sc$celltype_rpca)~"DTL",
                                  so_kpmp_sc$celltype_rpca=="DCT"~"DCT",
                                  so_kpmp_sc$celltype_rpca=="ATL"~"ATL",
                                  so_kpmp_sc$celltype_rpca=="B"~"B",
                                  so_kpmp_sc$celltype_rpca=="T"~"T")
so_kpmp_sc$celltype1 <- as.character(so_kpmp_sc$celltype1)

so_kpmp_sc$KPMP_celltype2 <- as.character(so_kpmp_sc$KPMP_celltype)
so_kpmp_sc$celltype2 <- ifelse(so_kpmp_sc$KPMP_celltype=="aPT" | 
                                 so_kpmp_sc$KPMP_celltype=="PT-S1/S2" | 
                                 so_kpmp_sc$KPMP_celltype == "PT-S3","PT",
                               ifelse(grepl("TAL",so_kpmp_sc$KPMP_celltype),"TAL",
                                      ifelse(grepl("EC-",so_kpmp_sc$KPMP_celltype),"EC",so_kpmp_sc$KPMP_celltype2)))

#High level celltypes
# Comprehensive cell type annotation for kidney single-cell data
so_kpmp_sc$celltype_LR <- case_when(
  # PROXIMAL TUBULE (PT) - All proximal tubule segments
  so_kpmp_sc$KPMP_celltype %in% c("aPT", "PT-S1/S2", "PT-S3") ~ "PT",
  # THICK ASCENDING LIMB (TAL) - All TAL variants
  grepl("TAL", so_kpmp_sc$KPMP_celltype) ~ "TAL",
  # THIN LIMBS - Descending and ascending thin limbs
  so_kpmp_sc$KPMP_celltype %in% c("DTL", "aDTL", "ATL") ~ "TL",
  # DISTAL CONVOLUTED TUBULE (DCT)
  grepl("DCT", so_kpmp_sc$KPMP_celltype) ~ "DCT",
  # CONNECTING TUBULE (CNT) - Including CNT and principal cells
  so_kpmp_sc$KPMP_celltype %in% c("CNT", "CNT-PC") ~ "CNT",
  # COLLECTING DUCT PRINCIPAL CELLS (PC)
  so_kpmp_sc$KPMP_celltype %in% c("CCD-PC", "dCCD-PC", "M-PC") ~ "PC",
  # INTERCALATED CELLS (IC) - All IC subtypes
  grepl("IC", so_kpmp_sc$KPMP_celltype) | so_kpmp_sc$KPMP_celltype == "aIC" ~ "IC",
  # ENDOTHELIAL CELLS (EC) - All endothelial subtypes
  grepl("EC-", so_kpmp_sc$KPMP_celltype) | so_kpmp_sc$KPMP_celltype == "EC/VSMC" ~ "EC",
  # PODOCYTES
  so_kpmp_sc$KPMP_celltype == "POD" ~ "POD",
  # PARIETAL EPITHELIAL CELLS
  so_kpmp_sc$KPMP_celltype == "PEC" ~ "PEC",
  # IMMUNE CELLS - All immune cell types
  so_kpmp_sc$KPMP_celltype %in% c("MON", "cDC", "pDC", "MAC", "CD4+ T", "CD8+ T", 
                                  "cycT", "B", "NK", "MC") ~ "Immune",
  # FIBROBLASTS
  so_kpmp_sc$KPMP_celltype == "FIB" ~ "Fibroblast",
  # VASCULAR SMOOTH MUSCLE CELLS/PERICYTES
  so_kpmp_sc$KPMP_celltype == "VSMC/P" ~ "VSMC_Pericyte",
  # SCHWANN CELLS
  so_kpmp_sc$KPMP_celltype == "SchwannCells" ~ "Schwann",
  # NON-SPECIFIC/UNKNOWN
  so_kpmp_sc$KPMP_celltype == "non-specific" ~ "Nonspecific",
  # DEFAULT - anything not captured above
  TRUE ~ "Other"
)

final_counts <- table(so_kpmp_sc$celltype_LR)
print(final_counts)
print(prop.table(final_counts) * 100)
rm(counts_layer)

#Save cleaned biopsy Seurat object
# saveRDS(so_kpmp_sc, file = "/home/hhampson/Data/cleaned_biopsy.rds")
```

### ii. Organoid Data
```{r}
ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")
# unique(sc_org$samples) #"sample_50_15"   "sample_42_15"   "sample_50_30"   "sample_41_1_15" "sample_11_30"   "ITD19_30" #"sample_10_15"   "sample_72_15"   "sample_10_30"   "ITD19_15"       "sample_41_1_30" "sample_72_30"  
#  "41_G_15"        "sample_42_30"   "41_G_30"        "sample_11_15"  
# DKD ids were 42, 50 and 72 and the controls were 10, 11 and 41 

# The 10 and 11 have iCRC, the 50 and 72 have RH, and the remaining ones _ 41, 42, and ITD19 _ don’t have any letters.
#CRC10 -sample_10_15, "sample_10_30
# CRC11 - sample_11_15, sample_11_30
# CRC03 (aka ‘line 41) - "41_G_15", "41_G_30" , sample_41_1_15, sample_41_1_30

# RH50T -  "sample_50_30", sample_50_15
# RH72T -  "sample_72_15" ,sample_72_30
# RH62T (aka ‘line 42’) - "sample_42_15",  "sample_42_30"
# IT2D19 - ITD19_30, ITD19_15

#Rename seurat object rownames as the gene names not ENSG
#Extract ids
gene_ids <- rownames(sc_org)
new_gene_names <- sc_org@misc$gene_annotations$name

# Rename the Seurat object
sc_org_renamed <- rename_seurat_genes(sc_org, new_gene_names)

# Verify the rename worked
print(paste("Original rownames (first 10):", paste(head(gene_ids, 10), collapse = ", ")))
print(paste("New rownames (first 10):", paste(head(rownames(sc_org_renamed), 10), collapse = ", ")))

# Check that dimensions are preserved
print(paste("Original dimensions:", paste(dim(sc_org), collapse = " x ")))
print(paste("New dimensions:", paste(dim(sc_org_renamed), collapse = " x ")))

#Save new sc_org
sc_org <- sc_org_renamed
rm(sc_org_renamed)

#Format metadata
meta <- sc_org@meta.data

diab_ids <- c("sample_50_15","sample_50_30","sample_72_15","sample_72_30","sample_42_15","sample_42_30","ITD19_15","ITD19_30")
control_ids <- c("sample_10_15","sample_10_30","sample_11_15","sample_11_30","41_G_15","41_G_30","sample_41_1_15","sample_41_1_30")

sc_org$diabetes <- ifelse(sc_org$samples %in% diab_ids,"Diabetes","Control")
sc_org$diabetes <- factor(sc_org$diabetes)

# biopsy_ids <- c("CRC-10","CRC-11","CRC-03","RH-50-T","RH-72-T","RH-62-T","IT_19")
sc_org@meta.data <- sc_org@meta.data %>% 
  mutate(record_id = case_when(sc_org$samples=="sample_10_15" | sc_org$samples=="sample_10_30" ~ "CRC-10",
                               sc_org$samples=="sample_11_15" | sc_org$samples=="sample_11_30" ~ "CRC-11",
                               sc_org$samples=="41_G_15" | sc_org$samples=="41_G_30" | 
                                 sc_org$samples=="sample_41_1_15" | sc_org$samples=="sample_41_1_30" ~"CRC-03",
                               sc_org$samples=="sample_50_15" | sc_org$samples=="sample_50_30" ~ "RH-50-T",
                               sc_org$samples=="sample_72_15" | sc_org$samples=="sample_72_30" ~ "RH-72-T",
                               sc_org$samples=="sample_42_15" | sc_org$samples=="sample_42_30" ~ "RH-62-T",
                               sc_org$samples=="ITD19_15" | sc_org$samples=="ITD19_30" ~ "IT_19"))

#Get gene annotations & rename rows
# gene_annotations <- data.frame(sc_org@misc$gene_annotations)
org_genes_all <- nrow(sc_org) #62,754 genes
org_cells_all <- ncol(sc_org) #194063 cells
rownames(sc_org)
colnames(sc_org)

#Format metadata
harm_meta_data <- harm_meta_data2 %>%   
    dplyr::summarise(across(where(negate(is.numeric)), ~ ifelse(all(is.na(.x)), NA_character_, last(na.omit(.x)))),
                   across(where(is.numeric), ~ ifelse(all(is.na(.x)), NA_real_, mean(.x, na.rm = TRUE))),
                   .by = c(record_id, visit)) %>% 
    dplyr::mutate(race_ethnicity_condensed = case_when(race == "White" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino White",
                                                     race == "Black or African American" &
                                                       ethnicity == "Not Hispanic or Latino" ~ "Not Hispanic or Latino Black",
                                                     ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
                                                     T ~ "Not Hispanic or Latino Other"))

##e. Filter to 7 organoid samples ----
meta <- harm_meta_data %>% 
  filter(visit=="baseline") %>%
  filter(record_id %in% ids)
rm(harm_meta_data,harm_meta_data2)

#Select metadata from seurat object to facilitate merge of new metadata into seurat object
meta_kidney_sc <-  sc_org@meta.data
rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)

#Merge metadata from 83 participants at baseline into seurat object metadata
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(meta,by="record_id")
rownames(meta_kidney_sc) <- rownames(sc_org@meta.data)

#Merge metadata back into seurat object
sc_org <- AddMetaData(sc_org, meta_kidney_sc)

#Check number of unique ids
length(unique(sc_org$record_id)) #should be 7
#Remove metadatasets
rm(meta_kidney_sc,meta)


#Create medication & disease status groups of interest
sc_org@meta.data <- sc_org@meta.data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>%
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>%
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>%
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups:
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
invisible(gc())
sc_org@meta.data <- sc_org@meta.data %>%
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
sc_org@meta.data$medication <- factor(sc_org@meta.data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

# #Ensure default assay in seurat object to RNA
DefaultAssay(sc_org) <- "RNA"
# invisible(gc())

nrow(sc_org) #62,754 genes before filtering
ncol(sc_org) #194,063 cells before filtering

length(unique(sc_org$record_id)) #should be 6
nrow(sc_org) #62,754 genes before filtering, now 62,754
ncol(sc_org) #194,063 cells before filtering, now 171,662 


#Filter out cells that express less than 500 genes or more than 5000 genes and cells that have more than 50% of gene expression coming from mitochondrial genes
sc_org <- subset(sc_org,
                 subset = nFeature_RNA > 500 &
                   nFeature_RNA < 5000 &
                   percent.mt < 50)

nrow(sc_org) #62,754 genes after filtering
ncol(sc_org) #156387 cells after filltering
expr_matrix <- GetAssayData(sc_org, assay = "RNA", layer = "counts")

# Calculate the proportion of cells expressing each gene
num_cells_per_gene <- rowSums(expr_matrix > 0)  # Count nonzero cells per gene
total_cells <- ncol(expr_matrix)  # Total number of cells
gene_proportion <- num_cells_per_gene / total_cells  # Fraction of cells expressing each gene
remove(expr_matrix)

# Keep genes expressed in at least "gene_pct" of cells
genes_to_keep <- names(gene_proportion[gene_proportion >= 0.05])
# genes_to_keep <- names(gene_proportion)
sc_org <- subset(sc_org, features = genes_to_keep)
ncol(sc_org) #156387 Cells, 137604
nrow(sc_org) # 7472 genes, 7497

#Remove mitochondrial genes (those starting with "MT-")
mito_genes <- grep("^MT-", rownames(sc_org), value = TRUE)
sc_org <- subset(sc_org, features = setdiff(rownames(sc_org), mito_genes))
sum(grepl("^MT-", rownames(sc_org))) #0
ncol(sc_org) #156387 cells, 137604
nrow(sc_org) #7457 genes, 7482

#Remove ribosomal Genes
# Identify ribosomal genes
ribo_genes <- c(
  "RPL22", "RPL11", "RPS8", "RPL5", "RPS27", "RPS7", "RPS27A", "RPL31", "RPL37A", "RPL32", "RPL15", "RPL14", "RPL29",
  "RPL24", "RPL22L1", "RPL35A", "RPL9", "RPL34", "RPS3A", "RPL37", "RPS23", "RPS14", "RPS18", "RPS10", "RPL10A", 
  "RPS20", "RPL7", "RPL30", "RPL8", "RPS6", "RPL35", "RPL12", "RPL7A", "RPS24", "RPLP2", "RPL27A", "RPS13", "RPS3",
  "RPS25", "RPS26", "RPL41", "RPL6", "RPLP0", "RPL21", "RPS29", "RPL4", "RPLP1", "RPS17", "RPS2", "RPS15A", "RPL13",
  "RPL26", "RPL23A", "RPL23", "RPL19", "RPL27", "RPL38", "RPL17", "RPS15", "RPL36", "RPS28", "RPL18A", "RPS16", 
  "RPS19", "RPL18", "RPL13A", "RPS11", "RPS9", "RPL28", "RPS5", "RPS21", "RPL3", "RPS4X", "RPL36A", "RPL39", 
  "RPL10", "RPS4Y1"
)
sc_org <- subset(sc_org, features = setdiff(rownames(sc_org), ribo_genes))
length(which(rownames(sc_org) %in% ribo_genes)) #0
ncol(sc_org) #156387 cells
nrow(sc_org) #7383 genes

#Remove ID IT_19
sc_org <- subset(sc_org,record_id!="IT_19")
nrow(sc_org)
ncol(sc_org)

#Renormalize & Scale after filtering
sc_org <- NormalizeData(sc_org)
sc_org <- ScaleData(sc_org, features = VariableFeatures(sc_org))

# Calculate cell library size for offset in NEBULA 
counts_layer <- round(GetAssayData(sc_org, layer = "counts"))
library_size <- Matrix::colSums(counts_layer)
sc_org$library_size <- library_size
# hist(sc_org$library_size)

# Pooled offset
bp <- MulticoreParam(workers = 9)
sce <- SingleCellExperiment(assays = list(counts = counts_layer))
sce <- computeSumFactors(sce, BPPARAM = bp)
pooled_offset <- sizeFactors(sce)
sc_org$pooled_offset <- pooled_offset
# hist(sc_org$pooled_offset)

#Create treatment variable
sc_org$treatment <- ifelse(grepl("15$",sc_org$samples),"15","30")
rm(sce,counts_layer)

# #Merge gene names
# sc_org <- NormalizeData(sc_org)
# sc_org <- ScaleData(sc_org, features = VariableFeatures(sc_org))

# #Save cleaned organoid data
# saveRDS(sc_org, file = "/home/hhampson/Data/cleaned_organoid.rds")
```

## b. Descriptive Statistics
```{r}
dat <- so_kpmp_sc@meta.data %>%
  group_by(record_id) %>%
  summarise(across(everything(), ~ .x[1])) %>%
  ungroup()
dat_full <- so_kpmp_sc@meta.data

table1(~ age_surgery + nih_sex + nih_race + nih_ethnicity + bmi + tg + a1c+
         diagnosis_of_diabetes | group, data=dat)

```

## c. Annotate Organoid Data from SE & Beno-approved annotations
```{r}
#Annotate cell types
#Start by clustering
#Select combined conc. only
so_combined <- sc_org

# #Remove ID IT_19
# so_combined <- subset(so_combined,record_id!="IT_19")
unique(so_combined$record_id) #"RH-50-T" "RH-62-T" "CRC-03"  "CRC-11"  "CRC-10"  "RH-72-T"

# PCA
so_combined <- NormalizeData(so_combined)
so_combined <- ScaleData(so_combined, features = VariableFeatures(so_combined))
so_combined <- FindVariableFeatures(object = so_combined)
so_combined <- RunPCA(so_combined, features = VariableFeatures(object = so_combined),assay="RNA")
ElbowPlot(so_combined)

# # Find neighbors and clusters 
so_combined <- FindNeighbors(so_combined, assay = "RNA", dims = 1:20) #20 based on elbow plot
so_combined <- FindClusters(so_combined, resolution = 0.5)

# Perform UMAP
so_combined <- RunUMAP(so_combined, dims = 1:30) #25 to 50 dimensions for organoid, start with 30
so_combined@reductions
DimPlot(so_combined, reduction = "umap", raster = F)
Idents(so_combined) <- "seurat_clusters"  # or whatever the column is named

# Verify you have 25 clusters
print(paste("Number of clusters:", length(unique(Idents(so_combined)))))
print(table(Idents(so_combined)))  # Show distribution of cells per cluster
DimPlot(so_combined, reduction = "umap", raster = T)

DimPlot(so_combined, reduction = "umap", raster = T, group.by = "record_id")

# Find markers for all clusters
all_markers <- FindAllMarkers(so_combined, 
                              only.pos = TRUE,     # Only positive markers
                              min.pct = 0.25,      # Must be expressed in at least 25% of cells
                              logfc.threshold = 0.25,  # Minimum log fold change
                              test.use = "wilcox")  # Wilcoxon test

# Verify all 25 clusters are included
print(paste("Clusters with markers found:", length(unique(all_markers$cluster))))
print(paste("Clusters in marker analysis:", paste(sort(unique(all_markers$cluster)), collapse = ", ")))

# Get top 40 markers per cluster
top_40_markers <- get_top_markers(all_markers, top_n = 40)
# write.csv(top_40_markers,"/home/hhampson/Results/combined_gluc_top_40_markers_res_05_clusters_19_outlier_removed.csv")

# Create dot plot with top 10 markers (might be crowded)
dotplot_40 <- create_marker_dotplot(so_combined, all_markers, top_n = 40,
                                    title = "Top 40 Marker Genes by Cluster; Combined Glucose Treatment")
print(dotplot_40)

# png("/home/hhampson/Results/dotplot_avg_exp_top40_gluc_combined_cluster18_res05_outlier_removed.png",res=300,width=10000,height=2500)
# print(dotplot_40)
# dev.off()

#Annotate clusters with SE annotations
# Check metadata columns
colnames(so_combined@meta.data)

# View the seurat_clusters column
head(so_combined@meta.data$seurat_clusters)

# View your annotation key to confirm structure
print(annot_key)

#Fix key - keep clusters 0 and 10 distinct
annot_key <- annot_key %>% 
  mutate(cell_type=ifelse(cluster_number==10,"developing_kidney_epithelium2",cell_type))

# Create named vector from your dataframe
cluster_annotations <- setNames(annot_key$cell_type, annot_key$cluster_number)

# First, check what cluster numbers actually exist in your Seurat object
table(so_combined$seurat_clusters)

# Check the class/type
class(so_combined$seurat_clusters)
levels(so_combined$seurat_clusters)

# Create the annotations vector
cluster_annotations <- setNames(annot_key$cell_type, 
                                as.character(annot_key$cluster_number))

# Method 1: Use AddMetaData with a named vector
cell_type_vector <- cluster_annotations[as.character(so_combined$seurat_clusters)]
names(cell_type_vector) <- colnames(so_combined)

so_combined <- AddMetaData(so_combined, 
                           metadata = cell_type_vector, 
                           col.name = "cell_type")

# Verify it worked
table(so_combined$cell_type)
table(so_combined$cell_type, so_combined$seurat_clusters)

# Set cell_type as the active identity for plotting
Idents(so_combined) <- "cell_type"

# Create a nice UMAP with cell type labels
DimPlot(so_combined, reduction = "umap", raster = TRUE, label = TRUE, repel = TRUE)

# Also visualize by sample/condition
DimPlot(so_combined, reduction = "umap", raster = TRUE, group.by = "record_id")

# Check your metadata to confirm what columns you have for NEBULA
colnames(so_combined@meta.data)

# Create abbreviated cell type names
cell_type_abbrev <- c(
  "developing_kidney_epithelium" = "DKE",
  "developing_kidney_epithelium2" = "DKE2",
  "developing_muscle" = "DMus",
  "developing_pec" = "DPEC",
  "distal_tubular_epithelial_cells_" = "DT",
  "early_endothelial_cells_vsmc" = "EEC",
  "mesangial_cells_smooth_muscle" = "Mes",
  "mesangial_cells_vsmcs" = "MesV",
  "mixed_pec_general_neural" = "PEC_N",
  "muscle_vsmc" = "MusV",
  "neural" = "Neur",
  "non_specific_kidney_epithelium" = "NsKE",
  "proliferating_mitotic_cells" = "Prolif",
  "proliferating_podocyte_epithelial_cells" = "ProlPod",
  "stromal" = "Strom"
)
# Add abbreviated cell types directly to metadata slot
so_combined@meta.data$cell_type_abbrev <- cell_type_abbrev[so_combined$cell_type]

# Verify it worked
table(so_combined@meta.data$cell_type_abbrev)

# Set as active identity
Idents(so_combined) <- "cell_type_abbrev"

# Plot with abbreviated labels
DimPlot(so_combined, reduction = "umap", raster = TRUE, label = TRUE, repel = TRUE, label.size = 6)+
   theme(legend.position = "none")
# Save the plot
ggsave("/home/hhampson/Results/UMAP_celltype_abbreviated_v2.png", width = 10, height = 10, dpi = 300)

p <- DimPlot(so_combined, reduction = "umap", raster = TRUE, label = FALSE) +
  labs(title = "Cell Type Annotations",
       color = "Cell Type")+ theme(legend.position = "none")

# Add bold labels
p <- LabelClusters(p, id = "ident", fontface = "bold", size = 6, repel = TRUE)

print(p)
ggsave("/home/hhampson/Results/UMAP_celltype_bold_labels_v2.png", p, width = 10, height = 10, dpi = 300)


# Create corrected legend with proper order
abbrev_legend <- data.frame(
  Full_Name = names(cell_type_abbrev),
  Abbreviation = unname(cell_type_abbrev)
)

# Sort by full name
abbrev_legend <- abbrev_legend[order(abbrev_legend$Full_Name), ]
rownames(abbrev_legend) <- NULL

# Print the legend
print(abbrev_legend)

# Save the corrected legend
write.csv(abbrev_legend, "/home/hhampson/Results/celltype_abbreviations_legend_corrected_v2.csv", row.names = FALSE)

# Create formatted version
abbrev_legend_formatted <- abbrev_legend %>%
  mutate(Legend = paste0(Abbreviation, " = ", Full_Name))

# Print formatted
cat("\nCell Type Abbreviations:\n")
cat(paste(abbrev_legend_formatted$Legend, collapse = "\n"))

# Save as text
writeLines(abbrev_legend_formatted$Legend, "/home/hhampson/Results/celltype_abbreviations_legend_corrected_v2.txt")

# Create a new variable with "Abbreviation = Full Name" format
so_combined@meta.data$cell_type_legend <- paste0(
  so_combined@meta.data$cell_type_abbrev, 
  " = ", 
  so_combined@meta.data$cell_type
)

# Set as active identity
Idents(so_combined) <- "cell_type_legend"

# Create plot with combined legend
p <- DimPlot(so_combined, reduction = "umap", raster = TRUE, label = FALSE) +
  labs(title = "Cell Type Annotations",
       color = "Cell Type") +
  theme(legend.text = element_text(size = 8),
        legend.key.size = unit(0.4, "cm"))

# Save the plot
ggsave("/home/hhampson/Results/UMAP_celltype_with_full_legend_v2.png", p, width = 16, height = 8, dpi = 300)

print(p)

#Save cleaned & annotated organoid data
# saveRDS(so_combined, file = "/home/hhampson/Data/annotated_cleaned_organoid.rds")

```


#3. Organoid Analysis
## a. Perform differential expression between T2D & LC in organoid samples (pooled by glucose conc.)
### i. Pre-Analysis Steps
```{r}
# Verify dimensions
nrow(so_combined) # genes 7383
ncol(so_combined) # cells 137604

# Check your metadata
table(so_combined$group)
table(so_combined$treatment)
table(so_combined$cell_type_abbrev)
head(so_combined@meta.data[, c("group", "cell_type_abbrev", "record_id", "treatment")])

# Make sure group is a factor with LC as reference
so_combined$group <- factor(so_combined$group)
so_combined$group <- relevel(so_combined$group, ref = "Lean Control")  # Adjust "Lean Control" to match your actual level name

# Prepare data for cell type distribution plot
celltype_counts <- so_combined@meta.data %>%
  group_by(group, cell_type_abbrev) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create stacked barchart
png(file.path("/home/hhampson/Results/Barchart_Celltypes_by_Group.png"), 
    res = 300, width = 2000, height = 2000)
ggplot(celltype_counts, aes(x = group, y = proportion, fill = cell_type_abbrev)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Disease Group",
    x = "Group",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()

# --- Propeller test: T2D vs LC ---
# propeller needs: clusters, sample, group stored in metadata
# Make sure "group" and "record_id" are columns in so_combined metadata
propeller_group <- propeller(
  clusters = so_combined$cell_type_abbrev,
  sample = so_combined$record_id,
  group = so_combined$group,
  transform = "logit"
)

cat("\n=== Propeller Results: T2D vs Lean Control ===\n")
print(propeller_group)

# Save results
write.csv(propeller_group, "/home/hhampson/Results/Propeller_T2DvsLC_results.csv")

```

### ii. Analysis 
```{r}
# Get cell types to analyze (you may want to exclude off-target populations)
# celltypes <- unique(so_combined$cell_type_abbrev)
celltypes <- unique(so_combined$cell_type_abbrev)
# Optional: filter out specific populations
# celltypes <- celltypes[!celltypes %in% c("Neur", "DMus")]

# Loop through each cell type
for (cell_name in celltypes) {
  
  cat("\n=== Processing:", cell_name, "===\n")
  
  # Subset to current cell type
  so_celltype <- subset(so_combined, cell_type_abbrev == cell_name)
  DefaultAssay(so_celltype) <- "RNA"
  
  StartGenes <- nrow(so_celltype)
  Cells <- ncol(so_celltype)
  
  cat("Genes:", StartGenes, "| Cells:", Cells, "\n")
  
  # Find highly variable genes
  so_celltype <- FindVariableFeatures(so_celltype, 
                                       selection.method = "vst", 
                                       nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  cat("HVGs:", length(hvgs), "\n")
  
  # Get counts for HVGs
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts"))
  genes_list <- hvgs
  
  # Set up parallel processing
  cl <- makeCluster(10)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  
  # Run NEBULA for each gene in parallel
  nebula_results_list <- foreach(g = genes_list, 
                                  .packages = c("nebula", "Matrix")) %dopar% {
    tryCatch({
      count_gene <- counts_hvg[g, , drop = FALSE]
      meta_gene <- subset(so_celltype, features = g)@meta.data
      
      formula <- as.formula("~ group")
      pred_gene <- model.matrix(formula, data = meta_gene)
      library <- meta_gene$pooled_offset
      
      data_g_gene <- group_cell(count = count_gene, 
                                 id = meta_gene$record_id, 
                                 pred = pred_gene, 
                                 offset = library)
      
      if (is.null(data_g_gene)) {
        data_g_gene <- list(count = count_gene, 
                            id = meta_gene$record_id, 
                            pred = pred_gene, 
                            offset = library)
      }
      
      # Run NEBULA with offset
      result <- nebula(count = data_g_gene$count, 
                       id = data_g_gene$id, 
                       pred = data_g_gene$pred, 
                       ncore = 1, 
                       reml = TRUE,
                       model = "NBLMM",
                       output_re = TRUE,
                       covariance = TRUE,
                       offset = data_g_gene$offset)
      
      list(gene = g, result = result)
      
    }, error = function(e) {
      NULL
    })
  }
  
  stopCluster(cl)
  end_time <- Sys.time()
  cat("Time elapsed:", end_time - start_time, "\n")
  
  # Process results
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)
  
  # Check convergence
  nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      data.frame(Gene = gene_name, Convergence_Code = converged)
    }
  )
  
  # Extract summaries
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  
  # Identify non-converged genes
  nonconverge_genes <- unique(
    nebula_converged$Gene[nebula_converged$Convergence_Code %in% c(-40, -50, -60)]
  )
  
  # Format results
  full_results <- as.data.frame(nebula_summaries)
  colnames(full_results) <- c("logFC_Intercept", "logFC", "se_Intercept", 
                               "se", "p_Intercept", "p_value", 
                               "gene_id", "gene")
  
  full_results$Variable <- "T2DvsLC"
  full_results$Celltype <- cell_name
  
  # Calculate number of genes filtered out for low expression
  full_results$low_exp <- length(genes_list) - nrow(full_results)
  
  # Filter non-converged genes
  full_results <- full_results %>% 
    filter(!gene %in% nonconverge_genes)
  
  # Calculate non-convergence rate
  full_results$nebula_nonconverged_percent <- 
    paste0(round((1 - (length(genes_list) - length(nonconverge_genes)) / 
                    length(genes_list)) * 100, 3), "%")
  
  full_results$Cells <- Cells
  full_results$Genes <- nrow(full_results)
  
  # FDR correction
  full_results$fdr <- p.adjust(full_results$p_value, method = "fdr")
  full_results$PValue10 <- -log10(pmax(full_results$p_value, 1e-10))
  
  # Save results
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  output_file <- file.path(paste0("/home/hhampson/Results?NEBULA_T2DvsLC_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
  write.csv(full_results, output_file, row.names = FALSE)
  
  cat("Results saved:", output_file, "\n\n")
  
  # Create volcano plot
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$logFC > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$logFC < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Cells <- Cells  # Already defined earlier in the loop
  Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(full_results$low_exp)[1]
  
  # Get min/max for x-axis
  max_fc <- max(full_results$logFC)
  min_fc <- min(full_results$logFC)
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(full_results, aes(x = logFC, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste("Type 2 Diabetes vs. Lean Controls -", cell_name),
      subtitle = "Organoids, Unadjusted (REML, Log Normal, Offset)",
      x = "Log Fold Change",
      y = "-log10(P-Value)",
      color = "FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, 
                      ", Cells = ", Cells, 
                      ", Non-Convergence Rate: ", Nonconvergence_Rate,
                      ", Genes Filtered for Low Expression: ", low_exp)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(-3, 3) +
    geom_text(data = significant_df, aes(label = gene),
              vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  
  # Save volcano plot
  plot_file <- file.path(paste0("/home/hhampson/Results/Plot_Organoid_NEBULA_", cell_name_clean, 
                                "_T2DvsLC_unadjusted_2000.png"))
  png(plot_file, width = 3000, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  
  cat("Plot saved:", plot_file, "\n\n")
}

cat("\n=== NEBULA Analysis Complete ===\n")

#Load in all the celltype results & make a nice figure
# Initialize empty list to store results
all_results <- list()
celltypes <- unique(so_combined$cell_type_abbrev)
for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
 # Check if file exists before reading
  if (file.exists(input_file)) {
    file <- read.csv(input_file)
    file$cell_type <- cell_name  # Add cell type column
    all_results[[cell_name]] <- file
    cat("Loaded:", cell_name, "- Genes:", nrow(file), "\n")
  } else {
    cat("File not found:", input_file, "\n")
  }

  
  # Combine all results into one dataframe
combined_results <- bind_rows(all_results)

# Count positive and negative DE genes per cell type
# Assuming you have logFC and p_adj columns
de_summary <- combined_results %>%
  filter(fdr < 0.05) %>%  # Adjust column name as needed
  mutate(direction = ifelse(logFC > 0, "Positive", "Negative")) %>%  # Adjust column name
  group_by(cell_type, direction) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(count = ifelse(direction == "Negative", -count, count))

# Create the plot
ggplot(de_summary, aes(x = count, y = reorder(cell_type, abs(count)), fill = direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Negative" = "#A8C9D9", "Positive" = "#E89A9A")) +
  geom_vline(xintercept = 0, color = "black", size = 0.5) +
  geom_hline(yintercept = 9.5, linetype = "dotted", color = "black", size = 0.5) +
  labs(x = "Number of DE genes", 
       y = NULL,
       fill = NULL) +
  theme_minimal() +
 theme(
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.length.x = unit(0.2, "cm"),
    legend.position = "top",
    legend.text = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = c(-500,-250, 0, 250,500),
                     labels = c(500,250, 0, 250, 500),
                     limits = c(-600, 600))

# Save the plot
ggsave("/home/hhampson/Results/DE_genes_by_celltype_barplot.png", 
       width = 8, height = 6, dpi = 300)
}
```

### iii. GSEA 
#### a. Reactome
```{r}
celltypes <- unique(so_combined$cell_type_abbrev)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # Create ranked gene list
  rankings <- full_results$logFC
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  cat("Ranked genes:", length(rankings), "| LogFC range:", 
      round(min(rankings), 3), "to", round(max(rankings), 3), "\n")
  
  # Run fgsea
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  cat("Significant pathways (padj < 0.05):", sum(reactome_res[, padj < 0.05]), "\n")
  cat("Significant pathways (pval < 0.05):", sum(reactome_res[, pval < 0.05]), "\n")
  
  # Save results
  saveRDS(reactome_res, file.path(dir.gsea, paste0(cell_name_clean, "_T2DvsLC_Reactome.rds")))
  
  # Plot
  n_sig <- sum(reactome_res$pval < 0.05)
  
if (n_sig > 0) {
    plot_height <- min(10, max(4, 3 + 0.3 * min(n_sig, 20)))
    max_nes <- ceiling(max(abs(reactome_res$NES[reactome_res$pval < 0.05])) + 0.5)
    
    p <- plot_fgsea_transpose(reactome_res, 
                              title = paste0(cell_name, " Top 20 REACTOME (T2D vs LC)"),
                              xlimit = max_nes)
    
    ggsave(file.path(dir.gsea, paste0(cell_name_clean, "_T2DvsLC_Reactome.png")),
           plot = p, width = 16, height = plot_height, dpi = 300)
  } else {
    cat("No significant pathways (pval < 0.05) for", cell_name, "\n")
  }
  
  cat("Saved:", cell_name, "\n")
}

cat("\n=== GSEA Reactome Analysis Complete ===\n")

```

#### b. KEGG
```{r}
# Download KEGG GMT
temp_file_kegg <- tempfile(fileext = ".gmt")
s3$download_file("gsea", "gmt_files/c2.cp.kegg_legacy.v2024.1.Hs.symbols.gmt", temp_file_kegg)
kegg_sets <- gmtPathways(temp_file_kegg)
cat("Loaded", length(kegg_sets), "KEGG gene sets\n")

# Output directory
dir.gsea.kegg <- "/home/hhampson/Results/GSEA_T2DvsLC_KEGG"
dir.create(dir.gsea.kegg, recursive = TRUE)

celltypes <- unique(so_combined$cell_type_abbrev)
for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # Create ranked gene list
  rankings <- full_results$logFC
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  cat("Ranked genes:", length(rankings), "| LogFC range:", 
      round(min(rankings), 3), "to", round(max(rankings), 3), "\n")
  
  # Run fgsea
  set.seed(1234)
  kegg_res <- fgsea(pathways = kegg_sets,
                    stats = rankings,
                    scoreType = 'std',
                    minSize = 3,
                    maxSize = 500,
                    nproc = 1,
                    nPermSimple = 10000)
  
  cat("Significant pathways (padj < 0.05):", sum(kegg_res[, padj < 0.05]), "\n")
  cat("Significant pathways (pval < 0.05):", sum(kegg_res[, pval < 0.05]), "\n")
  
  # Save results
  saveRDS(kegg_res, file.path(dir.gsea.kegg, paste0(cell_name_clean, "_T2DvsLC_KEGG.rds")))
  
  # Plot - function handles pval filtering internally
  n_sig <- sum(kegg_res$pval < 0.05)
  
if (n_sig > 0) {
    plot_height <- min(10, max(4, 3 + 0.3 * min(n_sig, 20)))
    max_nes <- ceiling(max(abs(kegg_res$NES[kegg_res$pval < 0.05])) + 0.5)
    
    p <- plot_fgsea_transpose(kegg_res, 
                              title = paste0(cell_name, " Top 20 KEGG (T2D vs LC)"),
                              xlimit = max_nes)
    
    ggsave(file.path(dir.gsea.kegg, paste0(cell_name_clean, "_T2DvsLC_KEGG.png")),
           plot = p, width = 16, height = plot_height, dpi = 300)
  } else {
    cat("No significant pathways (pval < 0.05) for", cell_name, "\n")
  }
  
  cat("Saved:", cell_name, "\n")
}

cat("\n=== GSEA KEGG Analysis Complete ===\n")

```

#### c. GO
```{r}
# Download GO GMT
temp_file_go <- tempfile(fileext = ".gmt")
s3$download_file("gsea", "gmt_files/c5.go.v2024.1.Hs.symbols.gmt", temp_file_go)
go_sets <- gmtPathways(temp_file_go)
cat("Loaded", length(go_sets), "GO gene sets\n")

# Output directory
dir.gsea.go <- "/home/hhampson/Results/GSEA_T2DvsLC_GO"
dir.create(dir.gsea.go, recursive = TRUE)

celltypes <- unique(so_combined$cell_type_abbrev)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # Create ranked gene list
  rankings <- full_results$logFC
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  cat("Ranked genes:", length(rankings), "| LogFC range:", 
      round(min(rankings), 3), "to", round(max(rankings), 3), "\n")
  
  # Run fgsea
  set.seed(1234)
  go_res <- fgsea(pathways = go_sets,
                  stats = rankings,
                  scoreType = 'std',
                  minSize = 5,
                  maxSize = 500,
                  nproc = 1,
                  nPermSimple = 10000)
  
  cat("Significant pathways (padj < 0.05):", sum(go_res[, padj < 0.05]), "\n")
  cat("Significant pathways (pval < 0.05):", sum(go_res[, pval < 0.05]), "\n")
  
  # Save results
  saveRDS(go_res, file.path(dir.gsea.go, paste0(cell_name_clean, "_T2DvsLC_GO.rds")))
  
  # Plot
  n_sig <- sum(go_res$pval < 0.05)
  
if (n_sig > 0) {
    plot_height <- min(10, max(4, 3 + 0.3 * min(n_sig, 20)))
    
    # Dynamic xlimit based on actual data
    max_nes <- ceiling(max(abs(go_res$NES[go_res$pval < 0.05])) + 0.5)
    
    p <- plot_fgsea_transpose(go_res, 
                              title = paste0(cell_name, " Top 20 GO (T2D vs LC)"),
                              xlimit = max_nes)
    
    ggsave(file.path(dir.gsea.go, paste0(cell_name_clean, "_T2DvsLC_GO.png")),
           plot = p, width = 16, height = plot_height, dpi = 300)
  } else {
    cat("No significant pathways (pval < 0.05) for", cell_name, "\n")
  }
  
  cat("Saved:", cell_name, "\n")
}

cat("\n=== GSEA GO Analysis Complete ===\n")



```

### iv. Combine Plots
####a. DiD Plot
```{r}
library(tidyverse)

# Cell types to analyze
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

# Initialize list to store category counts
all_category_counts <- list()

# Process each cell type
for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  full_results <- read.csv(input_file)
  
  # Categorize based on DiD
  did_categories <- full_results %>%
    mutate(
      # DiD and treatment direction
      DiD = `logFC_groupType.2.Diabetes.treatment30`,
      DiD_fdr = `fdr_groupType.2.Diabetes.treatment30`,
      Treatment_effect = logFC_treatment30,
      Treatment_fdr = fdr_treatment30,
      
      # Four DiD categories
      did_category = case_when(
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in T2D",
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in T2D",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in LC",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in LC",
        TRUE ~ "Not Significant"
      )
    )
  
  # Count categories
  category_counts <- did_categories %>%
    dplyr::count(did_category) %>%
    mutate(celltype = cell_name)
  
  all_category_counts[[cell_name]] <- category_counts
}

# Combine all results
combined_counts <- bind_rows(all_category_counts)

#[1] "Prolif"  "DMus"    "EEC"     "Neur"    "DPEC"    "DT"      "Mes"     "MesV"    "DKE"     "PEC_N"   "Strom"   "MusV"    "NsKE"   
# [14] "ProlPod"

# Order cell types by total significant DiD genes
celltype_order <- combined_counts %>%
  filter(did_category != "Not Significant") %>%
  group_by(celltype) %>%
  summarize(total_sig = sum(n)) %>%
  arrange(desc(total_sig)) %>%
  pull(celltype)

celltype_order <- c(celltype_order,"MusV","NsKE")

combined_counts$celltype <- factor(combined_counts$celltype, levels = celltype_order)

# Define category order and colors
combined_counts$did_category <- factor(combined_counts$did_category, 
                                       levels = c("Glucose upregulates MORE in T2D",
                                                  "Glucose downregulates LESS in T2D",
                                                  "Glucose upregulates MORE in LC",
                                                  "Glucose downregulates LESS in LC",
                                                  "Not Significant"))

category_colors <- c(
  "Glucose upregulates MORE in T2D" = "#DC143C",        # Dark red (matching "All Three Effects")
  "Glucose downregulates LESS in T2D" = "#FFA07A",      # Light pink/salmon (matching "Interaction + Treatment")
  "Glucose upregulates MORE in LC" = "#4682B4",         # Dark blue (matching "Group + Treatment")
  "Glucose downregulates LESS in LC" = "#B0C4DE",       # Light blue (matching "Treatment Only")
  "Not Significant" = "#D3D3D3"                         # Light gray
)

# Create stacked bar plot
p <- ggplot(combined_counts, aes(x = celltype, y = n, fill = did_category)) +
  geom_bar(stat = "identity", width = 0.8) +
  scale_fill_manual(
    values = category_colors,
    name = "DiD Pattern",
    labels = c(
      "Glucose upregulates MORE in T2D" = "Upregulates MORE in T2D",
      "Glucose downregulates LESS in T2D" = "Downregulates LESS in T2D",
      "Glucose upregulates MORE in LC" = "Upregulates MORE in LC",
      "Glucose downregulates LESS in LC" = "Downregulates LESS in LC",
      "Not Significant" = "Not Significant"
    )
  ) +
  labs(
    title = "Differential Glucose Response Patterns: T2D vs LC (Difference-in-Differences)",
    subtitle = "Genes categorized by glucose treatment interaction effect",
    x = "Cell Type",
    y = "Number of Genes",
    caption = "FDR < 0.05"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 11),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 11),
    legend.position = "right",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    plot.caption = element_text(hjust = 1, size = 9)
  )

print(p)

# Save plot
ggsave("/home/hhampson/Results/DiD_CategoryCounts_StackedBar_AllCelltypes.png", 
       plot = p, width = 12, height = 8, dpi = 300)

# Also create summary table
summary_table <- combined_counts %>%
  pivot_wider(names_from = did_category, values_from = n, values_fill = 0) %>%
  arrange(desc(`Glucose upregulates MORE in T2D`))

write.csv(summary_table, 
          "/home/hhampson/Results/DiD_CategoryCounts_Summary.csv", 
          row.names = FALSE)


# Create stacked bar plot (only significant interactions)
p <- ggplot(sig_counts, aes(x = celltype, y = n, fill = did_category)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(
    values = category_colors,
    name = "Interaction Pattern"
  ) +
  labs(
    title = "Genes with Significant Interaction Effects",
    subtitle = "Diabetes-specific glucose responses by cell type",
    x = "Cell Type",
    y = "Number of Genes",
    caption = "FDR < 0.05 for interaction term"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 11),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 11),
    legend.position = "right",
    legend.title = element_text(size = 11, face = "bold"),
    legend.text = element_text(size = 10),
    panel.grid.major.x = element_blank(),
    plot.caption = element_text(hjust = 1, size = 9)
  )

print(p)

# Save plot
ggsave("/home/hhampson/Results/DiD_SignificantOnly_StackedBar_AllCelltypes.png", 
       plot = p, width = 10, height = 7, dpi = 300)

# Also create summary table
summary_table <- sig_counts %>%
  pivot_wider(names_from = did_category, values_from = n, values_fill = 0) %>%
  arrange(desc(`Glucose upregulates MORE in T2D`))

write.csv(summary_table, 
          "/home/hhampson/Results/DiD_SignificantOnly_Summary.csv", 
          row.names = FALSE)

cat("\n=== Significant-only stacked bar plot complete ===\n")

```

####b. DiD Volcano Plot + GSEA
#####1. Method 1
```{r}
library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Cell types to analyze
# celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")
celltypes <- celltype_order 
# Color scheme
category_colors <- c(
  "Glucose upregulates MORE in T2D" = "#DC143C",
  "Glucose downregulates LESS in T2D" = "#FFA07A",
  "Glucose upregulates MORE in LC" = "#4682B4",
  "Glucose downregulates LESS in LC" = "#B0C4DE",
  "Not Significant" = "#D3D3D3"
)

# Open PDF - one page per cell type
pdf("/home/hhampson/Results/DiD_Volcano_GSEA_AllCelltypes.pdf", 
    width = 22, height = 10)

for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- CATEGORIZE GENES ----
  did_results <- full_results %>%
    mutate(
      # DiD = interaction coefficient
      DiD = `logFC_groupType.2.Diabetes.treatment30`,
      DiD_pval = `p_groupType.2.Diabetes.treatment30`,
      DiD_fdr = `fdr_groupType.2.Diabetes.treatment30`,
      DiD_pval10 = `PValue10_groupType.2.Diabetes.treatment30`,
      
      # Treatment main effect
      Treatment_effect = logFC_treatment30,
      
      # Four DiD categories
      did_category = case_when(
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in T2D",
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in T2D",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in LC",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in LC",
        TRUE ~ "Not Significant"
      ),
      
      # Assign colors
      color = case_when(
        did_category == "Glucose upregulates MORE in T2D" ~ "#DC143C",
        did_category == "Glucose downregulates LESS in T2D" ~ "#FFA07A",
        did_category == "Glucose upregulates MORE in LC" ~ "#4682B4",
        did_category == "Glucose downregulates LESS in LC" ~ "#B0C4DE",
        TRUE ~ "#D3D3D3"
      )
    )
  
  # ---- VOLCANO PLOT ----
  
  # Dynamic axis limits
  did_range <- range(did_results$DiD, na.rm = TRUE)
  did_padding <- diff(did_range) * 0.1
  xlim_min <- did_range[1] - did_padding
  xlim_max <- did_range[2] + did_padding
  
  pval_max <- max(did_results$DiD_pval10, na.rm = TRUE)
  ylim_max <- pval_max * 1.05
  
  # Label significant genes
  sig_genes <- did_results %>% 
    filter(DiD_fdr < 0.05)
  
  # Count genes in each category
  n_up_t2d <- sum(did_results$did_category == "Glucose upregulates MORE in T2D")
  n_down_less_t2d <- sum(did_results$did_category == "Glucose downregulates LESS in T2D")
  n_up_lc <- sum(did_results$did_category == "Glucose upregulates MORE in LC")
  n_down_less_lc <- sum(did_results$did_category == "Glucose downregulates LESS in LC")
  
  volcano_plot <- ggplot(did_results, aes(x = DiD, y = DiD_pval10, color = color)) +
    geom_point(alpha = 0.7, size = 2) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - Glucose Treatment Interaction (DiD)"),
      subtitle = paste0("T2D up: ", n_up_t2d, " | T2D resistant: ", n_down_less_t2d, 
                        " | LC up: ", n_up_lc, " | LC resistant: ", n_down_less_lc),
      x = "Difference-in-Differences (logFC)\n[Treatment Effect in T2D] - [Treatment Effect in LC]",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10)
    ) +
    xlim(xlim_min, xlim_max) +
    ylim(0, ylim_max) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", alpha = 0.3, linewidth = 0.5) +
    geom_text_repel(data = sig_genes, aes(label = Gene),
                    size = 2.5, color = "black", max.overlaps = 10,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- GSEA (Reactome) ----
  
  # Rank genes by DiD (interaction coefficient)
  rankings <- did_results$DiD
  names(rankings) <- did_results$Gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  # Prepare GSEA plot data
  gsea_plot_data <- reactome_res %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50),
      
      # Color pathways by direction (similar to volcano)
      pathway_color = case_when(
        NES > 0 ~ "darkred",  # Positive NES = enriched in T2D-specific up response
        NES < 0 ~ "#4682B4"   # Negative NES = enriched in LC-specific up response
      )
    )
  
  if (nrow(gsea_plot_data) > 0) {
    # Dynamic NES axis limit
    max_nes <- max(abs(gsea_plot_data$NES), na.rm = TRUE)
    nes_limit <- max_nes * 1.05
    
    gsea_plot <- ggplot(gsea_plot_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                             fill = pathway_color, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_identity() +
      scale_alpha_continuous(range = c(0.6, 1), guide = "none") +
      scale_x_continuous(limits = c(0, nes_limit), expand = expansion(mult = c(0, 0.01))) +
      labs(
        title = paste0(cell_name, " - Top 20 Reactome Pathways (p < 0.05)"),
        subtitle = "Pathways enriched in differential glucose responses",
        x = "Normalized Enrichment Score (NES)",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank()
      ) +
      # Add legend
      annotate("rect", xmin = nes_limit * 0.7, xmax = nes_limit * 0.75,
               ymin = 19, ymax = 19.5, fill = "darkred", alpha = 0.7) +
      annotate("text", x = nes_limit * 0.77, y = 19.25,
               label = "Stronger in T2D response", hjust = 0, size = 3) +
      annotate("rect", xmin = nes_limit * 0.7, xmax = nes_limit * 0.75,
               ymin = 18, ymax = 18.5, fill = "#4682B4", alpha = 0.7) +
      annotate("text", x = nes_limit * 0.77, y = 18.25,
               label = "Stronger in LC response", hjust = 0, size = 3)
    
    # Combine side by side
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    # No significant GSEA
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
               label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - Reactome Pathways")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== DiD volcano + GSEA plots complete ===\n")

```

#####2. Method 2
```{r}
library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Cell types to analyze
# celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")
celltypes <- celltype_order 

# Color scheme
category_colors <- c(
  "Glucose upregulates MORE in T2D" = "#DC143C",
  "Glucose downregulates LESS in T2D" = "#FFA07A",
  "Glucose upregulates MORE in LC" = "#4682B4",
  "Glucose downregulates LESS in LC" = "#B0C4DE"
)

# Open PDF
pdf("/home/hhampson/Results/DiD_DGSEA_Comparative_AllCelltypes.pdf", 
    width = 22, height = 10)

for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- CATEGORIZE GENES ----
  did_results <- full_results %>%
    mutate(
      DiD = `logFC_groupType.2.Diabetes.treatment30`,
      DiD_pval = `p_groupType.2.Diabetes.treatment30`,
      DiD_fdr = `fdr_groupType.2.Diabetes.treatment30`,
      DiD_pval10 = `PValue10_groupType.2.Diabetes.treatment30`,
      Treatment_effect = logFC_treatment30,
      Group_effect = logFC_groupType.2.Diabetes,
      
      # Calculate treatment effect in each group separately
      # Treatment in T2D = Treatment main + Interaction
      Treatment_T2D = Treatment_effect + DiD,
      # Treatment in LC = Treatment main effect only
      Treatment_LC = Treatment_effect,
      
      did_category = case_when(
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in T2D",
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in T2D",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in LC",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in LC",
        TRUE ~ "Not Significant"
      ),
      
      color = case_when(
        did_category == "Glucose upregulates MORE in T2D" ~ "#DC143C",
        did_category == "Glucose downregulates LESS in T2D" ~ "#FFA07A",
        did_category == "Glucose upregulates MORE in LC" ~ "#4682B4",
        did_category == "Glucose downregulates LESS in LC" ~ "#B0C4DE",
        TRUE ~ "#D3D3D3"
      )
    )
  
  # ---- VOLCANO PLOT ----
  did_range <- range(did_results$DiD, na.rm = TRUE)
  did_padding <- diff(did_range) * 0.1
  xlim_min <- did_range[1] - did_padding
  xlim_max <- did_range[2] + did_padding
  
  pval_max <- max(did_results$DiD_pval10, na.rm = TRUE)
  ylim_max <- pval_max * 1.05
  
  sig_genes <- did_results %>% filter(DiD_fdr < 0.05)
  
  n_up_t2d <- sum(did_results$did_category == "Glucose upregulates MORE in T2D")
  n_down_less_t2d <- sum(did_results$did_category == "Glucose downregulates LESS in T2D")
  n_up_lc <- sum(did_results$did_category == "Glucose upregulates MORE in LC")
  n_down_less_lc <- sum(did_results$did_category == "Glucose downregulates LESS in LC")
  
  volcano_plot <- ggplot(did_results, aes(x = DiD, y = DiD_pval10, color = color)) +
    geom_point(alpha = 0.7, size = 2) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - Glucose Treatment Interaction (DiD)"),
      subtitle = paste0("T2D up: ", n_up_t2d, " | T2D resistant: ", n_down_less_t2d, 
                        " | LC up: ", n_up_lc, " | LC resistant: ", n_down_less_lc),
      x = "Difference-in-Differences (logFC)",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10)
    ) +
    xlim(xlim_min, xlim_max) +
    ylim(0, ylim_max) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", alpha = 0.3, linewidth = 0.5) +
    geom_text_repel(data = sig_genes, aes(label = Gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- DGSEA: Comparative Enrichment ----
  
  # Rank genes by treatment effect in T2D
  rankings_T2D <- did_results$Treatment_T2D
  names(rankings_T2D) <- did_results$Gene
  rankings_T2D <- sort(rankings_T2D, decreasing = TRUE)
  
  # Rank genes by treatment effect in LC
  rankings_LC <- did_results$Treatment_LC
  names(rankings_LC) <- did_results$Gene
  rankings_LC <- sort(rankings_LC, decreasing = TRUE)
  
  # Run GSEA for T2D
  set.seed(1234)
  gsea_T2D <- fgsea(pathways = reactome_sets,
                    stats = rankings_T2D,
                    scoreType = 'std',
                    minSize = 3,
                    maxSize = 500,
                    nproc = 1,
                    nPermSimple = 10000)
  
  # Run GSEA for LC
  set.seed(1234)
  gsea_LC <- fgsea(pathways = reactome_sets,
                   stats = rankings_LC,
                   scoreType = 'std',
                   minSize = 3,
                   maxSize = 500,
                   nproc = 1,
                   nPermSimple = 10000)
  
  # Merge results and calculate differential enrichment
  dgsea_results <- gsea_T2D %>%
    dplyr::select(pathway, NES_T2D = NES, pval_T2D = pval, padj_T2D = padj) %>%
    left_join(
      gsea_LC %>% dplyr::select(pathway, NES_LC = NES, pval_LC = pval, padj_LC = padj),
      by = "pathway"
    ) %>%
    mutate(
      # Calculate difference in NES
      diff_NES = NES_T2D - NES_LC,
      
      # Both must be significant OR difference must be large
      is_significant = (padj_T2D < 0.05 | padj_LC < 0.05) & abs(diff_NES) > 0.5,
      
      # Calculate mean NES direction
      mean_NES = (NES_T2D + NES_LC) / 2,
      
      # Categorize based on which group has stronger enrichment and direction
      pathway_category = case_when(
        diff_NES > 0 & mean_NES > 0 ~ "Glucose upregulates MORE in T2D",
        diff_NES > 0 & mean_NES < 0 ~ "Glucose downregulates LESS in T2D",
        diff_NES < 0 & mean_NES > 0 ~ "Glucose upregulates MORE in LC",
        diff_NES < 0 & mean_NES < 0 ~ "Glucose downregulates LESS in LC",
        TRUE ~ "Unclear"
      )
    )
  
  # Prepare plot data
  gsea_plot_data <- dgsea_results %>%
    filter(is_significant) %>%
    arrange(desc(abs(diff_NES))) %>%
    head(20) %>%
    mutate(
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50),
      
      # Assign colors
      pathway_color = case_when(
        pathway_category == "Glucose upregulates MORE in T2D" ~ "#DC143C",
        pathway_category == "Glucose downregulates LESS in T2D" ~ "#FFA07A",
        pathway_category == "Glucose upregulates MORE in LC" ~ "#4682B4",
        pathway_category == "Glucose downregulates LESS in LC" ~ "#B0C4DE",
        TRUE ~ "#999999"
      )
    )
  
  if (nrow(gsea_plot_data) > 0) {
    max_diff <- max(abs(gsea_plot_data$diff_NES), na.rm = TRUE)
    diff_limit <- max_diff * 1.05
    
    gsea_plot <- ggplot(gsea_plot_data, 
                        aes(x = abs(diff_NES), y = reorder(pathway_clean, abs(diff_NES)),
                            fill = pathway_color, alpha = abs(diff_NES))) +
      geom_col(width = 0.7) +
      scale_fill_identity() +
      scale_alpha_continuous(range = c(0.6, 1), guide = "none") +
      scale_x_continuous(limits = c(0, diff_limit), expand = expansion(mult = c(0, 0.01))) +
      labs(
        title = paste0(cell_name, " - Top 20 Differential Pathways (DGSEA)"),
        subtitle = "Comparing enrichment in T2D vs LC glucose responses",
        x = "Differential Enrichment (|NES_T2D - NES_LC|)",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank()
      )
    
    # Combine
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
               label = "No significantly differential\npathways",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - DGSEA")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== DGSEA comparative enrichment plots complete ===\n")

```

####c. Volcano Plots Mixed
```{r}
library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# celltypes <- unique(so_combined$cell_type_abbrev)
#Do cell types in order of most to lease degs
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

# Open PDF - one page per cell type
pdf("/home/hhampson/Results/T2DvsLC_Volcano_GSEA_AllCelltypes.pdf", width = 22, height = 10)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- VOLCANO PLOT ----
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$logFC > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$logFC < 0, "#003366", "gray"))
  
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(full_results$low_exp)[1]
  n_cells <- unique(full_results$Cells)[1]
  
  volcano_plot <- ggplot(full_results, aes(x = logFC, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - T2D vs LC"),
      subtitle = paste0("Genes = ", Genes, " | Cells = ", n_cells, 
                        " | Non-Conv: ", Nonconvergence_Rate),
      x = "Log Fold Change",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10)
    ) +
    xlim(-3, 3) +
    geom_text_repel(data = significant_df, aes(label = gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- GSEA (Reactome) ----
  rankings <- full_results$logFC
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  # Prepare GSEA plot data
  gsea_plot_data <- reactome_res %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      direction = ifelse(NES > 0, "Positive", "Negative"),
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(gsea_plot_data) > 0) {
    max_nes <- ceiling(max(abs(gsea_plot_data$NES)) + 0.5)
    
    gsea_plot <- ggplot(gsea_plot_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                             fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, max_nes), expand = expansion(mult = c(0, 0.02))) +
      labs(
        title = paste0(cell_name, " - Top 20 Reactome (p < 0.05)"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
    
    # Combine side by side
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    # No significant GSEA - just print volcano with a note
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - Reactome")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== PDF Complete ===\n")

```

## b. Perform differential expression between T2D & LC in organoid samples (pooled by glucose conc. with glucose treatment interaction effect term in model)
### i. Pre-Analysis Steps
```{r}
# Verify dimensions
nrow(so_combined) # genes 7383
ncol(so_combined) # cells 137604

# Check your metadata
table(so_combined$group)
table(so_combined$treatment)
table(so_combined$cell_type_abbrev)
head(so_combined@meta.data[, c("group", "cell_type_abbrev", "record_id", "treatment")])

# Make sure group is a factor with LC as reference
so_combined$treatment <- factor(so_combined$treatment)
so_combined$treatment <- relevel(so_combined$treatment, ref = "15")

# Prepare data for cell type distribution plot
celltype_counts <- so_combined@meta.data %>%
  group_by(group, treatment, cell_type_abbrev) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(group, treatment) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create stacked barchart by group and treatment
png("/home/hhampson/Results/Barchart_Celltypes_by_Group_Treatment.png", 
    res = 300, width = 2500, height = 2000)
ggplot(celltype_counts, aes(x = interaction(group, treatment), y = proportion, fill = cell_type_abbrev)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Treatment Group and Glucose Concentration",
    x = "Group x Treatment",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()

```

### ii. Analysis
```{r}
# Get cell types to analyze
celltypes <- unique(so_combined$cell_type_abbrev)

# Loop through each cell type
for (cell_name in celltypes) {
  
  cat("\n=== Processing:", cell_name, "===\n")
  
  # Subset to current cell type
  so_celltype <- subset(so_combined, cell_type_abbrev == cell_name)
  DefaultAssay(so_celltype) <- "RNA"
  
  StartGenes <- nrow(so_celltype)
  Cells <- ncol(so_celltype)
  
  cat("Genes:", StartGenes, "| Cells:", Cells, "\n")
  
  # Find highly variable genes
  so_celltype <- FindVariableFeatures(so_celltype, 
                                       selection.method = "vst", 
                                       nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  cat("HVGs:", length(hvgs), "\n")
  
  # Get counts for HVGs
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts"))
  genes_list <- hvgs
  
  # Set up parallel processing
  cl <- makeCluster(10)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  
  # Run NEBULA for each gene in parallel
# Run NEBULA for each gene in parallel
nebula_results_list <- foreach(g = genes_list, 
                                .packages = c("nebula", "Matrix")) %dopar% {
  tryCatch({
    count_gene <- counts_hvg[g, , drop = FALSE]
    meta_gene <- subset(so_celltype, features = g)@meta.data
    
    # MODEL WITH INTERACTION: group + treatment + group:treatment
    formula <- as.formula("~ group + treatment + group:treatment")
    pred_gene <- model.matrix(formula, data = meta_gene)
    library <- meta_gene$pooled_offset
    
    # CRITICAL: Sort by record_id to group cells from same subject
    sort_order <- order(meta_gene$record_id)
    count_gene_sorted <- count_gene[, sort_order, drop = FALSE]
    meta_gene_sorted <- meta_gene[sort_order, ]
    pred_gene_sorted <- pred_gene[sort_order, , drop = FALSE]
    library_sorted <- library[sort_order]
    
    # Create data structure with sorted data
    data_g_gene <- list(count = count_gene_sorted, 
                        id = meta_gene_sorted$record_id, 
                        pred = pred_gene_sorted, 
                        offset = library_sorted)
    
    # Run NEBULA with offset
    result <- nebula(count = data_g_gene$count, 
                     id = data_g_gene$id, 
                     pred = data_g_gene$pred, 
                     ncore = 1, 
                     reml = TRUE,
                     model = "NBLMM",
                     output_re = TRUE,
                     covariance = TRUE,
                     offset = data_g_gene$offset)
    
    list(gene = g, result = result)
    
  }, error = function(e) {
    NULL
  })
}
  
  stopCluster(cl)
  end_time <- Sys.time()
  cat("Time elapsed:", end_time - start_time, "\n")
  
  # Process results
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)
  
  # Check convergence
  nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      data.frame(Gene = gene_name, Convergence_Code = converged)
    }
  )
  
  # Extract summaries
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  
  # Identify non-converged genes
  nonconverge_genes <- unique(
    nebula_converged$Gene[nebula_converged$Convergence_Code %in% c(-40, -50, -60)]
  )
  
  # Format results - DON'T rename columns yet, keep original names
  full_results <- as.data.frame(nebula_summaries)
  
  # Add metadata columns
  full_results$Variable <- "T2DvsLC_with_treatment_interaction"
  full_results$Celltype <- cell_name
  
  # Calculate number of genes filtered out for low expression
  full_results$low_exp <- length(genes_list) - nrow(full_results)
  
  # Filter non-converged genes
  full_results <- full_results %>% 
    filter(!Gene %in% nonconverge_genes)
  
  # Calculate non-convergence rate
  full_results$nebula_nonconverged_percent <- 
    paste0(round((1 - (length(genes_list) - length(nonconverge_genes)) / 
                    length(genes_list)) * 100, 3), "%")
  
  full_results$Cells <- Cells
  full_results$Genes <- nrow(full_results)
  
  # FDR correction for each coefficient
  # Identify which columns are p-values (start with "p_")
  pval_cols <- grep("^p_", names(full_results), value = TRUE)
  
  for (pval_col in pval_cols) {
    fdr_col_name <- paste0("fdr_", gsub("^p_", "", pval_col))
    full_results[[fdr_col_name]] <- p.adjust(full_results[[pval_col]], method = "fdr")
    
    # Also create -log10 p-value columns
    pval10_col_name <- paste0("PValue10_", gsub("^p_", "", pval_col))
    full_results[[pval10_col_name]] <- -log10(pmax(full_results[[pval_col]], 1e-10))
  }
  
  # Save results with all coefficients
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  output_file <- file.path("/home/hhampson/Results", 
                           paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
  write.csv(full_results, output_file, row.names = FALSE)
  
  cat("Results saved:", output_file, "\n")
  
  # Create volcano plots for each coefficient
  # Find logFC and p-value columns for group effect
  group_logfc_col <- grep("^logFC_group", names(full_results), value = TRUE)[1]
  group_pval_col <- grep("^p_group", names(full_results), value = TRUE)[1]
  group_fdr_col <- grep("^fdr_group", names(full_results), value = TRUE)[1]
  group_pval10_col <- grep("^PValue10_group", names(full_results), value = TRUE)[1]
  
  if (!is.na(group_logfc_col) && !is.na(group_pval10_col)) {
    # Create volcano plot for main group effect
    full_results$color_group <- ifelse(full_results[[group_fdr_col]] < 0.05 & full_results[[group_logfc_col]] > 0, "#990000",
                                       ifelse(full_results[[group_fdr_col]] < 0.05 & full_results[[group_logfc_col]] < 0, "#003366", "gray"))
    
    significant_df_group <- full_results[full_results[[group_fdr_col]] < 0.05, ]
    
    Genes <- length(unique(full_results$Gene))
    Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
    low_exp <- unique(full_results$low_exp)[1]
    
    volcano_plot_group <- ggplot(full_results, aes(x = .data[[group_logfc_col]], y = .data[[group_pval10_col]], color = color_group)) +
      geom_point(alpha = 0.7) +
      scale_color_identity() +
      theme_minimal() +
      labs(
        title = paste("Type 2 Diabetes vs. Lean Controls (Main Effect) -", cell_name),
        subtitle = "Organoids, With Treatment Interaction (REML, Log Normal, Offset)",
        x = "Log Fold Change",
        y = "-log10(P-Value)",
        color = "FC Direction",
        caption = paste0("FDR < 0.05, Genes = ", Genes, 
                        ", Cells = ", Cells, 
                        ", Non-Convergence Rate: ", Nonconvergence_Rate,
                        ", Genes Filtered for Low Expression: ", low_exp)
      ) +
      theme(
        plot.title = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, hjust = 1)
      ) +
      xlim(-3, 3) +
      geom_text(data = significant_df_group, aes(label = Gene),
                vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    
    plot_file_group <- file.path("/home/hhampson/Results", 
                                 paste0("Plot_Organoid_NEBULA_", cell_name_clean, 
                                        "_T2DvsLC_interaction_maineffect_2000.png"))
    png(plot_file_group, width = 3000, height = 2100, res = 300)
    print(volcano_plot_group)
    dev.off()
    
    cat("Main effect plot saved:", plot_file_group, "\n")
  }
  
  # Create volcano plot for interaction effect
  interaction_logfc_col <- grep("^logFC_.*:.*treatment", names(full_results), value = TRUE)[1]
  interaction_pval_col <- grep("^p_.*:.*treatment", names(full_results), value = TRUE)[1]
  interaction_fdr_col <- grep("^fdr_.*:.*treatment", names(full_results), value = TRUE)[1]
  interaction_pval10_col <- grep("^PValue10_.*:.*treatment", names(full_results), value = TRUE)[1]
  
  if (!is.na(interaction_logfc_col) && !is.na(interaction_pval10_col)) {
    full_results$color_interaction <- ifelse(full_results[[interaction_fdr_col]] < 0.05 & full_results[[interaction_logfc_col]] > 0, "#990000",
                                             ifelse(full_results[[interaction_fdr_col]] < 0.05 & full_results[[interaction_logfc_col]] < 0, "#003366", "gray"))
    
    significant_df_interaction <- full_results[full_results[[interaction_fdr_col]] < 0.05, ]
    
    volcano_plot_interaction <- ggplot(full_results, aes(x = .data[[interaction_logfc_col]], y = .data[[interaction_pval10_col]], color = color_interaction)) +
      geom_point(alpha = 0.7) +
      scale_color_identity() +
      theme_minimal() +
      labs(
        title = paste("T2D x Treatment Interaction Effect -", cell_name),
        subtitle = "Organoids, Interaction Term (REML, Log Normal, Offset)",
        x = "Log Fold Change (Interaction)",
        y = "-log10(P-Value)",
        color = "FC Direction",
        caption = paste0("FDR < 0.05, Genes = ", Genes, 
                        ", Cells = ", Cells, 
                        ", Non-Convergence Rate: ", Nonconvergence_Rate,
                        ", Genes Filtered for Low Expression: ", low_exp)
      ) +
      theme(
        plot.title = element_text(hjust = 0),
        axis.text.x = element_text(angle = 0, hjust = 1)
      ) +
      xlim(-3, 3) +
      geom_text(data = significant_df_interaction, aes(label = Gene),
                vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
    
    plot_file_interaction <- file.path("/home/hhampson/Results", 
                                       paste0("Plot_Organoid_NEBULA_", cell_name_clean, 
                                              "_T2DvsLC_interaction_effect_2000.png"))
    png(plot_file_interaction, width = 3000, height = 2100, res = 300)
    print(volcano_plot_interaction)
    dev.off()
    
    cat("Interaction effect plot saved:", plot_file_interaction, "\n\n")
  }
}

cat("\n=== NEBULA Analysis Complete ===\n")

#Load in all the celltype results & make a nice figure for interaction term
# Initialize empty list to store results
all_results_interaction <- list()
celltypes <- unique(so_combined$cell_type_abbrev)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  # Check if file exists before reading
  if (file.exists(input_file)) {
    file <- read.csv(input_file)
    file$cell_type <- cell_name  # Add cell type column
    all_results_interaction[[cell_name]] <- file
    cat("Loaded:", cell_name, "- Genes:", nrow(file), "\n")
  } else {
    cat("File not found:", input_file, "\n")
  }
}

# Combine all results into one dataframe
combined_results_interaction <- bind_rows(all_results_interaction)

# Count positive and negative DE genes per cell type for INTERACTION term
de_summary_interaction <- combined_results_interaction %>%
  filter(`fdr_groupType.2.Diabetes.treatment30` < 0.05) %>%
  mutate(direction = ifelse(`logFC_groupType.2.Diabetes.treatment30` > 0, "Positive", "Negative")) %>%
  group_by(cell_type, direction) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(count = ifelse(direction == "Negative", -count, count))

# Create the plot for interaction term
p_interaction <- ggplot(de_summary_interaction, aes(x = count, y = reorder(cell_type, abs(count)), fill = direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Negative" = "#A8C9D9", "Positive" = "#E89A9A")) +
  geom_vline(xintercept = 0, color = "black", size = 0.5) +
  geom_hline(yintercept = 9.5, linetype = "dotted", color = "black", linewidth = 0.5) +
  labs(x = "Number of DE genes (Interaction: T2D x Treatment)", 
       y = NULL,
       fill = NULL) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.length.x = unit(0.2, "cm"),
    axis.line.x = element_line(color = "black"),
    legend.position = "top",
    legend.text = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = c(-500, -250, 0, 250, 500),
                     labels = c(500, 250, 0, 250, 500),
                     limits = c(-600, 600))

# Save the interaction plot
ggsave("/home/hhampson/Results/DE_genes_by_celltype_interaction_barplot.png", 
       plot = p_interaction,
       width = 8, height = 6, dpi = 300)

# Count positive and negative DE genes per cell type for TREATMENT30 main effect
de_summary_treatment <- combined_results_interaction %>%
  filter(fdr_groupType.2.Diabetes < 0.05) %>%
  mutate(direction = ifelse(logFC_groupType.2.Diabetes > 0, "Positive", "Negative")) %>%
  group_by(cell_type, direction) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(count = ifelse(direction == "Negative", -count, count))

# Create the plot for groupType.2.Diabetes main effect
p_group <- ggplot(de_summary_treatment, aes(x = count, y = reorder(cell_type, abs(count)), fill = direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Negative" = "#A8C9D9", "Positive" = "#E89A9A")) +
  geom_vline(xintercept = 0, color = "black", size = 0.5) +
  geom_hline(yintercept = 9.5, linetype = "dotted", color = "black", linewidth = 0.5) +
  labs(x = "Number of DE genes (Group: Type 2 Diabetes vs Lean Control)", 
       y = NULL,
       fill = NULL) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.length.x = unit(0.2, "cm"),
    axis.line.x = element_line(color = "black"),
    legend.position = "top",
    legend.text = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = c(-500, -250, 0, 250, 500),
                     labels = c(500, 250, 0, 250, 500),
                     limits = c(-600, 600))

# Save the treatment plot
ggsave("/home/hhampson/Results/DE_genes_by_celltype_groupType.2.Diabetes_barplot.png", 
       plot = p_group,
       width = 8, height = 6, dpi = 300)

# Print summaries
cat("\n=== Interaction Term Summary ===\n")
print(de_summary_interaction %>% arrange(desc(abs(count))))

cat("\n=== groupType.2.Diabetes Main Effect Summary ===\n")
print(de_summary_treatment %>% arrange(desc(abs(count))))
```
### iii. Joint Analysis
```{r}

library(tidyverse)
library(ggrepel)

# Cell types to analyze
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

# Open PDF
pdf("/home/hhampson/Results/T2DvsLC_DiD_FourCategory_Volcano_AllCelltypes.pdf", 
    width = 14, height = 10)

for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # Categorize into 4 groups based on DiD AND treatment direction
  did_results <- full_results %>%
    mutate(
      # DiD = interaction coefficient
      DiD = `logFC_groupType.2.Diabetes.treatment30`,
      DiD_pval = `p_groupType.2.Diabetes.treatment30`,
      DiD_fdr = `fdr_groupType.2.Diabetes.treatment30`,
      DiD_pval10 = `PValue10_groupType.2.Diabetes.treatment30`,
      
      # Treatment main effect (overall glucose response)
      Treatment_effect = logFC_treatment30,
      Treatment_fdr = fdr_treatment30,
      
      # Four-way categorization
      did_category = case_when(
        # Positive DiD (Treatment effect stronger in T2D)
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in T2D",
        DiD_fdr < 0.05 & DiD > 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in T2D",
        
        # Negative DiD (Treatment effect stronger in LC)
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect > 0 ~ 
          "Glucose upregulates MORE in LC",
        DiD_fdr < 0.05 & DiD < 0 & Treatment_effect < 0 ~ 
          "Glucose downregulates LESS in LC",
        
        TRUE ~ "Not Significant"
      ),
      
      # Four distinct colors - Red/Orange for positive DiD, Blue/Purple for negative DiD
      color = case_when(
        did_category == "Glucose upregulates MORE in T2D" ~ "#D32F2F",      # Red
        did_category == "Glucose downregulates LESS in T2D" ~ "#FF9800",     # Orange
        did_category == "Glucose upregulates MORE in LC" ~ "#1976D2",        # Blue
        did_category == "Glucose downregulates LESS in LC" ~ "#7B1FA2",      # Purple
        TRUE ~ "gray"
      )
    )
  
  # Dynamic axis limits
  did_range <- range(did_results$DiD, na.rm = TRUE)
  did_padding <- diff(did_range) * 0.1
  xlim_min <- did_range[1] - did_padding
  xlim_max <- did_range[2] + did_padding
  
  pval_max <- max(did_results$DiD_pval10, na.rm = TRUE)
  ylim_max <- pval_max * 1.05
  
  # Label significant genes (all 4 categories)
  sig_genes <- did_results %>% 
    filter(DiD_fdr < 0.05)
  
  # Count genes in each category
  category_counts <- did_results %>%
    filter(DiD_fdr < 0.05) %>%
    dplyr::count(did_category)
  
  # Create volcano plot
  p <- ggplot(did_results, aes(x = DiD, y = DiD_pval10, color = color)) +
    geom_point(alpha = 0.7, size = 2) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - Glucose Treatment Effect: T2D vs LC"),
      subtitle = "How does high glucose (30 vs 15mM) affect gene expression differently in T2D vs LC?",
      x = "Difference-in-Differences (logFC)\n[Treatment Effect in T2D] - [Treatment Effect in LC]",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 11),
      axis.title.x = element_text(size = 11, margin = margin(t = 10)),
      axis.title.y = element_text(size = 11),
      axis.text = element_text(size = 10),
      legend.position = "none"
    ) +
    xlim(xlim_min, xlim_max) +
    ylim(0, ylim_max) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "black", alpha = 0.3, linewidth = 0.5) +
    geom_text_repel(data = sig_genes, aes(label = Gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # Add 4-category legend
  legend_y_start <- ylim_max * 0.95
  legend_spacing <- ylim_max * 0.06
  legend_x_start <- xlim_max * 0.45
  legend_width <- (xlim_max - xlim_min) * 0.05
  
  # Legend entries
  p <- p +
    # 1. Glucose upregulates MORE in T2D (RED)
    annotate("rect", 
             xmin = legend_x_start, xmax = legend_x_start + legend_width,
             ymin = legend_y_start - legend_spacing * 0, 
             ymax = legend_y_start - legend_spacing * 0 + ylim_max * 0.04,
             fill = "#D32F2F", alpha = 0.7, color = "black", linewidth = 0.3) +
    annotate("text", 
             x = legend_x_start + legend_width * 1.3, 
             y = legend_y_start - legend_spacing * 0 + ylim_max * 0.02,
             label = "Glucose upregulates MORE in T2D", 
             hjust = 0, size = 3.5, fontface = "bold") +
    
    # 2. Glucose downregulates LESS in T2D (ORANGE)
    annotate("rect", 
             xmin = legend_x_start, xmax = legend_x_start + legend_width,
             ymin = legend_y_start - legend_spacing * 1, 
             ymax = legend_y_start - legend_spacing * 1 + ylim_max * 0.04,
             fill = "#FF9800", alpha = 0.7, color = "black", linewidth = 0.3) +
    annotate("text", 
             x = legend_x_start + legend_width * 1.3, 
             y = legend_y_start - legend_spacing * 1 + ylim_max * 0.02,
             label = "Glucose downregulates LESS in T2D (resistant)", 
             hjust = 0, size = 3.5, fontface = "bold") +
    
    # 3. Glucose upregulates MORE in LC (BLUE)
    annotate("rect", 
             xmin = legend_x_start, xmax = legend_x_start + legend_width,
             ymin = legend_y_start - legend_spacing * 2, 
             ymax = legend_y_start - legend_spacing * 2 + ylim_max * 0.04,
             fill = "#1976D2", alpha = 0.7, color = "black", linewidth = 0.3) +
    annotate("text", 
             x = legend_x_start + legend_width * 1.3, 
             y = legend_y_start - legend_spacing * 2 + ylim_max * 0.02,
             label = "Glucose upregulates MORE in LC", 
             hjust = 0, size = 3.5, fontface = "bold") +
    
    # 4. Glucose downregulates LESS in LC (PURPLE)
    annotate("rect", 
             xmin = legend_x_start, xmax = legend_x_start + legend_width,
             ymin = legend_y_start - legend_spacing * 3, 
             ymax = legend_y_start - legend_spacing * 3 + ylim_max * 0.04,
             fill = "#7B1FA2", alpha = 0.7, color = "black", linewidth = 0.3) +
    annotate("text", 
             x = legend_x_start + legend_width * 1.3, 
             y = legend_y_start - legend_spacing * 3 + ylim_max * 0.02,
             label = "Glucose downregulates LESS in LC (resistant)", 
             hjust = 0, size = 3.5, fontface = "bold")
  
  print(p)
  
  # Print category counts
  cat("\nCategory counts for", cell_name, ":\n")
  print(category_counts)
  cat("\n")
}

dev.off()

cat("\n=== DiD 4-category volcano plots complete ===\n")

```
###iv. Combined Plots
####a. Volcano + GSEA
```{r}
library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Cell types in order of most to least DEGs
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

# Specify which effect to visualize
effect_type <- "interaction"  # or "main_effect"

# Open PDF - one page per cell type
pdf(paste0("/home/hhampson/Results/GlucoseConc_Volcano_GSEA_", effect_type, "_AllCelltypes.pdf"), 
    width = 22, height = 10)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  
  # Load the combined dataframe with both effects
  input_file <- file.path(paste0("/home/hhampson/Results/NEBULA_GlucoseConc_", 
                                  cell_name_clean, "_combined_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # Filter to the effect of interest
  effect_results <- full_results %>%
    filter(effect == effect_type)
  
  # ---- VOLCANO PLOT ----
  effect_results$color <- ifelse(effect_results$fdr < 0.05 & effect_results$logFC > 0, "#990000",
                                 ifelse(effect_results$fdr < 0.05 & effect_results$logFC < 0, "#003366", "gray"))
  
  significant_df <- effect_results[effect_results$fdr < 0.05, ]
  
  Genes <- length(unique(effect_results$gene))
  Nonconvergence_Rate <- unique(effect_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(effect_results$low_exp)[1]
  n_cells <- unique(effect_results$Cells)[1]
  
  plot_title <- ifelse(effect_type == "interaction",
                      paste0(cell_name, " - Glucose Conc × T2D Interaction"),
                      paste0(cell_name, " - Glucose Conc Main Effect"))
  
  # Calculate dynamic axis limits based on data
  # X-axis (logFC): add 10% padding to both sides
  logFC_range <- range(effect_results$logFC, na.rm = TRUE)
  logFC_padding <- diff(logFC_range) * 0.1
  xlim_min <- logFC_range[1] - logFC_padding
  xlim_max <- logFC_range[2] + logFC_padding
  
  # Y-axis (PValue10): add 5% padding to top, start at 0
  pval_max <- max(effect_results$PValue10, na.rm = TRUE)
  ylim_max <- pval_max * 1.05
  
  volcano_plot <- ggplot(effect_results, aes(x = logFC, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = plot_title,
      subtitle = paste0("Genes = ", Genes, " | Cells = ", n_cells, 
                        " | Non-Conv: ", Nonconvergence_Rate),
      x = "Log Fold Change",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10)
    ) +
    xlim(xlim_min, xlim_max) +
    ylim(0, ylim_max) +
    geom_text_repel(data = significant_df, aes(label = gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- GSEA (Reactome) ----
  rankings <- effect_results$logFC
  names(rankings) <- effect_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  # Prepare GSEA plot data
  gsea_plot_data <- reactome_res %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      direction = ifelse(NES > 0, "Positive", "Negative"),
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(gsea_plot_data) > 0) {
    # Dynamic NES axis limit with minimal padding
    max_nes <- max(abs(gsea_plot_data$NES), na.rm = TRUE)
    nes_limit <- max_nes * 1.05  # Only 5% padding instead of ceiling + 0.5
    
    gsea_plot <- ggplot(gsea_plot_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                             fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, nes_limit), expand = expansion(mult = c(0, 0.01))) +
      labs(
        title = paste0(cell_name, " - Top 20 Reactome (p < 0.05)"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
    
    # Combine side by side
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    # No significant GSEA - just print volcano with a note
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - Reactome")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== PDF Complete ===\n")

```
####b. Main + Interaction
```{r}

library(tidyverse)
library(patchwork)
library(ggrepel)

# Cell types to analyze
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

# Initialize list to store category counts
all_category_counts <- list()

# ============================================================
# PART 1: Process each cell type and categorize
# ============================================================

for (cell_name in celltypes) {
  
  cat("\n=== Processing:", cell_name, "===\n")
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  full_results <- read.csv(input_file)
  
  # Categorize genes based on significance patterns
  full_results <- full_results %>%
    mutate(
      sig_group = fdr_groupType.2.Diabetes < 0.05,
      sig_treatment = fdr_treatment30 < 0.05,
      sig_interaction = `fdr_groupType.2.Diabetes.treatment30` < 0.05,
      
      effect_pattern = case_when(
        sig_interaction & sig_group & sig_treatment ~ "All_three",
        sig_interaction & sig_treatment ~ "Interaction+Treatment",
        sig_interaction & sig_group ~ "Interaction+Group",
        sig_interaction ~ "Interaction_only",
        sig_group & sig_treatment ~ "Group+Treatment",
        sig_group ~ "Group_only",
        sig_treatment ~ "Treatment_only",
        TRUE ~ "None"
      ),
      
      # Create a simplified category for main focus
      main_category = case_when(
        sig_interaction ~ "Has_Interaction",
        sig_group ~ "Group_only",
        sig_treatment ~ "Treatment_only",
        TRUE ~ "Not_significant"
      )
    )
  
  # Count genes in each category
  category_table <- table(full_results$effect_pattern)
  print(category_table)
  
  # Store for summary
  all_category_counts[[cell_name]] <- data.frame(
    celltype = cell_name,
    category = names(category_table),
    count = as.numeric(category_table)
  )
  
  # Save categorized results
  output_file <- file.path("/home/hhampson/Results", 
                           paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                  "_categorized_2000.csv"))
  write.csv(full_results, output_file, row.names = FALSE)
  
  cat("Categorized results saved:", output_file, "\n")
}

# ============================================================
# PART 2: Create summary visualizations across all cell types
# ============================================================

# Combine all category counts
summary_df <- bind_rows(all_category_counts)

# Define color palette for categories
category_colors <- c(
  "All_three" = "#8B0000",           # Dark red - most complex
  "Interaction+Treatment" = "#DC143C", # Crimson - diabetes-specific glucose
  "Interaction+Group" = "#FF6347",    # Tomato - baseline + interaction
  "Interaction_only" = "#FFA07A",     # Light salmon - pure interaction
  "Group+Treatment" = "#4682B4",      # Steel blue - both main effects
  "Group_only" = "#87CEEB",           # Sky blue - baseline only
  "Treatment_only" = "#B0C4DE",       # Light steel blue - glucose only
  "None" = "#D3D3D3"                  # Light gray - not significant
)

# Order celltypes by total significant genes (interaction genes)
celltype_order <- summary_df %>%
  filter(category != "None") %>%
  group_by(celltype) %>%
  summarize(total_sig = sum(count)) %>%
  arrange(desc(total_sig)) %>%
  pull(celltype)

summary_df$celltype <- factor(summary_df$celltype, levels = celltype_order)

# Reorder categories for better visualization
summary_df$category <- factor(summary_df$category, levels = c(
  "All_three", "Interaction+Treatment", "Interaction+Group", "Interaction_only",
  "Group+Treatment", "Group_only", "Treatment_only", "None"
))

# ============================================================
# PLOT 1: Stacked bar chart of all categories
# ============================================================

pdf("/home/hhampson/Results/T2DvsLC_Interaction_CategoryCounts_AllCelltypes.pdf", 
    width = 14, height = 8)

# Full stacked bar chart
p1 <- ggplot(summary_df, aes(x = celltype, y = count, fill = category)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = category_colors,
                    name = "Significance Pattern",
                    labels = c(
                      "All_three" = "All Three Effects",
                      "Interaction+Treatment" = "Interaction + Treatment",
                      "Interaction+Group" = "Interaction + Group",
                      "Interaction_only" = "Interaction Only",
                      "Group+Treatment" = "Group + Treatment",
                      "Group_only" = "Group Only",
                      "Treatment_only" = "Treatment Only",
                      "None" = "Not Significant"
                    )) +
  labs(
    title = "Differential Expression Patterns: T2D vs LC with Glucose Interaction",
    subtitle = "Genes categorized by significance in main effects and interaction term",
    x = "Cell Type",
    y = "Number of Genes",
    caption = "FDR < 0.05"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    legend.position = "right",
    legend.text = element_text(size = 10)
  )

print(p1)

# ============================================================
# PLOT 2: Focused on interaction genes only
# ============================================================

interaction_df <- summary_df %>%
  filter(category %in% c("All_three", "Interaction+Treatment", 
                         "Interaction+Group", "Interaction_only"))

p2 <- ggplot(interaction_df, aes(x = celltype, y = count, fill = category)) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = category_colors,
                    name = "Interaction Pattern",
                    labels = c(
                      "All_three" = "With Both Main Effects",
                      "Interaction+Treatment" = "With Treatment Effect",
                      "Interaction+Group" = "With Group Effect",
                      "Interaction_only" = "Interaction Only"
                    )) +
  labs(
    title = "Genes with Significant Interaction Effects",
    subtitle = "Diabetes-specific glucose responses by cell type",
    x = "Cell Type",
    y = "Number of Genes",
    caption = "FDR < 0.05 for interaction term"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    legend.position = "right",
    legend.text = element_text(size = 10)
  )

print(p2)

# ============================================================
# PLOT 3: Diverging bar chart (positive vs negative for interaction genes)
# ============================================================

for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_categorized_2000.csv"))
  
  if (!file.exists(input_file)) next
  
  full_results <- read.csv(input_file)
  
  # Count positive and negative for each category with interaction
  interaction_genes <- full_results %>%
    filter(sig_interaction == TRUE) %>%
    mutate(
      direction = ifelse(`logFC_groupType.2.Diabetes.treatment30` > 0, "Positive", "Negative")
    ) %>%
    group_by(effect_pattern, direction) %>%
    summarize(count = n(), .groups = "drop") %>%
    mutate(
      count_signed = ifelse(direction == "Negative", -count, count)
    )
  
  if (nrow(interaction_genes) == 0) next
  
  p_diverging <- ggplot(interaction_genes, 
                        aes(x = effect_pattern, y = count_signed, fill = direction)) +
    geom_bar(stat = "identity", width = 0.6) +
    scale_fill_manual(values = c("Negative" = "#1565C0", "Positive" = "#C62828"),
                      name = "Direction") +
    coord_flip() +
    labs(
      title = paste0(cell_name, " - Interaction Gene Directions"),
      subtitle = "Number of genes with positive vs negative interaction effects",
      x = "Significance Pattern",
      y = "Number of Genes",
      caption = "Positive = exaggerated increase in T2D; Negative = dampened/reversed in T2D"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10),
      axis.text = element_text(size = 10)
    ) +
    geom_hline(yintercept = 0, linetype = "solid", color = "black")
  
  print(p_diverging)
}

dev.off()

cat("\n=== Summary plots saved ===\n")

# ============================================================
# PART 3: Create volcano plots with category coloring
# ============================================================

library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Cell types to analyze
celltypes <- c("Prolif","DMus","EEC","Neur","DPEC","DT","Mes","MesV","DKE","PEC_N","Strom","MusV","NsKE","ProlPod")

pdf("/home/hhampson/Results/T2DvsLC_Interaction_Volcano_Categorized_AllCelltypes.pdf", 
    width = 22, height = 10)

for (cell_name in celltypes) {
  
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path("/home/hhampson/Results", 
                          paste0("NEBULA_T2DvsLC_interaction_", cell_name_clean, 
                                 "_categorized_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Plotting:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- GROUP EFFECT VOLCANO (colored by category) ----
  
  # Prepare data
  group_data <- full_results %>%
    mutate(
      color = case_when(
        effect_pattern == "All_three" ~ "#8B0000",
        effect_pattern == "Interaction+Group" ~ "#FF6347",
        effect_pattern == "Group+Treatment" ~ "#4682B4",
        effect_pattern == "Group_only" ~ "#87CEEB",
        TRUE ~ "gray"
      )
    )
  
  # Dynamic axis limits
  logFC_range_group <- range(group_data$logFC_groupType.2.Diabetes, na.rm = TRUE)
  logFC_padding_group <- diff(logFC_range_group) * 0.1
  xlim_min_group <- logFC_range_group[1] - logFC_padding_group
  xlim_max_group <- logFC_range_group[2] + logFC_padding_group
  
  pval_max_group <- max(group_data$PValue10_groupType.2.Diabetes, na.rm = TRUE)
  ylim_max_group <- pval_max_group * 1.05
  
  # Label only genes with interaction + at least one main effect (or all three)
  sig_group <- group_data %>% 
    filter(effect_pattern %in% c("All_three", "Interaction+Treatment", "Interaction+Group"))
  
  volcano_group <- ggplot(group_data, 
                         aes(x = logFC_groupType.2.Diabetes, 
                             y = PValue10_groupType.2.Diabetes, 
                             color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - Group Main Effect (T2D vs LC)"),
      subtitle = "Genes colored by significance pattern",
      x = "Log Fold Change (T2D vs LC)",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10)
    ) +
    xlim(xlim_min_group, xlim_max_group) +
    ylim(0, ylim_max_group) +
    geom_text_repel(data = sig_group, aes(label = Gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- INTERACTION EFFECT VOLCANO (colored by category) ----
  
  interaction_data <- full_results %>%
    mutate(
      color = case_when(
        effect_pattern == "All_three" ~ "#8B0000",
        effect_pattern == "Interaction+Treatment" ~ "#DC143C",
        effect_pattern == "Interaction+Group" ~ "#FF6347",
        effect_pattern == "Interaction_only" ~ "#FFA07A",
        TRUE ~ "gray"
      )
    )
  
  # Dynamic axis limits
  logFC_range_int <- range(interaction_data$`logFC_groupType.2.Diabetes.treatment30`, na.rm = TRUE)
  logFC_padding_int <- diff(logFC_range_int) * 0.1
  xlim_min_int <- logFC_range_int[1] - logFC_padding_int
  xlim_max_int <- logFC_range_int[2] + logFC_padding_int
  
  pval_max_int <- max(interaction_data$`PValue10_groupType.2.Diabetes.treatment30`, na.rm = TRUE)
  ylim_max_int <- pval_max_int * 1.05
  
  # Label only genes with interaction + at least one main effect (or all three)
  sig_interaction <- interaction_data %>% 
    filter(effect_pattern %in% c("All_three", "Interaction+Treatment", "Interaction+Group"))
  
  volcano_interaction <- ggplot(interaction_data, 
                                aes(x = `logFC_groupType.2.Diabetes.treatment30`, 
                                    y = `PValue10_groupType.2.Diabetes.treatment30`, 
                                    color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - Interaction Effect (T2D × Treatment)"),
      subtitle = "Genes colored by significance pattern",
      x = "Log Fold Change (Interaction)",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10)
    ) +
    xlim(xlim_min_int, xlim_max_int) +
    ylim(0, ylim_max_int) +
    geom_text_repel(data = sig_interaction, aes(label = Gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- CREATE LEGEND ----
  
  legend_data <- data.frame(
    category = c("All Three Effects", "Interaction + Group", "Interaction + Treatment", 
                 "Interaction Only", "Group + Treatment", "Group Only", "Not Significant"),
    color = c("#8B0000", "#FF6347", "#DC143C", "#FFA07A", "#4682B4", "#87CEEB", "gray"),
    x = 1,
    y = 7:1
  )
  
  legend_plot <- ggplot(legend_data, aes(x = x, y = y, fill = color)) +
    geom_tile(width = 0.5, height = 0.8, color = "black") +
    geom_text(aes(label = category), x = 1.6, hjust = 0, size = 4) +
    scale_fill_identity() +
    theme_void() +
    xlim(0.5, 4) +
    ylim(0, 8) +
    labs(title = "Significance Patterns") +
    theme(plot.title = element_text(hjust = 0, size = 12, face = "bold"))
  
  # Combine plots
  combined <- (volcano_group | volcano_interaction | legend_plot) + 
    plot_layout(widths = c(1, 1, 0.4))
  
  print(combined)
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()

cat("\n=== All categorized volcano plots complete ===\n")

# ============================================================
# PART 4: Create summary table
# ============================================================

summary_table <- summary_df %>%
  pivot_wider(names_from = category, values_from = count, values_fill = 0) %>%
  arrange(desc(All_three))

write.csv(summary_table, 
          "/home/hhampson/Results/T2DvsLC_Interaction_CategorySummary.csv", 
          row.names = FALSE)

cat("\n=== Summary table saved ===\n")

```

## c. Perform differential expression between 15 & 30 glucose conc. treatment  in organoid samples (pooled by diabetes group)
### i. Pre-Analysis Steps
```{r}
# Verify dimensions
nrow(so_combined) # genes 7383
ncol(so_combined) # cells 137604

# Check your metadata
table(so_combined$group)
table(so_combined$treatment)
table(so_combined$cell_type_abbrev)
head(so_combined@meta.data[, c("group", "cell_type_abbrev", "record_id", "treatment")])

# Make sure treatment is a factor with 15mM as reference
so_combined$treatment <- factor(so_combined$treatment)
so_combined$treatment <- relevel(so_combined$treatment, ref = "15")  # Adjust to match your actual level name (might be "15mM")

# Calculate pooled offset if not already done
if (!"pooled_offset" %in% colnames(so_combined@meta.data)) {
  so_combined$pooled_offset <- log(so_combined$nCount_RNA + 1)
}

# Prepare data for cell type distribution plot
celltype_counts <- so_combined@meta.data %>%
  group_by(treatment, cell_type_abbrev) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(treatment) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create stacked barchart
png("/home/hhampson/Results/Barchart_Celltypes_by_Treatment.png", 
    res = 300, width = 2000, height = 2000)
ggplot(celltype_counts, aes(x = treatment, y = proportion, fill = cell_type_abbrev)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Glucose Treatment",
    x = "Treatment",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()

# --- Propeller test: T2D vs LC ---
# propeller needs: clusters, sample, group stored in metadata
# Make sure "group" and "record_id" are columns in so_combined metadata
# Option 1: Keep only cell types present in ALL 6 samples
cell_types_in_all <- names(which(colSums(prop_table > 0) == 6))
print(cell_types_in_all)  # Should show 11 cell types

so_filtered <- subset(so_combined, subset = cell_type_abbrev %in% cell_types_in_all)

# Now run propeller on filtered data
# Check if propeller.ttest works for paired data
props <- getTransformedProps(
  clusters = so_combined$cell_type_abbrev,
  sample = so_combined$record_id,
  transform = "logit"
)

# Check structure
str(props)
print(props$Samples)

# Create sample info dataframe
sample_info <- so_combined@meta.data %>%
  dplyr::select(record_id, treatment) %>%
  distinct() %>%
  arrange(record_id)

print(sample_info)

cat("\n=== Propeller Results: T2D vs Lean Control ===\n")
print(propeller_group)

# Save results
write.csv(propeller_group, "/home/hhampson/Results/Propeller_T2DvsLC_results.csv")

```

### ii. Analysis 
```{r}
# Get cell types to analyze
celltypes <- unique(so_combined$cell_type_abbrev)

# Loop through each cell type
for (cell_name in celltypes) {
  
  cat("\n=== Processing:", cell_name, "===\n")
  
  # Subset to current cell type
  so_celltype <- subset(so_combined, cell_type_abbrev == cell_name)
  DefaultAssay(so_celltype) <- "RNA"
  
  StartGenes <- nrow(so_celltype)
  Cells <- ncol(so_celltype)
  
  cat("Genes:", StartGenes, "| Cells:", Cells, "\n")
  
  # Find highly variable genes
  so_celltype <- FindVariableFeatures(so_celltype, 
                                       selection.method = "vst", 
                                       nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  cat("HVGs:", length(hvgs), "\n")
  
  # Get counts for HVGs
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts"))
  genes_list <- hvgs  # Changed from hvgs[1] - you want all genes, not just the first!
  
  # Set up parallel processing
  cl <- makeCluster(10)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  
  # Run NEBULA for each gene in parallel
  nebula_results_list <- foreach(g = genes_list, 
                                  .packages = c("nebula", "Matrix")) %dopar% {
    tryCatch({
      count_gene <- counts_hvg[g, , drop = FALSE]
      meta_gene <- subset(so_celltype, features = g)@meta.data
      
      # MODEL: comparing treatment (30 vs 15mM)
      formula <- as.formula("~ treatment")
      pred_gene <- model.matrix(formula, data = meta_gene)
      library <- meta_gene$pooled_offset
      
      # CRITICAL: Sort by record_id to group cells from same subject
      sort_order <- order(meta_gene$record_id)
      count_gene_sorted <- count_gene[, sort_order, drop = FALSE]
      meta_gene_sorted <- meta_gene[sort_order, ]
      pred_gene_sorted <- pred_gene[sort_order, , drop = FALSE]
      library_sorted <- library[sort_order]
      
      # Create data structure with sorted data
      data_g_gene <- list(count = count_gene_sorted, 
                          id = meta_gene_sorted$record_id, 
                          pred = pred_gene_sorted, 
                          offset = library_sorted)
      
      # Run NEBULA with offset
      result <- nebula(count = data_g_gene$count, 
                       id = data_g_gene$id, 
                       pred = data_g_gene$pred, 
                       ncore = 1, 
                       reml = TRUE,
                       model = "NBLMM",
                       output_re = TRUE,
                       covariance = TRUE,
                       offset = data_g_gene$offset)
      
      list(gene = g, result = result)
      
    }, error = function(e) {
      NULL
    })
  }
  
  stopCluster(cl)
  end_time <- Sys.time()
  cat("Time elapsed:", end_time - start_time, "\n")
  
  # Process results
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)
  
  # Check convergence
  nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      data.frame(Gene = gene_name, Convergence_Code = converged)
    }
  )
  
  # Extract summaries
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  
  # Identify non-converged genes
  nonconverge_genes <- unique(
    nebula_converged$Gene[nebula_converged$Convergence_Code %in% c(-40, -50, -60)]
  )
  
  # Format results
  full_results <- as.data.frame(nebula_summaries)
  colnames(full_results) <- c("logFC_Intercept", "logFC", "se_Intercept", 
                               "se", "p_Intercept", "p_value", 
                               "gene_id", "gene", "Gene")
  
  full_results$Variable <- "30vs15mM"
  full_results$Celltype <- cell_name
  
  # Calculate number of genes filtered out for low expression
  full_results$low_exp <- length(genes_list) - nrow(full_results)
  
  # Filter non-converged genes
  full_results <- full_results %>% 
    filter(!gene %in% nonconverge_genes)
  
  # Calculate non-convergence rate
  full_results$nebula_nonconverged_percent <- 
    paste0(round((1 - (length(genes_list) - length(nonconverge_genes)) / 
                    length(genes_list)) * 100, 3), "%")
  
  full_results$Cells <- Cells
  full_results$Genes <- nrow(full_results)
  
  # FDR correction
  full_results$fdr <- p.adjust(full_results$p_value, method = "fdr")
  full_results$PValue10 <- -log10(pmax(full_results$p_value, 1e-10))
  
  # Save results
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  output_file <- file.path("/home/hhampson/Results", 
                           paste0("NEBULA_30vs15mM_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
  write.csv(full_results, output_file, row.names = FALSE)
  
  cat("Results saved:", output_file, "\n\n")
  
  # Create volcano plot
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$logFC > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$logFC < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Cells <- Cells  # Already defined earlier in the loop
  Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(full_results$low_exp)[1]
  
  # Get min/max for x-axis
  max_fc <- max(full_results$logFC)
  min_fc <- min(full_results$logFC)
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(full_results, aes(x = logFC, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste("30 vs. 15mM Glucose Treatment -", cell_name),
      subtitle = "Organoids, Unadjusted (REML, Log Normal, Offset)",
      x = "Log Fold Change",
      y = "-log10(P-Value)",
      color = "FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, 
                      ", Cells = ", Cells, 
                      ", Non-Convergence Rate: ", Nonconvergence_Rate,
                      ", Genes Filtered for Low Expression: ", low_exp)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(-3, 3) +
    geom_text(data = significant_df, aes(label = gene),
              vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  
  # Save volcano plot
  plot_file <- file.path("/home/hhampson/Results", 
                         paste0("Plot_Organoid_NEBULA_", cell_name_clean, 
                                "_30vs15mM_unadjusted_2000.png"))
  png(plot_file, width = 3000, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  
  cat("Plot saved:", plot_file, "\n\n")
}

cat("\n=== NEBULA Analysis Complete ===\n")



```

### iv. Combine Plots
```{r}
#Load in all the celltype results & make a nice figure
# Initialize empty list to store results
all_results <- list()
celltypes <- unique(so_combined$cell_type_abbrev)
for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/NEBULA_30vs15mM_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
 # Check if file exists before reading
  if (file.exists(input_file)) {
    file <- read.csv(input_file)
    file$cell_type <- cell_name  # Add cell type column
    all_results[[cell_name]] <- file
    cat("Loaded:", cell_name, "- Genes:", nrow(file), "\n")
  } else {
    cat("File not found:", input_file, "\n")
  }

  
  # Combine all results into one dataframe
combined_results <- bind_rows(all_results)

# Count positive and negative DE genes per cell type
# Assuming you have logFC and p_adj columns
de_summary <- combined_results %>%
  filter(fdr < 0.05) %>%  # Adjust column name as needed
  mutate(direction = ifelse(logFC > 0, "Positive", "Negative")) %>%  # Adjust column name
  group_by(cell_type, direction) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(count = ifelse(direction == "Negative", -count, count))

# Create the plot
ggplot(de_summary, aes(x = count, y = reorder(cell_type, abs(count)), fill = direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Negative" = "#A8C9D9", "Positive" = "#E89A9A")) +
  geom_vline(xintercept = 0, color = "black", size = 0.5) +
  geom_hline(yintercept = 11.5, linetype = "dotted", color = "black", size = 0.5) +
  labs(x = "Number of DE genes", 
       y = NULL,
       fill = NULL) +
  theme_minimal() +
 theme(
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.length.x = unit(0.2, "cm"),
    legend.position = "top",
    legend.text = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = c(-500,-250, 0, 250,500),
                     labels = c(500,250, 0, 250, 500),
                     limits = c(-800, 800))

# Save the plot
ggsave("/home/hhampson/Results/DE_genes_by_celltype_barplot_treatment.png", 
       width = 8, height = 6, dpi = 300)
}

# celltypes <- unique(so_combined$cell_type_abbrev)
#Do cell types in order of most to lease degs
celltypes <- c("Neur","Strom","EEC","DPEC","MesV","Prolif","DKE","Mees","DMus","PEC_N","DT","ProlPod","NsKE","MusV")

# Open PDF - one page per cell type
pdf("/home/hhampson/Results/30vs15_Volcano_GSEA_AllCelltypes.pdf", width = 22, height = 10)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/NEBULA_30vs15mM_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- VOLCANO PLOT ----
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$logFC > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$logFC < 0, "#003366", "gray"))
  
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(full_results$low_exp)[1]
  n_cells <- unique(full_results$Cells)[1]
  
# Calculate dynamic x-axis limits
logFC_range <- range(full_results$logFC, na.rm = TRUE)
logFC_padding <- diff(logFC_range) * 0.1
xlim_min <- logFC_range[1] - logFC_padding
xlim_max <- logFC_range[2] + logFC_padding

volcano_plot <- ggplot(full_results, aes(x = logFC, y = PValue10, color = color)) +
  geom_point(alpha = 0.7) +
  scale_color_identity() +
  theme_minimal() +
  labs(
    title = paste0(cell_name, " - 30 vs 15mM"),
    subtitle = paste0("Genes = ", Genes, " | Cells = ", n_cells, 
                      " | Non-Conv: ", Nonconvergence_Rate),
    x = "Log Fold Change",
    y = "-log10(P-Value)"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10)
  ) +
  xlim(xlim_min, xlim_max) +
  geom_text_repel(data = significant_df, aes(label = gene),
                  size = 2.5, color = "black", max.overlaps = 15,
                  box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- GSEA (Reactome) ----
  rankings <- full_results$logFC
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  # Prepare GSEA plot data
  gsea_plot_data <- reactome_res %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      direction = ifelse(NES > 0, "Positive", "Negative"),
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(gsea_plot_data) > 0) {
    max_nes <- ceiling(max(abs(gsea_plot_data$NES)) + 0.5)
    
    gsea_plot <- ggplot(gsea_plot_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                             fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, max_nes), expand = expansion(mult = c(0, 0.02))) +
      labs(
        title = paste0(cell_name, " - Top 20 Reactome (p < 0.05)"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
    
    # Combine side by side
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    # No significant GSEA - just print volcano with a note
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - Reactome")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== PDF Complete ===\n")

```

#4. Biopsy Analysis
## a. Perform differential expression between T2D & LC in Biopsy samples
### i. Pre-Analysis Steps
```{r}
# Verify dimensions
nrow(so_kpmp_sc) # genes
ncol(so_kpmp_sc) # cells

# Check your metadata
table(so_kpmp_sc$group)
table(so_kpmp_sc$celltype_LR)
head(so_kpmp_sc@meta.data[, c("group", "celltype_LR", "kit_id")])

# Make sure group is a factor with LC as reference
so_kpmp_sc$group <- factor(so_kpmp_sc$group)
so_kpmp_sc$group <- relevel(so_kpmp_sc$group, ref = "Lean_Control")  # Adjust to match your actual level name

# Prepare data for cell type distribution plot
celltype_counts <- so_kpmp_sc@meta.data %>%
  group_by(group, celltype_LR) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create stacked barchart
png("/home/hhampson/Results/Barchart_Celltypes_by_Group_Biopsy.png", 
    res = 300, width = 2000, height = 2000)
ggplot(celltype_counts, aes(x = group, y = proportion, fill = celltype_LR)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Diabetes Status",
    x = "Group",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()

```

### ii. Analysis 
```{r}
# Get cell types to analyze
celltypes <- unique(so_kpmp_sc$celltype_LR)[-15] #Remove nonspecific because non in Lean controls & not enough cells

# Loop through each cell type
for (cell_name in celltypes) {
  
  cat("\n=== Processing:", cell_name, "===\n")
  
  # Subset to current cell type
  so_celltype <- subset(so_kpmp_sc, celltype_LR == cell_name)
  DefaultAssay(so_celltype) <- "RNA"
  
  StartGenes <- nrow(so_celltype)
  Cells <- ncol(so_celltype)
  
  cat("Genes:", StartGenes, "| Cells:", Cells, "\n")
  
  # CHECK: Skip if cell type doesn't have both groups
  group_table <- table(so_celltype$group)
  if (length(group_table) < 2) {
    cat("Skipping - only has", names(group_table), "group level\n\n")
    next
  }
  cat("Group distribution:", paste(names(group_table), "=", group_table, collapse=", "), "\n")
  
  # Also check kit_id distribution
  kit_table <- table(so_celltype$kit_id)
  if (length(kit_table) < 2) {
    cat("Skipping - only has 1 sample\n\n")
    next
  }
  
  # Make sure group is a factor with correct reference level
  so_celltype$group <- factor(so_celltype$group)
  so_celltype$group <- relevel(so_celltype$group, ref = "Lean_Control")
  
  # Find highly variable genes
  so_celltype <- FindVariableFeatures(so_celltype, 
                                       selection.method = "vst", 
                                       nfeatures = 2000)
  hvgs <- VariableFeatures(so_celltype)
  
  cat("HVGs:", length(hvgs), "\n")
  
  # Get counts for HVGs
  counts_hvg <- round(GetAssayData(so_celltype, layer = "counts"))
  genes_list <- hvgs  
  
  # Set up parallel processing
  cl <- makeCluster(10)
  registerDoParallel(cl)
  
  start_time <- Sys.time()
  
  # Run NEBULA for each gene in parallel
  nebula_results_list <- foreach(g = genes_list, 
                                  .packages = c("nebula", "Matrix")) %dopar% {
    tryCatch({
      count_gene <- counts_hvg[g, , drop = FALSE]
      meta_gene <- subset(so_celltype, features = g)@meta.data
      pred_gene <- model.matrix(~group, data = meta_gene)
      library <- meta_gene$pooled_offset
      
      # Use group_cell to properly structure data (handles sorting automatically)
      data_g_gene <- group_cell(count = count_gene, 
                                id = meta_gene$kit_id, 
                                pred = pred_gene, 
                                offset = library)
      
      # If group_cell returns NULL, create data structure manually
      if (is.null(data_g_gene)) {
        data_g_gene <- list(count = count_gene, 
                            id = meta_gene$kit_id, 
                            pred = pred_gene, 
                            offset = library)
      }
      
      # Run NEBULA with offset
      result <- nebula(count = data_g_gene$count, 
                       id = data_g_gene$id, 
                       pred = data_g_gene$pred, 
                       ncore = 1, 
                       reml = TRUE,
                       model = "NBLMM",
                       output_re = TRUE,
                       covariance = TRUE,
                       offset = data_g_gene$offset)
      
      list(gene = g, result = result)
      
    }, error = function(e) {
      NULL
    })
  }
  
  stopCluster(cl)
  end_time <- Sys.time()
  cat("Time elapsed:", end_time - start_time, "\n")
  
  # Process results
  nebula_results_list <- Filter(Negate(is.null), nebula_results_list)
  names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)
  nebula_results_list <- lapply(nebula_results_list, function(x) x$result)
  
  # Check convergence
  nebula_converged <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      converged <- nebula_results_list[[gene_name]]$convergence
      data.frame(Gene = gene_name, Convergence_Code = converged)
    }
  )
  
  # Extract summaries
  nebula_summaries <- map_dfr(
    names(nebula_results_list),
    function(gene_name) {
      df <- nebula_results_list[[gene_name]]$summary
      df <- df %>% mutate(Gene = gene_name)
      return(df)
    }
  )
  
  # Identify non-converged genes
  nonconverge_genes <- unique(
    nebula_converged$Gene[nebula_converged$Convergence_Code == -40]
  )
  
  # Format results
  full_results <- as.data.frame(nebula_summaries)
  
  # Calculate number of genes filtered out for low expression
  low_exp <- length(genes_list) - nrow(full_results)
  
  # Filter non-converged genes
  full_results <- full_results %>% 
    filter(!gene %in% nonconverge_genes)
  
  # Calculate non-convergence rate
  nebula_nonconverged_percent <- 
    paste0(round((1 - (length(genes_list) - length(nonconverge_genes)) / 
                    length(genes_list)) * 100, 3), "%")
  
  # FDR correction
  full_results <- full_results %>%
    mutate(fdr = p.adjust(`p_groupType_2_Diabetes`, method = "fdr"))
  
  full_results$PValue10 <- -log10(pmax(full_results$`p_groupType_2_Diabetes`, 1e-10))
  
  # Add metadata columns
  full_results$Variable <- "T2DvsLC"
  full_results$Celltype <- cell_name
  full_results$low_exp <- low_exp
  full_results$nebula_nonconverged_percent <- nebula_nonconverged_percent
  full_results$Cells <- Cells
  full_results$Genes <- nrow(full_results)
  
  # Save results
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  output_file <- file.path("/home/hhampson/Results", 
                           paste0("NEBULA_Biopsy_T2DvsLC_", cell_name_clean, 
                                  "_unadjusted_2000.csv"))
  write.csv(full_results, output_file, row.names = FALSE)
  
  cat("Results saved:", output_file, "\n\n")
  
  # Create volcano plot
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$`logFC_groupType_2_Diabetes` < 0, "#003366", "gray"))
  
  # Identify significant points (fdr < 0.05)
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Nonconvergence_Rate <- nebula_nonconverged_percent
  
  # Create the volcano plot using ggplot
  volcano_plot <- ggplot(full_results, aes(x = `logFC_groupType_2_Diabetes`, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste("Type 2 Diabetes vs. Lean Controls -", cell_name),
      subtitle = "Biopsy, Unadjusted (REML, Log Normal, Offset)",
      x = "Log Fold Change",
      y = "-log10(P-Value)",
      color = "FC Direction",
      caption = paste0("FDR < 0.05, Genes = ", Genes, 
                      ", Cells = ", Cells, 
                      ", Non-Convergence Rate: ", Nonconvergence_Rate,
                      ", Genes Filtered for Low Expression: ", low_exp)
    ) +
    theme(
      plot.title = element_text(hjust = 0),
      axis.text.x = element_text(angle = 0, hjust = 1)
    ) +
    xlim(-3, 3) +
    geom_text(data = significant_df, aes(label = gene),
              vjust = 1, hjust = 1, size = 3, check_overlap = TRUE, color = "black")
  
  # Save volcano plot
  plot_file <- file.path("/home/hhampson/Results", 
                         paste0("Plot_Biopsy_NEBULA_", cell_name_clean, 
                                "_T2DvsLC_unadjusted_2000.png"))
  png(plot_file, width = 3000, height = 2100, res = 300)
  print(volcano_plot)
  dev.off()
  
  cat("Plot saved:", plot_file, "\n\n")
}


```

### iii. Combined Plots
```{r}

library(tidyverse)

# Load all biopsy results
all_results <- list()
celltypes <- unique(so_kpmp_sc$celltype_LR)[-15] # Remove nonspecific

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/NEBULA_Biopsy_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  # Check if file exists before reading
  if (file.exists(input_file)) {
    file <- read.csv(input_file)
    file$cell_type <- cell_name  # Add cell type column
    all_results[[cell_name]] <- file
    cat("Loaded:", cell_name, "- Genes:", nrow(file), "\n")
  } else {
    cat("File not found:", input_file, "\n")
  }
}

# Combine all results into one dataframe
combined_results <- bind_rows(all_results)

# Count positive and negative DE genes per cell type
de_summary <- combined_results %>%
  filter(fdr < 0.05) %>%
  mutate(direction = ifelse(logFC_groupType_2_Diabetes > 0, "Positive", "Negative")) %>%
  group_by(cell_type, direction) %>%
  summarise(count = n(), .groups = "drop") %>%
  mutate(count = ifelse(direction == "Negative", -count, count))

# Calculate total absolute counts for ordering (DESCENDING - most at bottom)
celltype_order <- de_summary %>%
  group_by(cell_type) %>%
  summarise(total = sum(abs(count))) %>%
  arrange(total) %>%  # Changed from desc(total) to put highest at bottom
  pull(cell_type)

de_summary$cell_type <- factor(de_summary$cell_type, levels = celltype_order)

# Create the plot
p <- ggplot(de_summary, aes(x = count, y = cell_type, fill = direction)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Negative" = "#A8C9D9", "Positive" = "#E89A9A")) +
  geom_vline(xintercept = 0, color = "black", linewidth = 0.5) +
  geom_hline(yintercept = 6.5, linetype = "dotted", color = "black", linewidth = 0.5) +  # Added horizontal line
  labs(
    title = "Differential Expression: T2D vs Lean Control (Biopsy)",
    x = "Number of DE genes", 
    y = NULL,
    fill = NULL
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.length.x = unit(0.2, "cm"),
    legend.position = "top",
    legend.text = element_text(size = 12)
  ) +
scale_x_continuous(
  breaks = seq(-60, 60, 20),
  labels = abs(seq(-60, 60, 20))
)

print(p)

# Save the plot
ggsave("/home/hhampson/Results/DE_genes_by_celltype_barplot_Biopsy_T2DvsLC.png", 
       plot = p, width = 8, height = 6, dpi = 300)

cat("\n=== Summary plot saved ===\n")

library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Get cell types from biopsy data
# celltypes <- unique(so_kpmp_sc$celltype_LR)[-15] # Remove nonspecific
celltypes <- c("IC","EC","TL","TAL","DCT","VSMC_Pericyte","Schwann","PT","PC","Immune","Fibroblast","POD","CNT","PEC")       

# Open PDF - one page per cell type
pdf("/home/hhampson/Results/Biopsy_T2DvsLC_Volcano_GSEA_AllCelltypes.pdf", width = 22, height = 10)

for (cell_name in celltypes) {
  cell_name_clean <- str_replace_all(cell_name, "[/ -]", "_")
  input_file <- file.path(paste0("/home/hhampson/Results/NEBULA_Biopsy_T2DvsLC_", 
                                  cell_name_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(input_file)) {
    cat("File not found:", input_file, "\n")
    next
  }
  
  cat("\n=== Processing:", cell_name, "===\n")
  full_results <- read.csv(input_file)
  
  # ---- VOLCANO PLOT ----
  full_results$color <- ifelse(full_results$fdr < 0.05 & full_results$logFC_groupType_2_Diabetes > 0, "#990000",
                               ifelse(full_results$fdr < 0.05 & full_results$logFC_groupType_2_Diabetes < 0, "#003366", "gray"))
  
  significant_df <- full_results[full_results$fdr < 0.05, ]
  
  Genes <- length(unique(full_results$gene))
  Nonconvergence_Rate <- unique(full_results$nebula_nonconverged_percent)[1]
  low_exp <- unique(full_results$low_exp)[1]
  n_cells <- unique(full_results$Cells)[1]
  
  volcano_plot <- ggplot(full_results, aes(x = logFC_groupType_2_Diabetes, y = PValue10, color = color)) +
    geom_point(alpha = 0.7) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0(cell_name, " - T2D vs LC (Biopsy)"),
      subtitle = paste0("Genes = ", Genes, " | Cells = ", n_cells, 
                        " | Non-Conv: ", Nonconvergence_Rate),
      x = "Log Fold Change",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 10)
    ) +
    xlim(-3, 3) +
    geom_text_repel(data = significant_df, aes(label = gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- GSEA (Reactome) ----
  rankings <- full_results$logFC_groupType_2_Diabetes
  names(rankings) <- full_results$gene
  rankings <- sort(rankings, decreasing = TRUE)
  
  set.seed(1234)
  reactome_res <- fgsea(pathways = reactome_sets,
                        stats = rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  # Prepare GSEA plot data
  gsea_plot_data <- reactome_res %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      direction = ifelse(NES > 0, "Positive", "Negative"),
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(gsea_plot_data) > 0) {
    max_nes <- ceiling(max(abs(gsea_plot_data$NES)) + 0.5)
    
    gsea_plot <- ggplot(gsea_plot_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                             fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, max_nes), expand = expansion(mult = c(0, 0.02))) +
      labs(
        title = paste0(cell_name, " - Top 20 Reactome (p < 0.05)"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        axis.text.y = element_text(size = 9),
        axis.text.x = element_text(size = 11),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
    
    # Combine side by side
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
    
  } else {
    # No significant GSEA - just print volcano with a note
    gsea_plot <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = paste0(cell_name, " - Reactome")) +
      theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
    
    combined <- volcano_plot + gsea_plot + plot_layout(widths = c(1, 1.3))
    print(combined)
  }
  
  cat("Printed page for:", cell_name, "\n")
}

dev.off()
cat("\n=== PDF Complete ===\n")


```

# 5. Comparative Analysis - Biopsy vs. Organoid
```{r}

library(fgsea)
library(tidyverse)
library(patchwork)
library(ggrepel)

# Define comparative cell type pairs
comparative_pairs <- list(
  list(biopsy = "POD", organoid = "ProlPod", label = "Podocytes"),
  list(biopsy = "DCT", organoid = "DT", label = "Distal Tubule"),
  list(biopsy = "PEC", organoid = "DPEC", label = "Parietal Epithelial Cells"),
  list(biopsy = "EC", organoid = "EEC", label = "Endothelial"),
  list(biopsy = "VSMC_Pericyte", organoid = "MesV", label = "Vascular Smooth Muscle"),
  list(biopsy = "Fibroblast", organoid = "Strom", label = "Mesenchymal/Fibroblast")
)

# Open PDF - one page per comparative pair (2x2 layout)
pdf("/home/hhampson/Results/Comparative_Organoid_Biopsy_T2DvsLC_Volcano_GSEA.pdf", 
    width = 24, height = 20)

for (pair in comparative_pairs) {
  
  cat("\n=== Processing:", pair$label, "===\n")
  cat("Organoid:", pair$organoid, "| Biopsy:", pair$biopsy, "\n")
  
  # ============================================================
  # ORGANOID DATA
  # ============================================================
  organoid_clean <- str_replace_all(pair$organoid, "[/ -]", "_")
  organoid_file <- file.path(paste0("/home/hhampson/Results/Results?NEBULA_T2DvsLC_", 
                                     organoid_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(organoid_file)) {
    cat("Organoid file not found:", organoid_file, "\n")
    next
  }
  
  org_results <- read.csv(organoid_file)
  
  # ---- ORGANOID VOLCANO ----
  org_results$color <- ifelse(org_results$fdr < 0.05 & org_results$logFC > 0, "#990000",
                              ifelse(org_results$fdr < 0.05 & org_results$logFC < 0, "#003366", "gray"))
  
  org_sig <- org_results[org_results$fdr < 0.05, ]
  
  org_genes <- length(unique(org_results$gene))
  org_cells <- unique(org_results$Cells)[1]
  org_nonconv <- unique(org_results$nebula_nonconverged_percent)[1]
  
  volcano_org <- ggplot(org_results, aes(x = logFC, y = PValue10, color = color)) +
    geom_point(alpha = 0.7, size = 1.5) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0("ORGANOID - ", pair$organoid),
      subtitle = paste0("Genes=", org_genes, " | Cells=", org_cells, " | NonConv: ", org_nonconv),
      x = "Log Fold Change",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 11),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10)
    ) +
    xlim(-3, 3) +
    geom_text_repel(data = org_sig, aes(label = gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- ORGANOID GSEA ----
  org_rankings <- org_results$logFC
  names(org_rankings) <- org_results$gene
  org_rankings <- sort(org_rankings, decreasing = TRUE)
  
  set.seed(1234)
  org_reactome <- fgsea(pathways = reactome_sets,
                        stats = org_rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  org_gsea_data <- org_reactome %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(org_gsea_data) > 0) {
    max_nes_org <- ceiling(max(abs(org_gsea_data$NES)) + 0.5)
    
    gsea_org <- ggplot(org_gsea_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                          fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, max_nes_org), expand = expansion(mult = c(0, 0.02))) +
      labs(
        title = paste0("ORGANOID - Top 20 Reactome"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 11),
        axis.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
  } else {
    gsea_org <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
               label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = "ORGANOID - Reactome") +
      theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
  }
  
  # ============================================================
  # BIOPSY DATA
  # ============================================================
  biopsy_clean <- str_replace_all(pair$biopsy, "[/ -]", "_")
  biopsy_file <- file.path(paste0("/home/hhampson/Results/NEBULA_Biopsy_T2DvsLC_", 
                                   biopsy_clean, "_unadjusted_2000.csv"))
  
  if (!file.exists(biopsy_file)) {
    cat("Biopsy file not found:", biopsy_file, "\n")
    next
  }
  
  bio_results <- read.csv(biopsy_file)
  
  # ---- BIOPSY VOLCANO ----
  bio_results$color <- ifelse(bio_results$fdr < 0.05 & bio_results$logFC_groupType_2_Diabetes > 0, "#990000",
                              ifelse(bio_results$fdr < 0.05 & bio_results$logFC_groupType_2_Diabetes < 0, "#003366", "gray"))
  
  bio_sig <- bio_results[bio_results$fdr < 0.05, ]
  
  bio_genes <- length(unique(bio_results$gene))
  bio_cells <- unique(bio_results$Cells)[1]
  bio_nonconv <- unique(bio_results$nebula_nonconverged_percent)[1]
  
  volcano_bio <- ggplot(bio_results, aes(x = logFC_groupType_2_Diabetes, y = PValue10, color = color)) +
    geom_point(alpha = 0.7, size = 1.5) +
    scale_color_identity() +
    theme_minimal() +
    labs(
      title = paste0("BIOPSY - ", pair$biopsy),
      subtitle = paste0("Genes=", bio_genes, " | Cells=", bio_cells, " | NonConv: ", bio_nonconv),
      x = "Log Fold Change",
      y = "-log10(P-Value)"
    ) +
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      plot.subtitle = element_text(hjust = 0.5, size = 11),
      axis.title = element_text(size = 12),
      axis.text = element_text(size = 10)
    ) +
    xlim(-3, 3) +
    geom_text_repel(data = bio_sig, aes(label = gene),
                    size = 2.5, color = "black", max.overlaps = 15,
                    box.padding = 0.3, segment.alpha = 0.5)
  
  # ---- BIOPSY GSEA ----
  bio_rankings <- bio_results$logFC_groupType_2_Diabetes
  names(bio_rankings) <- bio_results$gene
  bio_rankings <- sort(bio_rankings, decreasing = TRUE)
  
  set.seed(1234)
  bio_reactome <- fgsea(pathways = reactome_sets,
                        stats = bio_rankings,
                        scoreType = 'std',
                        minSize = 3,
                        maxSize = 500,
                        nproc = 1,
                        nPermSimple = 10000)
  
  bio_gsea_data <- bio_reactome %>%
    filter(pval < 0.05) %>%
    arrange(pval) %>%
    head(20) %>%
    mutate(
      pathway_clean = str_remove(pathway, "^REACTOME_"),
      pathway_clean = str_replace_all(pathway_clean, "_", " "),
      pathway_clean = str_to_title(pathway_clean),
      pathway_clean = str_trunc(pathway_clean, 50)
    )
  
  if (nrow(bio_gsea_data) > 0) {
    max_nes_bio <- ceiling(max(abs(bio_gsea_data$NES)) + 0.5)
    
    gsea_bio <- ggplot(bio_gsea_data, aes(x = abs(NES), y = reorder(pathway_clean, abs(NES)),
                                          fill = NES, alpha = abs(NES))) +
      geom_col(width = 0.7) +
      geom_text(aes(x = abs(NES) / 2, label = size),
                color = "white", fontface = "bold", size = 3.5) +
      scale_fill_gradient2(
        low = "#1565C0", mid = "white", high = "#C62828", midpoint = 0,
        name = "NES",
        guide = guide_colorbar(barwidth = 8, barheight = 0.5)
      ) +
      scale_alpha_continuous(range = c(0.5, 1), guide = "none") +
      scale_x_continuous(limits = c(0, max_nes_bio), expand = expansion(mult = c(0, 0.02))) +
      labs(
        title = paste0("BIOPSY - Top 20 Reactome"),
        x = "NES",
        y = NULL
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
        axis.text.y = element_text(size = 10),
        axis.text.x = element_text(size = 11),
        axis.title = element_text(size = 12),
        panel.grid.major.y = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "top"
      )
  } else {
    gsea_bio <- ggplot() + 
      annotate("text", x = 0.5, y = 0.5, 
               label = "No significant Reactome\npathways (p < 0.05)",
               size = 6, hjust = 0.5) +
      theme_void() +
      labs(title = "BIOPSY - Reactome") +
      theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
  }
  
  # ============================================================
  # COMBINE ALL 4 PLOTS IN 2x2 LAYOUT
  # ============================================================
  # Add main title
  main_title <- ggplot() + 
    labs(title = paste0(pair$label, " - T2D vs Lean Control Comparison")) +
    theme_void() +
    theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"))
  
  # Layout: Top row = Organoid (Volcano + GSEA), Bottom row = Biopsy (Volcano + GSEA)
  layout <- (volcano_org | gsea_org) / (volcano_bio | gsea_bio) +
    plot_annotation(
      title = paste0(pair$label, " - T2D vs Lean Control Comparison"),
      theme = theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"))
    )
  
  print(layout)
  
  cat("Printed page for:", pair$label, "\n")
}

dev.off()
cat("\n=== PDF Complete ===\n")

```

# 6.Old Method
##15 Glucose
```{r}
#Run analysis - Differentially Expressed Genes by Diabetes Status
nrow(so_15) #7383 genes
ncol(so_15) #69215 cells

# Define the mapping
celltype_mapping <- c(
  "Muscle/Myogenic Cells (off-target)" = "Muscle_OT",
  "Proliferating Cells" = "Prolif",
  "Proliferating Nephron Progenitors" = "PNP",
  "Neural Crest/Melanocyte (off-target)" = "NC_Mel_OT",
  "Podocytes" = "Podo",
  "Stromal/Interstitial Cells" = "Stroma",
  "Developing Proximal Tubule" = "dPT",
  "Collecting Duct Principal Cells" = "CDPC",
  "Differentiating Neurons (off-target)" = "Diff_Neuron_OT",
  "Neural Progenitors (off-target)" = "NP_OT",
  "Thick Ascending Limb (TAL)" = "TAL",
  "Mature Proximal Tubule" = "mPT"
)
# Create celltype2 as a factor with abbreviated names
so_15$celltype2 <- factor(so_15$celltype,
                          levels = names(celltype_mapping),
                          labels = celltype_mapping)
# Verify the recoding
unique(so_15$celltype2)
# Check that all cells were mapped correctly
table(so_15$celltype2)
meta <- so_15@meta.data
# unique(meta$group)

# Prepare data for plotting
celltype_counts <- so_15@meta.data %>%
  group_by(group, celltype2) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create the stacked barchart
png("/home/hhampson/Results/Barchart_Celltypes_by_Diabetes_15_Glucose.png",res=300,width=2000,height=2000)
ggplot(celltype_counts, aes(x = group, y = proportion, fill = celltype2)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Treatment Group",
    x = "Group",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()


HR_celltypes <- unique(so_15$celltype2)
for (cell_name in HR_celltypes){
  # oro <- "carbp_m"
  # for (oro in oro_vars) {
    so_celltype <- subset(so_15,celltype2==cell_name)
    DefaultAssay(so_celltype) <- "RNA" 
    StartGenes <- nrow(so_celltype) 
    Nuclei <- ncol(so_celltype) 
    
    # cells_to_keep <- !is.na(so_celltype@meta.data[[oro]])
    # so_celltype <- subset(so_celltype, cells = colnames(so_celltype)[cells_to_keep])
    # 
    so_celltype <- FindVariableFeatures(so_celltype, selection.method = "vst", nfeatures = 2000)
    hvgs <- VariableFeatures(so_celltype)
    counts_hvg <- round(GetAssayData(so_celltype, layer = "counts"))
    genes_list <- hvgs
    cl <- makeCluster(10)
    registerDoParallel(cl)
    
    start_time <- Sys.time()
    
    nebula_results_list <- foreach(g = genes_list, .packages = c("nebula", "Matrix")) %dopar% {
      tryCatch({
        count_gene <- counts_hvg[g, , drop = FALSE]
        meta_gene <- subset(so_celltype,features=g)@meta.data
        formula <- as.formula(paste("~ group"))
        pred_gene <- model.matrix(formula, data = meta_gene)
        # pred_gene <- model.matrix(~oro, data = meta_gene)
        # library <- meta_gene$pooled_offset
        library <- meta_gene$pooled_offset
        data_g_gene <- group_cell(count = count_gene, id = meta_gene$record_id, pred = pred_gene,offset=library)
        
        if (is.null(data_g_gene)) {
          data_g_gene <- list(count = count_gene, id = meta_gene$record_id, pred = pred_gene, offset = library)
        }
        
        #With offset
        result <- nebula(count = data_g_gene$count, id = data_g_gene$id, pred = data_g_gene$pred, ncore = 1, reml=T,model="NBLMM",output_re = T,covariance=T,offset = data_g_gene$offset)
        
        list(gene = g, result = result)  # return both gene name and result
        
      }, error = function(e) {
        NULL
      })
    }
    
    stopCluster(cl)
    end_time <- Sys.time()
    print(end_time - start_time)
    
    # set the names of results based on gene names
    nebula_results_list <- Filter(Negate(is.null), nebula_results_list)  # remove NULLs first
    names(nebula_results_list) <- sapply(nebula_results_list, function(x) x$gene)  # set names
    nebula_results_list <- lapply(nebula_results_list, function(x) x$result)  # clean list back to just results
    
    hep_nebula_converged <- map_dfr(
      names(nebula_results_list),
      function(gene_name) {
        converged <- nebula_results_list[[gene_name]]$convergence
        df <- data.frame(Gene = gene_name,
                         Convergence_Code = converged)
        return(df)
      }
    )
    
    nebula_summaries <- map_dfr(
      names(nebula_results_list),
      function(gene_name) {
        df <- nebula_results_list[[gene_name]]$summary
        df <- df %>% mutate(Gene = gene_name)
        return(df)
      }
    )
    nonconverge_genes <- unique(hep_nebula_converged$Gene[which(hep_nebula_converged$Convergence_Code==-40 | hep_nebula_converged$Convergence_Code==-50 | hep_nebula_converged$Convergence_Code==-60)]
    ) 
    
    full_results <- as.data.frame(nebula_summaries)
    colnames(full_results) <- c("logFC_Intercept","logFC","se_Intercept","se","p_Intercept","p_value","gene_id","gene","Gene")
    full_results$Variable <- oro
    full_results$Celltype <- cell_name
    
    #Calculate number of genes filtered out for low expression 
    full_results$low_exp <- length(genes_list)-length(full_results$gene)
    #Filter out non-converging genes
    full_results <- full_results %>% 
      filter(!gene %in%  nonconverge_genes)
    #Calculate nonconvergence rate
    full_results$nebula_nonconverged_percent <- paste0(round((1-(length(genes_list)-length(nonconverge_genes))/length(genes_list))*100,3),"%")
    full_results$Nuceli <- Nuclei
    full_results$Genes <- length(full_results$Gene)
    # nebula_nonconverged_percent <- (length(rownames(counts_tca))-length(unique(full_results$gene)))/length(rownames(counts_tca))
    # print(paste0(nebula_nonconverged_percent*100, "% failed to converge"))
    full_results$fdr <- p.adjust(full_results[,6],method="fdr")  
    # mutate(fdr3=p.adjust(PValue3,method="fdr"))
    full_results$PValue10 <- -log10(pmax(full_results[,6], 1e-10))
    # results_total <- rbind(results_total,full_results)
    cell_name2 <- str_replace_all(cell_name,"/","_")
    cell_name2 <- str_replace_all(cell_name2,"-","_")
    write.csv(full_results,fs::path(dir.results,paste0("NEBULA_",oro,"_",cell_name2,"_unadjusted_2000_tca.csv")))
  }
# }
```

##30 Glucose
```{r}
#Run analysis - Differentially Expressed Genes by Diabetes Status
nrow(so_30) #7383 genes
ncol(so_30) #87172 cells

# Define the mapping
celltype_mapping <- c(
  "Stromal/Interstitial Cells" = "Stroma",
  "Distal Convoluted Tubule (DCT)" = "DCT",
  "Podocytes - Activated/Contractile" = "Podo (Act)",
  "Proliferating Nephron Progenitors" = "PNP",
  "Neural Crest/Melanocyte-like (off-target)" = "NC/Mel (OT)",
  "Mature Proximal Tubule" = "mPT",
  "Specialized Proximal Tubule/Epithelial" = "sPT",
  "Proliferating Cells" = "Prolif",
  "Neuronal Cells - Mature (off-target)" = "Neuron (OT)",
  "Collecting Duct Principal Cells" = "CDPC",
  "Podocytes - Classic" = "Podo (Class)",
  "Muscle/Myogenic Cells - Mature (off-target)" = "Muscle (OT)",
  "Neuronal Cells - Highly Differentiated (off-target)" = "Neuron Diff (OT)",
  "Thick Ascending Limb (TAL)" = "TAL"
)

# Create celltype2 as a factor with abbreviated names
so_30$celltype2 <- factor(so_30$celltype,
                          levels = names(celltype_mapping),
                          labels = celltype_mapping)

# Verify the recoding
unique(so_30$celltype2)

# Check that all cells were mapped correctly
table(so_30$celltype2)

# Verify the recoding
unique(so_30$celltype2)
# Check that all cells were mapped correctly
table(so_30$celltype2)
meta <- so_30@meta.data
# unique(meta$group)

# Prepare data for plotting
celltype_counts <- so_30@meta.data %>%
  group_by(group, celltype2) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(group) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

# Create the stacked barchart
png("/home/hhampson/Results/Barchart_Celltypes_by_Diabetes_30_Glucose.png",res=300,width=2000,height=2000)
ggplot(celltype_counts, aes(x = group, y = proportion, fill = celltype2)) +
  geom_col(width = 0.6) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent) +
  theme_minimal() +
  labs(
    title = "Cell Type Distribution by Treatment Group",
    x = "Group",
    y = "Proportion of Cells",
    fill = "Cell Type"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = "right"
  )
dev.off()

```