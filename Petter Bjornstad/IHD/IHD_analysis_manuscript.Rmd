---
title: "IHD analyses"
author: "Paige Dillon and Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(magrittr)
library(tableone)
library(knitr)
library(ISLR)
library(stringr)
library(Hmisc)
library(emmeans)
library(car)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Petter Bjornstad/Data Harmonization/Data Exports"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/"
} 
knitr::opts_knit$set(root.dir = home_dir)
setwd(home_dir)

```

```{r, include=FALSE}
# read in raw data
dat <- read.csv("./Data Clean/harmonized_dataset.csv", na.strings = c(" ", "", "-99"))

# read in ffa data
insulin_dat <- dat %>%
  select(record_id, visit, insulin_minus_20, insulin_minus_10, insulin_minus_5, insulin_0) %>%
  group_by(record_id, visit) 
insulin_dat %<>%
  fill(names(insulin_dat)) %>%
  summarise_all(last)

ffa_dat <- read.csv("./Data Clean/ffa_dataset.csv", na.strings = c(" ", "", "-99"))

ffa_insulin_dat <- ffa_dat %>%
  left_join(insulin_dat)

ffa_insulin_dat_clean <- ffa_insulin_dat %>%
  mutate(ffa_suppression = case_when(ffa_suppression < 0 ~ 0, T~ffa_suppression)) %>%
  mutate(p1_ffa_suppression = case_when(p1_ffa_suppression < 0 ~ 0, T~ p1_ffa_suppression)) %>%
  mutate(p2_ffa_suppression = case_when(p2_ffa_suppression < 0 ~ 0, T~ p2_ffa_suppression)) %>%
  mutate(ffa_suppression_combined = case_when(is.na(ffa_suppression)~p2_ffa_suppression, T~ffa_suppression)) %>%
  group_by(record_id, visit) %>%
  mutate(fasting_insulin = mean(c(insulin_minus_20, insulin_minus_10, insulin_minus_5, insulin_0), na.rm = TRUE)) %>%
  mutate(fasting_ffa = mean(c(ffa_minus_20, ffa_minus_10, ffa_minus_5, ffa_0), na.rm = TRUE)) %>%
  mutate(adipose_ir = fasting_insulin*fasting_ffa)

write.csv(ffa_insulin_dat_clean, "./Data Clean/ffa_insulin_dataset.csv", row.names = F)

# clean data
clean_dat <- dat %>%
  group_by(record_id) %>%
  fill(names(dat))%>%
  summarise_all(last)
clean_dat$group <- as.factor(clean_dat$group)

# labels for table 01
label(clean_dat$sex)= "Sex"
label(clean_dat$age)= "Age"
label(clean_dat$race)= "Race"
label(clean_dat$ethnicity)= "Ethnicity"
label(clean_dat$hba1c)= "HbA1C"
label(clean_dat$diabetes_duration)= "Length of diabetes diagnosis in months"
label(clean_dat$height)= "Height in cm"
label(clean_dat$weight)= "Weight in kg"
label(clean_dat$bmi)= "BMI"
label(clean_dat$dexa_body_fat)= "DEXA Body Fat (%)"
label(clean_dat$dexa_fat_kg)= "DEXA Body Fat (kg)"
label(clean_dat$waistcm)= "Waist Circumference (cm)"
label(clean_dat$cholesterol)= "Cholesterol (mg/dl)"
label(clean_dat$hdl_base)= "Baseline HDL (mg/dl)"
label(clean_dat$ldl_base)= "Baseline LDL (mg/dl)"
label(clean_dat$triglycerides)= "Triglycerides (mg/dl)"
label(clean_dat$sbp)= "Systolic Blood Pressure (SBP)"
label(clean_dat$dbp)= "Diastolic Blood Pressure (DBP)"
label(clean_dat$map)= "Mean Arterial Pressure (MAP)"
label(clean_dat$creatinine_s)= "Serum Creatinine (mg/dl)"
label(clean_dat$cystatin_c_s)= "Serum Cystatin (mg/L)"
label(clean_dat$gfr_bsa_plasma_urine) = "BSA indexed GFR from plasma and urine clearance"
label(clean_dat$gfr_bsa_plasma) = "BSA indexed GFR from plasma clearance"
label(clean_dat$gfr_raw_plasma_urine)= "Absolute GFR from plasma and urine clearnace"
label(clean_dat$gfr_raw_plasma)= "Absolute GFR from plasma clearnace"
label(clean_dat$erpf_raw_plasma_urine)= "Absolute ERPF from plasma and urine clearance"
label(clean_dat$erpf_raw_plasma)= "Absolute ERPF from plasma clearance"
label(clean_dat$erpf_bsa_plasma_urine)= "BSA indexed ERPF from plasma and urine clearance"
label(clean_dat$erpf_bsa_plasma)= "BSA indexed ERPF from plasma clearance"
label(clean_dat$bold_r_pf_cortex)= "Bold_r_pf cortex"
label(clean_dat$bold_r_pf_medulla)= "Bold_r_pf medulla"
label(clean_dat$bold_r_pf_kidney)= "Bold_r_pf kidney"

#Labeling the other variables
label(clean_dat$record_id)= "Subject ID"
label(clean_dat$acr_baseline)= "ACR Baseline"
label(clean_dat$diabetes_dx_date)= "Date of Diagnosis with Diabetes"
label(clean_dat$airg)= "AIRg"
label(clean_dat$steady_state_insulin)= "SS. insulin"
label(clean_dat$mes_index)= "Mes Index"
label(clean_dat$acr_baseline)= "Baseline ACR"
label(clean_dat$ffa_suppression)= "Percent FFA Suppression"
label(clean_dat$dob)= "Date of Birth"
label(clean_dat$acprg)= "ACPRg (nmol/L)"
label(clean_dat$steady_state_cpeptide)= "SS CP"
label(clean_dat$group)= "Group"

# make dataframe with only T2D and obese
clean_dat_T2D_obese <- clean_dat %>% filter(group %in% c("Type 2 Diabetes","Obese Control"))
clean_dat_T2D_obese$group <- as.factor(clean_dat_T2D_obese$group)
clean_dat_T2D_obese$group <- droplevels(clean_dat_T2D_obese$group)
clean_dat_T2D_obese$sex <- as.factor(clean_dat_T2D_obese$sex)
```

# Questions for Carson

1. We did not find oxygen availability in the dataset.
2. For albuminuria, we used variable "ACR_baseline" - is that correct?

# Results

## Descriptive statistics

```{r echo=FALSE, include=FALSE}
t1 <- CreateTableOne(data=clean_dat, vars=c('sex','age','race', 'ethnicity', 'hba1c','height', 'weight', 'bmi', 'dexa_body_fat', 'waistcm','cholesterol', 'hdl', 'ldl', 'triglycerides', 'sbp', 'dbp','map', 'creatinine_s', 'cystatin_c_s','gfr_raw_plasma_urine', 'gfr_bsa_plasma_urine', 'erpf_raw_plasma_urine','erpf_bsa_plasma_urine', 'gfr_raw_plasma', 'gfr_bsa_plasma', 'erpf_raw_plasma', 'erpf_bsa_plasma', 'bold_r_pf_cortex', 'bold_r_pf_medulla','bold_r_pf_kidney'), strata="group")
t1 <- print(t1, showAllLevels=T)

t_erpf <- CreateTableOne(data=clean_dat, vars=c('gfr_raw_plasma_urine', 'gfr_bsa_plasma_urine', 'erpf_raw_plasma_urine','erpf_bsa_plasma_urine', 'gfr_raw_plasma', 'gfr_bsa_plasma', 'erpf_raw_plasma', 'erpf_bsa_plasma'), strata="group")
t_erpf <- print(t_erpf, showAllLevels=T)
```

```{r echo=FALSE, include=TRUE}
kable(t1)
```

## Measures of insulin sensitivity, adjusted for sex

```{r echo=FALSE,comment=''}
sivars <- c("steady_state_cpeptide","steady_state_insulin","GIR","airg","Disposition.index..M.I.xAIRg","ffa_suppression")

# group comparisons adjusted for sex
for (v in sivars) {
  form = as.formula(paste0(v,"~group + sex"))
  mod <- lm(form,data = merged_data_T2D_obese)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
}
```

## GFR and ERPF, adjusted for sex and A1c

```{r echo=FALSE,comment=''}
gfr_erpf_vars <- c('gfr_raw_plasma_urine', 'gfr_bsa_plasma_urine', 'erpf_raw_plasma_urine','erpf_bsa_plasma_urine', 'gfr_raw_plasma', 'gfr_bsa_plasma', 'erpf_raw_plasma', 'erpf_bsa_plasma')

# group comparisons adjusted for sex
for (v in gfr_erpf_vars) {
  form = as.formula(paste0(v,"~group + sex + hba1c"))
  mod <- lm(form,data = merged_data_T2D_obese)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
}
```

## O2 consumption, adjusted for sex, A1c, and weight

```{r echo=FALSE,comment=''}
o2_vars <- c("O2_Consumption._cortex","O2_Consumption_medulla","O2_Consumption_Kidney")

# group comparisons adjusted for sex
for (v in o2_vars) {
  form = as.formula(paste0(v,"~group + sex + hba1c + weight"))
  mod <- lm(form,data = merged_data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
 }
```

## FFA suppression vs. albuminuria and renal oxygen consumption

```{r echo=FALSE,comment=''}
ffa_vars <- c("O2_Consumption._cortex","O2_Consumption_medulla","O2_Consumption_Kidney","ACR_baseline")

# group comparisons adjusted for sex
for (v in ffa_vars) {
  form = as.formula(paste0(v,"~ffa_suppression + sex + hba1c + weight"))
  mod <- lm(form,data = merged_data)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  plot(mod)
}
```
