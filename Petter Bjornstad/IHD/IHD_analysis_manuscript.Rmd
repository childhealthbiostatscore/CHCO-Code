---
title: "IHD analyses"
author: "Paige Dillon and Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(magrittr)
library(tableone)
library(jstable)
library(knitr)
library(ISLR)
library(stringr)
library(Hmisc)
library(emmeans)
library(car)
library(kableExtra)
library(table1)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S:/Petter Bjornstad/Data Harmonization/Data Exports"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/"
} 
knitr::opts_knit$set(root.dir = home_dir)
setwd(home_dir)

```

```{r, include=FALSE}
# read in raw data
dat <- read.csv("./Data Clean/harmonized_dataset.csv", na.strings = c(" ", "", "-99"))
var_dat <- read.csv("./data_dictionary_master.csv", na.strings = c(" ", "", "-99"))

# clean data
clean_dat <- dat %>%
  group_by(record_id) %>%
  fill(names(dat))%>%
  summarise_all(last)
clean_dat$group <- as.factor(clean_dat$group)

ffa_insulin_dat_clean <- clean_dat %>%
  mutate(ffa_suppression = case_when(ffa_suppression < 0 ~ 0, T~ffa_suppression)) %>%
  mutate(p1_ffa_suppression = case_when(p1_ffa_suppression < 0 ~ 0, T~ p1_ffa_suppression)) %>%
  mutate(p2_ffa_suppression = case_when(p2_ffa_suppression < 0 ~ 0, T~ p2_ffa_suppression)) %>%
  mutate(ffa_suppression_combined = case_when(is.na(ffa_suppression)~p2_ffa_suppression, T~ffa_suppression)) %>%
  group_by(record_id, visit) %>%
  mutate(fasting_insulin = mean(c(insulin_minus_20, insulin_minus_10, insulin_minus_5, insulin_0), na.rm = TRUE)) %>%
  mutate(fasting_ffa = mean(c(ffa_minus_20, ffa_minus_10, ffa_minus_5, ffa_0), na.rm = TRUE)) %>%
  mutate(adipose_ir = fasting_insulin*fasting_ffa)

# Label variables
rownames(var_dat) <- var_dat$variable_name 
var_dat %<>% select("label")
var_dat <- t(var_dat) %>% as.data.frame(var_dat)
var_dat <- var_dat[intersect(names(clean_dat), names(var_dat))]
var_dat[setdiff(names(clean_dat), names(var_dat))] <- " "
label(clean_dat) = var_dat[match(names(clean_dat), names(var_dat))]

# make dataframe with only T2D and obese
clean_dat_T2D_obese <- clean_dat %>% filter(group %in% c("Type 2 Diabetes","Obese Control"))
clean_dat_T2D_obese$group <- as.factor(clean_dat_T2D_obese$group)
clean_dat_T2D_obese$group <- droplevels(clean_dat_T2D_obese$group)
clean_dat_T2D_obese$sex <- as.factor(clean_dat_T2D_obese$sex)
```

# Questions for Carson

1. We did not find oxygen availability in the dataset.
2. For albuminuria, we used variable "ACR_baseline" - is that correct?

# Results

## Descriptive statistics

```{r echo=FALSE, include=FALSE}
t1 <- table1(~sex + age + race +  ethnicity +  hba1c + height +  weight +  bmi +  dexa_body_fat +  waistcm + cholesterol +  hdl +  ldl +  triglycerides +  sbp +  dbp + map +  creatinine_s +  cystatin_c_s + gfr_raw_plasma_urine +  gfr_bsa_plasma_urine +  erpf_raw_plasma_urine + erpf_bsa_plasma_urine +  gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma +  bold_r_pf_cortex +  bold_r_pf_medulla + bold_r_pf_kidney | group, data=clean_dat)
t1 <- print(t1, showAllLevels=T)

t_erpf <- table1(~gfr_raw_plasma_urine +  gfr_bsa_plasma_urine +  erpf_raw_plasma_urine + erpf_bsa_plasma_urine +  gfr_raw_plasma +  gfr_bsa_plasma +  erpf_raw_plasma +  erpf_bsa_plasma | group, data=clean_dat)
t_erpf <- print(t_erpf, showAllLevels=T)
```


## Measures of insulin sensitivity, adjusted for sex

```{r echo=FALSE,comment=''}
sivars <- c("steady_state_cpeptide","steady_state_insulin","d20_infusion","airg","di","ffa_suppression")

# group comparisons adjusted for sex
for (v in sivars) {
  form = as.formula(paste0(v,"~group + sex"))
  mod <- lm(form,data = clean_dat_T2D_obese)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
}
```

## GFR and ERPF, adjusted for sex and A1c

```{r echo=FALSE,comment=''}
gfr_erpf_vars <- c('gfr_raw_plasma_urine', 'gfr_bsa_plasma_urine', 'erpf_raw_plasma_urine','erpf_bsa_plasma_urine', 'gfr_raw_plasma', 'gfr_bsa_plasma', 'erpf_raw_plasma', 'erpf_bsa_plasma')

# group comparisons adjusted for sex
for (v in gfr_erpf_vars) {
  form = as.formula(paste0(v,"~group + sex + hba1c"))
  mod <- lm(form,data = clean_dat_T2D_obese)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
}
```

## O2 consumption, adjusted for sex, A1c, and weight

```{r echo=FALSE,comment=''}
o2_vars <- c("fsoc_r_cortex", "fsoc_r_medulla", "fsoc_r_kidney", "fsoc_l_cortex", "fsoc_l_medulla", "fsoc_l_kidney")

# group comparisons adjusted for sex
for (v in o2_vars) {
  form = as.formula(paste0(v,"~group + sex + hba1c + weight"))
  mod <- lm(form,data = clean_dat)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  means <- emmeans(mod,"group")
  print(means)
 }
```

## FFA suppression vs. albuminuria and renal oxygen consumption

```{r echo=FALSE,comment=''}
ffa_vars <- c("fsoc_r_cortex", "fsoc_r_medulla", "fsoc_r_kidney", "fsoc_l_cortex", "fsoc_l_medulla", "fsoc_l_kidney","acr_baseline")

# group comparisons adjusted for sex
for (v in ffa_vars) {
  form = as.formula(paste0(v,"~ffa_suppression + sex + hba1c + weight"))
  mod <- lm(form,data = clean_dat)
  print(noquote(c("Adjusted model for: ", noquote(v))))
  print(summary(mod))
  plot(mod)
}
```
