---
title: "Permutation Code for Laura"
author: "Hailey Hampson"
date: "2025-09-25"
output: html_document
---

# 1. Set up Libraries & Directores
```{r}
file.path.name <- "hhampson" #Replace with your username
dir.dat <- c(paste0("/Users/",file.path.name,"/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Biostatistics Core Shared Drive"))
dir.results <- c(paste0("/Users/",file.path.name,"/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Liver Project/NEBULA Results"))
dir.code <- c(paste0("/Users/",file.path.name,"/CHCO-Code/Petter Bjornstad/Liver analysis"))

#Load Libraries
source(fs::path(dir.code,"Libraries.R"))

#Load functions
source(fs::path(dir.code,"Liver_functions.R"))

knitr::opts_knit$set(root.dir = dir.results)
```

# 2. Load Data
```{r}
#Load liver seurat object
invisible(gc())
so_liver_sn <- readRDS(fs::path(dir.dat,"scRNA","data_raw","NoRef_PetterLiver_ClinData_Labels_Char_041924.RDS"))

DefaultAssay(so_liver_sn) <- "RNA"
#Check cell and gene counds
dim(so_liver_sn)#36601 130124
nrow(so_liver_sn) #36,601 genes
ncol(so_liver_sn) # 130,124 nuceli
invisible(gc())

```

# 3. Load Metadata, Clean & Merge
```{r}
#Load metadata
meta_liver_raw <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))

unique(meta_liver_raw$Kit_Lot)
unique(meta_liver_raw$StudyID)
meta_liver_raw <- meta_liver_raw %>%
  filter(StudyID!="IT2D-18") %>%
  filter(StudyID!="IT2D-16")

#Create Liver Status Variables
meta_liver_raw <- meta_liver_raw %>%
  mutate(steatosis_cat = ifelse((steatosis_grade==0 | steatosis_grade==1),"Low Steatosis (0+1)","High Steatosis (2+3)")) %>%
  mutate(fibrosis_cat = case_when(steatosis_grade==0 & fibrosis_stage==0 ~ "No Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage==0 ~ "Any Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage>0 ~ "Any Fibrosis & Any Steatosis"))

#Merge liver sn metadata with meta liver raw metadata
meta_liver_sn <-  so_liver_sn@meta.data[,1:11] %>%
  dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(meta_liver_raw)
#Merge into seurat object
rownames(meta_liver_sn) <- rownames(so_liver_sn@meta.data)
so_liver_sn <- AddMetaData(so_liver_sn, meta_liver_sn)
rm(meta_liver_sn,meta_liver_raw)

#Switch default assay in seurat object to RNA
DefaultAssay(so_liver_sn) <- "RNA"
invisible(gc())

dim(so_liver_sn) #36601 130124
ncol(so_liver_sn) #130124 nuclei 
nrow(so_liver_sn) # 36601 genes

#YE JI's filtering code for percent expression 
#Filter out rare genes expressed in less than "gene_pct" of cells
expr_matrix <- as.matrix(GetAssayData(so_liver_sn, layer = "counts"))
# expr_matrix <- as.matrix(GetAssayData(so_liver_sn, assay = "RNA", layer = "counts"))
expr_matrix <- so_liver_sn@assays$RNA@counts
# Calculate the proportion of cells expressing each gene
num_cells_per_gene <- rowSums(expr_matrix > 0)  # Count nonzero cells per gene
total_cells <- ncol(expr_matrix)  # Total number of cells
gene_proportion <- num_cells_per_gene / total_cells  # Fraction of cells expressing each gene
remove(expr_matrix)
# Keep genes expressed in at least "gene_pct" of cells
genes_to_keep <- names(gene_proportion[gene_proportion >= 0.01])
so_liver_sn <- subset(so_liver_sn, features = genes_to_keep)
ncol(so_liver_sn) #130,124 nuclei
nrow(so_liver_sn) # 11313 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_liver_sn), value = TRUE)
so_liver_sn <- subset(so_liver_sn, features = setdiff(rownames(so_liver_sn@assays$RNA@counts), mito_genes))
dim(so_liver_sn@assays$RNA@counts) #9276 186125
dim(so_liver_sn@assays$RNA@data) #9276 186125
dim(so_liver_sn@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(so_liver_sn@assays$RNA@counts))) #0
ncol(so_liver_sn) #130124 cells
nrow(so_liver_sn) #11300 genes

#Step 3: Remove ribosomal Genes
# Identify ribosomal genes
ribo_genes <- c(
  "RPL22", "RPL11", "RPS8", "RPL5", "RPS27", "RPS7", "RPS27A", "RPL31", "RPL37A", "RPL32", "RPL15", "RPL14", "RPL29",
  "RPL24", "RPL22L1", "RPL35A", "RPL9", "RPL34", "RPS3A", "RPL37", "RPS23", "RPS14", "RPS18", "RPS10", "RPL10A", 
  "RPS20", "RPL7", "RPL30", "RPL8", "RPS6", "RPL35", "RPL12", "RPL7A", "RPS24", "RPLP2", "RPL27A", "RPS13", "RPS3",
  "RPS25", "RPS26", "RPL41", "RPL6", "RPLP0", "RPL21", "RPS29", "RPL4", "RPLP1", "RPS17", "RPS2", "RPS15A", "RPL13",
  "RPL26", "RPL23A", "RPL23", "RPL19", "RPL27", "RPL38", "RPL17", "RPS15", "RPL36", "RPS28", "RPL18A", "RPS16", 
  "RPS19", "RPL18", "RPL13A", "RPS11", "RPS9", "RPL28", "RPS5", "RPS21", "RPL3", "RPS4X", "RPL36A", "RPL39", 
  "RPL10", "RPS4Y1"
)
so_liver_sn <- subset(so_liver_sn, features = setdiff(rownames(so_liver_sn), ribo_genes))
# sum(grepl("^MT-", rownames(so_liver_sn))) #0
length(which(rownames(so_liver_sn) %in% ribo_genes)) #0
ncol(so_liver_sn) #130,124 cells
nrow(so_liver_sn) #11224 genes

so_liver_sn <- NormalizeData(so_liver_sn)
so_liver_sn <- ScaleData(so_liver_sn, features = VariableFeatures(so_liver_sn))

#Create general hepatocyte cell type variable
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype) | grepl("dHep",so_liver_sn$celltype) | grepl("Hep/Immune",so_liver_sn$celltype),"Hep","Non-Hep")
# so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hep","Non-Hep")

# table(so_liver_sn$celltype,so_liver_sn$celltype2)

# rm(expression_data)
DefaultAssay(so_liver_sn) <- "RNA" 

# Calculate cell library size for offset in NEBULA --------------------------------------
counts_layer <- round(GetAssayData(so_liver_sn, layer = "counts"))
library_size <- Matrix::colSums(counts_layer)
so_liver_sn$library_size <- library_size

so_liver_sn$celltype_LR <- ifelse(grepl("Hep-",so_liver_sn$celltype) | grepl("dHep",so_liver_sn$celltype) | grepl("Hep/Immune",so_liver_sn$celltype),"Hep",
                                  ifelse(so_liver_sn$celltype=="EC-1" | so_liver_sn$celltype=="EC-2","EC",
                                         ifelse(so_liver_sn$celltype=="Stellate-1" | so_liver_sn$celltype=="Stellate-2","Stellate",
                                                ifelse(so_liver_sn$celltype=="Cholang","Cholang",
                                                       ifelse(so_liver_sn$celltype=="B/Plasma" | so_liver_sn$celltype=="cFIB/cImmune" | so_liver_sn$celltype=="Kup/MAC"|so_liver_sn$celltype=="Kup/MON" | so_liver_sn$celltype=="NKC/NKT","Immune","Unknown")))))
unique(so_liver_sn$celltype_LR)

```

# 4. Run Cell Chat Analysis
```{r}
# Split by steatosis level 
Hep_high <- subset(so_liver_sn, subset = steatosis_cat == "High Steatosis (2+3)")  
Hep_low  <- subset(so_liver_sn, subset = steatosis_cat == "Low Steatosis (0+1)")   

# Filter by cell type size for each group
Hep_high <- filter_by_celltype_size(Hep_high, min_cells = 30)  
Hep_low  <- filter_by_celltype_size(Hep_low, min_cells = 30)

# Fix factor levels
Hep_high$celltype <- droplevels(factor(Hep_high$celltype))
Hep_low$celltype  <- droplevels(factor(Hep_low$celltype))

# Run CellChat on both groups
cellchats <- list(
  Hep_high = run_cellchat_pipeline(Hep_high, "Hep_high"),
  Hep_low  = run_cellchat_pipeline(Hep_low,  "Hep_low")
)

# Merge CellChat objects for comparison
cellchat_merged <- mergeCellChat(cellchats, add.names = names(cellchats))

# Compare the total number of interactions
compareInteractions(cellchat_merged, show.legend = F, group = c(1,2))

# Compare the total interaction strength
compareInteractions(cellchat_merged, show.legend = F, group = c(1,2), measure = "weight")

# Compare the number of interactions by cell type
netVisual_diffInteraction(cellchat_merged, weight.scale = T)

# Compare the interaction strength by cell type
netVisual_diffInteraction(cellchat_merged, weight.scale = T, measure = "weight")

# Get group sizes for each condition
groupSize_high <- get_group_size(cellchats[['Hep_high']])
groupSize_low  <- get_group_size(cellchats[['Hep_low']])

# Get all pathways from both conditions
pathways_high <- cellchats[['Hep_high']]@netP$pathways
pathways_low  <- cellchats[['Hep_low']]@netP$pathways

# Get union of all pathways and sort them (alphabetical order)
all_pathways <- sort(union(pathways_high, pathways_low))

# High steatosis interactions with ordered pathways
a <- netVisual_bubble(cellchats[['Hep_high']], 
                      signaling = all_pathways,  # This orders the pathways
                      remove.isolate = FALSE,
                      title.name = "High Steatosis - Cell Communication")

# Low steatosis interactions with same pathway order
b <- netVisual_bubble(cellchats[['Hep_low']], 
                      signaling = all_pathways,  # Same order as above
                      remove.isolate = FALSE,
                      title.name = "Low Steatosis - Cell Communication")


# Use the merged object for direct comparison
cellchat_merged <- mergeCellChat(cellchats, add.names = names(cellchats))

# This will show both conditions with consistent ordering
c <- netVisual_bubble(cellchat_merged, 
                      signaling = all_pathways,  # Same order as above
                      comparison = c(1, 2),  # Compare group 1 vs group 2
                      remove.isolate = T)

# Create comparison plots
# pdf(fs::path(dir.results,"steatosis_comparison_bubble.pdf"), width = 8, height = 8)
plot(a)
plot(b)
plot(c)
# dev.off()

# Find pathways that differ between conditions
pathways_high <- cellchats[['Hep_high']]@netP$pathways
pathways_low  <- cellchats[['Hep_low']]@netP$pathways

# Pathways specific to high steatosis
high_specific <- setdiff(pathways_high, pathways_low)
print("High steatosis specific pathways:")
print(high_specific)

# Pathways specific to low steatosis
low_specific <- setdiff(pathways_low, pathways_high)
print("Low steatosis specific pathways:")
print(low_specific)

# Common pathways
common_pathways <- intersect(pathways_high, pathways_low)
print("Common pathways:")
print(common_pathways)

# Get pathways from both groups
pathways_high <- cellchats[['Hep_high']]@netP$pathways  
pathways_low <- cellchats[['Hep_low']]@netP$pathways
common_pathways <- intersect(pathways_high, pathways_low)

# Loop through pathways and create comparisons
for(pw in common_pathways) {
  
  # High steatosis
  netVisual_aggregate(
    object = cellchats[['Hep_high']],
    signaling = pw,
    layout = "chord",
    weight.scale = TRUE,
    edge.weight.max = max(cellchats[['Hep_high']]@net$weight),
    title.name = paste(pw, "- High Steatosis")
  )
  
  # Low steatosis  
  netVisual_aggregate(
    object = cellchats[['Hep_low']],
    signaling = pw,
    layout = "chord",
    weight.scale = TRUE,
    edge.weight.max = max(cellchats[['Hep_low']]@net$weight),
    title.name = paste(pw, "- Low Steatosis")
  )
}
```

###iii. Permutation Test for Differences
```{r}
# Permutation Test for CellChat Communication Differences
# Tests differences in pathway communication between high and low steatosis

library(CellChat)
library(dplyr)
library(ggplot2)

# Function to perform permutation test on communication differences
perform_permutation_test <- function(cellchats, n_permutations = 1000, seed = 123) {
  
  set.seed(seed)
  
  # Get common pathways
  pathways_high <- cellchats[['Hep_high']]@netP$pathways
  pathways_low <- cellchats[['Hep_low']]@netP$pathways
  common_pathways <- intersect(pathways_high, pathways_low)
  
  # Initialize results storage
  results <- list()
  
  for(pathway in common_pathways) {
    
    cat(paste("Testing pathway:", pathway, "\n"))
    
    # Get indices for the pathway in each condition
    idx_high <- which(cellchats[['Hep_high']]@netP$pathways == pathway)
    idx_low <- which(cellchats[['Hep_low']]@netP$pathways == pathway)
    
    if(length(idx_high) > 0 && length(idx_low) > 0) {
      
      # Extract communication probability matrices
      prob_high <- cellchats[['Hep_high']]@netP$prob[,,idx_high]
      prob_low <- cellchats[['Hep_low']]@netP$prob[,,idx_low]
      
      # Calculate observed difference in total communication
      obs_diff <- sum(prob_high, na.rm = TRUE) - sum(prob_low, na.rm = TRUE)
      
      # Combine data for permutation
      all_probs <- array(c(prob_high, prob_low), 
                        dim = c(dim(prob_high)[1], dim(prob_high)[2], 2))
      
      # Permutation test
      perm_diffs <- numeric(n_permutations)
      
      for(i in 1:n_permutations) {
        # Randomly assign conditions
        perm_labels <- sample(c(1, 2), 2, replace = FALSE)
        
        perm_high <- all_probs[,,perm_labels[1]]
        perm_low <- all_probs[,,perm_labels[2]]
        
        perm_diffs[i] <- sum(perm_high, na.rm = TRUE) - sum(perm_low, na.rm = TRUE)
      }
      
      # Calculate p-value
      p_value <- mean(abs(perm_diffs) >= abs(obs_diff))
      
      # Calculate effect size (Cohen's d equivalent)
      pooled_sd <- sqrt((var(as.vector(prob_high), na.rm = TRUE) + 
                        var(as.vector(prob_low), na.rm = TRUE)) / 2)
      effect_size <- obs_diff / (pooled_sd * sqrt(length(prob_high)))
      
      # Store results
      results[[pathway]] <- list(
        pathway = pathway,
        observed_diff = obs_diff,
        p_value = p_value,
        effect_size = effect_size,
        perm_diffs = perm_diffs,
        high_total = sum(prob_high, na.rm = TRUE),
        low_total = sum(prob_low, na.rm = TRUE),
        fold_change = sum(prob_high, na.rm = TRUE) / sum(prob_low, na.rm = TRUE)
      )
    }
  }
  
  return(results)
}

# Run the permutation test
perm_results <- perform_permutation_test(cellchats, n_permutations = 1000)

# Convert results to data frame for easy visualization
results_df <- do.call(rbind, lapply(perm_results, function(x) {
  data.frame(
    pathway = x$pathway,
    observed_diff = x$observed_diff,
    p_value = x$p_value,
    effect_size = x$effect_size,
    high_total = x$high_total,
    low_total = x$low_total,
    fold_change = x$fold_change
  )
}))

# Adjust for multiple testing
results_df$p_adj <- p.adjust(results_df$p_value, method = "BH")

# Sort by p-value
results_df <- results_df[order(results_df$p_value),]

print("Permutation test results:")
print(results_df)

# Visualization of results

# 1. Volcano plot
volcano_plot <- ggplot(results_df, aes(x = observed_diff, y = -log10(p_value))) +
  geom_point(aes(size = abs(effect_size), 
                 color = p_value < 0.05),
             alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", alpha = 0.5) +
  geom_text_repel(aes(label = pathway), 
                  size = 3,
                  max.overlaps = 15) +
  scale_color_manual(values = c("TRUE" = "red3", "FALSE" = "gray50"),
                     name = "Significant\n(p < 0.05)") +
  scale_size_continuous(name = "Effect Size",
                        range = c(2, 8)) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank(),
        plot.title = element_text(size = 14, face = "bold")) +
  labs(x = "Difference in Total Communication (High - Low)",
       y = expression(-log[10](p-value)),
       title = "Permutation Test Results for Pathway Communication")

print(volcano_plot)

# 2. Bar plot of fold changes with significance
bar_plot <- ggplot(results_df, aes(x = reorder(pathway, fold_change), 
                                   y = log2(fold_change))) +
  geom_bar(stat = "identity", 
           aes(fill = p_value < 0.05)) +
  geom_hline(yintercept = 0, linetype = "solid", alpha = 0.5) +
  scale_fill_manual(values = c("TRUE" = "darkred", "FALSE" = "gray70"),
                    name = "Significant") +
  coord_flip() +
  theme_minimal() +
  labs(x = "Pathway",
       y = "Log2 Fold Change (High/Low)",
       title = "Pathway Communication Changes")

print(bar_plot)

# 3. Individual pathway permutation distribution plots
plot_permutation_distribution <- function(pathway_name, perm_results) {
  
  result <- perm_results[[pathway_name]]
  
  if(!is.null(result)) {
    df <- data.frame(diff = result$perm_diffs)
    
    p <- ggplot(df, aes(x = diff)) +
      geom_histogram(bins = 50, fill = "gray70", color = "black", alpha = 0.7) +
      geom_vline(xintercept = result$observed_diff, 
                 color = "red", size = 1.5, linetype = "solid") +
      geom_vline(xintercept = 0, 
                 color = "black", linetype = "dashed", alpha = 0.5) +
      theme_minimal() +
      labs(x = "Difference in Communication (High - Low)",
           y = "Count",
           title = paste(pathway_name, "Permutation Test"),
           subtitle = paste("p-value:", round(result$p_value, 4),
                          "| Observed difference:", round(result$observed_diff, 3)))
    
    return(p)
  }
}

# Plot for most significant pathways
sig_pathways <- results_df$pathway[results_df$p_value < 0.05]

if(length(sig_pathways) > 0) {
  for(pathway in sig_pathways[1:min(4, length(sig_pathways))]) {
    p <- plot_permutation_distribution(pathway, perm_results)
    print(p)
  }
}

# 4. Summary heatmap of changes
# Create matrix for heatmap
comm_matrix <- matrix(0, nrow = length(common_pathways), ncol = 2)
rownames(comm_matrix) <- common_pathways
colnames(comm_matrix) <- c("Low Steatosis", "High Steatosis")

for(i in 1:length(common_pathways)) {
  pathway <- common_pathways[i]
  if(pathway %in% results_df$pathway) {
    row_data <- results_df[results_df$pathway == pathway,]
    comm_matrix[i, 1] <- row_data$low_total
    comm_matrix[i, 2] <- row_data$high_total
  }
}

# Scale by row to show relative changes
comm_matrix_scaled <- t(scale(t(comm_matrix)))

library(ComplexHeatmap)

ht <- Heatmap(comm_matrix_scaled,
              name = "Scaled\nCommunication",
              column_title = "Communication Strength by Condition",
              row_title = "Signaling Pathway",
              cluster_columns = FALSE,
              col = circlize::colorRamp2(c(-2, 0, 2), c("blue", "white", "red")),
              row_names_gp = gpar(fontsize = 10),
              column_names_gp = gpar(fontsize = 12))

draw(ht)

# Export significant results
write.csv(results_df[results_df$p_value < 0.05,], 
          "significant_pathway_changes.csv", 
          row.names = FALSE)

# Function to test cell-type specific changes
test_celltype_specific <- function(cellchats, pathway, n_perm = 1000) {
  
  # Get pathway indices
  idx_high <- which(cellchats[['Hep_high']]@netP$pathways == pathway)
  idx_low <- which(cellchats[['Hep_low']]@netP$pathways == pathway)
  
  if(length(idx_high) == 0 || length(idx_low) == 0) {
    return(NULL)
  }
  
  prob_high <- cellchats[['Hep_high']]@netP$prob[,,idx_high]
  prob_low <- cellchats[['Hep_low']]@netP$prob[,,idx_low]
  
  cell_types <- rownames(prob_high)
  results_ct <- list()
  
  for(i in 1:length(cell_types)) {
    for(j in 1:length(cell_types)) {
      
      # Observed difference
      obs_diff <- prob_high[i,j] - prob_low[i,j]
      
      if(!is.na(obs_diff) && (prob_high[i,j] > 0 || prob_low[i,j] > 0)) {
        
        # Simple permutation for this cell pair
        combined <- c(prob_high[i,j], prob_low[i,j])
        perm_diffs <- numeric(n_perm)
        
        for(k in 1:n_perm) {
          perm <- sample(combined)
          perm_diffs[k] <- perm[1] - perm[2]
        }
        
        p_val <- mean(abs(perm_diffs) >= abs(obs_diff))
        
        results_ct[[paste(cell_types[i], cell_types[j], sep = "_")]] <- list(
          source = cell_types[i],
          target = cell_types[j],
          obs_diff = obs_diff,
          p_value = p_val
        )
      }
    }
  }
  
  return(results_ct)
}

# Example: Test cell-type specific changes for PAR pathway
if("PARs" %in% common_pathways) {
  par_celltype_results <- test_celltype_specific(cellchats, "PARs")
  
  # Convert to data frame
  if(!is.null(par_celltype_results)) {
    par_ct_df <- do.call(rbind, lapply(par_celltype_results, as.data.frame))
    par_ct_df <- par_ct_df[order(par_ct_df$p_value),]
    
    print("\nCell-type specific changes for PAR signaling:")
    print(head(par_ct_df, 10))
  }
}


```
