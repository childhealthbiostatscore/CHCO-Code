---
title: "Liver Project"
author: "Hailey Hampson"
date: "2025-02-10"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

# 1. Set up Libraries & Directores
```{r libraries, echo=F, include = F}
library(reprex)
library(tidyverse)
library(BiocManager)        
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(future)
library(colorspace)
library(patchwork)
library(ggdendro)
library(cowplot)
library(ggpubr)
library(venn)
library(rstatix)
library(table1)
library(Biobase)
library(ReactomeGSA)
library(GSEABase)
library(msigdbr)
library(kableExtra)
library(knitr)
library(SingleCellExperiment)
library(fgsea)
library(EnhancedVolcano)
library(openxlsx)
library(BiocManager)
library(MAST)
library(ggrepel)
# library(qpcR)
library(ggpubr)
library(openxlsx)
library(ggplot2)
library(GGally)
library(GSEABase)
library(limma)
library(reshape2)
library(data.table)
library(knitr)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(stringr)
library(NMF)
library(rsvd)
library(RColorBrewer)
library(MAST)
library(devtools)
# install_github("Sun-lab/ideas",force=T)
# library(ideas)
library(foreach)
library(doRNG)
library(doParallel)
library(fs)
registerDoParallel(cores = 6)
library(VennDiagram)
#install.packages("survival")
library(survival)
#install.packages("lme4")  # If not already installed
library(lme4)
#install.packages("lmerTest")
library(lmerTest)

#Local file path
# dir.dat <- c("/Volumes/Peds Endo/Petter Bjornstad")
# dir.dat2 <- c("/Volumes/Peds Endo/Petter Bjornstad/scRNA/data_clean")
# dir.code <- c("/Users/hhampson/Documents/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
# dir.results <- c("/Users/hhampson/Documents/UW/1_Ongoing Projects/Liver scRNAseq/2_Results")

#Lambda file path
# dir.dat <- c("/run/user/1026/gvfs/smb-share:server=ucdenver.pvt,share=som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad")
# dir.code <- c("/home/Github_Repo/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
# dir.results <- c(fs::path(dir.dat,"Liver project/Results"))

#Mac studio
#Mac Studio File Path
dir.dat <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive")
dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Liver Project/Results")
# dir.ipa <- c("/Users/hhampson/Documents/IPA/Results")

#Load functions
source("Liver_functions.R")


knitr::opts_knit$set(root.dir = dir.results)
```

# 2. Load Full Data & Clean: 
## a. snRNA & MetaData
```{r, include = F}
# Liver snRNA data processing
invisible(gc())
#Local
# so_liver_sn <- readRDS(fs::path(dir.dat,"scRNA","data_raw","NoRef_PetterLiver_ClinData_Labels_Char_041924.RDS"))
#Lambda
so_liver_sn <- readRDS(fs::path(dir.dat,"scRNA","data_raw","NoRef_PetterLiver_ClinData_Labels_Char_041924.RDS"))

invisible(gc())
#Local
# meta_liver_raw <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))
#Lambda
meta_liver_raw <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))
unique(meta_liver_raw$Kit_Lot)
meta_liver_raw <- meta_liver_raw %>%
  filter(StudyID!="IT2D-18") %>%
  filter(StudyID!="IT2D-16")
meta_liver_raw <- meta_liver_raw %>%
  mutate(both=ifelse(diagnosis_of_diabetes=="Yes" & glp1agonist=="Yes" & sglt2=="Yes","Yes","No")) %>% 
  mutate(sglt2_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="Yes" & glp1agonist=="No","Yes","No")) %>% 
  mutate(glp1_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="Yes","Yes","No")) %>% 
  mutate(either=ifelse(glp1agonist=="Yes" | sglt2=="Yes","Yes","No")) %>%
  mutate(neither=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="No","Yes","No")) %>%
  mutate(hc=ifelse(diagnosis_of_diabetes=="No","Yes","No"))
meta_liver_raw <- meta_liver_raw %>%
    mutate(group2=case_when(both == "Yes" ~ "both",
                          sglt2_exclusive == "Yes" ~ "sglt2_exclusive",
                          glp1_exclusive == "Yes" ~ "glp1_exclusive",
                          either == "Yes" ~ "either",
                          neither == "Yes" ~ "neither",
                          hc == "Yes" ~ "obese_control"))
meta_liver_raw <- meta_liver_raw %>%
  mutate(group3=ifelse(either=="Yes","either","neither"))

#Create Liver Status Variables
meta_liver_raw <- meta_liver_raw %>%
  mutate(steatosis_cat = ifelse((steatosis_grade==0 | steatosis_grade==1),"0+1","3")) %>%
  mutate(fibrosis_cat = case_when(steatosis_grade==0 & fibrosis_stage==0 ~ "No Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage==0 ~ "Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage>0 ~ "Fibrosis & Steatosis"))

meta_liver_sn <-  so_liver_sn@meta.data[,1:11] %>%
  dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(meta_liver_raw)

rownames(meta_liver_sn) <- rownames(so_liver_sn@meta.data)
so_liver_sn <- AddMetaData(so_liver_sn, meta_liver_sn)
rm(meta_liver_sn,meta_liver_raw)

#Switch default assay in seurat object to RNA
DefaultAssay(so_liver_sn) <- "RNA"
invisible(gc())

#Create liver disease and drug groups
#so_liver_sn@meta.data <- so_liver_sn@meta.data %>% 
#  mutate(both=ifelse(diagnosis_of_diabetes=="Yes" & glp1agonist=="Yes" & sglt2=="Yes","Yes","No")) %>% 
 # mutate(sglt2_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="Yes" & glp1agonist=="No","Yes","No")) %>% 
 # mutate(glp1_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="Yes","Yes","No")) %>% 
#  mutate(either=ifelse(glp1agonist=="Yes" | sglt2=="Yes","Yes","No")) %>%
#  mutate(neither=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="No","Yes","No")) %>%
#  mutate(hc=ifelse(diagnosis_of_diabetes=="No","Yes","No"))

# Create a single grouping variable
#so_liver_sn@meta.data <- so_liver_sn@meta.data %>% 
#  mutate(group2=case_when(both == "Yes" ~ "both",
#                          sglt2_exclusive == "Yes" ~ "sglt2_exclusive",
#                          glp1_exclusive == "Yes" ~ "glp1_exclusive",
#                          either == "Yes" ~ "either",
#                          neither == "Yes" ~ "neither",
#                          hc == "Yes" ~ "obese_control"))

#so_liver_sn@meta.data$group2 <- factor(so_liver_sn@meta.data$group2, levels = c("obese_control","neither","sglt2_exclusive", #"glp1_exclusive","either","both"))

# #Create Diabetes only seurat object
# so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#Create senesence so in all cell types
#sens_gene_in_data <- intersect(sens_genes, rownames(so_liver_sn))
# Subset the Seurat object to include only genes in sens_gene_in_data
#so_sens_all <- subset(so_liver_sn, features = sens_gene_in_data)

# #Filter to hepatocytes only
# so_liver_sn$Hepatocyte <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Yes","No")
# so_hep <- subset(so_liver_sn, Hepatocyte=="Yes")
# rm(so_liver_sn)
# DefaultAssay(so_hep) <- "RNA"  

dim(so_liver_sn) #36601 130124

# Step 1: Filter to genes expressed in more than 5% of cells
gene_expression_matrix <- so_liver_sn@assays$RNA@counts
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.05

so_liver_sn <- subset(so_liver_sn, features = rownames(gene_expression_matrix)[expressed_genes])
dim(so_liver_sn@assays$RNA@counts) #4502 130124
dim(so_liver_sn@assays$RNA) #4502 130124
dim(so_liver_sn) #4502 130124
sum(grepl("^MT-", rownames(so_liver_sn@assays$RNA@counts))) #13
ncol(so_liver_sn) #30124 cells
nrow(so_liver_sn) #4502 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_liver_sn), value = TRUE)
#keep_ids <- unique(rownames(so_liver_sn)[which(!rownames(so_liver_sn) %in% mito_genes)])
# so_liver_sn <- subset(so_liver_sn, features = setdiff(rownames(so_liver_sn), mito_genes))
# so_liver_sn <- subset(so_liver_sn,kit_id!="KL-0029535")
#so_liver_sn$Gene <- rownames(so_liver_sn)
#so_liver_sn <- subset(so_liver_sn, Gene %in% keep_ids)
so_liver_sn <- subset(so_liver_sn, features = setdiff(rownames(so_liver_sn@assays$RNA@counts), mito_genes))
#so_liver_sn <- subset(so_liver_sn, features = setdiff(rownames(so_liver_sn@assays$RNA@counts), mito_genes))
# so_liver_sn <- subset(so_liver_sn, !rownames(so_liver_sn) %in% mito_genes)
# grep("^MT-", rownames(so_liver_sn@assays$RNA@counts), value = TRUE)
dim(so_liver_sn@assays$RNA@counts) #9276 186125
dim(so_liver_sn@assays$RNA@data) #9276 186125
dim(so_liver_sn@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(so_liver_sn@assays$RNA@counts))) #0
ncol(so_liver_sn) #130124 cells
nrow(so_liver_sn) #4489 genes

# # Identify mitochondrial genes
# mt_genes <- grepl("^MT", rownames(so_liver_sn@assays$RNA@counts))
# 
# # Calculate the percentage of mitochondrial genes per cell
# mt_percentage <- Matrix::colSums(so_liver_sn@assays$RNA@counts[mt_genes, ]) / Matrix::colSums(so_liver_sn@assays$RNA@counts)
# 
# # Filter out cells where the proportion of mitochondrial genes is > 15%
# cells_to_keep <- mt_percentage <= 0.15
# 
# # Subset the object to retain only cells with <= 15% mitochondrial genes
# so_liver_sn <- so_liver_sn[, cells_to_keep]

# Check dimensions after filtering
dim(so_liver_sn@assays$RNA@counts) #9276 81882
dim(so_liver_sn@assays$RNA)#9276 81882
dim(so_liver_sn)#9276 81882

# Optionally, you can also check how many MT genes remain in the filtered dataset
sum(grepl("^MT-", rownames(so_liver_sn@assays$RNA@counts)))
ncol(so_liver_sn)  # Number of cells remaining


# Step 3: Renormalize the Seurat object after filtering
so_liver_sn <- NormalizeData(so_liver_sn)

#Check normalized slot
dim(so_liver_sn@assays$RNA@data) #5714 186125
sum(grepl("^MT", rownames(so_liver_sn@assays$RNA@data))) #70
ncol(so_liver_sn) #186125 cells
nrow(so_liver_sn) #5714 genes

rm(gene_expression_matrix)
```

##b. scRNA & MetaData 
```{r, include=F}
invisible(gc())
so_liver_sc <- readRDS(fs::path(dir.dat,"scRNA","data_raw","PB_Liver_7SingleCellDatasets.RDS"))
invisible(gc())

#Switch default assay in seurat object to RNA
DefaultAssay(so_liver_sc) <- "RNA"
invisible(gc())

#Get metadata for each individual with sc data
#Lambda
meta_liver_raw <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))
so_liver_sc$Cryostor_ID <- str_remove(unique(so_liver_sc@meta.data$orig.ident),"-Liv")
liver_ids <- str_remove(unique(so_liver_sc@meta.data$orig.ident),"-Liv")
liver_ids %in% meta_liver_raw$Cryostor_ID

meta_liver_raw <- meta_liver_raw %>%
  filter(Cryostor_ID %in% liver_ids)

meta_liver_raw <- meta_liver_raw %>%
  mutate(both=ifelse(diagnosis_of_diabetes=="Yes" & glp1agonist=="Yes" & sglt2=="Yes","Yes","No")) %>% 
  mutate(sglt2_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="Yes" & glp1agonist=="No","Yes","No")) %>% 
  mutate(glp1_exclusive=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="Yes","Yes","No")) %>% 
  mutate(either=ifelse(glp1agonist=="Yes" | sglt2=="Yes","Yes","No")) %>%
  mutate(neither=ifelse(diagnosis_of_diabetes=="Yes" & sglt2=="No" & glp1agonist=="No","Yes","No")) %>%
  mutate(hc=ifelse(diagnosis_of_diabetes=="No","Yes","No"))
meta_liver_raw <- meta_liver_raw %>%
    mutate(group2=case_when(both == "Yes" ~ "both",
                          sglt2_exclusive == "Yes" ~ "sglt2_exclusive",
                          glp1_exclusive == "Yes" ~ "glp1_exclusive",
                          either == "Yes" ~ "either",
                          neither == "Yes" ~ "neither",
                          hc == "Yes" ~ "obese_control"))
meta_liver_raw <- meta_liver_raw %>%
  mutate(group3=ifelse(either=="Yes","either","neither"))

#Create Liver Status Variables
meta_liver_raw <- meta_liver_raw %>%
  mutate(steatosis_cat = ifelse((steatosis_grade==0 | steatosis_grade==1),"0+1","3")) %>%
  mutate(fibrosis_cat = case_when(steatosis_grade==0 & fibrosis_stage==0 ~ "No Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage==0 ~ "Steatosis, No Fibrosis",
                                  steatosis_grade>0 & fibrosis_stage>0 ~ "Fibrosis & Steatosis"))



meta_liver_sc <-  so_liver_sc@meta.data[,c(9,123)] %>%
  #dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(meta_liver_raw,by=c("Cryostor_ID"))

rownames(meta_liver_sc) <- rownames(so_liver_sc@meta.data)
so_liver_sc <- AddMetaData(so_liver_sc, meta_liver_sc)
rm(meta_liver_sc,meta_liver_raw)

#Switch default assay in seurat object to RNA
DefaultAssay(so_liver_sc) <- "RNA"
invisible(gc())


dim(so_liver_sc) #36601 130124

# Step 1: Filter to genes expressed in more than 5% of cells
gene_expression_matrix <- so_liver_sc@assays$RNA@counts
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.05

so_liver_sc <- subset(so_liver_sc, features = rownames(gene_expression_matrix)[expressed_genes])
dim(so_liver_sc@assays$RNA@counts) #4502 130124
dim(so_liver_sc@assays$RNA) #4502 130124
dim(so_liver_sc) #4502 130124
sum(grepl("^MT-", rownames(so_liver_sc@assays$RNA@counts))) #13
ncol(so_liver_sc) #30124 cells
nrow(so_liver_sc) #4502 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_liver_sc), value = TRUE)
#keep_ids <- unique(rownames(so_liver_sc)[which(!rownames(so_liver_sc) %in% mito_genes)])
# so_liver_sc <- subset(so_liver_sc, features = setdiff(rownames(so_liver_sc), mito_genes))
# so_liver_sc <- subset(so_liver_sc,kit_id!="KL-0029535")
#so_liver_sc$Gene <- rownames(so_liver_sc)
#so_liver_sc <- subset(so_liver_sc, Gene %in% keep_ids)
so_liver_sc <- subset(so_liver_sc, features = setdiff(rownames(so_liver_sc@assays$RNA@counts), mito_genes))
#so_liver_sc <- subset(so_liver_sc, features = setdiff(rownames(so_liver_sc@assays$RNA@counts), mito_genes))
# so_liver_sc <- subset(so_liver_sc, !rownames(so_liver_sc) %in% mito_genes)
# grep("^MT-", rownames(so_liver_sc@assays$RNA@counts), value = TRUE)
dim(so_liver_sc@assays$RNA@counts) #9276 186125
dim(so_liver_sc@assays$RNA@data) #9276 186125
dim(so_liver_sc@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(so_liver_sc@assays$RNA@counts))) #0
ncol(so_liver_sc) #130124 cells
nrow(so_liver_sc) #4489 genes

# # Identify mitochondrial genes
# mt_genes <- grepl("^MT", rownames(so_liver_sc@assays$RNA@counts))
# 
# # Calculate the percentage of mitochondrial genes per cell
# mt_percentage <- Matrix::colSums(so_liver_sc@assays$RNA@counts[mt_genes, ]) / Matrix::colSums(so_liver_sc@assays$RNA@counts)
# 
# # Filter out cells where the proportion of mitochondrial genes is > 15%
# cells_to_keep <- mt_percentage <= 0.15
# 
# # Subset the object to retain only cells with <= 15% mitochondrial genes
# so_liver_sc <- so_liver_sc[, cells_to_keep]

# Check dimensions after filtering
dim(so_liver_sc@assays$RNA@counts) #9276 81882
dim(so_liver_sc@assays$RNA)#9276 81882
dim(so_liver_sc)#9276 81882

# Optionally, you can also check how many MT genes remain in the filtered dataset
sum(grepl("^MT-", rownames(so_liver_sc@assays$RNA@counts)))
ncol(so_liver_sc)  # Number of cells remaining


# Step 3: Renormalize the Seurat object after filtering
so_liver_sc <- NormalizeData(so_liver_sc)

#Check normalized slot
dim(so_liver_sc@assays$RNA@data) #5714 186125
sum(grepl("^MT", rownames(so_liver_sc@assays$RNA@data))) #70
ncol(so_liver_sc) #186125 cells
nrow(so_liver_sc) #5714 genes

rm(gene_expression_matrix)
```

# 3. Outline 
### a. Comparison Groups of Interest
1. Steatosis (0+1 vs. 2+3)
2. No Liver Disease (No Steatosis, No Fibrosis) vs. Steatosis (1,2, or 3 Steatosis, No Fibrosis) vs. Fibrosis (Any Fibrosis, Any Steatosis)

### b. Disease Categories of Interest
1. OB (Obese Controls Only)
a. T2D + OB (Full Cohort: Type 2s and Obese Controls)

### e. Characteristics of Interest
HbA1c, Medication Status, TGs

### f. Gene Sets & Genes of Interest
1. All Genes 
2. Senescence 
3. Metabolism
4. Inflammation
5. PNLAP3
6. GCKR
7. TM6SF2
8. APOC3
9. MTOR
10. Growth Factors
11. HNF4alpha?

### g. Analysis Plan
1. All Genes
  a. DEGS + IPA
  b. LMEM + IPA, adjusting for HbA1c, Med Status, TGs 
  c. Pseuodbulk all cell types
  d. Hepatocytes
  e. Cell Specific (All other cell types)
2. Pathway Gene Sets
  a. DEGS + IPA
  b. LMEM + IPA, adjusting for HbA1c, Med Status, TGs
  c. Pseuodbulk all cell types
  d. Hepatocytes
  e. Cell Specific (All other cell types)

#4. Descriptive Statistics
## a. Participants with Single Nucleus Data
```{r, echo = F,warning=F}
#Define disease and drug groups
# dat <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))
#dat <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/scRNA/data_clean/liver_biopsy_metadata_PN.csv")

dat <- so_liver_sn@meta.data %>%
  dplyr::select(all_of(c("StudyID","RNAlater_ID","Cryostor_ID","nih_sex","nih_ethnicity","nih_race","bmi","diagnosis_of_diabetes",
                         "diagnosis_of_MASLD",
                         "steatosis_grade","fibrosis_stage",
                         "lobular_inflammation_percent","tg","creatinine",
                         "alt","ast","ggt","age_surgery","glp1agonist","sglt2","group2",
                         "group3","meds","insulin","metformin","StudyID","steatosis_cat","fibrosis_cat","a1c"
                         )))  %>%
  group_by(RNAlater_ID) %>%
  summarise(across(everything(), first)) %>%
  ungroup() 
dat$study <- case_when(grepl("IT2D",dat$StudyID) ~ "IMPROVE",
                       grepl("MANGO",dat$StudyID) ~ "MANGO",
                       grepl("BSA",dat$StudyID) ~ "BIOBANK")
dat <- dat %>% 
  mutate(both=ifelse(glp1agonist=="Yes" & sglt2=="Yes","Yes","No")) %>% 
  mutate(sglt2_exclusive=ifelse(sglt2=="Yes" & glp1agonist=="No","Yes","No")) %>% 
  mutate(glp1_exclusive=ifelse(sglt2=="No" & glp1agonist=="Yes","Yes","No")) %>% 
  mutate(neither=ifelse(sglt2=="No" & glp1agonist=="No","Yes","No")) 

# table(dat2$sglt2_exclusive) #-/+ #5 No, 0 yes
# table(dat2$glp1_exclusive) #+/- # 2 Yes, 3 No
# table(dat2$both) #+/+ #1 Both, 4 not both
# table(dat2$neither) #-/- #3 neither, 2 on someting
dat$steatosis_cat <- factor(dat$steatosis_cat,levels=c("0+1","3"),labels=c("Low Steatosis (0+1)","High Steatosis (3)"))
dat$fibrosis_cat <- factor(dat$fibrosis_cat)
dat$diagnosis_of_MASLD <- factor(dat$diagnosis_of_MASLD, levels=c("Yes","No"), labels=c("MASLD", "No MASLD"))
dat$diagnosis_of_diabetes <- factor(dat$diagnosis_of_diabetes, levels=c("Yes","No"), labels=c("Type 2 Diabetes", "Obese Controls"))
dat$nih_sex     <- factor(dat$nih_sex, levels=c("Male", "Female"), labels=c("Male", "Female"))
dat$nih_ethnicity   <- factor(dat$nih_ethnicity, levels=c("Hispanic_Or_Latino","NonHispanic"), labels=c("Hispanic or Latino","Non-Hispanic/Non-Latino"))
dat$nih_race   <- factor(dat$nih_race, levels=c("White","BlackAfAm","Multiracial","Other"),
                         labels=c("White","Black","Multirace","Other"))
dat$steatosis_grade <- as.factor(dat$steatosis_grade)
dat$fibrosis_stage <- as.factor(dat$fibrosis_stage)
dat$lobular_inflammation_percent <- as.factor(dat$lobular_inflammation_percent)

label(dat$age_surgery)      <- "Age (y)"
label(dat$sglt2_exclusive) <- "SGLT2 Inhibitors (Yes/No)"
label(dat$glp1agonist) <- "GLP-1 Receptor Agonists (Yes/No)"
label(dat$sglt2) <- "SGLT2 Inhibitors (Yes/No)"
label(dat$nih_sex)      <- "Sex"
label(dat$nih_race)    <- "Race"
label(dat$nih_ethnicity)    <- "Ethnicity"
label(dat$diagnosis_of_diabetes)  <- "Diabetes Status (Yes/No)"
label(dat$diagnosis_of_MASLD) <- "MASLD (Yes/No)"
label(dat$bmi)   <- "Body Mass Index (kg/m2)"
label(dat$diagnosis_of_MASLD)  <- "MASLD Status"
label(dat$a1c) <- "HbA1c (%)"
#label(dat$sbp)     <- "Systolic Blood Pressure (mmHg)"
#label(dat$dbp) <- "Diastolic Blood Pressure (mmHg)"
label(dat$tg) <-  "Triglycerides (mg/dL)"
label(dat$creatinine) <-  "Creatinine (mg/dL)"
label(dat$steatosis_grade) <- "Steatosis Grade"
label(dat$fibrosis_stage) <- "Fibrosis Stage"
label(dat$lobular_inflammation_percent) <- "Lobular Inflammation Percent (%)"
label(dat$sglt2_exclusive) <- "Exclusive SGLT2 Inhibitors (Yes/No)"
label(dat$glp1_exclusive) <- "Exclusive GLP-1 Receptor Agonists (Yes/No)"
#label(dat$group2) <- "Disease Group"
label(dat$both) <- "SLGT2i + GLP-1ra (Yes/No)"
label(dat$neither) <- "No SGLT2i or GLP-1ra (Yes/No)"
label(dat$metformin) <- "Metformin (Yes/No)"
label(dat$insulin) <- "Insulin (Yes/No)"
label(dat$alt) <- "ALT (U/L)"
label(dat$ast) <- "AST (U/L)"
label(dat$ggt) <- "GGT (U/L)"
label(dat$fibrosis_cat) <- "Fibrosis Category"
label(dat$steatosis_cat) <- "Steatosis Category"

#Table 1. 
table1(~ age_surgery + nih_sex + nih_race + nih_ethnicity + bmi + tg + a1c+
         diagnosis_of_diabetes + diagnosis_of_MASLD+
         sglt2 + glp1agonist  | study, data=dat)

table1(~ age_surgery + nih_sex + nih_race + nih_ethnicity + bmi + tg +a1c+
          diagnosis_of_MASLD+
         sglt2 + glp1agonist +metformin + insulin | diagnosis_of_diabetes, data=dat)

table1(~ a1c+ diagnosis_of_MASLD+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + steatosis_grade + fibrosis_stage + lobular_inflammation_percent  
         | diagnosis_of_diabetes, data=dat)

table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + steatosis_cat + fibrosis_cat +steatosis_grade + fibrosis_stage + lobular_inflammation_percent  
         | diagnosis_of_MASLD, data=dat)

table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + lobular_inflammation_percent  
         | steatosis_cat, data=dat)
table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + lobular_inflammation_percent  
         | fibrosis_cat, data=dat)

```

## b. Participants with Single Cell Data
```{r, echo = F,warning=F}
#Define disease and drug groups
# dat <- read.csv(fs::path(dir.dat,"scRNA","data_clean","liver_biopsy_metadata_PN.csv"))
#dat <- read.csv("/Volumes/Peds Endo/Petter Bjornstad/scRNA/data_clean/liver_biopsy_metadata_PN.csv")

dat <- so_liver_sc@meta.data %>%
  dplyr::select(all_of(c("Cryostor_ID","nih_sex","nih_ethnicity","nih_race","bmi","diagnosis_of_diabetes",
                         "diagnosis_of_MASLD",
                         "steatosis_grade","fibrosis_stage",
                         "lobular_inflammation_percent","tg","creatinine",
                         "alt","ast","ggt","age_surgery","glp1agonist","sglt2","group2",
                         "group3","meds","insulin","metformin","StudyID","steatosis_cat","fibrosis_cat","a1c"
                         )))  %>%
  group_by(Cryostor_ID) %>%
  summarise(across(everything(), first)) %>%
  ungroup() 
dat$study <- ifelse(grepl("IT2D",dat$StudyID),"IMPROVE","MANGO")
dat <- dat %>% 
  mutate(both=ifelse(glp1agonist=="Yes" & sglt2=="Yes","Yes","No")) %>% 
  mutate(sglt2_exclusive=ifelse(sglt2=="Yes" & glp1agonist=="No","Yes","No")) %>% 
  mutate(glp1_exclusive=ifelse(sglt2=="No" & glp1agonist=="Yes","Yes","No")) %>% 
  mutate(neither=ifelse(sglt2=="No" & glp1agonist=="No","Yes","No")) 

# table(dat2$sglt2_exclusive) #-/+ #5 No, 0 yes
# table(dat2$glp1_exclusive) #+/- # 2 Yes, 3 No
# table(dat2$both) #+/+ #1 Both, 4 not both
# table(dat2$neither) #-/- #3 neither, 2 on someting

dat$steatosis_cat <- factor(dat$steatosis_cat,levels=c("0+1","3"),labels=c("Low Steatosis (0+1)","High Steatosis (3)"))
dat$fibrosis_cat <- factor(dat$fibrosis_cat)
dat$diagnosis_of_MASLD <- factor(dat$diagnosis_of_MASLD, levels=c("Yes","No"), labels=c("MASLD", "No MASLD"))
dat$diagnosis_of_diabetes <- factor(dat$diagnosis_of_diabetes, levels=c("Yes","No"), labels=c("Type 2 Diabetes", "Obese Controls"))
dat$nih_sex     <- factor(dat$nih_sex, levels=c("Male", "Female"), labels=c("Male", "Female"))
dat$nih_ethnicity   <- factor(dat$nih_ethnicity, levels=c("Hispanic_Or_Latino","NonHispanic"), labels=c("Hispanic or Latino","Non-Hispanic/Non-Latino"))
dat$nih_race   <- factor(dat$nih_race, levels=c("White","BlackAfAm","Multiracial","Other"),
                         labels=c("White","Black","Multirace","Other"))
dat$steatosis_grade <- as.factor(dat$steatosis_grade)
dat$fibrosis_stage <- as.factor(dat$fibrosis_stage)
dat$lobular_inflammation_percent <- as.factor(dat$lobular_inflammation_percent)

label(dat$age_surgery)      <- "Age (y)"
label(dat$sglt2_exclusive) <- "SGLT2 Inhibitors (Yes/No)"
label(dat$glp1agonist) <- "GLP-1 Receptor Agonists (Yes/No)"
label(dat$sglt2) <- "SGLT2 Inhibitors (Yes/No)"
label(dat$nih_sex)      <- "Sex"
label(dat$nih_race)    <- "Race"
label(dat$nih_ethnicity)    <- "Ethnicity"
label(dat$diagnosis_of_diabetes)  <- "Diabetes Status (Yes/No)"
label(dat$diagnosis_of_MASLD) <- "MASLD (Yes/No)"
label(dat$bmi)   <- "Body Mass Index (kg/m2)"
label(dat$diagnosis_of_MASLD)  <- "MASLD Status"
label(dat$a1c) <- "HbA1c (%)"
#label(dat$sbp)     <- "Systolic Blood Pressure (mmHg)"
#label(dat$dbp) <- "Diastolic Blood Pressure (mmHg)"
label(dat$tg) <-  "Triglycerides (mg/dL)"
label(dat$creatinine) <-  "Creatinine (mg/dL)"
label(dat$steatosis_grade) <- "Steatosis Grade"
label(dat$fibrosis_stage) <- "Fibrosis Stage"
label(dat$lobular_inflammation_percent) <- "Lobular Inflammation Percent (%)"
label(dat$sglt2_exclusive) <- "Exclusive SGLT2 Inhibitors (Yes/No)"
label(dat$glp1_exclusive) <- "Exclusive GLP-1 Receptor Agonists (Yes/No)"
#label(dat$group2) <- "Disease Group"
label(dat$both) <- "SLGT2i + GLP-1ra (Yes/No)"
label(dat$neither) <- "No SGLT2i or GLP-1ra (Yes/No)"
label(dat$metformin) <- "Metformin (Yes/No)"
label(dat$insulin) <- "Insulin (Yes/No)"
label(dat$alt) <- "ALT (U/L)"
label(dat$ast) <- "AST (U/L)"
label(dat$ggt) <- "GGT (U/L)"
label(dat$fibrosis_cat) <- "Fibrosis Category"
label(dat$steatosis_cat) <- "Steatosis Category"

#Table 1. 
table1(~ age_surgery + nih_sex + nih_race + nih_ethnicity + bmi + tg + a1c+
         diagnosis_of_diabetes + diagnosis_of_MASLD+
         sglt2 + glp1agonist  | study, data=dat)

table1(~ age_surgery + nih_sex + nih_race + nih_ethnicity + bmi + tg +a1c+
          diagnosis_of_MASLD+
         sglt2 + glp1agonist +metformin + insulin | diagnosis_of_diabetes, data=dat)

table1(~ a1c+ diagnosis_of_MASLD+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + steatosis_grade + fibrosis_stage + lobular_inflammation_percent  
         | diagnosis_of_diabetes, data=dat)

table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + steatosis_cat + fibrosis_cat +steatosis_grade + fibrosis_stage + lobular_inflammation_percent  
         | diagnosis_of_MASLD, data=dat)

table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + lobular_inflammation_percent  
         | steatosis_cat, data=dat)
table1(~ a1c+ diagnosis_of_diabetes+ sglt2 + glp1agonist + metformin + insulin + alt + ast + ggt + lobular_inflammation_percent  
         | fibrosis_cat, data=dat)

```

# 5. DEGS & IPA
## A. Single Nuc
### i. All Genes
#### a. Pseudobulk Cells
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Steatosis Low vs. Steatosis High
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#GLP-1s/SGLT2s 
#Whole Cohort
#GLP1 vs. no med

#SGLT2 vs. no med

#SGLT2 + GLP1 vs. no med

#
```

#### b. Hepatocytes
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte","Non-Hepatocyte")
#dim(so_liver_sn)
#Filter to Hepatocytes only
so_subset <- subset(so_liver_sn,celltype2=="Hepatocyte")
all_genes <- rownames(so_subset)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#APOC-111 
length(unique(so_liver_sn$Kit_Lot))
all_genes <- rownames(so_subset)
all_genes <- intersect("APOC3",rownames(so_liver_sn))
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="No",top_gsea = 30)

```

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
all_genes <- rownames(so_liver_sn)
all_cell_types <- unique(so_liver_sn$celltype)
Idents(so_liver_sn) <- so_liver_sn$celltype

for (cell in all_cell_types[-1]) {
  result <- degs_fxn(so=so_liver_sn,cell=cell,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)
  print(result)
}

```

### ii. Specific Genes & Pathways
####a. Pseudobulk
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Steatosis Low vs. Steatosis High
#Senescence 
sub_genes <- intersect(sens_genes, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Senescence")

#Metabolism
#TCA
sub_genes <- intersect(tca, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="TCA")

#Gluconeogenesis
sub_genes <- intersect(gluco, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Gluconeogenesis")

#Glycolysis
sub_genes <- intersect(tca, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Glycolysis")

#Beta Oxidation
sub_genes <- intersect(beta_ox, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Beta Oxidation")

#Oxidative Phosphoylation
sub_genes <- intersect(ox_phos, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Oxidative Phosphorylation")

#Lipid Metabolism
sub_genes <- intersect(lipid_met, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Lipid Metabolism")

#Energy Metabolism
sub_genes <- intersect(energy_met, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Energy Metabolism")

#Metabolism
sub_genes <- intersect(met, rownames(so_liver_sn))
so_subset <- subset(so_liver_sn,features=sub_genes)
all_genes <- rownames(so_subset)
degs_fxn_pathway(so=so_subset,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",pathway="Metabolism")

#Inflammation
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#PNLAP3
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#GCKR
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#TM6SF2
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#APOC3
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#MTOR
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#Growth Factors
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#HNF4alpha?
all_genes <- rownames(so_liver_sn)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)



```

#### b. Hepatocytes
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte","Non-Hepatocyte")
#dim(so_liver_sn)
#Filter to Hepatocytes only
so_subset <- subset(so_liver_sn,celltype2=="Hepatocyte")
all_genes <- rownames(so_subset)
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

```

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
all_genes <- rownames(so_liver_sn)
all_cell_types <- unique(so_liver_sn$celltype)
Idents(so_liver_sn) <- so_liver_sn$celltype

for (cell in all_cell_types[-1]) {
  result <- degs_fxn(so=so_liver_sn,cell=cell,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)
  print(result)
}

```

## B. Single Cell
### i. All Genes
#### a. Pseudobulk Cells
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Steatosis Low vs. Steatosis High
all_genes <- rownames(so_liver_sc)
degs_fxn(so=so_liver_sc,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

#GLP-1s/SGLT2s 
#Whole Cohort
#GLP1 vs. no med

#SGLT2 vs. no med

#SGLT2 + GLP1 vs. no med

#
```

#### b. Hepatocytes
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sc$celltype)
so_liver_sc$celltype <- as.character(so_liver_sc$celltype)
so_liver_sc$celltype2 <- ifelse(grepl("Hepatocyte",so_liver_sc$celltype),"Hepatocyte","Non-Hepatocyte")
#dim(so_liver_sc)
#Filter to Hepatocytes only
so_subset <- subset(so_liver_sc,celltype2=="Hepatocyte")
all_genes <- rownames(so_subset)
degs_fxn(so=so_liver_sc,cell=NULL,gene_set=all_genes,exposure="steatosis_cat",exp_group="3",ref_group="0+1",enrichment="No",top_gsea = 30)

```
#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```

### ii. Specific Genes & Pathways
#### a. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Among Type 2: No meds vs. GLP-1 Exclusive
##SGLT2i only -/+ #5 No, 0 yes
#GLP-1 only +/- # 2 Yes, 3 No
#Both +/+ #1 Both, 4 not both
#Neither-/- #3 neither, 2 on someting

all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)

#Create diab so
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)

```

#### b. Hepatocytes

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```


# 6. LMEM
## A. Single Nuc
### i. All Genes
#### a. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Among Type 2: No meds vs. GLP-1 Exclusive
##SGLT2i only -/+ #5 No, 0 yes
#GLP-1 only +/- # 2 Yes, 3 No
#Both +/+ #1 Both, 4 not both
#Neither-/- #3 neither, 2 on someting

all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)

#Create diab so
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)

```

#### b. Hepatocytes

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```

### ii. Specific Genes & Pathways
#### a. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Among Type 2: No meds vs. GLP-1 Exclusive
##SGLT2i only -/+ #5 No, 0 yes
#GLP-1 only +/- # 2 Yes, 3 No
#Both +/+ #1 Both, 4 not both
#Neither-/- #3 neither, 2 on someting

all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)

#Create diab so
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)

```

#### b. Hepatocytes

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```

## B. Single Cell
### i. All Genes
#### a. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Among Type 2: No meds vs. GLP-1 Exclusive
##SGLT2i only -/+ #5 No, 0 yes
#GLP-1 only +/- # 2 Yes, 3 No
#Both +/+ #1 Both, 4 not both
#Neither-/- #3 neither, 2 on someting

all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)

#Create diab so
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)

```

#### b. Hepatocytes

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```

### ii. Specific Genes & Pathways
#### a. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Among Type 2: No meds vs. GLP-1 Exclusive
##SGLT2i only -/+ #5 No, 0 yes
#GLP-1 only +/- # 2 Yes, 3 No
#Both +/+ #1 Both, 4 not both
#Neither-/- #3 neither, 2 on someting

all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
degs_fxn(so=so_liver_sn,cell=NULL,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)

#Create diab so
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
degs_fxn(so=so_sub,cell=NULL,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)

```

#### b. Hepatocytes

#### c. All Cell Types
```{r, echo=F,warning=F,fig.width=15,fig.height=9}
#Major Cell Types
#unique(so_liver_sn$celltype)
so_liver_sn$celltype <- as.character(so_liver_sn$celltype)
so_liver_sn$celltype2 <- ifelse(grepl("Hep-",so_liver_sn$celltype),"Hepatocyte",
                                ifelse(grepl("Stellate-",so_liver_sn$celltype),"Stellate",
                                       ifelse(grepl("EC-",so_liver_sn$celltype),"EC",so_liver_sn$celltype)))
all_cell_types <- unique(so_liver_sn$celltype2)
all_genes <- rownames(so_liver_sn)
#Diabetes yes vs. no
for (cell_type in all_cell_types) {
  degs_fxn(so=so_liver_sn,cell=cell_type,gene_set=all_genes,exposure="diagnosis_of_diabetes",exp_group="Yes",ref_group="No",enrichment="Yes",top_gsea = 30)
}

#Create diab so 
so_diab <- subset(so_liver_sn,diagnosis_of_diabetes=="Yes")

#GLP-1 vs. None
so_sub <- subset(so_diab,group2!="both")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="glp1_exclusive",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
#GLP-1 vs. Both
so_sub <- subset(so_diab,group2!="neither")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-6]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="glp1_exclusive",enrichment="Yes",top_gsea = 30)
}
#Both vs. None
so_sub <- subset(so_diab,group2!="glp1_exclusive")
so_sub$group2 <- factor(so_sub$group2)
#Define genes
all_genes <- rownames(so_sub)
all_cell_types <- unique(so_sub$celltype2)[-11]
for (cell_type in all_cell_types) {
  degs_fxn(so=so_sub,cell=cell_type,gene_set=all_genes,exposure="group2",exp_group="both",ref_group="neither",enrichment="Yes",top_gsea = 30)
}
```