---
title: "Pima Master Data"
author: "Tim Vigers & Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(DT)
library(arsenal)
library(skimr)
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE)
home_dir = ifelse(.Platform$OS.type != "unix","T:/",
                  "/Volumes/som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/Pima/Master data/Raw data")
knitr::opts_knit$set(root.dir = home_dir)
```

```{r incl}
# Import datasets
vital_status = read.csv('./NelsonVitalStatusDEC_DATA_2021-02-04_1616.csv',na.strings = "")

g4 = read.csv('./Group4UofMRemodel112_DATA_2021-02-04_1617.csv',na.strings = "")
g4$protocol = "GROUP4"

ficoll = read.csv('./FicollUniversityOfMi_DATA_2021-02-04_1618.csv',na.strings = "")
ficoll$protocol = "FICOLL"

ddn = read.csv('./Nelson13DKN151Determ_DATA_2021-02-04_1610.csv',na.strings = "")
ddn$protocol = "DDN"

losartan = read.csv('./NelsonPECRBRenoprote_DATA_2021-02-04_1619.csv',na.strings = "")
losartan$protocol = "LCT"
```

```{r vital status}
# Collapse rows - get first non-NA element in each column by record ID
vital_status %>% group_by('record_id') %>% 
  mutate(
    esrd_start_date = first(na.omit(esrd_start_date)),
    dod = first(na.omit(dod)),
    codunerlying = first(na.omit(codunerlying))) %>% 
  ungroup() %>% select(record_id,esrd_start_date,dod,coddrunerlying)
```

```{r g4}
# Unite date columns
date_cols = colnames(g4)[grep("f\\d{,2}visitdate$",colnames(g4))]
g4 = g4 %>% unite(date,all_of(date_cols),na.rm = T,remove = F)
g4$date = lubridate::ymd(sapply(strsplit(g4$date,"_"),function(x){unique(x)[1]}))
# Unite test interval columns
int_cols = colnames(g4)[grep("*testintrvl$|*testintvrl$|*testintvl$",colnames(g4))]
g4 = g4 %>% unite(testint,all_of(int_cols),na.rm = T,remove = F)
g4$testint = as.numeric(g4$testint)
```

```{r}
# Rename variables
t = g4 %>% rename(nih = record_id,date_dx = dtdiabonset)
# Select variables of interest
t = t %>% select(nih,sacaton_no,phx_number,dob,date_dx,testint,
                   protocol)
# Fill in missing for non-time varying 
t = t %>% group_by(nih) %>% fill(sacaton_no,phx_number,dob,date_dx)
# Print
datatable(t)
```
