---
title: "07_scRNA_pathway_reversal_figures"
author: "Ye Ji Choi"
format: html
---

```{r}
library(dplyr)
library(aws.s3)
library(jsonlite)
library(ggplot2)
library(ggforce)
```

```{r}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}

source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_functions.R"))
source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_scRNA_functions.R"))
```

```{r}
# Pull in nebula results
folders <- c(
  # new additions
  "T2D_GLP_Y_vs_T2D_GLP_N" = "t2d_glpyn",
  "T2D_GLP_N_vs_HC" = "t2d_glpn_hc"
)

# Define common parameters
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  aPT = "aPT",
  `PT-S1/S2` = "PT-S1/S2",
  `PT-S3` = "PT-S3",
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  `C-TAL-1` = "C-TAL-1",
  `C-TAL-2` = "C-TAL-2",
  aTAL = "aTAL",
  dTAL = "dTAL",
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC", "EC-A"),
  `EC-AVR` = "EC-AVR",
  `EC-GC`  = "EC-GC",
  `EC-PTC` = "EC-PTC",
  `EC-AEA` = "EC-AEA",
  `EC-LYM` = "EC-LYM",
  `EC/VSMC` = "EC/VSMC",
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  Immune_Myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_Lymphoid = c("CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  IC = c("IC-A", "IC-B", "aIC"),
  DTL_ATL = c("DTL", "aDTL", "ATL"),
  DCT_CNT = c("DCT", "dDCT", "CNT"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD",
  MC = "MC",
  PEC = "PEC",
  Schwann = "SchwannCells"
)

```

```{r}
# load all the necessary files (processed df and pathways)
gsea_results <- list()
for (folder in names(folders)) {
  for (cell in names(celltype_groups)) {
    
    var_name <- paste0(tolower(cell), "_", folders[folder])
    var_name <- gsub("/", "_", var_name)
    
    processed_path <- file.path(
      root_path,
      paste0("Renal HERITAGE/Results/nebula/csv/full/", var_name, "_kpmp.csv")
    )
    
    if (!file.exists(processed_path)) {
      message("Processed DF not found, skipping: ", var_name)
      next
    }
    
    processed_df <- read.csv(processed_path)
    assign(var_name, processed_df, envir = .GlobalEnv)
    
    file_path <- file.path(root_path, paste0("Renal HERITAGE/Results/GSEA/hallmark_", folders[[folder]], "_", tolower(gsub("/", "_", cell)), "_gsea.RDS"))
    
    # Check if file exists and read it
    if (file.exists(file_path)) {
      # Create a unique name for this combination
      result_name <- paste0(folders[[folder]], "_", tolower(gsub("/", "_", cell)))
      
      # Read the RDS file
      gsea_results[[result_name]] <- readRDS(file_path)
    } else {
      message(paste0("File not found: ", file_path))
    }
  }
}
```


```{r}
# check on some genes for Petter
gene_list <- c(
  "PLVAP",
  "LRG1",
  "A2M",
  "IL13RA2",
  "SOST2",
  "EHD3",
  "FAS",
  "SLC16A3",
  "FSCN1",
  "S100A6",
  "VCAM1",
  "ICAM1",
  "SELE",
  "CXCL9",
  "CXCL10",
  "CCL2",
  "FOS",
  "JUN",
  "EGR1",
  "SROHINH1",
  "ACTA2",
  "VIM",
  "TAGLN",
  "CDH5",
  "PECAM1"
)

gene_search <- data.frame()
for (folder in names(folders)) {
  for (cell in names(celltype_groups)) {
    
    var_name <- paste0(tolower(cell), "_", folders[folder])
    var_name <- gsub("/", "_", var_name)
    
    processed_path <- file.path(
      root_path,
      paste0("Renal HERITAGE/Results/nebula/csv/full/", var_name, "_kpmp.csv")
    )
    
    if (!file.exists(processed_path)) {
      message("Processed DF not found, skipping: ", var_name)
      next
    }
    
    processed_df <- read.csv(processed_path)
    
    processed_df_subset <- processed_df %>%
      dplyr::select(logFC = 2, pval = 6, 10, 9) %>%
      mutate(cell = cell, run = folder) %>%
      filter(Gene %in% gene_list & pval < 0.05) 

    gene_search <- rbind(gene_search, processed_df_subset)
      
  }
}

gene_search <- gene_search %>%
  arrange(Gene, cell)

write.csv(gene_search, file.path(root_path, "Renal HERITAGE/Results/Summary csv/nebula_transcript_search.csv"), row.names = F, na =)
```

```{r}
make_leadingedge_long <- function(
    hallmark_df,
    de_glpn_hc,            # gene-level table for DKD GLP- vs HC
    de_glpy_glpn,          # gene-level table for DKD GLP+ vs GLP-
    logfc_col_glpn_hc,
    pval_col_glpn_hc,
    logfc_col_glpy_glpn,
    pval_col_glpy_glpn,
    comp1_label = "DKD GLP- vs. HC",
    comp2_label = "DKD GLP+ vs. GLP-"
) {
  
  # expand pathway -> leadingEdge genes
  lead <- hallmark_df %>%
    dplyr::transmute(
      pathway,
      leadingEdge
    ) %>%
    tidyr::unnest(leadingEdge) %>%
    dplyr::rename(Gene = leadingEdge) %>%
    distinct(pathway, Gene)
  
  # pull stats for comparison 1
  d1 <- de_glpn_hc %>%
    dplyr::select(
      Gene,
      logFC = all_of(logfc_col_glpn_hc),
      pval  = all_of(pval_col_glpn_hc)
    ) %>%
    mutate(comparison = comp1_label)
  
  # pull stats for comparison 2
  d2 <- de_glpy_glpn %>%
    dplyr::select(
      Gene,
      logFC = all_of(logfc_col_glpy_glpn),
      pval  = all_of(pval_col_glpy_glpn)
    ) %>%
    mutate(comparison = comp2_label)
  
  # join leadingEdge genes to both comparisons, then keep genes with both comps
  out <- lead %>%
    left_join(d1, by = "Gene") %>%
    bind_rows(
      lead %>% left_join(d2, by = "Gene")
    ) %>%
    group_by(pathway, Gene) %>%
    filter(sum(!is.na(logFC)) == 2) %>%   # gene exists in both comps
    ungroup()
  
  out
}

```

```{r}
# Most responsive cell type to GLP1RA
sig_df_summary_comp <- read.csv(file.path(root_path, "Renal HERITAGE/Results/Summary csv/nebula_deg_results_summary.csv"))

# low res cell types
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC", "EC-A"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  IC = c("IC-A", "IC-B", "aIC"),
  DTL_ATL = c("DTL", "aDTL", "ATL"),
  DCT_CNT = c("DCT", "dDCT", "CNT"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD",
  MC = "MC",
  PEC = "PEC",
  Schwann = "SchwannCells"
)

# high res cell types
celltype_groups_high <- list(
  aPT = "aPT",
  `PT-S1/S2` = "PT-S1/S2",
  `PT-S3` = "PT-S3",
  `C-TAL-1` = "C-TAL-1",
  `C-TAL-2` = "C-TAL-2",
  aTAL = "aTAL",
  dTAL = "dTAL",
  `EC-AVR` = "EC-AVR",
  `EC-GC`  = "EC-GC",
  `EC-PTC` = "EC-PTC",
  `EC-AEA` = "EC-AEA",
  `EC-LYM` = "EC-LYM",
  `EC/VSMC` = "EC/VSMC",
  Immune_Myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_Lymphoid = c("CD4+ T", "CD8+ T", "B", "NK", "cycT")
)

# T2D GLP Y vs GLP N
sig_df_clean <- sig_df_summary_comp %>%
  filter(analysis_type == "T2D_GLP_Y_vs_T2D_GLP_N") %>%
  arrange(desc(Total)) %>%
  pivot_longer(
    cols = c(Positive, Negative),
    names_to = "Direction",
    values_to = "Count"
  ) %>%
  mutate(
    Count = ifelse(Direction == "Negative", -Count, Count),
    celltype = factor(celltype, levels = rev(unique(celltype)))  # keeps nice top-to-bottom order
  )

sig_df_clean %>%
  filter(celltype %in% names(celltype_groups_high)) %>%
  ggplot(aes(x = Count, y = celltype, fill = Direction)) +
  geom_col(width = 0.7) +
  geom_vline(xintercept = 0, color = "white", linewidth = 0.6) +
  geom_text(aes(label = celltype, x = 0), size = 4) +
  scale_x_continuous(
    labels = abs,
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_fill_manual(
    values = c("Negative" = "#c0d6df", "Positive" = "#f4978e")
  ) +
  labs(
    x = "Number of DE genes",
    y = NULL,
    fill = NULL
  ) +
  theme(
    legend.position = "top",
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(file.path(root_path, paste0("Renal HERITAGE/Results/Figures/DEG summary/deg_summary_t2d_glpy_glpn_highres.png")))

sig_df_clean %>%
  filter(celltype %in% names(celltype_groups)) %>%
  ggplot(aes(x = Count, y = celltype, fill = Direction)) +
  geom_col(width = 0.7) +
  geom_vline(xintercept = 0, color = "white", linewidth = 0.6) +
  geom_text(aes(label = celltype, x = 0), size = 4) +
  scale_x_continuous(
    labels = abs,
    expand = expansion(mult = c(0.01, 0.01))
  ) +
  scale_fill_manual(
    values = c("Negative" = "#c0d6df", "Positive" = "#f4978e")
  ) +
  labs(
    x = "Number of DE genes",
    y = NULL,
    fill = NULL
  ) +
  theme(
    legend.position = "top",
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(file.path(root_path, paste0("Renal HERITAGE/Results/Figures/DEG summary/deg_summary_t2d_glpy_glpn_lowres.png")))
```

## (DKD30 GLP+ vs. GLP-) vs. (DKD30 GLP- vs. HC) 

### Bar plots from JCI paper

```{r}
# first look for significant pathways
# then look at the gene sets in those pathways
# then plot the direction of logFCs of those genes in GLPN vs. HC and GLPY vs. GLPN
for (cell in names(celltype_groups)) {
  # define vars
  cellname = tolower(gsub("/", "_", cell))
  glpn_hc = "dkd30_glpn_hc"
  glpn_hc_var <- paste0(cellname, "_", glpn_hc)
  glpn_hc_df <- get(glpn_hc_var)
  
  glpy_glpn = "dkd_30_glpy_glpn"
  glpy_glpn_var <- paste0(cellname, "_", glpy_glpn)
  glpy_glpn_df <- get(glpy_glpn_var)
  
  # filter to significant hallmark pathways
  glpn_hc_hallmark <- gsea_results[[paste0(glpn_hc, "_", cellname)]]$hallmark %>%
    filter(pval < 0.05)
  glpy_glpn_hallmark <- gsea_results[[paste0(glpy_glpn, "_", cellname)]]$hallmark %>%
    filter(pval < 0.05)  
  
  # create df to plot
  plot_df <- bind_rows(
    make_leadingedge_long(
      hallmark_df       = glpn_hc_hallmark,
      de_glpn_hc        = glpn_hc_df,
      de_glpy_glpn      = glpy_glpn_df,
      logfc_col_glpn_hc = "logFC_dkd_group_30_hcDKD",
      pval_col_glpn_hc  = "p_dkd_group_30_hcDKD",
      logfc_col_glpy_glpn = "logFC_glp_t2dobGLP_Y",
      pval_col_glpy_glpn  = "p_glp_t2dobGLP_Y",
      comp1_label = "DKD GLP- vs. HC",
      comp2_label = "DKD GLP+ vs. GLP-"
    ),
    make_leadingedge_long(
      hallmark_df       = glpy_glpn_hallmark,
      de_glpn_hc        = glpn_hc_df,
      de_glpy_glpn      = glpy_glpn_df,
      logfc_col_glpn_hc = "logFC_dkd_group_30_hcDKD",
      pval_col_glpn_hc  = "p_dkd_group_30_hcDKD",
      logfc_col_glpy_glpn = "logFC_glp_t2dobGLP_Y",
      pval_col_glpy_glpn  = "p_glp_t2dobGLP_Y",
      comp1_label = "DKD GLP- vs. HC",
      comp2_label = "DKD GLP+ vs. GLP-"
    )
  ) %>%
    distinct(pathway, Gene, comparison, .keep_all = TRUE)
  
  # count reversed genes
  pathway_rev_summary <-  plot_df %>%
    dplyr::select(-pval) %>%
    group_by(Gene) %>%
    pivot_wider(
      names_from = comparison,
      values_from = logFC) %>%
    mutate(
      reversed = sign(`DKD GLP- vs. HC`) != sign(`DKD GLP+ vs. GLP-`)
    ) %>% ungroup() %>%
    group_by(pathway) %>%
    summarise(n_genes = sum(!is.na(reversed)),
              n_reversed = sum(reversed, na.rm = TRUE),
              pct_reversed = 100 * n_reversed / n_genes,
              .groups = "drop")
  
  plot_df <- plot_df %>%
    left_join(pathway_rev_summary %>% select(pathway, pct_reversed), by = "pathway") %>%
    mutate(pathway_lab = paste0(gsub("HALLMARK ", "", gsub("_", " ", pathway)), "\n(", sprintf("%.1f", pct_reversed), "% Reversed)"))
  
  # plot
  n_pages <- ceiling(length(unique(plot_df$pathway)) / 6)
  for (i in seq_len(n_pages)) {
    p <- ggplot(plot_df, aes(x = Gene, y = logFC, fill = comparison)) +
      geom_col(position = position_dodge(width = 0.8), width = 0.7) +
      facet_wrap_paginate(
        ~ pathway_lab,
        nrow = 3,
        ncol = 2,
        scales = "free_x",
        page = i
      ) +
      labs(
        x = NULL,
        y = "logFC",
        title = paste0(cell, " pathways (", i, "/", n_pages, ")"),
        fill = NULL
      ) +
      theme_minimal() +
      theme(
        panel.grid = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom"
      )
    
    ggsave(file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathway comparisons/DKD30/hallmark_dkd30_glpyn_glpn_hc_", cellname, "_", i, ".png")),
           width = 15)
  }
}
```

### Bar plots of pathways

```{r}
gsea_results$t2d_glpyn_ec

glpn_hc_hallmark <- gsea_results[[paste0(glpn_hc, "_", cellname)]]$hallmark %>%
  filter(pval < 0.05)
glpy_glpn_hallmark <- gsea_results[[paste0(glpy_glpn, "_", cellname)]]$hallmark %>%
  filter(pval < 0.05)  

```



## (T2D GLP+ vs. GLP-) vs. (T2D GLP- vs. HC) 

```{r}
# first look for significant pathways
# then look at the gene sets in those pathways
# then plot the direction of logFCs of those genes in GLPN vs. HC and GLPY vs. GLPN
for (cell in names(celltype_groups)) {
  
  cellname <- tolower(gsub("/", "_", cell))
  
  glpn_hc   <- "t2d_glpn_hc"
  glpy_glpn <- "t2d_glpyn"
  
  glpn_hc_var   <- paste0(cellname, "_", glpn_hc)
  glpy_glpn_var <- paste0(cellname, "_", glpy_glpn)
  
  # -------------------------
  # 1) Skip if dfs don't exist
  # -------------------------
  if (!exists(glpn_hc_var, envir = .GlobalEnv) || !exists(glpy_glpn_var, envir = .GlobalEnv)) {
    message("Skipping ", cellname, ": missing processed dfs (", glpn_hc_var, " or ", glpy_glpn_var, ")")
    next
  }
  
  glpn_hc_df   <- get(glpn_hc_var, envir = .GlobalEnv)
  glpy_glpn_df <- get(glpy_glpn_var, envir = .GlobalEnv)
  
  # -------------------------
  # 2) Skip if GSEA results missing
  # -------------------------
  gsea_glpn_key   <- paste0(glpn_hc, "_", cellname)
  gsea_glpy_key   <- paste0(glpy_glpn, "_", cellname)
  
  if (!gsea_glpn_key %in% names(gsea_results) || !gsea_glpy_key %in% names(gsea_results)) {
    message("Skipping ", cellname, ": missing gsea_results (", gsea_glpn_key, " or ", gsea_glpy_key, ")")
    next
  }
  
  # -------------------------
  # 3) Skip if hallmark missing/empty
  # -------------------------
  glpn_obj <- gsea_results[[gsea_glpn_key]]
  glpy_obj <- gsea_results[[gsea_glpy_key]]
  
  if (is.null(glpn_obj$hallmark) || is.null(glpy_obj$hallmark)) {
    message("Skipping ", cellname, ": hallmark table missing in GSEA object(s)")
    next
  }
  
  glpn_hc_hallmark <- glpn_obj$hallmark %>% filter(pval < 0.05)
  glpy_glpn_hallmark <- glpy_obj$hallmark %>% filter(pval < 0.05)
  
  if (nrow(glpn_hc_hallmark) == 0 && nrow(glpy_glpn_hallmark) == 0) {
    message("Skipping ", cellname, ": no significant hallmark pathways in either comparison")
    next
  }
  
  # -------------------------
  # create df to plot
  # -------------------------
  plot_df <- bind_rows(
    make_leadingedge_long(
      hallmark_df          = glpn_hc_hallmark,
      de_glpn_hc           = glpn_hc_df,
      de_glpy_glpn         = glpy_glpn_df,
      logfc_col_glpn_hc    = "logFC_glp_t2dobGLP_N",
      pval_col_glpn_hc     = "p_glp_t2dobGLP_N",
      logfc_col_glpy_glpn  = "logFC_glp_t2dobGLP_Y",
      pval_col_glpy_glpn   = "p_glp_t2dobGLP_Y",
      comp1_label          = "T2D GLP- vs. HC",
      comp2_label          = "T2D GLP+ vs. GLP-"
    ),
    make_leadingedge_long(
      hallmark_df          = glpy_glpn_hallmark,
      de_glpn_hc           = glpn_hc_df,
      de_glpy_glpn         = glpy_glpn_df,
      logfc_col_glpn_hc    = "logFC_glp_t2dobGLP_N",
      pval_col_glpn_hc     = "p_glp_t2dobGLP_N",
      logfc_col_glpy_glpn  = "logFC_glp_t2dobGLP_Y",
      pval_col_glpy_glpn   = "p_glp_t2dobGLP_Y",
      comp1_label          = "T2D GLP- vs. HC",
      comp2_label          = "T2D GLP+ vs. GLP-"
    )
  ) %>%
    distinct(pathway, Gene, comparison, .keep_all = TRUE)
  
  # If still nothing to plot (e.g., no overlapping genes), skip
  if (nrow(plot_df) == 0) {
    message("Skipping ", cellname, ": plot_df empty after leadingEdge overlap filter")
    next
  }
  
  # -------------------------
  # count reversed genes (FIXED grouping!)
  # -------------------------
  pathway_rev_summary <- plot_df %>%
    select(pathway, Gene, comparison, logFC) %>%
    pivot_wider(names_from = comparison, values_from = logFC) %>%
    mutate(reversed = sign(`T2D GLP- vs. HC`) != sign(`T2D GLP+ vs. GLP-`)) %>%
    group_by(pathway) %>%
    summarise(
      n_genes = sum(!is.na(reversed)),
      n_reversed = sum(reversed, na.rm = TRUE),
      pct_reversed = 100 * n_reversed / n_genes,
      .groups = "drop"
    )
  
  plot_df <- plot_df %>%
    left_join(pathway_rev_summary %>% select(pathway, pct_reversed), by = "pathway") %>%
    mutate(pathway_lab = paste0(gsub("HALLMARK ", "", gsub("_", " ", pathway)), "\n(", sprintf("%.1f", pct_reversed), "% Reversed)"))
  
  n_pages <- ceiling(length(unique(plot_df$pathway)) / 6)
  
  for (i in seq_len(n_pages)) {
    p <- ggplot(plot_df, aes(x = Gene, y = logFC, fill = comparison)) +
      geom_col(position = position_dodge(width = 0.8), width = 0.7) +
      ggforce::facet_wrap_paginate(
        ~ pathway_lab,
        nrow = 3, ncol = 2,
        scales = "free_x",
        page = i
      ) +
      labs(
        x = NULL,
        y = "logFC",
        title = paste0(cell, " pathways (", i, "/", n_pages, ")"),
        fill = NULL
      ) +
      theme_minimal() +
      theme(
        panel.grid = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom"
      )
    
    ggsave(
      filename = file.path(
        root_path,
        paste0("Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/hallmark_t2d_glpyn_glpn_hc_", cellname, "_", i, ".png")
      ),
      plot = p,
      width = 15
    )
  }
}
```

### N of transcripts reversed by GLP1RA in each cell type

```{r}
t2d_glp_rev_combined <- data.frame()

for (cell in names(celltype_groups)) {
  
  cellname <- tolower(gsub("/", "_", cell))
  
  glpn_hc   <- "t2d_glpn_hc"
  glpy_glpn <- "t2d_glpyn"
  
  glpn_hc_var   <- paste0(cellname, "_", glpn_hc)
  glpy_glpn_var <- paste0(cellname, "_", glpy_glpn)
  
  # -------------------------
  # 1) Skip if dfs don't exist
  # -------------------------
  if (!exists(glpn_hc_var, envir = .GlobalEnv) || !exists(glpy_glpn_var, envir = .GlobalEnv)) {
    message("Skipping ", cellname, ": missing processed dfs (", glpn_hc_var, " or ", glpy_glpn_var, ")")
    next
  }
  
  glpn_hc_df   <- get(glpn_hc_var, envir = .GlobalEnv)
  glpy_glpn_df <- get(glpy_glpn_var, envir = .GlobalEnv)
  
  glpn_hc_df_sig <- glpn_hc_df %>%
    dplyr::select(logFC = logFC_glp_t2dobGLP_N, p.val = p_glp_t2dobGLP_N, fdr, Gene) %>%
    mutate(celltype = cell, comparison = "T2D GLP (-) vs HC")
  glpy_glpn_df_sig <- glpy_glpn_df %>% 
    dplyr::select(logFC = logFC_glp_t2dobGLP_Y, p.val = p_glp_t2dobGLP_Y, fdr, Gene) %>%
    mutate(celltype = cell, comparison = "T2D GLP (+) vs T2D GLP(-)")  
  
  t2d_glp_comp <- rbind(glpn_hc_df_sig, glpy_glpn_df_sig) %>%
    mutate(
      sgn = if_else(p.val < 0.05, sign(logFC), NA_real_)
    ) %>%
    group_by(Gene, celltype) %>%
    mutate(
      sgn_glpn_hc   = sgn[comparison == "T2D GLP (-) vs HC"][1],
      sgn_glpy_glpn = sgn[comparison == "T2D GLP (+) vs T2D GLP(-)"][1],
      direction = case_when(
        is.na(sgn_glpn_hc) | is.na(sgn_glpy_glpn) ~ NA_character_,
        sgn_glpn_hc == sgn_glpy_glpn              ~ "Not Reversed",
        TRUE                                      ~ "Reversed"
      ),
      rev_direction = case_when(
        direction == "Reversed" & sgn_glpy_glpn == -1 ~"Suppressed",
        direction == "Reversed" & sgn_glpy_glpn == 1  ~ "Enhanced"
      )
    ) %>%
    ungroup() %>%
    filter(!is.na(direction)) %>%
    select(-sgn, -sgn_glpn_hc, -sgn_glpy_glpn) %>%
    distinct(Gene, celltype, .keep_all = T)
  
  t2d_glp_rev_combined <- rbind(t2d_glp_rev_combined, t2d_glp_comp)
}

# Reversed vs. not reversed
t2d_glp_dir_summary <- t2d_glp_rev_combined %>%
  group_by(celltype, direction) %>%
  dplyr::summarise(n = n()) %>%
  mutate(total_n = sum(n)) %>%
  arrange(desc(total_n)) %>% ungroup() %>%
  mutate(celltype = factor(celltype, levels = unique(celltype)),
         percentage = n/total_n)

# Reversed vs. not-reversed
t2d_glp_dir_summary %>%
  ggplot(aes(x = celltype, y = n, fill = direction)) +
  geom_col(width = 0.7) +
  scale_fill_manual(
    values = c("Not Reversed" = "#f2a65a", "Reversed" = "#8fb996")
  ) +
  labs(
    x = NULL,
    y = "N of transcripts\naffected by GLP1RA",
    fill = NULL
  ) +
  theme(
    legend.position = "top",
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 50, hjust = 1)
  )

ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/N_transcripts_direction_barplot.png"),
       width = 7, height = 5)
# reversed in percentage
t2d_glp_dir_summary %>%
  ggplot(aes(x = celltype, y = percentage, fill = direction)) +
  geom_col(width = 0.7) +
  scale_fill_manual(
    values = c("Reversed" = "#8fb996")
  ) +
  labs(
    x = NULL,
    y = "% of transcripts\naffected by GLP1RA",
    fill = NULL
  ) +
  theme(
    legend.position = "top",
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 50, hjust = 1)
  )

ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/N_transcripts_direction_barplot_percentage.png"),
       width = 7, height = 5)

# Of the reversed, enhanced vs. suppressed
t2d_glp_rev_summary <- t2d_glp_rev_combined %>%
  filter(direction == "Reversed") %>%
  group_by(celltype, rev_direction) %>%
  dplyr::summarise(n = n()) %>%
  mutate(total_n = sum(n)) %>%
  arrange(desc(total_n)) %>% ungroup() %>%
  mutate(celltype = factor(celltype, levels = unique(celltype)))

t2d_glp_rev_summary %>%
  ggplot(aes(x = celltype, y = n, fill = rev_direction)) +
  geom_col(width = 0.7) +
  scale_fill_manual(
    values = c("Suppressed" = "#669bbc", "Enhanced" = "#df7373")
  ) +
  labs(
    x = NULL,
    y = "N of transcripts\nreversed by GLP1RA",
    fill = NULL
  ) +
  theme(
    legend.position = "top",
    panel.background = element_blank(),
    text = element_text(size = 15),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(angle = 50, hjust = 1)
  )

ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/N_transcripts_reversed_barplot.png"),
       width = 7, height = 5)
```

### Pathways of reversed transcripts
```{r}
rev_reactome_df <- data.frame()

for (cell in names(celltype_groups)) {
  sup_genes <- t2d_glp_rev_combined %>%
    filter(celltype == cell) %>%
    filter(rev_direction == "Suppressed") %>%
    pull(Gene)
  enh_genes <- t2d_glp_rev_combined %>%
    filter(celltype == cell) %>%
    filter(rev_direction == "Enhanced") %>%
    pull(Gene)
  
  sup_genes_reactome <- enrichr(sup_genes, databases = "Reactome_Pathways_2024")
  enh_genes_reactome <- enrichr(enh_genes, databases = "Reactome_Pathways_2024") 
  
  sup_genes_reactome_df <- sup_genes_reactome$Reactome_Pathways_2024 %>%
    mutate(bg = "Suppressed",
           n_genes = as.numeric(gsub("/.*", "", Overlap)),
           celltype = cell,
           neg_logp = -log10(P.value))
  
  enh_genes_reactome_df <- enh_genes_reactome$Reactome_Pathways_2024 %>%
    mutate(bg = "Enhanced",
           n_genes = as.numeric(gsub("/.*", "", Overlap)),
           celltype = cell,
           neg_logp = -log10(P.value))
  
  rev_reactome_df <- rbind(rev_reactome_df, sup_genes_reactome_df, enh_genes_reactome_df)
}

rev_reactome_sig <- rev_reactome_df %>%
  filter(P.value < 0.05) %>%
  group_by(Term, bg) %>%
  mutate(n = n()) %>%
  filter(n > 5)

rev_reactome_sig %>%
  filter(bg == "Suppressed") %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#669bbc", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_suppressed_reactome_dotplot.png"),
       width = 12, height = 5)
  
 rev_reactome_sig %>%
  filter(bg == "Enhanced") %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#df7373", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_enhanced_reactome_dotplot.png"),
       width = 7, height = 3)
# rev_reactome_sig %>%
#   filter(bg == "Suppressed") %>%
#   pull(Term) %>%
#   unique()
# 
# rev_reactome_sig %>%
#   filter(bg == "Enhanced") %>%
#   pull(Term) %>%
#   unique()

rev_reactome_celltypes <- rev_reactome_df %>%
  filter(P.value < 0.05) %>%
  group_by(Term, bg) %>%
  mutate(n = n()) %>%
  filter(celltype %in% c("EC", "Immune", "VSMC_P_FIB"))

rev_reactome_celltypes %>%
  filter(bg == "Suppressed" & n > 5) %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#669bbc", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_suppressed_reactome_dotplot_celltypes.png"),
       width = 12, height = 20)
  
 rev_reactome_celltypes %>%
  filter(bg == "Enhanced" & n > 5) %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#df7373", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_enhanced_reactome_dotplot_celltypes.png"),
       width = 12, height = 15)


rev_reactome_celltypes %>%
  filter(bg == "Suppressed" & Adjusted.P.value < 0.1) %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#669bbc", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_suppressed_reactome_dotplot_celltypes_fdr.png"),
       width = 12, height = 8)
  
 rev_reactome_celltypes %>%
  filter(bg == "Enhanced" & Adjusted.P.value < 0.1) %>%
  ggplot(aes(x = celltype, y = Term, size = n_genes, color = neg_logp)) +
  geom_point() +
  theme_minimal(base_size = 15) +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = NULL, y = NULL, size = "N of genes", color = "-log10(P)") +
  scale_color_gradient2(mid = "white", high = "#df7373", midpoint = 0)
ggsave(file.path(root_path, "Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/rev_enhanced_reactome_dotplot_celltypes_fdr.png"),
       width = 12, height = 8)
```

```{r}
# first look for significant pathways
# then look at the gene sets in those pathways
# then plot the direction of logFCs of those genes in GLPN vs. HC and GLPY vs. GLPN
for (cell in names(celltype_groups)) {
  
  cellname <- tolower(gsub("/", "_", cell))
  
  glpn_hc   <- "t2d_glpn_hc"
  glpy_glpn <- "t2d_glpyn"
  
  glpn_hc_var   <- paste0(cellname, "_", glpn_hc)
  glpy_glpn_var <- paste0(cellname, "_", glpy_glpn)
  
  # -------------------------
  # 1) Skip if dfs don't exist
  # -------------------------
  if (!exists(glpn_hc_var, envir = .GlobalEnv) || !exists(glpy_glpn_var, envir = .GlobalEnv)) {
    message("Skipping ", cellname, ": missing processed dfs (", glpn_hc_var, " or ", glpy_glpn_var, ")")
    next
  }
  
  glpn_hc_df   <- get(glpn_hc_var, envir = .GlobalEnv)
  glpy_glpn_df <- get(glpy_glpn_var, envir = .GlobalEnv)
  
  # -------------------------
  # define pathways from reactome
  # -------------------------
  rev_reactome_sig_combined <- 
    rev_reactome_sig %>%
    filter(bg == "Enhanced" & celltype == cell) %>%
    head(5) %>%
    separate_rows(Genes, sep = ";") %>%
    rbind(rev_reactome_sig %>%
            filter(bg == "Suppressed" & celltype == cell) %>%
            head(5) %>%
            separate_rows(Genes, sep = ";")) %>%
    dplyr::select(pathway = Term, Gene = Genes, bg, celltype)
  
  if (nrow(rev_reactome_sig_combined) == 0) {
    message("Skipping ", cell, ": no significant Reactome pathways")
    next
  }
  
  # -------------------------
  # create df to plot
  # -------------------------

  plot_df <- bind_rows(
    glpn_hc_df %>%
    separate_rows(Gene, sep = ";") %>%
    dplyr::select(Gene, logFC = logFC_glp_t2dobGLP_N,
                  p.val = p_glp_t2dobGLP_N, fdr) %>%
      mutate(comparison = "T2D GLP- vs. HC"),
    glpy_glpn_df %>%
    separate_rows(Gene, sep = ";") %>%
    dplyr::select(Gene, logFC = logFC_glp_t2dobGLP_Y,
                  p.val = p_glp_t2dobGLP_Y, fdr) %>%
      mutate(comparison = "T2D GLP+ vs. GLP-")
  ) %>%
    left_join(rev_reactome_sig_combined) %>%
    filter(!is.na(pathway))
  
  
  
  # If still nothing to plot (e.g., no overlapping genes), skip
  if (nrow(plot_df) == 0) {
    message("Skipping ", cellname, ": plot_df empty after leadingEdge overlap filter")
    next
  }
  
  # -------------------------
  # count reversed genes
  # -------------------------
  pathway_rev_summary <- plot_df %>%
    select(pathway, Gene, comparison, logFC) %>%
    pivot_wider(names_from = comparison, values_from = logFC) %>%
    mutate(reversal_direction = case_when(`T2D GLP+ vs. GLP-` > 0 ~ "Enhanced", T ~ "Suppressed")) %>%
    distinct(pathway, reversal_direction)
  
  plot_df <- plot_df %>%
    left_join(pathway_rev_summary %>% select(pathway, reversal_direction), by = "pathway") %>%
    mutate(pathway_lab = paste0(pathway, "\n(", reversal_direction, ")"))
  
  n_pages <- ceiling(length(unique(plot_df$pathway)) / 4)
  
  for (i in seq_len(n_pages)) {
    p <- ggplot(plot_df, aes(x = Gene, y = logFC, fill = comparison)) +
      geom_col(position = position_dodge(width = 0.8), width = 0.7) +
      ggforce::facet_wrap_paginate(
        ~ pathway_lab,
        nrow = 2, ncol = 2,
        scales = "free_x",
        page = i
      ) +
      labs(
        x = NULL,
        y = "logFC",
        title = paste0(cell, " pathways (", i, "/", n_pages, ")"),
        fill = NULL
      ) +
      theme_minimal() +
      theme(
        panel.grid = element_blank(),
        axis.text.x = element_text(angle = 40, hjust = 1),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom"
      ) +
      scale_fill_manual(values = c("grey", "#e8998d"))
    
    ggsave(
      filename = file.path(
        root_path,
        paste0("Renal HERITAGE/Results/Figures/Pathway comparisons/T2D/reactome_t2d_glpyn_glpn_hc_", cellname, "_", i, ".png")
      ),
      plot = p,
      width = 15
    )
  }
}
```

