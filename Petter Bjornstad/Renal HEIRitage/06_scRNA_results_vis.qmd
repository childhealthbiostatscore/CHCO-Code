---
title: "scRNA results report"
author: "Ye Ji Choi"
format:
  revealjs:
    embed-resources: true
    scrollable: true
    transition: slide
    controls-layout: bottom-right
    menu: true
    toc: true
    toc-depth: 1
    fontsize: 15
    number-sections: true
---

```{r include = F}
library(jsonlite)
library(aws.s3)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(lmerTest)
library(emmeans)
library(broom)
library(ggbeeswarm)
library(lemon)
library(quantreg)
library(readxl)
```

```{r include = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```


```{r include = F}
source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_functions.R"))
```

```{r echo = F}
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC", "EC-A"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  IC = c("IC-A", "IC-B", "aIC"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  DTL_ATL = c("DTL", "aDTL", "ATL"),
  DCT_CNT = c("DCT", "dDCT", "CNT"),
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD",
  MC = "MC",
  PEC = "PEC",
  Schwann = "SchwannCells"
)
```

# Descriptive

```{r echo = F, echo = F}
rh_rh2_croc_panther_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_croc_panther_unique.csv"))
rh_rh2_croc_improve_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_croc_improve_unique.csv")) %>%
  mutate(kit_id = gsub("Kl", "KL", kit_id))
rh_rh2_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_unique.csv"))
bx_meta <- s3readRDS(object = "data_clean/subset/pb90_ckd_analysis_subset_meta.rds", bucket = "scrna", region = "")

bx_subset <- rh_rh2_croc_improve_unique %>%
  filter(kit_id %in% bx_meta$kit_id)
bx_subset$dkd_group_100_hc <- factor(bx_subset$dkd_group_100_hc, levels = c("HC", "non_DKD", "DKD"))
bx_subset$dkd_group_30_hc <- factor(bx_subset$dkd_group_30_hc, levels = c("HC", "non_DKD", "DKD"))
```

## DKD defined by UACR ≥ 30 | eGFR < 90

```{r echo = F, results = 'asis'}
summary(arsenal::tableby(dkd_group_30_hc ~ group + age + sex + kwt(acr_u, "medianq1q3") + hba1c +
                           eGFR_CKD_epi + gfr_raw_plasma + gfr_bsa_plasma + bmi + diabetes_duration + epic_glp1ra_1 + epic_sglti2_1, 
                         data=bx_subset),
        total = F, digits = 1)
```

## DKD defined by UACR ≥ 100 | eGFR < 90

```{r echo = F, results = 'asis'}
summary(arsenal::tableby(dkd_group_100_hc ~ group + age + sex + kwt(acr_u, "medianq1q3") + hba1c +
                           eGFR_CKD_epi + gfr_raw_plasma + gfr_bsa_plasma + bmi + diabetes_duration + epic_glp1ra_1 + epic_sglti2_1, 
                         data=bx_subset),
        total = F, digits = 1)
```

# DKD Disease Impact

## DKD vs. non-DKD within T2D only (30)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_t2d"
for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD vs. non-DKD within T2D/OB (30)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD vs. non-DKD within T2D only (100)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_t2d"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD vs. non-DKD within T2D/OB (100)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## non-DKD (within T2D only) vs. HC (30)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_t2d_hc"
for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## non-DKD (within T2D/OB) vs. HC (30)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## non-DKD (within T2D only) vs. HC (100)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_t2d_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## non-DKD (within T2D/OB) vs. HC (100)

### DEGs & Pathways

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

# Drug Impact

## DKD+ GLP+ vs. DKD + GLP- (30)

```{r echo = F, results = 'asis', eval = F}
folder = specify

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD+ GLP+ vs. DKD + GLP- (100)

```{r echo = F, results = 'asis', eval = F}
folder = specify

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD- GLP+ vs. DKD- GLP- (30)

```{r echo = F, results = 'asis', eval = F}
folder = specify

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD- GLP+ vs. DKD- GLP- (100)

```{r echo = F, results = 'asis', eval = F}
folder = specify

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD- GLP+ vs. HC (30)

```{r echo = F, results = 'asis', eval = F}
folder = "nondkd30_glpy_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD- GLP+ vs. HC (100)

```{r echo = F, results = 'asis', eval = F}
folder = "nondkd100_glpy_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD+ GLP+ vs. HC (30)

```{r echo = F, results = 'asis', eval = F}
folder = "dkd30_glpy_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```

## DKD+ GLP+ vs. HC (100)

```{r echo = F, results = 'asis', eval = F}
folder = "dkd100_glpy_hc"

for (cell in names(celltype_groups)) {
  cat("::: {layout-ncol=2}\n\n")
  
  cat(paste0("![p-value < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", 
                                      tolower(cell), ".png")), ")\n\n"))

  cat(paste0("![FDR < 0.05](", file.path(root_path, 
                               paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", 
                                      tolower(cell), "_fdr.png")), ")\n\n"))
  cat(":::\n\n")
  
  cat(paste0("![](", file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", tolower(cell), "_gsea.png")),
             ")\n\n"))
}
```



