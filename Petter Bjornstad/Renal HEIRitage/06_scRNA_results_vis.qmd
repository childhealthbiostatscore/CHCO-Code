---
title: "scRNA results report"
author: "Ye Ji Choi"
format:
  revealjs:
    embed-resources: true
    scrollable: true
    transition: slide
    controls-layout: bottom-right
    menu: true
    toc: true
    toc-depth: 3
    fontsize: 15
    number-sections: true
---

```{r include = F}
library(jsonlite)
library(aws.s3)
library(knitr)
library(dplyr)
library(kableExtra)
library(tidyverse)
library(lmerTest)
library(emmeans)
library(broom)
library(ggbeeswarm)
library(lemon)
library(quantreg)
library(readxl)
```

```{r include = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-SharedLibraries-UW/Laura Pyle - Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r include = F}
## Create an S3 client
keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")

Sys.setenv(
  "AWS_ACCESS_KEY_ID" = keys$MY_ACCESS_KEY,
  "AWS_SECRET_ACCESS_KEY" = keys$MY_SECRET_KEY,
  "AWS_DEFAULT_REGION" = "",
  "AWS_REGION" = "",
  "AWS_S3_ENDPOINT" = "s3.kopah.uw.edu"
)
```


```{r include = F}
source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_functions.R"))
```

```{r echo = F}
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  aPT = "aPT",
  `PT-S1/S2` = "PT-S1/S2",
  `PT-S3` = "PT-S3",
  `PT-1` = "PT-1",
  `PT-2` = "PT-2",
  `PT-3` = "PT-3",
  `PT-4` = "PT-4",
  `PT-5` = "PT-5",
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  `C-TAL-1` = "C-TAL-1",
  `C-TAL-2` = "C-TAL-2",
  aTAL = "aTAL",
  dTAL = "dTAL",
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC", "EC-A"),
  `EC-AVR` = "EC-AVR",
  `EC-GC`  = "EC-GC",
  `EC-PTC` = "EC-PTC",
  `EC-AEA` = "EC-AEA",
  `EC-LYM` = "EC-LYM",
  `EC/VSMC` = "EC/VSMC",
  Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  Immune_Myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_Lymphoid = c("CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  IC = c("IC-A", "IC-B", "aIC"),
  DTL_ATL = c("DTL", "aDTL", "ATL"),
  DCT_CNT = c("DCT", "dDCT", "CNT"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD",
  MC = "MC",
  PEC = "PEC",
  Schwann = "SchwannCells"
)
```

# Descriptive

```{r echo = F, echo = F}
rh_rh2_croc_panther_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_croc_panther_unique.csv"))
rh_rh2_croc_improve_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_croc_improve_unique.csv")) %>%
  mutate(kit_id = gsub("Kl", "KL", kit_id))
rh_rh2_unique <- read.csv(file.path(root_path, "Renal HERITAGE/Data_Cleaned/rh_rh2_unique.csv"))
bx_meta <- s3readRDS(object = "data_clean/subset/pb90_ckd_analysis_subset_meta.rds", bucket = "scrna", region = "")

bx_subset <- rh_rh2_croc_improve_unique %>%
  filter(kit_id %in% bx_meta$kit_id)
bx_subset$dkd_group_100_hc <- factor(bx_subset$dkd_group_100_hc, levels = c("HC", "non_DKD", "DKD"))
bx_subset$dkd_group_30_hc <- factor(bx_subset$dkd_group_30_hc, levels = c("HC", "non_DKD", "DKD"))
```

## DKD defined by UACR ≥ 30 | eGFR < 90

```{r echo = F, results = 'asis'}
summary(arsenal::tableby(dkd_group_30_hc ~ group + age + sex + kwt(acr_u, "medianq1q3") + hba1c +
                           eGFR_CKD_epi + gfr_raw_plasma + gfr_bsa_plasma + bmi + diabetes_duration + epic_glp1ra_1 + epic_sglti2_1, 
                         data=bx_subset),
        total = F, digits = 1)
```



## DKD defined by UACR ≥ 100 | eGFR < 90

```{r echo = F, results = 'asis'}
summary(arsenal::tableby(dkd_group_100_hc ~ group + age + sex + kwt(acr_u, "medianq1q3") + hba1c +
                           eGFR_CKD_epi + gfr_raw_plasma + gfr_bsa_plasma + bmi + diabetes_duration + epic_glp1ra_1 + epic_sglti2_1, 
                         data=bx_subset),
        total = F, digits = 1)
```

## Analysis summary

### Disease characterization

| Comparison                                     | Scientific Question                                            | What It Tells Us                                                                 | Why It's Needed                                                                                      |
|-----------------------------------------------|----------------------------------------------------------------|----------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|
| [DKD vs HC](#dkd-vs-hc)                       | What are the transcriptomic signatures of diabetic kidney disease? | Identifies disease-specific DEGs, dysregulated pathways, and cell-type-specific changes in DKD | Establishes the “disease signature” that drugs might reverse or compensate for                      |
| [T2D vs HC](#t2d-vs-hc)                       | What are the transcriptomic changes in T2D kidneys without overt DKD? | Identifies early T2D-associated changes before clinical DKD manifestation        | Differentiates early metabolic effects from advanced kidney disease; identifies potential targets    |
| [DKD vs T2D](#dkd-vs-t2d)                     | What additional transcriptomic changes occur during DKD progression? | Isolates DKD-specific pathology beyond T2D metabolic effects                     | Identifies progression signatures and therapeutic targets specific to kidney disease advancement     |

### GLP-1RA drug effects

| Comparison                                            | Scientific Question                                         | What It Tells Us                                                              | Why It's Needed                                                                                   |
|------------------------------------------------------|-------------------------------------------------------------|-------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| [DKD+ GLP1RA+ vs DKD+ GLP1RA-](#dkdyglp1rayvsdkdyglp1ran)           | What is the direct effect of GLP-1RA treatment in DKD?      | Identifies GLP-1RA-responsive genes and pathways in diseased kidney          | Primary outcome: demonstrates drug mechanism of action in the disease state                       |
| [T2D + GLP-1RA vs T2D](#dkdnglp1rayvsdkdnglp1ran)           | What is the effect of GLP-1RA in T2D without DKD?           | Identifies early protective or metabolic effects before DKD onset            | Reveals preventive mechanisms; separates metabolic from kidney-specific effects                   |

### SGLT2i drug effects

| Comparison                                            | Scientific Question                                         | What It Tells Us                                                              | Why It's Needed                                                                                   |
|------------------------------------------------------|-------------------------------------------------------------|-------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| [DKD + SGLT2i vs DKD](#dkdysglt2iyvsdkdysglt2in)            | What is the direct effect of SGLT2i treatment in DKD?       | Identifies SGLT2i-responsive genes and pathways in diseased kidney           | Primary outcome: demonstrates drug mechanism of action in the disease state                       |
| [T2D + SGLT2i vs T2D](#dkdnsglt2iyvsdkdnsglt2in)            | What is the effect of SGLT2i in T2D without DKD?            | Identifies early protective or metabolic effects before DKD onset            | Reveals preventive mechanisms; separates metabolic from kidney-specific effects                   |

### Reversion/normalization analysis

| Comparison                                                             | Scientific Question                                           | What It Tells Us                                                                                      | Why It's Needed                                                                                                     |
|------------------------------------------------------------------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| [DKD+ GLP1RA+ vs HC](#dkdy-glpy-vs-hc)                | Does GLP-1RA treatment normalize DKD transcriptome to healthy state?          | Identifies which disease genes are reversed vs. remain dysregulated vs. show compensatory changes | Distinguishes true disease reversal from compensatory protection; identifies residual pathology |
| [DKD- GLP1RA+ vs HC](#dkdn-glpy-vs-hc)                | Does GLP-1RA normalize early T2D changes?          | Determines if metabolic normalization occurs with treatment                                                     | Assesses preventive vs. compensatory mechanisms |
| [DKD+ SGLT2i+ vs HC](#dkdy-sglt2iy-vs-hc)                | Does SGLT2i treatment normalize DKD transcriptome to healthy state?          | Identifies which disease genes are reversed vs. remain dysregulated vs. show compensatory changes | Distinguishes true disease reversal from compensatory protection; identifies residual pathology |
| [DKD- SGLT2i+ vs HC](#dkdn-sglt2iy-vs-hc)                | Does SGLT2i normalize early T2D changes?          | Determines if metabolic normalization occurs with treatment                                                     | Assesses preventive vs. compensatory mechanisms

### Reversion quantification

| Comparison                                                             | Scientific Question                                           | What It Tells Us                                                                                      | Why It's Needed                                                                                                     |
|------------------------------------------------------------------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| [(DKD+GLP1RA - HC) vs (DKD - HC)](#dkdy-glpy-hc-vs-dkdy-glpn-hc)                | What proportion of DKD DEGs are reversed by GLP-1RA?          | Quantifies degree of transcriptomic normalization; categorizes genes as: fully reversed, partially reversed, unchanged, or overcorrected | Provides mechanistic classification: true reversal vs. compensation vs. drug-specific effects independent of disease |
| [(DKD+SGLT2i - HC) vs (DKD - HC)](#dkdy-sglt2iy-hc-vs-dkdy-sglt2in-hc)                | What proportion of DKD DEGs are reversed by SGLT2i?          | Quantifies degree of transcriptomic normalization                                                     | Same as above for SGLT2i


### Drug comparison

| Comparison                                            | Scientific Question                                           | What It Tells Us                                                                | Why It's Needed                                                                                     |
|------------------------------------------------------|---------------------------------------------------------------|---------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------|
| [DKD + GLP-1RA vs DKD + SGLT2i](#dkd-glp1ra-vs-dkd-sglt2i) | What are the differential effects of GLP-1RA vs SGLT2i?      | Identifies drug-specific vs shared mechanisms of protection                     | Reveals whether drugs work through similar or complementary pathways; informs combination rationale |
| [T2D + GLP-1RA vs T2D + SGLT2i](#t2d-glp1ra-vs-t2d-sglt2i) | Early-stage drug mechanism comparison                         | Differentiates metabolic vs hemodynamic vs other early protective mechanisms    | Identifies stage-specific drug effects                                                              |

### Synergy / combination (if available)

| Comparison                                            | Scientific Question                                                | What It Tells Us                                          | Why It's Needed                                                                                 |
|------------------------------------------------------|--------------------------------------------------------------------|-----------------------------------------------------------|-------------------------------------------------------------------------------------------------|
| [DKD + Combo vs DKD + GLP-1RA](#dkd-combo-vs-dkd-glp1ra) | Does combination therapy provide additional benefit beyond GLP-1RA? | Identifies additive or synergistic effects                | Tests combination therapy hypothesis                                                            |
| [DKD + Combo vs DKD + SGLT2i](#dkd-combo-vs-dkd-sglt2i) | Does combination therapy provide additional benefit beyond SGLT2i?  | Identifies additive or synergistic effects                | Tests combination therapy hypothesis                                                            |
| [DKD + Combo vs HC](#dkd-combo-vs-hc)               | Does combination therapy achieve better normalization?             | Comprehensive assessment of maximal therapeutic potential | Determines if combination achieves superior transcriptomic normalization                        |



```{r echo = F}
folders <- c(
  
  # --- Base DKD vs nonDKD ---
  "DKD_vs_nonDKD_30" = "dkd30",
  "DKD_vs_nonDKD_100" = "dkd100",
  
  # --- DKD vs nonDKD with T2D ---
  "DKD_vs_nonDKD_30_t2d" = "dkd30_t2d",
  "DKD_vs_nonDKD_100_t2d" = "dkd100_t2d",
  
  # --- DKD vs HC (30 / 100) ---
  "DKD_30_vs_HC" = "dkd30_hc",
  "DKD_100_vs_HC" = "dkd100_hc",
  
  # --- DKD vs HC with T2D ---
  "DKD_30_t2d_vs_HC" = "dkd30_t2d_hc",
  "DKD_100_t2d_vs_HC" = "dkd100_t2d_hc",
  
  # --- nonDKD vs HC (30 / 100) ---
  "nonDKD_30_vs_HC" = "nondkd30_hc",
  "nonDKD_100_vs_HC" = "nondkd100_hc",
  
  # --- nonDKD vs HC with T2D ---
  "nonDKD_30_t2d_vs_HC" = "nondkd30_t2d_hc",
  "nonDKD_100_t2d_vs_HC" = "nondkd100_t2d_hc",
  
  # --- GLP (within DKD) ---
  "DKD_30_GLP_Y_vs_DKD_30_GLP_N" = "dkd_30_glpy_glpn",
  "DKD_100_GLP_Y_vs_DKD_100_GLP_N" = "dkd_100_glpy_glpn",
  
  # --- GLP (within nonDKD) ---
  "nonDKD_30_GLP_Y_vs_nonDKD_30_GLP_N" = "nondkd_30_glpy_glpn",
  "nonDKD_100_GLP_Y_vs_nonDKD_100_GLP_N" = "nondkd_100_glpy_glpn",
  
  # --- GLP N/Y vs HC (nonDKD) ---
  "nonDKD_30_GLP_N_vs_HC" = "nondkd30_glpn_hc",
  "nonDKD_30_GLP_Y_vs_HC" = "nondkd30_glpy_hc",
  "nonDKD_100_GLP_N_vs_HC" = "nondkd100_glpn_hc",
  "nonDKD_100_GLP_Y_vs_HC" = "nondkd100_glpy_hc",
  
  # --- GLP N/Y vs HC (DKD) ---
  "DKD_30_GLP_N_vs_HC" = "dkd30_glpn_hc",
  "DKD_30_GLP_Y_vs_HC" = "dkd30_glpy_hc",
  "DKD_100_GLP_N_vs_HC" = "dkd100_glpn_hc",
  "DKD_100_GLP_Y_vs_HC" = "dkd100_glpy_hc",
  
  # --- SGLT2i (within DKD) ---
  "DKD_30_SGLT2i_Y_vs_DKD_30_SGLT2i_N" = "dkd30_sglt2iy_sglt2in",
  "DKD_100_SGLT2i_Y_vs_DKD_100_SGLT2i_N" = "dkd100_sglt2iy_sglt2in",
  
  # --- SGLT2i (within nonDKD) ---
  "nonDKD_30_SGLT2i_Y_vs_nonDKD_30_SGLT2i_N" = "nondkd30_sglt2iy_sglt2in",
  "nonDKD_100_SGLT2i_Y_vs_nonDKD_100_SGLT2i_N" = "nondkd100_sglt2iy_sglt2in",
  
  # --- SGLT2i N/Y vs HC (nonDKD) ---
  "nonDKD_30_SGLT2i_N_vs_HC" = "nondkd30_sglt2in_hc",
  "nonDKD_30_SGLT2i_Y_vs_HC" = "nondkd30_sglt2iy_hc",
  "nonDKD_100_SGLT2i_N_vs_HC" = "nondkd100_sglt2in_hc",
  "nonDKD_100_SGLT2i_Y_vs_HC" = "nondkd100_sglt2iy_hc",
  
  # --- SGLT2i N/Y vs HC (DKD) ---
  "DKD_30_SGLT2i_N_vs_HC" = "dkd30_sglt2in_hc",
  "DKD_30_SGLT2i_Y_vs_HC" = "dkd30_sglt2iy_hc",
  "DKD_100_SGLT2i_N_vs_HC" = "dkd100_sglt2in_hc",
  "DKD_100_SGLT2i_Y_vs_HC" = "dkd100_sglt2iy_hc"
)

reverse_folders <- setNames(names(folders), folders)

meta_df_compiled <- read.csv(file.path(root_path, paste0("Renal HERITAGE/Results/nebula/csv/run_metadata_compiled.csv")))
```

# Disease characterization

## DKD vs HC {#dkd-vs-hc}

### DKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```


## T2D vs HC {#t2d-vs-hc}

### T2D nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_t2d_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### T2D nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_t2d_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

## DKD vs T2D {#dkd-vs-t2d}

### DKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_t2d"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_t2d"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

# GLP-1RA drug effects

## DKD+ GLP1RA+ vs DKD+ GLP1RA- {#dkdyglp1rayvsdkdyglp1ran}

### DKD (30)
```{r echo = F, results = 'asis', eval = T}
folder = "dkd_30_glpy_glpn"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd_100_glpy_glpn"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

## DKD- GLP1RA+ vs DKD- GLP1RA- {#dkdnglp1rayvsdkdnglp1ran}

### nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd_30_glpy_glpn"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### nonDKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd_100_glpy_glpn"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

# SGLT2i drug effects

## DKD+ SGLT2i+ vs DKD+ SGLT2i- {#dkdysglt2iyvsdkdysglt2in}

### DKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_sglt2iy_sglt2in"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_sglt2iy_sglt2in"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```


## DKD- SGLT2i+ vs DKD- SGLT2i- {#dkdnsglt2iyvsdkdnsglt2in}

### nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_sglt2iy_sglt2in"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### nonDKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_sglt2iy_sglt2in"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

# Reversion/normalization analysis

## DKD+ GLP1RA+ vs HC {#dkdy-glpy-vs-hc}

### DKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_glpy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_glpy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```


## DKD- GLP1RA+ vs HC {#dkdn-glpy-vs-hc}

### nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_glpy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### nonDKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_glpy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

## DKD+ SGLT2i+ vs HC {#dkdy-sglt2iy-vs-hc}

### DKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd30_sglt2iy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### DKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "dkd100_sglt2iy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

## DKD- SGLT2i+ vs HC {#dkdn-sglt2iy-vs-hc}

### nonDKD (30)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd30_sglt2iy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

### nonDKD (100)

```{r echo = F, results = 'asis', eval = T}
folder = "nondkd100_sglt2iy_hc"

for (cell in names(celltype_groups)) {
  
  # Normalize the cell name once
  cell_norm <- tolower(gsub("/", "_", cell))
  
  # Filter rows from meta_df_compiled for this iteration
  meta_sub <- meta_df_compiled %>%
    dplyr::filter(
      analysis_type == reverse_folders[[folder]],
      celltype == cell
    )
  
  # Skip this cell if not found in meta info
  if (nrow(meta_sub) == 0) {
    message(paste("Skipping", cell, "- not found in meta_df_compiled"))
    next
  }
  
  print(knitr::kable(meta_sub))
  cat("\n::: {layout-ncol=2}\n\n")
  
  # List of plots to check and print
  plot_paths <- list(
    pval      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/pval/", folder, "_", cell_norm, ".png")),
    fdr       = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Volcano Plots/fdr/", folder, "_", cell_norm, "_fdr.png")),
    gsea      = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/hallmark_", folder, "_", cell_norm, "_gsea.png")),
    combined  = file.path(root_path, paste0("Renal HERITAGE/Results/Figures/Pathways/Underlying genes/Combined/hallmark_", folder, "_", cell_norm, "_combined.png"))
  )
  
  # Loop through plot files and only include if they exist
  for (ptype in names(plot_paths)) {
    if (file.exists(plot_paths[[ptype]])) {
      label <- if (ptype == "pval") "p-value < 0.05" else
               if (ptype == "fdr") "FDR < 0.05" else ""
      
      cat(paste0("![", label, "](", plot_paths[[ptype]], ")\n\n"))
    } else {
      message(paste("Missing:", plot_paths[[ptype]]))
    }
  }
  
  cat(":::\n\n")
}
```

