---
title: "11_scRNA REMODEL Genes"
author: "Ye Ji Choi"
format: html
---

```{r include = F}
library(dplyr)
library(aws.s3)
library(jsonlite)
library(ggplot2)
library(ggforce)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(msigdbr)
library(ggpubr)
library(ggrepel)
library(RColorBrewer)
library(ggtrace)
library(ggtext)
library(nebula)
```

```{r include = F}
user <- Sys.info()[["user"]]

if (user == "choiyej") { # local version
  root_path <- "/Users/choiyej/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/choiyej/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/Users/choiyej/Library/CloudStorage/OneDrive-TheUniversityofColoradoDenver/Bjornstad Pyle Lab/keys.json")
} else if (user == "rameshsh") { # hyak version
  root_path <- ""
  git_path <- "/mmfs1/gscratch/togo/rameshsh/CHCO-Code/Petter Bjornstad"
} else if (user == "yejichoi") { # hyak version
  root_path <- "/mmfs1/gscratch/togo/yejichoi/"
  git_path <- "/mmfs1/gscratch/togo/yejichoi/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/yejichoi/keys.json")
} else if (user == "pylell") {
  root_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive"
  git_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
  keys <- fromJSON("/mmfs1/home/pylell/keys.json")
} else {
  stop("Unknown user: please specify root path for this user.")
}

source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_functions.R"))
source(file.path(git_path, "Renal HEIRitage/RH_RH2_IMPROVE_scRNA_functions.R"))

entrez_map <- AnnotationDbi::select(
 org.Hs.eg.db,
 keys   = keys(org.Hs.eg.db, keytype = "ENTREZID"),
 columns = c("SYMBOL", "GENENAME", "ALIAS"),
 keytype = "ENTREZID"
)


s3write_using_region <- function(FUN, ..., object, bucket, region = NULL, opts = NULL, filename = NULL) {
  if (missing(bucket)) {
    bucket <- get_bucketname(object)
  }
  object <- get_objectkey(object)
  
  tmp <- if (is.character(filename)) {
    file.path(tempdir(TRUE), filename)
  } else {
    # if object has an extension, keep it; otherwise make a generic tmp
    ext <- tools::file_ext(object)
    if (nzchar(ext)) tempfile(fileext = paste0(".", ext)) else tempfile()
  }
  
  on.exit(unlink(tmp), add = TRUE)
  
  # Add region to opts if provided
  if (!is.null(region)) {
    if (is.null(opts)) {
      opts <- list(region = region)
    } else {
      opts$region <- region
    }
  }
  
  FUN(tmp, ...)
  
  if (is.null(opts)) {
    r <- put_object(file = tmp, bucket = bucket, object = object)
  } else {
    r <- do.call("put_object", c(list(file = tmp, bucket = bucket, object = object), opts))
  }
  
  return(invisible(r))
}

pb90_subset <- s3readRDS("data_clean/subset/pb90_ckd_analysis_subset.rds", "scrna", region = "")
pb90_subset <- subset(pb90_subset, group != "Obese_Control")
pb90_raw <- s3readRDS("Kidney transcriptomics/Single cell RNA seq/PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds", "scrna", region = "") # for GLP1R
```

```{r}
celltype_groups <- list(
  PT = c("PT-S1/S2", "PT-S3", "aPT"),
  TAL = c("C-TAL-1", "C-TAL-2", "aTAL", "dTAL"),
  PC = c("CCD-PC", "CNT-PC", "dCCD-PC", "M-PC", "tPC-IC"),
  IC = c("IC-A", "IC-B", "aIC"),
  DTL_ATL = c("DTL", "aDTL", "ATL"),   # grouped thin limbs
  DCT_CNT = c("DCT", "dDCT", "CNT"),   # grouped distal tubule/connecting tubule
  EC = c("EC-AVR", "EC-GC", "EC-PTC", "EC-AEA", "EC-LYM", "EC/VSMC", "EC-A"), 
  # Immune = c("MAC", "MON", "cDC", "pDC", "CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  Immune_Myeloid = c("MAC", "MON", "cDC", "pDC"),
  Immune_Lymphoid = c("CD4+ T", "CD8+ T", "B", "NK", "cycT"),
  VSMC_P_FIB = c("VSMC/P", "FIB"),
  POD = "POD",
  MC = "MC",                         # mesangial cells
  PEC = "PEC",                       # parietal epithelial cells
  Schwann = "SchwannCells"
  # Other = c("non-specific")          # catchall
)

remodel_genes <- c("LMF1", "LSAMP", "EMC10", "KCNK6", "FAT1", "NES", "MAPKAPK3", "FLT4", "CASR", "IRF3", "ACER1", "ACSM2B", "GLS", "CA12")
```

```{r}
# Feature Plots
umap_meta <- prepare_umap_metadata(pb90_subset, genes = remodel_genes)

remodel_feature_plots <- plot_feature_umap(
  genes = remodel_genes,
  metadata = umap_meta$metadata,
  centers = umap_meta$centers,
  celltype_colors = umap_meta$celltype_colors,
  pct_threshold = 10,
  save_to_s3 = TRUE
)
```

```{r}
# Dot Plots per cell type
dotplot_df <- pb90_subset_meta %>%
  # For each gene and cell type combination
  group_by(KPMP_celltype_general2) %>%
  summarise(
    across(
      .cols = all_of(remodel_genes),
      .fns = list(
        pct_expressed = ~mean(. > 0) * 100,  # Percent of cells expressing
        mean_expr = ~mean(.[. > 0], na.rm = TRUE)  # Mean expression in expressing cells only
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  ) %>%
  # Reshape to long format
  pivot_longer(
    cols = -KPMP_celltype_general2,
    names_to = c("gene", ".value"),
    names_pattern = "(.+)_(pct_expressed|mean_expr)"
  ) %>%
  # Optional: filter out combinations with no expression
  filter(pct_expressed > 0)

ggplot(dotplot_df, aes(x = gene, y = KPMP_celltype_general2)) +
  geom_point(aes(size = pct_expressed, color = mean_expr)) +
  scale_size_continuous(name = "% Expressed", range = c(1, 10)) +
  scale_colour_gradient(low = "#ffffff", high = "#f08080", name = "Mean Expression") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    text = element_text(size = 20)
  ) +
  labs(x = NULL, y = NULL)

s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_celltype_dotplot.png"), 
                       bucket = "scrna", region = "", height = 15, width = 10)

```

```{r}
# Dot Plots per GLP group
dotplot_glp_t2dob_df <- pb90_subset_meta %>%
  filter(group != "Obese_Control") %>%
  # For each gene and cell type combination
  group_by(glp_t2dob) %>%
  summarise(
    across(
      .cols = all_of(remodel_genes),
      .fns = list(
        pct_expressed = ~mean(. > 0) * 100,  # Percent of cells expressing
        mean_expr = ~mean(.[. > 0], na.rm = TRUE)  # Mean expression in expressing cells only
      ),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  ) %>%
  # Reshape to long format
  pivot_longer(
    cols = -glp_t2dob,
    names_to = c("gene", ".value"),
    names_pattern = "(.+)_(pct_expressed|mean_expr)"
  ) %>%
  # Optional: filter out combinations with no expression
  filter(pct_expressed > 0)

ggplot(dotplot_glp_t2dob_df, aes(x = gene, y = glp_t2dob)) +
  geom_point(aes(size = pct_expressed, color = mean_expr)) +
  scale_size_continuous(name = "% Expressed", range = c(1, 10)) +
  scale_colour_gradient(low = "#ffffff", high = "#f08080", name = "Mean Expression") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    text = element_text(size = 20)
  ) +
  labs(x = NULL, y = NULL)

s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_glp_t2dob_dotplot.png"), 
                       bucket = "scrna", region = "", height = 5, width = 10)

```


## GLP1R

```{r}
# Feature Plots
glp_umap <- prepare_umap_metadata(pb90_raw, genes = "GLP1R")

glp_feature_plot <- plot_feature_umap(
  genes = "GLP1R",
  metadata = glp_umap$metadata,
  centers = glp_umap$centers,
  celltype_colors = glp_umap$celltype_colors,
  pct_threshold = 0.05,
  save_to_s3 = TRUE
)

# T2D only
# Feature Plots
t2d_glp_umap <- prepare_umap_metadata(subset(pb90_raw, group == "Type_2_Diabetes"), genes = "GLP1R")

t2d_glp_feature_plot <- plot_feature_umap(
  genes = "GLP1R",
  metadata = t2d_glp_umap$metadata,
  centers = t2d_glp_umap$centers,
  celltype_colors = t2d_glp_umap$celltype_colors,
  pct_threshold = 0.05,
  save_to_s3 = TRUE,
  s3_suffix = "_T2D"
)
```


# Clinical correlations

## Unadjusted

### Low res

```{r}
# nebula
pb90_subset$glp_t2dob <- relevel(factor(pb90_subset$glp_t2dob), ref = "HC")
pb90_subset$log_acr_u <- log(pb90_subset$acr_u)
combinations <- expand.grid(
  gene = remodel_genes,
  celltype = names(celltype_groups),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "Other")

nebula_results_list <- foreach(i = 1:nrow(combinations),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations$gene[i]
                                 cell <- combinations$celltype[i]
                                 var <- combinations$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype_general2 == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var)])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var)), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres.RDS", bucket = "scrna", region = "")

# nebula_results_list <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)

# Assign gene names as list names
names(nebula_results_list) <- sapply(nebula_results_list, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results <- as.data.frame(nebula_summaries)

# Adjust p-values using False Discovery Rate (FDR) method
results_list <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list[[var_name]] <- full_results %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined <- bind_rows(results_list)
# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df <- full_results_combined[full_results_combined$fdr < 0.05, ]

s3saveRDS(full_results_combined, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres.RDS", bucket = "scrna", region = "")
```

### High res

```{r}
# nebula
combinations_highres <- expand.grid(
  gene = remodel_genes,
  celltype = unique(pb90_subset$KPMP_celltype),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "non-specific")

nebula_results_list_highres <- foreach(i = 1:nrow(combinations_highres),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations_highres$gene[i]
                                 cell <- combinations_highres$celltype[i]
                                 var <- combinations_highres$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var)])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var)), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_highres.RDS", bucket = "scrna", region = "")
# 
# nebula_results_list_highres <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_highres.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list_highres <- Filter(Negate(is.null), nebula_results_list_highres)

# Assign gene names as list names
names(nebula_results_list_highres) <- sapply(nebula_results_list_highres, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list_highres <- lapply(nebula_results_list_highres, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    converged <- nebula_results_list_highres[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries_highres <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    df <- nebula_results_list_highres[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes_highres <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results_highres <- as.data.frame(nebula_summaries_highres)

# Adjust p-values using False Discovery Rate (FDR) method
results_list_highres <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list_highres[[var_name]] <- full_results_highres %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined_highres <- bind_rows(results_list_highres)

# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df_highres <- full_results_combined_highres[full_results_combined_highres$fdr < 0.05, ]

s3saveRDS(full_results_combined_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres.RDS", bucket = "scrna", region = "")
```

## Adjusting for glp_t2dob

### Low res

```{r}
# nebula
pb90_subset$glp_t2dob <- relevel(factor(pb90_subset$glp_t2dob), ref = "HC")
pb90_subset$log_acr_u <- log(pb90_subset$acr_u)
combinations <- expand.grid(
  gene = remodel_genes,
  celltype = names(celltype_groups),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "Other")

nebula_results_list <- foreach(i = 1:nrow(combinations),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations$gene[i]
                                 cell <- combinations$celltype[i]
                                 var <- combinations$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype_general2 == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var, "glp_t2dob")])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var, " + glp_t2dob")), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres_glp_t2dob.RDS", bucket = "scrna", region = "")

# nebula_results_list <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres_glp_t2dob.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)

# Assign gene names as list names
names(nebula_results_list) <- sapply(nebula_results_list, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results <- as.data.frame(nebula_summaries)

# Adjust p-values using False Discovery Rate (FDR) method
results_list <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list[[var_name]] <- full_results %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined <- bind_rows(results_list)
# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df <- full_results_combined[full_results_combined$fdr < 0.05, ]

s3saveRDS(full_results_combined, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob.RDS", bucket = "scrna", region = "")

full_results_combined <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob.RDS", bucket = "scrna", region = "")
```

### High res

```{r}
# nebula
combinations_highres <- expand.grid(
  gene = remodel_genes,
  celltype = unique(pb90_subset$KPMP_celltype),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "non-specific")

nebula_results_list_highres <- foreach(i = 1:nrow(combinations_highres),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations_highres$gene[i]
                                 cell <- combinations_highres$celltype[i]
                                 var <- combinations_highres$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var, "glp_t2dob")])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var, " + glp_t2dob")), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_highres_glp_t2dob.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list_highres <- Filter(Negate(is.null), nebula_results_list_highres)

# Assign gene names as list names
names(nebula_results_list_highres) <- sapply(nebula_results_list_highres, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list_highres <- lapply(nebula_results_list_highres, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    converged <- nebula_results_list_highres[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries_highres <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    df <- nebula_results_list_highres[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes_highres <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results_highres <- as.data.frame(nebula_summaries_highres)

# Adjust p-values using False Discovery Rate (FDR) method
results_list_highres <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list_highres[[var_name]] <- full_results_highres %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined_highres <- bind_rows(results_list_highres)

# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df_highres <- full_results_combined_highres[full_results_combined_highres$fdr < 0.05, ]

s3saveRDS(full_results_combined_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres_glp_t2dob.RDS", bucket = "scrna", region = "")
```

## Adjusting for glp_t2dob + age + sex + bmi

### Low res

```{r}
# nebula
pb90_subset$glp_t2dob <- relevel(factor(pb90_subset$glp_t2dob), ref = "HC")
pb90_subset$log_acr_u <- log(pb90_subset$acr_u)
combinations <- expand.grid(
  gene = remodel_genes,
  celltype = names(celltype_groups),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "Other")

nebula_results_list <- foreach(i = 1:nrow(combinations),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations$gene[i]
                                 cell <- combinations$celltype[i]
                                 var <- combinations$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype_general2 == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var, "glp_t2dob", "age", "sex.x", "bmi")])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var, 
                                                                               " + glp_t2dob + age + sex.x + bmi")), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")

# nebula_results_list <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_lowres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list <- Filter(Negate(is.null), nebula_results_list)

# Assign gene names as list names
names(nebula_results_list) <- sapply(nebula_results_list, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list <- lapply(nebula_results_list, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    converged <- nebula_results_list[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries <- map_dfr(
  names(nebula_results_list),
  function(gene_name) {
    df <- nebula_results_list[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results <- as.data.frame(nebula_summaries)

# Adjust p-values using False Discovery Rate (FDR) method
results_list <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list[[var_name]] <- full_results %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined <- bind_rows(results_list)
# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df <- full_results_combined[full_results_combined$fdr < 0.05, ]

s3saveRDS(full_results_combined, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")

full_results_combined <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")
```

### High res

```{r}
# nebula
combinations_highres <- expand.grid(
  gene = remodel_genes,
  celltype = unique(pb90_subset$KPMP_celltype),
  var = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
  stringsAsFactors = FALSE
) %>%
  filter(celltype != "non-specific")

nebula_results_list_highres <- foreach(i = 1:nrow(combinations_highres),
                               .packages = c("nebula", "Matrix", "Seurat")) %do% {
                                 
                                 g <- combinations_highres$gene[i]
                                 cell <- combinations_highres$celltype[i]
                                 var <- combinations_highres$var[i]
                                 
                                 tryCatch({
                                   cat("Processing:", g, "in", cell, ", ", var, "\n")
                                   
                                   # Subset to current cell type
                                   subset_obj <- subset(pb90_subset, KPMP_celltype == cell)
                                   
                                   # Get counts for the current gene
                                   count_gene <- round(GetAssayData(subset_obj, layer = "counts")[g, , drop = FALSE])
                                   
                                   # Get metadata
                                   meta_gene <- subset_obj@meta.data
                                   
                                   # Skip if too few cells with non-zero expression
                                   if (sum(count_gene > 0) < 10) {
                                     cat("  Skipping - too few expressing cells\n")
                                     return(NULL)
                                   }
                                   
                                   # Check for complete cases in clinical variables
                                   complete_cases <- complete.cases(meta_gene[, c(var, "glp_t2dob", "age", "sex.x", "bmi")])
                                   if (sum(complete_cases) < 20) {
                                     cat("  Skipping - too few cells after removing NAs\n")
                                     return(NULL)
                                   }
                                   
                                   # Subset to complete cases
                                   count_gene <- count_gene[, complete_cases, drop = FALSE]
                                   meta_gene <- meta_gene[complete_cases, ]
                                   
                                   # Create predictor matrix
                                   pred_gene <- model.matrix(as.formula(paste0("~ ", var, 
                                                                               " + glp_t2dob + age + sex.x + bmi")), 
                                                             data = meta_gene)
                                   
                                   # Run nebula
                                   result <- nebula(
                                     count = count_gene,
                                     id = meta_gene$kit_id,
                                     pred = pred_gene,
                                     ncore = 1,
                                     output_re = TRUE
                                   )
                                   
                                   # Return results with metadata
                                   list(gene = g, celltype = cell, var = var, result = result)
                                   
                                 }, error = function(e) {
                                   cat("  Error:", conditionMessage(e), "\n")
                                   return(NULL)
                                 })
                               }

s3saveRDS(nebula_results_list_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_highres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")
```

```{r}
# nebula results processing
# Remove NULL entries (failed analyses) from the results
nebula_results_list_highres <- Filter(Negate(is.null), nebula_results_list_highres)

# Assign gene names as list names
names(nebula_results_list_highres) <- sapply(nebula_results_list_highres, function(x) 
  paste0(x$gene, "_", x$celltype, "_", x$var))

# Simplify the list to only contain the result objects
nebula_results_list_highres <- lapply(nebula_results_list_highres, function(x) x$result)

# Extract convergence status into a dataframe
nebula_converged <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    converged <- nebula_results_list_highres[[gene_name]]$convergence
    df <- data.frame(Gene = gene_name, Convergence_Code = converged)
    return(df)
  }
)

# Extract model summaries into a dataframe
nebula_summaries_highres <- map_dfr(
  names(nebula_results_list_highres),
  function(gene_name) {
    df <- nebula_results_list_highres[[gene_name]]$summary
    df <- df %>% mutate(Gene = gene_name)
    return(df)
  }
)

# Identify genes that did not converge (Convergence_Code == -40)
nonconverge_genes_highres <- unique(nebula_converged$Gene[which(nebula_converged$Convergence_Code == -40)])

# ---- Final Cleanup ----

# Create a full results dataframe
full_results_highres <- as.data.frame(nebula_summaries_highres)

# Adjust p-values using False Discovery Rate (FDR) method
results_list_highres <- list()

for (var_name in c("hba1c", "log_acr_u", "eGFR_CKD_epi")) {
  
  p_col <- paste0("p_", var_name)
  logFC_col <- paste0("logFC_", var_name)
  
  results_list_highres[[var_name]] <- full_results_highres %>%
    separate(Gene, into = c("gene", "celltype", "clinical_var"), sep = "_", remove = FALSE) %>%
    select(gene, celltype, clinical_var, all_of(c(p_col, logFC_col))) %>%
    mutate(
      clinical_var = var_name,
      fdr = p.adjust(.data[[p_col]], method = "fdr"),
      PValue10 = -log10(pmax(.data[[p_col]], 1e-10)),
      logFC = .data[[logFC_col]],
      p_value = .data[[p_col]],
      color = case_when(
        fdr < 0.05 & logFC > 0 ~ "lightcoral",
        fdr < 0.05 & logFC < 0 ~ "lightblue",
        TRUE ~ "gray"
      )
    ) %>%
    select(-all_of(c(p_col, logFC_col)))  # Remove original columns
}

# Combine into one dataframe
full_results_combined_highres <- bind_rows(results_list_highres)

# Identify significantly differentially expressed genes (FDR < 0.05)
significant_df_highres <- full_results_combined_highres[full_results_combined_highres$fdr < 0.05, ]

s3saveRDS(full_results_combined_highres, object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")
```
# Result compilation

```{r}
lowres_unadjusted <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres.RDS", bucket = "scrna", region = "")
highres_unadjusted <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres.RDS", bucket = "scrna", region = "")

lowres_glp_t2dob <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob.RDS", bucket = "scrna", region = "")
highres_glp_t2dob <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres_glp_t2dob.RDS", bucket = "scrna", region = "")

lowres_adjusted <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_lowres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")
highres_adjusted <- s3readRDS(object = "Projects/CKD/RH_RH2/Results/clinical_associations/REMODEL_genes_hba1c_uacr_egfr_nebula_processed_highres_glp_t2dob_age_sex_bmi.RDS", bucket = "scrna", region = "")

lowres_unadjusted$clinical_var <- factor(lowres_unadjusted$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))
highres_unadjusted$clinical_var <- factor(highres_unadjusted$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))

lowres_glp_t2dob$clinical_var <- factor(lowres_glp_t2dob$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))
highres_glp_t2dob$clinical_var <- factor(highres_glp_t2dob$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))

lowres_adjusted$clinical_var <- factor(lowres_adjusted$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))
highres_adjusted$clinical_var <- factor(highres_adjusted$clinical_var, 
                                         levels = c("hba1c", "log_acr_u", "eGFR_CKD_epi"),
                                         labels = c("HbA1c", "log(uACR)", "eGFR"))

```

```{r}
lowres_unadjusted %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_lowres_unadjusted.png"), 
                     bucket = "scrna", region = "", height = 5, width = 10)
highres_unadjusted %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_highres_unadjusted.png"), 
                     bucket = "scrna", region = "", height = 6, width = 10)
```

```{r}
lowres_glp_t2dob %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_lowres_glp_t2dob.png"), 
                     bucket = "scrna", region = "", height = 5, width = 10)
highres_glp_t2dob %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_highres_glp_t2dob.png"), 
                     bucket = "scrna", region = "", height = 6, width = 10)
```

```{r}
lowres_adjusted %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_lowres_adjusted.png"), 
                     bucket = "scrna", region = "", height = 5, width = 10)

highres_adjusted %>%
  filter(p_value < 0.05) %>%
  ggplot(aes(x = gene, y = celltype, color = logFC, size = PValue10)) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) +
  facet_wrap(~clinical_var)
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_highres_adjusted.png"), 
                     bucket = "scrna", region = "", height = 6, width = 10)
```

# DEG from NEBULA

```{r}
# T2D GLP+ vs. GLP-
t2d_glpy_glpn <- list()
for (cell in names(celltype_groups)) {
  file_path <- paste0(
    "Projects/CKD/RH_RH2/Results/nebula/",
    "T2D_GLP_Y_vs_T2D_GLP_N/",
    cell, "/", 
    cell, "_rh_rh2_imp_nebula_kpmp_t2d_glpyn_processed.rds"
  )
  
  t2d_glpy_glpn[[cell]] <- s3readRDS(
    object = file_path,
    bucket = "scrna",
    region = "") %>%
    filter(Gene %in% remodel_genes) %>%
    dplyr::select(Gene, 
                  logFC = logFC_glp_t2dobGLP_Y,
                  pval = p_glp_t2dobGLP_Y,
                  fdr) %>%
    mutate(celltype = cell)
}

t2d_glpy_glpn_combined <- dplyr::bind_rows(t2d_glpy_glpn)

t2d_glpy_glpn_combined %>%
  filter(pval < 0.05) %>%
  ggplot(aes(x = Gene, y = celltype, color = logFC, size = -log10(pval))) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) 
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_nebula_t2d_glpy_glpn.png"), 
                     bucket = "scrna", region = "", height = 5, width = 6)
```

```{r}
# T2D GLP- vs. HC
t2d_glpn_hc <- list()
for (cell in names(celltype_groups)) {
  file_path <- paste0(
    "Projects/CKD/RH_RH2/Results/nebula/",
    "T2D_GLP_N_vs_HC/",
    cell, "/", 
    cell, "_rh_rh2_imp_nebula_kpmp_t2d_glpn_hc_processed.rds"
  )
  
  t2d_glpn_hc[[cell]] <- s3readRDS(
    object = file_path,
    bucket = "scrna",
    region = "") %>%
    filter(Gene %in% remodel_genes) %>%
    dplyr::select(Gene, 
                  logFC = logFC_glp_t2dobGLP_N,
                  pval = p_glp_t2dobGLP_N,
                  fdr) %>%
    mutate(celltype = cell)
}

t2d_glpn_hc_combined <- dplyr::bind_rows(t2d_glpn_hc)

t2d_glpn_hc_combined %>%
  filter(pval < 0.05) %>%
  ggplot(aes(x = Gene, y = celltype, color = logFC, size = -log10(pval))) +
  geom_point() +
  scale_color_gradient2(low = "#89c2d9", mid = "white", high = "#ee7674", midpoint = 0) +
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(y = NULL, x = NULL) 
s3write_using_region(FUN = ggsave, 
                     object = paste0("Projects/CKD/RH_RH2/Results/Figures/Dot Plot/REMODEL_genes_nebula_t2d_glpn_hc.png"), 
                     bucket = "scrna", region = "", height = 4, width = 4)
```
