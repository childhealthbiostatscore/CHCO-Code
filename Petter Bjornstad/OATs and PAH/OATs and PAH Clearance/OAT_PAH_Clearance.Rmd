---
title: "OAT scRNA & PAH Clearance"
author: "Hailey Hampson"
date: "2024-09-24"
output: html_document
--- 

#1. Load Libraries & Directories
```{r, include=F}
library(reprex)
library(tidyverse)
library(BiocManager)        
library(arsenal)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(Seurat)
library(future)
library(colorspace)
library(patchwork)
library(ggdendro)
library(cowplot)
library(ggpubr)
library(venn)
library(rstatix)
library(table1)
library(Biobase)
library(ReactomeGSA)
library(GSEABase)
library(msigdbr)
library(kableExtra)
library(knitr)
library(SingleCellExperiment)
library(fgsea)
library(EnhancedVolcano)
library(openxlsx)
library(BiocManager)
library(MAST)
library(ggrepel)
# library(qpcR)
library(ggpubr)
library(openxlsx)
library(ggplot2)
library(GGally)
library(GSEABase)
library(limma)
library(reshape2)
library(data.table)
library(knitr)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
library(stringr)
#library(NMF)
library(rsvd)
library(RColorBrewer)
library(MAST)
library(devtools)
# install_github("Sun-lab/ideas",force=T)
#library(ideas)
library(foreach)
library(doRNG)
library(doParallel)
library(fs)
registerDoParallel(cores = 6)
library(VennDiagram)
library(janitor)
devtools::install_github('immunogenomics/presto')
library(presto)
library(knitr)
library(lme4)
library(lmerTest)

#Local file path
#dir.dat <- c("/Volumes/Peds Endo/Petter Bjornstad")
#dir.dat2 <- c("/Volumes/Peds Endo/Petter Bjornstad/scRNA/data_clean")
#dir.code <- c("/Users/hhampson/Documents/CHCO-Code/Petter Bjornstad/Liver analysis/Liver scRNAseq")
#dir.results <- c("/Volumes/Peds Endo/Petter Bjornstad/Kidney Project/Results")

# #Lambda file path
#  dir.dat <- c("/run/user/1026/gvfs/smb-share:server=ucdenver.pvt,share=som/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad")
#  dir.code <- c("/home/Github_Repo/CHCO-Code/Petter Bjornstad/Kidney scRNA/Kidney scRNA")
#  dir.results <- c(fs::path(dir.dat,"Kidney Project/Results"))

#Mac Studio File Path
dir.dat <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive")
dir.results <- c("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Kidney scRNAseq Project/Results")
dir.ipa <- c("/Users/hhampson/Documents/IPA/Results")

#Load functions
source("2_OAT_Functions.R")
```

#2. Load Data & Format
## a. Format Data - Old KPMP 
```{r, include=F}
#Local
# dir.dat <- c("/Users/hhampson/Dropbox/Bjornstad data")
# so_kidney_sc <- readRDS(fs::path(dir.dat,"Kidney scRNA","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
# load("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/Data Exports/PB90_clinical_metadata.RData")
# so_kidney_sc <- AddMetaData(so_kidney_sc, so_meta_combined)
# rm(so_meta_combined)
# gc()

#Lambda
so_kidney_sc <- readRDS(fs::path(dir.dat,"scRNA","data_raw","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="KI-0014643")] <- "KL-0014643"
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="kl-0023998")] <- "KL-0023998"
#check2 <- so_kidney_sc@meta.data

#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv")) #small meta set
#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata.csv")) #all metadata vars
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney scRNAseq Project","Data","harmonized_data_kidney_sc_all_metadata2.csv"))
#Get coenrolled IDs
coenroll <- read.csv(fs::path(dir.dat,"Renal HERITAGE/Data_Cleaned/coenrolled_ids.csv"))

#Which IDs are coenrolled 
coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="")]
coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="" & coenroll$improve_id!="")]

#"KL-0014634" "KL-0014629" "KL-0014628" coenrolled IDs
#"KL-0014634" "KL-0014629" "KL-0014628" having missing meta data 

#KL-0014628: IT_10/RH-66-T KL-0014628 KL-0019101
#KL-0014629: IT_09/RH-65-T
#KL-0014634: IT_07/RH-59-T
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group")))

#Partipant 30051 (kit id KL-0027474 at 4m has sc, but at baseline no sc has kit id KL-0027474 metadata)
#missing <- c("KL-0014628", "KL-0014629", "KL-0014634", "KL-0019059", "KL-0019092", "KL-0019101", "KL-0022159", "KL-0024005", "KL-0027470", #"KL-0027478")
#Check these ids in metadat
#check <- harm_meta_data %>%
#filter(kit_id %in% missing)

#IDs missing group information  
#Filter out attempt participants
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)
#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
#mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
gc()
meta_kidney_sc <-  so_kidney_sc@meta.data 
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)

#Check for pah clearance

meta_kidney_sc <- meta_kidney_sc %>%
  #dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(harm_meta_data,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
#Check to see if all ids still have metadata
#check4 <- meta_kidney_sc %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check4 <- check4 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))

#rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
ids <- harm_meta_data$kit_id
#Filter seurat object to only IDs that have the metadata (83 individuals of interest)
so_kidney_sc <- AddMetaData(so_kidney_sc, meta_kidney_sc)
#check5 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check5 <- check5 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))
so_kidney_sc <- subset(so_kidney_sc, kit_id %in% ids)
#check6 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check6 <- check6 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))
#unique(so_kidney_sc$group)
#unique(so_kidney_sc$KPMP_celltype)
rm(meta_kidney_sc,harm_meta_data)

#Switch default assay in seurat object to RNA
DefaultAssay(so_kidney_sc) <- "RNA"
gc()

check3 <- so_kidney_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","celltype_rpca","medication")))
# rm(check3)
unique(so_kidney_sc$co_enroll_id) 
#"RH-66-T" "RH-65-T" "RH-59-T" "IT2D-08" "RH-98-T" "RH-99-T" "RH-16-T" "RH-23-T" "RH-19-O" "RH-96-T" "RH-67-T"
#"RH-99-T" "RH-16-T" "RH-23-T" "RH-19-O" "RH-96-T" "RH-67-T" IDs coenrolled in RH and RH2 as a baseline and followup - filter out their RH2 study visit?
#RH-67-T/RH2-19 kit id for second visit to filter out: KL-0030621
#RH-23/RH2-14 kit id for second visit to filter out: KL-0029535

# #Check if coenrolled IDs have multiple biopsies
# co1 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="")] #Coenrolled in RH&RH2
# co2 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="" & coenroll$improve_id!="")] #Coenrolled in Improve/RH/RH2
# co3 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$improve_id!="")] #Coenrolled in Improve/RH2
# co4 <- coenroll$rh_id[which(coenroll$rh_id!="" & coenroll$improve_id!="")] #Coenroleld in Improve/RH
# co5 <- coenroll$crc_id[which(coenroll$crc_id!="" & coenroll$panda_id!="")] #Coenrolled in Crocodile and panda
# co6 <- coenroll$panda_id[which(coenroll$panda_id!="" & coenroll$crc_id!="")]
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co1)]) #"RH-68-T" "RH-23-T" "RH-60-T" "RH-67-T" "RH-93-T"
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co2)]) #"RH-60-T"
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co3)]) #"RH-60-T"
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co4)]) #"RH-66-T" "RH-65-T" "RH-59-T" "RH-60-T"
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co5)]) #"CRC-21" "CRC-04" "CRC-09" "CRC-24" "CRC-18" "CRC-07" "CRC-38" "CRC-32" "CRC-36" "CRC-44" "CRC-43" "CRC-16" "CRC-42" "CRC-31" "CRC-48" "CRC-59"
# unique(so_kidney_sc$record_id[which(so_kidney_sc$record_id %in% co6)]) #"CRC-21" "CRC-04" "CRC-09" "CRC-24" "CRC-18" "CRC-07" "CRC-38" "CRC-32" "CRC-36" "CRC-44" "CRC-43" "CRC-16" "CRC-42" "CRC-31" "CRC-48" "CRC-59"
# 
# rm(coenroll,check3)


so_kidney_sc <- subset(so_kidney_sc,kit_id!="KL-0030621")
so_kidney_sc <- subset(so_kidney_sc,kit_id!="KL-0029535")
check3 <- so_kidney_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","celltype_rpca","medication")))
length(unique(check3$kit_id)) #81
rm(check3)
rm(coenroll)

#Check the total number of cells & genes in the full dataset
ncol(so_kidney_sc) #186125 cells
nrow(so_kidney_sc) #31332 genes

dim(so_kidney_sc@assays$RNA@counts) #31332 186125
sum(grepl("^MT-", rownames(so_kidney_sc@assays$RNA@counts))) #101

# #Filter out mitochondrial DNA
# gene_expression_matrix <- so_kidney_sc@assays$RNA@counts
# 
# # Filter genes expressed in more than 10% of cells
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
# so_kidney_sc@assays$RNA@counts <- gene_expression_matrix[expressed_genes,]
# 
# dim(so_kidney_sc@assays$RNA@counts) #5759 186125 
# sum(grepl("^MT", rownames(so_kidney_sc@assays$RNA@counts))) #45
# 
# ncol(so_kidney_sc) #186125 cells
# nrow(so_kidney_sc) #31332 genes
# 
# # Remove mitochondrial genes (prefix "MT")
# so_kidney_sc@assays$RNA@counts <- so_kidney_sc@assays$RNA@counts[grep("^MT", rownames(so_kidney_sc@assays$RNA@counts), invert = TRUE),]
# ncol(so_kidney_sc) #186125 cells
# nrow(so_kidney_sc) #31332 genes
# dim(so_kidney_sc@assays$RNA@counts) #5714 186125
# sum(grepl("^MT", rownames(so_kidney_sc@assays$RNA@counts))) #0

# Step 1: Filter to genes expressed in more than 5% of cells
gene_expression_matrix <- so_kidney_sc@assays$RNA@counts
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.05

so_kidney_sc <- subset(so_kidney_sc, features = rownames(gene_expression_matrix)[expressed_genes])
dim(so_kidney_sc@assays$RNA@counts) #9289 186125
dim(so_kidney_sc@assays$RNA) #9289 186125
dim(so_kidney_sc) #9289 186125
sum(grepl("^MT-", rownames(so_kidney_sc@assays$RNA@counts))) #70
ncol(so_kidney_sc) #186125 cells
nrow(so_kidney_sc) #9289 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_kidney_sc), value = TRUE)
#keep_ids <- unique(rownames(so_kidney_sc)[which(!rownames(so_kidney_sc) %in% mito_genes)])
# so_kidney_sc <- subset(so_kidney_sc, features = setdiff(rownames(so_kidney_sc), mito_genes))
# so_kidney_sc <- subset(so_kidney_sc,kit_id!="KL-0029535")
#so_kidney_sc$Gene <- rownames(so_kidney_sc)
#so_kidney_sc <- subset(so_kidney_sc, Gene %in% keep_ids)
so_kidney_sc <- subset(so_kidney_sc, features = setdiff(rownames(so_kidney_sc@assays$RNA@counts), mito_genes))
#so_kidney_sc <- subset(so_kidney_sc, features = setdiff(rownames(so_kidney_sc@assays$RNA@counts), mito_genes))
# so_kidney_sc <- subset(so_kidney_sc, !rownames(so_kidney_sc) %in% mito_genes)
# grep("^MT-", rownames(so_kidney_sc@assays$RNA@counts), value = TRUE)
dim(so_kidney_sc@assays$RNA@counts) #9276 186125
dim(so_kidney_sc@assays$RNA@data) #9276 186125
dim(so_kidney_sc@assays$RNA)#9276 186125
sum(grepl("^MT-", rownames(so_kidney_sc@assays$RNA@counts))) #0
ncol(so_kidney_sc) #186125 cells
nrow(so_kidney_sc) #9276 genes

# # Identify mitochondrial genes
# mt_genes <- grepl("^MT", rownames(so_kidney_sc@assays$RNA@counts))
# 
# # Calculate the percentage of mitochondrial genes per cell
# mt_percentage <- Matrix::colSums(so_kidney_sc@assays$RNA@counts[mt_genes, ]) / Matrix::colSums(so_kidney_sc@assays$RNA@counts)
# 
# # Filter out cells where the proportion of mitochondrial genes is > 15%
# cells_to_keep <- mt_percentage <= 0.15
# 
# # Subset the object to retain only cells with <= 15% mitochondrial genes
# so_kidney_sc <- so_kidney_sc[, cells_to_keep]

# Check dimensions after filtering
dim(so_kidney_sc@assays$RNA@counts) #9276 81882
dim(so_kidney_sc@assays$RNA)#9276 81882
dim(so_kidney_sc)#9276 81882

# Optionally, you can also check how many MT genes remain in the filtered dataset
sum(grepl("^MT-", rownames(so_kidney_sc@assays$RNA@counts)))
ncol(so_kidney_sc)  # Number of cells remaining


# Step 3: Renormalize the Seurat object after filtering
so_kidney_sc <- NormalizeData(so_kidney_sc)

#Check normalized slot
dim(so_kidney_sc@assays$RNA@data) #5714 186125
sum(grepl("^MT-", rownames(so_kidney_sc@assays$RNA@data))) #70
ncol(so_kidney_sc) #186125 cells
nrow(so_kidney_sc) #5714 genes

#Load in med data to update medication information
med <- read.xlsx(fs::path(dir.dat,"Kidney scRNAseq Project/Data/Biopsies_w_mrn_Oct3.xlsx"))
med <- med %>% 
  dplyr::select(all_of(c("record_id","mrn","raasi_1","insulin_1","mfm_1")))
meta_kidney_sc <-  so_kidney_sc@meta.data
med <- med %>% 
  filter(mrn %in% as.character(meta_kidney_sc$mrn)) #95 remain
med <- med %>%  
  filter(record_id %in% meta_kidney_sc$record_id) #81 remain
# med$mrn <- as.numeric(med$mrn)
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
med$mrn <- as.numeric(med$mrn)
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(med,by=c("mrn","record_id"))
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)

#Add Med Meta Data to Seurat object
so_kidney_sc <- AddMetaData(so_kidney_sc, meta_kidney_sc)
rm(gene_expression_matrix,med,meta_kidney_sc)
# saveRDS(so_kidney_sc,fs::path(dir.dat,"Kidney scRNAseq Project","Data","so_kidney_sc_10_mito.rds"))

check3 <- so_kidney_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","group2","medication","pah_clear_bsa","pah_clear_abs")))
unique(check3$kit_id[which(is.na(check3$pah_clear_abs))])
unique(check3$kit_id[which(is.na(check3$pah_clear_bsa))])
#Remove kidney ids without pah clearance
ids2 <- ids[which(!ids %in% unique(check3$kit_id[which(is.na(check3$pah_clear_abs))]))] #69 individuals have pah data
#Filter to only those 69 ids
so_kidney_sc <- subset(so_kidney_sc, kit_id %in% ids2)
rm(check3)
```

```{r, include=F}
#Local
# dir.dat <- c("/Users/hhampson/Dropbox/Bjornstad data")
# so_kidney_sc <- readRDS(fs::path(dir.dat,"Kidney scRNA","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
# load("/Volumes/Peds Endo/Petter Bjornstad/Data Harmonization/Data Exports/PB90_clinical_metadata.RData")
# so_kidney_sc <- AddMetaData(so_kidney_sc, so_meta_combined)
# rm(so_meta_combined)
# gc()

#Lambda
so_kidney_sc <- readRDS(fs::path(dir.dat,"scRNA","data_raw","PB_90samples_Harmony_rpca_Fadhl_PhilApproved_091024.RDS"))
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="KI-0014643")] <- "KL-0014643"
so_kidney_sc$kit_id[which(so_kidney_sc$kit_id=="kl-0023998")] <- "KL-0023998"
#check2 <- so_kidney_sc@meta.data

#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv")) #small meta set
# harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata2.csv")) #all metadata vars
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney scRNAseq Project","Data","harmonized_data_kidney_sc_all_metadata2.csv"))

#"KL-0014634" "KL-0014629" "KL-0014628" coenrolled IDs
#"KL-0014634" "KL-0014629" "KL-0014628" having missing meta data 

#KL-0014628: IT_10/RH-66-T KL-0014628 KL-0019101
#KL-0014629: IT_09/RH-65-T
#KL-0014634: IT_07/RH-59-T
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group")))

#Partipant 30051 (kit id KL-0027474 at 4m has sc, but at baseline no sc has kit id KL-0027474 metadata)
#missing <- c("KL-0014628", "KL-0014629", "KL-0014634", "KL-0019059", "KL-0019092", "KL-0019101", "KL-0022159", "KL-0024005", "KL-0027470", #"KL-0027478")
#Check these ids in metadat
#check <- harm_meta_data %>%
  #filter(kit_id %in% missing)

#IDs missing group information  
#Filter out attempt participants
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)
#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
  #mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                            sglt2 == "Yes" ~ "sglt2",
                            glp1 == "Yes" ~ "glp1",
                            no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
gc()
meta_kidney_sc <-  so_kidney_sc@meta.data 
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
meta_kidney_sc <- meta_kidney_sc %>%
  #dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(harm_meta_data,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
#Check to see if all ids still have metadata
#check4 <- meta_kidney_sc %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check4 <- check4 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))

#rownames(meta_kidney_sc) <- rownames(so_kidney_sc@meta.data)
ids <- harm_meta_data$kit_id
#Filter seurat object to only IDs that have the metadata (83 individuals of interest)
so_kidney_sc <- AddMetaData(so_kidney_sc, meta_kidney_sc)
#check5 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check5 <- check5 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))
so_kidney_sc <- subset(so_kidney_sc, kit_id %in% ids)
#check6 <- so_kidney_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check6 <- check6 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","group2")))
#unique(so_kidney_sc$group)
#unique(so_kidney_sc$group2)
rm(meta_kidney_sc,harm_meta_data)

#Switch default assay in seurat object to RNA
DefaultAssay(so_kidney_sc) <- "RNA"
gc()

check3 <- so_kidney_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","group2","medication","pah_clear_bsa","pah_clear_abs")))
unique(check3$kit_id[which(is.na(check3$pah_clear_abs))])
unique(check3$kit_id[which(is.na(check3$pah_clear_bsa))])

#Find pah clearance abs and bsa new
harm_data <- read.csv("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/Data Harmonization/Data Clean/harmonized_dataset.csv")
pah <- harm_data %>% 
  dplyr::select(all_of(c("mrn","kit_id","cryostor_id","rnalater_id","pah_clear_bsa","pah_clear_abs","visit","procedure")))
unique(so_kidney_sc$kit_id)
unique(so_kidney_sc$mrn) 
pah <- pah %>% 
  filter(mrn %in% unique(so_kidney_sc$mrn) )
pah <- pah %>% 
  filter(procedure=="clamp") %>% 
  filter(visit=="baseline")
pah <- pah %>% 
  filter(!is.na(pah_clear_abs))

#Remove kidney ids without pah clearance
ids2 <- ids[which(!ids %in% unique(check3$kit_id[which(is.na(check3$pah_clear_abs))]))] #69 individuals have pah data
#Filter to only those 69 ids
so_kidney_sc <- subset(so_kidney_sc, kit_id %in% ids2)
rm(check3)
#FIlter to oat genes only

```

## b. Format Data - New KPMP
```{r, include=F}
#Load KPMP Cell Types 2 (new)
#Mac Studio
so_kpmp_sc <- readRDS("/Users/hhampson/Library/CloudStorage/OneDrive-UW/Biostatistics Core Shared Drive/scRNA/data_raw/PB_90_RPCAFix_Metadata_LR_RM_kpmpV1labelled.rds")

so_kpmp_sc$kit_id[which(so_kpmp_sc$kit_id=="KI-0014643")] <- "KL-0014643"
so_kpmp_sc$kit_id[which(so_kpmp_sc$kit_id=="kl-0023998")] <- "KL-0023998"
#check2 <- so_kpmp_sc@meta.data

#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv")) #small meta set
#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata.csv")) #all metadata vars
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney scRNAseq Project","Data","harmonized_data_kidney_sc_all_metadata2.csv"))
#Get coenrolled IDs
coenroll <- read.csv(fs::path(dir.dat,"Renal HERITAGE/Data_Cleaned/coenrolled_ids.csv"))

#Which IDs are coenrolled 
coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="")]
coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="" & coenroll$improve_id!="")]

#"KL-0014634" "KL-0014629" "KL-0014628" coenrolled IDs
#"KL-0014634" "KL-0014629" "KL-0014628" having missing meta data 

#KL-0014628: IT_10/RH-66-T KL-0014628 KL-0019101
#KL-0014629: IT_09/RH-65-T
#KL-0014634: IT_07/RH-59-T
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group")))

#Partipant 30051 (kit id KL-0027474 at 4m has sc, but at baseline no sc has kit id KL-0027474 metadata)
#missing <- c("KL-0014628", "KL-0014629", "KL-0014634", "KL-0019059", "KL-0019092", "KL-0019101", "KL-0022159", "KL-0024005", "KL-0027470", #"KL-0027478")
#Check these ids in metadat
#check <- harm_meta_data %>%
#filter(kit_id %in% missing)

#IDs missing group information  
#Filter out attempt participants
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)
#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
#mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                                sglt2 == "Yes" ~ "sglt2",
                                glp1 == "Yes" ~ "glp1",
                                no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))
#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
gc()
meta_kidney_sc <-  so_kpmp_sc@meta.data 
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
meta_kidney_sc <- meta_kidney_sc %>%
  #dplyr::mutate(RNAlater_ID = SampleID) %>%
  left_join(harm_meta_data,by="kit_id")
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
#Check to see if all ids still have metadata
#check4 <- meta_kidney_sc %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check4 <- check4 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))

#rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
ids <- harm_meta_data$kit_id
#Filter seurat object to only IDs that have the metadata (83 individuals of interest)
so_kpmp_sc <- AddMetaData(so_kpmp_sc, meta_kidney_sc)
#check5 <- so_kpmp_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check5 <- check5 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))
so_kpmp_sc <- subset(so_kpmp_sc, kit_id %in% ids)
#check6 <- so_kpmp_sc@meta.data %>%
#  filter(kit_id=="KL-0014628" | kit_id=="KL-0014629" | kit_id=="KL-0014634")
#check6 <- check6 %>%
#  dplyr::select(all_of(c("kit_id","record_id.x","record_id.y","co_enroll_id","group","KPMP_celltype")))
#unique(so_kpmp_sc$group)
#unique(so_kpmp_sc$KPMP_celltype)
rm(meta_kidney_sc,harm_meta_data)

#Switch default assay in seurat object to RNA
DefaultAssay(so_kpmp_sc) <- "RNA"
gc()

check3 <- so_kpmp_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","KPMP_celltype","medication")))
# rm(check3)
unique(so_kpmp_sc$co_enroll_id) 
length(unique(check3$kit_id))
#"RH-66-T" "RH-65-T" "RH-59-T" "IT2D-08" "RH-98-T" "RH-99-T" "RH-16-T" "RH-23-T" "RH-19-O" "RH-96-T" "RH-67-T"
#"RH-99-T" "RH-16-T" "RH-23-T" "RH-19-O" "RH-96-T" "RH-67-T" IDs coenrolled in RH and RH2 as a baseline and followup - filter out their RH2 study visit?
#RH-67-T/RH2-19 kit id for second visit to filter out: KL-0030621
#RH-23/RH2-14 kit id for second visit to filter out: KL-0029535

# #Check if coenrolled IDs have multiple biopsies
# co1 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="")] #Coenrolled in RH&RH2
# co2 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$rh_id!="" & coenroll$improve_id!="")] #Coenrolled in Improve/RH/RH2
# co3 <- coenroll$rh_id[which(coenroll$rh2_id!="" & coenroll$improve_id!="")] #Coenrolled in Improve/RH2
# co4 <- coenroll$rh_id[which(coenroll$rh_id!="" & coenroll$improve_id!="")] #Coenroleld in Improve/RH
# co5 <- coenroll$crc_id[which(coenroll$crc_id!="" & coenroll$panda_id!="")] #Coenrolled in Crocodile and panda
# co6 <- coenroll$panda_id[which(coenroll$panda_id!="" & coenroll$crc_id!="")]
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co1)]) #"RH-68-T" "RH-23-T" "RH-60-T" "RH-67-T" "RH-93-T"
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co2)]) #"RH-60-T"
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co3)]) #"RH-60-T"
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co4)]) #"RH-66-T" "RH-65-T" "RH-59-T" "RH-60-T"
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co5)]) #"CRC-21" "CRC-04" "CRC-09" "CRC-24" "CRC-18" "CRC-07" "CRC-38" "CRC-32" "CRC-36" "CRC-44" "CRC-43" "CRC-16" "CRC-42" "CRC-31" "CRC-48" "CRC-59"
# unique(so_kpmp_sc$record_id[which(so_kpmp_sc$record_id %in% co6)]) #"CRC-21" "CRC-04" "CRC-09" "CRC-24" "CRC-18" "CRC-07" "CRC-38" "CRC-32" "CRC-36" "CRC-44" "CRC-43" "CRC-16" "CRC-42" "CRC-31" "CRC-48" "CRC-59"
# 
# rm(coenroll,check3)


so_kpmp_sc <- subset(so_kpmp_sc,kit_id!="KL-0030621")
so_kpmp_sc <- subset(so_kpmp_sc,kit_id!="KL-0029535")
check3 <- so_kpmp_sc@meta.data
check3 <- check3 %>%
  dplyr::select(all_of(c("kit_id","record_id","co_enroll_id","group","KPMP_celltype","medication")))
length(unique(check3$kit_id)) #81
rm(check3)
rm(coenroll)

#Check the total number of cells & genes in the full dataset
ncol(so_kpmp_sc) #186125 cells
nrow(so_kpmp_sc) #31332 genes

dim(so_kpmp_sc@assays$RNA@layers$counts) #31332 186125
sum(grepl("^MT-", rownames(so_kpmp_sc@assays$RNA))) #101

# #Filter out mitochondrial DNA
# gene_expression_matrix <- so_kpmp_sc@assays$RNA@counts
# 
# # Filter genes expressed in more than 10% of cells
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
# so_kpmp_sc@assays$RNA@counts <- gene_expression_matrix[expressed_genes,]
# 
# dim(so_kpmp_sc@assays$RNA@counts) #5759 186125 
# sum(grepl("^MT", rownames(so_kpmp_sc@assays$RNA@counts))) #45
# 
# ncol(so_kpmp_sc) #186125 cells
# nrow(so_kpmp_sc) #31332 genes
# 
# # Remove mitochondrial genes (prefix "MT")
# so_kpmp_sc@assays$RNA@counts <- so_kpmp_sc@assays$RNA@counts[grep("^MT", rownames(so_kpmp_sc@assays$RNA@counts), invert = TRUE),]
# ncol(so_kpmp_sc) #186125 cells
# nrow(so_kpmp_sc) #31332 genes
# dim(so_kpmp_sc@assays$RNA@counts) #5714 186125
# sum(grepl("^MT", rownames(so_kpmp_sc@assays$RNA@counts))) #0

# Step 1: Filter to genes expressed in more than 5% of cells
gene_expression_matrix <- so_kpmp_sc@assays$RNA@layers$counts
rownames(gene_expression_matrix) <- rownames(so_kpmp_sc@assays$RNA)
colnames(gene_expression_matrix) <- colnames(so_kpmp_sc@assays$RNA)
# expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.1
expressed_genes <- Matrix::rowSums(gene_expression_matrix != 0) > dim(gene_expression_matrix)[2] * 0.05
names(expressed_genes)
rownames(gene_expression_matrix)[expressed_genes]

so_kpmp_sc <- subset(so_kpmp_sc, features = rownames(gene_expression_matrix)[expressed_genes])
dim(so_kpmp_sc@assays$RNA@layers$counts) #9289 186125
dim(so_kpmp_sc@assays$RNA) #9289 186125
dim(so_kpmp_sc) #9289 186125
sum(grepl("^MT-", rownames(so_kpmp_sc@assays$RNA))) #70
ncol(so_kpmp_sc) #186125 cells
nrow(so_kpmp_sc) #9289 genes

# Step 2: Remove mitochondrial genes (those starting with "MT")
mito_genes <- grep("^MT-", rownames(so_kpmp_sc@assays$RNA), value = TRUE)
so_kpmp_sc <- subset(so_kpmp_sc, features = setdiff(rownames(so_kpmp_sc), mito_genes))
dim(so_kpmp_sc@assays$RNA@layers$counts) #9276 186125
dim(so_kpmp_sc@assays$RNA@layers$data) #9276 186125
dim(so_kpmp_sc@assays$RNA)#5714 186125
sum(grepl("^MT-", rownames(so_kpmp_sc@assays$RNA@layers$counts))) #0
ncol(so_kpmp_sc) #186125 cells
nrow(so_kpmp_sc) #9276 genes

# # Identify mitochondrial genes
# mt_genes <- grepl("^MT", rownames(so_kpmp_sc@assays$RNA@counts))
# 
# # Calculate the percentage of mitochondrial genes per cell
# mt_percentage <- Matrix::colSums(so_kpmp_sc@assays$RNA@counts[mt_genes, ]) / Matrix::colSums(so_kpmp_sc@assays$RNA@counts)
# 
# # Filter out cells where the proportion of mitochondrial genes is > 15%
# cells_to_keep <- mt_percentage <= 0.15
# 
# # Subset the object to retain only cells with <= 15% mitochondrial genes
# so_kpmp_sc <- so_kpmp_sc[, cells_to_keep]

# Check dimensions after filtering
dim(so_kpmp_sc@assays$RNA@layers$counts) #9289 81882
dim(so_kpmp_sc@assays$RNA)#9289 81882
dim(so_kpmp_sc)#9289 81882

# Optionally, you can also check how many MT genes remain in the filtered dataset
sum(grepl("^MT-", rownames(so_kpmp_sc@assays$RNA@layers$counts)))
ncol(so_kpmp_sc)  # Number of cells remaining


# Step 3: Renormalize the Seurat object after filtering
so_kpmp_sc <- NormalizeData(so_kpmp_sc)

#Check normalized slot
dim(so_kpmp_sc@assays$RNA@layers$data) #5714 186125
sum(grepl("^MT-", rownames(so_kpmp_sc@assays$RNA@layers$data))) #70
ncol(so_kpmp_sc) #186125 cells
nrow(so_kpmp_sc) #5714 genes

#Load in med data to update medication information
med <- read.xlsx(fs::path(dir.dat,"Kidney scRNAseq Project/Data/Biopsies_w_mrn_Oct3.xlsx"))
med <- med %>% 
  dplyr::select(all_of(c("record_id","mrn","raasi_1","insulin_1","mfm_1")))
meta_kidney_sc <-  so_kpmp_sc@meta.data
med <- med %>% 
  filter(mrn %in% as.character(meta_kidney_sc$mrn)) #95 remain
med <- med %>%  
  filter(record_id %in% meta_kidney_sc$record_id) #81 remain
# med$mrn <- as.numeric(med$mrn)
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)
med$mrn <- as.numeric(med$mrn)
meta_kidney_sc <- meta_kidney_sc %>%
  left_join(med,by=c("mrn","record_id"))
rownames(meta_kidney_sc) <- rownames(so_kpmp_sc@meta.data)

#Add Med Meta Data to Seurat object
so_kpmp_sc <- AddMetaData(so_kpmp_sc, meta_kidney_sc)
rm(gene_expression_matrix,med,meta_kidney_sc)
rm(expressed_genes)
# saveRDS(so_kpmp_sc,fs::path(dir.dat,"Kidney scRNAseq Project","Data","so_kidney_sc_10_mito.rds"))
```

# 3. Descriptive Statistics
```{r, echo = F,warning=F}
#Load metadata for descriptive stats
#harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc.csv"))
harm_meta_data <- read.csv(fs::path(dir.dat,"Kidney Project","Data","harmonized_data_kidney_sc_all_metadata.csv")) #all metadata vars
harm_meta_data <- harm_meta_data %>% 
  dplyr::select(-X)

#Filter to individuals with pah clerance data 
harm_meta_data <- harm_meta_data %>%
  filter(kit_id %in% unique(so_kidney_sc$kit_id))

#Create Medication Groups
harm_meta_data <- harm_meta_data %>%
  mutate(glp1_sglt2=ifelse(epic_glp1ra_1=="Yes" & epic_sglti2_1=="Yes","Yes","No")) %>% 
  mutate(sglt2=ifelse(epic_sglti2_1=="Yes" & epic_glp1ra_1=="No","Yes","No")) %>% 
  mutate(glp1=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="Yes","Yes","No")) %>% 
  mutate(no_med=ifelse(epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))
  #mutate(=ifelse(group!="Type 2 Diabetes" &  epic_sglti2_1=="No" & epic_glp1ra_1=="No","Yes","No"))

#Define 4 exposure groups: 
#SGLT2i(+)/GLP1RA(+), SGLT2i(+)/GLP1RA(-), SGLT2i(-)/GLPRA(+), SGLT2i(-)/GLP1RA(-)
gc()
harm_meta_data <- harm_meta_data %>% 
  mutate(medication = case_when(glp1_sglt2 == "Yes" ~ "glp1_sglt2",
                            sglt2 == "Yes" ~ "sglt2",
                            glp1 == "Yes" ~ "glp1",
                            no_med == "Yes" ~ "no_med"))
harm_meta_data$medication <- factor(harm_meta_data$medication, levels = c("no_med", "sglt2", "glp1","glp1_sglt2"))

#Define a T2D+OB group
harm_meta_data <- harm_meta_data %>%
  mutate(group2 = ifelse((group=="Type 2 Diabetes" | group=="Obese Control"),"T2D + OB",group))
#check <- harm_meta_data %>%
#  dplyr::select(all_of(c("kit_id","group","group2")))

#Number of Individuals Per Study 
harm_summary1 <- harm_meta_data %>%
  group_by(study) %>%
  summarize(n=n())

#Number of Individuals Per Disease Group
harm_summary2 <- harm_meta_data %>%
  group_by(group) %>%
  summarize(n=n())

#Number of Individuals Per Medication Group
harm_summary3 <- harm_meta_data %>%
  group_by(medication) %>%
  summarize(n=n())

#Number of Individuals per med group & disease group
harm_summary4 <- harm_meta_data %>%
  group_by(group,medication) %>%
  summarize(n=n())

harm_summary5 <- harm_meta_data %>%
  group_by(study,group,medication) %>%
  summarize(n=n())

#Note: 83 participants have sc and metadata
#Covars of interest: 
#UACR, SBP/DBP (MAP), GFR, RPF, BMI, Fat Mass, Lean Mass, HbA1C, TKV/htTKV
dat <- harm_meta_data
label(dat$age)      <- "Age (y)"
label(dat$sex)      <- "Sex"
label(dat$hba1c) <- "HbA1c (%)"
dat$medication <- case_when(dat$medication=="no_med"~"No Medication",
                            dat$medication=="sglt2"~"Exclusive SLGT2i",
                            dat$medication=="glp1"~"Exclusive GLP-1ra",
                            dat$medication=="glp1_sglt2"~"GLP-1ra + SGLT2i")
#dat$medication <- factor(dat$medication)
label(dat$medication) <- "Medication Status"
label(dat$ace_inhibitor) <- "ACE Inhibitor (Yes vs. No)"
label(dat$angiotensin_receptor_blocker) <- "Angiotensin Receptor Blocker (Yes vs. No)"
label(dat$sbp) <- "Systolic Blood Pressure (mmHg)"
label(dat$dbp) <- "Diastolic Blood Pressure (mmHg)"
label(dat$map) <- "Mean Arterial Pressure (mmHg)"
label(dat$erpf_raw_plasma) <- "Estimated Renal Plasma Flow (mL/min)"
label(dat$bmi) <- "Body Mass Index (kg/m²)"
label(dat$dexa_fat_kg) <- "DEXA Fat Mass (kg)" 
label(dat$dexa_lean_kg) <- "DEXA Lean Mass (kg)"
label(dat$total_kidney_volume_ml) <- "Total Kidney Volume (mL)"
label(dat$ht_adj_tkv) <- "Height-Adjusted Total Kidney Volume (mL/m)"
label(dat$gfr_raw_plasma) <- "Glomerular Filtration Rate (mL/min)"
label(dat$eGFR_CKD_epi) <- "Estimated Glomerular Filtration Rate (mL/min/1.73 m²)"
label(dat$race_ethnicity)    <- "Race/Ethnicity"
label(dat$triglycerides) <-  "Triglycerides (mg/dL)"
label(dat$pah_clear_abs) <- "Absolute PAH Clearance (Plasma) (mL/min)"
label(dat$pah_clear_bsa) <- "BSA Normalized PAH Clearance (Plasma) (ml/min/1.73m2)"
label(dat$group) <- "Disease Status"
label(dat$group2) <- "Disease Status"
#race_ethnicity
#Table 1. Descriptive Statistics by Disease Status ----
table1(~ age + sex + bmi + race_ethnicity + map + 
         triglycerides + pah_clear_abs + group +
         medication | study, data=dat,overall=F)
table1(~ pah_clear_abs+dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides  | group, data=dat)
table1(~  gfr_raw_plasma +  
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+ 
         + medication | group, data=dat)
table1(~ age + sex + bmi + dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides + gfr_raw_plasma + eGFR_CKD_epi + 
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+ 
         + medication | group, data=dat)
#Table 1. Descriptive Statistics by Disease Status with T2D and OB Combined ----
table1(~ age + sex + bmi + dexa_fat_kg + dexa_lean_kg + hba1c +
         sbp + dbp + map + 
         triglycerides + gfr_raw_plasma + eGFR_CKD_epi + 
         erpf_raw_plasma+ total_kidney_volume_ml + ht_adj_tkv+
         ace_inhibitor + angiotensin_receptor_blocker+
         + medication | group2, data=dat)


#Visualize pah clearance on plots
p <- ggplot(dat, aes(x = group, y = pah_clear_abs, fill=group)) +
  geom_bar(stat="identity",position="dodge")+
  labs(x = "Disease Status", y = "PAH Clearance",fill="Disease Status") +
  theme_minimal() 
print(p)

p <- ggplot(dat, aes(x = group, y = pah_clear_abs, fill = group)) +
  geom_violin(trim = FALSE, alpha = 0.6) +  # Violin plot with full density
  geom_jitter(width = 0.2, alpha = 0.5) +  # Adds individual points for better visibility
  stat_summary(fun = mean, geom = "point", shape = 23, size = 3, color = "black", fill = "white") +  # Add means
  labs(x = "Disease Status", y = "PAH Clearance", fill = "Disease Status") +
  theme_minimal()

print(p)


p <- ggplot(dat, aes(x = group, y = pah_clear_abs, fill=medication)) +
  geom_bar(stat="identity",position="dodge")+
  labs(x = "Disease Status", y = "PAH Clearance",fill="Medication") +
  theme_minimal() 
print(p)

type2 <- dat%>%
  filter(group=="Type 2 Diabetes")
p <- ggplot(type2, aes(x = medication, y = pah_clear_abs, fill=medication)) +
  geom_bar(stat="identity",position="dodge")+
  labs(x = "Medication", y = "PAH Clearance",fill="Medication") +
  theme_minimal() 
print(p)

```


#4. Linear Regression 
##a. All KPMP Cell Types
```{r}
#Subset seurat object to OAT genes only
all.genes <- rownames(so_kidney_sc)
oat.genes <- all.genes[which(grepl("SLC22",all.genes))] #23 genes
oat_genes_in_data <- intersect(oat.genes, rownames(so_kidney_sc))
# Subset the Seurat object to include only genes in sens_gene_in_data
#so_sens_all <- subset(so_kidney_sc, features = sens_gene_in_data)
so_oat <- subset(so_kidney_sc, features=oat_genes_in_data)

#Aggregate expression data by each individuals cell type
agg_expression <- AggregateExpression(
  object = so_oat,
  features = NULL,
  group.by = c("kit_id", "celltype_rpca"),  # Aggregate by cell_type
  fun = "mean",
  return.seurat = FALSE
)

# Check the structure of the result
agg_expression_matrix <- agg_expression$RNA  # Assuming RNA is the name of your assay
#agg_expression_matrix <- as.matrix(agg_expression$RNA)

# Ensure 'pah' values are aligned with the conditions in agg_expression_matrix
# Assuming that the 'kit_id' and 'celltype_rpca' are the columns that the data was aggregated by.

# Extract metadata for 'pah' and align it with the columns of aggregated expression matrix
#agg_metadata <- so_kidney_sc@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs" ,"pah_clear_bsa")]
agg_metadata <- unique(so_oat@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs" ,"pah_clear_bsa")])

# Create a combined factor for 'kit_id' and 'celltype_rpca' to match columns in agg_expression_matrix
agg_metadata$condition <- interaction(agg_metadata$kit_id, agg_metadata$celltype_rpca, sep = "_")

# Check if the names match the column names of the aggregated expression matrix
colnames(agg_expression_matrix) <- as.character(agg_metadata$condition)

# Now align the pah values to the column names (conditions) of agg_expression_matrix
pah_values <- agg_metadata$pah_clear_abs

# Make sure pah_values is of the correct length to match the columns of the aggregated expression matrix
if(length(pah_values) != ncol(agg_expression_matrix)) {
  stop("The number of pah values does not match the number of columns in the aggregated expression matrix.")
}

agg_expression_df <- as.data.frame(t(agg_expression$RNA))  # Transpose so rows are (kit_id, celltype)
agg_expression_df$condition <- rownames(agg_expression_df)  # Extract condition names
agg_metadata <- unique(so_oat@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs", "pah_clear_bsa","age","sex","bmi","hba1c","group","group2","medication")])
agg_metadata$condition <- interaction(agg_metadata$kit_id, agg_metadata$celltype_rpca, sep = "_")

final_dataset <- merge(agg_metadata, agg_expression_df, by = "condition")

#Log transform gene expression
final_dataset <- final_dataset %>%
  mutate(across(all_of(oat.genes),~log(.),.names = "{.col}_log"))
log_oat_genes <- paste0(oat.genes,"_log")
#Filter to PT cells only
#pt_data <- final_dataset %>%
#  filter(grepl("PT-",celltype_rpca))
#PT_cells <- unique(pt_data$celltype_rpca)

#Calculate binary yes no expression variable for each gene
# Loop through each gene in oat.genes and create a binary column
#for (gene in oat.genes) {
for (gene in log_oat_genes) {
  # Create a new column with binary values for each gene
  #pt_data[[paste0(gene, "_bin")]] <- ifelse(pt_data[[gene]] > 0, 1, 0)
  final_dataset[[paste0(gene, "_bin")]] <- ifelse(final_dataset[[gene]] > 0, 1, 0)
}

hist(final_dataset$SLC22A25)
#Create a linear regression loop 
 reg_results <- data.frame()
 reg_results_adj <- data.frame()
 #covars <- c("age","sex","hba1c","medication")
 covars <- c("age","sex","group","medication")
 #covars <- c("age","sex")
#For each group type, stratif by disease status
# Iterate over each cell type (assuming cell_type is a vector of the unique cell types)
for (cell in unique(final_dataset$celltype_rpca)) {
  
  # Filter the data for the current cell type
  filtered_data <- final_dataset[final_dataset$celltype_rpca == cell, ]
  
  #Filter the data for the current disease group
  #filtered_data <- filtered_data[filtered_data$group == disease, ]
  
  # Iterate over each gene in the oat.genes list
  #for (gene in oat.genes) {
  for (gene in log_oat_genes) {
    
    # Define the formula for the crude model (without covariates)
    M0 <- as.formula(paste0("pah_clear_abs ~", gene, "_bin + ", gene))
    
    # Define the formula for the adjusted model (with covariates)
    M0_adj <- as.formula(paste0("pah_clear_abs ~", gene, "_bin + ", gene, " + ", paste(covars, collapse = " + ")))
    
    # Fit the crude model
    M1 <- lm(M0, data = filtered_data)
    
    # Fit the adjusted model
    M1_adj <- lm(M0_adj, data = filtered_data)
    
    # Initialize variables for regression coefficients and p-values
    Beta_Crude <- NA
    Beta_Adj <- NA
    Beta_Zero_Crude <- NA
    Beta_Zero_Adj <- NA
    Pval_Crude <- NA
    Pval_Adj <- NA
    Pval_Zero_Crude <- NA
    Pval_Zero_Adj <- NA
    
    # Check for the presence of coefficients in the models and assign appropriate values
    if (!is.na(M1$coefficients[2]) & !is.na(M1$coefficients[3])) {
      Beta_Crude <- summary(M1)$coef[3,1]
      Beta_Adj <- summary(M1_adj)$coef[3,1]
      Beta_Zero_Crude <- summary(M1)$coef[2,1]
      Beta_Zero_Adj <- summary(M1_adj)$coef[2,1]
      Pval_Crude <- summary(M1)$coef[3,4]
      Pval_Adj <- summary(M1_adj)$coef[3,4]
      Pval_Zero_Crude <- summary(M1)$coef[2,4]
      Pval_Zero_Adj <- summary(M1_adj)$coef[2,4]
    } else if (!is.na(M1$coefficients[2]) & is.na(M1$coefficients[3])) {
      Beta_Crude <- summary(M1)$coef[2,1]
      Beta_Adj <- summary(M1_adj)$coef[2,1]
      Beta_Zero_Crude <- NA
      Beta_Zero_Adj <- NA
      Pval_Crude <- summary(M1)$coef[2,4]
      Pval_Adj <- summary(M1_adj)$coef[2,4]
      Pval_Zero_Crude <- NA
      Pval_Zero_Adj <- NA
    } else if (is.na(M1$coefficients[2]) & !is.na(M1$coefficients[3])) {
      Beta_Crude <- NA
      Beta_Adj <- NA
      Beta_Zero_Crude <- summary(M1)$coef[2,1]
      Beta_Zero_Adj <- summary(M1_adj)$coef[2,1]
      Pval_Crude <- NA
      Pval_Adj <- NA
      Pval_Zero_Crude <- summary(M1)$coef[2,4]
      Pval_Zero_Adj <- summary(M1_adj)$coef[2,4]
    }
    
    # Create the results data frame for both crude and adjusted models
    results <- data.frame(Gene = gene, Cell = cell, 
                          Beta_Crude = Beta_Crude, Pval_Crude = Pval_Crude, 
                          Beta_Zero_Crude = Beta_Zero_Crude, Pval_Zero_Crude = Pval_Zero_Crude)
    results_adj <- data.frame(Gene = gene, Cell = cell, 
                              Beta_Adj = Beta_Adj, Pval_Adj = Pval_Adj, 
                              Beta_Zero_Adj = Beta_Zero_Adj, Pval_Zero_Adj = Pval_Zero_Adj)
    
    # Bind the results to the main results data frames
    reg_results <- rbind(reg_results, results)
    reg_results_adj <- rbind(reg_results_adj, results_adj)
  }
}
 

reg_results_fdr <- data.frame()
for(disease in unique(reg_results$Disease)) {
for (cell in unique(reg_results$Cell)) {
  
  # Filter the data for the current cell type
  filtered_results <- reg_results[reg_results$Cell == cell, ]
  
  # Calculate the adjusted p-values using the FDR method
  filtered_results$Pval_Crude_FDR <- p.adjust(filtered_results$Pval_Crude, method = "fdr")
  filtered_results$Pval_Crude_FDR_Sig <- ifelse(filtered_results$Pval_Crude_FDR<0.1,"*","")
  filtered_results$Pval_Zero_Crude_FDR <- p.adjust(filtered_results$Pval_Zero_Crude, method = "fdr")
  filtered_results$Pval_Zero_Crude_FDR_Sig <- ifelse(filtered_results$Pval_Zero_Crude_FDR<0.1,"*","")
  
  # Bind the results with the FDR adjusted p-values back to the main results data frame
  reg_results_fdr <- rbind(reg_results_fdr, filtered_results)
}
}

reg_results_adj_fdr <- data.frame()
for(disease in unique(reg_results$Disease)) {
# Loop through unique cell types in the reg_results_adj data frame
for (cell in unique(reg_results_adj$Cell)) {
  
  # Filter the data for the current cell type
  filtered_results <- reg_results_adj[reg_results_adj$Cell == cell, ]
  
  # Calculate the adjusted p-values using the FDR method
  filtered_results$Pval_Adj_FDR <- p.adjust(filtered_results$Pval_Adj, method = "fdr")
  filtered_results$Pval_Adj_FDR_Sig <- ifelse(filtered_results$Pval_Adj_FDR<0.1,"*","")
  filtered_results$Pval_Zero_Adj_FDR <- p.adjust(filtered_results$Pval_Zero_Adj, method = "fdr")
  filtered_results$Pval_Zero_Adj_FDR_Sig <- ifelse(filtered_results$Pval_Zero_Adj_FDR<0.1,"*","")
  
  # Bind the results with the FDR adjusted p-values back to the main results data frame
  reg_results_adj_fdr <- rbind(reg_results_adj_fdr, filtered_results)
}
}

# Define a significance threshold (adjust as needed)
sig_threshold <- 0.05  

p <- ggplot(reg_results_adj, aes(x = Beta_Adj, y = -log10(Pval_Adj), color = Pval_Adj < sig_threshold)) +
  geom_point(alpha = 0.7) +  # Scatter points
  geom_text_repel(aes(label = ifelse(Pval_Adj < sig_threshold, Gene, "")), 
                  size = 3, max.overlaps = 15) +  # Label significant genes
  scale_color_manual(values = c("black", "red")) +  # Red for significant genes
  labs(x = "Beta Estimate", y = "-log10(Adjusted P-value)", color = "Significance") +
  theme_minimal() +
  facet_wrap(~ Cell)  # Create separate volcano plots per cell type
pdf(fs::path(dir.results,"Volcano_OAT_PAH_Results.pdf"),width=20,height=10)
print(p) 
dev.off()
  
#write.csv(reg_results,fs::path(dir.results,"PAH_Clearance_vs_OAT_Exp_All_Cells_crude_fdr.csv"))
#write.csv(reg_results_adj,fs::path(dir.results,"PAH_Clearance_vs_OAT_Exp_All_Cells_adj_fdr.csv"))


#Visulaize results 

#Scatter plots
final_dataset$celltype <- final_dataset$celltype_rpca

for (gene in unique(reg_results_adj_fdr$Gene)) {
  pdf(fs::path(dir.results,paste0(gene,"_vs_PAH_Clearance_by_Cell_Type.pdf")),width=10,height=10)
p <- ggplot(final_dataset , aes(x = .data[[gene]], y = pah_clear_abs)) +
  geom_point() +  # Add points to the scatterplot
  geom_smooth(method="lm",se=F)+
  theme_bw() +
  labs(title=paste0(gene," vs. PAH Clearance"),
       x=paste0("Expression of ",gene),
       y="PAH Clearance")+
  facet_wrap(~celltype)
print(p)
dev.off()
}

#significant scatterplots
for (gene in unique(reg_results_adj_fdr$Gene)) {
  pdf(fs::path(dir.results,paste0(gene,"_vs_PAH_Clearance_by_Cell_Type.pdf")),width=10,height=10)
p <- ggplot(final_dataset , aes(x = .data[[gene]], y = pah_clear_abs)) +
  geom_point() +  # Add points to the scatterplot
  geom_smooth(method="lm",se=F)+
  theme_bw() +
  labs(title=paste0(gene," vs. PAH Clearance"),
       x=paste0("Expression of ",gene),
       y="PAH Clearance")+
  facet_wrap(~celltype)
print(p)
dev.off()
}
#Barcharts
#visualize pah clearance by group






```

##b. Pseudobulk PT & Tal
```{r}
#Subset seurat object to OAT genes only
all.genes <- rownames(so_kidney_sc)
oat.genes <- all.genes[which(grepl("SLC22",all.genes))] #23 genes
oat_genes_in_data <- intersect(oat.genes, rownames(so_kidney_sc))
# Subset the Seurat object to include only genes in sens_gene_in_data
#so_sens_all <- subset(so_kidney_sc, features = sens_gene_in_data)
so_oat <- subset(so_kidney_sc, features=oat_genes_in_data)

#Aggregate expression data by each individuals cell type
agg_expression <- AggregateExpression(
  object = so_oat,
  features = NULL,
  group.by = c("kit_id", "celltype_rpca"),  # Aggregate by cell_type
  fun = "mean",
  return.seurat = FALSE
)

# Check the structure of the result
agg_expression_matrix <- agg_expression$RNA  # Assuming RNA is the name of your assay
#agg_expression_matrix <- as.matrix(agg_expression$RNA)

# Ensure 'pah' values are aligned with the conditions in agg_expression_matrix
# Assuming that the 'kit_id' and 'celltype_rpca' are the columns that the data was aggregated by.

# Extract metadata for 'pah' and align it with the columns of aggregated expression matrix
#agg_metadata <- so_kidney_sc@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs" ,"pah_clear_bsa")]
agg_metadata <- unique(so_oat@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs" ,"pah_clear_bsa")])

# Create a combined factor for 'kit_id' and 'celltype_rpca' to match columns in agg_expression_matrix
agg_metadata$condition <- interaction(agg_metadata$kit_id, agg_metadata$celltype_rpca, sep = "_")

# Check if the names match the column names of the aggregated expression matrix
colnames(agg_expression_matrix) <- as.character(agg_metadata$condition)

# Now align the pah values to the column names (conditions) of agg_expression_matrix
pah_values <- agg_metadata$pah_clear_abs

# Make sure pah_values is of the correct length to match the columns of the aggregated expression matrix
if(length(pah_values) != ncol(agg_expression_matrix)) {
  stop("The number of pah values does not match the number of columns in the aggregated expression matrix.")
}

agg_expression_df <- as.data.frame(t(agg_expression$RNA))  # Transpose so rows are (kit_id, celltype)
agg_expression_df$condition <- rownames(agg_expression_df)  # Extract condition names
agg_metadata <- unique(so_oat@meta.data[, c("kit_id", "celltype_rpca", "pah_clear_abs", "pah_clear_bsa","age","sex","bmi","hba1c","group","group2","medication")])
agg_metadata$condition <- interaction(agg_metadata$kit_id, agg_metadata$celltype_rpca, sep = "_")

final_dataset <- merge(agg_metadata, agg_expression_df, by = "condition")

#Filter to PT cells only
#pt_data <- final_dataset %>%
#  filter(grepl("PT-",celltype_rpca))
#PT_cells <- unique(pt_data$celltype_rpca)

#Calculate binary yes no expression variable for each gene
# Loop through each gene in oat.genes and create a binary column
for (gene in oat.genes) {
  # Create a new column with binary values for each gene
  #pt_data[[paste0(gene, "_bin")]] <- ifelse(pt_data[[gene]] > 0, 1, 0)
  final_dataset[[paste0(gene, "_bin")]] <- ifelse(final_dataset[[gene]] > 0, 1, 0)
}


#Create a linear regression loop 
 reg_results <- data.frame()
 reg_results_adj <- data.frame()
 #covars <- c("age","sex","hba1c","medication")
 covars <- c("age","sex","group","medication")
 #covars <- c("age","sex")
#For each group type, stratif by disease status
# Iterate over each cell type (assuming cell_type is a vector of the unique cell types)
for (cell in unique(final_dataset$celltype_rpca)) {
  
  # Filter the data for the current cell type
  filtered_data <- final_dataset[final_dataset$celltype_rpca == cell, ]
  
  #Filter the data for the current disease group
  #filtered_data <- filtered_data[filtered_data$group == disease, ]
  
  # Iterate over each gene in the oat.genes list
  for (gene in oat.genes) {
    
    # Define the formula for the crude model (without covariates)
    M0 <- as.formula(paste0("pah_clear_abs ~", gene, "_bin + ", gene))
    
    # Define the formula for the adjusted model (with covariates)
    M0_adj <- as.formula(paste0("pah_clear_abs ~", gene, "_bin + ", gene, " + ", paste(covars, collapse = " + ")))
    
    # Fit the crude model
    M1 <- lm(M0, data = filtered_data)
    
    # Fit the adjusted model
    M1_adj <- lm(M0_adj, data = filtered_data)
    
    # Initialize variables for regression coefficients and p-values
    Beta_Crude <- NA
    Beta_Adj <- NA
    Beta_Zero_Crude <- NA
    Beta_Zero_Adj <- NA
    Pval_Crude <- NA
    Pval_Adj <- NA
    Pval_Zero_Crude <- NA
    Pval_Zero_Adj <- NA
    
    # Check for the presence of coefficients in the models and assign appropriate values
    if (!is.na(M1$coefficients[2]) & !is.na(M1$coefficients[3])) {
      Beta_Crude <- summary(M1)$coef[3,1]
      Beta_Adj <- summary(M1_adj)$coef[3,1]
      Beta_Zero_Crude <- summary(M1)$coef[2,1]
      Beta_Zero_Adj <- summary(M1_adj)$coef[2,1]
      Pval_Crude <- summary(M1)$coef[3,4]
      Pval_Adj <- summary(M1_adj)$coef[3,4]
      Pval_Zero_Crude <- summary(M1)$coef[2,4]
      Pval_Zero_Adj <- summary(M1_adj)$coef[2,4]
    } else if (!is.na(M1$coefficients[2]) & is.na(M1$coefficients[3])) {
      Beta_Crude <- summary(M1)$coef[2,1]
      Beta_Adj <- summary(M1_adj)$coef[2,1]
      Beta_Zero_Crude <- NA
      Beta_Zero_Adj <- NA
      Pval_Crude <- summary(M1)$coef[2,4]
      Pval_Adj <- summary(M1_adj)$coef[2,4]
      Pval_Zero_Crude <- NA
      Pval_Zero_Adj <- NA
    } else if (is.na(M1$coefficients[2]) & !is.na(M1$coefficients[3])) {
      Beta_Crude <- NA
      Beta_Adj <- NA
      Beta_Zero_Crude <- summary(M1)$coef[2,1]
      Beta_Zero_Adj <- summary(M1_adj)$coef[2,1]
      Pval_Crude <- NA
      Pval_Adj <- NA
      Pval_Zero_Crude <- summary(M1)$coef[2,4]
      Pval_Zero_Adj <- summary(M1_adj)$coef[2,4]
    }
    
    # Create the results data frame for both crude and adjusted models
    results <- data.frame(Gene = gene, Cell = cell, 
                          Beta_Crude = Beta_Crude, Pval_Crude = Pval_Crude, 
                          Beta_Zero_Crude = Beta_Zero_Crude, Pval_Zero_Crude = Pval_Zero_Crude)
    results_adj <- data.frame(Gene = gene, Cell = cell, 
                              Beta_Adj = Beta_Adj, Pval_Adj = Pval_Adj, 
                              Beta_Zero_Adj = Beta_Zero_Adj, Pval_Zero_Adj = Pval_Zero_Adj)
    
    # Bind the results to the main results data frames
    reg_results <- rbind(reg_results, results)
    reg_results_adj <- rbind(reg_results_adj, results_adj)
  }
}
 

reg_results_fdr <- data.frame()
for(disease in unique(reg_results$Disease)) {
for (cell in unique(reg_results$Cell)) {
  
  # Filter the data for the current cell type
  filtered_results <- reg_results[reg_results$Cell == cell, ]
  
  # Calculate the adjusted p-values using the FDR method
  filtered_results$Pval_Crude_FDR <- p.adjust(filtered_results$Pval_Crude, method = "fdr")
  filtered_results$Pval_Crude_FDR_Sig <- ifelse(filtered_results$Pval_Crude_FDR<0.1,"*","")
  filtered_results$Pval_Zero_Crude_FDR <- p.adjust(filtered_results$Pval_Zero_Crude, method = "fdr")
  filtered_results$Pval_Zero_Crude_FDR_Sig <- ifelse(filtered_results$Pval_Zero_Crude_FDR<0.1,"*","")
  
  # Bind the results with the FDR adjusted p-values back to the main results data frame
  reg_results_fdr <- rbind(reg_results_fdr, filtered_results)
}
}

reg_results_adj_fdr <- data.frame()
for(disease in unique(reg_results$Disease)) {
# Loop through unique cell types in the reg_results_adj data frame
for (cell in unique(reg_results_adj$Cell)) {
  
  # Filter the data for the current cell type
  filtered_results <- reg_results_adj[reg_results_adj$Cell == cell, ]
  
  # Calculate the adjusted p-values using the FDR method
  filtered_results$Pval_Adj_FDR <- p.adjust(filtered_results$Pval_Adj, method = "fdr")
  filtered_results$Pval_Adj_FDR_Sig <- ifelse(filtered_results$Pval_Adj_FDR<0.1,"*","")
  filtered_results$Pval_Zero_Adj_FDR <- p.adjust(filtered_results$Pval_Zero_Adj, method = "fdr")
  filtered_results$Pval_Zero_Adj_FDR_Sig <- ifelse(filtered_results$Pval_Zero_Adj_FDR<0.1,"*","")
  
  # Bind the results with the FDR adjusted p-values back to the main results data frame
  reg_results_adj_fdr <- rbind(reg_results_adj_fdr, filtered_results)
}
}
  
  
#write.csv(reg_results,fs::path(dir.results,"PAH_Clearance_vs_OAT_Exp_All_Cells_crude_fdr.csv"))
#write.csv(reg_results_adj,fs::path(dir.results,"PAH_Clearance_vs_OAT_Exp_All_Cells_adj_fdr.csv"))


#Visulaize results 

#Scatter plots
final_dataset$celltype <- final_dataset$celltype_rpca

for (gene in unique(reg_results_adj_fdr$Gene)) {
  pdf(fs::path(dir.results,paste0(gene,"_vs_PAH_Clearance_by_Cell_Type.pdf")),width=10,height=10)
p <- ggplot(final_dataset , aes(x = .data[[gene]], y = pah_clear_abs)) +
  geom_point() +  # Add points to the scatterplot
  geom_smooth(method="lm",se=F)+
  theme_bw() +
  labs(title=paste0(gene," vs. PAH Clearance"),
       x=paste0("Expression of ",gene),
       y="PAH Clearance")+
  facet_wrap(~celltype)
print(p)
dev.off()
}

#significant scatterplots
for (gene in unique(reg_results_adj_fdr$Gene)) {
  pdf(fs::path(dir.results,paste0(gene,"_vs_PAH_Clearance_by_Cell_Type.pdf")),width=10,height=10)
p <- ggplot(final_dataset , aes(x = .data[[gene]], y = pah_clear_abs)) +
  geom_point() +  # Add points to the scatterplot
  geom_smooth(method="lm",se=F)+
  theme_bw() +
  labs(title=paste0(gene," vs. PAH Clearance"),
       x=paste0("Expression of ",gene),
       y="PAH Clearance")+
  facet_wrap(~celltype)
print(p)
dev.off()
}
#Barcharts
#visualize pah clearance by group






```

#5. Differential Expression Analysis
```{r}
#Define Gene Sets
all.genes = rownames(so_kidney_sc)
oat.genes <- all.genes[which(grepl("SLC22",all.genes))]

#Differential Expression of SLC22 genes in PT by Group
#Define Proximal Tubule Cells (PT)
so_kidney_sc@meta.data$PT <- ifelse(grepl("PT",so_kidney_sc$celltype_rpca),"PT","")
Idents(so_kidney_sc) <- so_kidney_sc$PT

#PAH Clearance Normal vs. Low 
so_kidney_sc@meta.data$pah_norm <- ifelse(so_kidney_sc@meta.data$pah_clear_bsa>=625,"Normal","Low")
## Top 2000 genes
de.markers(so_kidney_sc, oat.genes, "pah_norm", id2 = "Normal", id1 = "Low", "PT", "_top")
m_top <- m_top %>% head(2000)

# significant_genes <- m_top %>% filter(p_val_adj < 0.05)
# 
# # Select the top 10 positive and top 10 negative log2FC genes that are significant
# top_genes <- rbind(
#   significant_genes %>% arrange(desc(avg_log2FC)) %>% head(10),  # Top 10 positive log2FC
#   significant_genes %>% arrange(avg_log2FC) %>% head(10)         # Top 10 negative log2FC
# )
# 
# labels <- ifelse(rownames(m_top) %in% rownames(top_genes), rownames(m_top), NA)
# p <- EnhancedVolcano(m_top,
#                      lab = labels,
#                      x = 'avg_log2FC',
#                      y = 'p_val_adj',
#                      title = paste0("Differentially Expressed OAT Genes by PAH Clearance (Pseudobulk PT)"),
#                      subtitle = paste0("Positive Log2 FC = Greater Expression in PAH Clearance Normal vs. Low\n",
#                                        "(Significant at FDR-P<0.05, FC Threshold = 0.5)"),
#                      pCutoff = 0.05,
#                      FCcutoff = 0.1,
#                      labFace = 'bold',
#                      pointSize = 4,
#                      labSize = 5,
#                      drawConnectors = TRUE,
#                      widthConnectors = 1.0,
#                      colConnectors = 'black',
#                      legendPosition=NULL,
#                      boxedLabels = TRUE,
#                      max.overlaps=20)
# plot(p)

```

#6. Model-based Analysis of Single-cell Transcriptomics 
```{r}
# Get expression matrix (counts)
expr_matrix <- as.matrix(GetAssayData(so_kidney_sc, layer = "counts"))

# Extract metadata containing your continuous variable, e.g., PAH clearance
metadata <- so_kidney_sc@meta.data

# Assuming the rownames of your metadata or expression matrix correspond to unique cell IDs
metadata$wellKey <- rownames(metadata)

# Create SingleCellAssay object with the updated metadata containing wellKey
sca <- FromMatrix(exprsArray = expr_matrix, cData = metadata)

#Specify the Regression Model
zlm_model <- zlm(~ pah_clear_bsa, sca)

#Extract results
# Test for the effect of PAH clearance
summary_res <- summary(zlm_model, doLRT='pah_clearance')

# Extract the summary DataFrame
summary_dt <- summary_res$datatable

# Filtering for significant genes based on a specific threshold (e.g., p < 0.05)
significant_genes <- summary_dt[summary_dt$component == "H" & summary_dt$`Pr(>Chisq)` < 0.05,]

# Plot the effect of PAH clearance on specific genes
# Example: Plot gene expression of gene X against PAH clearance
gene_of_interest <- "GeneX"

ggplot(metadata, aes(x = pah_clearance, y = expr_matrix[gene_of_interest, ])) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = paste("Expression of", gene_of_interest, "vs PAH clearance"))

# Include additional covariates like batch or condition
zlm_model <- zlm(~ pah_clearance + batch + condition, sca)


```

#7. Pseudotime Analysis
```{r pseudotime analysis}
## Make SO into SCE object for pseudotime analysis
sce_PT <- as.SingleCellExperiment(subset(so_kidney_sc, PT == "PT"), assay = "RNA")
rm(harm_data,meta_kidney_sc,meta_raw,so_kidney_sc)

# Totem clustering for trajectory analysis
gc()
sce_PT <- PrepareTotem(sce_PT)
sce_PT <- RunDimRed(object = sce_PT,
                    dim.red.method = "pca",
                    dim.red.features = row.names(m_top),
                    dim.reduction.par.list = list(ndim=5))

## where so@assays$RNA@counts is the normalized expression count
# gc()
# dim_red <- dimred_pca(t(subset(so, generaltype == "PT" & celltype != "PT_lowQuality")@assays$RNA@counts), ndim=2)
dim_red <- reducedDim(sce_PT, type = "pca")

sce_PT <- RunClustering(sce_PT,
                        k.range = 3:20,
                        min.cluster.size = 5,
                        N.clusterings=10000)
gc()
viz_cell <- VizCellConnectivity(sce_PT,viz.dim.red = dim_red)

pushover(message = "done w/ VizCellConnectivity")

sce_PT <- SelectClusterings(sce_PT,selection.method = 1,
                       selection.N.models = 10,
                       selection.stratified=FALSE,
                       prior.clustering = NULL)
VizMST(sce_PT,clustering.names = ReturnTrajNames(sce_PT),viz.dim.red = dim_red)
```
