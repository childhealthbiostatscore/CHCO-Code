---
title: "TODAY Somalogic follow-up analyses"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(SomaDataIO)
library(parallel)
library(lmerTest)
library(emmeans)
library(knitr)
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/Petter Bjornstad/TODAY subaward"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r cache=TRUE}
# Tim's code playground
# Import
load("./Somalogic data raw/soma.Rdata")
load("./Somalogic data raw/analytes.Rdata")
load("./Clinical data/comorb.Rdata")
# Merge soma and comorbidities
soma = left_join(soma,comorb,by = "releaseid")
# Filter unnecessary columns
soma = soma %>% arrange(releaseid,Date.Drawn) %>% group_by(releaseid) %>% 
  mutate(timepoint = row_number()) %>%
  select(releaseid,timepoint,Date.Drawn,MAC,MIC,HYP,RAPID,HTN,NEURO,RETINO,
         seq.10000.28:seq.9999.1) %>% ungroup()
# Skim
# skimr::skim(soma)
# Create matrices for limma
Y = soma %>% select(seq.10000.28:seq.9999.1) %>% t(.)
X = soma %>% select(releaseid,timepoint,MAC:RETINO)
X = data.frame(lapply(X,as.factor))
# Log transform proteins
Y = log(Y)
```

# Limma results

```{r eval=FALSE}
# Estimate the intra-participant correlation
design = model.matrix(~0+MAC*timepoint,data = X)
dupcor = duplicateCorrelation(Y,design,block=soma$releaseid)
# Fit the random effect model
fit = lmFit(Y,design)
fit = eBayes(fit)
limma_res = topTable(fit,number = nrow(Y),coef = 4)
```

# LMM results

```{r}
mod_fit = function(outcomes = rownames(Y),predictor,df = soma){
  # Parallel processing
  cl = makeCluster(detectCores()*0.5,type = "FORK")
  # Fit all the models, and pull out those with significant interaction term
  models = parLapply(cl,outcomes, function(p){
    # Formula and model fit
    f = as.formula(paste0("log(",p,")","~0+factor(",predictor,")*factor(timepoint)+(1|releaseid)"))
    mod = suppressMessages(lmer(f,data = df)) # Some singular fit warnings here, but okay to ignore per Laura
    # Calculate the difference in change over time between two groups
    contr = (c(0,0,0,1) - c(0,1,0,0)) - (c(0,0,1,0) - c(1,0,0,0))
    means_f = as.formula(paste0("~",predictor,"+timepoint"))
    emm.mod = emmeans(mod,specs = means_f,contr = list("Diff. in logFC" = contr))
    means = data.frame(emm.mod$emmeans)
    comp = data.frame(emm.mod$contrasts)
    return(comp)
  })
  # Combine the fold change comparisons
  results = data.frame(do.call(rbind,models))
  rownames(results) = outcomes
  results$contrast = NULL
  colnames(results)[1] = "Diff. in logFC"
  results$p.value.adj = p.adjust(results$p.value,method = "BH")
  results = results[order(results$p.value),]
  # Return
  return(results)
}
```

## MAC

```{r cache=TRUE}
mac_res = mod_fit(predictor = "MAC")
kable(mac_res[mac_res$p.value.adj <= 0.05,])
```
