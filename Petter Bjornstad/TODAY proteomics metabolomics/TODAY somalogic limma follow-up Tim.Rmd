---
title: "TODAY Somalogic follow-up analyses"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(SomaDataIO)
library(limma)
knitr::opts_chunk$set(echo = FALSE,warning = FALSE)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/Petter Bjornstad/TODAY subaward"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r cache=TRUE}
# Tim's code playground
# Import
load("./Somalogic data raw/soma.Rdata")
load("./Somalogic data raw/analytes.Rdata")
load("./Clinical data/comorb.Rdata")
# Merge soma and comorbidities
soma = left_join(soma,comorb,by = "releaseid")
# Filter unnecessary columns
soma = soma %>% arrange(releaseid,Date.Drawn) %>% group_by(releaseid) %>% 
  mutate(timepoint = row_number()) %>%
  select(releaseid,timepoint,Date.Drawn,MAC,MIC,HYP,RAPID,HTN,NEURO,RETINO,
         seq.10000.28:seq.9999.1) %>% ungroup()
# Skim
# skimr::skim(soma)
# Create matrices for limma
Y = soma %>% select(seq.10000.28:seq.9999.1) %>% t(.)
X = soma %>% select(releaseid,timepoint,MAC:RETINO)
X = data.frame(lapply(X,as.factor))
# Log transform proteins
Y = log(Y)
```

# Limma results

```{r}
# Estimate the intra-participant correlation
design = model.matrix(~0+MAC*timepoint,data = X)
dupcor = duplicateCorrelation(Y,design,block=soma$releaseid)
# Fit the random effect model
fit = lmFit(Y,design,block=soma$releaseid,correlation=dupcor$consensus.correlation)
fit = eBayes(fit)
```

# LMM results

```{r}
lmm = lapply(rownames(Y), function(p){
  f = as.formula(paste0(p,"~0+MAC*timepoint+(1|releaseid)"))
  mod = lmer(f,data = soma)
})
```
