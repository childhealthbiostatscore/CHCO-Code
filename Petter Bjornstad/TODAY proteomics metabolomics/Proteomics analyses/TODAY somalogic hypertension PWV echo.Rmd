---
title: "TODAY study - proteomics, hypertension, and OSA"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
library(SomaDataIO)
library(limma)
library(dplyr)
library(caret)
library(purrr)
library(multtest)
library(openxlsx)
library(tableone)
library(EnhancedVolcano)
library(knitr)
library(survival)
library(broom)
library(psych)
library(corrplot)
library(pander)
library(tableone)
library(polycor)
library(piercer)
library(RColorBrewer)
library(data.table)
library(gtools)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/Petter Bjornstad/TODAY subaward"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
} else if (Sys.info()["sysname"] == "Darwin"){
 home_dir = "/Volumes/Shared/Shared Projects/Laura/Peds Endo/Petter Bjornstad/TODAY subaward/"
 #home_dir = "/Users/pylell/Documents/Downtime/TODAY"
  }
knitr::opts_knit$set(root.dir = home_dir)

#source("/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad/Resources/YC/R Functions/correlation_function.R")

```

```{r, include=FALSE}
corr_plot_modified_nodict <- function(data, X, Y, cor_method = "pearson", adj_var = NULL, 
                               method = "color", insig = "pch", coef_col = NULL,
                               pch = 4, pch.col = "black", pch.cex = 0) {
  n_cols = length(Y)
  M <- cor(y = subset(data, select = Y),
           x = subset(data, select = X),
           use = "pairwise.complete.obs",
           method = cor_method)
  
  if (!is.na(adj_var)){
    x_vars <- rep(X, times = length(Y))
    x_coord <- rep(seq(1,length(Y)), each = length(X))
    y_vars <- rep(Y, each = length(X))
    y_coord <- rep(seq(length(X),1), times = length(Y))
    lm_extracted <- data.frame(yName = character(0),
                               xName = character(0),
                               x = numeric(0),
                               y = numeric(0),
                               adj_var = character(0),
                               adj_x_coef = numeric(0),
                               adj_x_pval = numeric(0))
    for (i in 1:length(x_vars)) {
      if(x_vars[i] != y_vars[i]) {
        lm_formula <- as.formula(paste0(y_vars[i], "~", x_vars[i], "+", adj_var))
        lm_model <- lm(lm_formula, data = data)
        lm_summary <- summary(lm_model)
        lm_coef <- lm_summary$coefficient[x_vars[i], "Estimate"]
        lm_p_val <- lm_summary$coefficient[x_vars[i], "Pr(>|t|)"]
        lm_extracted <- rbind(lm_extracted,
                              data.frame(
                                yName = y_vars[i],
                                xName = x_vars[i],
                                x = x_coord[i],
                                y = y_coord[i],
                                adj_var = adj_var,
                                adj_x_coef = lm_coef,
                                adj_x_pval = lm_p_val))
      }
    }
  }
  
  correlation_p_value <- correlation_p_value_matrix(data, relevant_vars = c(Y, X), n_cols = n_cols, cor_method = cor_method)
  
  corrplot(M,
           p.mat = correlation_p_value,
           method = method,
           tl.col = "black",
           tl.srt = 45,
           tl.cex = 1.2,
           insig = insig,
           addCoef.col = coef_col,
           addgrid.col = 'lightgray',
           number.digits = 2,
           pch.col = pch.col, 
           pch = pch,
           pch.cex = pch.cex)$corrPos -> p1
  p1_sub <- subset(p1, p.value <= 0.05)
  p1_sub2 <- subset(p1, p.value <= 0.05 & abs(corr) >= 0.7)
  
  if (nrow(p1) > 0) {
    graphics::text(p1$x, p1$y, sprintf("%.2f", p1$corr), adj = c(0.5, 0), cex=1.2)
    graphics::text(p1_sub$x, p1_sub$y, stars.pval(p1_sub$p.value), adj = c(0.5, 2), cex=1.2)
  }
  if (nrow(p1_sub2) > 0) {
    graphics::text(p1_sub2$x, p1_sub2$y, sprintf("%.2f", p1_sub2$corr), col = "white", adj = c(0.5, 0), cex=1.2)
    graphics::text(p1_sub2$x, p1_sub2$y, stars.pval(p1_sub2$p.value), col = "white", adj = c(0.5, 2), cex=1.2)
  }
  if (!is.na(adj_var)) {
    lm_extracted <- subset(lm_extracted, adj_x_pval <= 0.05)
    if (nrow(lm_extracted) > 0){
      graphics::rect(xleft = lm_extracted$x-.45, 
                     ybottom = lm_extracted$y-.45,
                     xright = lm_extracted$x+.45,
                     ytop = lm_extracted$y+.45)
    }
  }
}


correlation_p_value_matrix <- function(data, relevant_vars, n_cols, cor_method = "pearson") {
  # Filter relevant variables for the correlation matrix
  dat_correlation <- data %>%
    dplyr::select(all_of(relevant_vars))
  
  # Compute p-values 
  res2 <- Hmisc::rcorr(as.matrix(dat_correlation),
                       type = cor_method)
  corr_pval <- as.data.frame(res2$P) %>%
    dplyr::select(all_of(relevant_vars[1:n_cols]))
  corr_pval = corr_pval[(n_cols + 1):nrow(corr_pval),]
  return(as.matrix(corr_pval))
}
```

```{r, include=FALSE}
setwd(home_dir)
# load somalogic data, with QC samples already excluded
load("./Somalogic data raw/soma.Rdata")

# load analyte info
load("./Somalogic data raw/analytes.Rdata")

# load comorbidity data
load("./Clinical data/comorb.Rdata")

# load baseline risk factors
load("./Clinical data/TODAY/baserisk.Rdata")

# take only the baseline soma samples
# can we just take the earliest or is it possible someone would have a follow-up sample but not baseline?
# probably can take the first and then check the years to make sure compatible with TODAY
base <- soma %>% arrange(releaseid,Date.Drawn) %>% group_by(releaseid) %>% filter(row_number()==1)

# these 3 release IDs have first sample after end of recruitment, so they must be missing the baseline visit
base <- base %>% filter(!releaseid %in% c("65-85903","65-47984","65-25901"))

# merge in complication data
base <- merge(base, comorb, by="releaseid",all.x=T, all.y=F)

# merge in baseline risk factors
base <- merge(base, baserisk, by="releaseid",all.x=T, all.y=F)

# identify columns corresponding to proteins
#is_seq <- function(.x) grepl("^seq\\.[0-9]{4}", .x) # regex for analytes
is_seq <- function(.x) grepl("seq", .x)
seq <- is_seq(names(base))

# convert to numeric
base[,seq] <- apply(base[,seq],2,as.numeric)

# are there proteins with low variability?
#no_var = caret::nearZeroVar(base[,seq])
# none

# log transform
base_log <- base %>% modify_if(is_seq(names(.)), log)

# scale by SD
base_log_scale <- base_log
predictors <- colnames(base_log[seq])
for (i in 1:length(predictors)) {
  base_log_scale[predictors[i]] <- base_log_scale[predictors[i]]/sd(base_log[,paste0(predictors[i])])
}

# TODAY ECHO
today_echo <- read.csv("./Clinical data/TODAY/echo.csv")
today_echo$TIMEPOINT <- "1"
# TODAY2 ECHO
today2_echo <- read.csv("./Clinical data/TODAY2/echo.csv")
today2_echo$TIMEPOINT <- "2"
drop_cols <- c("DOPPLERQC","MMODEQC","OVERALLQC","PLAXQC","SAXQC","APICALQC","mmodeqc")
today2_echo <- today2_echo %>% select(-one_of(drop_cols))
# combine echo datasets - need to calculate deltas, but there are some variables that exist in timepoint 2 but not 1
echo <- bind_rows(today2_echo, today_echo)
echo$TIMEPOINT <- as.factor(echo$TIMEPOINT)
# make a wide dataset and calculate deltas
echonames <- colnames(echo)
echonames <- echonames[-1]
echonames <- echonames[-1]
echo_wide <- reshape(data=echo, direction="wide", idvar = "releaseid", timevar = "TIMEPOINT")
echo_wide$delta_days <- echo_wide$days.2 - echo_wide$days.1
echo_wide$delta_ascend2d <-  echo_wide$ascend2d.2 -  echo_wide$ascend2d.1   
echo_wide$delta_diasto2d <-   echo_wide$diasto2d.2 -  echo_wide$diasto2d.1 
echo_wide$delta_systol2d <-    echo_wide$systol2d.2 -  echo_wide$systol2d.1
echo_wide$delta_laarea2d <-    echo_wide$laarea2d.2 -  echo_wide$laarea2d.1
echo_wide$delta_diavol2d <-    echo_wide$diavol2d.2 -  echo_wide$diavol2d.1
echo_wide$delta_lvedv2d2ch <-  echo_wide$lvedv2d2ch.2 -  echo_wide$lvedv2d2ch.1
echo_wide$delta_lvef2d2ch  <-  echo_wide$lvef2d2ch.2 -  echo_wide$lvef2d2ch.1
echo_wide$delta_lvef2d4ch <-  echo_wide$lvef2d4ch.2 -  echo_wide$lvef2d4ch.1 
echo_wide$delta_lvesv2d2ch  <- echo_wide$lvesv2d2ch.2 -  echo_wide$lvesv2d2ch.1
echo_wide$delta_lvesv2d4ch   <- echo_wide$lvesv2d4ch.2 -  echo_wide$lvesv2d4ch.1
echo_wide$delta_lve    <-   echo_wide$lve.2 -  echo_wide$lve.1    
echo_wide$delta_lvem   <-   echo_wide$lvem.2 -  echo_wide$lvem.1    
echo_wide$delta_lvratio  <- echo_wide$lvratio.2 -  echo_wide$lvratio.1   
echo_wide$delta_lvsepe    <- echo_wide$lvsepe.2 -  echo_wide$lvsepe.1  
echo_wide$delta_lvsepem     <- echo_wide$lvsepem.2 -  echo_wide$lvsepem.1
echo_wide$delta_lvsepratio  <- echo_wide$lvsepratio.2 -  echo_wide$lvsepratio.1
echo_wide$delta_lvtrie   <- echo_wide$lvtrie.2 -  echo_wide$lvtrie.1   
echo_wide$delta_lvtriem    <-  echo_wide$lvtriem.2 -  echo_wide$lvtriem.1
echo_wide$delta_lvtriratio   <- echo_wide$lvtriratio.2 -  echo_wide$lvtriratio.1
echo_wide$delta_peakvelo   <- echo_wide$peakvelo.2 -  echo_wide$peakvelo.1
echo_wide$delta_rvsystol    <- echo_wide$rvsystol.2 -  echo_wide$rvsystol.1
echo_wide$delta_aortroot   <- echo_wide$aortroot.2 -  echo_wide$aortroot.1 
echo_wide$delta_ladimen     <- echo_wide$ladimen.2 -  echo_wide$ladimen.1
echo_wide$delta_mmodehr  <- echo_wide$mmodehr.2 -  echo_wide$mmodehr.1   
echo_wide$delta_ivsdias  <- echo_wide$ivsdias.2 -  echo_wide$ivsdias.1   
echo_wide$delta_ivssyst  <- echo_wide$ivssyst.2 -  echo_wide$ivssyst.1   
echo_wide$delta_lvindex  <- echo_wide$lvindex.2 -  echo_wide$lvindex.1   
echo_wide$delta_lvoutput  <- echo_wide$lvoutput.2 -  echo_wide$lvoutput.1  
echo_wide$delta_lveject  <-   echo_wide$lveject.2 -  echo_wide$lveject.1 
echo_wide$delta_diavolmm   <- echo_wide$diavolmm.2 -  echo_wide$diavolmm.1 
echo_wide$delta_sysvolmm   <- echo_wide$sysvolmm.2 -  echo_wide$sysvolmm.1
echo_wide$delta_pctshort   <-  echo_wide$pctshort.2 -  echo_wide$pctshort.1
echo_wide$delta_lvdiast    <-  echo_wide$lvdiast.2 -  echo_wide$lvdiast.1
echo_wide$delta_lvsystol  <- echo_wide$lvsystol.2 -  echo_wide$lvsystol.1  
echo_wide$delta_lvmass  <- echo_wide$lvmass.2 -  echo_wide$lvmass.1    
echo_wide$delta_walldias  <- echo_wide$walldias.2 -  echo_wide$walldias.1  
echo_wide$delta_wallsyst  <- echo_wide$wallsyst.2 -  echo_wide$wallsyst.1  
echo_wide$delta_lvstroke   <-  echo_wide$lvstroke.2 -  echo_wide$lvstroke.1
echo_wide$delta_tapse  <-  echo_wide$tapse.2 -  echo_wide$tapse.1
echo_wide$delta_walthick  <- echo_wide$walthick.2 -  echo_wide$walthick.1  
echo_wide$delta_lvmassht   <- echo_wide$lvmassht.2 -  echo_wide$lvmassht.1 
echo_wide$delta_ladiamht   <-  echo_wide$ladiamht.2 -  echo_wide$ladiamht.1
echo_wide$delta_lvdiasht   <- echo_wide$lvdiasht.2 -  echo_wide$lvdiasht.1 
echo_wide$delta_lvbsa  <- echo_wide$lvbsa.2 -  echo_wide$lvbsa.1

# TODAY2 PWV
pwv <- read.csv("./Clinical data/TODAY2/pwv.csv")
pwv$releaseid <- pwv$RELEASEID
pwv$RELEASEID <- NULL
# make a wide dataset and calculate deltas
pwvnames <- colnames(pwv)
pwvnames <- pwvnames[-1]
pwvnames <- pwvnames[-1]
pwv_wide <- reshape(data=pwv, direction="wide", idvar = "releaseid", timevar = "TIMEPOINT")
pwv_wide$delta_days <- pwv_wide$DAYS.PWV2 - pwv_wide$DAYS.PWV1
pwv_wide$delta_sdnn <- pwv_wide$SDNN.PWV2 - pwv_wide$SDNN.PWV1
pwv_wide$delta_pnn50 <- pwv_wide$PNN50.PWV2 - pwv_wide$PNN50.PWV1
pwv_wide$delta_rmssd <- pwv_wide$RMSSD.PWV2 - pwv_wide$RMSSD.PWV1
pwv_wide$delta_sdann <- pwv_wide$SDANN.PWV2 - pwv_wide$SDANN.PWV1
pwv_wide$delta_sdnn_index <- pwv_wide$SDNN_INDEX.PWV2 - pwv_wide$SDNN_INDEX.PWV1
pwv_wide$delta_lf_power_normalized <- pwv_wide$LF_POWER_NORMALISED.PWV2 - pwv_wide$LF_POWER_NORMALISED.PWV1
pwv_wide$delta_hf_power_normalized <- pwv_wide$HF_POWER_NORMALISED.PWV2 - pwv_wide$HF_POWER_NORMALISED.PWV1
pwv_wide$delta_lf_hf_ratio <- pwv_wide$LF_HF_RATIO.PWV2 - pwv_wide$LF_HF_RATIO.PWV1
pwv_wide$delta_pwvf <- pwv_wide$PWVF.PWV2 - pwv_wide$PWVF.PWV1
pwv_wide$delta_pwvr <- pwv_wide$PWVR.PWV2 - pwv_wide$PWVR.PWV1
pwv_wide$delta_pwvfft <- pwv_wide$PWVFFT.PWV2 - pwv_wide$PWVFFT.PWV1
pwv_wide$delta_pwvd <- pwv_wide$PWVD.PWV2 - pwv_wide$PWVD.PWV1
pwv_wide$delta_aix <- pwv_wide$AIX.PWV2 - pwv_wide$AIX.PWV1
pwv_wide$delta_c_sbp <- pwv_wide$C_SBP.PWV2 - pwv_wide$C_SBP.PWV1
pwv_wide$delta_c_dbp <- pwv_wide$C_DBP.PWV2 - pwv_wide$C_DBP.PWV1
pwv_wide$delta_brachd <- pwv_wide$BRACHD.PWV2 - pwv_wide$BRACHD.PWV1
pwv_wide$delta_map_pm <- pwv_wide$MAP_PM.PWV2 - pwv_wide$MAP_PM.PWV1
pwv_wide$delta_hr_pm <- pwv_wide$HR_PM.PWV2 - pwv_wide$HR_PM.PWV1
pwv_wide$delta_ci <- pwv_wide$CI.PWV2 - pwv_wide$CI.PWV1
pwv_wide$delta_lvdpdt <- pwv_wide$LVDPDT.PWV2 - pwv_wide$LVDPDT.PWV1
pwv_wide$delta_lv_ctx <- pwv_wide$LV_CTX.PWV2 - pwv_wide$LV_CTX.PWV1
pwv_wide$delta_svc <- pwv_wide$SVC.PWV2 - pwv_wide$SVC.PWV1
pwv_wide$delta_svr <- pwv_wide$SVR.PWV2 - pwv_wide$SVR.PWV1

# merge in the proteins (not scaled data)
analytes_keep <- analytes %>% filter(AptName %in% c("seq.13408.23","seq.19563.3","seq.7957.2","seq.2999.6","seq.18896.23","seq.5109.24",
                                                    "seq.9211.19","seq.18339.207","seq.18376.19","seq.18935.14","seq.24948.79","seq.4330.4"))
key <- analytes_keep[,c("AptName","UniProt","Target","TargetFullName")]
base_log_keep <- base_log %>% select(c("releaseid",all_of(analytes_keep$AptName)))
data.table::setnames(base_log_keep, as.character(analytes_keep$AptName), as.character(analytes_keep$Target), skip_absent = T)

# with echo data - TODAY
today_echo <- merge(base_log_keep,today_echo,by="releaseid",all.x = F, all.y = F)
# remove markers with >=80% missing 
today_echo <- today_echo %>% dplyr::select(where(~mean(is.na(.)) < 0.8))
# with echo data - TODAY2
today2_echo <- merge(base_log_keep,today2_echo,by="releaseid",all.x = F, all.y = F)
# remove markers with >=80% missing 
today2_echo <- today2_echo %>% dplyr::select(where(~mean(is.na(.)) < 0.8))

# with echo data - deltas
echo_deltas <- echo_wide %>% select(starts_with("delta"))
echo_deltas <- cbind(echo_wide$releaseid, echo_deltas)
echo_deltas <- echo_deltas %>% filter(!is.na(delta_days))
names(echo_deltas)[1] <- "releaseid"
echo_deltas <- echo_deltas %>% dplyr::select(where(~mean(is.na(.)) < 0.8))
echo_deltas <- merge(base_log_keep,echo_deltas,by="releaseid",all.x = F, all.y = F)

# with pwv data - time point 1
pwv_v1 <- pwv %>% filter(TIMEPOINT=="PWV1")
# remove markers with >=80% missing 
pwv_v1 <- pwv_v1 %>% dplyr::select(where(~mean(is.na(.)) < 0.8))
pwv_v1 <- merge(base_log_keep,pwv_v1,by="releaseid",all.x = F, all.y = F)

# with pwv data - time point 2
pwv_v2 <- pwv %>% filter(TIMEPOINT=="PWV2")
pwv_v2 <- pwv_v2 %>% dplyr::select(where(~mean(is.na(.)) < 0.8))
pwv_v2 <- merge(base_log_keep,pwv_v2,by="releaseid",all.x = F, all.y = F)

# with pwv data - deltas
pwv_deltas <- pwv_wide %>% select(starts_with("delta"))
pwv_deltas <- cbind(pwv_wide$releaseid, pwv_deltas)
pwv_deltas <- pwv_deltas %>% filter(!is.na(delta_days))
names(pwv_deltas)[1] <- "releaseid"
pwv_deltas <- pwv_deltas %>% dplyr::select(where(~mean(is.na(.)) < 0.8))
pwv_deltas <- merge(base_log_keep,pwv_deltas,by="releaseid",all.x = F, all.y = F)

label(today_echo$ascend2d) = "2D aorta ascending"
```

# Results

## Key to protein names

```{r, include=TRUE}
kable(key)
```

## Echocardiogram

### Summary statistics - TODAY

```{r, include=FALSE}
echonames <- colnames(today_echo)
echonames <- echonames[-1]
echonames <- echonames[13:length(echonames)]
t <- CreateTableOne(vars=echonames,data=today_echo)
t <- print(t, nonnormal = echonames, missing=T)
```

```{r, include=TRUE, comment=""}
kable(t)
```

### Summary statistics - TODAY2

```{r, include=FALSE}
echonames <- colnames(today2_echo)
echonames <- echonames[-1]
echonames <- echonames[13:length(echonames)]
t <- CreateTableOne(vars=echonames,data=today2_echo)
t <- print(t, nonnormal = echonames, missing=T)
```

```{r, include=TRUE, comment=""}
kable(t)
```

### Correlation between TODAY echo and baseline proteins

```{r, include=TRUE}
 # Correlations
today_echo_corr <- today_echo %>% select(-c(releaseid, days, TIMEPOINT))
today_echo_corr <- today_echo_corr %>% select("WFKN2","PSB3","Myosin light chain 1","H6ST3","TLR5","SEZ6L","PSPC1","LSAMP","PSA","Nr-CAM","SCG3","PEDF",
                                              "ascend2d","diasto2d","systol2d","laarea2d","diavol2d","lve","lvem","lvratio","diavolmm","sysvolmm",
                                              "lvdiast","lvsystol","lvmass","lvmass","lvstroke","lvmassht","lvbsa","lveject","pctshort","lvindex","lvoutput",
                                               "wallsyst","walldias","lvdiasht","peakvelo","rvsystol","aortroot","ladimen","mmodehr","ivsdias","ivssyst",
                                                "walthick","ladiamht","tapse")
today_echo_corr <- today_echo_corr %>% dplyr::rename("Ascending aorta dimensions" = ascend2d,
                                                      "Left ventricular (LV) diastolic dimensions" = diasto2d,
                                                      "Left ventricular systolic dimensions" = systol2d,
                                                      "Left atrial area" = laarea2d,
                                                      "Diastolic volume" = diavol2d,
                                                      "Left ventricular endocardium" = lve,
                                                      "Left ventricular endomyocardial" = lvem,
                                                      "Ratio of LV dimensions or volumes" = lvratio,
                                                      "Diastolic volume in millimeters" = diavolmm,
                                                      "Systolic volume in millimeters" = sysvolmm,
                                                      "Left ventricular diastolic dimension" = lvdiast,
                                                      "Left ventricular systolic dimension" = lvsystol,
                                                      "Left ventricular mass" = lvmass,
                                                      "Left ventricular stroke volume" = lvstroke,
                                                      "Left ventricular mass/height" = lvmassht,
                                                      "Left ventricular size/body surface area" = lvbsa,
                                                      "Left ventricular ejection fraction" = lveject,
                                                      "Percent shortening" = pctshort,
                                                      "Left ventricular mass index" = lvindex,
                                                      "Left ventricular cardiac output" = lvoutput,
                                                      "Left ventricular wall motion during systole" = wallsyst,
                                                      "Left ventricular wall motion during diastole" = walldias,
                                                      "Left ventricular diastolic dimension at end of diastole indexed to height" = lvdiasht,
                                                      "Peak velocity of blood flow" = peakvelo,
                                                      "Right ventricular systolic pressure" = rvsystol,
                                                      "Aortic root dimensions" = aortroot,
                                                      "Left atrial dimensions" = ladimen,
                                                      "M-mode heart rate" = mmodehr,
                                                      "Interventricular septal thickness in diastole" = ivsdias,
                                                      "Interventricular septal thickness in systole" = ivssyst,
                                                      "Wall thickness" = walthick,
                                                      "Left atrial diameter indexed to height" = ladiamht,
                                                      "Tricuspid annular plane systolic excursion" = tapse)
  M <- corr.test(data.matrix(today_echo_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")

png(height = 3000, width = 2500, file = "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad/TODAY proteomics metabolomics/Proteomics analyses/today_echo_corr1.png", res = 170)
corr_plot_modified_nodict(data=today_echo_corr, 
                   Y=c("WFKN2","PSB3","Myosin light chain 1","H6ST3","TLR5","SEZ6L","PSPC1","LSAMP","PSA","Nr-CAM","SCG3","PEDF"), 
                 X=c("Ascending aorta dimensions","Left ventricular (LV) diastolic dimensions", "Left ventricular systolic dimensions",
                                                      "Left atrial area" ,
                                                      "Diastolic volume" ,
                                                      "Left ventricular endocardium" ,
                                                      "Left ventricular endomyocardial" ,
                                                      "Ratio of LV dimensions or volumes" ,
                                                      "Diastolic volume in millimeters" ,
                                                      "Systolic volume in millimeters" ,
                                                      "Left ventricular diastolic dimension" ,
                                                      "Left ventricular systolic dimension" ,
                                                      "Left ventricular mass" ,
                                                      "Left ventricular stroke volume" ,
                                                      "Left ventricular mass/height" ,
                                                      "Left ventricular size/body surface area" ,
                                                      "Left ventricular ejection fraction" ,
                                                      "Percent shortening" ,
                                                      "Left ventricular mass index" ,
                                                      "Left ventricular cardiac output" ,
                                                      "Left ventricular wall motion during systole" ,
                                                      "Left ventricular wall motion during diastole" ,
                                                      "Left ventricular diastolic dimension at end of diastole indexed to height"),
                 cor_method="spearman", adj_var = NA)
dev.off()



png(height = 3000, width = 2500, file = "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad/TODAY proteomics metabolomics/Proteomics analyses/today_echo_corr2.png", res = 170)
corr_plot_modified_nodict(data=today_echo_corr, 
                   Y=c("WFKN2","PSB3","Myosin light chain 1","H6ST3","TLR5","SEZ6L","PSPC1","LSAMP","PSA","Nr-CAM","SCG3","PEDF"), 
                 X=c("Peak velocity of blood flow" ,
                                                      "Right ventricular systolic pressure" ,
                                                      "Aortic root dimensions" ,
                                                      "Left atrial dimensions" ,
                                                      "M-mode heart rate" ,
                                                      "Interventricular septal thickness in diastole" ,
                                                      "Interventricular septal thickness in systole" ,
                                                      "Wall thickness" ,
                                                      "Left atrial diameter indexed to height" ,
                                                      "Tricuspid annular plane systolic excursion"),
                 cor_method="spearman", adj_var = NA)
dev.off()


```

### Correlation between TODAY2 echo and baseline proteins

```{r, include=TRUE}
 # Correlations
today2_echo_corr <- today2_echo %>% select(-c(releaseid, days, TIMEPOINT))
  M <- corr.test(data.matrix(today2_echo_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")
```

### Correlation between change in echo and baseline proteins

```{r, include=TRUE}
 # Correlations
echo_deltas_corr <- echo_deltas %>% select(-c(releaseid))
  M <- corr.test(data.matrix(echo_deltas_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")
```

## PWV

### Summary statistics 

```{r, include=FALSE}
pwvnames <- colnames(pwv)
pwvnames <- pwvnames[!(pwvnames %in% c("releaseid","TIMEPOINT"))]
t <- CreateTableOne(vars=pwvnames,data=pwv,strata = "TIMEPOINT")
t <- print(t, nonnormal = pwvnames, missing=T)
```

```{r, include=TRUE, comment=""}
kable(t)
```

### Correlation between PWV time 1 and baseline proteins

```{r, include=TRUE}
 # Correlations
pwv_v1_corr <- pwv_v1 %>% select(-c(releaseid,TIMEPOINT))
  M <- corr.test(data.matrix(pwv_v1_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")
```

### Correlation between PWV time 2 and baseline proteins

```{r, include=TRUE}
 # Correlations
pwv_v2_corr <- pwv_v2 %>% select(-c(releaseid,TIMEPOINT))
  M <- corr.test(data.matrix(pwv_v2_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")
```

### Correlation between change in PWV and baseline proteins

```{r, include=TRUE}
 # Correlations
pwv_deltas_corr <- pwv_deltas %>% select(-c(releaseid))
  M <- corr.test(data.matrix(pwv_deltas_corr), normal = F, method = "spearman")
  r <- data.frame(round(M$r, 3))
#  r <- r %>% filter(rownames(r)=="CENTRAL_AHI")
#  r <- r %>% select(-releaseid)
#  p <- data.frame(round(M$p, 3))
#  p <- p %>% filter(rownames(p)=="CENTRAL_AHI")
#  p <- p %>% select(-releaseid)
  emphasize.strong.cells(which(M$p <= 0.05, arr.ind = TRUE))
  cat("\n")
  pander(r, caption = "Coefficients")
  cat("\n")
```
