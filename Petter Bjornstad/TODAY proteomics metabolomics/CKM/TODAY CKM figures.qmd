---
title: "CKM in the TODAY study"
author: "Laura Pyle"
date: "`r lubridate::today()`"
format:
  revealjs:
    embed-resources: true
    scrollable: true
    transition: fade
    transition-speed: slow
    controls-layout: bottom-right
    menu: true
    toc: true
    toc-depth: 1
    fontsize: 20
---

```{r include = F}
library(jsonlite)
library(dplyr)
library(knitr)
library(readxl)
library(ggplot2)
library(ggrepel)

# specify user for paths
user <- Sys.info()[["user"]]
if (user == "laurapyle") {
  data_path <- "/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward"
  github_path <- "/Users/laurapyle/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else if (user == "lpyle") {
  data_path <- "/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward"
  github_path <- "/Users/lpyle/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r include = F}
scaleFUN <- function(x) sprintf("%.2f", x)

# Volcano plot
volcano <- function(data, lab = "Target", xcol = "estimate", ycol = "p.value", zcol = "adj.p.value",
                    top = 11, 
                    xlimit = c(-1, 1), ylimit = c(0, -log10(10e-7)),
                    xlabel = "HR", pCutoff = 0.05, overlaps = 50,
                    log_t = F) {
  data <- as.data.frame(data)
  t <- data[data[, zcol] <= pCutoff, ]
  if (log_t) {
    t <- t[order(abs(log(t[, ycol])), decreasing = F), ]
  } else {
    t <- t[order(abs(t[, ycol]), decreasing = F), ]
  }
  data$top <- data[, "AptName"] %in% t[1:top, "AptName"]
  #data$top <- data[, "AptName"] %in% t[t$Target %in% top, "AptName"]
  data$logp <- -log10(data[, ycol])
  data$fc <- data[, xcol]
  data$sig <- data[, ycol] <= pCutoff
  p <- ggplot(data = data, aes(x = fc, y = logp, color = sig)) +
    geom_hline(yintercept = -log10(pCutoff), linetype = "dashed") +
    geom_point(size = 2.5) +
    geom_label_repel(
      data = data[data$top, ], aes(label = Target), color = "black",
      max.overlaps = overlaps
    ) +
    scale_color_manual(values = c("grey", "#3e6dbf")) +
    xlab(xlabel) + scale_x_continuous(labels = scaleFUN) +
    ylab(bquote(~ -Log[10] ~ italic(P))) +
    theme_bw() +
    theme(legend.position = "none")
  return(p)
}
```

```{r include = F}
setwd(data_path)

# Read in proteomics results file
filename <- "/CKM/Results/TODAY CKM Cox models scaled baseline unadjusted.xlsx"
full_path <- file.path(data_path, filename)
ckm_proteins <- read_xlsx(full_path, sheet = "Time to CKM Proteins")
ckm_clinical <- read_xlsx(full_path, sheet = "Time to CKM Clinical")

# Read in delta results file
filename <- "CKM/Results/TODAY change in proteins CKM progression.xlsx"
full_path <- file.path(data_path, filename)
ckm_proteins_delta <- read_xlsx(full_path, sheet = "Protein delta CKM prog")
```

# Cox models of baseline proteins vs. time to first progression of CKM

Protein HECA2:CD is significant after FDR adjustment and is labeled on the volcano plot. Nominally significant proteins are colored in blue.

```{r include = F}
v <- volcano(ckm_proteins, log_t = T)
filename <- "CKM/Results/Figures/CKM_protein_volcano.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano.jpg){width=50%}


# Linear models of change in proteins in participants with CKM progression vs. those with no progression

```{r include = F}
v <- volcano(ckm_proteins_delta, xcol = "logFC", ycol = "P.Value", zcol = "adj.P.Val", log_t = F)
filename <- "CKM/Results/Figures/CKM_protein_volcano_delta.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano_delta.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano_delta.jpg){width=50%}