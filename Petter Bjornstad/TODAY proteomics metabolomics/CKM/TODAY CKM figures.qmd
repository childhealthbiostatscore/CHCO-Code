---
title: "CKM in the TODAY study"
author: "Laura Pyle"
date: "`r lubridate::today()`"
format:
  revealjs:
    embed-resources: true
    scrollable: true
    transition: fade
    transition-speed: slow
    controls-layout: bottom-right
    menu: true
    toc: true
    toc-depth: 1
    fontsize: 20
---

```{r include = F}
library(jsonlite)
library(dplyr)
library(knitr)
library(readxl)
library(ggplot2)
library(ggrepel)

# specify user for paths
user <- Sys.info()[["user"]]
if (user == "laurapyle") {
  data_path <- "/Users/laurapyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward"
  github_path <- "/Users/laurapyle/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else if (user == "lpyle") {
  data_path <- "/Users/lpyle/Library/CloudStorage/OneDrive-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward"
  github_path <- "/Users/lpyle/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else if (user == "pylell") {
  data_path <- "/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward"
  github_path <- "/Users/pylell/Documents/GitHub/CHCO-Code/Petter Bjornstad"
} else {
  stop("Unknown user: please specify root path for this user.")
}
```

```{r include = F}
scaleFUN <- function(x) sprintf("%.2f", x)

# Volcano plot
volcano_old <- function(data, lab = "Target", xcol = "estimate", ycol = "p.value", zcol = "p.value",
                    top = 30, 
                    xlimit = c(-1, 1), ylimit = c(0, -log10(10e-7)),
                    xlabel = "HR", pCutoff = 0.05, overlaps = 30,
                    log_t = F) {
  data <- as.data.frame(data)
  t <- data[data[, zcol] <= pCutoff, ]
  if (log_t) {
    t <- t[order(abs(log(t[, zcol])), decreasing = T), ]
  } else {
    t <- t[order(abs(t[, zcol]), decreasing = T), ]
  }
  data$top <- data[, "AptName"] %in% t[1:top, "AptName"]
  #data$top <- data[, "AptName"] %in% t[t$Target %in% top, "AptName"]
  data$logp <- -log10(data[, ycol])
  data$fc <- data[, xcol]
  data$sig <- data[, ycol] <= pCutoff
  p <- ggplot(data = data, aes(x = fc, y = logp, color = sig)) +
    geom_hline(yintercept = -log10(pCutoff), linetype = "dashed") +
    geom_point(size = 2.5) +
    geom_label_repel(
      data = data[data$top, ], aes(label = Target), color = "black",
      max.overlaps = overlaps
    ) +
    scale_color_manual(values = c("grey", "#3e6dbf")) +
    xlab(xlabel) + scale_x_continuous(labels = scaleFUN) +
    ylab(bquote(~ -Log[10] ~ italic(P))) +
    theme_bw() +
    theme(legend.position = "none")
  return(p)
}

volcano <- function(data, lab = "Target", xcol = "estimate", ycol = "p.value", zcol = "adj.p.value",
                    top = 30, 
                    xlimit = c(-1, 1), ylimit = c(0, -log10(10e-7)),
                    xlabel = "HR", pCutoff = 0.05, overlaps = 35,
                    log_t = F) {
  data <- as.data.frame(data)
  t <- data[data[, ycol] <= pCutoff, ]
  if (log_t) {
    t <- t[order(abs(log(t[, ycol])), decreasing = T), ]
  } else {
    t <- t[order(abs(t[, ycol]), decreasing = T), ]
  }
  data$top <- data[, "AptName"] %in% t[1:top, "AptName"]
  #data$top <- data[, "AptName"] %in% t[t$Target %in% top, "AptName"]
  data$logp <- -log10(data[, ycol])
  data$fc <- data[, xcol]
  data <- data %>% mutate(sig = case_when(
    data[, ycol] >= pCutoff ~ 0,
    (data[, ycol] < pCutoff) & (data[, zcol] >= pCutoff) ~ 1, 
    TRUE ~ 2
  ))
  data$sig <- as.factor(data$sig)
  p <- ggplot(data = data, aes(x = fc, y = logp, color = sig)) +
    geom_hline(yintercept = -log10(pCutoff), linetype = "dashed") +
    geom_point(size = 2.5) +
    geom_label_repel(
      data = data[data$top, ], aes(label = Target), color = "black",
      max.overlaps = overlaps
    ) +
    scale_color_manual(values = c("grey", "#3e6dbf", "coral2")) +
    xlab(xlabel) + scale_x_continuous(labels = scaleFUN) +
    ylab(bquote(~ -Log[10] ~ italic(P))) +
    theme_bw() +
    theme(legend.position = "none")
  return(p)
}
```

```{r include = F}
setwd(data_path)

# Read in proteomics results file
filename <- "/CKM/Results/TODAY CKM Cox models scaled baseline unadjusted.xlsx"
full_path <- file.path(data_path, filename)
ckm_proteins <- read_xlsx(full_path, sheet = "Proteins all stages")
ckm_proteins_3 <- read_xlsx(full_path, sheet = "Proteins CKM 3")
ckm_proteins_4 <- read_xlsx(full_path, sheet = "Proteins CKM 4")
ckm_clinical <- read_xlsx(full_path, sheet = "Clinical all stages")

# Read in delta results file
filename <- "CKM/Results/TODAY change in proteins CKM progression.xlsx"
full_path <- file.path(data_path, filename)
ckm_proteins_delta <- read_xlsx(full_path, sheet = "DiD proteins vs CKM progression")
```

# Transitions between CKM stages

![](CKM_sankey.jpg){width=50%}

# Cox models of baseline proteins vs. time to first progression of CKM (all stages)

Proteins significant at 5% FDR are colored in coral. Nominally significant proteins are colored in blue. Top 30 proteins by p-value are labeled.

```{r include = F}
v <- volcano(ckm_proteins, log_t = T)
filename <- "CKM/Results/Figures/CKM_protein_volcano.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano.jpg){width=50%}

# Cox models of baseline proteins vs. time to first progression of CKM (maximum stage = 3)

Proteins significant at 5% FDR are colored in coral. Nominally significant proteins are colored in blue. Top 30 proteins by p-value are labeled.

```{r include = F}
v <- volcano(ckm_proteins_3, log_t = T)
filename <- "CKM/Results/Figures/CKM_protein_volcano_3.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano_3.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano_3.jpg){width=50%}

# Cox models of baseline proteins vs. time to first progression of CKM (maximum stage = 4)

Proteins significant at 5% FDR are colored in coral. Nominally significant proteins are colored in blue. Top 30 proteins by p-value are labeled.

```{r include = F}
v <- volcano(ckm_proteins_4, log_t = T)
filename <- "CKM/Results/Figures/CKM_protein_volcano_4.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano_4.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano_4.jpg){width=50%}

# FGSEA

## Time to any progression (KEGG)

![](plasma_SOMA_KEGG.png){width=50%}


## Time to any progression (Reactome)

![](plasma_SOMA_REACTOME.png){width=50%}


## Time to any progression (GO)

![](plasma_SOMA_GO.png){width=50%}


## Time to any progression (Hallmark)

![](plasma_SOMA_Hallmark.png){width=50%}


## Time to progression in those who reached stage 3 (KEGG)

![](plasma_SOMA_KEGG_stage3.png){width=50%}


## Time to progression in those who reached stage 3 (Reactome)

![](plasma_SOMA_REACTOME_stage3.png){width=50%}


## Time to progression in those who reached stage 3 (GO)

![](plasma_SOMA_KEGG_stage3.png){width=50%}


## Time to progression in those who reached stage 3 (Hallmark)

![](plasma_SOMA_Hallmark_stage3.png){width=50%}


## Time to progression in those who reached stage 4 (KEGG)

![](plasma_SOMA_KEGG_stage4.png){width=50%}


## Time to progression in those who reached stage 4 (Reactome)

![](plasma_SOMA_REACTOME_stage4.png){width=50%}

## Time to progression in those who reached stage 4 (GO)

![](plasma_SOMA_GO_stage4.png){width=50%}

## Time to progression in those who reached stage 4 (Hallmark)

![](plasma_SOMA_Hallmark_stage4.png){width=50%}

# Mixed-effects models of change in proteins in participants with CKM progression vs. those with no progression

Proteins significant at 5% FDR are colored in coral. Nominally significant proteins are colored in blue. Top 30 proteins by p-value are labeled.

```{r include = F}
v <- volcano(ckm_proteins_delta, xcol = "logFC", ycol = "P.Value", zcol = "P.Value", log_t = T, xlabel = "logFC")
filename <- "CKM/Results/Figures/CKM_protein_volcano_delta.jpg"
full_path <- file.path(data_path, filename)
ggsave(
  filename = 'CKM_protein_volcano_delta.jpg', plot = v,
  width = 1600, height = 900, units = "px", scale = 2
)
```

![](CKM_protein_volcano_delta.jpg){width=50%}

# Model concordance, time to first progression, any maximum stage

![](forest_plot_elastic_net_concordance_any_max_stage.png){width=50%}

# Model concordance, time to first progression, maximum stage 3

![](forest_plot_elastic_net_concordance_stage3.png){width=50%}
# Model concordance, time to first progression, maximum stage 4

![](forest_plot_elastic_net_concordance_stage4.png){width=50%}