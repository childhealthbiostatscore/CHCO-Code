---
title: "CKM in TODAY"
author: "Laura Pyle"
format: html
editor: visual
---

```{r}
library(dplyr)
library(arsenal)
```

```{r}
# read in COMORB adjudicated endpoints
comorb <- read.csv("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward/Clinical data/COMORB.csv")
# get fup time from visit dates - the problem is that these are not granular enough 
load("/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward/Clinical data/TODAY/clinical_data_long.Rdata")

# in comorb, figure out length of follow-up by choosing number of days for an event the participant did not have
comorb$fup_time <- ifelse(comorb$HTN == 0, comorb$DAYSTOHTN, 
                          ifelse(comorb$LDLDLP == 0, comorb$DAYSTOLDL,
                                 ifelse(comorb$NEURO == 0, comorb$DAYSTONEURO, 
                                        ifelse(comorb$DNE == 0, comorb$DAYSTODNE, 
                                               ifelse(comorb$FILAM == 0, comorb$DAYSTOFILAM, 
                                                     ifelse(comorb$RETINO == 0, comorb$DAYSTORETINO, 
                                                            ifelse(comorb$TGDLP == 0, comorb$DAYSTOTG, 
                                                                   ifelse(comorb$NEPHRO == 0, comorb$DAYSTONEPHRO, 
                                                                          ifelse(comorb$HYP ==0, comorb$DAYSTOHYP, NA)))))))))
# one person () has every outcome, so fup_time is missing
comorb$fup_time <- ifelse(comorb$RELEASEID == "65-44824", 4425, comorb$fup_time)

# read in adjudicated medical event dataset
ame <- read.csv('/Users/pylell/Library/CloudStorage/OneDrive-SharedLibraries-UW/Bjornstad/Biostatistics Core Shared Drive/TODAY subaward/Clinical data/TODAY2/AME.csv')

# reformat ame database so it's in the same format as COMORB (i.e., variable for event at baseline, variable for event during followup, and days to event)
# note that some people have multiple events of the same type (e.g., CAD) - for now, will retain all the events to allow the most flexibility later, but for most analyses, may need to use the first (to be parallel with COMORB)
# create new dataset ame_summary with one row per event
arrhythmia <- ame %>% filter(AMENAME == 1) %>% select(releaseid, DAYSTOAME)
colnames(arrhythmia) <- c("RELEASEID", "DAYSTOARRHYTHMIA")
arrhythmia$ARRHYTHMIA <- 1
cad <- ame %>% filter(AMENAME == 2) %>% select(releaseid, DAYSTOAME)
colnames(cad) <- c("RELEASEID", "DAYSTOCAD")
cad$CAD <- 1
chf <- ame %>% filter(AMENAME == 3) %>% select(releaseid, DAYSTOAME)
colnames(chf) <- c("RELEASEID", "DAYSTOCHF")
chf$CHF <- 1
lvsd <- ame %>% filter(AMENAME == 4) %>% select(releaseid, DAYSTOAME)
colnames(lvsd) <- c("RELEASEID", "DAYSTOLVSD")
lvsd$lvsd <- 1
mi <- ame %>% filter(AMENAME == 5) %>% select(releaseid, DAYSTOAME)
colnames(mi) <- c("RELEASEID", "DAYSTOMI")
mi$MI <- 1
pad <- ame %>% filter(AMENAME == 6) %>% select(releaseid, DAYSTOAME)
colnames(pad) <- c("RELEASEID", "DAYSTOPAD")
pad$PAD <- 1
#rad <- ame %>% filter(AMENAME == 7) %>% select(releaseid, DAYSTOAME)
#colnames(rad) <- c("RELEASEID", "DAYSTORAD")
#rad$RAD <- 1
dvt <- ame %>% filter(AMENAME == 8) %>% select(releaseid, DAYSTOAME)
colnames(dvt) <- c("RELEASEID", "DAYSTODVT")
dvt$DVT <- 1
stroke <- ame %>% filter(AMENAME == 9) %>% select(releaseid, DAYSTOAME)
colnames(stroke) <- c("RELEASEID", "DAYSTOSTROKE")
stroke$STROKE <- 1
#cerebrovascular <- ame %>% filter(AMENAME == 10) %>% select(releaseid, DAYSTOAME)
#colnames(cerebrovascular) <- c("RELEASEID", "DAYSTOCEREBROVASCULAR")
#cerebrovascular$CEREBROVASCULAR <- 1
tia <- ame %>% filter(AMENAME == 11) %>% select(releaseid, DAYSTOAME)
colnames(tia) <- c("RELEASEID", "DAYSTOTIA")
tia$TIA <- 1
pancreatitis <- ame %>% filter(AMENAME == 12) %>% select(releaseid, DAYSTOAME)
colnames(pancreatitis) <- c("RELEASEID", "DAYSTOPANCREATITIS")
pancreatitis$PANCREATITIS <- 1
gallbladder <- ame %>% filter(AMENAME == 13) %>% select(releaseid, DAYSTOAME)
colnames(gallbladder) <- c("RELEASEID", "DAYSTOGALLBLADDER")
gallbladder$GALLBLADDER <- 1
pneuro <- ame %>% filter(AMENAME == 14) %>% select(releaseid, DAYSTOAME)
colnames(pneuro) <- c("RELEASEID", "DAYSTOPNEURO")
pneuro$PNEURO <- 1
aneuro <- ame %>% filter(AMENAME == 15) %>% select(releaseid, DAYSTOAME)
colnames(aneuro) <- c("RELEASEID", "DAYSTOANEURO")
aneuro$ANEURO <- 1
mononeuro <- ame %>% filter(AMENAME == 16) %>% select(releaseid, DAYSTOAME)
colnames(mononeuro) <- c("RELEASEID", "DAYSTOMONONEURO")
mononeuro$MONONEURO <- 1
ckd <- ame %>% filter(AMENAME == 17) %>% select(releaseid, DAYSTOAME)
colnames(ckd) <- c("RELEASEID", "DAYSTOCKD")
ckd$CKD <- 1
eskd <- ame %>% filter(AMENAME == 18) %>% select(releaseid, DAYSTOAME)
colnames(eskd) <- c("RELEASEID", "DAYSTOESKD")
eskd$ESKD <- 1
npdr <- ame %>% filter(AMENAME == 19) %>% select(releaseid, DAYSTOAME)
colnames(npdr) <- c("RELEASEID", "DAYSTONPDR")
npdr$NPDR <- 1
pdr <- ame %>% filter(AMENAME == 20) %>% select(releaseid, DAYSTOAME)
colnames(pdr) <- c("RELEASEID", "DAYSTOPDR")
pdr$PDR <- 1
me <- ame %>% filter(AMENAME == 21) %>% select(releaseid, DAYSTOAME)
colnames(me) <- c("RELEASEID", "DAYSTOME")
me$ME <- 1
vh <- ame %>% filter(AMENAME == 22) %>% select(releaseid, DAYSTOAME)
colnames(vh) <- c("RELEASEID", "DAYSTOVH")
vh$VH <- 1
blindness <- ame %>% filter(AMENAME == 23) %>% select(releaseid, DAYSTOAME)
colnames(blindness) <- c("RELEASEID", "DAYSTOBLINDNESS")
blindness$BLINDNESS <- 1
cataracts <- ame %>% filter(AMENAME == 24) %>% select(releaseid, DAYSTOAME)
colnames(cataracts) <- c("RELEASEID", "DAYSTOCATARACTS")
cataracts$CATARACTS <- 1
glaucoma <- ame %>% filter(AMENAME == 25) %>% select(releaseid, DAYSTOAME)
colnames(glaucoma) <- c("RELEASEID", "DAYSTOGLAUCOMA")
glaucoma$GLAUCOMA <- 1
death <- ame %>% filter(AMENAME == 26) %>% select(releaseid, DAYSTOAME)
colnames(death) <- c("RELEASEID", "DAYSTODEATH")
death$DEATH <- 1

ame_summary <- full_join(arrhythmia, cad, by = "RELEASEID")
ame_summary <- full_join(ame_summary, chf, by = "RELEASEID")
ame_summary <- full_join(ame_summary, lvsd, by = "RELEASEID")
ame_summary <- full_join(ame_summary, mi, by = "RELEASEID")
ame_summary <- full_join(ame_summary, pad, by = "RELEASEID")
#ame_summary <- full_join(ame_summary, rad, by = "RELEASEID")
ame_summary <- full_join(ame_summary, dvt, by = "RELEASEID")
ame_summary <- full_join(ame_summary, stroke, by = "RELEASEID")
#ame_summary <- full_join(ame_summary, cerebrovascular, by = "RELEASEID")
ame_summary <- full_join(ame_summary, tia, by = "RELEASEID")
ame_summary <- full_join(ame_summary, pancreatitis, by = "RELEASEID")
ame_summary <- full_join(ame_summary, gallbladder, by = "RELEASEID")
ame_summary <- full_join(ame_summary, pneuro, by = "RELEASEID")
ame_summary <- full_join(ame_summary, aneuro, by = "RELEASEID")
ame_summary <- full_join(ame_summary, mononeuro, by = "RELEASEID")
ame_summary <- full_join(ame_summary, ckd, by = "RELEASEID")
ame_summary <- full_join(ame_summary, eskd, by = "RELEASEID")
ame_summary <- full_join(ame_summary, npdr, by = "RELEASEID")
ame_summary <- full_join(ame_summary, pdr, by = "RELEASEID")
ame_summary <- full_join(ame_summary, me, by = "RELEASEID")
ame_summary <- full_join(ame_summary, vh, by = "RELEASEID")
ame_summary <- full_join(ame_summary, blindness, by = "RELEASEID")
ame_summary <- full_join(ame_summary, cataracts, by = "RELEASEID")
ame_summary <- full_join(ame_summary, glaucoma, by = "RELEASEID")
ame_summary <- full_join(ame_summary, death, by = "RELEASEID")

# not the right format...if there is more than one row per person, merge gets messed up
# maybe leave AME dataset as the one with multiple events and just create a dataframe
# with time to first?

ame$AMENAME <- factor(ame$AMENAME, labels = c("Arrhythmia", "Coronary artery disease", "Coronary heart failure", "Left ventricular systolic dysfunction", "Myocardial infarction", "PAD/vascular insufficiency", "Deep vein thrombosis", "Stroke", "TIA", "Pancreatitis", "Gallbladder disease", "Peripheral diabetic neuropathy", "Autonomic neuropathy", "Diabetic mononeuropathy", "Chronic kidney disease", "ESKD", "Non-proliferative DR", "Proliferative DR", "Macular edema", "Vitreous hemorrhage", "Blindness due to diabetes", "Cataracts", "Glaucoma", "Death"))

```

```         
```

## Background

This is the background.

## Results

Count of events (can be multiple events per person)

```{r}
event_table <- tableby(data = ame, ~ as.factor(AMENAME))
```
