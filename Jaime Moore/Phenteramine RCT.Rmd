---
title: "Moore - Phenteramine vs. Placebo"
author: "Laura Pyle"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(tableone)
library(stringr)
library(growthcleanr)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

# Questions


# Methods

- Lab data for table 1 were taken from the Screening/Enrollment Visit, not Visit 1, as all data were missing at Visit 1.
- Some participants had more than one CESD administered at Visit 1. The most recent CESD was used.

```{r, include=FALSE}
# Demographics data
demo <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPDemographics_DATA_LABELS_2024-02-05_1920.csv")
demo <- demo %>% filter(!(Record.ID %in% c("Jacky Test","Jacky Test 2")))
demo <- demo %>% filter(Repeat.Instrument=="Demographics Form")
demo <- demo %>% filter(!is.na(Age..completed.years..at.Enrollment))
# participant 28 withdrew before taking a single dose of study medication
demo <- demo %>% filter(!(Record.ID == "028"))
demo$Obesity.Class.at.Enrollment <- as.factor(demo$Obesity.Class.at.Enrollment)
# create combined race/ethnicity
# there are 3 people who checked Latino - 2 checked white and 1 checked other for race
# if they checked black (+/- white), classify them as black
demo <- demo %>% mutate(
  race_eth = case_when(
  Adolescent..Young.Adult.Ethnicity == "Hispanic or Latino" ~ "Hispanic or Latino",
  Adolescent.Young.Adult.Race..choice.Black.or.African.American. == "Checked" &
   !(Adolescent.Young.Adult.Race..choice.White. == "Checked") ~ "Non-Hispanic Black",
  Adolescent.Young.Adult.Race..choice.White. == "Checked" & 
    !(Adolescent.Young.Adult.Race..choice.Black.or.African.American. == "Checked") ~ "Non-Hispanic White",
  Adolescent.Young.Adult.Race..choice.White. == "Checked" & 
    Adolescent.Young.Adult.Race..choice.Black.or.African.American. == "Checked" ~ "Non-Hispanic > 1 race"
  ))
# fix health insurance
demo <- demo %>% mutate(
  Health.Insurance.Type = case_when(
  Health.Insurance.Type == "" & Record.ID == "45" ~ "State-based (e.g. Medicaid, ACC, CHP+)",
  Health.Insurance.Type == "" & Record.ID == "011" ~ "State-based (e.g. Medicaid, ACC, CHP+)",
  .default = Health.Insurance.Type
  ))
# turn household income into numeric
demo$Estimated.yearly.household.income. <- str_remove(demo$Estimated.yearly.household.income., "\\$")
demo$Estimated.yearly.household.income. <- str_remove(demo$Estimated.yearly.household.income., ",")
demo <- demo %>% mutate(
  Household.income.numeric = case_when(
    Estimated.yearly.household.income. == "2850 per month" ~ 34200,
    !(Estimated.yearly.household.income. == "$2,850 per month") ~ as.numeric(Estimated.yearly.household.income.)
  )
)
# summary variable for food insecurity
demo <- demo %>% mutate (
  food_insecurity = case_when(
    X.Within.the.past.12.months..we.worried.about.whether.our.food.would.run.out.before.we.got.money.to.buy.more. == "YES" ~ "Yes",
    X.Within.the.past.12.months..the.food.we.bought.didn.t.last.and.we.didn.t.have.money.to.get.more. == "YES" ~ "Yes",
    .default = "No"
  )
)

# Drug tolerance - randomization assignment
drug_tol <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPDrugTolerance_DATA_LABELS_2024-02-05_1945.csv", na.strings = c("NA", "", " "))
drug_tol <- drug_tol %>% filter(!is.na(Randomization.Assignment))
t1_data <- merge(demo, drug_tol, by="Record.ID", all.x = T, all.y = F)

# Height/weight/vitals
ht_wt_vitals <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPHtWtVitals_DATA_LABELS_2024-02-06_1154.csv", na.strings = c("NA", "", " "))
# per Jaime, use 2nd record for participant 0002
ht_wt_vitals <- ht_wt_vitals %>% filter(!(Record.ID == "0002" & Repeat.Instance == 1))
# read in analysis height variable
analysis_ht <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPHeightForAnalysis_DATA_2024-08-08_0908.csv", na.strings = c("NA", "", " "))
analysis_ht$Record.ID <- analysis_ht$record_id
analysis_ht <- analysis_ht %>% select(Record.ID, height_analysis)
ht_wt_vitals <- left_join(ht_wt_vitals, analysis_ht, by = "Record.ID")
num_vars <- c("height_analysis", "Weight.1..kg.", "Weight.2..kg.", "Weight.3..kg.",
              "Systolic.Blood.Pressure.1", "Systolic.Blood.Pressure.2", "Systolic.Blood.Pressure.3",
              "Diastolic.Blood.Pressure.1", "Diastolic.Blood.Pressure.2", "Diastolic.Blood.Pressure.3")
ht_wt_vitals[num_vars] <- apply(ht_wt_vitals[,num_vars],2,as.numeric)
ht_wt_vitals$height_m <- ht_wt_vitals$height_analysis/100
ht_wt_vitals$wt <- rowMeans(ht_wt_vitals[, c("Weight.1..kg.", "Weight.2..kg.", "Weight.3..kg.")])
ht_wt_vitals$sbp <- rowMeans(ht_wt_vitals[, c("Systolic.Blood.Pressure.1", "Systolic.Blood.Pressure.2", "Systolic.Blood.Pressure.3")])
ht_wt_vitals$dbp <- rowMeans(ht_wt_vitals[, c("Diastolic.Blood.Pressure.1", "Diastolic.Blood.Pressure.2", "Diastolic.Blood.Pressure.3")])
ht_wt_vitals$hr <- rowMeans(ht_wt_vitals[, c("Heart.Rate.1.", "Heart.Rate.2.", "Heart.Rate.3.")])
ht_wt_vitals_long <- ht_wt_vitals 
ht_wt_vitals <- ht_wt_vitals %>% filter(Event.Name == "Study Visit 1")
ht_wt_vitals <- ht_wt_vitals %>% filter(!is.na(Repeat.Instrument))
sex_age <- demo[, c("Record.ID", "Biological.Sex", "AgeAtVisit1")]
ht_wt_vitals <- merge(sex_age, ht_wt_vitals, by="Record.ID", all.x = T, all.y = F)
ht_wt_vitals$sex <- ht_wt_vitals$Biological.Sex
ht_wt_vitals$bmi <- ht_wt_vitals$wt / (ht_wt_vitals$height_m * ht_wt_vitals$height_m)
ht_wt_vitals$agem <- ht_wt_vitals$AgeAtVisit1 * 12
ht_wt_vitals_bmiz <- ext_bmiz(ht_wt_vitals, ht = "height_analysis")
ht_wt_vitals_keep <- ht_wt_vitals_bmiz %>% select(Record.ID, height_m, wt, bmi, bmiz, bmip95, sbp, dbp)
t1_data <- merge(t1_data, ht_wt_vitals_keep, by="Record.ID", all.x = T, all.y = F)

# Labs
labs <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPLabs_DATA_2024-02-16_2219.csv")
labs_long <- labs
labs <- labs %>% filter(redcap_event_name == "screeningenrollmen_arm_1")
labs <- labs %>% filter(redcap_repeat_instrument == "labs")
labs$Record.ID <- labs$record_id
labs_keep <- labs %>% select(Record.ID, labs_a1c, labs_trig, labs_hdl, labs_ldl, labs_alt)
t1_data <- merge(t1_data, labs_keep, by="Record.ID", all.x = T, all.y = F)

# CESD
cesd <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPCESD_DATA_2024-02-16_2232.csv")
cesd <- cesd %>% filter(redcap_event_name == "study_visit_1_arm_1")
cesd <- cesd %>% filter(redcap_repeat_instrument == "cesd")
# some people have more than 1 CESD at this visit - keep the most recent
cesd <- cesd %>% arrange(record_id, desc(cesd_dateofvisit))
cesd <- cesd %>% group_by(record_id) %>% filter(row_number()==1)
cesd$Record.ID <- cesd$record_id
cesd <- ungroup(cesd)
cesd_keep <- cesd %>% select(Record.ID, cesd_score)
t1_data <- merge(t1_data, cesd_keep, by="Record.ID", all.x = T, all.y = F)
t1_data$cesd_score_ge20 <- as.factor(ifelse(t1_data$cesd_score >= 20, 1, 0))

# DEXA
dxa <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPDEXA_DATA_2024-02-16_2244.csv")
dxa <- dxa %>% filter(redcap_event_name == "study_visit_1_arm_1")

# RMR
rmr <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPRMR_DATA_2024-02-16_2245.csv")

# simplified AE
simp_AE <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPAESimplified_DATA_2024-08-08_1528.csv")
simp_AE <- simp_AE %>% select(!redcap_event_name) %>% select(!aes_simplified_version_complete)
simp_AE$aes_other_yn <- ifelse(!simp_AE$aes_other == "", 1, 0)
exclude_vars <- c("record_id", "aes_id", "severeae", "ae_dosereduce", "aes_other")
#simp_AE <- simp_AE %>% select(-one_of(exclude_vars)) %>% replace(is.na(.), 0) %>% mutate(aecount = max())
simp_AE$ae_count <- simp_AE %>% select(-one_of(exclude_vars)) %>% rowSums(na.rm = TRUE)
simp_AE$any_ae <- ifelse(simp_AE$ae_count > 0, 1, 0)
simp_AE$Record.ID <- simp_AE$record_id
simp_AE$record_id <- NULL
simp_AE$general <- simp_AE %>% select(aes_fever, aes_flushing, aes_sweating, aes_cooldown, aes_fatigue, aes_energy) %>% rowSums(na.rm = TRUE)
simp_AE$general <- as.factor(simp_AE$general)
simp_AE$ophthalmologic <- simp_AE %>% select(aes_vision, aes_eye) %>% rowSums(na.rm = TRUE)
simp_AE$ophthalmologic <- as.factor(simp_AE$ophthalmologic)
simp_AE$gastrointestinal <- simp_AE %>% select(nutrdifficult, aes_mouth, aes_taste, aes_abd, aes_nv, aes_dia, aes_const) %>% rowSums(na.rm = TRUE)
simp_AE$gastrointestinal <- as.factor(simp_AE$gastrointestinal)
simp_AE$cardiopulmonary <- simp_AE %>% select(aes_cp, aes_hr, aes_sob, aes_exin) %>% rowSums(na.rm = TRUE)
simp_AE$cardiopulmonary <- as.factor(simp_AE$cardiopulmonary)
simp_AE$genitourinary <- simp_AE %>% select(aes_cycle, aes_back, aes_swell) %>% rowSums(na.rm = TRUE)
simp_AE$genitourinary <- as.factor(simp_AE$genitourinary)
simp_AE$dermatologic <- simp_AE %>% select(aes_rash) %>% rowSums(na.rm = TRUE)
simp_AE$dermatologic <- as.factor(simp_AE$dermatologic)
simp_AE$neuropsychiatric <- simp_AE %>% select(aes_sleep, aes_tingle, aes_foggy, aes_conc, aes_mem, aes_words, aes_ir, aes_rest, aes_anx, aes_dep) %>% rowSums(na.rm = TRUE)
simp_AE$neuropsychiatric <- as.factor(simp_AE$neuropsychiatric)
simp_AE$allergic <- simp_AE %>% select(aes_allergy) %>% rowSums(na.rm = TRUE)
simp_AE$allergic <- as.factor(simp_AE$allergic)
simp_AE$other <- simp_AE %>% select(aes_other_yn) %>% rowSums(na.rm = TRUE)
simp_AE$other <- as.factor(simp_AE$other)

# create dataframe for Table 2
t2_data <- t1_data %>% select(Record.ID, Max.Topiramate.Dose.Tolerated..mg., Max.Phentermine.Dose.Tolerated..mg., Randomization.Assignment)
urineamp <- read.csv("/Volumes/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Moore/Phenteramine RCT/Data raw/PilotRCTPhentermineT-LPUrineAmphetamine_DATA_2024-08-08_1216.csv")
urineamp$Record.ID <- urineamp$record_id
adher <- left_join(urineamp, drug_tol, by = "Record.ID") 
adher <- adher %>% filter(Randomization.Assignment == "Active")
adher <- adher %>% select(Record.ID, urine_v1result, urine_v2result, urine_v3result, urine_v4result)
adher$urine_v1_performed <- ifelse(adher$urine_v1result %in% c(0,1), 1, 0)
adher$urine_v2_performed <- ifelse(adher$urine_v2result %in% c(0,1), 1, 0)
adher$urine_v3_performed <- ifelse(adher$urine_v3result %in% c(0,1), 1, 0)
adher$urine_v4_performed <- ifelse(adher$urine_v4result %in% c(0,1), 1, 0)
adher$v1_pos <- ifelse(adher$urine_v1result == 1, 1, 0)
adher$v2_pos <- ifelse(adher$urine_v2result == 1, 1, 0)
adher$v3_pos <- ifelse(adher$urine_v3result == 1, 1, 0)
adher$v4_pos <- ifelse(adher$urine_v4result == 1, 1, 0)
adher$urine_amp_adherence <- (adher$v1_pos + adher$v2_pos + adher$v3_pos + adher$v4_pos) / 
  (adher$urine_v1_performed + adher$urine_v2_performed + adher$urine_v3_performed + adher$urine_v4_performed)
adher <- adher %>% select(Record.ID, urine_amp_adherence)
t2_data <- left_join(t2_data, adher, by = "Record.ID")
t2_data <- left_join(t2_data, simp_AE, by = "Record.ID")
t2_data$any_ae <- as.factor(t2_data$any_ae)
t2_data$severeae <- as.factor(t2_data$severeae)
t2_data$ae_dosereduce <- as.factor(t2_data$ae_dosereduce)
t2_data$ae_discont <- as.factor(t2_data$ae_discont)

# calculate AE vars based on vitals
ht_wt_vitals_long <- ht_wt_vitals_long %>% filter(Event.Name %in% c("Study Visit 1", "Study Visit 2", "Study Visit 3","Study Visit 4"))
ht_wt_vitals_long <- ht_wt_vitals_long %>% filter(!(Record.ID %in% c("Jacky Test","Jacky Test 2")))
ht_wt_vitals_long <- ht_wt_vitals_long %>% filter(!is.na(wt) & !is.na(sbp) & !is.na(dbp) & !is.na(hr))
ht_wt_vitals_long <- ht_wt_vitals_long %>% select(Record.ID, Event.Name, hr, sbp, dbp)
ht_wt_vitals_wide <- reshape(ht_wt_vitals_long, direction = "wide", idvar = "Record.ID", timevar = "Event.Name")
ht_wt_vitals_wide$delta_hr <- ht_wt_vitals_wide$`hr.Study Visit 4` - ht_wt_vitals_wide$`hr.Study Visit 1`
ht_wt_vitals_wide$delta_sbp <- ht_wt_vitals_wide$`sbp.Study Visit 4` - ht_wt_vitals_wide$`sbp.Study Visit 1`
ht_wt_vitals_wide$delta_dbp <- ht_wt_vitals_wide$`dbp.Study Visit 4` - ht_wt_vitals_wide$`dbp.Study Visit 1`
ht_wt_vitals_wide <- ht_wt_vitals_wide %>% rowwise() %>%
  mutate(hr_max = max(`hr.Study Visit 2`, `hr.Study Visit 3`, `hr.Study Visit 4`, na.rm = TRUE))
ht_wt_vitals_wide$hr_ge_100 <- as.factor(ifelse(is.infinite(ht_wt_vitals_wide$hr_max), NA, 
                                      ifelse(ht_wt_vitals_wide$hr_max >= 100, 1, 0)))
ht_wt_vitals_wide <- ht_wt_vitals_wide %>% rowwise() %>%
  mutate(dbp_max = max(`dbp.Study Visit 2`, `dbp.Study Visit 3`, `dbp.Study Visit 4`, na.rm = TRUE))
ht_wt_vitals_wide$dbp_ge_80 <- as.factor(ifelse(is.infinite(ht_wt_vitals_wide$dbp_max), NA, 
                                      ifelse(ht_wt_vitals_wide$dbp_max >= 80, 1, 0)))
ht_wt_vitals_wide$sbp_120_129 <- ifelse(is.na(ht_wt_vitals_wide$`sbp.Study Visit 2`) & is.na(ht_wt_vitals_wide$`sbp.Study Visit 3`) & is.na(ht_wt_vitals_wide$`sbp.Study Visit 4`), NA, 
  ifelse((!is.na(ht_wt_vitals_wide$`sbp.Study Visit 2`) & ht_wt_vitals_wide$`sbp.Study Visit 2` >= 120 & ht_wt_vitals_wide$`sbp.Study Visit 2` <= 129) |
  (!is.na(ht_wt_vitals_wide$`sbp.Study Visit 3`) & ht_wt_vitals_wide$`sbp.Study Visit 3` >= 120 & ht_wt_vitals_wide$`sbp.Study Visit 3` <= 129) |
  (!is.na(ht_wt_vitals_wide$`sbp.Study Visit 4`) & ht_wt_vitals_wide$`sbp.Study Visit 4` >= 120 & ht_wt_vitals_wide$`sbp.Study Visit 4` <= 129), 1, 0))
ht_wt_vitals_wide$sbp_120_129 <- as.factor(ht_wt_vitals_wide$sbp_120_129)
ht_wt_vitals_wide <- ht_wt_vitals_wide %>% rowwise() %>%
  mutate(sbp_max = max(`sbp.Study Visit 2`, `sbp.Study Visit 3`, `sbp.Study Visit 4`, na.rm = TRUE))
ht_wt_vitals_wide$sbp_ge_130 <- as.factor(ifelse(is.infinite(ht_wt_vitals_wide$sbp_max), NA, 
                                      ifelse(ht_wt_vitals_wide$sbp_max >= 130, 1, 0)))
t2_data <- left_join(t2_data, ht_wt_vitals_wide, by = "Record.ID")

# calculate AE vars based on labs
labs_long <- labs_long %>% filter(redcap_event_name %in% c("study_visit_1_arm_1", "study_visit_2_arm_1", "study_visit_3_arm_1","study_visit_4_arm_1"))
labs_long <- labs_long %>% filter(!(Record.ID %in% c("Jacky Test","Jacky Test 2")))
labs_long <- labs_long %>% filter(!is.na(labs_bicarbonate) & !is.na(labs_creatinine) & !is.na(labs_potassium))
labs_long$Record.ID <- labs_long$record_id
labs_long <- labs_long %>% select(Record.ID, redcap_event_name, labs_bicarbonate, labs_creatinine, labs_potassium)
labs_wide <- reshape(labs_long, direction = "wide", idvar = "Record.ID", timevar = "redcap_event_name")
labs_wide$delta_bicarb <- labs_wide$labs_bicarbonate.study_visit_4_arm_1 - labs_wide$labs
labs_wide$delta_sbp <- labs_wide$`sbp.Study Visit 4` - labs_wide$`sbp.Study Visit 1`
labs_wide$delta_dbp <- labs_wide$`dbp.Study Visit 4` - labs_wide$`dbp.Study Visit 1`
```

# Results

## Table 1

```{r, include=FALSE}
t1 <- CreateTableOne(data = t1_data, vars = c("AgeAtVisit1", "Biological.Sex", "race_eth", "Primary.Bariatric.Surgical.Procedure",
                                              "Months.post.MBS.at.Enrollment", "Obesity.Class.at.Enrollment", "Qualifying.Inclusion.Criteria",
                                              "Health.Insurance.Type", "Primary.caregiver.s.highest.level.of.education.",
                                              "Household.income.numeric", "food_insecurity", "height_m", "weight_kg", "sbp", "dbp",
                                              "hr", "record_id", "labs_a1c", "labs_trig", "labs_hdl", "labs_ldl", "labs_alt",
                                              "cesd_score", "cesd_score_ge20"), 
                     strata = "Randomization.Assignment")
t1 <- print(t1, nonnormal = c("Age..completed.years..at.Enrollment", "labs_a1c", "labs_trig", "labs_alt"), 
            showAllLevels = T)
```

```{r, include=TRUE}
kable(t1)
```

## Table 2

```{r, include=FALSE}
t2 <- CreateTableOne(data = t2_data, vars = c("urine_amp_adherence","Max.Topiramate.Dose.Tolerated..mg.","Max.Phentermine.Dose.Tolerated..mg.",
                                              "any_ae", "severeae", "ae_dosereduce", "ae_discont", "general", "ophthalmologic", "gastrointestinal", 
                                              "cardiopulmonary", "genitourinary", "dermatologic", "neuropsychiatric", "allergic", "other", 
                                              "delta_hr", "hr_ge_100", "delta_sbp", "sbp_120_129", "sbp_ge_130", "delta_dbp", "dbp_ge_80"), 
                     strata = "Randomization.Assignment")
t2 <- print(t2, showAllLevels = T)
```

```{r, include=TRUE}
kable(t2)
```