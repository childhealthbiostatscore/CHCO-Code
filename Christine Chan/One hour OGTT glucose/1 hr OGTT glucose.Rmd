---
title: "1 hour OGTT glucose in CFRD"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(knitr)
library(rspiro)
library(dplyr)
library(childsds)
library(tableone)
library(pROC)
library(OptimalCutpoints)
library(sjlabelled)
library(Hmisc)
library(pch)
library(coxphw)
library(finalfit)
library(survivalROC)
library(tdROC)

# read in separate data files

ogtt <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\ogtt.csv")
pft <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\pfts.csv")
a1c <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\a1c.csv")
demo <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\demographics.csv")

# checking for dups
t <- ogtt[,c("MRN","FName","LName")]
t <- unique(t)
ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# merge ogtt and demo
demo$FName <- NULL
demo$LName <- NULL
ogtt <- ogtt %>% group_by(MRN,Date.of.OGTT) %>% filter(row_number() == 1)
ogtt_demo <- merge(ogtt,demo,by="MRN",all.x = T, all.y = T)

# merge ogtt, demo, and A1c
ogtt_demo$Date <- ogtt_demo$Date.of.OGTT
ogtt_demo$Date.of.OGTT <- NULL
a1c$Date.of.OGTT <- NULL
a1c$Days.Between.A1C.and.OGTT <- NULL
a1c$Date <- a1c$Date.of.A1C
a1c$Date.of.A1C  <- NULL
a1c$FName <- NULL
a1c$LName <- NULL
a1c <- a1c %>% group_by(MRN,Date) %>% filter(row_number() == 1)
ogtt_demo_a1c <- merge(ogtt_demo,a1c,by=c("MRN","Date"),all.x=T,all.y=T)

# add in PFTs
pft$Date.of.OGTT <- NULL
pft$FName <- NULL
pft$LName <- NULL
pft$Date <- pft$Date.of.PFT
pft$Date.of.PFT <- NULL
# get predicted spirometry values
pft$FVC...Pred <- NULL
pft$FEV1...Pred <- NULL
pft$FEF.25.75...Pred <- NULL
pft$DOB <- as.Date(as.character(pft$DOB),format="%m/%d/%Y")
pft$ht_m <- pft$Height..cm./100
sex <- demo[,c("MRN","Sex")]
pft <- merge(pft, sex, by="MRN",all.x=T,all.y = F)
pft$sexnum <- ifelse(pft$Sex=="Male",1,2)
pft$FEV1.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEV1")
pft$FVC.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FVC")
pft$FEF.25.75.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEF2575")
pft$FEV1.per.pred <- (pft$FEV1.Raw / pft$FEV1.pred)*100
pft$FVC.per.pred <- (pft$FVC.Raw / pft$FVC.pred)*100
pft$FEF.25.75.per.pred <- (pft$FEF.25.75.Raw / pft$FEF.25.75.pred)*100
pft$Sex <- NULL
pft <- pft %>% group_by(MRN,Date) %>% filter(row_number() == 1)
alldata <- merge(ogtt_demo_a1c,pft,by=c("MRN","Date"),all.x=T,all.y=T)

# merge back all baseline characteristics
d <- alldata[,c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2")]
d <- d[!is.na(d$FName),]
d <- unique(d)
alldata$FName <- NULL
alldata$Latino.a. <- NULL
alldata$LName <- NULL
alldata$Sex <- NULL
alldata$Race <- NULL
alldata$Mutation.1 <- NULL
alldata$Mutation.2 <- NULL
alldata <- merge(alldata,d,by="MRN",all.x = T,all.y = T)

# checking for dups
t <- alldata[,c("MRN","FName","LName")]
t <- unique(t)
ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# find first OGTT
o <- alldata[!is.na(alldata$Age.At.Test..years.) & !is.na(alldata$X1.hour.Glucose),c("MRN","Date")]
o <- o[order(o$MRN,o$Date),]
o <- o %>% group_by(MRN) %>% filter(row_number() == 1)
colnames(o) <- c("MRN","Date of first OGTT")
alldata <- merge(alldata,o,by="MRN",all.x = T,all.y = T)
alldata <- alldata[!is.na(alldata$`Date of first OGTT`),]

# remove all visits before first OGTT
alldata$Date <- as.Date(as.character(alldata$Date),format="%m/%d/%Y")
alldata$`Date of first OGTT` <- as.Date(as.character(alldata$`Date of first OGTT`),format="%m/%d/%Y")
alldata <- alldata[alldata$Date >= alldata$`Date of first OGTT`,]

# calculate BMI
alldata$BMI <- alldata$Weight..kg./((alldata$Height..cm./100)^2)

# reorder columns
colorder <- c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2","Date of first OGTT",
              "Date","Age.At.Test..years.","Fasting.Glucose","X1.hour.Glucose","X2.hour.Glucose","A1C",
              "DOB","Age.at.PFT","FVC.Raw","Height..cm.","Weight..kg.","FEV1.Raw","FEF.25.75.Raw","ht_m",
              "sexnum","FEV1.pred","FVC.pred","FEF.25.75.pred","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","BMI")
alldata <- alldata[,colorder]
alldata <- alldata[order(alldata$MRN,alldata$Date),]

# get BMI percentile
alldata$age <- ifelse(is.na(alldata$Age.at.PFT),alldata$Age.At.Test..years.,alldata$Age.at.PFT)
alldata$age_bmi <- ifelse(alldata$age>20,20,alldata$age)
alldata$bmip = sds(alldata$BMI,
              age = alldata$age_bmi,
              sex = alldata$Sex, male = "Male", female =  "Female",
              ref = cdc.ref,
              item = "bmi",
              type = "perc")

# classify CFRD at each visit
alldata$cfrd_visit <- NA
alldata$cfrd_visit <- ifelse(is.na(alldata$X2.hour.Glucose),NA,ifelse(alldata$X2.hour.Glucose>=200,1,0))

# find people with CFRD at baseline
cfrdbase <- alldata[alldata$Date==alldata$`Date of first OGTT` & alldata$cfrd_visit==1,]
alldata <- alldata[!(alldata$MRN %in% cfrdbase$MRN),]

# create variable for CFRD groups (i.e., those who developed CFRD vs those who did not)
# and get date of first OGTT with CFRD
cfrdcheck <- alldata[alldata$cfrd_visit==1,c("MRN","Date","cfrd_visit")]
cfrdcheck <- cfrdcheck[order(cfrdcheck$MRN,desc(cfrdcheck$cfrd_visit)),]
cfrdcheck <- cfrdcheck[!is.na(cfrdcheck$MRN),]
cfrdcheck <- cfrdcheck %>% group_by(MRN) %>% filter(row_number() == 1)                              
colnames(cfrdcheck) <- c("MRN","Date of CFRD diagnosis","CFRD")      
alldata <- merge(alldata,cfrdcheck,by="MRN",all.x=T,all.y=T)
alldata$CFRD <- ifelse(is.na(alldata$CFRD),0,1)

# get baseline age
baseage <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","age")]
colnames(baseage) <- c("MRN","Base_age")
alldata <- merge(alldata,baseage,by="MRN",all.x=T,all.y=T)

# get baseline 1 hour and 2 hour glucose
basegluc <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","X1.hour.Glucose","X2.hour.Glucose")]
colnames(basegluc) <- c("MRN","Baseline_1hr_glucose","Baseline_2hr_glucose")
alldata <- merge(alldata,basegluc,by="MRN",all.x=T,all.y=T)

# find date of last OGTT
lastogtt <- alldata[!is.na(alldata$Fasting.Glucose) | !is.na(alldata$X1.hour.Glucose) | !is.na(alldata$X2.hour.Glucose),
                    c("MRN","Date")]
lastogtt <- lastogtt[order(lastogtt$MRN,desc(lastogtt$Date)),]
lastogtt <- lastogtt %>% group_by(MRN) %>% filter(row_number() == 1)  
colnames(lastogtt) <- c("MRN","Date of last OGTT")
alldata <- merge(alldata,lastogtt,by="MRN",all.x = T,all.y=T)

# for analyses about prediction of CFRD, we need to exclude those who only have one OGTT
# can use alldata for mixed models of PFTs and BMI
oneogtt <- alldata[alldata$`Date of first OGTT`==alldata$`Date of last OGTT`,]
multogtt <- alldata[!(alldata$MRN %in% oneogtt$MRN),]

# have CFRD indicator
# create variable for follow-up time
# in those who do not develop CFRD, this is the time between first and last OGTT, and they are censored
# for those who develop CFRD, this is time between first OGTT and diagnosis of CFRD
multogtt$Follow_up_time_yrs <- ifelse(multogtt$CFRD==1,(multogtt$`Date of CFRD diagnosis`-multogtt$`Date of first OGTT`)/365.25,
                           (multogtt$`Date of last OGTT`-multogtt$`Date of first OGTT`)/365.25)

# get number of participants in each cohort
n_alldata <- length(unique(alldata$MRN))
n_multogtt <- length(unique(multogtt$MRN))
# number of participants in each cohort who developed CFRD
n_alldata_cfrd <-  length(unique(alldata[alldata$CFRD==1,]$MRN))
n_multogtt_cfrd <- length(unique(multogtt[multogtt$CFRD==1,]$MRN))

# create dataset with baseline only 
baseline_mult <- multogtt[multogtt$Date==multogtt$`Date of first OGTT`,]
baseline_all <- alldata[alldata$Date==alldata$`Date of first OGTT`,]

# table of demographics in those with at least one pre-CFRD OGTT
demovars <- c("Sex","Race","Latino.a.","age")
# Taking out these clinical variables - if they are to be added to table 1, need to figure out how
# because they come from PFT visits, not the same date as OGTT
#              "BMI","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","bmip")
t1_alldata <- CreateTableOne(data=baseline_all,vars=demovars)
t1_alldata <-  print(t1_alldata,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# table of demographics in those with more than OGTT
t1_multogtt <- CreateTableOne(data=baseline_mult,vars=c(demovars,"Follow_up_time_yrs"))
t1_multogtt <-  print(t1_multogtt,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# compare baseline glucose values in those who developed CFRD and those who did not
gluctable <- CreateTableOne(baseline_mult,vars=c("X1.hour.Glucose","X2.hour.Glucose"),strata="CFRD")
gluctable <-  print(gluctable,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = T)

# logistic regression of 1 hour and 2 hour glucose predicting cfrd
log1 <- glm(data = baseline_mult, CFRD~X1.hour.Glucose,family = "binomial")
or1 <- exp(cbind(OR = coef(log1), confint(log1)))

log1_adj <- glm(data = baseline_mult, CFRD~X1.hour.Glucose + Base_age + Sex,family = "binomial")
or1_adj <- exp(cbind(OR = coef(log1_adj), confint(log1_adj)))

log2 <- glm(data = baseline_mult, CFRD~X2.hour.Glucose,family = "binomial")
or2 <- exp(cbind(OR = coef(log2), confint(log2)))

log2_adj <- glm(data = baseline_mult, CFRD~X2.hour.Glucose + Base_age + Sex,family = "binomial")
or2_adj <- exp(cbind(OR = coef(log2_adj), confint(log2_adj)))

# ROC for 1 hour glucose
baseline_mult$pred_1hr <- predict(log1, type="response", data.frame=baseline_mult)
roc1 <- roc(data=baseline_mult, response = CFRD, predictor=X1.hour.Glucose)
coords1 <- coords(roc1, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

# ROC for 2 hour glucose
baseline_mult$pred_2hr <- predict(log2, type="response", data.frame=baseline_mult)
roc2 <- roc(data=baseline_mult, response = CFRD, predictor=X2.hour.Glucose)
coords2 <- coords(roc2, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

# CPH model for baseline 1 hour glucose
cox1hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_1hr_glucose,data = multogtt)
# Diagnostics
d1 <- cox.zph(cox1hr)
cox1hrt <- multogtt %>% finalfit("Surv(Follow_up_time_yrs,CFRD)","Baseline_1hr_glucose")

# CPH model for 2 hour glucose
cox2hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data = multogtt)
# Diagnostics
d2 <- cox.zph(cox2hr)
# appears to violate PH
cox2hrint <- cox.zph(cox2hr,transform = function(Follow_up_time_yrs) log(Follow_up_time_yrs))
# log transforming time doesn't fix it
plot(cox2hrint)

# adding time dependent coefficient
cox2hrtt <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose + tt(Baseline_2hr_glucose),data = multogtt,
                tt=function(x,t,...) x*t*t*t)
# check fit of new model
plot(d2)
abline(coef(cox2hrtt[1:2],col=2))

# trying piecewise constant hazard model
pch1 <- pchreg(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,breaks = 2,data=multogtt)

# trying weighted Cox regression
cw1 <- coxphw(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data=multogtt)

# time dependent ROC
# one hour glucose
# year 1
tdroc11 <- tdROC(X=multogtt$Baseline_1hr_glucose,Y=multogtt$Follow_up_time_yrs,delta=multogtt$CFRD,tau=1)
a <- tdroc11$ROC
tdroc11.youd <- with(a, which.max(sens+spec-1))
survroctab1_row1 <- c(round(a$grid[tdroc11.youd],2),
                     round(a$sens[tdroc11.youd],2),
                     round(a$spec[tdroc11.youd],2))
#  year 2
tdroc12 <- tdROC(X=multogtt$Baseline_1hr_glucose,Y=multogtt$Follow_up_time_yrs,delta=multogtt$CFRD,tau=2)
a <- tdroc12$ROC
tdroc12.youd <- with(a, which.max(sens+spec-1))
survroctab1_row2 <- c(round(a$grid[tdroc12.youd],2),
                     round(a$sens[tdroc12.youd],2),
                     round(a$spec[tdroc12.youd],2))
# year 3
tdroc13 <- tdROC(X=multogtt$Baseline_1hr_glucose,Y=multogtt$Follow_up_time_yrs,delta=multogtt$CFRD,tau=3)
a <- tdroc13$ROC
tdroc13.youd <- with(a, which.max(sens+spec-1))
survroctab1_row3 <- c(round(a$grid[tdroc13.youd],2),
                     round(a$sens[tdroc13.youd],2),
                     round(a$spec[tdroc13.youd],2))
# year 4
tdroc14 <- tdROC(X=multogtt$Baseline_1hr_glucose,Y=multogtt$Follow_up_time_yrs,delta=multogtt$CFRD,tau=4)
a <- tdroc14$ROC
tdroc14.youd <- with(a, which.max(sens+spec-1))
survroctab1_row4 <- c(round(a$grid[tdroc14.youd],2),
                     round(a$sens[tdroc14.youd],2),
                     round(a$spec[tdroc14.youd],2))
# year 5
tdroc15 <- tdROC(X=multogtt$Baseline_1hr_glucose,Y=multogtt$Follow_up_time_yrs,delta=multogtt$CFRD,tau=5)
a <- tdroc15$ROC
tdroc15.youd <- with(a, which.max(sens+spec-1))
survroctab1_row5 <- c(round(a$grid[tdroc15.youd],2),
                     round(a$sens[tdroc15.youd],2),
                     round(a$spec[tdroc15.youd],2))
survroctab1 <- rbind(survroctab1_row1,survroctab1_row2,survroctab1_row3,survroctab1_row4,survroctab1_row5)
rownames(survroctab1) <- c("1 year","2 years","3 years","4 years","5 years")
colnames(survroctab1) <- c("Glucose","Sensitivity","Specificity")

# two hour glucose
survroc21 <- survivalROC(Stime=multogtt$Follow_up_time_yrs, status=multogtt$CFRD, marker = multogtt$Baseline_2hr_glucose,
                        predict.time = 1, method = "KM")
survroc21.youd <- with(survroc21, which.min(1-TP+ FP))
survroc22 <- survivalROC(Stime=multogtt$Follow_up_time_yrs, status=multogtt$CFRD, marker = multogtt$Baseline_2hr_glucose,
                        predict.time = 2, method = "KM")
survroc22.youd <- with(survroc22, which.min(1-TP+ FP))
survroc23 <- survivalROC(Stime=multogtt$Follow_up_time_yrs, status=multogtt$CFRD, marker = multogtt$Baseline_2hr_glucose,
                        predict.time = 3, method = "KM")
survroc23.youd <- with(survroc23, which.min(1-TP+ FP))
survroc24 <- survivalROC(Stime=multogtt$Follow_up_time_yrs, status=multogtt$CFRD, marker = multogtt$Baseline_2hr_glucose,
                        predict.time = 4, method = "KM")
survroc24.youd <- with(survroc24, which.min(1-TP+ FP))
survroc25 <- survivalROC(Stime=multogtt$Follow_up_time_yrs, status=multogtt$CFRD, marker = multogtt$Baseline_2hr_glucose,
                        predict.time = 5, method = "KM")
survroc25.youd <- with(survroc25, which.min(1-TP+ FP))


```

# Background

# Methods

describe who is excluded
difference between entire cohort and those with follow-up OGTTs

# Results

There were `r n_alldata` participants who had at least one OGTT.  Of these, `r n_alldata_cfrd` developed CFRD.

There were `r n_multogtt` participants who had more than one OGTT.  Of these, `r n_multogtt_cfrd` developed CFRD.

## Table 1a.  Descriptive statistics for entire cohort.

```{r, echo=FALSE}
kable(t1_alldata)
```

<br>

## Table 1b.  Descriptive statistics for participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(t1_multogtt)
```

<br>

## Table 2.  Glucose values from baseline OGTT in those who developed CFRD vs. those who did not, among the participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(gluctable)
```

<br>

## Table 3a.  Results of logistic regression - baseline 1 hour glucose and CFRD.

```{r, echo=FALSE}
summary(log1)$coefficients

or1
```

<br>

## Table 3b.  Results of logistic regression - baseline 1 hour glucose and CFRD, adjusted for baseline age and sex.

```{r, echo=FALSE}
summary(log1_adj)$coefficients

or1_adj
```

<br>

## Table 4a.  Results of logistic regression - baseline 2 hour glucose and CFRD.

```{r, echo=FALSE}
summary(log2)$coefficients

or2
```

<br>

## Table 4b.  Results of logistic regression - baseline 2 hour glucose and CFRD, adjusted for baseline age and sex.

```{r, echo=FALSE}
summary(log2_adj)$coefficients

or2_adj
```

<br>

## ROC analysis for baseline 1 hour glucose.

The AUC for the ROC was `r round(auc(roc1),4)`.

```{r, echo=FALSE}
plot.roc(roc1, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 1 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords1)
```

<br>

## ROC analysis for baseline 2 hour glucose.

The AUC for the ROC was `r round(auc(roc2),4)`.

```{r, echo=FALSE}
plot.roc(roc2, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 2 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords2)
```

<br>

## Cox proportional hazards model for baseline 1 hour glucose.

```{r, echo=FALSE}
kable(cox1hrt[,1:4])
```

<br>

## Weighted Cox proportional hazards model for baseline 2 hour glucose.

```{r, echo=FALSE}
print(cw1)
```

<br>

## Survival ROC for baseline 1 hour glucose.

## Survival ROC for baseline 2 hour glucose.

For 2 hour, used regular Cox model, not weighted.


