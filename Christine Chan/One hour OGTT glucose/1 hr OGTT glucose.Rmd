---
title: "1 hour OGTT glucose in CFRD"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
library(knitr)
library(rspiro)
library(childsds)
library(tableone)
library(pROC)
library(OptimalCutpoints)
library(sjlabelled)
library(Hmisc)
library(pch)
library(coxphw)
#crappy package - don't use!
#library(finalfit)
library(survivalROC)
library(tdROC)
library(nlme)
library(plyr)
library(dplyr)
library(emmeans)
library(survival)
library(survminer)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "E:/"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r}

# read in separate data files

ogtt <- read.csv("./Christine Chan/1 hour OGTT in CFRD/Data_raw/ogtt.csv")
pft <- read.csv("./Christine Chan/1 hour OGTT in CFRD/Data_raw/pfts.csv")
a1c <- read.csv("./Christine Chan/1 hour OGTT in CFRD/Data_raw/a1c.csv")
demo <- read.csv("./Christine Chan/1 hour OGTT in CFRD/Data_raw/demographics.csv")

# checking for dups
#t <- ogtt[,c("MRN","FName","LName")]
#t <- unique(t)
#ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# merge ogtt and demo
demo$FName <- NULL
demo$LName <- NULL
ogtt <- ogtt %>% group_by(MRN,Date.of.OGTT) %>% filter(row_number() == 1)
ogtt_demo <- merge(ogtt,demo,by="MRN",all.x = T, all.y = T)
ogtt_demo$Date.of.OGTT <- mdy(ogtt_demo$Date.of.OGTT)
```

```{r}

# merge ogtt, demo, and A1c
#ogtt_demo$Date <- ogtt_demo$Date.of.OGTT
#ogtt_demo$Date.of.OGTT <- NULL
#a1c$Date.of.OGTT <- NULL
#a1c$Days.Between.A1C.and.OGTT <- NULL
#a1c$Date <- a1c$Date.of.A1C
#a1c$Date.of.A1C  <- NULL
#a1c$FName <- NULL
#a1c$LName <- NULL
#a1c <- a1c %>% group_by(MRN,Date) %>% filter(row_number() == 1)
#ogtt_demo_a1c <- merge(ogtt_demo,a1c,by=c("MRN","Date"),all.x=T,all.y=T)

# find most recent A1c that is within the 90 days prior to OGTT
# subsetting to correct ID
# this is so weird - all IDs<1000000 have missing A1c values
# if I first subset the data to one participant with ID<1000000, it works, so it seems like A1c is getting overwritten with NA at later steps?
a1c$Date.of.A1C <- mdy(a1c$Date.of.A1C)
ogtt_demo_a1c$A1c = unlist(apply(ogtt_demo_a1c,1,function(r){
  Date = r["Date.of.OGTT"]
  ID = as.numeric(r["MRN"])
  a = d$A1C[which.min(abs(difftime(a1c$Date.of.A1C[a1c$MRN == ID], Date)))]
  if(is.na(Date) | !(ID %in% a1c$MRN)){a = NA}
  return(a)
}))

# add in PFTs
pft$Date.of.OGTT <- NULL
pft$FName <- NULL
pft$LName <- NULL
pft$Date <- pft$Date.of.PFT
pft$Date.of.PFT <- NULL
# get predicted spirometry values
pft$FVC...Pred <- NULL
pft$FEV1...Pred <- NULL
pft$FEF.25.75...Pred <- NULL
pft$DOB <- as.Date(as.character(pft$DOB),format="%m/%d/%Y")
pft$ht_m <- pft$Height..cm./100
sex <- demo[,c("MRN","Sex")]
pft <- merge(pft, sex, by="MRN",all.x=T,all.y = F)
pft$sexnum <- ifelse(pft$Sex=="Male",1,2)
pft$FEV1.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEV1")
pft$FVC.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FVC")
pft$FEF.25.75.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEF2575")
pft$FEV1.per.pred <- (pft$FEV1.Raw / pft$FEV1.pred)*100
pft$FVC.per.pred <- (pft$FVC.Raw / pft$FVC.pred)*100
pft$FEF.25.75.per.pred <- (pft$FEF.25.75.Raw / pft$FEF.25.75.pred)*100
pft$Sex <- NULL
pft <- pft %>% group_by(MRN,Date) %>% filter(row_number() == 1)
alldata <- merge(ogtt_demo_a1c,pft,by=c("MRN","Date"),all.x=T,all.y=T)

# hard code some corrections to data per CC
alldata[alldata$MRN==686476,]$X1.hour.Glucose <- ifelse(alldata[alldata$MRN==686476,]$Age.At.Test..years.==14.5,185,alldata[alldata$MRN==686476,]$X1.hour.Glucose)

#severity of genotype

# Red = severe or minimal function mutation
# Orange= unknown mutation status (for now) 
# Yellow= partial function or mild
# Green = not CF causing, classify as "other", will most likely be seen in people with CRMS diagnosis

alldata$class2 <- ifelse(alldata$Mutation.2 %in% c('1717-1G->A', '1717-1G-A',  'G542X', 'Q493X', 'R1162X', 'R553X', 'R553x', 'W1089X', 'W1282X', '1078delT', 'R75X',
                                      '3659delC', '621+1G->T', '621+1G>T', '394delTT', '3120 + 1g->A', '1154InsTC',  '1154insTC', '1213delT',
                                      '1259insA', '1288insTA', '3791delC', 'E60X', 'K710X', '2184delA', 'CFTRdele2,3', '663delT', 'Glu528',
                                      '1461ins4', '306insA', 'R709X', 'CFTRdele22-24', '2711delT', '2183AA- >G','2183delAA>G'), "I", 
                                          ifelse(alldata$Mutation.2 %in% c('F508', 'F508del', 'F508del ', 'G85E', 'I507', 'I 507', 'N1303K', 'A559T', 'R560T', 'A561E'), 
                                           "II", 
                                              ifelse(alldata$Mutation.2 %in% c('G551D', 'G551S', 'S549N'), "III", 
                                                  ifelse(alldata$Mutation.2 %in% c('R334W', 'R347P', 'R117H', 'R117C', 'P67L', 'L206W','l206w','I206w', 'D614G', 'R347H', 'D1152H', '3849+10kbC>T'),"IV", 
                                                      ifelse(alldata$Mutation.2 %in% c('A455E', '2789+5G->A', '3849+10CT', '3849+10kbC->T', '711+3A->G', '1898+5G->T',
                                                      'P574H', '3272-26A->G5','3272-26A->G'), "V" , "")))))   
 
alldata$severity2 <- ifelse(alldata$Mutation.2 %in% c('1717-1G->A', '1717-1G-A',  'G542X', 'Q493X', 'R1162X', 'R553X', 'R553x', 'W1089X', 'W1282X', '1078delT', 'R75X',
                                             '3659delC', '621+1G->T', '621+1G>T', '394delTT', '3120 + 1g->A', '1154InsTC',  '1154insTC', '1213delT',
                                             '1259insA', '1288insTA', '3791delC', 'E60X', 'K710X', '2184delA', 'CFTRdele2,3', '663delT', 'Glu528',
                                             '1461ins4', '306insA', 'R709X', 'CFTRdele22-24', '2711delT', '2183AA- >G','2183delAA>G','F508', 'F508del', 'F508del ', 'G85E', 
                                             'I507', 'I 507', 'N1303K', 'A559T', 'R560T', 'A561E','G551D', 'G551S', 'S549N','1898+1G->A', '2143delT', '2183AA-G',
                                             '2183delAA->G', '2184insA', 'S434X','2585delT', '3120+1G->A',  '3905insT',  '406-1G->A', '712-1G->T', 'L1245X', 'Q2X', 'R1158X',
                                             'R851X', 'V520F', 'L1077P', 'S489X', 'F311del', 'W846X', 'M1101K', '2622+1G->A', 'S945L',"Y1092X", "R1066C", "G178R", "2957delT", 
                                             "CFTRdele1", 'W1204X', "q493x", "W57G", "1585-8G>A", "1717-8G->A","G1244E"), "Severe", 
               ifelse(alldata$Mutation.2 %in% c('R334W', 'R347P', 'R117H', 'R117C', 'P67L', 'L206W','l206w','I206w', 'D614G', 'R347H', 'D1152H', '3849+10kbC>T', "D110H", "R1070W",
                                               'A455E', '2789+5G->A', '3849+10CT', '3849+10kbC->T', '711+3A->G', '1898+5G->T','P574H', '3272-26A->G5','3272-26A->G','3849G->A', 'H199Y', 'H199y',
                                               'S492F', 'S531P','L1335P', 'R352Q', "D1270N", "2789+2insA", "3849+10kbc->T", "Q98R", "Phe1052Val", 
                                               "F1052V", "Tyr1014Cys", "Y1014C", "T338I", "5T", "c.2249C>T", "P750L"), "Mild" ,
                      ifelse(alldata$Mutation.2 %in% c(  '1262insA', 'I506T', '3363delGT' , 'Q1209P', '3349insT', 'G178R', 'L467P', '317insC', 'I336K',	
                                                       'ex14a', '3500-2A->G', 'c.3407_3422del16', '3349insT', '1248+1G->A', 'M470V', '1812-1G->A',
                                                       'del X22-24', 'Q237H', 'Q237H', 'W57G', '1078delA', 'G178R', '2957delT', 'G576A',
                                                       'other', 'Other', 'Unknown', 'unknown', 'CFTRdele1', '1811+1.6kb A->', 'UNK', "I336K", "M470V", "S1235R", "M470V", "F508C",
                                                       "R1066H", "P205S"),"Unk","")))

alldata$class1 <- ifelse(alldata$Mutation.1 %in% c('1717-1G->A', '1717-1G-A',  'G542X', 'Q493X', 'R1162X', 'R553X', 'R553x', 'W1089X', 'W1282X', '1078delT', 'R75X',
                                             '3659delC', '621+1G->T', '621+1G>T', '394delTT', '3120 + 1g->A', '1154InsTC',  '1154insTC', '1213delT',
                                             '1259insA', '1288insTA', '3791delC', 'E60X', 'K710X', '2184delA', 'CFTRdele2,3', '663delT', 'Glu528',
                                             '1461ins4', '306insA', 'R709X', 'CFTRdele22-24', '2711delT', '2183AA- >G','2183delAA>G'), "I", 
                      ifelse(alldata$Mutation.1 %in% c('F508', 'F508del', 'F508del ', 'G85E', 'I507', 'I 507', 'N1303K', 'A559T', 'R560T', 'A561E'), "II", 
                             ifelse(alldata$Mutation.1 %in% c('G551D', 'G551S', 'S549N'), "III", 
                                    ifelse(alldata$Mutation.1 %in% c('R334W', 'R347P', 'R117H', 'R117C', 'P67L', 'L206W','l206w','I206w', 'D614G', 'R347H', 'D1152H', '3849+10kbC>T'), "IV", 
                                           ifelse(alldata$Mutation.1 %in% c('A455E', '2789+5G->A', '3849+10CT', '3849+10kbC->T', '711+3A->G', '1898+5G->T',
                                                                         'P574H', '3272-26A->G5','3272-26A->G'), "V" , "")))))   

alldata$severity1 <- ifelse(alldata$Mutation.1 %in% c('1717-1G->A', '1717-1G-A',  'G542X', 'Q493X', 'R1162X', 'R553X', 'R553x', 'W1089X', 'W1282X', '1078delT', 'R75X',
                                                    '3659delC', '621+1G->T', '621+1G>T', '394delTT', '3120 + 1g->A', '1154InsTC',  '1154insTC', '1213delT',
                                                    '1259insA', '1288insTA', '3791delC', 'E60X', 'K710X', '2184delA', 'CFTRdele2,3', '663delT', 'Glu528',
                                                    '1461ins4', '306insA', 'R709X', 'CFTRdele22-24', '2711delT', '2183AA- >G','2183delAA>G','F508', 'F508del', 'F508del ', 'G85E', 
                                                    'I507', 'I 507', 'N1303K', 'A559T', 'R560T', 'A561E','G551D', 'G551S', 'S549N','1898+1G->A', '2143delT', '2183AA-G',
                                                    '2183delAA->G', '2184insA', 'S434X','2585delT', '3120+1G->A',  '3905insT',  '406-1G->A', '712-1G->T', 'L1245X', 'Q2X', 'R1158X',
                                                    'R851X', 'V520F', 'L1077P', 'S489X', 'F311del', 'W846X', 'M1101K', '2622+1G->A', 'S945L', 
                                                    "Y1092X", "R1066C", "G178R", "2957delT", "CFTRdele1", 'W1204X', "q493x", "W57G", "1585-8G>A", "1717-8G->A","G1244E"), "Severe", 
                           ifelse(alldata$Mutation.1 %in% c('R334W', 'R347P', 'R117H', 'R117C', 'P67L', 'L206W','l206w','I206w', 'D614G', 'R347H', 'D1152H', '3849+10kbC>T', "D110H", "R1070W",
                                                           'A455E', '2789+5G->A', '3849+10CT', '3849+10kbC->T', '711+3A->G', '1898+5G->T',
                                                           'P574H', '3272-26A->G5','3272-26A->G','3849G->A', 'H199Y', 'H199y',  'S492F', 'S531P',
                                                           'L1335P', 'R352Q', "D1270N", "2789+2insA", "3849+10kbc->T", "Q98R", "Phe1052Val", 
                                                           "F1052V", "Tyr1014Cys", "Y1014C", "T338I", "5T", "c.2249C>T", "P750L"), "Mild" ,
                                  ifelse(alldata$Mutation.1 %in% c(  '1262insA', 'I506T', '3363delGT' , 'Q1209P', '3349insT', 'G178R', 'L467P', '317insC', 'I336K',	
                                                                    'ex14a', '3500-2A->G', 'c.3407_3422del16', '3349insT', '1248+1G->A', 'M470V', '1812-1G->A',
                                                                    'del X22-24', 'Q237H', 'Q237H', 'W57G', '1078delA', 'G178R', '2957delT', 'G576A',
                                                                    'other', 'Other', 'Unknown', 'unknown', 'CFTRdele1', '1811+1.6kb A->', 'UNK', "I336K", "M470V", "S1235R", "M470V", "F508C",
                                                                    "R1066H", "P205S"), "Unk","")))

alldata$genoRisk <- ifelse(alldata$severity1 == "Mild" | alldata$severity2 == "Mild", "Low", 
                  ifelse(alldata$severity1 == "Severe" & alldata$severity2 == "Severe", "High", ""))

# merge back all baseline characteristics
d <- alldata[,c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2","class1","class2","severity1","severity2","genoRisk")]
d <- d[!is.na(d$FName),]
d <- unique(d)
alldata$FName <- NULL
alldata$Latino.a. <- NULL
alldata$LName <- NULL
alldata$Sex <- NULL
alldata$Race <- NULL
alldata$Mutation.1 <- NULL
alldata$Mutation.2 <- NULL
alldata$class1 <- NULL
alldata$class2 <- NULL
alldata$severity1 <- NULL
alldata$severity2 <- NULL
alldata$genoRisk <- NULL
alldata <- merge(alldata,d,by="MRN",all.x = T,all.y = T)


# checking for dups
#t <- alldata[,c("MRN","FName","LName")]
#t <- unique(t)
#ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# find first OGTT
alldata$Date <- as.Date(as.character(alldata$Date),format="%m/%d/%Y")
o <- alldata[!is.na(alldata$Age.At.Test..years.) & !is.na(alldata$X1.hour.Glucose),c("MRN","Date")]
o <- o[order(o$MRN,o$Date),]
o <- o %>% group_by(MRN) %>% filter(row_number() == 1)
colnames(o) <- c("MRN","Date of first OGTT")
alldata <- merge(alldata,o,by="MRN",all.x = T,all.y = T)
alldata <- alldata[!is.na(alldata$`Date of first OGTT`),]

# checking ppts that Collin said had CFRD
col_check <- alldata[alldata$MRN %in% c(1006479,1053930,1078408,1136992,1289450,1339023,1413821,1695512,664400,
                      686476,707831,712676,739231,739460,787372,800007,848440,860181,875128,897478,905284,908966,
                      918124,932695,949042,952250,952252,825118),]
col_check <- col_check[order(col_check$MRN,col_check$Date),]
write.csv(col_check,"./Christine Chan/1 hour OGTT in CFRD/Data_raw/check_cfrd.csv",na="",row.names = F)

# last 2 discrepant cases after fixing date issue
col_check2 <- alldata[alldata$MRN %in% c(686476,825118),]
col_check2 <- col_check2[order(col_check2$MRN,col_check2$Date),]
write.csv(col_check2,"./Christine Chan/1 hour OGTT in CFRD/Data_raw/check_cfrd2.csv",na="",row.names = F)

# remove all visits before first OGTT
#alldata$`Date of first OGTT` <- as.Date(as.character(alldata$`Date of first OGTT`),format="%m/%d/%Y")
alldata <- alldata[alldata$Date >= alldata$`Date of first OGTT`,]

# calculate BMI
alldata$BMI <- alldata$Weight..kg./((alldata$Height..cm./100)^2)

# reorder columns
colorder <- c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2","class1","class2","severity1","severity2","genoRisk",
              "Date of first OGTT","Date","Age.At.Test..years.","Fasting.Glucose","X1.hour.Glucose","X2.hour.Glucose","A1C",
              "DOB","Age.at.PFT","FVC.Raw","Height..cm.","Weight..kg.","FEV1.Raw","FEF.25.75.Raw","ht_m",
              "sexnum","FEV1.pred","FVC.pred","FEF.25.75.pred","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","BMI")
alldata <- alldata[,colorder]
alldata <- alldata[order(alldata$MRN,alldata$Date),]

# create combined race/ethnicity
alldata$race_eth <- ifelse(alldata$Latino.a.=="TRUE","Hispanic",alldata$Race)

# get BMI percentile
alldata$age <- ifelse(is.na(alldata$Age.at.PFT),alldata$Age.At.Test..years.,alldata$Age.at.PFT)
alldata$age_bmi <- ifelse(alldata$age>20,20,alldata$age)
alldata$bmip = sds(alldata$BMI,
              age = alldata$age_bmi,
              sex = alldata$Sex, male = "Male", female =  "Female",
              ref = cdc.ref,
              item = "bmi",
              type = "perc")

# classify CFRD at each visit
alldata$cfrd_visit <- NA
alldata$cfrd_visit <- ifelse(is.na(alldata$X2.hour.Glucose),NA,ifelse(alldata$X2.hour.Glucose>=200,1,0))

# find people with CFRD at baseline
cfrdbase <- alldata[alldata$Date==alldata$`Date of first OGTT` & alldata$cfrd_visit==1,]
before_cfrd <- length(unique(alldata$MRN))
alldata <- alldata[!(alldata$MRN %in% cfrdbase$MRN),]
after_cfrd <- length(unique(alldata$MRN))

# number excluded with CFRD at baseline
nexcl_cfrd <- before_cfrd - after_cfrd

# create variable for CFRD groups (i.e., those who developed CFRD vs those who did not)
# and get date of first OGTT with CFRD
cfrdcheck <- alldata[alldata$cfrd_visit==1,c("MRN","Date","cfrd_visit")]
cfrdcheck <- cfrdcheck[order(cfrdcheck$MRN,desc(cfrdcheck$cfrd_visit)),]
cfrdcheck <- cfrdcheck[!is.na(cfrdcheck$MRN),]
cfrdcheck <- cfrdcheck %>% group_by(MRN) %>% filter(row_number() == 1)                              
colnames(cfrdcheck) <- c("MRN","Date of CFRD diagnosis","CFRD")      
alldata <- merge(alldata,cfrdcheck,by="MRN",all.x=T,all.y=T)
alldata$CFRD <- ifelse(is.na(alldata$CFRD),0,1)

# get baseline age
baseage <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","age")]
colnames(baseage) <- c("MRN","Base_age")
alldata <- merge(alldata,baseage,by="MRN",all.x=T,all.y=T)

# get baseline 1 hour and 2 hour glucose
basegluc <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","X1.hour.Glucose","X2.hour.Glucose")]
colnames(basegluc) <- c("MRN","Baseline_1hr_glucose","Baseline_2hr_glucose")
alldata <- merge(alldata,basegluc,by="MRN",all.x=T,all.y=T)

# dichotomize baseline 1 hour glucose
alldata$Baseline_1hr_glucose_155 <- ifelse(alldata$Baseline_1hr_glucose>=155,1,0)
alldata$Baseline_1hr_glucose_140 <- ifelse(alldata$Baseline_1hr_glucose>=140,1,0)

# dichotomize baseline 2 hour glucose
alldata$Baseline_2hr_glucose_140 <- ifelse(alldata$Baseline_2hr_glucose>=140,1,0)

# find date of last OGTT
lastogtt <- alldata[!is.na(alldata$Fasting.Glucose) | !is.na(alldata$X1.hour.Glucose) | !is.na(alldata$X2.hour.Glucose),
                    c("MRN","Date")]
lastogtt <- lastogtt[order(lastogtt$MRN,desc(lastogtt$Date)),]
lastogtt <- lastogtt %>% group_by(MRN) %>% filter(row_number() == 1)  
colnames(lastogtt) <- c("MRN","Date of last OGTT")
alldata <- merge(alldata,lastogtt,by="MRN",all.x = T,all.y=T)

# read in date of modulator use
mod <- read.csv("./Christine Chan/1 hour OGTT in CFRD/Data_raw/modulators.csv",na.strings = c(""," ",NA))
mod$Kalydeco.Start.Date <- as.Date(mod$Kalydeco.Start.Date,format="%m/%d/%Y")
mod$Orkambi.Start.Date <- as.Date(mod$Orkambi.Start.Date,format="%m/%d/%Y")
mod$Symdeko.Start.Date <- as.Date(mod$Symdeko.Start.Date,format="%m/%d/%Y")
mod$Trikafta.Start.Date <- as.Date(mod$Trikafta.Start.Date,format="%m/%d/%Y")
mod$modstart <- as.Date(NA)
mod$he_modstart <- as.Date(NA)
mod$me_modstart <- as.Date(NA)
for (i in 1:nrow(mod)) {
  mod[i,]$modstart <- 
    as.Date(pmin(mod[i,]$Kalydeco.Start.Date,mod[i,]$Orkambi.Start.Date,mod[i,]$Symdeko.Start.Date,mod[i,]$Trikafta.Start.Date,na.rm = T))
  mod[i,]$he_modstart <- as.Date(pmin(mod[i,]$Kalydeco.Start.Date,mod[i,]$Trikafta.Start.Date,na.rm = T))
  mod[i,]$me_modstart <- as.Date(pmin(mod[i,]$Orkambi.Start.Date,mod[i,]$Symdeko.Start.Date,na.rm = T))
}
modkeep <- mod[,c("MRN","modstart","he_modstart","me_modstart")]
alldata <- merge(alldata,modkeep,by="MRN",all.x = TRUE,all.y = FALSE)
alldata$onmod <- ifelse(!is.na(alldata$modstart) & alldata$modstart<=alldata$Date,1,
                        ifelse(!is.na(alldata$modstart) & alldata$modstart>alldata$Date,0,NA))
alldata$onmod <- ifelse(is.na(alldata$modstart) & is.na(alldata$onmod),0,alldata$onmod)

alldata$onhemod <- ifelse(!is.na(alldata$he_modstart) & alldata$he_modstart<=alldata$Date,1,
                        ifelse(!is.na(alldata$he_modstart) & alldata$he_modstart>alldata$Date,0,NA))
alldata$onhemod <- ifelse(is.na(alldata$he_modstart) & is.na(alldata$onhemod),0,alldata$onhemod)

alldata$onmemod <- ifelse(!is.na(alldata$me_modstart) & alldata$me_modstart<=alldata$Date,1,
                        ifelse(!is.na(alldata$me_modstart) & alldata$me_modstart>alldata$Date,0,NA))
alldata$onmemod <- ifelse(is.na(alldata$me_modstart) & is.na(alldata$onmemod),0,alldata$onmemod)


# for analyses about prediction of CFRD, we need to exclude those who only have one OGTT
# can use alldata for mixed models of PFTs and BMI
oneogtt <- alldata[alldata$`Date of first OGTT`==alldata$`Date of last OGTT`,]
multogtt <- alldata[!(alldata$MRN %in% oneogtt$MRN),]

# have CFRD indicator
# create variable for follow-up time
# in those who do not develop CFRD, this is the time between first and last OGTT, and they are censored
# for those who develop CFRD, this is time between first OGTT and diagnosis of CFRD
multogtt$Follow_up_time_yrs <- ifelse(multogtt$CFRD==1,(multogtt$`Date of CFRD diagnosis`-multogtt$`Date of first OGTT`)/365.25,
                           (multogtt$`Date of last OGTT`-multogtt$`Date of first OGTT`)/365.25)

# create categorical time
multogtt$cat_time <- as.factor(round_any(multogtt$Follow_up_time_yrs,0.5))
# need a time variable for mixed models
multogtt$time <- as.numeric((multogtt$Date - multogtt$`Date of first OGTT`)/365.25)
multogtt$cat_time2 <- as.factor(round_any(multogtt$time,0.5))

# get number of participants in each cohort
n_alldata <- length(unique(alldata$MRN))
n_multogtt <- length(unique(multogtt$MRN))
# number of participants in each cohort who developed CFRD
n_alldata_cfrd <-  length(unique(alldata[alldata$CFRD==1,]$MRN))
n_multogtt_cfrd <- length(unique(multogtt[multogtt$CFRD==1,]$MRN))

# create dataset with baseline only 
baseline_mult <- multogtt[multogtt$Date==multogtt$`Date of first OGTT`,]
baseline_mult$onmod_baseline <- as.factor(baseline_mult$onmod)
baseline_all <- alldata[alldata$Date==alldata$`Date of first OGTT`,]
baseline_all$onmod_baseline <- as.factor(baseline_all$onmod)
# find patients who were put on modulators during follow-up
evermod <- alldata %>% group_by(MRN) %>% summarise(max(onmod))
baseline_all <- merge(baseline_all,evermod,by="MRN",all.x = T, all.y = T)
baseline_all$modstarted_fup <- as.factor(ifelse(baseline_all$onmod_baseline==0 & baseline_all$`max(onmod)`==1,1,0))
baseline_mult <- merge(baseline_mult,evermod,by="MRN",all.x = T, all.y = F)
baseline_mult$modstarted_fup <- as.factor(ifelse(baseline_mult$onmod_baseline==0 & baseline_mult$`max(onmod)`==1,1,0))

# create multogtt with time <4 years since there is little data beyond that
multogtt_reduced <- multogtt[multogtt$time<=4,]

##############
# DESC STATS #
##############

# table of demographics in those with at least one pre-CFRD OGTT
demovars <- c("Sex","race_eth","age","genoRisk","Fasting.Glucose","X1.hour.Glucose","X2.hour.Glucose","onmod_baseline","modstarted_fup")
# Taking out these clinical variables - if they are to be added to table 1, need to figure out how
# because they come from PFT visits, not the same date as OGTT
#              "BMI","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","bmip")
t1_alldata <- CreateTableOne(data=baseline_all,vars=demovars)
t1_alldata <-  print(t1_alldata,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# table of demographics in those with at least one pre-CFRD OGTT by sex
t1_alldata_sex <- CreateTableOne(data=baseline_all,vars=demovars,strata="Sex")
t1_alldata_sex <-  print(t1_alldata_sex,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T)

# table of demographics in those with more than 1 OGTT
t1_multogtt <- CreateTableOne(data=baseline_mult,vars=c(demovars,"Follow_up_time_yrs"))
t1_multogtt <-  print(t1_multogtt,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# table of demographics in those with more than 1 OGTT by sex
t1_multogtt_sex <- CreateTableOne(data=baseline_mult,vars=demovars,strata="Sex")
t1_multogtt_sex <-  print(t1_multogtt_sex,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T)

# compare baseline glucose values in those who developed CFRD and those who did not
# added other vars too
gluctable <- CreateTableOne(baseline_mult,vars=demovars,strata="CFRD")
gluctable <-  print(gluctable,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = T)

########################
# LOGISTIC REGRESSIONS #
########################

# logistic regression of 1 hour and 2 hour glucose predicting cfrd
log1 <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose,family = "binomial")
or1 <- exp(cbind(OR = coef(log1), confint(log1)))
log1_adj <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose + Base_age + Sex,family = "binomial")
or1_adj <- exp(cbind(OR = coef(log1_adj), confint(log1_adj)))

# add interaction with sex
log1_adj_int <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose + Base_age + Sex + Sex*Baseline_1hr_glucose,family = "binomial")
or1_adj_int <- exp(cbind(OR = coef(log1_adj_int), confint(log1_adj_int)))

log1_cat <- glm(data=baseline_mult, CFRD~Baseline_1hr_glucose_155, family="binomial")
or1_cat <- exp(cbind(OR = coef(log1_cat), confint(log1_cat)))
log1_cat_adj <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose_155 + Base_age + Sex,family = "binomial")
or1_cat_adj <- exp(cbind(OR = coef(log1_cat_adj), confint(log1_cat_adj)))

log1_cat_140 <- glm(data=baseline_mult, CFRD~Baseline_1hr_glucose_140, family="binomial")
or1_cat_140 <- exp(cbind(OR = coef(log1_cat_140), confint(log1_cat_140)))
log1_cat_adj_140 <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose_140 + Base_age + Sex,family = "binomial")
or1_cat_adj_140 <- exp(cbind(OR = coef(log1_cat_adj_140), confint(log1_cat_adj_140)))

# add interaction with sex
log1_cat_adj_int <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose_155 + Base_age + Sex + Sex*Baseline_1hr_glucose_155
                        ,family = "binomial")
or1_cat_adj_int <- exp(cbind(OR = coef(log1_cat_adj_int), confint(log1_cat_adj_int)))

log2 <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose,family = "binomial")
or2 <- exp(cbind(OR = coef(log2), confint(log2)))

log2_adj <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose + Base_age + Sex,family = "binomial")
or2_adj <- exp(cbind(OR = coef(log2_adj), confint(log2_adj)))

# add interaction with sex
log2_adj_int <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose + Base_age + Sex + Sex*Baseline_2hr_glucose,family = "binomial")
or2_adj_int <- exp(cbind(OR = coef(log2_adj_int), confint(log2_adj_int)))


# ROC for 1 hour glucose
baseline_mult$pred_1hr <- predict(log1, type="response", data.frame=baseline_mult)
roc1 <- roc(data=baseline_mult, response = CFRD, predictor=X1.hour.Glucose)
coords1 <- coords(roc1, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

# ROC for 2 hour glucose
baseline_mult$pred_2hr <- predict(log2, type="response", data.frame=baseline_mult)
roc2 <- roc(data=baseline_mult, response = CFRD, predictor=X2.hour.Glucose)
coords2 <- coords(roc2, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

##############
# COX MODELS #
##############

# CPH model for baseline 1 hour glucose
cox1hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_1hr_glucose,data = baseline_mult)
# Diagnostics
d1 <- cox.zph(cox1hr)
#cox1hrt <- multogtt %>% finalfit("Surv(Follow_up_time_yrs,CFRD)","Baseline_1hr_glucose")

hr1hr5 <- round(exp(coef(cox1hr))^5,2)
hr1hr5_lo <- round(summary(cox1hr)$conf.int[3]^5,2)
hr1hr5_hi <- round(summary(cox1hr)$conf.int[4]^5,2)
hr1hr10 <- round(exp(coef(cox1hr))^10,2)
hr1hr10_lo <- round(summary(cox1hr)$conf.int[3]^10,2)
hr1hr10_hi <- round(summary(cox1hr)$conf.int[4]^10,2)

# CPH model for 2 hour glucose
cox2hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data = baseline_mult)
# Diagnostics
d2 <- cox.zph(cox2hr)
#cox2hrt <- multogtt %>% finalfit("Surv(Follow_up_time_yrs,CFRD)","Baseline_2hr_glucose")
# appears to violate PH
cox2hrint <- cox.zph(cox2hr,transform = function(Follow_up_time_yrs) log(Follow_up_time_yrs))
# log transforming time doesn't fix it
plot(cox2hrint)

hr2hr5 <- round(exp(coef(cox2hr))^5,2)
hr2hr5_lo <- round(summary(cox2hr)$conf.int[3]^5,2)
hr2hr5_hi <- round(summary(cox2hr)$conf.int[4]^5,2)
hr2hr10 <- round(exp(coef(cox2hr))^10,2)
hr2hr10_lo <- round(summary(cox2hr)$conf.int[3]^10,2)
hr2hr10_hi <- round(summary(cox2hr)$conf.int[4]^10,2)

# trying weighted Cox regression
cw1 <- coxphw(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data=baseline_mult)

# time dependent ROC
# one hour glucose
# year 1
tdroc11 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=1)
a <- tdroc11$ROC
tdroc11.youd <- with(a, which.max(sens+spec-1))
survroctab1_row1 <- c(round(a$grid[tdroc11.youd],2),
                     round(a$sens[tdroc11.youd],2),
                     round(a$spec[tdroc11.youd],2))
#  year 2
tdroc12 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=2)
a <- tdroc12$ROC
tdroc12.youd <- with(a, which.max(sens+spec-1))
survroctab1_row2 <- c(round(a$grid[tdroc12.youd],2),
                     round(a$sens[tdroc12.youd],2),
                     round(a$spec[tdroc12.youd],2))
# year 3
tdroc13 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=3)
a <- tdroc13$ROC
tdroc13.youd <- with(a, which.max(sens+spec-1))
survroctab1_row3 <- c(round(a$grid[tdroc13.youd],2),
                     round(a$sens[tdroc13.youd],2),
                     round(a$spec[tdroc13.youd],2))
# year 4
tdroc14 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=4)
a <- tdroc14$ROC
tdroc14.youd <- with(a, which.max(sens+spec-1))
survroctab1_row4 <- c(round(a$grid[tdroc14.youd],2),
                     round(a$sens[tdroc14.youd],2),
                     round(a$spec[tdroc14.youd],2))
# year 5
tdroc15 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=5)
a <- tdroc15$ROC
tdroc15.youd <- with(a, which.max(sens+spec-1))
survroctab1_row5 <- c(round(a$grid[tdroc15.youd],2),
                     round(a$sens[tdroc15.youd],2),
                     round(a$spec[tdroc15.youd],2))
survroctab1 <- rbind(survroctab1_row1,survroctab1_row2,survroctab1_row3,survroctab1_row4,survroctab1_row5)
rownames(survroctab1) <- c("1 year","2 years","3 years","4 years","5 years")
colnames(survroctab1) <- c("1 hour glucose","Sensitivity","Specificity")

# two hour glucose
# year 1
tdroc21 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=1)
a <- tdroc21$ROC
tdroc21.youd <- with(a, which.max(sens+spec-1))
survroctab2_row1 <- c(round(a$grid[tdroc21.youd],2),
                     round(a$sens[tdroc21.youd],2),
                     round(a$spec[tdroc21.youd],2))
#  year 2
tdroc22 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=2)
a <- tdroc22$ROC
tdroc22.youd <- with(a, which.max(sens+spec-1))
survroctab2_row2 <- c(round(a$grid[tdroc22.youd],2),
                     round(a$sens[tdroc22.youd],2),
                     round(a$spec[tdroc22.youd],2))
# year 3
tdroc23 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=3)
a <- tdroc23$ROC
tdroc23.youd <- with(a, which.max(sens+spec-1))
survroctab2_row3 <- c(round(a$grid[tdroc23.youd],2),
                     round(a$sens[tdroc23.youd],2),
                     round(a$spec[tdroc23.youd],2))
# year 4
tdroc24 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=4)
a <- tdroc24$ROC
tdroc24.youd <- with(a, which.max(sens+spec-1))
survroctab2_row4 <- c(round(a$grid[tdroc24.youd],2),
                     round(a$sens[tdroc24.youd],2),
                     round(a$spec[tdroc24.youd],2))
# year 5
tdroc25 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=5)
a <- tdroc25$ROC
tdroc25.youd <- with(a, which.max(sens+spec-1))
survroctab2_row5 <- c(round(a$grid[tdroc25.youd],2),
                     round(a$sens[tdroc25.youd],2),
                     round(a$spec[tdroc25.youd],2))
survroctab2 <- rbind(survroctab2_row1,survroctab2_row2,survroctab2_row3,survroctab2_row4,survroctab2_row5)
rownames(survroctab2) <- c("1 year","2 years","3 years","4 years","5 years")
colnames(survroctab2) <- c("2 hour glucose","Sensitivity","Specificity")

# add proc freqs of baseline 1 and 2 hour glucose at various cutoffs
temp <- baseline_mult
temp$baseline_1hr_glucose_128.14 <- as.factor(ifelse(!is.na(temp$Baseline_1hr_glucose) & temp$Baseline_1hr_glucose>128.14,1,0))
temp$baseline_1hr_glucose_141.02 <- as.factor(ifelse(!is.na(temp$Baseline_1hr_glucose) & temp$Baseline_1hr_glucose>141.02,1,0))
temp$baseline_1hr_glucose_153.06 <- as.factor(ifelse(!is.na(temp$Baseline_1hr_glucose) & temp$Baseline_1hr_glucose>153.06,1,0))
temp$baseline_2hr_glucose_48.04 <- as.factor(ifelse(!is.na(temp$Baseline_2hr_glucose) & temp$Baseline_2hr_glucose>48.04,1,0))
temp$baseline_2hr_glucose_102.05 <- as.factor(ifelse(!is.na(temp$Baseline_2hr_glucose) & temp$Baseline_2hr_glucose>102.05,1,0))

rocfreq <- CreateTableOne(data = temp, vars=c("baseline_1hr_glucose_128.14","baseline_1hr_glucose_141.02","baseline_1hr_glucose_153.06","baseline_2hr_glucose_48.04","baseline_2hr_glucose_102.05"))
rocfreq <- print(rocfreq)

################
# MIXED MODELS #
################

# mixed models - BMIp, PFTs
# first continuous time
mmcontbmip1 <- lme(bmip ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontbmip2 <- lme(bmip ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# testing categorical glucose
mmcontbmip1_cat <- lme(bmip ~ Baseline_1hr_glucose_155 + time + Baseline_1hr_glucose_155*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)

# categorical time
#mmcatbmip1 <- lme(bmip ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatbmip2 <- lme(bmip ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontbmip1_noint <- lme(bmip ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontbmip2_noint <- lme(bmip ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatbmip1_noint <- lme(bmip ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatbmip2_noint <- lme(bmip ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)


# FEV1.per.pred
# first continuous time
mmcontfev1 <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev2 <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfev1 <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfev2 <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfev1_noint <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev2_noint <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatfev1_noint <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatfev2_noint <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# FVC.per.pred
# first continuous time
mmcontfvc1 <- lme(FVC.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc2 <- lme(FVC.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfvc1 <- lme(FVC.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfvc2 <- lme(FVC.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfvc1_noint <- lme(FVC.per.pred ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc2_noint <- lme(FVC.per.pred ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatfvc1_noint <- lme(FVC.per.pred ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatfvc2_noint <- lme(FVC.per.pred ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# FEF.25.75.per.pred
# first continuous time
mmcontfef1 <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef2 <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfef1 <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#emtrends(mmcatfef1,pairwise ~ cat_time2, var="Baseline_1hr_glucose")
#mmcatfef2 <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfef1_noint <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef2_noint <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
#mmcatfef1_noint <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfef2_noint <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# mixed models adjusted for modulator use
mmcontbmip1_noint_mod <- lme(bmip ~ Baseline_1hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontbmip2_noint_mod <- lme(bmip ~ Baseline_2hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev1_noint_mod <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev2_noint_mod <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc1_noint_mod <- lme(FVC.per.pred ~ Baseline_1hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc2_noint_mod <- lme(FVC.per.pred ~ Baseline_2hr_glucose + time + onmod,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef1_noint_mod <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + time + onmod,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef2_noint_mod <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + time + onmod,
              random=~1|MRN,data=multogtt, na.action=na.omit)

# spaghetti plots
p1 <- ggplot(data=multogtt, aes(x=time,y=bmip,group=MRN,color=as.factor(onmod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p2 <- ggplot(data=multogtt, aes(x=time,y=FEV1.per.pred,group=MRN,color=as.factor(onmod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p3 <- ggplot(data=multogtt, aes(x=time,y=FVC.per.pred,group=MRN,color=as.factor(onmod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p4 <- ggplot(data=multogtt, aes(x=time,y=FEF.25.75.per.pred,group=MRN,color=as.factor(onmod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)

# spaghetti plots of HE mods
p5 <- ggplot(data=multogtt, aes(x=time,y=bmip,group=MRN,color=as.factor(onhemod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p6 <- ggplot(data=multogtt, aes(x=time,y=FEV1.per.pred,group=MRN,color=as.factor(onhemod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p7 <- ggplot(data=multogtt, aes(x=time,y=FVC.per.pred,group=MRN,color=as.factor(onhemod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p8 <- ggplot(data=multogtt, aes(x=time,y=FEF.25.75.per.pred,group=MRN,color=as.factor(onhemod))) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)

#######################
# KAPLAN MEIER MODELS #
#######################

# KM model of baseline glucose >155 and time to CFRD, excluding those with baseline 2 hour glucose >140
km_no140 <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_1hr_glucose_155,
                    data=baseline_mult[baseline_mult$Baseline_2hr_glucose<=140,])

# KM model of baseline glucose >155 and time to CFRD, including those with baseline 2 hour glucose >140
km_inc140 <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_1hr_glucose_155,data=baseline_mult)

# KM model of baseline glucose >155 and time to CFRD, including those with baseline 2 hour glucose >140, limit fup time
km_inc140_lt7 <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_1hr_glucose_155,data=baseline_mult[baseline_mult$Follow_up_time_yrs<7,])

# KM model of baseline two hour glucose >155 and time to CFRD
km_2hr <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_2hr_glucose_140,data=baseline_mult)

# KM model of baseline glucose >140 and time to CFRD, excluding those with baseline 2 hour glucose >140
km140_no140 <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_1hr_glucose_140,
                    data=baseline_mult[baseline_mult$Baseline_2hr_glucose<=140,])

# KM model of baseline glucose >140 and time to CFRD, including those with baseline 2 hour glucose >140
km140_inc140 <- survfit(Surv(Follow_up_time_yrs,CFRD)~Baseline_1hr_glucose_140,data=baseline_mult)

```

# Background

The purpose of this analysis is to examine whether baseline 1 hour and 2 hour OGTT glucose predicts development of CFRD and trajectories of BMI and PFTs in patients with cystic fibrosis.

# Methods

Predicted values for PFTs were calculated using the rspiro R package.  BMI percentile was calculated using the childsds R package.

The first OGTT with a non-missing 1 hour glucose was used as baseline.  All A1c and PFT data prior to that date were excluded.

CFRD was defined as a 2 hour glucose >=200.  `r nexcl_cfrd` participants with CFRD at baseline were excluded from analysis.

Two cohorts of participants were created: all participants were included in analyses of whether baseline glucose predicts trajectories of BMI and PFTs, but only participants with at least two OGTTs were included in analyses of whether baseline glucose predicts development of CFRD.  There were `r n_alldata` participants who had at least one OGTT.  Of these, `r n_alldata_cfrd` developed CFRD.  There were `r n_multogtt` participants who had more than one OGTT.  Of these, `r n_multogtt_cfrd` developed CFRD.

T-tests and chi-square tests were used to compare continuous and categorical variables by group.

Logistic regression was used to test whether baseline glucose predicts development of CFRD, using both unadjusted models and models adjusted for age and sex.  An interaction term between baseline glucose and sex tested whether the effect of baseline glucose differed in males and females (as in Shiekh et al., 2015).  Receiver operating curve (ROC) analyses were used to find the cutoffs of baseline 1 hour and 2 hour glucose that best predicted development of CFRD.

Cox proportional hazards models were used to test whether baseline glucose predicts time to development of CFRD.  Time-dependent ROC was used to find the cutoffs of baseline 1 hour and 2 hour glucose that best predicted time to develop CFRD at 1-5 years after baseline.  

Mixed-effects models were used to test whether baseline glucose predicts trajectories of BMI percentile and PFTs.  BMI and PFT measures were assigned to the nearest 1/2 year increment and time was treated as a categorical variable to allow non-linear trajectories over time.  These models were also adjusted for CFTR modulator use.  Modulator use was also categorized as highly effective (Kalydeko and Trikafta) or moderately effective (Orkambi or Symdeko) but the numbers of visits on highly effective modulators was small, so statistical power would be too low to adjsut for these categories separately.

# Results


## Table 1a.  Descriptive statistics for entire cohort.

```{r, echo=FALSE}
kable(t1_alldata)
```

\newpage

## Table 1b.  Descriptive statistics for participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(t1_multogtt)
```

\newpage

## Table 1c.  Descriptive statistics for entire cohort, by sex.

```{r, echo=FALSE}
kable(t1_alldata_sex)
```

\newpage

## Table 1d.  Descriptive statistics for participants with at least one follow-up OGTT, by sex.

```{r, echo=FALSE}
kable(t1_multogtt_sex)
```

\newpage

## Table 2.  Glucose values from baseline OGTT in those who developed CFRD vs. those who did not, among the participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(gluctable)
```

\newpage

## Table 3a.  Logistic regression - baseline 1 hour glucose and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1)$coefficients

or1
```

<br>

## Table 3b.  Logistic regression - baseline 1 hour glucose and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_adj)$coefficients

or1_adj
```

\newpage

## Table 3c.  Logistic regression - baseline 1 hour glucose and CFRD, adjusted for baseline age and sex, with interaction between sex and baseline 1 hour glucose.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_adj_int)$coefficients

or1_adj_int
```

<br>

## Table 3d.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat)$coefficients

or1_cat
```

\newpage

## Table 3e.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_adj)$coefficients

or1_cat_adj
```

<br>

## Table 3f.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD, adjusted for baseline age and sex, with an interaction between baseline 1 hour glucose and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_adj_int)$coefficients

or1_cat_adj_int
```

\newpage

## Table 3g.  Logistic regression - baseline 1 hour glucose (categorized as >=140 or <140) and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_140)$coefficients

or1_cat_140
```

## Table 3h.  Logistic regression - baseline 1 hour glucose (categorized as >=140 or <140) and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_adj_140)$coefficients

or1_cat_adj_140
```

<br>

\newpage

## Table 4a.  Logistic regression - baseline 2 hour glucose and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2)$coefficients

or2
```

<br>

## Table 4b.  Logistic regression - baseline 2 hour glucose and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2_adj)$coefficients

or2_adj
```

\newpage

## Table 4c.  Logistic regression - baseline 2 hour glucose and CFRD, adjusted for baseline age and sex, with an interaction between baseline 2 hour glucose and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2_adj_int)$coefficients

or2_adj_int
```

\newpage

## ROC analysis for baseline 1 hour glucose.

The AUC for the ROC was `r round(auc(roc1),4)`.

```{r, echo=FALSE}
plot.roc(roc1, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 1 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords1)
```

\newpage

## ROC analysis for baseline 2 hour glucose.

The AUC for the ROC was `r round(auc(roc2),4)`.

```{r, echo=FALSE}
plot.roc(roc2, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 2 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords2)
```

\newpage

## Cox proportional hazards model for baseline 1 hour glucose.

The hazard ratio (i.e., increase in the hazard of CFRD for a 1 mg/dL increase in glucose) is labeled "exp(coef)".

```{r, echo=FALSE,comment=""}
summary(cox1hr)
```

<br>

The HR for a 5 mg/dL increase in glucose is `r hr1hr5` (95% CI `r hr1hr5_lo`,`r hr1hr5_hi`).  The HR for a 10 mg/dL increase in glucose is `r hr1hr10` (95% CI `r hr1hr10_lo`,`r hr1hr10_hi`). 

\newpage

## Cox proportional hazards model for baseline 2 hour glucose.

The hazard ratio (i.e., increase in the hazard of CFRD for a 1 mg/dL increase in glucose) is labeled "exp(coef)".

```{r, echo=FALSE,comment=""}
summary(cox2hr)
```

The HR for a 5 mg/dL increase in glucose is `r hr2hr5` (95% CI `r hr2hr5_lo`,`r hr2hr5_hi`).  The HR for a 10 mg/dL increase in glucose is `r hr2hr10` (95% CI `r hr2hr10_lo`,`r hr2hr10_hi`).

\newpage

## Survival ROC for baseline 1 hour glucose.

The table below shows the 1 hour glucose values that maximize the Youden index at 1-5 years, along with the corresponding sensitivity and specificity.

```{r, echo=FALSE}
kable(survroctab1)
```

## Survival ROC for baseline 2 hour glucose.

The table below shows the 2 hour glucose values that maximize the Youden index at 1-5 years, along with the corresponding sensitivity and specificity.

```{r, echo=FALSE}
kable(survroctab2)
```

<br>

The table below shows the percentage of participants with baseline 1 hour or 2 hour OGTT glucose that exceeded the cutoffs identified in the survival ROC analysis above.

```{r, echo=FALSE}
kable(rocfreq)
```

\newpage

## Kaplan-Meier model of baseline one hour glucose >155 and time to CFRD, excluding those with baseline 2 hour glucose >140

The Kaplan-Meier plot for baseline one hour glucose >155 vs. CFRD and log-rank test p-value are below.  Participants with baseline 2 hour glucose >140 were excluded from this model.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km_no140)

ggsurvplot(km_no140,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))

```

\newpage

## Kaplan-Meier model of baseline one hour glucose >155 and time to CFRD, including those with baseline 2 hour glucose >140

The Kaplan-Meier plot for baseline one hour glucose >155 vs. CFRD and log-rank test p-value are below.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km_inc140)

ggsurvplot(km_inc140,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))
```

\newpage

## Kaplan-Meier model of baseline one hour glucose >140 and time to CFRD, excluding those with baseline 2 hour glucose >140

The Kaplan-Meier plot for baseline one hour glucose >140 vs. CFRD and log-rank test p-value are below.  Participants with baseline 2 hour glucose >140 were excluded from this model.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km140_no140)

ggsurvplot(km140_no140,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))

```

\newpage

## Kaplan-Meier model of baseline one hour glucose >140 and time to CFRD, including those with baseline 2 hour glucose >140

The Kaplan-Meier plot for baseline one hour glucose >140 vs. CFRD and log-rank test p-value are below.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km140_inc140)

ggsurvplot(km140_inc140,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))
```

\newpage

## Kaplan-Meier model of baseline one hour glucose >155 and time to CFRD, including those with baseline 2 hour glucose >140, time<7 years

The Kaplan-Meier plot for baseline one hour glucose >155 vs. CFRD and log-rank test p-value are below.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km_inc140_lt7)

ggsurvplot(km_inc140_lt7,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))
```

\newpage

## Kaplan-Meier model of baseline two hour glucose >140 and time to CFRD

The Kaplan-Meier plot for baseline two hour glucose >140 vs. CFRD and log-rank test p-value are below.  Hatchmarks indicate censoring times.

```{r, echo=FALSE}
surv_pvalue(km_2hr)

ggsurvplot(km_2hr,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"))
```


\newpage

## Mixed model of BMI-percentile over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontbmip1_noint)$tTable)
```

<br>

## Mixed model of BMI-percentile over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontbmip2_noint)$tTable)
```

<br>

## Mixed model of FEV1 % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfev1_noint)$tTable)
```

\newpage

## Mixed model of FEV1 % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfev2_noint)$tTable)
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfvc1_noint)$tTable)
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfvc2_noint)$tTable)
```

\newpage

## Mixed model of FEF 25-75 % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfef1_noint)$tTable)
```

<br>

## Mixed model of FEF 25-75 % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.  The p-values are in the first table and the coefficients are in the second table.  The coefficient for glucose can be interpreted as the change in FEF 25-75 % predicted for a 1 mg/dL increase in baseline 2 hour glucose.

```{r, echo=FALSE}
kable(summary(mmcontfef2_noint)$tTable)
```

\newpage

## Mixed model of BMI-percentile over time vs. baseline 1 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontbmip1_noint_mod)$tTable)
```

## Mixed model of BMI-percentile over time vs. baseline 2 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontbmip2_noint_mod)$tTable)
```

<br>

## Mixed model of FEV1 % predicted over time vs. baseline 1 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfev1_noint_mod)$tTable)
```

## Mixed model of FEV1 % predicted over time vs. baseline 2 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfev2_noint_mod)$tTable)
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 1 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfvc1_noint_mod)$tTable)
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 2 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfvc2_noint_mod)$tTable)
```

## Mixed model of FEF 25-75 % predicted over time vs. baseline 1 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(summary(mmcontfef1_noint_mod)$tTable)
```

<br>

## Mixed model of FEF 25-75 % predicted over time vs. baseline 2 hour glucose adjusted for modulator use

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.   The p-values are in the first table and the coefficients are in the second table.  The coefficient for glucose can be interpreted as the change in FEF 25-75 % predicted for a 1 mg/dL increase in baseline 2 hour glucose.

```{r, echo=FALSE}
kable(summary(mmcontfef2_noint_mod)$tTable)
```

\newpage

# Spaghetti plots

The plots below show the trajectories of outcomes over time.  The panel labelled "0" is for participants with baseline 1 hour glucose <155, and the panel labelled "1" is for participants with baseline 1 hour glucose >=155.  Lines are colored to indicate whether the participant was on modulators.

```{r, echo=FALSE, warning=F}
p1

p2

p3

p4
``` 

\newpage

The plots below show the trajectories of outcomes over time.  The panel labelled "0" is for participants with baseline 1 hour glucose <155, and the panel labelled "1" is for participants with baseline 1 hour glucose >=155.  Lines are colored to indicate whether the participant was on highly effective modulators (Trikafta or Kalydeco).

```{r, echo=FALSE, warning=F}
p5

p6

p7

p8
``` 

