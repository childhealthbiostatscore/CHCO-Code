---
title: "1 hour OGTT glucose in CFRD"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(knitr)
library(rspiro)
library(childsds)
library(tableone)
library(pROC)
library(OptimalCutpoints)
library(sjlabelled)
library(Hmisc)
library(pch)
library(coxphw)
library(finalfit)
library(survivalROC)
library(tdROC)
library(nlme)
library(plyr)
library(dplyr)
library(emmeans)

# read in separate data files

ogtt <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\ogtt.csv")
pft <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\pfts.csv")
a1c <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\a1c.csv")
demo <- read.csv("E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\demographics.csv")

# checking for dups
#t <- ogtt[,c("MRN","FName","LName")]
#t <- unique(t)
#ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# merge ogtt and demo
demo$FName <- NULL
demo$LName <- NULL
ogtt <- ogtt %>% group_by(MRN,Date.of.OGTT) %>% filter(row_number() == 1)
ogtt_demo <- merge(ogtt,demo,by="MRN",all.x = T, all.y = T)

# merge ogtt, demo, and A1c
ogtt_demo$Date <- ogtt_demo$Date.of.OGTT
ogtt_demo$Date.of.OGTT <- NULL
a1c$Date.of.OGTT <- NULL
a1c$Days.Between.A1C.and.OGTT <- NULL
a1c$Date <- a1c$Date.of.A1C
a1c$Date.of.A1C  <- NULL
a1c$FName <- NULL
a1c$LName <- NULL
a1c <- a1c %>% group_by(MRN,Date) %>% filter(row_number() == 1)
ogtt_demo_a1c <- merge(ogtt_demo,a1c,by=c("MRN","Date"),all.x=T,all.y=T)

# add in PFTs
pft$Date.of.OGTT <- NULL
pft$FName <- NULL
pft$LName <- NULL
pft$Date <- pft$Date.of.PFT
pft$Date.of.PFT <- NULL
# get predicted spirometry values
pft$FVC...Pred <- NULL
pft$FEV1...Pred <- NULL
pft$FEF.25.75...Pred <- NULL
pft$DOB <- as.Date(as.character(pft$DOB),format="%m/%d/%Y")
pft$ht_m <- pft$Height..cm./100
sex <- demo[,c("MRN","Sex")]
pft <- merge(pft, sex, by="MRN",all.x=T,all.y = F)
pft$sexnum <- ifelse(pft$Sex=="Male",1,2)
pft$FEV1.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEV1")
pft$FVC.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FVC")
pft$FEF.25.75.pred <- pred_GLI(age=pft$Age.at.PFT,height=pft$ht_m,gender=pft$sexnum,param="FEF2575")
pft$FEV1.per.pred <- (pft$FEV1.Raw / pft$FEV1.pred)*100
pft$FVC.per.pred <- (pft$FVC.Raw / pft$FVC.pred)*100
pft$FEF.25.75.per.pred <- (pft$FEF.25.75.Raw / pft$FEF.25.75.pred)*100
pft$Sex <- NULL
pft <- pft %>% group_by(MRN,Date) %>% filter(row_number() == 1)
alldata <- merge(ogtt_demo_a1c,pft,by=c("MRN","Date"),all.x=T,all.y=T)

# merge back all baseline characteristics
d <- alldata[,c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2")]
d <- d[!is.na(d$FName),]
d <- unique(d)
alldata$FName <- NULL
alldata$Latino.a. <- NULL
alldata$LName <- NULL
alldata$Sex <- NULL
alldata$Race <- NULL
alldata$Mutation.1 <- NULL
alldata$Mutation.2 <- NULL
alldata <- merge(alldata,d,by="MRN",all.x = T,all.y = T)

# checking for dups
#t <- alldata[,c("MRN","FName","LName")]
#t <- unique(t)
#ct <- t %>% group_by(LName,FName) %>% count(unique(MRN))

# find first OGTT
alldata$Date <- as.Date(as.character(alldata$Date),format="%m/%d/%Y")
o <- alldata[!is.na(alldata$Age.At.Test..years.) & !is.na(alldata$X1.hour.Glucose),c("MRN","Date")]
o <- o[order(o$MRN,o$Date),]
o <- o %>% group_by(MRN) %>% filter(row_number() == 1)
colnames(o) <- c("MRN","Date of first OGTT")
alldata <- merge(alldata,o,by="MRN",all.x = T,all.y = T)
alldata <- alldata[!is.na(alldata$`Date of first OGTT`),]

# checking ppts that Collin said had CFRD
col_check <- alldata[alldata$MRN %in% c(1006479,1053930,1078408,1136992,1289450,1339023,1413821,1695512,664400,
                      686476,707831,712676,739231,739460,787372,800007,848440,860181,875128,897478,905284,908966,
                      918124,932695,949042,952250,952252,825118),]
col_check <- col_check[order(col_check$MRN,col_check$Date),]
write.csv(col_check,"E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\check_cfrd.csv",na="",row.names = F)

# last 2 discrepant cases after fixing date issue
col_check2 <- alldata[alldata$MRN %in% c(686476,825118),]
col_check2 <- col_check2[order(col_check2$MRN,col_check2$Date),]
write.csv(col_check2,"E:\\Christine Chan\\1 hour OGTT in CFRD\\Data_raw\\check_cfrd2.csv",na="",row.names = F)

# remove all visits before first OGTT
#alldata$`Date of first OGTT` <- as.Date(as.character(alldata$`Date of first OGTT`),format="%m/%d/%Y")
alldata <- alldata[alldata$Date >= alldata$`Date of first OGTT`,]

# calculate BMI
alldata$BMI <- alldata$Weight..kg./((alldata$Height..cm./100)^2)

# reorder columns
colorder <- c("MRN","FName","LName","Sex","Race","Latino.a.","Mutation.1","Mutation.2","Date of first OGTT",
              "Date","Age.At.Test..years.","Fasting.Glucose","X1.hour.Glucose","X2.hour.Glucose","A1C",
              "DOB","Age.at.PFT","FVC.Raw","Height..cm.","Weight..kg.","FEV1.Raw","FEF.25.75.Raw","ht_m",
              "sexnum","FEV1.pred","FVC.pred","FEF.25.75.pred","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","BMI")
alldata <- alldata[,colorder]
alldata <- alldata[order(alldata$MRN,alldata$Date),]

# get BMI percentile
alldata$age <- ifelse(is.na(alldata$Age.at.PFT),alldata$Age.At.Test..years.,alldata$Age.at.PFT)
alldata$age_bmi <- ifelse(alldata$age>20,20,alldata$age)
alldata$bmip = sds(alldata$BMI,
              age = alldata$age_bmi,
              sex = alldata$Sex, male = "Male", female =  "Female",
              ref = cdc.ref,
              item = "bmi",
              type = "perc")

# classify CFRD at each visit
alldata$cfrd_visit <- NA
alldata$cfrd_visit <- ifelse(is.na(alldata$X2.hour.Glucose),NA,ifelse(alldata$X2.hour.Glucose>=200,1,0))

# find people with CFRD at baseline
cfrdbase <- alldata[alldata$Date==alldata$`Date of first OGTT` & alldata$cfrd_visit==1,]
before_cfrd <- length(unique(alldata$MRN))
alldata <- alldata[!(alldata$MRN %in% cfrdbase$MRN),]
after_cfrd <- length(unique(alldata$MRN))

# number excluded with CFRD at baseline
nexcl_cfrd <- before_cfrd - after_cfrd

# create variable for CFRD groups (i.e., those who developed CFRD vs those who did not)
# and get date of first OGTT with CFRD
cfrdcheck <- alldata[alldata$cfrd_visit==1,c("MRN","Date","cfrd_visit")]
cfrdcheck <- cfrdcheck[order(cfrdcheck$MRN,desc(cfrdcheck$cfrd_visit)),]
cfrdcheck <- cfrdcheck[!is.na(cfrdcheck$MRN),]
cfrdcheck <- cfrdcheck %>% group_by(MRN) %>% filter(row_number() == 1)                              
colnames(cfrdcheck) <- c("MRN","Date of CFRD diagnosis","CFRD")      
alldata <- merge(alldata,cfrdcheck,by="MRN",all.x=T,all.y=T)
alldata$CFRD <- ifelse(is.na(alldata$CFRD),0,1)

# get baseline age
baseage <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","age")]
colnames(baseage) <- c("MRN","Base_age")
alldata <- merge(alldata,baseage,by="MRN",all.x=T,all.y=T)

# get baseline 1 hour and 2 hour glucose
basegluc <- alldata[alldata$Date==alldata$`Date of first OGTT`,c("MRN","X1.hour.Glucose","X2.hour.Glucose")]
colnames(basegluc) <- c("MRN","Baseline_1hr_glucose","Baseline_2hr_glucose")
alldata <- merge(alldata,basegluc,by="MRN",all.x=T,all.y=T)

# dichotomize baseline 1 hour glucose
alldata$Baseline_1hr_glucose_155 <- ifelse(alldata$Baseline_1hr_glucose>=155,1,0)

# find date of last OGTT
lastogtt <- alldata[!is.na(alldata$Fasting.Glucose) | !is.na(alldata$X1.hour.Glucose) | !is.na(alldata$X2.hour.Glucose),
                    c("MRN","Date")]
lastogtt <- lastogtt[order(lastogtt$MRN,desc(lastogtt$Date)),]
lastogtt <- lastogtt %>% group_by(MRN) %>% filter(row_number() == 1)  
colnames(lastogtt) <- c("MRN","Date of last OGTT")
alldata <- merge(alldata,lastogtt,by="MRN",all.x = T,all.y=T)

# for analyses about prediction of CFRD, we need to exclude those who only have one OGTT
# can use alldata for mixed models of PFTs and BMI
oneogtt <- alldata[alldata$`Date of first OGTT`==alldata$`Date of last OGTT`,]
multogtt <- alldata[!(alldata$MRN %in% oneogtt$MRN),]

# have CFRD indicator
# create variable for follow-up time
# in those who do not develop CFRD, this is the time between first and last OGTT, and they are censored
# for those who develop CFRD, this is time between first OGTT and diagnosis of CFRD
multogtt$Follow_up_time_yrs <- ifelse(multogtt$CFRD==1,(multogtt$`Date of CFRD diagnosis`-multogtt$`Date of first OGTT`)/365.25,
                           (multogtt$`Date of last OGTT`-multogtt$`Date of first OGTT`)/365.25)

# create categorical time
multogtt$cat_time <- as.factor(round_any(multogtt$Follow_up_time_yrs,0.5))
# need a time variable for mixed models
multogtt$time <- as.numeric((multogtt$Date - multogtt$`Date of first OGTT`)/365.25)
multogtt$cat_time2 <- as.factor(round_any(multogtt$time,0.5))

# get number of participants in each cohort
n_alldata <- length(unique(alldata$MRN))
n_multogtt <- length(unique(multogtt$MRN))
# number of participants in each cohort who developed CFRD
n_alldata_cfrd <-  length(unique(alldata[alldata$CFRD==1,]$MRN))
n_multogtt_cfrd <- length(unique(multogtt[multogtt$CFRD==1,]$MRN))

# create dataset with baseline only 
baseline_mult <- multogtt[multogtt$Date==multogtt$`Date of first OGTT`,]
baseline_all <- alldata[alldata$Date==alldata$`Date of first OGTT`,]

# create multogtt with time <4 years since there is little data beyond that
multogtt_reduced <- multogtt[multogtt$time<=4,]

# table of demographics in those with at least one pre-CFRD OGTT
demovars <- c("Sex","Race","Latino.a.","age")
# Taking out these clinical variables - if they are to be added to table 1, need to figure out how
# because they come from PFT visits, not the same date as OGTT
#              "BMI","FEV1.per.pred","FVC.per.pred","FEF.25.75.per.pred","bmip")
t1_alldata <- CreateTableOne(data=baseline_all,vars=demovars)
t1_alldata <-  print(t1_alldata,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# table of demographics in those with more than OGTT
t1_multogtt <- CreateTableOne(data=baseline_mult,vars=c(demovars,"Follow_up_time_yrs"))
t1_multogtt <-  print(t1_multogtt,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = F)

# compare baseline glucose values in those who developed CFRD and those who did not
gluctable <- CreateTableOne(baseline_mult,vars=c("X1.hour.Glucose","X2.hour.Glucose"),strata="CFRD")
gluctable <-  print(gluctable,printToggle = F,varLabels=TRUE,missing=T,showAllLevels = T,test = T)

# logistic regression of 1 hour and 2 hour glucose predicting cfrd
log1 <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose,family = "binomial")
or1 <- exp(cbind(OR = coef(log1), confint(log1)))

log1_adj <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose + Base_age + Sex,family = "binomial")
or1_adj <- exp(cbind(OR = coef(log1_adj), confint(log1_adj)))

# add interaction with sex
log1_adj_int <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose + Base_age + Sex + Sex*Baseline_1hr_glucose,family = "binomial")
or1_adj_int <- exp(cbind(OR = coef(log1_adj_int), confint(log1_adj_int)))

log1_cat <- glm(data=baseline_mult, CFRD~Baseline_1hr_glucose_155, family="binomial")
or1_cat <- exp(cbind(OR = coef(log1_cat), confint(log1_cat)))

log1_cat_adj <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose_155 + Base_age + Sex,family = "binomial")
or1_cat_adj <- exp(cbind(OR = coef(log1_cat_adj), confint(log1_cat_adj)))

# add interaction with sex
log1_cat_adj_int <- glm(data = baseline_mult, CFRD~Baseline_1hr_glucose_155 + Base_age + Sex + Sex*Baseline_1hr_glucose_155
                        ,family = "binomial")
or1_cat_adj_int <- exp(cbind(OR = coef(log1_cat_adj_int), confint(log1_cat_adj_int)))


log2 <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose,family = "binomial")
or2 <- exp(cbind(OR = coef(log2), confint(log2)))

log2_adj <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose + Base_age + Sex,family = "binomial")
or2_adj <- exp(cbind(OR = coef(log2_adj), confint(log2_adj)))

# add interaction with sex
log2_adj_int <- glm(data = baseline_mult, CFRD~Baseline_2hr_glucose + Base_age + Sex + Sex*Baseline_2hr_glucose,family = "binomial")
or2_adj_int <- exp(cbind(OR = coef(log2_adj_int), confint(log2_adj_int)))


# ROC for 1 hour glucose
baseline_mult$pred_1hr <- predict(log1, type="response", data.frame=baseline_mult)
roc1 <- roc(data=baseline_mult, response = CFRD, predictor=X1.hour.Glucose)
coords1 <- coords(roc1, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

# ROC for 2 hour glucose
baseline_mult$pred_2hr <- predict(log2, type="response", data.frame=baseline_mult)
roc2 <- roc(data=baseline_mult, response = CFRD, predictor=X2.hour.Glucose)
coords2 <- coords(roc2, "b", ret=c("t","specificity","sensitivity"), best.method="youden") # default

# CPH model for baseline 1 hour glucose
cox1hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_1hr_glucose,data = baseline_mult)
# Diagnostics
d1 <- cox.zph(cox1hr)
cox1hrt <- multogtt %>% finalfit("Surv(Follow_up_time_yrs,CFRD)","Baseline_1hr_glucose")

# CPH model for 2 hour glucose
cox2hr <- coxph(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data = baseline_mult)
# Diagnostics
d2 <- cox.zph(cox2hr)
# appears to violate PH
cox2hrint <- cox.zph(cox2hr,transform = function(Follow_up_time_yrs) log(Follow_up_time_yrs))
# log transforming time doesn't fix it
plot(cox2hrint)

# trying weighted Cox regression
cw1 <- coxphw(Surv(Follow_up_time_yrs,CFRD) ~ Baseline_2hr_glucose,data=baseline_mult)

# time dependent ROC
# one hour glucose
# year 1
tdroc11 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=1)
a <- tdroc11$ROC
tdroc11.youd <- with(a, which.max(sens+spec-1))
survroctab1_row1 <- c(round(a$grid[tdroc11.youd],2),
                     round(a$sens[tdroc11.youd],2),
                     round(a$spec[tdroc11.youd],2))
#  year 2
tdroc12 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=2)
a <- tdroc12$ROC
tdroc12.youd <- with(a, which.max(sens+spec-1))
survroctab1_row2 <- c(round(a$grid[tdroc12.youd],2),
                     round(a$sens[tdroc12.youd],2),
                     round(a$spec[tdroc12.youd],2))
# year 3
tdroc13 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=3)
a <- tdroc13$ROC
tdroc13.youd <- with(a, which.max(sens+spec-1))
survroctab1_row3 <- c(round(a$grid[tdroc13.youd],2),
                     round(a$sens[tdroc13.youd],2),
                     round(a$spec[tdroc13.youd],2))
# year 4
tdroc14 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=4)
a <- tdroc14$ROC
tdroc14.youd <- with(a, which.max(sens+spec-1))
survroctab1_row4 <- c(round(a$grid[tdroc14.youd],2),
                     round(a$sens[tdroc14.youd],2),
                     round(a$spec[tdroc14.youd],2))
# year 5
tdroc15 <- tdROC(X=baseline_mult$Baseline_1hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=5)
a <- tdroc15$ROC
tdroc15.youd <- with(a, which.max(sens+spec-1))
survroctab1_row5 <- c(round(a$grid[tdroc15.youd],2),
                     round(a$sens[tdroc15.youd],2),
                     round(a$spec[tdroc15.youd],2))
survroctab1 <- rbind(survroctab1_row1,survroctab1_row2,survroctab1_row3,survroctab1_row4,survroctab1_row5)
rownames(survroctab1) <- c("1 year","2 years","3 years","4 years","5 years")
colnames(survroctab1) <- c("1 hour glucose","Sensitivity","Specificity")

# two hour glucose
# year 1
tdroc21 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=1)
a <- tdroc21$ROC
tdroc21.youd <- with(a, which.max(sens+spec-1))
survroctab2_row1 <- c(round(a$grid[tdroc21.youd],2),
                     round(a$sens[tdroc21.youd],2),
                     round(a$spec[tdroc21.youd],2))
#  year 2
tdroc22 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=2)
a <- tdroc22$ROC
tdroc22.youd <- with(a, which.max(sens+spec-1))
survroctab2_row2 <- c(round(a$grid[tdroc22.youd],2),
                     round(a$sens[tdroc22.youd],2),
                     round(a$spec[tdroc22.youd],2))
# year 3
tdroc23 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=3)
a <- tdroc23$ROC
tdroc23.youd <- with(a, which.max(sens+spec-1))
survroctab2_row3 <- c(round(a$grid[tdroc23.youd],2),
                     round(a$sens[tdroc23.youd],2),
                     round(a$spec[tdroc23.youd],2))
# year 4
tdroc24 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=4)
a <- tdroc24$ROC
tdroc24.youd <- with(a, which.max(sens+spec-1))
survroctab2_row4 <- c(round(a$grid[tdroc24.youd],2),
                     round(a$sens[tdroc24.youd],2),
                     round(a$spec[tdroc24.youd],2))
# year 5
tdroc25 <- tdROC(X=baseline_mult$Baseline_2hr_glucose,Y=baseline_mult$Follow_up_time_yrs,delta=baseline_mult$CFRD,tau=5)
a <- tdroc25$ROC
tdroc25.youd <- with(a, which.max(sens+spec-1))
survroctab2_row5 <- c(round(a$grid[tdroc25.youd],2),
                     round(a$sens[tdroc25.youd],2),
                     round(a$spec[tdroc25.youd],2))
survroctab2 <- rbind(survroctab2_row1,survroctab2_row2,survroctab2_row3,survroctab2_row4,survroctab2_row5)
rownames(survroctab2) <- c("1 year","2 years","3 years","4 years","5 years")
colnames(survroctab2) <- c("2 hour glucose","Sensitivity","Specificity")

# mixed models - BMIp, PFTs
# first continuous time
mmcontbmip1 <- lme(bmip ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontbmip2 <- lme(bmip ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# testing categorical glucose
mmcontbmip1_cat <- lme(bmip ~ Baseline_1hr_glucose_155 + time + Baseline_1hr_glucose_155*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)

# categorical time
#mmcatbmip1 <- lme(bmip ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatbmip2 <- lme(bmip ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontbmip1_noint <- lme(bmip ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontbmip2_noint <- lme(bmip ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatbmip1_noint <- lme(bmip ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatbmip2_noint <- lme(bmip ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)


# FEV1.per.pred
# first continuous time
mmcontfev1 <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev2 <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfev1 <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfev2 <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfev1_noint <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfev2_noint <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatfev1_noint <- lme(FEV1.per.pred ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatfev2_noint <- lme(FEV1.per.pred ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# FVC.per.pred
# first continuous time
mmcontfvc1 <- lme(FVC.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc2 <- lme(FVC.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfvc1 <- lme(FVC.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfvc2 <- lme(FVC.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfvc1_noint <- lme(FVC.per.pred ~ Baseline_1hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfvc2_noint <- lme(FVC.per.pred ~ Baseline_2hr_glucose + time,random=~1|MRN,data=multogtt, na.action=na.omit)
mmcatfvc1_noint <- lme(FVC.per.pred ~ Baseline_1hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
mmcatfvc2_noint <- lme(FVC.per.pred ~ Baseline_2hr_glucose + cat_time2,random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# FEF.25.75.per.pred
# first continuous time
mmcontfef1 <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + time + Baseline_1hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef2 <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + time + Baseline_2hr_glucose*time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
# categorical time
#mmcatfef1 <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + cat_time2 + Baseline_1hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#emtrends(mmcatfef1,pairwise ~ cat_time2, var="Baseline_1hr_glucose")
#mmcatfef2 <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + cat_time2 + Baseline_2hr_glucose*cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
# models without interaction
mmcontfef1_noint <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
mmcontfef2_noint <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + time,
              random=~1|MRN,data=multogtt, na.action=na.omit)
#mmcatfef1_noint <- lme(FEF.25.75.per.pred ~ Baseline_1hr_glucose + cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)
#mmcatfef2_noint <- lme(FEF.25.75.per.pred ~ Baseline_2hr_glucose + cat_time2,
#              random=~1|MRN,data=multogtt[multogtt$cat_time2 != 5.5,], na.action=na.omit)

# spaghetti plots
p1 <- ggplot(data=multogtt, aes(x=time,y=bmip,group=MRN)) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p2 <- ggplot(data=multogtt, aes(x=time,y=FEV1.per.pred,group=MRN)) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p3 <- ggplot(data=multogtt, aes(x=time,y=FVC.per.pred,group=MRN)) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)
p4 <- ggplot(data=multogtt, aes(x=time,y=FEF.25.75.per.pred,group=MRN)) + geom_line() + facet_grid(. ~ Baseline_1hr_glucose_155)



```

# Background

The purpose of this analysis is to examine whether baseline 1 hour and 2 hour OGTT glucose predicts development of CFRD and trajectories of BMI and PFTs in patients with cystic fibrosis.

# Methods

Predicted values for PFTs were calculated using the rspiro R package.  BMI percentile was calculated using the childsds R package.

The first OGTT with a non-missing 1 hour glucose was used as baseline.  All A1c and PFT data prior to that date were excluded.

CFRD was defined as a 2 hour glucose >=200.  `r nexcl_cfrd` participants with CFRD at baseline were excluded from analysis.

Two cohorts of participants were created: all participants were included in analyses of whether baseline glucose predicts trajectories of BMI and PFTs, but only participants with at least two OGTTs were included in analyses of whether baseline glucose predicts development of CFRD.  There were `r n_alldata` participants who had at least one OGTT.  Of these, `r n_alldata_cfrd` developed CFRD.  There were `r n_multogtt` participants who had more than one OGTT.  Of these, `r n_multogtt_cfrd` developed CFRD.

T-tests and chi-square tests were used to compare continuous and categorical variables by group.

Logistic regression was used to test whether baseline glucose predicts development of CFRD, using both unadjusted models and models adjusted for age and sex.  An interaction term between baseline glucose and sex tested whether the effect of baseline glucose differed in males and females (as in Shiekh et al., 2015).  Receiver operating curve (ROC) analyses were used to find the cutoffs of baseline 1 hour and 2 hour glucose that best predicted development of CFRD.

Cox proportional hazards models were used to test whether baseline glucose predicts time to development of CFRD.  However, baseline 2 hour glucose did not pass the check of the assumption of proportional hazards, meaning that baseline 2 hour glucose had differing effects on the hazard of developing CFRD over time.  For this reason, a weighted Cox model, which averages the effect of baseline 2 hour glucose over time, was used.  Time-dependent ROC was used to find the cutoffs of baseline 1 hour and 2 hour glucose that best predicted time to develop CFRD at 1-5 years after baseline.  ROC analyses for weighted Cox proportional hazards models have not been developed; therefore, a regular Cox model was used for baseline 2 hour glucose even though the proportionality assumption was violated.  

Mixed-effects models were used to test whether baseline glucose predicts trajectories of BMI percentile and PFTs.  BMI and PFT measures were assigned to the nearest 1/2 year increment and time was treated as a categorical variable to allow non-linear trajectories over time.

# Results


## Table 1a.  Descriptive statistics for entire cohort.

```{r, echo=FALSE}
kable(t1_alldata)
```

\newpage

## Table 1b.  Descriptive statistics for participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(t1_multogtt)
```

<br>

## Table 2.  Glucose values from baseline OGTT in those who developed CFRD vs. those who did not, among the participants with at least one follow-up OGTT.

```{r, echo=FALSE}
kable(gluctable)
```

\newpage

## Table 3a.  Logistic regression - baseline 1 hour glucose and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1)$coefficients

or1
```

<br>

## Table 3b.  Logistic regression - baseline 1 hour glucose and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_adj)$coefficients

or1_adj
```

\newpage

## Table 3c.  Logistic regression - baseline 1 hour glucose and CFRD, adjusted for baseline age and sex, with interaction between sex and baseline 1 hour glucose.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_adj_int)$coefficients

or1_adj_int
```

<br>

## Table 3d.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat)$coefficients

or1_cat
```

\newpage

## Table 3e.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_adj)$coefficients

or1_cat_adj
```

<br>

## Table 3f.  Logistic regression - baseline 1 hour glucose (categorized as >=155 or <155) and CFRD, adjusted for baseline age and sex, with an interaction between baseline 1 hour glucose and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log1_cat_adj_int)$coefficients

or1_cat_adj_int
```

\newpage

## Table 4a.  Logistic regression - baseline 2 hour glucose and CFRD.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2)$coefficients

or2
```

<br>

## Table 4b.  Logistic regression - baseline 2 hour glucose and CFRD, adjusted for baseline age and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2_adj)$coefficients

or2_adj
```

\newpage

## Table 4c.  Logistic regression - baseline 2 hour glucose and CFRD, adjusted for baseline age and sex, with an interaction between baseline 2 hour glucose and sex.

The column in the first table labelled "Pr(>|Z|)" contains the p-values for the terms in the model.  The second table contains the odds ratios (i.e., increase in odds of developing CFRD for a 1 mg/dL increase in glucose).

```{r, echo=FALSE}
summary(log2_adj_int)$coefficients

or2_adj_int
```

\newpage

## ROC analysis for baseline 1 hour glucose.

The AUC for the ROC was `r round(auc(roc1),4)`.

```{r, echo=FALSE}
plot.roc(roc1, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 1 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords1)
```

\newpage

## ROC analysis for baseline 2 hour glucose.

The AUC for the ROC was `r round(auc(roc2),4)`.

```{r, echo=FALSE}
plot.roc(roc2, legacy.axes=F, xlim=c(1,0), ylim=c(0,1))
```

The threshold of 2 hour glucose that maximized the Youden index, along with the corresponding sensitivity and specificity, are shown below.

```{r, echo=FALSE}
kable(coords2)
```

\newpage

## Cox proportional hazards model for baseline 1 hour glucose.

The table below shows the hazard ratio (i.e., increase in the hazard of CFRD for a 1 mg/dL increase in glucose) and associated p-value.

```{r, echo=FALSE}
kable(cox1hrt[,1:4])
```

<br>

## Weighted Cox proportional hazards model for baseline 2 hour glucose.

The column labeled "exp(coef)" is the hazard ratio for a 1 mg/dL increase in glucose.  The p-value is `r cw1$prob`.

```{r, echo=FALSE}
print(cw1)
```

\newpage

## Survival ROC for baseline 1 hour glucose.

The table below shows the 1 hour glucose values that maximize the Youden index at 1-5 years, along with the corresponding sensitivity and specificity.

```{r, echo=FALSE}
kable(survroctab1)
```

<br>

## Survival ROC for baseline 2 hour glucose.

The table below shows the 2 hour glucose values that maximize the Youden index at 1-5 years, along with the corresponding sensitivity and specificity.

```{r, echo=FALSE}
kable(survroctab2)
```

\newpage

## Mixed model of BMI-percentile over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontbmip1_noint))
```

<br>

## Mixed model of BMI-percentile over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontbmip2_noint))
```

<br>

## Mixed model of FEV1 % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontfev1_noint))
```

\newpage

## Mixed model of FEV1 % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontfev2_noint))
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontfvc1_noint))
```

<br>

## Mixed model of FVC % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcatfvc2_noint))
```

\newpage

## Mixed model of FEF 25-75 % predicted over time vs. baseline 1 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontfef1_noint))
```

<br>

## Mixed model of FEF 25-75 % predicted over time vs. baseline 2 hour glucose

The baseline glucose term can be interpreted as the effect of baseline glucose on the change in the outcome over time.

```{r, echo=FALSE}
kable(anova.lme(mmcontfef2_noint))
```

\newpage

# Spaghetti plots

The plots below show the trajectories of outcomes over time.  The panel labelled "0" is for participants with baseline 1 hour glucose <155, and the panel labelled "1" is for participants with baseline 1 hour glucose >=155.

```{r, echo=FALSE, warning=F}
p1

p2

p3

p4
``` 
