---
title: "CF Data Registry Analysis"
author: "Casey Sakamoto"
date: "3/18/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(Hmisc)
library(readr)
library(knitr)
library(table1)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S://Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data load in, include=FALSE}
setwd("S://Laura/Peds Endo/Christine Chan/CF registry data")
# load in data 
CFF19_Demog <- read_csv("CFF19_DemogCFDiag_Del1.csv")
CFF19_Annualized <- read_csv("CFF19_Annualized_Del1.csv")
CFF19_CareEpisodes <- read_csv("CFF19_CareEpisodes_Del1.csv")
CFF19_encounters <- read_csv("CFF19_encountersMerged_Del1.csv")

```

```{r aim 1 code, include=FALSE}
# CFRD_status:
# 1	Normal Glucose Metabolism (includes normal, random, fasting, or OGTT)
# 2	Impaired Glucose Tolerance (FBG < 126, 2-h PG 140-199)
# 3	CFRD with or without fasting hyperglycemia ( 2-h PG >= 200)
# 4	Type 1 Diabetes
# 5	Type 2 Diabetes

# make a visit variable to iterate through
CFF19_encounters = CFF19_encounters %>% group_by(eDWID) %>% mutate(visit = row_number()) %>% ungroup()

# idea is to grab the lowest visit number that a subject has cfrd, then they have cfrd for the remainder of the visits
cfrd_status = CFF19_encounters %>% group_by(eDWID) %>% 
  filter(cfrd_status == 3) %>%
  mutate(cfrd_incident = case_when(visit == min(visit) ~ 1,
                                   TRUE ~ 0),
         incident_visit = min(visit)) %>% ungroup()

CFF19_encounters = full_join(CFF19_encounters, cfrd_status) %>% group_by(eDWID) %>% fill(incident_visit, .direction = "downup")
CFF19_encounters = CFF19_encounters %>% group_by(eDWID) %>% 
  mutate(cfrd_outcome = case_when(visit >= incident_visit ~ 1,
                                  TRUE ~ 0))
# prevalence/incidence
describe(CFF19_encounters$cfrd_outcome)
describe(CFF19_encounters$cfrd_incident)
CFF19_encounters = CFF19_encounters %>% mutate(cfrd_incident = ifelse(is.na(cfrd_incident), 0, cfrd_incident))
# data table with one row per subject year
cfrd_prevalence = CFF19_encounters %>% select(eDWID, reviewyear, cfrd_outcome, cfrd_incident) %>% distinct()
cfrd_prevalence = cfrd_prevalence %>% group_by(reviewyear, eDWID) %>% filter(cfrd_incident == max(cfrd_incident))

aim1_prev = cfrd_prevalence %>% group_by(reviewyear) %>% summarise(`CFRD Prevalence` = mean(cfrd_outcome),
                                                        `CFRD Incidence` = mean(cfrd_incident)*1000)
aim1_prev = aim1_prev %>% rename(`Review Year` = reviewyear)
rm(cfrd_status)



# combine data into one set
analysis = full_join(cfrd_prevalence, CFF19_Annualized, by = c("eDWID", "reviewyear" = "ReviewYear")) %>% distinct()
analysis = full_join(CFF19_Demog, analysis) %>% distinct()
# analysis = full_join(analysis, CFF19_CareEpisodes) %>% distinct()
analysis = analysis %>% select(eDWID, reviewyear,cfrd_outcome, cfrd_incident, Age_YrEnd, Gender, Race1:Race6, Hispanicrace, Diagnosis_year, 
                               Primarycauseofdeath, patient_education:pregnancy_outcome, smoking:smoking_household,family_income, #demog
                               A_FEV1, A_FVC,   NumPulmExacerbation,  Any_pe_assessment:A_medscurrentepisode7, # pulm function
                               A_pseudomonasaeruginosa, A_burkho_complex, 
                               A_othermicroorganisms1:A_othermicroorganisms2, A_fungalyeast1:A_fungalyeast3, # microbiome
                               MutClass:F508, A_IsOnEnzymes, # pancreas
                               NumHt:A_WHO_whz, A_salt_supplement:A_cf_vitamins, # nutrition/bmi
                               A_dornasealfa, A_PrimaryAirClear, A_bronchodilators1:A_bronchodilatorsinhaled5, oxygen_therapy, A_corticosteroids1:A_corticosteroids3,
                               A_pulmonarycomplications1:A_pulmonarycomplications5, A_othercomplications9, A_hepatobiliary1_3:A_cirrhosiscomplications7) 

# make time periods and age groups
# also label and factor cat variables/ clean up dataset
analysis = analysis %>% mutate(year_cat = case_when(reviewyear < 2010 ~ "2003-2009",
                                                    reviewyear < 2014 & reviewyear >= 2010 ~ "2010-2013",
                                                    reviewyear >= 2014 ~ "2014-2018"),
                               age_cat = case_when(Age_YrEnd < 10 ~ "< 10",
                                                   Age_YrEnd < 20 & Age_YrEnd >= 10 ~ "10-20",
                                                   Age_YrEnd < 30 & Age_YrEnd >= 20 ~ "20-30",
                                                   Age_YrEnd < 40 & Age_YrEnd >= 30 ~ "30-40",
                                                   Age_YrEnd < 50 & Age_YrEnd >= 40 ~ "40-50",
                                                   Age_YrEnd < 60 & Age_YrEnd >= 50 ~ "50-60",
                                                   Age_YrEnd < 70 & Age_YrEnd >= 60 ~ "60-70",
                                                   Age_YrEnd < 80 & Age_YrEnd >= 70 ~ "70-80",
                                                   Age_YrEnd >= 80 & Age_YrEnd < 90 ~ "80-90"),
                               race = case_when(Race1 == 1 ~ "White",
                                                Race2 == 1 ~ "Black or African American",
                                                Race3 == 1 ~ "American Indian or Alaska Native",
                                                Race4 == 1 ~ "Asian", 
                                                Race5 == 1 ~ "Native Hawaiian or Other Pacific Islander")) %>% select(-(Race1:Race6))

analysis$year_cat = factor(analysis$year_cat, levels = c("2003-2009", "2010-2013", "2014-2018"))
analysis$age_cat = factor(analysis$age_cat, levels = c("< 10", "10-20", "20-30", "30-40", "40-50", "50-60", "60-70", "70-80", "80-90"))
analysis$Hispanicrace = factor(analysis$Hispanicrace, levels = c(1,2), labels = c("Hispanic Origin", "No Hispanic Origin"))

# aggregate variables based on year and subj
# first numerical variables (we'll avg them)
num_vars = analysis %>% cbind(Age_YrEnd, A_FEV1, A_FVC, NumPulmExacerbation, A_bmivalue, A_bmipercentile)
test = aggregate(A_bmipercentile ~ year_cat + as.factor(eDWID),data = analysis, mean)
```
eDWID, reviewyear,cfrd_outcome, cfrd_incident, Age_YrEnd, Gender, Race1:Race6, Hispanicrace, Diagnosis_year, 
                               Primarycauseofdeath, patient_education:pregnancy_outcome, smoking:smoking_household,family_income, #demog
                               A_FEV1, A_FVC,   NumPulmExacerbation,  Any_pe_assessment:A_medscurrentepisode7, # pulm function
                               A_pseudomonasaeruginosa, A_burkho_complex, 
                               A_othermicroorganisms1:A_othermicroorganisms2, A_fungalyeast1:A_fungalyeast3, # microbiome
                               MutClass:F508, A_IsOnEnzymes, # pancreas
                               NumHt:A_WHO_whz, A_salt_supplement:A_cf_vitamins, # nutrition/bmi
                               A_dornasealfa, A_PrimaryAirClear, A_bronchodilators1:A_bronchodilatorsinhaled5, oxygen_therapy, A_corticosteroids1:A_corticosteroids3,
                               A_pulmonarycomplications1:A_pulmonarycomplications5, A_othercomplications9, A_hepatobiliary1_3:A_cirrhosiscomplications7


NOTE: Incomplete data dictionary:
Important ones:
f508

Less so:
primarycauseofdeath: what is 0 and 1 (assuming alive and something else?)
patienteducation/parenteducation: cant find codes
familyincome


```{r Aim 1 Prev}
kable(aim1_prev, digits = 3)
```
Incidence per year will is estimated as the number of incident CFRD diagnoses per 1,000 person-years of longitudinal data, with prevalent cases excluded.



```{r table1}
# create a rough table1 by year_cat and cfrd status? to look at patient characteristics
cfrd_table1 = table1(~ Gender + age_cat + race + Hispanicrace + as.factor(A_IsOnEnzymes) + MutClass + as.factor(F508) + A_FEV1 + NumPulmExacerbation +
                       A_bmivalue + A_bmipercentile + as.factor(A_pseudomonasaeruginosa) + as.factor(A_burkho_complex) +
                       as.factor(A_othermicroorganisms2) + as.factor(A_fungalyeast1) + as.factor(A_fungalyeast2) +  | year_cat*as.factor(cfrd_outcome),
                     
                     data = analysis)



cfrd_table1
```