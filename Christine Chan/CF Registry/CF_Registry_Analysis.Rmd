---
title: "CF Data Registry Analysis"
author: "Casey Sakamoto"
date: "3/18/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(Hmisc)
library(readr)
library(knitr)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S://Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
}
knitr::opts_knit$set(root.dir = home_dir)
```

```{r data load in, include=FALSE}
setwd("S://Laura/Peds Endo/Christine Chan/CF registry data")
# load in data 
CFF19_Demog <- read_csv("CFF19_DemogCFDiag_Del1.csv")
CFF19_Annualized <- read_csv("CFF19_Annualized_Del1.csv")
CFF19_CareEpisodes <- read_csv("CFF19_CareEpisodes_Del1.csv")
CFF19_encounters <- read_csv("CFF19_encountersMerged_Del1.csv")

CFF19_Annualized$bmi
```

```{r aim 1 code, include=FALSE}
# CFRD_status:
# 1	Normal Glucose Metabolism (includes normal, random, fasting, or OGTT)
# 2	Impaired Glucose Tolerance (FBG < 126, 2-h PG 140-199)
# 3	CFRD with or without fasting hyperglycemia ( 2-h PG >= 200)
# 4	Type 1 Diabetes
# 5	Type 2 Diabetes

# make a visit variable to iterate through
CFF19_encounters = CFF19_encounters %>% group_by(eDWID) %>% mutate(visit = row_number()) %>% ungroup()

# idea is to grab the lowest visit number that a subject has cfrd, then they have cfrd for the remainder of the visits
cfrd_status = CFF19_encounters %>% group_by(eDWID) %>% 
  filter(cfrd_status == 3) %>%
  mutate(cfrd_incident = case_when(visit == min(visit) ~ 1,
                                   TRUE ~ 0),
         incident_visit = min(visit)) %>% ungroup()

CFF19_encounters = full_join(CFF19_encounters, cfrd_status) %>% group_by(eDWID) %>% fill(incident_visit, .direction = "downup")
CFF19_encounters = CFF19_encounters %>% group_by(eDWID) %>% 
  mutate(cfrd_outcome = case_when(visit >= incident_visit ~ 1,
                                  TRUE ~ 0))
# prevalence/incidence
describe(CFF19_encounters$cfrd_outcome)
describe(CFF19_encounters$cfrd_incident)
CFF19_encounters = CFF19_encounters %>% mutate(cfrd_incident = ifelse(is.na(cfrd_incident), 0, cfrd_incident))
# data table with one row per subject year
cfrd_prevalence = CFF19_encounters %>% select(eDWID, reviewyear, cfrd_outcome, cfrd_incident) %>% distinct()
cfrd_prevalence = cfrd_prevalence %>% group_by(reviewyear, eDWID) %>% filter(cfrd_incident == max(cfrd_incident))

aim1_prev = cfrd_prevalence %>% group_by(reviewyear) %>% summarise(`CFRD Prevalence` = mean(cfrd_outcome),
                                                        `CFRD Incidence` = mean(cfrd_incident)*1000)
aim1_prev = aim1_prev %>% rename(`Review Year` = reviewyear)
rm(cfrd_status)
```

In Aim 1, we will estimate:
the prevalence of CFRD at each year as the proportion of patients with CFRD.

Incidence per year will be estimated as the number of incident CFRD diagnoses per 1,000 person-years of longitudinal data, with prevalent cases excluded.

To assess the associations of individual variables (e.g., sex, race/ethnicity, number of prednisone prescriptions) with CFRD within a given year, t-tests and Chi-squared tests will be used for continuous and categorical variables respectively.

To test whether these univariate relationships differ between years, a mixed-effects logistic regression model with an interaction effect for year and CFRD status will be fit, and significance of the interaction effect from the model assessed with ANOVA will be used to detect a difference in effect between years. 

To evaluate the independent associations of these variables with CFRD, a mixed effects logistic regression model with variables selected by Least Absolute Shrinkage Selection Operator (LASSO) or Elastic Net will be used to assess which if any variables are associated with CFRD. The model will be tuned and evaluated based on cross-validated Area Under the Curve of the Receiver Operating Characteristic (ROC-AUC). From this model, odds ratios and their 95% CIs will be calculated to interpret the results. 


```{r Aim 1 Prev}
kable(aim1_prev, digits = 3)
```
Incidence per year will is estimated as the number of incident CFRD diagnoses per 1,000 person-years of longitudinal data, with prevalent cases excluded.

To assess the associations of individual variables (e.g., sex, race/ethnicity, number of prednisone prescriptions) with CFRD within a given year, t-tests and Chi-squared tests will be used for continuous and categorical variables respectively.-- use annualized data and combine with the outcome for easy 1 subjvis/yr
```{r ttests}
# combine data into one set
test = full_join(cfrd_prevalence, CFF19_Annualized, by = c("eDWID", "reviewyear" = "ReviewYear")) %>% distinct()
```


To test whether these univariate relationships differ between years, a mixed-effects logistic regression model with an interaction effect for year and CFRD status will be fit, and significance of the interaction effect from the model assessed with ANOVA will be used to detect a difference in effect between years. 

To evaluate the independent associations of these variables with CFRD, a mixed effects logistic regression model with variables selected by Least Absolute Shrinkage Selection Operator (LASSO) or Elastic Net will be used to assess which if any variables are associated with CFRD. The model will be tuned and evaluated based on cross-validated Area Under the Curve of the Receiver Operating Characteristic (ROC-AUC). From this model, odds ratios and their 95% CIs will be calculated to interpret the results. 