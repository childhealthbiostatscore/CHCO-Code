---
title: "CF Data Registry Analysis"
author: "Casey Sakamoto"
date: "3/18/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(Hmisc)
library(readr)

knitr::opts_chunk$set(echo = FALSE)
if(Sys.info()["sysname"] == "Windows"){
  home_dir = "S://Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Linux"){
  home_dir = "~/UCD/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
} else if (Sys.info()["sysname"] == "Darwin"){
  home_dir = "/Volumes/PEDS/RI Biostatistics Core/Shared/Shared Projects/Laura/Peds Endo/Christine Chan/CF registry data"
}
knitr::opts_knit$set(root.dir = home_dir)


setwd('S://Laura/Peds Endo/Christine Chan/CF registry data')

# load in data 
CFF19_Demog <- read_csv("CFF19_DemogCFDiag_Del1.csv")
CFF19_Annualized <- read_csv("CFF19_Annualized_Del1.csv")
CFF19_CareEpisodes <- read_csv("CFF19_CareEpisodes_Del1.csv")
CFF19_encounters <- read_csv("CFF19_encountersMerged_Del1.csv")
```


In Aim 1, we will estimate:
the prevalence of CFRD at each year as the proportion of patients with CFRD.

Incidence per year will be estimated as the number of incident CFRD diagnoses per 1,000 person-years of longitudinal data, with prevalent cases excluded.

To assess the associations of individual variables (e.g., sex, race/ethnicity, number of prednisone prescriptions) with CFRD within a given year, t-tests and Chi-squared tests will be used for continuous and categorical variables respectively.

To test whether these univariate relationships differ between years, a mixed-effects logistic regression model with an interaction effect for year and CFRD status will be fit, and significance of the interaction effect from the model assessed with ANOVA will be used to detect a difference in effect between years. 

To evaluate the independent associations of these variables with CFRD, a mixed effects logistic regression model with variables selected by Least Absolute Shrinkage Selection Operator (LASSO) or Elastic Net will be used to assess which if any variables are associated with CFRD. The model will be tuned and evaluated based on cross-validated Area Under the Curve of the Receiver Operating Characteristic (ROC-AUC). From this model, odds ratios and their 95% CIs will be calculated to interpret the results. 

```{r aim 1}

# im just going to examine the 3's in the encounters vs the annualized
CFRD_annualtest = CFF19_Annualized %>% filter(cfrd_status_annual == 3) %>% select(eDWID) %>% distinct() # 13224 subjects who had 3 in at least 1 year

# check the extended version of the subjects who had a 3 in the annualized
CFRD_encountertest = CFF19_encounters %>% select(eDWID, reviewyear, encounternum,cfrd_status) %>% filter( eDWID %in% CFRD_annualtest$eDWID) %>% distinct()
describe(CFRD_encountertest)

# proportion/prevalence
# just need to define cfrd; i think we should go by encounter cfrd status' just because not all encounters have lab data 
# need to decide whether its any cfrd in a year, or last measure for a year, 
# as well as total cfrd prevalence; any cfrd ever? or last recorded? etc
```

CFRD:
1	Normal Glucose Metabolism (includes normal, random, fasting, or OGTT)
2	Impaired Glucose Tolerance (FBG < 126, 2-h PG 140-199)
3	CFRD with or without fasting hyperglycemia ( 2-h PG >= 200)
4	Type 1 Diabetes
5	Type 2 Diabetes