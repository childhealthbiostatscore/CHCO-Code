---
title: "Prospective analysis of CF outcomes"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(stringr)
library(dplyr)
library(readxl)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

# get REDCap data and exclude HCs
source("E:\\Christine Chan\\Prospective analysis\\Data raw\\CGMInHealthyControls-DataForProspectiveAn_R_2021-06-02_0929.r")
data <- data[data$group_category != 1,]

# get rid of double data entry
data$dde <- str_detect(data$subject_id,"--")
data <- filter(data,dde=="FALSE")

# keep the first visit
data$rpt <- str_detect(data$subject_id,"\\.1")
data <- filter(data,rpt=="FALSE")

# rename and get rid of variables
data$MRN <- str_trim(data$medical_record_number)
data$medical_record_number <- NULL
data$dde <- NULL
data$rpt <- NULL

# one patient is in twice with different IDs - keep the first
data <- data[data$subject_id != 138,]

# read in and merge insulin data
ins <- read.csv("E:\\Christine Chan\\Prospective analysis\\Data raw\\Insulin Start date and prospective data-- Eileen cleanup.csv",
                na.strings = c(""," ",NA))
# there can be duplicates in this file - keep the one with earliest date of consent
ins <- ins[!is.na(ins$Date.of.Consent),]
ins <- arrange(ins,MRN,desc(Date.of.Consent))   
ins <- ins %>% group_by(MRN) %>% filter(row_number() == 1)
#ins$subject_id <- ins$Subject.ID
ins$rpt <- str_detect(ins$Subject.ID,"\\.1")
ins <- filter(ins,rpt=="FALSE")
ins$Subject.ID <- NULL
ins$rpt <- NULL
# looks like there are duplicates in the insulin data file
# find MRNs that are in REDCap and work with those
#ins_keep <- ins[ins$MRN %in% data$MRN,]
#write.csv(ins_keep,"E:\\Christine Chan\\Prospective analysis\\Data clean\\insulin_checking.csv")
data1 <- merge(data,ins,by="MRN",all.x = T,all.y = F)

# create a new variable called encounter date, which will be used to link all the results in the various sheets
data1$Encounter_date <- data1$date_of_visit

# read in PFTs
pfts <- read_xlsx("E:\\Christine Chan\\Prospective analysis\\Data raw\\Updated Full List for Elin_Data 2020 06 05.xlsx",sheet="PFTs")
pfts$Encounter_date <- pfts$`Encounter date`
pfts$`Encounter date` <- NULL
# this merge won't work - we want all the MRNs in X but all the Encounter dates
data2 <- merge(data1,pfts,by=c("MRN","Encounter_date"),all.x = T,all.y = F)

```

# Background

# Methods

# Results

```{r echo=FALSE}
kable(t1,caption = "")
```
<br>
