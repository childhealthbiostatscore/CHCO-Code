---
title: "Prospective analysis of CF outcomes"
author: "Laura Pyle"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    number_sections: yes
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
library(stringr)
library(dplyr)
library(readxl)

knitr::opts_chunk$set(echo = FALSE,warning = FALSE)

# get REDCap data and exclude HCs
source("E:\\Christine Chan\\Prospective analysis\\Data raw\\CGMInHealthyControls-DataForProspectiveAn_R_2021-06-02_0929.r")
data <- data[data$group_category != 1,]

# get rid of double data entry
data$dde <- str_detect(data$subject_id,"--")
data <- filter(data,dde=="FALSE")

# keep the first visit
data$rpt <- str_detect(data$subject_id,"\\.1")
data <- filter(data,rpt=="FALSE")

# rename and get rid of variables
data$MRN <- str_trim(data$medical_record_number)
data$medical_record_number <- NULL
data$dde <- NULL
data$rpt <- NULL

# one patient is in twice with different IDs - keep the first
data <- data[data$subject_id != 138,]

# read in and merge insulin data
ins <- read.csv("E:\\Christine Chan\\Prospective analysis\\Data raw\\Insulin Start date and prospective data-- Eileen cleanup.csv",
                na.strings = c(""," ",NA))
# there can be duplicates in this file - keep the one with earliest date of consent
ins <- ins[!is.na(ins$Date.of.Consent),]
ins <- arrange(ins,MRN,desc(Date.of.Consent))   
ins <- ins %>% group_by(MRN) %>% filter(row_number() == 1)
#ins$subject_id <- ins$Subject.ID
ins$rpt <- str_detect(ins$Subject.ID,"\\.1")
ins <- filter(ins,rpt=="FALSE")
ins$Subject.ID <- NULL
ins$rpt <- NULL
# looks like there are duplicates in the insulin data file
# find MRNs that are in REDCap and work with those
#ins_keep <- ins[ins$MRN %in% data$MRN,]
#write.csv(ins_keep,"E:\\Christine Chan\\Prospective analysis\\Data clean\\insulin_checking.csv")
data1 <- merge(data,ins,by="MRN",all.x = T,all.y = F)

# create a new variable called encounter date, which will be used to link all the results in the various sheets
data1$Encounter_date <- as.Date(data1$date_of_visit)

# read in PFTs
pfts <- read_xlsx("E:\\Christine Chan\\Prospective analysis\\Data raw\\Updated Full List for Elin_Data 2020 06 05.xlsx",sheet="PFTs")
pfts$Encounter_date <- as.Date(pfts$`Encounter date`)
pfts$`Encounter date` <- NULL
pfts$`First Name` <- NULL
pfts$`Last Name` <- NULL
# there seem to be some dups
pfts$`Date of Consent` <- NULL
pfts <- unique(pfts)
# keep PFTs where MRN matches data1, then merge
pfts_keep <- pfts[pfts$MRN %in% data1$MRN,]
data2 <- merge(data1,pfts_keep,by=c("MRN","Encounter_date"),all.x = T,all.y = T)
write.csv(data2,'C:\\temp\\data2.csv')

# read in OGTT and A1c data
ogtt <- read_xlsx("E:\\Christine Chan\\Prospective analysis\\Data raw\\Updated Full List for Elin_Data 2020 06 05.xlsx",sheet="OGTTandA1C")
ogtt$Encounter_date <- as.Date(ogtt$`Date of Test`)
ogtt$`Date of Test` <- NULL
ogtt$`Date of Consent` <- NULL
ogtt$`First Name` <- NULL
ogtt$`Last Name` <- NULL
ogtt <- unique(ogtt)
# keep OGTTs where MRN matches data2, then merge
ogtt_keep <- ogtt[ogtt$MRN %in% data2$MRN,]
data3 <- merge(data2,ogtt_keep,by=c("MRN","Encounter_date"),all.x = T,all.y = T)
write.csv(data3,'C:\\temp\\data3.csv')

# read in sputum data
sputum <- read_xlsx("E:\\Christine Chan\\Prospective analysis\\Data raw\\Updated Full List for Elin_Data 2020 06 05.xlsx",sheet="Sputum")
sputum$Encounter_date <- as.Date(sputum$CultureDate)
sputum$CultureDate <- NULL
sputum$first_name <- NULL
sputum$last_name <- NULL
sputum$`Date of Earliest Consent` <- NULL
sputum <- unique(sputum)
# keep sputum where MRN matches data3, then merge
sputum_keep <- sputum[sputum$MRN %in% data3$MRN,]
data4 <- merge(data3,sputum_keep,by=c("MRN","Encounter_date"),all.x = T,all.y = T)
write.csv(data4,'C:\\temp\\data4.csv')

# read in modulator data
mods <- read_xlsx("E:\\Christine Chan\\Prospective analysis\\Data raw\\Updated Full List for Elin_Data 2020 06 05.xlsx",sheet="Modulators")
mods$`First Name` <- NULL
mods$`Last Name` <- NULL
mods$`Date of Consent` <- NULL
#mods$check1 <- ifelse(mods$`Earliest Kalydeco Date After Consent` < mods$`Earliest Orkambi Date After Consent`,0,1)
#mods$check2 <- ifelse(mods$`Earliest Orkambi Date After Consent` < mods$`Earliest Symdeko Date After Consent`,0,1)
#mods$check3 <- ifelse(mods$`Earliest Symdeko Date After Consent` < mods$`Earliest Trikafta Date After Consent`,0,1)
# for all patients Kalydeco < Orkambi < Symdeko < Trikafta
mods <- unique(mods)
# keep sputum where MRN matches data4, then merge
mods_keep <- mods[mods$MRN %in% data4$MRN,]
data5 <- merge(data4,mods_keep,by="MRN",all.x = T,all.y = T)
write.csv(data5,'C:\\temp\\data5.csv')
# this is weird - why are there so many new records?  should not increase # records at all
# next, create vars to indicate on each type of modulator at the encounter date


```

# Background

# Methods

# Results

```{r echo=FALSE}
kable(t1,caption = "")
```
<br>
